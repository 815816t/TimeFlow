<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TIMEFLOW</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DotGothic16&family=M+PLUS+Rounded+1c:wght@300;400;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

:root {
  --bg:#0c0f1a; --s1:#111827; --s2:#1a2236; --s3:#212f47;
  --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.14);
  --text:#dce8f8; --muted:#4a6080; --muted2:#7a9ab8;
  --cyan:#38bdf8; --green:#4ade80; --amber:#fbbf24;
  --violet:#c084fc; --rose:#fb7185; --orange:#fb923c;
  --pixel:#1a2820; --gold:#f59e0b; --gold2:#fcd34d;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'M PLUS Rounded 1c',sans-serif;min-height:100vh;overflow-x:hidden;}

/* ===== NAV ===== */
.nav{
  position:fixed;top:0;left:0;right:0;z-index:100;
  background:rgba(12,15,26,0.92);backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 24px;height:56px;gap:8px;overflow:hidden;
}
.nav-logo{font-family:'DotGothic16',monospace;font-size:1.1rem;color:var(--cyan);letter-spacing:0.05em;margin-right:16px;flex-shrink:0;}
.nav-tabs{display:flex;gap:4px;flex:1;min-width:0;}
.ntab{
  background:transparent;border:none;
  padding:6px 18px;border-radius:8px;
  color:var(--muted2);cursor:pointer;
  font-family:'M PLUS Rounded 1c',sans-serif;font-size:0.82rem;font-weight:700;
  transition:all 0.2s;position:relative;
}
.ntab.active{background:var(--s2);color:var(--text);border:1px solid var(--border2);}
.ntab:hover:not(.active){background:var(--s1);color:var(--text);}
.ntab .badge{
  position:absolute;top:-4px;right:-4px;
  background:var(--amber);color:#000;
  font-size:0.55rem;font-weight:800;padding:1px 5px;border-radius:10px;
  font-family:'JetBrains Mono',monospace;
}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:10px;flex-shrink:0;}
.xp-pill{
  background:var(--s2);border:1px solid rgba(74,222,128,0.3);
  border-radius:20px;padding:4px 14px;
  font-family:'JetBrains Mono',monospace;font-size:0.75rem;
  display:flex;align-items:center;gap:6px;
}
.xp-num{color:var(--green);font-weight:700;}
.streak-pill{
  background:var(--s2);border:1px solid rgba(251,191,36,0.3);
  border-radius:20px;padding:4px 12px;
  font-family:'JetBrains Mono',monospace;font-size:0.75rem;
  color:var(--amber);font-weight:700;
}

/* ===== PAGES ===== */
.page{display:none;padding-top:72px;min-height:100vh;}
.page.active{display:block;}
.wrap{max-width:1360px;margin:0 auto;padding:20px 24px;}

/* ===== CARDS ===== */
.card{background:var(--s1);border:1px solid var(--border);border-radius:16px;padding:18px;}
.card-hd{font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:14px;display:flex;align-items:center;gap:7px;}
.card-hd-dot{width:5px;height:5px;border-radius:50%;background:var(--cyan);flex-shrink:0;}

/* ===== BUTTONS ===== */
.btn{background:var(--s2);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:8px 16px;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;font-size:0.82rem;font-weight:700;transition:all 0.15s;}
.btn:hover{background:var(--s3);border-color:var(--border2);}
.btn.primary{background:linear-gradient(135deg,#38bdf8,#818cf8);border:none;color:#fff;}
.btn.primary:hover{opacity:0.9;transform:translateY(-1px);box-shadow:0 4px 20px rgba(56,189,248,0.3);}
.btn.green{background:linear-gradient(135deg,#4ade80,#22d3ee);border:none;color:#000;font-weight:800;}
.btn.amber{background:linear-gradient(135deg,#fbbf24,#fb923c);border:none;color:#000;font-weight:800;}
.btn.sm{padding:5px 12px;font-size:0.75rem;}

/* inputs */
input[type=time],select.sel,input[type=text],input[type=number]{
  background:var(--s2);border:1px solid var(--border);border-radius:8px;
  color:var(--text);padding:8px 10px;
  font-family:'M PLUS Rounded 1c',sans-serif;font-size:0.85rem;
  transition:border-color 0.15s;width:100%;
}
input[type=time]:focus,select.sel:focus,input[type=text]:focus,input[type=number]:focus{outline:none;border-color:var(--cyan);box-shadow:0 0 0 2px rgba(56,189,248,0.12);}
select.sel{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='7'%3E%3Cpath d='M0 0l5 7 5-7z' fill='%234a6080'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px;cursor:pointer;}
.inp-lbl{font-size:0.68rem;color:var(--muted2);margin-bottom:4px;font-family:'JetBrains Mono',monospace;}

/* ===== PAGE 1: RECORD ===== */
.p1-grid{display:grid;grid-template-columns:400px 1fr;gap:16px;}
.input-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
.add-btn{width:100%;margin-top:8px;background:linear-gradient(135deg,#38bdf8,#818cf8);border:none;border-radius:10px;color:#fff;font-weight:800;font-size:0.9rem;padding:11px;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;transition:all 0.2s;letter-spacing:0.02em;}
.add-btn:hover{opacity:0.9;transform:translateY(-1px);box-shadow:0 4px 20px rgba(56,189,248,0.3);}
.quick-adds{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;}
.time-sel{background:var(--s2);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px 12px;font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;width:100%;appearance:none;-webkit-appearance:none;cursor:pointer;text-align:center;}
.time-sel:focus{outline:none;border-color:var(--cyan);box-shadow:0 0 0 2px rgba(56,189,248,.12);}
.time-sel option{background:#111827;color:#e2e8f0;padding:4px 8px;}
.time-sel option.hr-mark{color:#38bdf8;font-weight:800;}
.time-input-wrap{display:flex;flex-direction:column;gap:4px;}
.time-steppers{display:flex;gap:3px;justify-content:center;}
.time-step-btn{padding:3px 0;border:1px solid var(--border);border-radius:6px;background:var(--s2);color:var(--muted);font-size:.58rem;font-weight:700;cursor:pointer;transition:all .15s;flex:1;text-align:center;line-height:1.2;}
.time-step-btn:hover{border-color:var(--cyan);color:var(--cyan);background:rgba(56,189,248,.08);}
.time-step-btn:active{background:rgba(56,189,248,.2);}
.tstep-btn{padding:4px 10px;border:1px solid var(--border);border-radius:6px;background:var(--s2);color:var(--muted);font-size:.62rem;font-weight:600;cursor:pointer;transition:all .15s;}
.tstep-btn.active{background:rgba(56,189,248,.15);border-color:rgba(56,189,248,.4);color:var(--cyan);font-weight:700;}
.tstep-btn:hover{border-color:var(--cyan);}
.qa-chip{background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:0.7rem;color:var(--muted2);cursor:pointer;transition:all 0.15s;}
.qa-chip:hover{border-color:var(--cyan);color:var(--text);background:var(--s3);}
.tl-wrap{position:relative;height:38px;background:var(--bg);border-radius:8px;overflow:hidden;margin:10px 0 4px;border:1px solid var(--border);}
.tl-seg{position:absolute;top:0;height:100%;opacity:0.85;cursor:pointer;transition:opacity 0.15s;}
.tl-seg:hover{opacity:1;}
.tl-ticks{display:flex;justify-content:space-between;padding:0 2px;}
.tl-tick{font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--muted);}
.blist{max-height:200px;overflow-y:auto;margin-top:8px;}
.blist::-webkit-scrollbar{width:3px;}
.blist::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.bitem{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:8px;background:var(--s2);border:1px solid var(--border);margin-bottom:4px;animation:popIn 0.2s cubic-bezier(0.34,1.56,0.64,1);cursor:pointer;transition:border-color .15s;}
.bitem:hover{border-color:var(--border2);}
.bitem.editing{border-color:var(--cyan);background:var(--s3);}
.bedit-row{display:flex;gap:4px;align-items:center;margin-top:5px;}
.bedit-row input,.bedit-row select{background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:4px 6px;font-size:.68rem;font-family:'JetBrains Mono',monospace;}
.bedit-row input[type=time]{width:80px;}
.bedit-row button{padding:3px 10px;border:none;border-radius:6px;font-size:.65rem;font-weight:700;cursor:pointer;transition:all .15s;}
.bedit-save{background:var(--cyan);color:#000;}
.bedit-cancel{background:var(--s2);color:var(--muted2);border:1px solid var(--border)!important;}
/* day template presets */
.daytpl-bar{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;align-items:center;}
.daytpl-chip{padding:5px 12px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--muted2);font-size:.68rem;font-weight:700;cursor:pointer;transition:all .15s;}
.daytpl-chip:hover{border-color:var(--cyan);color:var(--text);background:var(--s3);}
.daytpl-chip.active{border-color:var(--cyan);color:var(--cyan);background:rgba(0,212,255,.08);}
@keyframes popIn{from{opacity:0;transform:scale(0.9) translateY(-4px);}to{opacity:1;transform:scale(1) translateY(0);}}
.bdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.binfo{flex:1;}
.bcat{font-size:0.8rem;font-weight:700;}
.btime{font-size:0.68rem;color:var(--muted2);font-family:'JetBrains Mono',monospace;}
.bdel{background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.9rem;padding:3px 6px;border-radius:4px;transition:all 0.15s;}
.bdel:hover{background:var(--rose);color:#fff;}

/* sleep */
.sleep-grid{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center;}
.sleep-arc-wrap{position:relative;width:88px;height:88px;}
.sleep-arc-wrap svg{width:88px;height:88px;}
.sleep-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.sleep-num{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700;}
.sleep-unit{font-size:0.58rem;color:var(--muted2);}
.sleep-inputs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
.sleep-band{height:5px;background:var(--bg);border-radius:3px;overflow:hidden;}
.sleep-band-fill{height:100%;border-radius:3px;transition:width 0.6s ease,background 0.4s;}
.sleep-msg{font-size:0.72rem;margin-top:5px;font-weight:700;}

/* special xp items */
.special-list{display:flex;flex-direction:column;gap:8px;}
.special-item{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--s2);border:1px solid var(--border);border-radius:10px;}
.special-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.special-info{flex:1;}
.special-name{font-size:0.82rem;font-weight:700;}
.special-meta{font-size:0.68rem;color:var(--muted2);}
.special-xp{font-family:'JetBrains Mono',monospace;font-size:0.78rem;color:var(--amber);font-weight:700;}
.special-del{background:none;border:none;color:var(--muted);cursor:pointer;padding:2px 6px;border-radius:4px;transition:all 0.15s;}
.special-del:hover{background:var(--rose);color:#fff;}

/* right col */
.right-col{display:flex;flex-direction:column;gap:14px;}
.metrics-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.metric-card{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:14px 16px;transition:all 0.2s;}
.metric-card:hover{border-color:var(--border2);transform:translateY(-1px);}
.metric-val{font-family:'JetBrains Mono',monospace;font-size:1.7rem;font-weight:700;line-height:1;}
.metric-lbl{font-size:0.68rem;color:var(--muted2);margin-top:3px;}
.metric-trend{font-size:0.68rem;margin-top:5px;}
.pie-row{display:flex;gap:14px;align-items:center;flex-wrap:wrap;}
.pie-pos{position:relative;height:220px;width:220px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.pie-mid{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none;}
.pie-mid-h{font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--cyan);}
.pie-mid-l{font-size:0.65rem;color:var(--muted2);}
.legend{display:flex;flex-direction:column;gap:5px;}
.leg-item{display:flex;align-items:center;gap:6px;font-size:0.73rem;}
.leg-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.leg-name{flex:1;color:var(--muted2);}
.leg-val{font-family:'JetBrains Mono',monospace;font-size:0.7rem;}
.leg-bar{height:2px;border-radius:2px;margin-top:2px;transition:width 0.5s ease;}
.effort-banner{background:linear-gradient(90deg,#071a10,var(--s1));border:1px solid rgba(74,222,128,0.2);border-radius:12px;padding:14px 18px;display:flex;align-items:center;gap:18px;}
.effort-big{font-family:'JetBrains Mono',monospace;font-size:2.3rem;font-weight:700;color:var(--green);line-height:1;}
.effort-lbl{font-size:0.68rem;color:var(--muted2);margin-top:2px;}
.ebar{display:flex;align-items:center;gap:7px;margin-bottom:5px;}
.ebar-lbl{font-size:0.68rem;width:44px;color:var(--muted2);}
.ebar-track{flex:1;height:4px;background:var(--bg);border-radius:2px;overflow:hidden;}
.ebar-fill{height:100%;border-radius:2px;transition:width 0.5s ease;}
.ebar-val{font-family:'JetBrains Mono',monospace;font-size:0.68rem;color:var(--text);width:34px;text-align:right;}

/* date nav */
.date-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:10px;flex-wrap:wrap;}
.date-ctrl{display:flex;align-items:center;gap:8px;}
.nav-btn{width:34px;height:34px;border-radius:9px;background:var(--s2);border:1px solid var(--border);color:var(--text);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all 0.15s;user-select:none;}
.nav-btn:hover{background:var(--s3);border-color:var(--cyan);color:var(--cyan);transform:scale(1.05);}
.nav-btn:active{transform:scale(0.95);}
.date-pill{background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:6px 16px;font-family:'JetBrains Mono',monospace;font-size:0.82rem;min-width:145px;text-align:center;}
.date-pill.today{border-color:var(--cyan);color:var(--cyan);}
.today-btn{background:transparent;border:1px solid var(--border);border-radius:9px;padding:6px 14px;color:var(--muted2);cursor:pointer;font-size:0.75rem;font-family:'JetBrains Mono',monospace;transition:all 0.15s;}
.today-btn:hover{border-color:var(--cyan);color:var(--cyan);}

/* ===== PAGE 2: STATS ===== */
.cue-card{background:linear-gradient(135deg,rgba(56,189,248,0.08),rgba(192,132,252,0.06));border:1px solid rgba(56,189,248,0.2);border-radius:12px;padding:12px 18px;margin-bottom:16px;display:flex;align-items:center;gap:14px;}
.cue-emoji{font-size:1.6rem;}
.cue-main{font-size:0.88rem;font-weight:700;}
.cue-sub{font-size:0.72rem;color:var(--muted2);margin-top:2px;}

.big-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;}
.bstat{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center;transition:all 0.2s;}
.bstat:hover{transform:translateY(-2px);border-color:var(--border2);}
.bstat-icon{font-size:1.8rem;margin-bottom:6px;}
.bstat-val{font-family:'JetBrains Mono',monospace;font-size:1.6rem;font-weight:700;line-height:1;}
.bstat-lbl{font-size:0.68rem;color:var(--muted2);margin-top:3px;}
.bstat-sub{font-size:0.65rem;margin-top:4px;}

.trend-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.trend-title{font-family:'JetBrains Mono',monospace;font-size:0.8rem;letter-spacing:0.06em;}
.trend-tabs{display:flex;gap:3px;background:var(--s1);border:1px solid var(--border);border-radius:8px;padding:3px;}
.ttab{background:transparent;border:none;border-radius:6px;padding:5px 14px;color:var(--muted2);cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:0.72rem;transition:all 0.15s;}
.ttab.active{background:var(--s3);color:var(--text);}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;}
.chart-card{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:16px;}
.chart-title{font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:10px;}
.chart-h{height:190px;position:relative;}

/* habit chain */
.hgrid{display:flex;gap:4px;flex-wrap:wrap;margin-top:10px;}
.hcell{width:26px;height:26px;border-radius:6px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:0.58rem;font-family:'JetBrains Mono',monospace;color:var(--muted);cursor:pointer;transition:all 0.15s;}
.hcell.filled{color:var(--text);}
.hcell.today-cell{border-color:var(--cyan);}

/* history */
.hist-list{max-height:260px;overflow-y:auto;}
.hist-list::-webkit-scrollbar{width:3px;}
.hist-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.hist-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:9px;background:var(--s2);border:1px solid var(--border);margin-bottom:5px;cursor:pointer;transition:all 0.15s;}
.hist-item:hover{border-color:var(--border2);background:var(--s3);}
.hist-item.cur{border-color:var(--cyan);background:rgba(56,189,248,0.05);}
.hist-date{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--cyan);width:76px;flex-shrink:0;}
.hist-mini{flex:1;display:flex;gap:2px;height:16px;align-items:flex-end;}
.hist-bar{border-radius:2px 2px 0 0;min-width:5px;}
.hist-effort{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--green);width:38px;text-align:right;flex-shrink:0;}
.hist-score{font-size:0.66rem;color:var(--muted2);width:40px;text-align:right;flex-shrink:0;}

/* ===== PAGE 3: SKILL TREE ===== */

/* XP header */
.xp-spend-bar{background:var(--s1);border:1px solid rgba(74,222,128,0.2);border-radius:12px;padding:12px 16px;margin-bottom:14px;}
.xp-spend-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.xp-spend-label{font-size:0.72rem;color:var(--muted2);}
.xp-spend-val{font-family:'JetBrains Mono',monospace;font-size:0.88rem;color:var(--green);font-weight:700;}
.xp-track{height:8px;background:var(--bg);border-radius:4px;overflow:hidden;margin-top:4px;}
.xp-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--green),var(--cyan));transition:width 0.8s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 0 8px rgba(74,222,128,0.3);}

/* level banner */
.lv-banner{background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(251,146,60,0.08));border:1px solid rgba(251,191,36,0.25);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.lv-circle{width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#fbbf24,#fb923c);display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;font-family:'JetBrains Mono',monospace;box-shadow:0 0 16px rgba(251,191,36,0.3);}
.lv-num{font-size:1.2rem;font-weight:700;color:#000;line-height:1;}
.lv-lbl{font-size:0.5rem;color:rgba(0,0,0,0.6);letter-spacing:0.08em;}
.lv-info{flex:1;}
.lv-name{font-weight:800;font-size:0.9rem;color:var(--amber);}
.lv-next{font-size:0.68rem;color:var(--muted2);margin-top:2px;}
.lv-track{height:6px;background:var(--bg);border-radius:3px;overflow:hidden;margin-top:6px;}
.lv-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,#fbbf24,#fb923c);transition:width 0.8s ease;}

/* SELF STATUS — top hero area */
.self-status {
  display:grid;grid-template-columns:auto 1fr;gap:20px;
  background:linear-gradient(135deg,#0c1a2e,#0f1830);
  border:1px solid rgba(56,189,248,0.2);border-radius:20px;
  padding:24px;margin-bottom:20px;position:relative;overflow:hidden;
}
.self-status::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 80% at 20% 50%,rgba(56,189,248,0.04),transparent);pointer-events:none;}
.avatar-wrap{position:relative;width:100px;flex-shrink:0;}
.avatar-ring{width:100px;height:100px;border-radius:50%;border:3px solid var(--cyan);display:flex;align-items:center;justify-content:center;font-size:3rem;background:var(--s2);position:relative;box-shadow:0 0 30px rgba(56,189,248,0.2);animation:avatarPulse 3s ease-in-out infinite;}
@keyframes avatarPulse{0%,100%{box-shadow:0 0 20px rgba(56,189,248,0.2);}50%{box-shadow:0 0 40px rgba(56,189,248,0.4);}}
.avatar-lv-badge{position:absolute;bottom:-4px;right:-4px;background:linear-gradient(135deg,#fbbf24,#fb923c);color:#000;font-family:'JetBrains Mono',monospace;font-size:0.65rem;font-weight:800;padding:2px 7px;border-radius:10px;border:2px solid var(--bg);}
.self-info{display:flex;flex-direction:column;justify-content:center;gap:10px;}
.self-name-row{display:flex;align-items:center;gap:10px;}
.self-name{font-size:1.3rem;font-weight:900;color:var(--text);}
.self-title-badge{background:rgba(192,132,252,0.15);border:1px solid rgba(192,132,252,0.3);border-radius:20px;padding:3px 12px;font-size:0.72rem;color:var(--violet);font-weight:700;}
.self-stats-row{display:flex;gap:16px;flex-wrap:wrap;}
.ss-stat{text-align:center;}
.ss-val{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:var(--cyan);}
.ss-lbl{font-size:0.6rem;color:var(--muted2);margin-top:1px;}
.self-bars{display:flex;flex-direction:column;gap:5px;}
.sbar-row{display:flex;align-items:center;gap:8px;}
.sbar-lbl{font-size:0.65rem;color:var(--muted2);width:52px;text-align:right;}
.sbar-track{flex:1;height:7px;background:var(--bg);border-radius:4px;overflow:hidden;border:1px solid var(--border);}
.sbar-fill{height:100%;border-radius:4px;transition:width 0.8s cubic-bezier(0.34,1.56,0.64,1);}
.sbar-val{font-family:'JetBrains Mono',monospace;font-size:0.62rem;color:var(--text);width:32px;}

/* SKILL TREE layout */
.st-layout{display:grid;grid-template-columns:1fr 300px;gap:16px;}

/* Skill tree canvas area */
.st-canvas{background:radial-gradient(ellipse 100% 100% at 50% 50%,#0d1a2e,#070b12);border:1px solid var(--border);border-radius:20px;padding:24px;position:relative;min-height:560px;}
.st-canvas-title{font-family:'DotGothic16',monospace;font-size:1rem;color:var(--cyan);margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;}
.st-tabs{display:flex;gap:4px;}
.sttab{background:var(--s2);border:1px solid var(--border);border-radius:7px;padding:4px 12px;cursor:pointer;font-size:0.72rem;font-weight:700;color:var(--muted2);transition:all 0.15s;}
.sttab.active{background:rgba(56,189,248,0.15);border-color:rgba(56,189,248,0.4);color:var(--cyan);}

/* Domain cards — 6 skill domains */
.domain-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.domain-card{
  background:var(--s2);border:1px solid var(--border);border-radius:14px;
  padding:14px;cursor:pointer;transition:all 0.2s;
  position:relative;overflow:hidden;
}
.domain-card:hover{transform:translateY(-2px);}
.domain-card.active-domain{border-width:2px;}
.domain-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;border-radius:0 0 14px 14px;}
.domain-top{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.domain-icon{font-size:1.4rem;}
.domain-name{font-size:0.78rem;font-weight:800;}
.domain-lv{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--muted2);}
.domain-bar-wrap{height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-bottom:6px;}
.domain-bar{height:100%;border-radius:2px;transition:width 0.6s ease;}
.domain-xp-row{display:flex;justify-content:space-between;font-size:0.62rem;color:var(--muted2);}
.domain-xp{font-family:'JetBrains Mono',monospace;}

/* Skill tree SVG node area */
.skill-tree-area{margin-top:16px;position:relative;}
.skill-tree-svg{width:100%;overflow:visible;}
.skill-node{cursor:pointer;transition:all 0.2s;}
.skill-node:hover .sn-circle{filter:brightness(1.3);}
.sn-circle{transition:all 0.25s;}
.sn-label{font-family:'M PLUS Rounded 1c',sans-serif;font-size:11px;font-weight:700;}
.sn-lv{font-family:'JetBrains Mono',monospace;font-size:9px;}
.skill-line{stroke-opacity:0.3;stroke-width:2;stroke-dasharray:4 3;}
.skill-line.unlocked{stroke-opacity:0.7;stroke-dasharray:none;}

/* Right panel: detail + events */
.st-right{display:flex;flex-direction:column;gap:12px;}

/* Selected skill detail */
.skill-detail{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:16px;}
.sd-empty{text-align:center;color:var(--muted);font-size:0.78rem;padding:20px 0;}
.sd-icon{font-size:2.5rem;text-align:center;margin-bottom:8px;}
.sd-name{font-size:1rem;font-weight:900;text-align:center;}
.sd-desc{font-size:0.72rem;color:var(--muted2);text-align:center;margin:6px 0 12px;line-height:1.5;}
.sd-lv-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.sd-lv-label{font-size:0.65rem;color:var(--muted2);}
.sd-lv-val{font-family:'JetBrains Mono',monospace;font-size:0.72rem;font-weight:700;}
.sd-bar{height:8px;background:var(--bg);border-radius:4px;overflow:hidden;margin-bottom:10px;}
.sd-bar-fill{height:100%;border-radius:4px;transition:width 0.6s ease;}
.sd-effect{background:var(--s2);border-radius:8px;padding:8px;font-size:0.72rem;margin-bottom:10px;}
.sd-effect-title{font-size:0.62rem;color:var(--muted2);margin-bottom:4px;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:0.08em;}
.sd-upgrade-btn{width:100%;padding:9px;border:none;border-radius:9px;font-family:'M PLUS Rounded 1c',sans-serif;font-size:0.82rem;font-weight:800;cursor:pointer;transition:all 0.2s;}
.sd-upgrade-btn.can{background:linear-gradient(135deg,#fbbf24,#fb923c);color:#000;}
.sd-upgrade-btn.can:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(251,191,36,0.4);}
.sd-upgrade-btn.cant{background:var(--s2);color:var(--muted);cursor:not-allowed;}

/* Narrative event log */
.event-log{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:14px;flex:1;}
.el-title{font-family:'DotGothic16',monospace;font-size:0.82rem;color:var(--amber);margin-bottom:10px;}
.el-list{max-height:220px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.el-list::-webkit-scrollbar{width:3px;}
.el-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.el-item{padding:8px 10px;border-radius:8px;background:var(--s2);border-left:3px solid transparent;font-size:0.72rem;line-height:1.5;animation:popIn 0.3s ease;}
.el-item.awakening{border-left-color:var(--amber);}
.el-item.levelup{border-left-color:var(--cyan);}
.el-item.streak{border-left-color:var(--green);}
.el-item.warning{border-left-color:var(--rose);}
.el-date{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--muted);margin-top:2px;}

/* Awakening modal special */
.awakening-overlay{position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);}
.awakening-overlay.show{display:flex;}
.awakening-box{
  background:linear-gradient(135deg,#0a0f1e,#1a0f30);
  border:2px solid var(--amber);border-radius:24px;
  padding:48px;text-align:center;max-width:400px;
  box-shadow:0 0 100px rgba(251,191,36,0.3),0 0 200px rgba(192,132,252,0.1);
  animation:awakeIn 0.5s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes awakeIn{from{transform:scale(0.3) rotate(-10deg);opacity:0;}to{transform:scale(1) rotate(0deg);opacity:1;}}
.aw-particles{font-size:2rem;margin-bottom:12px;animation:spin 2s linear infinite;}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
.aw-title{font-family:'DotGothic16',monospace;font-size:1.6rem;color:var(--amber);margin-bottom:8px;text-shadow:0 0 20px rgba(251,191,36,0.5);}
.aw-sub{font-size:0.82rem;color:var(--muted2);line-height:1.6;margin-bottom:20px;}
.aw-close{background:linear-gradient(135deg,#fbbf24,#fb923c);border:none;border-radius:10px;padding:10px 30px;color:#000;font-weight:800;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;}

@media(max-width:900px){
  .st-layout,.self-status{grid-template-columns:1fr;}
  .domain-grid{grid-template-columns:repeat(2,1fr);}
  .self-stats-row{gap:10px;}
}

/* ===== REWARD POP ===== */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;display:none;align-items:center;justify-content:center;}
.overlay.show{display:flex;}
.reward-box{
  background:linear-gradient(135deg,#0f1e14,#0d1230);
  border:2px solid var(--amber);border-radius:20px;
  padding:36px 48px;text-align:center;
  box-shadow:0 0 80px rgba(251,191,36,0.25);
  animation:rewardIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
  max-width:360px;
}
@keyframes rewardIn{from{transform:scale(0.5);opacity:0;}to{transform:scale(1);opacity:1;}}
.reward-emoji{font-size:3.5rem;display:block;margin-bottom:10px;animation:bounce 0.6s ease infinite alternate;}
@keyframes bounce{from{transform:translateY(0);}to{transform:translateY(-8px);}}
.reward-title{font-family:'DotGothic16',monospace;font-size:1.3rem;color:var(--amber);margin-bottom:6px;}
.reward-sub{font-size:0.82rem;color:var(--muted2);line-height:1.5;}
.reward-close{margin-top:20px;background:var(--s3);border:1px solid var(--border);border-radius:8px;padding:7px 24px;color:var(--text);cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;font-size:0.82rem;font-weight:700;transition:all 0.15s;}
.reward-close:hover{background:var(--amber);color:#000;}

/* modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:150;display:none;align-items:center;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:150;display:none;align-items:center;justify-content:center;}
.modal.show{display:flex;}
.modal-box{background:var(--s1);border:1px solid var(--border2);border-radius:16px;padding:24px;max-width:400px;width:90%;animation:rewardIn 0.3s ease;}
.modal-title{font-weight:800;font-size:1rem;margin-bottom:14px;}
.modal-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
.modal-close{margin-top:12px;}

/* toast */
.toast{position:fixed;bottom:24px;right:24px;background:var(--s2);border:1px solid var(--green);color:var(--text);padding:10px 16px;border-radius:10px;font-size:0.82rem;z-index:9999;transform:translateY(60px);opacity:0;transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;gap:8px;box-shadow:0 8px 30px rgba(0,0,0,0.5);}
.toast.on{transform:translateY(0);opacity:1;}
.toast.err{border-color:var(--rose);}

/* floating xp */
.xp-float{position:fixed;font-family:'DotGothic16',monospace;font-size:1rem;color:var(--amber);pointer-events:none;z-index:999;animation:floatUp 1.2s ease forwards;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1);}100%{opacity:0;transform:translateY(-60px) scale(1.3);}}

/* ===== ECONOMY / WAGE ===== */
.eco-bar{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;}
.eco-card{border-radius:14px;padding:16px 20px;position:relative;overflow:hidden;}
.eco-card.wage{background:linear-gradient(135deg,#120d04,#1e1608);border:1px solid rgba(245,158,11,.3);}
.eco-card.money{background:linear-gradient(135deg,#071a0f,var(--s1));border:1px solid rgba(74,222,128,.25);}
.eco-card.info{background:var(--s1);border:1px solid var(--border);}
.eco-label{font-size:.65rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:6px;}
.eco-big{font-family:'JetBrains Mono',monospace;font-size:2.6rem;font-weight:800;line-height:1;text-shadow:0 0 20px currentColor;letter-spacing:-.02em;}
.eco-unit{font-size:.72rem;color:var(--muted2);margin-top:3px;font-weight:600;}
.eco-sub{font-size:.62rem;color:var(--muted);margin-top:4px;}
.eco-bar-track{height:5px;background:var(--bg);border-radius:3px;overflow:hidden;margin-top:8px;}
.eco-bar-fill{height:100%;border-radius:3px;transition:width .8s ease;}
.eco-wage-next{font-size:.65rem;color:var(--muted);margin-top:5px;}
.wage-ladder{display:flex;flex-direction:column;gap:3px;margin-top:8px;}
.wl-row{display:flex;align-items:center;gap:6px;font-size:.67rem;opacity:.5;transition:opacity .2s;}
.wl-row.cur{opacity:1;font-weight:700;}
.wl-row.past{opacity:.35;}
.wl-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;background:var(--muted);}
.wl-row.cur .wl-dot{background:var(--gold);}
.wl-name{flex:1;color:var(--muted2);}
.wl-row.cur .wl-name{color:var(--text);}
.wl-wage{font-family:'JetBrains Mono',monospace;color:var(--muted);}
.wl-row.cur .wl-wage{color:var(--gold);}
.work-btn{width:100%;padding:11px;border:none;border-radius:10px;background:linear-gradient(135deg,#f59e0b,#fb923c);color:#000;font-weight:800;font-size:.9rem;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;transition:all .2s;margin-top:10px;}
.work-btn:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 18px rgba(245,158,11,.4);}
.work-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}

/* work modal */
.work-modal{background:linear-gradient(135deg,#0d1220,#120f06);border:2px solid var(--gold);border-radius:20px;padding:28px;max-width:420px;width:90%;animation:rewardIn .35s cubic-bezier(.34,1.56,.64,1);}
.wm-title{font-family:'DotGothic16',monospace;font-size:1.1rem;color:var(--gold);text-align:center;margin-bottom:4px;}
.wm-sub{font-size:.72rem;color:var(--muted2);text-align:center;margin-bottom:16px;line-height:1.5;}
.wm-wage-box{background:rgba(245,158,11,.09);border:1px solid rgba(245,158,11,.22);border-radius:11px;padding:12px;text-align:center;margin-bottom:14px;}
.wm-wage-big{font-family:'JetBrains Mono',monospace;font-size:2.1rem;font-weight:700;color:var(--gold);}
.wm-wage-lbl{font-size:.65rem;color:var(--muted2);margin-top:2px;}
.wm-hours-inp{background:var(--s2);border:1px solid var(--border);border-radius:9px;color:var(--text);padding:10px;font-family:'JetBrains Mono',monospace;font-size:1.1rem;width:100%;text-align:center;font-weight:700;margin-bottom:8px;}
.wm-hours-inp:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(245,158,11,.12);}
.wm-preview{text-align:center;font-size:.8rem;color:var(--muted2);margin-bottom:14px;}
.wm-preview strong{color:var(--green);font-family:'JetBrains Mono',monospace;font-size:1rem;}
.wm-worked-notice{font-size:.65rem;color:var(--rose);text-align:center;margin-top:8px;}

/* building shop */
.bld-section{display:flex;flex-direction:column;gap:6px;max-height:320px;overflow-y:auto;}
.bld-section::-webkit-scrollbar{width:3px;}
.bld-section::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.bld-item{display:flex;align-items:center;gap:9px;padding:8px 10px;background:var(--s2);border:1px solid var(--border);border-radius:9px;cursor:pointer;transition:all .15s;}
.bld-item:hover:not(.bld-owned){border-color:var(--gold);background:var(--s3);}
.bld-item.bld-owned{opacity:.5;cursor:default;}
.bld-item.bld-cant{opacity:.3;cursor:not-allowed;}
.bld-icon{font-size:1.3rem;flex-shrink:0;width:30px;text-align:center;}
.bld-info{flex:1;}
.bld-name{font-size:.78rem;font-weight:700;}
.bld-desc{font-size:.62rem;color:var(--muted2);}
.bld-cost{font-family:'JetBrains Mono',monospace;font-size:.72rem;font-weight:700;white-space:nowrap;}
.bld-cost.c-own{color:var(--green);}
.bld-cost.c-gold{color:var(--gold);}
.bld-cost.c-lock{color:var(--muted);}

/* town grid in page3 */
.town-display{background:linear-gradient(180deg,#060e1e,#0a1428);border:1px solid rgba(56,189,248,.12);border-radius:16px;padding:16px;margin-bottom:14px;}
.town-grid-vis{display:flex;flex-wrap:wrap;gap:6px;min-height:80px;align-items:flex-start;}
.town-bld{font-size:1.6rem;line-height:1;animation:popIn .3s ease;cursor:pointer;transition:transform .15s;}
.town-bld:hover{transform:scale(1.15);}
.town-empty{font-size:.72rem;color:var(--muted);padding:20px;text-align:center;width:100%;}
.town-pop{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--cyan);margin-top:8px;}

:root{--gold:#f59e0b;--gold2:#fcd34d;}

@media(max-width:900px){
  .p1-grid,.st-layout{grid-template-columns:1fr;}
  .charts-grid,.big-stats{grid-template-columns:1fr 1fr;}
  .eco-bar{grid-template-columns:1fr;}
}
@media(max-width:640px){
  .nav{padding:0 8px;gap:4px;}
  .nav-logo{display:none;}
  .ntab{padding:5px 10px;font-size:.72rem;}
  .nav-right{gap:4px;}
  .xp-pill{padding:3px 8px;font-size:.65rem;}
  .streak-pill{padding:3px 8px;font-size:.65rem;}
  .help-btn{width:28px;height:28px;font-size:.7rem;}
  select.sel{-webkit-appearance:menulist;appearance:menulist;background-image:none;padding-right:10px;}
}

/* ===== INVESTMENTS ===== */
.inv-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;margin-top:10px;}
.inv-card{background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:14px;transition:all .2s;cursor:pointer;position:relative;overflow:hidden;}
.inv-card:hover{border-color:var(--cyan);transform:translateY(-2px);box-shadow:0 4px 16px rgba(56,189,248,.1);}
.inv-card.locked{opacity:.4;cursor:not-allowed;}
.inv-card.locked:hover{transform:none;border-color:var(--border);}
.inv-card .inv-icon{font-size:1.6rem;margin-bottom:6px;}
.inv-card .inv-name{font-size:.82rem;font-weight:700;margin-bottom:2px;}
.inv-card .inv-desc{font-size:.62rem;color:var(--muted2);line-height:1.5;margin-bottom:6px;}
.inv-card .inv-yield{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--green);}
.inv-card .inv-cost{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--gold);}
.inv-card .inv-lock{font-size:.6rem;color:var(--rose);margin-top:4px;}
.inv-card.owned{border-color:rgba(74,222,128,.3);background:linear-gradient(135deg,var(--s2),#0a1a10);}
.inv-card.owned::after{content:'✓ 保有中';position:absolute;top:8px;right:10px;font-size:.58rem;color:var(--green);background:rgba(74,222,128,.12);padding:2px 7px;border-radius:8px;}
.passive-bar{background:linear-gradient(135deg,#071a10,#0d1a0a);border:1px solid rgba(74,222,128,.2);border-radius:14px;padding:14px 18px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
.passive-big{font-family:'JetBrains Mono',monospace;font-size:1.6rem;font-weight:700;color:var(--green);}
.passive-lbl{font-size:.62rem;color:var(--muted2);}
.collect-btn{padding:9px 22px;border:none;border-radius:10px;background:linear-gradient(135deg,#4ade80,#22d3ee);color:#000;font-weight:800;font-size:.82rem;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;transition:all .2s;}
.collect-btn:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 14px rgba(74,222,128,.3);}
.collect-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;}

/* ===== LIFESTYLE ===== */
.lifestyle-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;margin-top:8px;}
.ls-card{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px;cursor:pointer;transition:all .15s;}
.ls-card:hover{border-color:var(--amber);}
.ls-card.ls-active{border-color:rgba(251,191,36,.4);background:linear-gradient(135deg,var(--s2),#1a1508);}
.ls-card .ls-icon{font-size:1.3rem;}
.ls-card .ls-name{font-size:.78rem;font-weight:700;margin:3px 0 1px;}
.ls-card .ls-desc{font-size:.58rem;color:var(--muted2);}
.ls-card .ls-cost{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--gold);margin-top:4px;}
.ls-card .ls-bonus{font-size:.58rem;color:var(--green);}

/* ===== GACHA / SLOT ===== */
.gacha-section{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
.gacha-box{background:linear-gradient(135deg,#120818,#0a0520);border:1px solid rgba(168,85,247,.25);border-radius:14px;padding:16px;text-align:center;}
.gacha-title{font-family:'DotGothic16',monospace;font-size:.95rem;color:var(--violet);margin-bottom:6px;}
.gacha-desc{font-size:.62rem;color:var(--muted2);margin-bottom:10px;line-height:1.5;}
.gacha-btn{padding:10px 24px;border:none;border-radius:10px;font-weight:800;font-size:.85rem;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;transition:all .2s;}
.gacha-btn:hover{opacity:.9;transform:translateY(-1px);}
.gacha-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.gacha-btn.violet{background:linear-gradient(135deg,#a855f7,#7c3aed);color:#fff;}
.gacha-btn.gold{background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;}
.slot-box{background:linear-gradient(135deg,#1a0c08,#140a02);border:1px solid rgba(251,146,60,.25);border-radius:14px;padding:16px;text-align:center;}
.slot-title{font-family:'DotGothic16',monospace;font-size:.95rem;color:var(--orange);margin-bottom:6px;}
.slot-reels{display:flex;justify-content:center;gap:8px;margin:12px 0;}
.slot-reel{width:52px;height:52px;background:var(--bg);border:2px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;transition:all .15s;}
.slot-reel.spinning{animation:slotSpin .15s infinite;}
@keyframes slotSpin{0%{transform:translateY(-3px);}50%{transform:translateY(3px);}100%{transform:translateY(-3px);}}
.slot-result{font-size:.75rem;color:var(--amber);min-height:20px;margin-top:6px;}

/* ===== ACHIEVEMENTS ===== */
.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-top:10px;}
.ach-card{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;align-items:center;gap:10px;transition:all .15s;}
.ach-card.unlocked{border-color:rgba(251,191,36,.3);background:linear-gradient(135deg,var(--s2),#161008);}
.ach-card.unlocked .ach-icon{filter:none;}
.ach-card .ach-icon{font-size:1.4rem;filter:grayscale(1) brightness(.4);flex-shrink:0;}
.ach-card .ach-info{flex:1;min-width:0;}
.ach-card .ach-name{font-size:.72rem;font-weight:700;}
.ach-card .ach-desc{font-size:.58rem;color:var(--muted2);}
.ach-card .ach-rew{font-size:.55rem;color:var(--green);}

/* ===== HELP MODAL ===== */
.help-btn{background:var(--s2);border:1px solid var(--border);width:36px;height:36px;border-radius:50%;color:var(--cyan);font-size:1rem;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.help-btn:hover{background:var(--s3);border-color:var(--cyan);box-shadow:0 0 12px rgba(56,189,248,.2);}
.help-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);display:none;align-items:flex-start;justify-content:center;padding:60px 20px;overflow-y:auto;}
.help-overlay.show{display:flex;}
.help-box{background:var(--s1);border:1px solid var(--border2);border-radius:20px;max-width:700px;width:100%;padding:28px;max-height:85vh;overflow-y:auto;}
.help-box::-webkit-scrollbar{width:4px;}
.help-box::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.hb-title{font-family:'DotGothic16',monospace;font-size:1.1rem;color:var(--cyan);margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;}
.hb-section{margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border);}
.hb-section:last-child{border:none;margin-bottom:0;padding-bottom:0;}
.hb-h{font-size:.82rem;font-weight:700;margin-bottom:6px;color:var(--text);}
.hb-p{font-size:.7rem;color:var(--muted2);line-height:1.7;}
.hb-tag{display:inline-block;background:var(--s3);border:1px solid var(--border);padding:2px 8px;border-radius:6px;font-size:.6rem;color:var(--cyan);margin:0 2px;}
.hb-tbl{width:100%;border-collapse:collapse;margin-top:6px;font-size:.65rem;}
.hb-tbl th{background:var(--s2);padding:5px 8px;text-align:left;color:var(--muted2);font-weight:700;}
.hb-tbl td{padding:5px 8px;border-top:1px solid var(--border);color:var(--text);}

/* ===== SLEEP XP MODIFIER BADGE ===== */
.sleep-xp-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:8px;font-size:.6rem;font-family:'JetBrains Mono',monospace;font-weight:700;}
.sleep-xp-badge.excellent{background:rgba(74,222,128,.12);color:#4ade80;border:1px solid rgba(74,222,128,.25);}
.sleep-xp-badge.good{background:rgba(56,189,248,.1);color:#38bdf8;border:1px solid rgba(56,189,248,.2);}
.sleep-xp-badge.normal{background:rgba(100,116,139,.1);color:#94a3b8;border:1px solid rgba(100,116,139,.2);}
.sleep-xp-badge.poor{background:rgba(251,191,36,.1);color:#fbbf24;border:1px solid rgba(251,191,36,.2);}
.sleep-xp-badge.bad{background:rgba(251,113,133,.1);color:#fb7185;border:1px solid rgba(251,113,133,.2);}

/* sub-tabs in page3 */
.p3-subtabs{display:flex;gap:4px;margin-bottom:14px;flex-wrap:wrap;}
.p3-stab{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted2);cursor:pointer;font-size:.75rem;font-weight:700;transition:all .15s;font-family:'M PLUS Rounded 1c',sans-serif;}
.p3-stab:hover{background:var(--s3);color:var(--text);}
.p3-stab.active{background:var(--s3);color:var(--text);border-color:var(--border2);}
.p3-panel{display:none;}
.p3-panel.active{display:block;}
.debt-lock-overlay{position:absolute;inset:0;z-index:10;display:flex;align-items:center;justify-content:center;background:rgba(10,10,15,0.55);border-radius:12px;pointer-events:none;}

@media(max-width:900px){
  .inv-grid{grid-template-columns:1fr;}
  .gacha-section{grid-template-columns:1fr;}
  .ach-grid{grid-template-columns:1fr 1fr;}
  .lifestyle-grid{grid-template-columns:1fr 1fr;}
}

/* Daily Quests */
.dq-card{background:linear-gradient(135deg,var(--s1),#0f1b2e);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;}
.dq-title{font-size:.78rem;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.dq-list{display:flex;flex-direction:column;gap:5px;}
.dq-item{display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--s2);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s;font-size:.74rem;}
.dq-item:hover{border-color:var(--cyan);background:var(--s3);}
.dq-item.done{border-color:rgba(74,222,128,.3);background:linear-gradient(135deg,rgba(74,222,128,.05),transparent);}
.dq-check{width:18px;height:18px;border-radius:50%;border:2px solid var(--muted);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;font-size:.6rem;}
.dq-item.done .dq-check{border-color:var(--green);background:var(--green);color:#000;}
.dq-label{flex:1;}
.dq-xp{font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--green);flex-shrink:0;}
.dq-item.done .dq-label{text-decoration:line-through;opacity:.6;}
.dq-prog{display:flex;align-items:center;gap:6px;margin-top:6px;font-size:.62rem;color:var(--muted2);}
.dq-prog-bar{flex:1;height:4px;background:var(--s2);border-radius:2px;overflow:hidden;}
.dq-prog-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--cyan));border-radius:2px;transition:width .3s;}
/* Performance card */
.perf-card{background:linear-gradient(135deg,#0d1520,#111d30);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;}
.perf-row{display:flex;gap:8px;margin-bottom:8px;}
.perf-metric{flex:1;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center;}
.perf-val{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;}
.perf-delta{font-family:'JetBrains Mono',monospace;font-size:.68rem;margin-top:2px;}
.perf-lbl{font-size:.58rem;color:var(--muted2);margin-top:2px;}
.perf-rank{text-align:center;padding:8px;background:var(--s2);border:1px solid var(--border);border-radius:8px;font-size:.72rem;line-height:1.6;}
.perf-rank-num{font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:800;}
/* ===== TUTORIAL ===== */
.tut-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.82);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;padding:20px;transition:opacity .3s;}
.tut-overlay.show{display:flex;}
.tut-card{background:linear-gradient(145deg,#0d1220,#111828);border:1px solid rgba(0,212,255,.2);border-radius:22px;max-width:460px;width:100%;padding:32px 28px;animation:tutIn .4s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden;}
.tut-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,rgba(0,212,255,.04),transparent,rgba(168,85,247,.04),transparent);animation:tutGlow 8s linear infinite;}
@keyframes tutIn{from{opacity:0;transform:scale(.85) translateY(20px);}to{opacity:1;transform:scale(1) translateY(0);}}
@keyframes tutGlow{to{transform:rotate(360deg);}}
.tut-inner{position:relative;z-index:1;}
.tut-step-indicator{display:flex;justify-content:center;gap:6px;margin-bottom:20px;}
.tut-dot{width:8px;height:8px;border-radius:50%;background:var(--s3);border:1px solid var(--border);transition:all .3s;}
.tut-dot.active{background:var(--cyan);border-color:var(--cyan);box-shadow:0 0 8px rgba(0,212,255,.5);}
.tut-dot.done{background:var(--green);border-color:var(--green);}
.tut-emoji{font-size:2.8rem;text-align:center;margin-bottom:14px;filter:drop-shadow(0 4px 16px rgba(0,0,0,.5));}
.tut-title{font-family:'DotGothic16',monospace;font-size:1.1rem;color:var(--cyan);text-align:center;margin-bottom:10px;text-shadow:0 0 12px rgba(0,212,255,.3);}
.tut-desc{font-size:.75rem;color:var(--muted2);line-height:1.8;text-align:center;margin-bottom:20px;}
.tut-desc strong{color:var(--text);font-weight:700;}
.tut-desc .th{display:inline-block;background:var(--s3);border:1px solid var(--border);padding:1px 7px;border-radius:5px;font-size:.65rem;color:var(--cyan);margin:1px 2px;font-weight:700;}
.tut-desc .tg{display:inline-block;background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.2);padding:1px 7px;border-radius:5px;font-size:.65rem;color:var(--green);margin:1px 2px;font-weight:700;}
.tut-desc .tr{display:inline-block;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);padding:1px 7px;border-radius:5px;font-size:.65rem;color:var(--amber);margin:1px 2px;font-weight:700;}
.tut-btns{display:flex;gap:8px;justify-content:center;}
.tut-btn{padding:10px 28px;border:none;border-radius:12px;font-weight:800;font-size:.82rem;cursor:pointer;transition:all .2s;font-family:'M PLUS Rounded 1c',sans-serif;}
.tut-btn:hover{transform:translateY(-1px);}
.tut-btn.primary{background:linear-gradient(135deg,#00d4ff,#0ea5e9);color:#000;box-shadow:0 4px 20px rgba(0,212,255,.3);}
.tut-btn.secondary{background:var(--s3);color:var(--muted2);border:1px solid var(--border);}
.tut-btn.skip{background:none;border:none;color:var(--muted);font-size:.68rem;padding:6px 12px;}
.tut-flow{display:flex;align-items:center;justify-content:center;gap:6px;margin:12px 0;flex-wrap:wrap;}
.tut-flow .tf-node{background:var(--s3);border:1px solid var(--border);padding:4px 10px;border-radius:8px;font-size:.62rem;font-weight:700;color:var(--text);}
.tut-flow .tf-arrow{color:var(--cyan);font-size:.7rem;}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="nav-logo">TIMEFLOW</div>
  <div class="nav-tabs">
    <button class="ntab active" id="nt0" onclick="gotoPage(0)">📝 記録</button>
    <button class="ntab" id="nt1" onclick="gotoPage(1)">📊 統計</button>
    <button class="ntab" id="nt2" onclick="gotoPage(2)">🌿 育成</button>
  </div>
  <div class="nav-right">
    <div class="xp-pill" style="border-color:rgba(245,158,11,.35);">💰 <span style="color:#f59e0b;font-weight:700;" id="navGold">0</span> <span style="color:var(--muted2)">G</span></div>
    <div class="xp-pill">⚡ <span class="xp-num" id="navXP">0</span> <span style="color:var(--muted2)">XP</span></div>
    <div class="streak-pill">🔥 <span id="navStreak">0</span>日</div>
    <div class="streak-pill" id="rebirthPill" style="display:none;border-color:rgba(192,132,252,.4);"></div>
  
    <button class="help-btn" onclick="openHelp()" title="ヘルプ">?</button></div>
</nav>

<!-- ==================== PAGE 1: RECORD ==================== -->
<div class="page active" id="page0">
<div class="wrap">

  <!-- date nav -->
  <div class="date-row">
    <div class="date-ctrl">
      <button class="nav-btn" onclick="changeDate(-1)">&#8592;</button>
      <div class="date-pill" id="datePill"></div>
      <button class="nav-btn" onclick="changeDate(1)">&#8594;</button>
      <button class="today-btn" onclick="goToday()">今日</button>
    </div>
  </div>

  <div class="p1-grid">
    <!-- LEFT: input -->
    <div style="display:flex;flex-direction:column;gap:14px;">
      <div class="card">
        <div class="card-hd"><div class="card-hd-dot"></div>時間ブロック入力</div>
        <div style="display:flex;gap:4px;margin-bottom:8px;align-items:center;">
          <span style="font-size:.58rem;color:var(--muted2);margin-right:2px;">刻み:</span>
          <button class="tstep-btn" id="tstep1" onclick="setTimeStep(1)">1分</button>
          <button class="tstep-btn active" id="tstep10" onclick="setTimeStep(10)">10分</button>
          <button class="tstep-btn" id="tstep30" onclick="setTimeStep(30)">30分</button>
          <button class="tstep-btn" id="tstep60" onclick="setTimeStep(60)">1時間</button>
        </div>
        <div class="input-row">
          <div class="time-input-wrap">
            <div class="inp-lbl">開始</div>
            <select id="startTime" class="time-sel"></select>
            <div class="time-steppers">
              <button class="time-step-btn" onclick="stepTime('startTime',-60)">-1h</button>
              <button class="time-step-btn" onclick="stepTime('startTime',-30)">-30m</button>
              <button class="time-step-btn" onclick="stepTime('startTime',-10)">-10m</button>
              <button class="time-step-btn" onclick="stepTime('startTime',10)">+10m</button>
              <button class="time-step-btn" onclick="stepTime('startTime',30)">+30m</button>
              <button class="time-step-btn" onclick="stepTime('startTime',60)">+1h</button>
            </div>
          </div>
          <div class="time-input-wrap">
            <div class="inp-lbl">終了</div>
            <select id="endTime" class="time-sel"></select>
            <div class="time-steppers">
              <button class="time-step-btn" onclick="stepTime('endTime',-60)">-1h</button>
              <button class="time-step-btn" onclick="stepTime('endTime',-30)">-30m</button>
              <button class="time-step-btn" onclick="stepTime('endTime',-10)">-10m</button>
              <button class="time-step-btn" onclick="stepTime('endTime',10)">+10m</button>
              <button class="time-step-btn" onclick="stepTime('endTime',30)">+30m</button>
              <button class="time-step-btn" onclick="stepTime('endTime',60)">+1h</button>
            </div>
          </div>
        </div>
        <div><div class="inp-lbl">カテゴリ</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <select class="sel" id="category" style="flex:1;min-width:0;min-height:44px;"></select>
            <button onclick="showAddSubCat()" style="padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--cyan);font-size:.68rem;font-weight:700;cursor:pointer;white-space:nowrap;min-height:44px;" title="サブカテゴリ追加">＋詳細</button>
          </div>
        </div>
        <button class="add-btn" onclick="addBlock()">＋ 追加</button>
        <div class="daytpl-bar" id="dayTplBar">
          <span style="font-size:.62rem;color:var(--muted2);flex-shrink:0;">📅 一日テンプレ：</span>
        </div>
        <div class="quick-adds" id="quickAdds"></div>

        <!-- XP progress mini -->
        <div style="display:flex;align-items:center;gap:8px;margin-top:10px;">
          <span style="font-size:0.65rem;color:var(--muted2);font-family:'JetBrains Mono',monospace;white-space:nowrap;">本日XP</span>
          <div class="xp-track" style="flex:1;height:6px;"><div class="xp-fill" id="dayXPBar" style="width:0%"></div></div>
          <span style="font-size:0.65rem;color:var(--green);font-family:'JetBrains Mono',monospace;" id="dayXPVal">0</span>
        </div>

        <div class="tl-wrap" id="timeline">
          <div style="display:flex;height:100%;align-items:center;justify-content:center;color:var(--muted);font-size:0.68rem;">タイムライン</div>
        </div>
        <div class="tl-ticks"><span class="tl-tick">0</span><span class="tl-tick">6</span><span class="tl-tick">12</span><span class="tl-tick">18</span><span class="tl-tick">24</span></div>
        <div class="blist" id="blockList"><div style="text-align:center;color:var(--muted);font-size:0.78rem;padding:14px;">ブロックがありません</div></div>
      </div>

      <!-- Sleep (auto-calculated from sleep blocks) -->
      <div class="card" style="background:linear-gradient(135deg,var(--s1) 60%,#110a2a);border-color:rgba(192,132,252,0.15);">
        <div class="card-hd"><div class="card-hd-dot" style="background:var(--violet);"></div>睡眠スコア
          <span style="font-size:0.62rem;color:var(--muted);margin-left:auto;cursor:pointer;" onclick="openSleepIdealEditor()" title="クリックして理想値を編集">理想: <span id="idealDisplay">23:00就寝 / 6:30起床 / 7.5h</span> ✏️</span>
        </div>
        <div class="sleep-grid">
          <div class="sleep-arc-wrap">
            <svg viewBox="0 0 88 88"><circle cx="44" cy="44" r="37" fill="none" stroke="var(--s3)" stroke-width="7"/><circle id="sleepArc" cx="44" cy="44" r="37" fill="none" stroke="#c084fc" stroke-width="7" stroke-dasharray="232.48" stroke-dashoffset="232.48" transform="rotate(-90 44 44)" stroke-linecap="round"/></svg>
            <div class="sleep-center"><div class="sleep-num" id="sleepScore" style="color:var(--violet)">--</div><div class="sleep-unit">点</div></div>
          </div>
          <div>
            <div id="sleepBlockInfo" style="font-size:.72rem;color:var(--muted2);margin-bottom:6px;">🌙 睡眠ブロックを追加すると自動計算されます</div>
            <div class="sleep-band"><div class="sleep-band-fill" id="sleepBand" style="width:0%"></div></div>
            <div class="sleep-msg" id="sleepMsg" style="color:var(--muted2)">睡眠カテゴリで時間を記録してください</div>
            <div style="font-size:.55rem;color:var(--muted);margin-top:4px;">💡 日またぎOK：例 23:00→07:00 で自動分割</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: metrics + pie -->
    <div class="right-col">
      <div class="metrics-row">
        <div class="metric-card">
          <div class="metric-val" id="m_total" style="color:var(--cyan)">0:00</div>
          <div class="metric-lbl">記録時間</div>
          <div class="metric-trend" id="m_total_trend"></div>
        </div>
        <div class="metric-card">
          <div class="metric-val" id="m_effort" style="color:var(--green)">0:00</div>
          <div class="metric-lbl">努力時間</div>
          <div class="metric-trend" id="m_effort_trend"></div>
        </div>
        <div class="metric-card">
          <div class="metric-val" id="m_sleep" style="color:var(--violet)">--</div>
          <div class="metric-lbl">睡眠スコア</div>
          <div class="metric-trend" id="m_sleep_trend"></div>
        </div>
      </div>

      <!-- Performance comparison card -->
      <div class="perf-card" id="perfCard" style="display:none;">
        <div style="font-size:.78rem;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;">📊 前日比パフォーマンス</div>
        <div class="perf-row">
          <div class="perf-metric">
            <div class="perf-val" id="perf_effort" style="color:var(--green);">--</div>
            <div class="perf-delta" id="perf_effort_delta"></div>
            <div class="perf-lbl">努力時間</div>
          </div>
          <div class="perf-metric">
            <div class="perf-val" id="perf_sleep" style="color:var(--violet);">--</div>
            <div class="perf-delta" id="perf_sleep_delta"></div>
            <div class="perf-lbl">睡眠スコア</div>
          </div>
        </div>
        <div class="perf-rank" id="perfRank"></div>
      </div>

      <!-- Pie Chart -->
      <div class="card">
        <div class="card-hd"><div class="card-hd-dot"></div>24時間タイムライン</div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:12px;">
          <div style="position:relative;width:340px;height:340px;flex-shrink:0;">
            <canvas id="clockCanvas" width="680" height="680" style="width:340px;height:340px;"></canvas>
            <div class="pie-mid"><div class="pie-mid-h" id="pieTotal">0h</div><div class="pie-mid-l">記録</div></div>
          </div>
          <div class="legend" id="pieLegend" style="width:100%;"></div>
        </div>
      </div>

      <div class="effort-banner">
        <div><div class="effort-big" id="effortBig">0:00</div><div class="effort-lbl">総努力時間</div><div style="font-size:0.62rem;color:var(--muted);margin-top:2px;">仕事・学習・運動＋特別項目</div></div>
        <div style="flex:1;" id="effortBars"></div>
      </div>

      <!-- Daily Quests -->
      <div class="dq-card">
        <div class="dq-title">✅ デイリークエスト <span style="font-size:.6rem;color:var(--muted2);font-weight:400;" id="dqDate"></span></div>
        <div class="dq-list" id="dqList"></div>
        <div class="dq-prog"><span id="dqProg">0/0</span><div class="dq-prog-bar"><div class="dq-prog-fill" id="dqProgBar" style="width:0%;"></div></div><span id="dqBonus" style="color:var(--green);"></span></div>
        <div style="margin-top:6px;display:flex;gap:4px;">
          <button class="btn sm" onclick="openQuestEditor()" style="font-size:.62rem;">⚙ クエスト編集</button>
        </div>
      </div>

      <!-- ToDo Goals -->
      <div class="card">
        <div class="card-hd" style="justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:7px;"><div class="card-hd-dot" style="background:#4ade80;"></div>📋 目標リスト <span style="font-size:.58rem;color:var(--muted);font-weight:400;" id="todoCount">0個</span></div>
          <button class="btn sm" onclick="openAddTodo()">＋ 追加</button>
        </div>
        <div id="todoList" style="display:flex;flex-direction:column;gap:8px;"></div>
        <div id="todoAddForm" style="display:none;background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px;">
          <div style="font-size:.75rem;font-weight:700;margin-bottom:8px;">📋 新しい目標</div>
          <input id="todoTitle" placeholder="目標のタイトル" maxlength="60" style="width:100%;padding:8px 10px;background:var(--s1);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.8rem;margin-bottom:6px;box-sizing:border-box;">
          <textarea id="todoDesc" placeholder="詳細メモ（任意）" maxlength="200" rows="2" style="width:100%;padding:8px 10px;background:var(--s1);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.7rem;resize:none;margin-bottom:6px;box-sizing:border-box;"></textarea>
          <div style="margin-bottom:8px;"><div class="inp-lbl" style="font-size:.6rem;">達成XP</div>
            <select id="todoXP" style="width:100%;padding:6px;background:var(--s1);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.75rem;">
              <option value="100">100 XP（小さい目標）</option>
              <option value="300">300 XP（中くらい）</option>
              <option value="500" selected>500 XP（大きい目標）</option>
              <option value="1000">1,000 XP（超大物）</option>
              <option value="2000">2,000 XP（人生レベル）</option>
            </select>
          </div>
          <div style="display:flex;gap:6px;">
            <button class="btn sm" onclick="addTodoItem()" style="background:linear-gradient(135deg,#4ade80,#22c55e);color:#000;font-weight:700;">追加</button>
            <button class="btn sm" onclick="document.getElementById('todoAddForm').style.display='none'">キャンセル</button>
          </div>
        </div>
      </div>

      <!-- Special high-xp items -->
      <div class="card">
        <div class="card-hd" style="justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:7px;"><div class="card-hd-dot" style="background:var(--amber);"></div>⭐ 特別XP項目</div>
          <button class="btn sm" onclick="openSpecialModal()">＋ 追加</button>
        </div>
        <div class="special-list" id="specialList"><div style="font-size:0.75rem;color:var(--muted);text-align:center;padding:10px;">特別項目がありません<br><span style="font-size:0.65rem;">自分が重要視する行動を登録してXPボーナスを得よう</span></div></div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ==================== PAGE 2: STATS ==================== -->
<div class="page" id="page1">
<div class="wrap">
  <div class="cue-card" id="cueCard">
    <div class="cue-emoji" id="cueEmoji">📊</div>
    <div class="cue-text"><div class="cue-main" id="cueMain">統計を確認しよう</div><div class="cue-sub" id="cueSub">記録が積み重なるほど洞察が深まります</div></div>
  </div>

  <div class="big-stats">
    <div class="bstat"><div class="bstat-icon">🔥</div><div class="bstat-val" id="bs_streak" style="color:var(--amber)">0</div><div class="bstat-lbl">継続</div><div class="bstat-sub" style="color:var(--muted2)">日</div></div>
    <div class="bstat"><div class="bstat-icon">⚡</div><div class="bstat-val" id="bs_xp" style="color:var(--green)">0</div><div class="bstat-lbl">累計XP</div><div class="bstat-sub" style="color:var(--muted2)">ポイント</div></div>
    <div class="bstat"><div class="bstat-icon">💪</div><div class="bstat-val" id="bs_effort" style="color:var(--cyan)">0h</div><div class="bstat-lbl">累計努力時間</div><div class="bstat-sub" id="bs_effort_sub" style="color:var(--muted2)">記録日平均</div></div>
    <div class="bstat"><div class="bstat-icon">🌙</div><div class="bstat-val" id="bs_sleep" style="color:var(--violet)">--</div><div class="bstat-lbl">平均睡眠スコア</div><div class="bstat-sub" style="color:var(--muted2)">/ 100点</div></div>
  </div>

  <!-- Category Summary -->
  <div class="card" style="margin-bottom:14px;">
    <div class="card-hd"><div class="card-hd-dot" style="background:var(--cyan);"></div>カテゴリ別サマリー</div>
    <div style="display:flex;gap:4px;margin-bottom:10px;">
      <button class="tstep-btn active" id="sumWeek" onclick="setSumTab('week')">📅 直近7日間</button>
      <button class="tstep-btn" id="sumAll" onclick="setSumTab('all')">📊 すべての合計</button>
    </div>
    <div id="catSummary"></div>
  </div>

  <div class="trend-hd">
    <div class="trend-title">推移グラフ</div>
    <div class="trend-tabs"><button class="ttab active" id="trendDayBtn" onclick="setTrend('day')">日足</button><button class="ttab" id="trendWeekBtn" onclick="setTrend('week')">週足</button></div>
  </div>
  <div class="charts-grid">
    <div class="chart-card"><div class="chart-title">カテゴリ別推移</div><div class="chart-h"><canvas id="lineChart"></canvas></div></div>
    <div class="chart-card"><div class="chart-title">努力時間 × 睡眠スコア</div><div class="chart-h"><canvas id="effortChart"></canvas></div></div>
  </div>

  <div class="card" style="margin-bottom:14px;">
    <div class="card-hd"><div class="card-hd-dot" style="background:var(--amber);"></div>習慣チェーン — 続けて繋げよう</div>
    <div class="hgrid" id="habitGrid"></div>
    <div id="streakRewardArea" style="margin-top:10px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.15);border-radius:10px;">
      <div>
        <div style="font-size:.68rem;color:var(--amber);font-weight:700;">🔥 <span id="streakRewardDays">0</span>日継続ボーナス</div>
        <div style="font-size:.58rem;color:var(--muted2);" id="streakRewardDesc">記録するとボーナスGがもらえます</div>
      </div>
      <button id="streakRewardBtn" class="gacha-btn gold" onclick="collectStreakReward()" style="font-size:.72rem;padding:6px 16px;">📥 受け取る</button>
    </div>
  </div>

  <div class="card">
    <div class="card-hd"><div class="card-hd-dot"></div>記録履歴</div>
    <div class="hist-list" id="histList"><div style="text-align:center;color:var(--muted);font-size:0.78rem;padding:14px;">データがありません</div></div>
  </div>
</div>
</div>

<!-- ==================== PAGE 3: LIFE RPG ==================== -->
<div class="page" id="page2">
<div class="wrap">

  <!-- SLEEP XP MODIFIER DISPLAY -->
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
    <span style="font-size:.65rem;color:var(--muted2);">睡眠XP倍率:</span>
    <span class="sleep-xp-badge normal" id="sleepXPBadge">×1.0</span>
  </div>

  <!-- ECONOMY BAR -->
  <div class="eco-bar">
    <div class="eco-card wage">
      <div class="eco-label"><span style="font-size:1.6rem;vertical-align:middle;margin-right:4px;">⏰</span> 現在の時給</div>
      <div class="eco-big" id="wageDisplay" style="color:#f59e0b;">500 G/h</div>
      <div class="eco-unit">/ 時間</div>
      <div class="eco-bar-track"><div class="eco-bar-fill" id="wageBarFill" style="width:0%;background:linear-gradient(90deg,#f59e0b,#fcd34d);"></div></div>
      <div class="eco-wage-next" id="wageNext">スキルを育てると時給が上昇します</div>
      <div class="wage-ladder" id="wageLadder"></div>
    </div>
    <div class="eco-card money">
      <div class="eco-label"><span style="font-size:1.6rem;vertical-align:middle;margin-right:4px;">💰</span> 所持金</div>
      <div class="eco-big" id="goldDisplay" style="color:var(--green);">0 G</div>
      <div class="eco-unit">ゴールド</div>
      <div class="eco-sub" id="goldToday">本日の稼ぎ: 0 G</div>
      <div class="eco-sub" id="debtDisplay" style="display:none;color:var(--rose);font-weight:700;font-size:.78rem;margin-top:4px;">💸 ローン残高: 0 G</div>
      <button id="debtPayBtn" onclick="manualPayDebt()" style="display:none;margin-top:4px;padding:5px 12px;border:none;border-radius:6px;background:linear-gradient(135deg,#ef4444,#f97316);color:#fff;font-size:.68rem;font-weight:700;cursor:pointer;">💸 所持金から返済する</button>
      <button class="work-btn" id="workBtn" onclick="openWorkModal()">⚒ 時間を換金する</button>
      <div class="wm-worked-notice" id="workedNotice" style="display:none;">✓ 今日はすでに換金済みです</div>
    </div>
    <div class="eco-card info">
      <div class="eco-label"><span style="font-size:1.6rem;vertical-align:middle;margin-right:4px;">📊</span> 不労所得</div>
      <div class="eco-big" id="passiveDisplay" style="color:var(--green);">0 G</div>
      <div class="eco-unit">/ 日</div>
      <div class="eco-sub" id="passiveDetail">投資や事業から毎日自動で収入を得られます</div>
    </div>
  </div>

  <!-- PASSIVE INCOME COLLECT BAR -->
  <div class="passive-bar" id="passiveBar" style="display:none;">
    <div>
      <div class="passive-lbl">📥 未受取の不労所得</div>
      <div class="passive-big" id="passiveCollectAmt">0 G</div>
    </div>
    <button class="collect-btn" id="collectBtn" onclick="collectPassive()">📥 受け取る</button>
  </div>

  <!-- XP bar -->
  <div style="background:var(--s1);border:1px solid rgba(74,222,128,.18);border-radius:12px;padding:11px 16px;margin-bottom:14px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
      <span style="font-size:.65rem;color:var(--muted2);">⚡ 使用可能XP</span>
      <span style="font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--green);font-weight:700;" id="gardenXP">0 XP</span>
    </div>
    <div class="xp-track" style="height:7px;"><div class="xp-fill" id="gardenXPBar" style="width:0%"></div></div>
  </div>

  <!-- Self status -->
  <div class="self-status">
    <div class="avatar-wrap">
      <div class="avatar-ring" id="avatarEmoji">🧑</div>
      <div class="avatar-lv-badge" id="avatarLv">Lv.1</div>
    </div>
    <div class="self-info">
      <div class="self-name-row">
        <div class="self-name">あなた</div>
        <div class="self-title-badge" id="selfTitle">見習い</div>
      </div>
      <div class="self-stats-row">
        <div class="ss-stat"><div class="ss-val" id="ss_days">0</div><div class="ss-lbl">記録日数</div></div>
        <div class="ss-stat"><div class="ss-val" id="ss_streak">0</div><div class="ss-lbl">連続</div></div>
        <div class="ss-stat"><div class="ss-val" id="ss_effort">0h</div><div class="ss-lbl">累計努力</div></div>
        <div class="ss-stat"><div class="ss-val" id="ss_totalxp">0</div><div class="ss-lbl">総XP</div></div>
        <div class="ss-stat"><div class="ss-val" id="ss_wage" style="color:#f59e0b;">500 G/h</div><div class="ss-lbl">時給</div></div>
        <div class="ss-stat"><div class="ss-val" id="ss_gold" style="color:var(--green);">0</div><div class="ss-lbl">累計収入G</div></div>
      </div>
      <div class="self-bars" id="selfBars"></div>
    </div>
  </div>

  <!-- SUB-TABS -->
  <div class="p3-subtabs">
    <button class="p3-stab active" id="p3t_skills" onclick="setP3Tab('skills')">🧬 スキル</button>
    <button class="p3-stab" id="p3t_invest" onclick="setP3Tab('invest')">📈 資産運用</button>
    <button class="p3-stab" id="p3t_life" onclick="setP3Tab('life')">🏠 生活</button>
    <button class="p3-stab" id="p3t_town" onclick="setP3Tab('town')">🏘️ 街</button>
    <button class="p3-stab" id="p3t_slot" onclick="setP3Tab('slot')">🎰 娯楽</button>
    <button class="p3-stab" id="p3t_ach" onclick="setP3Tab('ach')">🏆 実績</button>
  </div>

  <!-- PANEL: SKILLS -->
  <div class="p3-panel active" id="panel_skills">
    <div class="st-layout">
      <div class="st-canvas">
        <div class="st-canvas-title">
          <span>スキルツリー — 自己設計</span>
          <div class="st-tabs">
            <button class="sttab active" id="sttab0" onclick="setSTTab('domains')">ドメイン</button>
            <button class="sttab" id="sttab1" onclick="setSTTab('tree')">スキル</button>
          </div>
        </div>
        <div id="domainView">
          <div style="font-size:.7rem;color:var(--muted2);margin-bottom:10px;">記録時間→スキル成長→時給上昇→ゴールド→資産運用 の完全なループ</div>
          <div class="domain-grid" id="domainGrid"></div>
        </div>
        <div id="treeView" style="display:none;">
          <div style="display:flex;align-items:center;gap:7px;margin-bottom:10px;">
            <button class="btn sm" onclick="setSTTab('domains')">← 戻る</button>
            <span style="font-size:.8rem;font-weight:800;" id="selectedDomainName"></span>
          </div>
          <div id="skillTreeSVGWrap"></div>
        </div>
      </div>
      <div class="st-right">
        <div class="skill-detail" id="skillDetail">
          <div class="sd-empty">← スキルを選択<br><span style="font-size:.65rem;display:block;margin-top:4px;">ドメインカードをクリック</span></div>
        </div>
        <div class="event-log">
          <div class="el-title">📖 成長の記録</div>
          <div class="el-list" id="eventLog"><div style="text-align:center;color:var(--muted);font-size:.72rem;padding:10px;">記録を始めると物語が動き出します</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PANEL: INVESTMENTS -->
  <div class="p3-panel" id="panel_invest">
    <div class="card" style="margin-bottom:12px;">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--green);"></div>📈 株式投資</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:8px;">株価は日々変動します。複数口購入・売却可能。安く買って高く売ろう。</div>
      <div class="inv-grid" id="stockGrid"></div>
    </div>
    <div class="card" style="margin-bottom:12px;">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--amber);"></div>🏠 不動産</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:8px;">複数物件を保有可能。家賃は月1回回収。物件は経年で減価します。</div>
      <button id="rentCollectBtn" onclick="collectRent()" style="display:none;width:100%;padding:8px;margin-bottom:8px;border:none;border-radius:8px;background:linear-gradient(135deg,#4ade80,#22d3ee);color:#000;font-size:.78rem;font-weight:700;cursor:pointer;">🏠 家賃を回収する</button>
      <div class="inv-grid" id="realEstateGrid"></div>
    </div>
    <div class="card" style="margin-bottom:12px;">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--violet);"></div>🏢 事業・人材</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:8px;">街の人口から従業員を雇用。同じ事業を複数設立可能。人口が足りないと雇えません。</div>
      <div class="inv-grid" id="businessGrid"></div>
    </div>
  </div>

  <!-- PANEL: TOWN -->
  <div class="p3-panel" id="panel_town">
    <!-- Town Title & Rank -->
    <div style="background:linear-gradient(180deg,#060e1e,#0a1428);border:1px solid rgba(56,189,248,.12);border-radius:16px;padding:16px;margin-bottom:12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:var(--cyan);">🏘️ マイタウン</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:.65rem;color:var(--muted2);" id="townPopLabel">人口: 0人</span>
          <span style="font-size:.65rem;background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.25);color:var(--cyan);padding:2px 8px;border-radius:8px;font-family:'JetBrains Mono',monospace;" id="townRankBadge">村</span>
        </div>
      </div>
      <div id="townGridVis" style="display:flex;flex-wrap:wrap;gap:6px;min-height:70px;align-items:flex-start;"></div>
      <div id="townPop" style="font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--cyan);margin-top:8px;"></div>
      <!-- Town rank progress -->
      <div style="margin-top:8px;">
        <div style="display:flex;justify-content:space-between;font-size:.6rem;color:var(--muted2);margin-bottom:3px;">
          <span id="townRankLabel">次のランク: 集落</span>
          <span id="townRankProg">0/50人</span>
        </div>
        <div class="xp-track" style="height:6px;"><div class="xp-fill" id="townRankBar" style="width:0%;background:linear-gradient(90deg,#38bdf8,#818cf8);"></div></div>
      </div>
      <!-- Town bonus display -->
      <div style="margin-top:8px;padding:8px;background:rgba(56,189,248,.06);border:1px solid rgba(56,189,248,.12);border-radius:8px;">
        <div style="font-size:.6rem;color:var(--muted2);margin-bottom:3px;">🎁 街ランクボーナス</div>
        <div style="font-size:.68rem;color:var(--cyan);font-family:'JetBrains Mono',monospace;" id="townBonusText">ボーナスなし</div>
      </div>
    </div>
    <!-- Build shop -->
    <div class="card">
      <div class="card-hd" style="justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:6px;"><div class="card-hd-dot" style="background:#f59e0b;"></div>建設ショップ</div>
        <span style="font-size:.65rem;color:var(--muted2);">所持金: <span id="shopGoldLabel" style="color:#f59e0b;font-family:'JetBrains Mono',monospace;">0 G</span></span>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;max-height:600px;overflow-y:auto;" id="bldShop"></div>
    </div>
  </div>

  <!-- PANEL: LIFE (生活水準) -->
  <div class="p3-panel" id="panel_life">
    <!-- Housing -->
    <div class="card" style="margin-bottom:12px;">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--amber);"></div>🏠 住居アップグレード</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:4px;">住まいを良くするとXPボーナスが永続的に上がります。</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:10px;background:var(--s2);border:1px solid var(--border);border-radius:10px;">
        <span style="font-size:2rem;" id="curHousingIcon">🛖</span>
        <div>
          <div style="font-size:.82rem;font-weight:700;" id="curHousingName">野宿</div>
          <div style="font-size:.6rem;color:var(--muted2);" id="curHousingBonus">XPボーナス: +0%</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:5px;" id="housingList"></div>
    </div>
    <!-- Interior -->
    <div class="card" style="margin-bottom:12px;">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--rose);"></div>🛋️ インテリア</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:8px;">家具や設備を揃えてXPボーナスをさらに積み上げよう。</div>
      <div class="inv-grid" id="interiorGrid"></div>
    </div>
    <!-- Subscriptions -->
    <div class="card">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--violet);"></div>📱 サブスクリプション</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:8px;">毎日コストがかかるがXP倍率ボーナス。解約も可能。</div>
      <div class="lifestyle-grid" id="lifestyleGrid"></div>
    </div>
  </div>

  <!-- PANEL: SLOT -->
  <div class="p3-panel" id="panel_slot">
    <!-- Entertainment sub-tabs -->
    <div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;">
      <button class="btn sm" id="entTab_slot" onclick="setEntTab('slot')" style="background:var(--s3);border-color:var(--orange);color:var(--orange);">🎰 スロット</button>
      <button class="btn sm" id="entTab_pachinko" onclick="setEntTab('pachinko')" style="background:var(--s2);">🔮 フォーチュンマシン</button>
      <button class="btn sm" id="entTab_mystery" onclick="setEntTab('mystery')" style="background:var(--s2);">🎁 ナゾガチャ</button>
      <button class="btn sm" id="entTab_luxgacha" onclick="setEntTab('luxgacha')" style="background:var(--s2);">💎 高級ガチャ</button>
      <button class="btn sm" id="entTab_loan" onclick="setEntTab('loan')" style="background:var(--s2);">🏦 消費者金融</button>
    </div>


      <div style="background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.2);border-radius:10px;padding:10px 14px;margin-bottom:14px;font-size:.65rem;color:var(--muted2);line-height:1.6;text-align:center;">
        ⚠️ <span style="color:var(--cyan);font-weight:700;">注意</span>：このゲーム内の「フォーチュンマシン」「スロット」「消費者金融」等はすべて<span style="font-weight:700;color:var(--text);">架空のゲーム内通貨（ゴールド）</span>を使用する演出です。現実の金銭・賭博・金融取引とは一切関係ありません。安心してゲームをお楽しみください。
      </div>
    <!-- SLOT -->
    <div id="entPanel_slot">
      <div class="slot-box" style="max-width:420px;margin:0 auto;">
        <div class="slot-title">🎰 スロットマシン</div>
        <div class="gacha-desc">運試し！ 期待値はマイナスだけど当たればデカい。<br>777で超ジャックポット！</div>
        <div class="slot-reels">
          <div class="slot-reel" id="reel0">🍒</div>
          <div class="slot-reel" id="reel1">🍋</div>
          <div class="slot-reel" id="reel2">⭐</div>
        </div>
        <button class="gacha-btn gold" onclick="spinSlot()">回す (80G)</button>
        <div class="slot-result" id="slotResult"></div>
        <div style="margin-top:12px;font-size:.6rem;color:var(--muted);text-align:center;">
          3つ揃い: +250〜5000G | 2つ揃い: +20G | はずれ: -80G<br>
          期待値: 約 -30G/回 ※ 娯楽です
        </div>
      </div>
    </div>

    <!-- PACHINKO (3 machines) -->
    <div id="entPanel_pachinko" style="display:none;">
      <div style="display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap;">
        <button class="btn sm pachi-sel active" id="pachiSel_std" onclick="setPachiMachine('std')" style="flex:1;font-size:.58rem;">🔮 フォーチュンスピン</button>
        <button class="btn sm pachi-sel" id="pachiSel_umi" onclick="setPachiMachine('umi')" style="flex:1;font-size:.58rem;">🌊 ラッキーオーシャン</button>
        <button class="btn sm pachi-sel" id="pachiSel_gen" onclick="setPachiMachine('gen')" style="flex:1;font-size:.58rem;">⚡ ゴールドラッシュ</button>
      </div>

      <!-- Machine 1: Standard -->
      <div id="pachiPanel_std" style="max-width:460px;margin:0 auto;background:linear-gradient(135deg,#1a0a1e,#0f0825);border:1px solid rgba(192,132,252,.3);border-radius:16px;padding:20px;text-align:center;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:#c084fc;margin-bottom:4px;">🔮 フォーチュンスピン</div>
        <div class="gacha-desc">フィーバー突入で連チャンの大チャンス！</div>
        <div id="pachinkoField" style="position:relative;width:240px;height:200px;margin:10px auto;background:radial-gradient(ellipse at 50% 30%,#2a1040,#0d0518);border:2px solid rgba(192,132,252,.3);border-radius:14px;overflow:hidden;"><canvas id="pachinkoCanvas" width="240" height="200" style="width:100%;height:100%;"></canvas></div>
        <div style="display:flex;justify-content:center;gap:10px;margin:8px 0;">
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">状態</div><div id="pachinkoMode" style="font-size:.72rem;font-weight:800;">通常</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">時短</div><div id="pachinkoJitan" style="font-size:.72rem;font-weight:800;">--</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">連チャン</div><div id="pachinkoChain" style="font-size:.72rem;font-weight:800;color:#c084fc;">0</div></div>
        </div>
        <div style="display:flex;justify-content:center;gap:6px;margin:8px 0;"><div class="slot-reel" id="pDrum0" style="border-color:rgba(192,132,252,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="pDrum1" style="border-color:rgba(192,132,252,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="pDrum2" style="border-color:rgba(192,132,252,.4);font-size:1.4rem;">-</div></div>
        <div id="pachinkoResult" style="font-size:.78rem;min-height:22px;margin:6px 0;color:var(--amber);"></div>
        <div style="display:flex;justify-content:center;gap:6px;"><button class="gacha-btn" onclick="playPachinko()" id="pachinkoBtn" style="background:linear-gradient(135deg,#a855f7,#7c3aed);color:#fff;">打つ (100G)</button><button class="gacha-btn" onclick="playPachinko(true)" id="pachinkoBtn2" style="background:linear-gradient(135deg,#7c3aed55,#a855f755);color:#c084fc;font-size:.7rem;border:1px solid rgba(168,85,247,.4);">ミニ (10G)</button></div>
        <div style="margin-top:10px;font-size:.55rem;color:var(--muted);line-height:1.5;">1/10 → フィーバー1/3 | フィーバー50% | +400〜2500G | 期待値85%</div>
      </div>

      <!-- Machine 2: Lucky Ocean (フィーバーループ) -->
      <div id="pachiPanel_umi" style="display:none;max-width:460px;margin:0 auto;background:linear-gradient(135deg,#051520,#081028);border:1px solid rgba(56,189,248,.3);border-radius:16px;padding:20px;text-align:center;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:#38bdf8;margin-bottom:4px;">🌊 ラッキーオーシャン</div>
        <div class="gacha-desc">フィーバーループで安定連チャン！当たれば65%で再フィーバー。</div>
        <div style="display:flex;justify-content:center;gap:10px;margin:10px 0;">
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">状態</div><div id="umiMode" style="font-size:.72rem;font-weight:800;">通常</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">連チャン</div><div id="umiChain" style="font-size:.72rem;font-weight:800;color:#38bdf8;">0</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">フィーバーループ</div><div id="umiLoop" style="font-size:.72rem;font-weight:800;">--</div></div>
        </div>
        <div style="display:flex;justify-content:center;gap:6px;margin:8px 0;"><div class="slot-reel" id="uDrum0" style="border-color:rgba(56,189,248,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="uDrum1" style="border-color:rgba(56,189,248,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="uDrum2" style="border-color:rgba(56,189,248,.4);font-size:1.4rem;">-</div></div>
        <div id="umiResult" style="font-size:.78rem;min-height:22px;margin:6px 0;color:var(--amber);"></div>
        <div style="display:flex;justify-content:center;gap:6px;"><button class="gacha-btn" onclick="playUmi()" id="umiBtn" style="background:linear-gradient(135deg,#0ea5e9,#0369a1);color:#fff;">打つ (80G)</button><button class="gacha-btn" onclick="playUmi(true)" id="umiBtn2" style="background:linear-gradient(135deg,#0369a155,#0ea5e955);color:#38bdf8;font-size:.7rem;border:1px solid rgba(56,189,248,.4);">ミニ (8G)</button></div>
        <div style="margin-top:10px;font-size:.55rem;color:var(--muted);line-height:1.5;">1/320 → フィーバー1/40 | フィーバーループ65% | +1500〜5000G | 期待値85%</div>
      </div>

      <!-- Machine 3: Gold Rush -->
      <div id="pachiPanel_gen" style="display:none;max-width:460px;margin:0 auto;background:linear-gradient(135deg,#1a1005,#201008);border:1px solid rgba(251,191,36,.3);border-radius:16px;padding:20px;text-align:center;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:#fbbf24;margin-bottom:4px;">⚡ ゴールドラッシュ</div>
        <div class="gacha-desc">初当たり軽め！RUSH突入で爆速連チャン！体感スピード強烈。</div>
        <div style="display:flex;justify-content:center;gap:10px;margin:10px 0;">
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">状態</div><div id="genMode" style="font-size:.72rem;font-weight:800;">通常</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">連チャン</div><div id="genChain" style="font-size:.72rem;font-weight:800;color:#fbbf24;">0</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">RUSH</div><div id="genRush" style="font-size:.72rem;font-weight:800;">--</div></div>
        </div>
        <div style="display:flex;justify-content:center;gap:6px;margin:8px 0;"><div class="slot-reel" id="gDrum0" style="border-color:rgba(251,191,36,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="gDrum1" style="border-color:rgba(251,191,36,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="gDrum2" style="border-color:rgba(251,191,36,.4);font-size:1.4rem;">-</div></div>
        <div id="genResult" style="font-size:.78rem;min-height:22px;margin:6px 0;color:var(--amber);"></div>
        <div style="display:flex;justify-content:center;gap:6px;"><button class="gacha-btn" onclick="playGen()" id="genBtn" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;">打つ (60G)</button><button class="gacha-btn" onclick="playGen(true)" id="genBtn2" style="background:linear-gradient(135deg,#d9770655,#f59e0b55);color:#fbbf24;font-size:.7rem;border:1px solid rgba(251,191,36,.4);">ミニ (6G)</button></div>
        <div style="margin-top:10px;font-size:.55rem;color:var(--muted);line-height:1.5;">1/199 → RUSH1/8 | RUSH突入30% 継続81% | +300〜2000G | 期待値85%</div>
      </div>
    </div>

    </div>
    <div id="entPanel_mystery" style="display:none;">
      <div style="max-width:460px;margin:0 auto;background:linear-gradient(135deg,#0a1518,#081020);border:1px solid rgba(0,212,255,.25);border-radius:16px;padding:20px;text-align:center;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:var(--cyan);margin-bottom:4px;">🎁 ナゾガチャ ～よくわからないコレクション～</div>
        <div class="gacha-desc">一体なにが出るのか、誰にもわからない。<br>全123種コンプリートを目指せ！</div>
        <div id="mysteryGachaDisplay" style="width:80px;height:80px;margin:14px auto;background:var(--s2);border:2px solid var(--border);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:2.5rem;transition:all .3s;">❓</div>
        <div id="mysteryGachaResult" style="font-size:.82rem;min-height:24px;margin:8px 0;"></div>
        <div style="display:flex;justify-content:center;gap:8px;margin:10px 0;">
          <button class="gacha-btn" onclick="pullMysteryGacha(1)" style="background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff;">1回 (50G)</button>
          <button class="gacha-btn" onclick="pullMysteryGacha(10)" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff;">10連 (450G)</button>
        </div>
        <div style="margin:10px 0;font-size:.72rem;color:var(--cyan);font-weight:700;">コレクション: <span id="mysteryCollCount">0</span> / 123</div>
        <div style="background:var(--s1);border:1px solid var(--border);border-radius:6px;height:8px;overflow:hidden;margin-bottom:10px;">
          <div id="mysteryCollBar" style="height:100%;background:linear-gradient(90deg,var(--cyan),#06b6d4);width:0%;transition:width .5s;"></div>
        </div>
        <!-- Collection grid -->
        <div id="mysteryCollGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(32px,1fr));gap:3px;max-height:250px;overflow-y:auto;padding:4px;"></div>
      </div>
    </div>

    <!-- LUXURY GACHA -->
    <div id="entPanel_luxgacha" style="display:none;">
      <div class="card" style="max-width:420px;margin:0 auto;background:linear-gradient(135deg,var(--s1),#120820);border-color:rgba(168,85,247,.2);">
        <div class="card-hd"><div class="card-hd-dot" style="background:var(--violet);"></div>💎 高級インテリアガチャ</div>
        <div style="font-size:.68rem;color:var(--muted2);margin-bottom:10px;">超レアなインテリアが当たるかも。ショップでは買えない限定品。</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="gacha-btn violet" onclick="luxuryGacha()">回す (10,000G)</button>
          <span style="font-size:.6rem;color:var(--muted2);" id="luxGachaOwned">0/5 コンプ</span>
        </div>
        <div id="luxGachaResult" style="margin-top:8px;font-size:.75rem;min-height:24px;"></div>
      </div>
    </div>

    <!-- CONSUMER FINANCE -->
    <div id="entPanel_loan" style="display:none;">
      <div style="max-width:480px;margin:0 auto;background:linear-gradient(135deg,#0f1a0a,#0a1510);border:1px solid rgba(74,222,128,.2);border-radius:16px;padding:20px;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:#4ade80;margin-bottom:2px;">🏦 TFファイナンス</div>
        <div style="font-size:.55rem;color:var(--muted);margin-bottom:12px;line-height:1.6;">
          貸金業登録番号 タイムフロー財務局長（3）第4219号<br>
          日本貸金業協会会員 第TF001234号
        </div>

        <!-- Status -->
        <div id="loanStatus" style="background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px;"></div>

        <!-- Application / Management -->
        <div id="loanActions"></div>

        <!-- Fine print -->
        <div style="margin-top:14px;font-size:.52rem;color:rgba(100,116,139,.6);line-height:1.7;border-top:1px solid var(--border);padding-top:8px;">
          ■ 実質年率 4.5〜18.0%（利息制限法に基づく）<br>
          ■ 元本10万G未満: 年20% / 10万〜100万G未満: 年18% / 100万G以上: 年15%<br>
          ■ 貸金業法に基づく総量規制: 借入上限は年収の1/3まで<br>
          ■ 返済方式: 元利一括返済 / 随時返済<br>
          ■ ご利用は計画的に。<br>
          ■ 審査の結果、ご希望に添えない場合があります。
        </div>
      </div>
    </div>

  </div>
    <!-- PANEL: ACHIEVEMENTS -->
  <div class="p3-panel" id="panel_ach">
    <div style="font-size:.7rem;color:var(--muted2);margin-bottom:8px;">実績を解除すると永続ボーナスが得られます。</div>
    <div class="ach-grid" id="achGrid"></div>

    <!-- REBIRTH SECTION -->
    <div style="margin-top:20px;background:linear-gradient(135deg,#0f051a,#1a0a2e);border:2px solid rgba(192,132,252,.25);border-radius:16px;padding:20px;text-align:center;">
      <div style="font-family:'DotGothic16',monospace;font-size:1.1rem;color:#c084fc;">⏳ 時の遺産 — 転生</div>
      <div style="font-size:.68rem;color:var(--muted2);margin:6px 0 12px;">全てを極めし者だけが到達できる新たな旅路。<br>転生するとボーナス付きで2周目が始まる。</div>
      <div id="rebirthStatus" style="margin-bottom:12px;"></div>
      <div id="rebirthConditions" style="text-align:left;margin-bottom:12px;"></div>
      <button id="rebirthBtn" onclick="doRebirth()" disabled style="padding:12px 30px;border:2px solid rgba(192,132,252,.4);border-radius:12px;background:rgba(192,132,252,.1);color:#c084fc;font-size:.9rem;font-weight:800;cursor:pointer;transition:all .3s;font-family:'DotGothic16',monospace;">⏳ 転生する</button>
    </div>
  </div>

</div>
</div>

<!-- Awakening animation overlay -->
<div class="awakening-overlay" id="awakeningOverlay">
  <div class="awakening-box">
    <div class="aw-particles" id="awParticles">✨</div>
    <div class="aw-title" id="awTitle">覚醒</div>
    <div class="aw-sub" id="awSub"></div>
    <button class="aw-close" onclick="closeAwakening()">受け入れる</button>
  </div>
</div>

<!-- WORK MODAL -->
<div class="overlay" id="workOverlay">
  <div class="work-modal">
    <div class="wm-title">⚒ 時間を換金する</div>
    <div class="wm-sub">記録した努力時間（仕事・学習・運動）を換金できます。</div>
    <div style="text-align:center;font-size:.72rem;color:var(--cyan);margin-bottom:8px;">換金可能: <strong id="workAvailHours" style="font-family:'JetBrains Mono',monospace;">0h</strong></div>
    <div class="wm-wage-box">
      <div style="font-size:.62rem;color:var(--muted2);margin-bottom:2px;">現在の時給</div>
      <div class="wm-wage-big" id="workModalWage">500 G/h</div>
      <div class="wm-wage-lbl">/ 時間</div>
    </div>
    <div class="inp-lbl" style="margin-bottom:4px;">換金する時間数</div>
    <input type="number" class="wm-hours-inp" id="workHoursInput" value="1" min="0.1" max="24" step="0.5" oninput="updateWorkPreview()">
    <div class="wm-preview">獲得予定: <strong id="workPreviewGold">500 G</strong></div>
    <div style="display:flex;gap:8px;">
      <button class="btn primary" style="flex:1;background:linear-gradient(135deg,#f59e0b,#fb923c);border:none;color:#000;font-weight:800;" onclick="doWork()">💰 換金する</button>
      <button class="btn" style="flex:1;" onclick="closeModal('workOverlay')">キャンセル</button>
    </div>
    <div style="font-size:.6rem;color:var(--muted);margin-top:9px;text-align:center;">※ 仕事・学習・運動の未換金時間のみ対象</div>
  </div>
</div>

<!-- REWARD OVERLAY -->
<div class="overlay" id="rewardOverlay">
  <div class="reward-box">
    <span class="reward-emoji" id="rewardEmoji">🎉</span>
    <div class="reward-title" id="rewardTitle">達成！</div>
    <div class="reward-sub" id="rewardSub"></div>
    <button class="reward-close" onclick="closeReward()">続ける →</button>
  </div>
</div>

<!-- SPECIAL ITEM MODAL -->
<div class="modal-overlay" id="specialModal">
  <div class="modal-box">
    <div class="modal-title">⭐ 特別XP項目を追加</div>
    <div style="font-size:0.75rem;color:var(--muted2);margin-bottom:12px;">自分が重要視する行動を登録。記録すると高いXPを得られます。</div>
    <div class="modal-row">
      <div><div class="inp-lbl">項目名</div><input type="text" id="si_name" placeholder="例: 瞑想"></div>
      <div><div class="inp-lbl">カテゴリ</div>
        <select class="sel" id="si_cat">
          <option value="仕事">💼 仕事</option><option value="学習">📚 学習</option>
          <option value="運動">🏃 運動</option><option value="趣味">🎮 趣味</option>
          <option value="その他">📋 その他</option>
        </select>
      </div>
    </div>
    <div class="modal-row">
      <div><div class="inp-lbl">目標時間 (分)</div><input type="number" id="si_mins" value="30" min="5" max="480"></div>
      <div><div class="inp-lbl">XP倍率</div>
        <select class="sel" id="si_multi">
          <option value="2">×2 (重要)</option><option value="3">×3 (最重要)</option>
          <option value="5">×5 (最優先)</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn primary" style="flex:1;" onclick="addSpecialItem()">追加する</button>
      <button class="btn modal-close" onclick="closeModal('specialModal')">キャンセル</button>
    </div>
  </div>
</div>

<!-- PLOT MODAL -->
<div class="modal-overlay" id="plotModal">
  <div class="modal-box" id="plotModalContent"></div>
</div>

<div class="toast" id="toast"><span id="toastIcon">✓</span> <span id="toastMsg"></span></div>

<script>
// ================================================================
// CONFIG
// ================================================================
const CATS = {
  '仕事':  {color:'#38bdf8',effort:true, emoji:'💼'},
  '学習':  {color:'#818cf8',effort:true, emoji:'📚'},
  '運動':  {color:'#4ade80',effort:true, emoji:'🏃'},
  '趣味':  {color:'#fbbf24',effort:false,emoji:'🎮'},
  '食事':  {color:'#fb923c',effort:false,emoji:'🍱'},
  '休憩':  {color:'#6b7280',effort:false,emoji:'☕'},
  '移動':  {color:'#a78bfa',effort:false,emoji:'🚃'},
  '睡眠':  {color:'#1e3a5f',effort:false,emoji:'🌙'},
  'その他':{color:'#475569',effort:false,emoji:'📋'},
};

const EFFORT_CATS = ['仕事','学習','運動'];
const NO_XP_CATS = ['移動','休憩','食事','趣味'];

// ===== SUBCATEGORY SYSTEM =====
function getSubCats(){return JSON.parse(localStorage.getItem('tf_subcats')||'{}');}
function saveSubCats(sc){localStorage.setItem('tf_subcats',JSON.stringify(sc));}
function catBase(c){return (c||'').split('::')[0]||'その他';}
function catSub(c){return (c||'').split('::')[1]||'';}
function catLookup(c){return CATS[catBase(c)]||{color:'#64748b',emoji:'📋',effort:false};}
function catLabel(c){var b=catBase(c),s=catSub(c),cat=CATS[b]||{emoji:'📋'};return s?cat.emoji+' '+b+'（'+s+'）':cat.emoji+' '+b;}
function buildCatOptions(selected){
  var sc=getSubCats(),html='';
  Object.keys(CATS).forEach(function(c){
    html+='<option value="'+c+'"'+(selected===c?' selected':'')+'>'+CATS[c].emoji+' '+c+'</option>';
    (sc[c]||[]).forEach(function(s){
      var v=c+'::'+s;
      html+='<option value="'+v+'"'+(selected===v?' selected':'')+'>　└ '+CATS[c].emoji+' '+c+'（'+s+'）</option>';
    });
  });
  return html;
}
function renderCatSelect(){document.getElementById('category').innerHTML=buildCatOptions('');}
function showAddSubCat(){
  var baseCat=catBase(document.getElementById("category").value);
  var existing=document.getElementById("subCatInputArea");
  if(existing){existing.remove();return;}
  var div=document.createElement("div");
  div.id="subCatInputArea";
  div.style.cssText="margin-top:6px;display:flex;gap:6px;align-items:center;";
  div.innerHTML='<input type="text" id="newSubName" placeholder="例: 英語、TOEIC..." style="flex:1;background:var(--s2);border:1px solid var(--cyan);border-radius:8px;color:var(--text);padding:8px 10px;font-size:.78rem;">'+
    '<button onclick="confirmAddSub()" style="padding:8px 14px;border:1px solid rgba(56,189,248,.4);border-radius:8px;background:rgba(56,189,248,.12);color:var(--cyan);font-size:.72rem;font-weight:700;cursor:pointer;">OK</button>'+
    '<button onclick="cancelSubCat()" style="padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--muted);font-size:.72rem;cursor:pointer;">✕</button>';
  document.getElementById("category").parentElement.parentElement.appendChild(div);
  setTimeout(function(){document.getElementById("newSubName").focus();},100);
}
function cancelSubCat(){var a=document.getElementById("subCatInputArea");if(a)a.remove();}
function confirmAddSub(){
  var baseCat=catBase(document.getElementById("category").value);
  var inp=document.getElementById("newSubName");
  var name=inp?inp.value.trim():"";
  if(!name){toast("名前を入力してください","err");return;}
  var sc=getSubCats();
  if(!sc[baseCat])sc[baseCat]=[];
  if(sc[baseCat].includes(name)){toast("すでに存在します","err");return;}
  sc[baseCat].push(name);
  saveSubCats(sc);
  var area=document.getElementById("subCatInputArea");
  if(area)area.remove();
  renderCatSelect();
  document.getElementById("category").value=baseCat+"::"+name;
  toast("✅ "+baseCat+"（"+name+"）を追加");
}

const LEVELS = [
  {min:0,    name:'見習い',       title:'見習い',      avatar:'🧑', color:'#64748b'},
  {min:100,  name:'実践者',       title:'実践者',      avatar:'🧑‍💻', color:'#38bdf8'},
  {min:300,  name:'挑戦者',       title:'挑戦者',      avatar:'⚡',  color:'#818cf8'},
  {min:700,  name:'熟練者',       title:'熟練者',      avatar:'🔥',  color:'#4ade80'},
  {min:1500, name:'マスター',     title:'マスター',    avatar:'💎',  color:'#fbbf24'},
  {min:3000, name:'エキスパート', title:'エキスパート',avatar:'👑',  color:'#c084fc'},
  {min:6000, name:'伝説',         title:'伝説',        avatar:'🌟',  color:'#fb7185'},
];

// ================================================================
// SKILL TREE DEFINITION
// 6 domains × skills, each with: hours needed to unlock each level
// Levels driven by ACTUAL recorded time, not XP spending
// XP spending = accelerate growth (1 XP = 2 extra minutes of "practice")
// ================================================================
const DOMAINS = [
  {id:'work',name:'仕事',icon:'💼',color:'#38bdf8',cat:'仕事',desc:'専門性・生産性・集中力',skills:[
    {id:'focus',name:'集中力',icon:'🎯',desc:'深い集中状態に入る能力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,5,30,100,250],effects:['解放済み','集中5h達成','集中30h突破','深集中を習得','フロー状態を体得'],awaken:4},
    {id:'output',name:'生産性',icon:'📤',desc:'成果物を生み出す力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,15,60,180,400],effects:['解放済み','仕事15h記録','仕事60h突破','仕事180h突破','生産機械の境地'],awaken:4},
    {id:'strategy',name:'戦略思考',icon:'♟️',desc:'長期視点で考える力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,30,120,300,650],effects:['解放済み','仕事30h記録','仕事120h突破','仕事300h突破','戦略家の覚醒'],awaken:4},
    {id:'decision',name:'意思決定',icon:'⚡',desc:'素早く正確に判断する力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,20,80,220,500],effects:['解放済み','仕事20h記録','判断力向上','直感的決断力','瞬断の覚醒'],awaken:4},
    {id:'leadership',name:'統率力',icon:'🦅',desc:'人やプロジェクトを導く力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,40,150,400,850],effects:['解放済み','仕事40h記録','リーダーの素養','指揮能力','王者の統率覚醒'],awaken:4},
  ]},
  {id:'learn',name:'学習',icon:'📚',color:'#818cf8',cat:'学習',desc:'知識吸収・理解・応用',skills:[
    {id:'absorb',name:'吸収力',icon:'🧠',desc:'新しい知識を素早く取り込む力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,3,20,70,180],effects:['解放済み','学習3h記録','学習20h突破','学習70h突破','超学習者の覚醒'],awaken:4},
    {id:'connect',name:'連結力',icon:'🔗',desc:'知識同士を結びつける力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,10,50,150,350],effects:['解放済み','学習10h記録','学習50h突破','学習150h突破','知識統合の覚醒'],awaken:4},
    {id:'depth',name:'専門深度',icon:'🌊',desc:'一つのことを深く掘る力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,20,80,250,550],effects:['解放済み','学習20h記録','学習80h突破','学習250h突破','専門家の境地'],awaken:4},
    {id:'memory',name:'記憶定着',icon:'💾',desc:'学んだことを忘れない力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,8,40,130,300],effects:['解放済み','学習8h記録','記憶術の基礎','長期記憶力','完全記憶の覚醒'],awaken:4},
    {id:'critical',name:'批判的思考',icon:'🔍',desc:'情報を正しく評価する力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,15,65,200,450],effects:['解放済み','学習15h記録','分析力向上','論理の達人','真理の覚醒'],awaken:4},
  ]},
  {id:'body',name:'身体',icon:'🏃',color:'#4ade80',cat:'運動',desc:'体力・持久力・回復力',skills:[
    {id:'stamina',name:'持久力',icon:'💪',desc:'長く動き続ける力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,2,15,50,130],effects:['解放済み','運動2h記録','運動15h突破','運動50h突破','アスリートの覚醒'],awaken:4},
    {id:'recovery',name:'回復力',icon:'⚕️',desc:'疲れから早く立ち直る力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,5,30,90,220],effects:['解放済み','運動5h記録','運動30h突破','運動90h突破','不死鳥の回復'],awaken:4},
    {id:'vitality',name:'生命力',icon:'🌿',desc:'根本的なエネルギー量',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,10,50,150,350],effects:['解放済み','運動10h記録','運動50h突破','運動150h突破','生命力覚醒'],awaken:4},
    {id:'agility',name:'機敏性',icon:'⚡',desc:'素早く正確に動く力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,4,25,80,200],effects:['解放済み','運動4h記録','反射神経向上','超反応','閃光の覚醒'],awaken:4},
    {id:'mental_t',name:'精神耐性',icon:'🛡️',desc:'肉体的苦痛を乗り越える力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,8,40,120,280],effects:['解放済み','運動8h記録','忍耐力向上','鋼の精神','不屈の覚醒'],awaken:4},
  ]},
  {id:'sleep',name:'睡眠',icon:'🌙',color:'#c084fc',cat:'睡眠',desc:'睡眠の質・概日リズム',skills:[
    {id:'rhythm',name:'概日リズム',icon:'🕐',desc:'体内時計を整える力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,7,30,90,250],effects:['解放済み','スコア60+7日','スコア70+30日','90日連続記録','概日マスター覚醒'],awaken:4,specialCalc:'sleep'},
    {id:'depth_s',name:'深睡眠',icon:'💤',desc:'深く眠り脳を回復させる力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,3,15,50,150],effects:['解放済み','スコア70+3日','スコア80+15日','スコア90+50日','完全睡眠の覚醒'],awaken:4,specialCalc:'sleep_deep'},
    {id:'restoration',name:'修復力',icon:'✨',desc:'睡眠で翌日を最大化する力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,10,50,150,330],effects:['解放済み','睡眠記録10日','睡眠記録50日','睡眠記録150日','睡眠マスター覚醒'],awaken:4,specialCalc:'sleep_days'},
    {id:'dream',name:'夢見力',icon:'🌌',desc:'睡眠中の脳の創造性',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,14,60,180,365],effects:['解放済み','14日記録','60日記録','180日記録','夢の覚醒'],awaken:4,specialCalc:'sleep_days'},
    {id:'nap_master',name:'仮眠術',icon:'😴',desc:'短時間で最大回復する力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,7,30,100,270],effects:['解放済み','7日記録','30日記録','100日記録','瞬眠の覚醒'],awaken:4,specialCalc:'sleep_days'},
  ]},
  {id:'creative',name:'創造',icon:'🎨',color:'#fb923c',cat:'趣味',desc:'創造性・表現・多様性',skills:[
    {id:'curiosity',name:'好奇心',icon:'🔭',desc:'新しいものに飛び込む力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,5,30,100,250],effects:['解放済み','趣味5h記録','趣味30h突破','趣味100h突破','好奇心の覚醒'],awaken:4},
    {id:'flow',name:'フロー',icon:'🌊',desc:'没入状態を意図的に作る力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,10,50,150,350],effects:['解放済み','趣味10h記録','趣味50h突破','趣味150h突破','創造フロー覚醒'],awaken:4},
    {id:'expression',name:'表現力',icon:'✍️',desc:'内側にあるものを外に出す力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,20,80,250,550],effects:['解放済み','趣味20h記録','趣味80h突破','趣味250h突破','表現者の覚醒'],awaken:4},
    {id:'aesthetic',name:'審美眼',icon:'👁️',desc:'美しさを見極める力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,15,60,180,400],effects:['解放済み','趣味15h記録','美的感覚向上','美の達人','審美の覚醒'],awaken:4},
    {id:'improvise',name:'即興力',icon:'🎭',desc:'その場で生み出す瞬発力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,8,40,130,300],effects:['解放済み','趣味8h記録','ひらめき向上','天才的即興','閃きの覚醒'],awaken:4},
  ]},
  {id:'balance',name:'統合',icon:'⚖️',color:'#fbbf24',cat:null,desc:'全分野の調和・自己設計',skills:[
    {id:'consistency',name:'一貫性',icon:'🔗',desc:'毎日続ける力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,7,30,90,300],effects:['解放済み','7日連続','30日連続','90日連続','伝説の一貫性覚醒'],awaken:4,specialCalc:'streak'},
    {id:'self_design',name:'自己設計',icon:'🧬',desc:'自分をシステムとして最適化',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,14,60,200,365],effects:['解放済み','記録14日','記録60日','記録200日','自己設計の覚醒'],awaken:4,specialCalc:'days'},
    {id:'meta',name:'メタ認知',icon:'🪞',desc:'自分を客観的に観察する力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,3,10,40,120],effects:['解放済み','全分野に記録','全Lv2以上','全Lv3以上','メタマスター覚醒'],awaken:4,specialCalc:'alldomain'},
    {id:'adaptability',name:'適応力',icon:'🌀',desc:'変化に素早く対応する力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,10,45,150,330],effects:['解放済み','10日多角的記録','45日記録','柔軟な対応力','カメレオン覚醒'],awaken:4,specialCalc:'days'},
    {id:'willpower',name:'意志力',icon:'🔥',desc:'自分を律する根源的な力',levels:['初歩','基礎','応用','熟達','覚醒'],thresholds:[0,7,30,100,350],effects:['解放済み','7日継続','30日継続','100日継続','鉄の意志覚醒'],awaken:4,specialCalc:'streak'},
  ]},
];

var DEFAULT_QUICK_TEMPLATES = [
  {label:'朝仕事 9-12',start:'09:00',end:'12:00',cat:'仕事'},
  {label:'昼食 12-13',start:'12:00',end:'13:00',cat:'食事'},
  {label:'午後 13-17',start:'13:00',end:'17:00',cat:'仕事'},
  {label:'夜学習 20-22',start:'20:00',end:'22:00',cat:'学習'},
  {label:'朝運動 7-8',start:'07:00',end:'08:00',cat:'運動'},
];
function getQuickTemplates(){return ls_get('quick_tpl')||DEFAULT_QUICK_TEMPLATES;}
function setQuickTemplates(v){ls_set('quick_tpl',v);}
var QUICK_TEMPLATES = getQuickTemplates();

var BASE_XP_EFFORT = 20;
var BASE_XP_OTHER  = 5;
var xpRateMode = ls_get('xp_rate_mode') || 'normal';
function getXPMultiplier(){ return xpRateMode==='easy'?0.5:xpRateMode==='hard'?2.0:1.0; }
var XP_PER_EFFORT_HOUR = Math.round(BASE_XP_EFFORT * getXPMultiplier());
var XP_PER_OTHER_HOUR  = Math.round(BASE_XP_OTHER  * getXPMultiplier());
function setXPRate(mode){ xpRateMode=mode; ls_set('xp_rate_mode',mode); XP_PER_EFFORT_HOUR=Math.round(BASE_XP_EFFORT*getXPMultiplier()); XP_PER_OTHER_HOUR=Math.round(BASE_XP_OTHER*getXPMultiplier()); document.querySelectorAll('.xprate-btn').forEach(function(b){b.classList.toggle('active',b.dataset.mode===mode);}); toast('⚡ XPレート: '+(mode==='easy'?'ゆるめ(×0.5)':mode==='hard'?'ハード(×2.0)':'ふつう(×1.0)')); }
const XP_SLEEP_BONUS     = 15;

// ================================================================
// STATE
// ================================================================
let currentDate = todayStr();

// Populate time selects with configurable intervals
function stepTime(id, deltaMin){
  var el=document.getElementById(id);
  var val=el.value;
  if(!val)val='09:00';
  var m=t2m(val)+deltaMin;
  if(m<0)m=0;
  if(m>=1440)m=1439;
  var snapped=Math.round(m/currentTimeStep)*currentTimeStep;
  if(snapped>=1440)snapped=1440-currentTimeStep;
  if(snapped<0)snapped=0;
  var newVal=String(Math.floor(snapped/60)).padStart(2,'0')+':'+String(snapped%60).padStart(2,'0');
  el.value=newVal;
}

var currentTimeStep=10;
function buildTimeOptions(step){
  var opts='';
  for(var h=0;h<24;h++){
    for(var m=0;m<60;m+=step){
      var v=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');
      var isHour=(m===0);
      var label=isHour?'━ '+v+' ━':v;
      opts+='<option value="'+v+'"'+(isHour?' class="hr-mark" style="color:#38bdf8;font-weight:800;"':'')+'>'+label+'</option>';
    }
  }
  opts+='<option value="23:59">23:59</option>';
  return opts;
}
function setTimeStep(step){
  var prevS=document.getElementById('startTime').value;
  var prevE=document.getElementById('endTime').value;
  currentTimeStep=step;
  var opts=buildTimeOptions(step);
  ['startTime','endTime'].forEach(function(id){
    var el=document.getElementById(id);if(el)el.innerHTML=opts;
  });
  // Try to restore previous values, snap to nearest valid
  function snapTo(val,s){
    var m=t2m(val);
    var snapped=Math.round(m/s)*s;
    if(snapped>=1440)snapped=1440-s;
    return String(Math.floor(snapped/60)).padStart(2,'0')+':'+String(snapped%60).padStart(2,'0');
  }
  document.getElementById('startTime').value=snapTo(prevS,step);
  document.getElementById('endTime').value=snapTo(prevE,step);
  // Update button states
  [1,10,30,60].forEach(function(s){
    var btn=document.getElementById('tstep'+s);
    if(btn){btn.className='tstep-btn'+(s===step?' active':'');}
  });
}
(function(){
  var opts=buildTimeOptions(10);
  ['startTime','endTime'].forEach(function(id){
    var el=document.getElementById(id);if(el)el.innerHTML=opts;
  });
  var s=document.getElementById('startTime');if(s)s.value='09:00';
  var e=document.getElementById('endTime');if(e)e.value='10:00';
  renderCatSelect();
})();
let trendMode   = 'day';
let selectedDomainId = null;
let selectedSkillId  = null;
let stTab = 'domains';
let pieChart=null, lineChart=null, effortChart=null;

// ================================================================
// STORAGE
// ================================================================
function ls_get(k){try{const r=localStorage.getItem('tf3_'+k);return r?JSON.parse(r):null;}catch{return null;}}
function ls_set(k,v){try{localStorage.setItem('tf3_'+k,JSON.stringify(v));}catch{}}

function getDayData(d){return ls_get('d_'+d)||{blocks:[],sleepTime:null,wakeTime:null,sleepScore:null};}
function setDayData(d,v){ls_set('d_'+d,v);}
function getSpecials(){return ls_get('specials')||[];}
function setSpecials(v){ls_set('specials',v);}
function getTotalXP(){return ls_get('total_xp')||0;}
function setTotalXP(v){ls_set('total_xp',v);}
function getSpentXP(){return ls_get('spent_xp')||0;}
function setSpentXP(v){ls_set('spent_xp',v);}
function getAvailXP(){return Math.max(0,getTotalXP()-getSpentXP());}
function getSkillBoosts(){return ls_get('skill_boosts')||{};}
function setSkillBoosts(v){ls_set('skill_boosts',v);}
function getEventLog(){return ls_get('event_log')||[];}
function setEventLog(v){ls_set('event_log',v.slice(0,50));}
function getAwakenedSkills(){return ls_get('awakened')||[];}
function setAwakenedSkills(v){ls_set('awakened',v);}
function getGold(){return ls_get('gold')||0;}
function setGold(v){ls_set('gold',v);}
function getDebt(){return ls_get('debt');}
function setDebt(v){ls_set('debt',v);}
function isDebtPaid(){var d=getDebt();return d!==null&&d<=0;}
function hasDebtSystem(){return getDebt()!==null;}
function initDebt(){
  if(getDebt()===null){
    setDebt(5000);
    setGold(0);
    addEventLog('🎮 チュートリアル開始！ 初期ローン 5,000G を返済して資産運用を解放しよう！','money');
  }
}
function payDebt(amount){
  var debt=getDebt();
  if(!debt||debt<=0)return amount; // no debt, return full amount
  var payment=Math.min(amount,debt);
  var remainder=amount-payment;
  setDebt(debt-payment);
  if(debt-payment<=0){
    addEventLog('🎉 ローン完済！資産運用と街づくりが解禁されました！','levelup');
    toast('🎉 ローンを完済しました！資産運用・街が解禁！');
    showReward('🎉','ローン完済！','資産運用と街づくりが解禁されました！\\nここからが本当のスタートです。');
  } else {
    toast('💸 '+payment.toLocaleString()+'G を返済 (残り: '+(debt-payment).toLocaleString()+'G)');
  }
  return remainder;
}
function manualPayDebt(){
  var debt=getDebt();
  if(!debt||debt<=0){toast('ローンはありません','err');return;}
  var gold=getGold();
  if(gold<=0){toast('所持金がありません','err');return;}
  var payment=Math.min(gold,debt);
  setGold(gold-payment);
  setDebt(debt-payment);
  addEventLog('💸 所持金から '+payment.toLocaleString()+'G を返済 (残り: '+Math.max(0,debt-payment).toLocaleString()+'G)','money');
  if(debt-payment<=0){
    addEventLog('🎉 ローン完済！資産運用と街づくりが解禁されました！','levelup');
    toast('🎉 ローンを完済しました！資産運用・街が解禁！');
    showReward('🎉','ローン完済！','資産運用と街づくりが解禁されました！');
  } else {
    toast('💸 '+payment.toLocaleString()+'G を返済 (残り: '+(debt-payment).toLocaleString()+'G)');
  }
  updateNav();renderEconomy();
}
function getTotalEarned(){return ls_get('total_earned')||0;}
function setTotalEarned(v){ls_set('total_earned',v);}
function getOwnedBuildings(){return ls_get('owned_bld')||[];}
function setOwnedBuildings(v){ls_set('owned_bld',v);}
function getDayWorked(d){return ls_get('worked_'+d)||false;}
function setDayWorked(d){ls_set('worked_'+d,true);}

// ================================================================
// ECONOMY CONFIG
// ================================================================
const BASE_WAGE = 90;
const WAGE_PER_SKILL_LV = 0.037; // scaled so Lv120 → ~8000

const BUILDINGS = [
  // === 初期・基礎インフラ (〜5,000G) === subtotal: ~350
  {id:'b0',  e:'🏠', name:'小屋',           cost:300,      pop:10,  desc:'最初の住まい'},
  {id:'b1',  e:'⛺', name:'テント広場',      cost:600,      pop:20,  desc:'憩いの場'},
  {id:'b35', e:'🚏', name:'バス停',          cost:800,      pop:15,  desc:'公共交通の始まり'},
  {id:'b2',  e:'🌲', name:'公園',            cost:1200,     pop:25,  desc:'緑が街を潤す'},
  {id:'b36', e:'🪵', name:'木材置き場',      cost:1500,     pop:20,  desc:'資材の拠点'},
  {id:'b37', e:'🧑‍🌾',name:'農場',          cost:2000,     pop:40,  desc:'食の自給自足'},
  {id:'b3',  e:'🏪', name:'商店',            cost:2500,     pop:50,  desc:'経済活動が始まる'},
  {id:'b38', e:'🍞', name:'パン屋',          cost:3000,     pop:30,  desc:'焼きたての香り'},
  {id:'b39', e:'📬', name:'郵便局',          cost:3500,     pop:40,  desc:'手紙が届く街'},
  {id:'b40', e:'⛪', name:'教会',            cost:4000,     pop:45,  desc:'祈りの場所'},
  {id:'b4',  e:'🏫', name:'学校',            cost:5000,     pop:80,  desc:'知識が街を豊かに'},

  // === 公共施設・中規模 (5,000〜20,000G) === subtotal: ~1,100
  {id:'b41', e:'🚒', name:'消防署',          cost:6000,     pop:70,  desc:'市民の安全を守る炎の番人'},
  {id:'b42', e:'👮', name:'警察署',          cost:6500,     pop:70,  desc:'治安が街の基盤'},
  {id:'b5',  e:'⛲', name:'噴水広場',        cost:7000,     pop:60,  desc:'街の中心に輝く'},
  {id:'b43', e:'📖', name:'保育園',          cost:7500,     pop:55,  desc:'子どもたちの笑い声'},
  {id:'b44', e:'🏋️',name:'スポーツジム',    cost:8000,     pop:65,  desc:'健康な身体は資本'},
  {id:'b45', e:'🐕', name:'動物保護施設',    cost:8500,     pop:50,  desc:'命を守る場所'},
  {id:'b46', e:'♻️', name:'リサイクルセンター',cost:9000,   pop:45,  desc:'持続可能な未来へ'},
  {id:'b47', e:'🏊', name:'市民プール',      cost:10000,    pop:80,  desc:'水しぶきの歓声'},
  {id:'b6',  e:'🏥', name:'病院',            cost:12000,    pop:120, desc:'市民の健康を守る'},
  {id:'b48', e:'🔥', name:'温泉施設',        cost:13000,    pop:70,  desc:'疲れを癒す源泉'},
  {id:'b49', e:'🏤', name:'市役所',          cost:15000,    pop:100, desc:'行政の中枢'},
  {id:'b7',  e:'🎭', name:'劇場',            cost:18000,    pop:100, desc:'文化が根付く'},
  {id:'b50', e:'📡', name:'通信塔',          cost:20000,    pop:80,  desc:'電波が街を繋ぐ'},

  // === 商業・文化施設 (20,000〜80,000G) === subtotal: ~2,700
  {id:'b51', e:'🎬', name:'映画館',          cost:22000,    pop:120, desc:'スクリーンに夢が映る'},
  {id:'b52', e:'🍺', name:'ブルワリー',      cost:25000,    pop:100, desc:'地ビールの誇り'},
  {id:'b53', e:'🎪', name:'遊園地',          cost:28000,    pop:200, desc:'笑顔があふれる'},
  {id:'b8',  e:'🏦', name:'銀行',            cost:30000,    pop:180, desc:'資本が街を動かす'},
  {id:'b54', e:'🐘', name:'動物園',          cost:35000,    pop:200, desc:'動物たちとの出会い'},
  {id:'b55', e:'🎨', name:'美術館',          cost:38000,    pop:150, desc:'アートが街に彩りを'},
  {id:'b56', e:'🏬', name:'デパート',        cost:40000,    pop:250, desc:'何でも揃う百貨店'},
  {id:'b57', e:'🎵', name:'コンサートホール',cost:45000,    pop:180, desc:'音楽が響き渡る'},
  {id:'b9',  e:'🏛️',name:'図書館',          cost:50000,    pop:200, desc:'知の殿堂'},
  {id:'b58', e:'🔬', name:'研究所',          cost:55000,    pop:180, desc:'科学が未来を拓く'},
  {id:'b59', e:'🛍️',name:'大型商業施設',    cost:60000,    pop:300, desc:'ショッピングモールで賑わう'},
  {id:'b60', e:'🏨', name:'高級ホテル',      cost:65000,    pop:200, desc:'おもてなしの頂点'},
  {id:'b61', e:'🎓', name:'大学',            cost:70000,    pop:350, desc:'最高学府が街の誇り'},
  {id:'b10', e:'🌉', name:'大橋',            cost:80000,    pop:250, desc:'街が繋がる'},

  // === 大型インフラ (80,000〜200,000G) === subtotal: ~5,500
  {id:'b62', e:'🏗️',name:'超高層ビル',      cost:85000,    pop:400, desc:'スカイラインを変える'},
  {id:'b63', e:'⚡', name:'火力発電所',      cost:90000,    pop:300, desc:'電力が街を照らす'},
  {id:'b64', e:'🌊', name:'水力発電所',      cost:100000,   pop:350, desc:'水の力を電力に'},
  {id:'b65', e:'🚇', name:'地下鉄',          cost:110000,   pop:500, desc:'地下を走る大動脈'},
  {id:'b11', e:'🏟️',name:'競技場',          cost:120000,   pop:500, desc:'スポーツが街を熱く'},
  {id:'b66', e:'☢️', name:'原子力発電所',    cost:130000,   pop:350, desc:'莫大なエネルギー'},
  {id:'b67', e:'🎰', name:'カジノ',          cost:140000,   pop:450, desc:'一攫千金の夢'},
  {id:'b68', e:'⚓', name:'港湾施設',        cost:150000,   pop:500, desc:'海の玄関口'},
  {id:'b69', e:'🏎️',name:'F1サーキット',    cost:160000,   pop:400, desc:'エンジンが唸る'},
  {id:'b70', e:'🎢', name:'テーマパーク',    cost:180000,   pop:600, desc:'夢と魔法の王国'},
  {id:'b12', e:'⛩️',name:'神社',            cost:200000,   pop:500, desc:'精神の拠り所'},

  // === 超大型・ランドマーク (200,000〜600,000G) === subtotal: ~10,500
  {id:'b71', e:'✈️', name:'国際空港',        cost:220000,   pop:700, desc:'世界と繋がる翼'},
  {id:'b72', e:'🌿', name:'国立公園',        cost:250000,   pop:500, desc:'自然と共に生きる'},
  {id:'b73', e:'🏙️',name:'金融街',          cost:280000,   pop:800, desc:'ウォール街が生まれる'},
  {id:'b74', e:'☀️', name:'太陽光発電所',    cost:300000,   pop:450, desc:'クリーンエネルギーの未来'},
  {id:'b13', e:'🗼', name:'タワー',          cost:350000,   pop:800, desc:'空に届くシンボル'},
  {id:'b75', e:'🧬', name:'バイオ研究センター',cost:380000, pop:600, desc:'生命科学の最前線'},
  {id:'b76', e:'🛡️',name:'軍事基地',        cost:400000,   pop:700, desc:'国防の要'},
  {id:'b77', e:'🌐', name:'データセンター',  cost:420000,   pop:600, desc:'デジタル社会の心臓'},
  {id:'b78', e:'🚄', name:'新幹線駅',        cost:450000,   pop:900, desc:'超高速で都市を結ぶ'},
  {id:'b79', e:'🏖️',name:'リゾート開発',    cost:500000,   pop:700, desc:'楽園がここに'},
  {id:'b80', e:'⚽', name:'ワールドカップスタジアム',cost:550000,pop:1000,desc:'世界が注目する舞台'},
  {id:'b14', e:'🏰', name:'城',              cost:600000,   pop:1200, desc:'伝説の城。あなたの王国'},

  // === 国家・宇宙規模 (600,000G〜) === subtotal: ~12,500
  {id:'b81', e:'🎡', name:'万博会場',        cost:700000,   pop:1200, desc:'世界の文化が集う'},
  {id:'b82', e:'🏔️',name:'スキーリゾート',  cost:800000,   pop:1000, desc:'白銀の世界'},
  {id:'b83', e:'💎', name:'宝石取引所',      cost:900000,   pop:800,  desc:'輝く富の集積地'},
  {id:'b84', e:'🔭', name:'天文台',          cost:1000000,  pop:1000, desc:'宇宙の神秘を覗く'},
  {id:'b85', e:'🚀', name:'NASA宇宙センター',cost:1500000,  pop:1500, desc:'人類は宇宙へ'},
  {id:'b86', e:'🌕', name:'月面基地',        cost:2500000,  pop:2000, desc:'月に街を築く'},
  {id:'b87', e:'🪐', name:'宇宙ステーション',cost:5000000,  pop:2500, desc:'軌道上の新都市'},
  {id:'b88', e:'🌌', name:'ダイソン球',      cost:10000000, pop:3500, desc:'恒星のエネルギーを支配する究極の構造物'},
];

const WAGE_TIERS = [
  {label:'無職',           totalLv:0,   wage:90},
  {label:'日雇い労働者',    totalLv:2,   wage:150},
  {label:'見習い',          totalLv:4,   wage:220},
  {label:'アルバイト',      totalLv:6,   wage:300},
  {label:'契約社員',        totalLv:9,   wage:400},
  {label:'一般事務',        totalLv:12,  wage:500},
  {label:'作業員',          totalLv:15,  wage:620},
  {label:'営業職',          totalLv:18,  wage:750},
  {label:'技能工',          totalLv:22,  wage:900},
  {label:'主任',            totalLv:26,  wage:1050},
  {label:'技術者',          totalLv:30,  wage:1200},
  {label:'係長',            totalLv:34,  wage:1400},
  {label:'専門職',          totalLv:38,  wage:1600},
  {label:'課長代理',        totalLv:42,  wage:1800},
  {label:'課長',            totalLv:47,  wage:2000},
  {label:'上級技術者',      totalLv:52,  wage:2250},
  {label:'シニアエンジニア',totalLv:57,  wage:2500},
  {label:'次長',            totalLv:62,  wage:2800},
  {label:'部長',            totalLv:67,  wage:3100},
  {label:'エキスパート',    totalLv:72,  wage:3500},
  {label:'統括部長',        totalLv:77,  wage:3900},
  {label:'執行役員',        totalLv:82,  wage:4300},
  {label:'上級執行役員',    totalLv:87,  wage:4800},
  {label:'常務取締役',      totalLv:92,  wage:5300},
  {label:'専務取締役',      totalLv:97,  wage:5800},
  {label:'副社長',          totalLv:102, wage:6300},
  {label:'社長',            totalLv:107, wage:6800},
  {label:'CEO',             totalLv:112, wage:7400},
  {label:'財閥総帥',        totalLv:117, wage:7800},
  {label:'伝説の経営者',    totalLv:120, wage:8000},
];

function getAllDates(){
  const keys=[];
  try{for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&k.startsWith('tf3_d_'))keys.push(k.replace('tf3_d_',''));}}catch{}
  return keys.sort();
}

// ================================================================
// DATE UTILS
// ================================================================
function todayStr(){const n=new Date();return n.getFullYear()+'-'+String(n.getMonth()+1).padStart(2,'0')+'-'+String(n.getDate()).padStart(2,'0');}
function parseDate(s){const[y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d);}
function addDays(s,n){const d=parseDate(s);d.setDate(d.getDate()+n);return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function formatDate(s){const d=parseDate(s);const D=['日','月','火','水','木','金','土'];return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} (${D[d.getDay()]})`;}
function formatShort(s){const d=parseDate(s);return `${d.getMonth()+1}/${d.getDate()}`;}

function changeDate(delta){currentDate=addDays(currentDate,delta);renderP1();}
function goToday(){currentDate=todayStr();renderP1();}

// ================================================================
// TIME UTILS
// ================================================================
function t2m(t){const[h,m]=t.split(':').map(Number);return h*60+m;}
function m2hm(m){const h=Math.floor(Math.abs(m)/60),mn=Math.abs(m)%60;return `${h}:${String(mn).padStart(2,'0')}`;}

// ================================================================
// PAGE NAV
// ================================================================
let curPage=0;
let curP3Tab='skills';
function gotoPage(n){
  // Close ALL modals and overlays when switching pages
  document.querySelectorAll('.modal.show,.overlay.show,.modal-overlay.show').forEach(function(m){m.classList.remove('show');});
  document.querySelectorAll('.page').forEach((p,i)=>p.classList.toggle('active',i===n));
  document.querySelectorAll('.ntab').forEach((t,i)=>t.classList.toggle('active',i===n));
  curPage=n;
  if(n===1)renderP2();
  if(n===2)renderP3();
  updateNav();
}

// ================================================================
// BLOCK MANAGEMENT
// ================================================================
function addBlock(forceOverwrite){
  const s=document.getElementById('startTime').value;
  const e=document.getElementById('endTime').value;
  const c=document.getElementById('category').value;
  if(!s||!e){toast('時刻を入力してください','err');return;}

  var sm=t2m(s), em=t2m(e);
  var crossesMidnight=(em<=sm);

  if(!crossesMidnight){
    // Same-day block: overlap check on current date
    var day=getDayData(currentDate);
    var overlapping=[];
    for(var i=0;i<day.blocks.length;i++){
      var b=day.blocks[i];
      var bS=t2m(b.start), bE=t2m(b.end);
      if(sm<bE && em>bS){overlapping.push(b);}
    }
    if(overlapping.length>0 && !forceOverwrite){
      var names=overlapping.map(function(b){return catLabel(b.category)+' '+b.start+'〜'+b.end;}).join('、');
      showOverwriteConfirm(names);
      return;
    }
    // Remove overlapping blocks
    if(overlapping.length>0){
      var removeIds=overlapping.map(function(b){return b.id;});
      day.blocks=day.blocks.filter(function(b){return removeIds.indexOf(b.id)===-1;});
    }
    var block={start:s,end:e,category:c,id:Date.now()};
    day.blocks.push(block);
    mergeBlocks(day);
    setDayData(currentDate,day);
    recalcSleepFromBlocks(currentDate);

    // XP
    var dur=em-sm;
    var isEffort=catLookup(c).effort;
    var isNoXP=NO_XP_CATS.includes(catBase(c));
    var specials=getSpecials().filter(function(sp){return sp.cat===c;});
    var xpGain=isNoXP?0:(isEffort?Math.round(dur/60*XP_PER_EFFORT_HOUR):Math.round(dur/60*XP_PER_OTHER_HOUR));
    var bonusMsg='';
    if(specials.length>0){var sp=specials[0];var multi=sp.multi||2;if(dur>=sp.mins){xpGain=Math.round(xpGain*multi);bonusMsg=' (⭐×'+multi+'ボーナス!)';}}
    addXP(xpGain,block);
    var overMsg=overlapping.length>0?'（上書き）':'';
    toast(catLabel(c)+' +'+xpGain+'XP'+bonusMsg+overMsg);
    onBlockAdded(c);
  } else {
    // Crosses midnight: split into today + tomorrow
    var day1=getDayData(currentDate);
    var nextDate=addDays(currentDate,1);
    var day2=getDayData(nextDate);

    var overlap1=[],overlap2=[];
    if(sm<1440){
      for(var i=0;i<day1.blocks.length;i++){
        var b=day1.blocks[i];
        if(sm<t2m(b.end)&&1440>t2m(b.start)){overlap1.push(b);}
      }
    }
    if(em>0){
      for(var i=0;i<day2.blocks.length;i++){
        var b=day2.blocks[i];
        if(0<t2m(b.end)&&em>t2m(b.start)){overlap2.push(b);}
      }
    }
    if((overlap1.length>0||overlap2.length>0) && !forceOverwrite){
      var all=overlap1.concat(overlap2);
      var names=all.map(function(b){return catLabel(b.category)+' '+b.start+'〜'+b.end;}).join('、');
      showOverwriteConfirm(names);
      return;
    }
    // Remove overlapping
    if(overlap1.length>0){var ids1=overlap1.map(function(b){return b.id;});day1.blocks=day1.blocks.filter(function(b){return ids1.indexOf(b.id)===-1;});}
    if(overlap2.length>0){var ids2=overlap2.map(function(b){return b.id;});day2.blocks=day2.blocks.filter(function(b){return ids2.indexOf(b.id)===-1;});}

    var block1={start:s,end:'23:59',category:c,id:Date.now()};
    var block2={start:'00:00',end:e,category:c,id:Date.now()+1};
    if(sm<1440)day1.blocks.push(block1);
    if(em>0)day2.blocks.push(block2);
    mergeBlocks(day1);mergeBlocks(day2);
    setDayData(currentDate,day1);
    setDayData(nextDate,day2);
    recalcSleepFromBlocks(currentDate);
    recalcSleepFromBlocks(nextDate);

    // XP for total duration
    var totalDur=(1440-sm)+em;
    var isEffort=catLookup(c).effort;
    var isNoXP=NO_XP_CATS.includes(catBase(c));
    var xpGain=isNoXP?0:(isEffort?Math.round(totalDur/60*XP_PER_EFFORT_HOUR):Math.round(totalDur/60*XP_PER_OTHER_HOUR));
    addXP(xpGain,block1);
    toast(catLabel(c)+' +'+xpGain+'XP（日をまたぎ分割）');
    onBlockAdded(c);
  }

  // Advance times
  document.getElementById('startTime').value=e;
  var nem=t2m(e)+60;
  var snapM=Math.round(Math.min(nem,1430)/currentTimeStep)*currentTimeStep;
  if(snapM>=1440)snapM=1440-currentTimeStep;
  document.getElementById('endTime').value=String(Math.floor(snapM/60)).padStart(2,'0')+':'+String(snapM%60).padStart(2,'0');

  renderP1();
}

function showOverwriteConfirm(names){
  var el=document.getElementById('overwriteConfirm');
  if(!el){
    el=document.createElement('div');
    el.id='overwriteConfirm';
    el.style.cssText='position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.75);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding:20px;';
    document.body.appendChild(el);
  }
  el.style.display='flex';
  el.innerHTML=
    '<div style="background:var(--s1);border:2px solid rgba(251,191,36,.4);border-radius:16px;padding:24px;max-width:380px;width:100%;animation:rewardIn .3s ease;">'+
      '<div style="font-size:1.2rem;text-align:center;margin-bottom:8px;">⚠️</div>'+
      '<div style="font-size:.85rem;font-weight:700;color:#fbbf24;text-align:center;margin-bottom:10px;">時間が重複しています</div>'+
      '<div style="font-size:.7rem;color:var(--muted2);text-align:center;margin-bottom:14px;line-height:1.6;">以下の記録を上書きしてもよいですか？<br><span style="color:var(--text);font-weight:700;">'+names+'</span></div>'+
      '<div style="display:flex;gap:8px;">'+
        '<button onclick="document.getElementById(\'overwriteConfirm\').style.display=\'none\'" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--s2);color:var(--muted2);font-size:.8rem;font-weight:700;cursor:pointer;">キャンセル</button>'+
        '<button onclick="document.getElementById(\'overwriteConfirm\').style.display=\'none\';addBlock(true)" style="flex:1;padding:10px;border:none;border-radius:10px;background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000;font-size:.8rem;font-weight:800;cursor:pointer;">上書きする</button>'+
      '</div>'+
    '</div>';
}

// Auto-merge consecutive blocks of the same category
function mergeBlocks(day){
  if(day.blocks.length<2)return;
  day.blocks.sort(function(a,b){return a.start.localeCompare(b.start);});
  var merged=[];
  var cur=Object.assign({},day.blocks[0]);
  for(var i=1;i<day.blocks.length;i++){
    var b=day.blocks[i];
    // Merge if same category and adjacent/overlapping
    if(b.category===cur.category && t2m(b.start)<=t2m(cur.end)+1){
      cur.end=t2m(b.end)>t2m(cur.end)?b.end:cur.end;
    } else {
      merged.push(cur);
      cur=Object.assign({},b);
    }
  }
  merged.push(cur);
  day.blocks=merged;
}

// Recalculate sleep score from sleep blocks
function recalcSleepFromBlocks(dateStr){
  var day=getDayData(dateStr);
  var sleepBlocks=day.blocks.filter(function(b){return catBase(b.category)==='睡眠';});
  if(sleepBlocks.length===0){
    day.sleepScore=null;day.sleepTime=null;day.wakeTime=null;
    setDayData(dateStr,day);return;
  }
  // Find total sleep time and boundaries
  var totalSleepMins=0;
  var earliest=9999, latest=0;
  sleepBlocks.forEach(function(b){
    var sm=t2m(b.start),em=t2m(b.end);
    totalSleepMins+=(em-sm);
    if(sm<earliest)earliest=sm;
    if(em>latest)latest=em;
  });
  // Determine sleep/wake times for scoring
  // If there's a block ending in morning (0:00-12:00), that's wakeTime
  // If there's a block starting in evening (18:00-24:00), that's sleepTime
  var sleepStart=null, wakeEnd=null;
  sleepBlocks.forEach(function(b){
    var sm=t2m(b.start),em=t2m(b.end);
    if(sm>=1080){sleepStart=b.start;} // after 18:00
    if(em<=720 && em>0){wakeEnd=b.end;} // before 12:00
  });
  // Fallback
  if(!sleepStart)sleepStart=sleepBlocks[0].start;
  if(!wakeEnd)wakeEnd=sleepBlocks[sleepBlocks.length-1].end;

  var score=calcSleepScore(sleepStart,wakeEnd);
  var hadScore=day.sleepScore;
  day.sleepTime=sleepStart;day.wakeTime=wakeEnd;day.sleepScore=score;
  setDayData(dateStr,day);
  if(dateStr===currentDate){
    updateSleepUI(score);
    if(score>=80&&hadScore===null){addXP(XP_SLEEP_BONUS);}
  }
}

function deleteBlock(id){
  const day=getDayData(currentDate);
  day.blocks=day.blocks.filter(b=>b.id!==id);
  setDayData(currentDate,day);
  recalcSleepFromBlocks(currentDate);
  renderP1();
}

function quickAdd(tpl){
  document.getElementById('startTime').value=tpl.start;
  document.getElementById('endTime').value=tpl.end;
  document.getElementById('category').value=tpl.cat;
}

// ================================================================
// SPECIAL ITEMS
// ================================================================
function openSpecialModal(){document.getElementById('specialModal').classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}

function addSpecialItem(){
  const name=document.getElementById('si_name').value.trim();
  const cat=document.getElementById('si_cat').value;
  const mins=parseInt(document.getElementById('si_mins').value)||30;
  const multi=parseInt(document.getElementById('si_multi').value)||2;
  if(!name){toast('項目名を入力してください','err');return;}
  const specials=getSpecials();
  specials.push({id:Date.now(),name,cat,mins,multi});
  setSpecials(specials);
  closeModal('specialModal');
  toast(`⭐ "${name}" を追加しました`);
  renderSpecialList();
}

function deleteSpecial(id){
  const s=getSpecials().filter(x=>x.id!==id);
  setSpecials(s);
  renderSpecialList();
}

function renderSpecialList(){
  const el=document.getElementById('specialList');
  const specials=getSpecials();
  if(!specials.length){
    el.innerHTML='<div style="font-size:0.75rem;color:var(--muted);text-align:center;padding:10px;">特別項目がありません<br><span style="font-size:0.65rem;">自分が重要視する行動を登録してXPボーナスを得よう</span></div>';
    return;
  }
  el.innerHTML=specials.map(sp=>{
    const cat=catLookup(sp.cat);
    return `<div class="special-item">
      <div class="special-dot" style="background:${cat.color}"></div>
      <div class="special-info">
        <div class="special-name">${cat.emoji} ${sp.name}</div>
        <div class="special-meta">${sp.cat} / ${sp.mins}分以上 → XP ×${sp.multi}</div>
      </div>
      <div class="special-xp">×${sp.multi}</div>
      <button class="special-del" onclick="deleteSpecial(${sp.id})">×</button>
    </div>`;
  }).join('');
}

// ================================================================
// XP
// ================================================================
function addXP(amount,blockEl){
  const prev=getTotalXP();
  const next=prev+amount;
  setTotalXP(next);
  checkLevelUp(prev,next);
  updateNav();
  // float
  if(blockEl){
    const x=window.innerWidth/2+Math.random()*100-50;
    const y=window.innerHeight/2;
    spawnFloatXP(x,y,'+'+amount+' XP');
  }
}

function spawnFloatXP(x,y,text){
  const el=document.createElement('div');
  el.className='xp-float';
  el.textContent=text;
  el.style.left=x+'px';
  el.style.top=y+'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1200);
}

function getLevel(xp){let lv=LEVELS[0];for(const l of LEVELS)if(xp>=l.min)lv=l;return lv;}

function checkLevelUp(prev,next){
  const pLv=getLevel(prev),nLv=getLevel(next);
  if(nLv.name!==pLv.name){
    showReward('🎊','レベルアップ！',`${nLv.name} になりました！\nスキルツリーで自分の成長を確認しよう ✨`);
    addEventLog(`🎊 レベルアップ！「${nLv.name}」になった！`,'levelup');
  }
}

function calcTotalSkillLevels(){
  let t=0;
  DOMAINS.forEach(d=>d.skills.forEach(s=>{t+=getSkillLevel(s);}));
  return t;
}

function calcWage(){
  const lvs=calcTotalSkillLevels();
  // Use tier-based wage with interpolation
  let curTier=WAGE_TIERS[0];
  let nextTier=null;
  for(let i=0;i<WAGE_TIERS.length;i++){
    if(lvs>=WAGE_TIERS[i].totalLv){curTier=WAGE_TIERS[i];nextTier=WAGE_TIERS[i+1]||null;}
  }
  if(!nextTier)return curTier.wage;
  // Interpolate between tiers
  var progress=(lvs-curTier.totalLv)/(nextTier.totalLv-curTier.totalLv);
  return Math.round(curTier.wage+(nextTier.wage-curTier.wage)*progress);
}

function updateNav(){
  const xp=getTotalXP();
  const streak=calcStreak();
  const lv=getLevel(xp);
  const lvIdx=LEVELS.indexOf(lv);
  document.getElementById('navXP').textContent=xp;
  document.getElementById('navStreak').textContent=streak;
  document.getElementById('navGold').textContent=getGold().toLocaleString();
  // Rebirth display
  var rCount=getRebirthCount();
  var rPill=document.getElementById('rebirthPill');
  if(rPill){
    if(rCount>0){
      var rt=getHighestRebirthTitle();
      rPill.style.display='';
      rPill.innerHTML=(rt?rt.icon:'')+' <span style="color:'+(rt?rt.color:'#c084fc')+';font-weight:700;">'+rCount+'周目</span>';
      rPill.style.borderColor=(rt?rt.color:'rgba(192,132,252,.4)');
    } else {rPill.style.display='none';}
  }
  const avail=getAvailXP();
  const el_xp=document.getElementById('gardenXP');
  const el_bar=document.getElementById('gardenXPBar');
  if(el_xp) el_xp.textContent=avail+' XP';
  if(el_bar) el_bar.style.width=Math.min(100,avail/Math.max(100,xp)*100)+'%';
}

// ================================================================
// ECONOMY FUNCTIONS
// ================================================================
function getConvertableHours(){
  // Sum all unconverted effort hours across ALL dates
  var dates=getAllDates();
  var totalMins=0;
  dates.forEach(function(d){
    var dd=getDayData(d);
    var effort=getEffortMins(dd.blocks);
    var converted=dd.convertedMins||0;
    totalMins+=Math.max(0,effort-converted);
  });
  return totalMins/60;
}

function markConvertedHours(hoursToConvert){
  // Distribute conversion across dates (oldest first)
  var remaining=Math.round(hoursToConvert*60);
  var dates=getAllDates();
  for(var i=0;i<dates.length&&remaining>0;i++){
    var dd=getDayData(dates[i]);
    var effort=getEffortMins(dd.blocks);
    var converted=dd.convertedMins||0;
    var available=Math.max(0,effort-converted);
    if(available>0){
      var take=Math.min(available,remaining);
      dd.convertedMins=(converted+take);
      setDayData(dates[i],dd);
      remaining-=take;
    }
  }
}

function openWorkModal(){
  const wage=calcWage();
  const avail=getConvertableHours();
  const maxH=Math.floor(avail*10)/10;
  if(maxH<=0){toast('換金可能な努力時間がありません。仕事・学習・運動を記録してください','err');return;}
  document.getElementById('workModalWage').textContent='\u00a5'+wage.toLocaleString();
  document.getElementById('workHoursInput').value=maxH;
  document.getElementById('workHoursInput').max=maxH;
  updateWorkPreview();
  const availEl=document.getElementById('workAvailHours');
  if(availEl)availEl.textContent=maxH.toFixed(1)+'h';
  document.getElementById('workOverlay').classList.add('show');
}

function updateWorkPreview(){
  const h=parseFloat(document.getElementById('workHoursInput').value)||0;
  const wage=calcWage();
  document.getElementById('workPreviewGold').textContent=(Math.round(h*wage)).toLocaleString()+' G';
}

function doWork(){
  const h=parseFloat(document.getElementById('workHoursInput').value)||0;
  if(h<=0){toast('換金する時間を入力してください','err');return;}
  const avail=getConvertableHours();
  if(h>avail+0.01){toast('換金可能な努力時間は '+avail.toFixed(1)+'h です','err');return;}
  const today=todayStr();
  const wage=calcWage();
  const earn=Math.round(h*wage);
  // Debt auto-repayment
  var debt=getDebt();
  var actualGold=earn;
  if(debt&&debt>0){
    actualGold=payDebt(earn);
    var paid=earn-actualGold;
    if(paid>0)addEventLog('💸 '+paid.toLocaleString()+'G をローン返済に充当 (残り: '+Math.max(0,debt-paid).toLocaleString()+'G)','money');
  }
  setGold(getGold()+actualGold);
  setTotalEarned(getTotalEarned()+earn);
  const dd=getDayData(today);
  dd.earnedGold=(dd.earnedGold||0)+earn;
  setDayData(today,dd);
  markConvertedHours(h);
  closeModal('workOverlay');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'+'+earn.toLocaleString()+' G');
  addEventLog(h+'h換金 '+earn.toLocaleString()+' G (時給 '+wage+' G/h)','money');
  toast(earn.toLocaleString()+' G 獲得！');
  updateNav();
  renderEconomy();
  if(curPage===2)renderP3();
  const total=getTotalEarned();
  [1000,5000,10000,50000,100000,500000].forEach(m=>{if(total-earn<m&&total>=m){showReward('💰','収入マイルストーン！','累計収入が '+total.toLocaleString()+' Gに達した！');}});
}

function buyBuilding(id){
  const b=BUILDINGS.find(x=>x.id===id);if(!b)return;
  const owned=getOwnedBuildings();
  if(owned.includes(id)){toast('すでに建設済みです','err');return;}
  if(getGold()<b.cost){toast('ゴールドが足りません（必要: '+b.cost.toLocaleString()+' G）','err');return;}
  setGold(getGold()-b.cost);
  owned.push(id);setOwnedBuildings(owned);
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'🏗️ 建設完了！');
  addEventLog('🏗️ 「'+b.name+'」を建設した！ (-'+b.cost.toLocaleString()+'G)','money');
  showReward(b.e,'建設完了！','「'+b.name+'」を建てました！\n人口が +'+b.pop+' 増えました 🏘️');
  updateNav();
  if(curPage===2)renderP3();
}

function renderEconomy(){
  const wage=calcWage();
  const gold=getGold();
  const totalLvs=calcTotalSkillLevels();
  const maxLvs=120;

  // wage card
  document.getElementById('wageDisplay').textContent=wage.toLocaleString()+' G/h';
  document.getElementById('wageBarFill').style.width=Math.min(100,totalLvs/maxLvs*100)+'%';

  // find current tier
  let curTier=WAGE_TIERS[0];
  for(const t of WAGE_TIERS) if(totalLvs>=t.totalLv) curTier=t;
  const nextTier=WAGE_TIERS[WAGE_TIERS.indexOf(curTier)+1];
  document.getElementById('wageNext').textContent=nextTier
    ? 'あと '+(nextTier.totalLv-totalLvs)+' スキルLvで '+nextTier.wage+' G/h'
    : '✨ 最高時給達成！';

  // wage ladder - show only nearby tiers (1 before, current, up to 4 after)
  var curIdx=WAGE_TIERS.indexOf(curTier);
  var startIdx=Math.max(0,curIdx-1);
  var endIdx=Math.min(WAGE_TIERS.length-1,curIdx+4);
  var visibleTiers=WAGE_TIERS.slice(startIdx,endIdx+1);
  var ladderHtml='';
  if(startIdx>0)ladderHtml+='<div style="font-size:.55rem;color:var(--muted);text-align:center;padding:2px;">▲ '+startIdx+'段階前</div>';
  ladderHtml+=visibleTiers.map(function(t){
    var isPast=totalLvs>t.totalLv&&curTier!==t;
    var isCur=curTier===t;
    var cls=isCur?'wl-row cur':isPast?'wl-row past':'wl-row';
    return '<div class="'+cls+'"><div class="wl-dot"></div><span class="wl-name">'+t.label+'</span><span class="wl-wage">'+t.wage.toLocaleString()+' G</span></div>';
  }).join('');
  if(endIdx<WAGE_TIERS.length-1)ladderHtml+='<div style="font-size:.55rem;color:var(--muted);text-align:center;padding:2px;">▼ あと'+(WAGE_TIERS.length-1-endIdx)+'段階 (最高 '+WAGE_TIERS[WAGE_TIERS.length-1].wage.toLocaleString()+' G)</div>';
  document.getElementById('wageLadder').innerHTML=ladderHtml;

  // gold card
  document.getElementById('goldDisplay').textContent=gold.toLocaleString()+' G';
  const today=todayStr();
  const dayData=getDayData(today);
  document.getElementById('goldToday').textContent='本日の稼ぎ: '+(dayData.earnedGold||0).toLocaleString()+' G';

  // debt display
  var debtEl=document.getElementById('debtDisplay');
  var debtPayBtn=document.getElementById('debtPayBtn');
  if(debtEl){
    var debt=getDebt();
    if(debt&&debt>0){
      debtEl.style.display='block';
      debtEl.textContent='💸 ローン残高: '+debt.toLocaleString()+' G';
      if(debtPayBtn){
        debtPayBtn.style.display=gold>0?'inline-block':'none';
        debtPayBtn.textContent='💸 所持金から返済する ('+Math.min(gold,debt).toLocaleString()+'G)';
      }
    } else {
      debtEl.style.display='none';
      if(debtPayBtn)debtPayBtn.style.display='none';
    }
  }
  updateDebtUI();

  // self status wage
  const el_wage=document.getElementById('ss_wage');
  const el_gold=document.getElementById('ss_gold');
  if(el_wage) el_wage.textContent=wage.toLocaleString()+' G/h';
  if(el_gold) el_gold.textContent=getTotalEarned().toLocaleString();
  document.getElementById('shopGoldLabel').textContent=gold.toLocaleString()+' G';

  // town
  renderTownVis();
  renderBldShop();
}

function renderTownVis(){
  const owned=getOwnedBuildings();
  const el=document.getElementById('townGridVis');
  const pop=owned.reduce((s,id)=>{const b=BUILDINGS.find(x=>x.id===id);return s+(b?b.pop:0);},0);
  document.getElementById('townPopLabel').textContent='人口: '+pop+'人';
  document.getElementById('townPop').textContent=owned.length?'建設数: '+owned.length+'棟 | 総人口: '+pop+'人':'';
  if(!owned.length){
    el.innerHTML='<div style="font-size:.72rem;color:var(--muted);padding:20px;text-align:center;width:100%;">まだ建物がありません。時間を働いてゴールドを稼ごう！</div>';
    return;
  }
  el.innerHTML=owned.map(id=>{
    const b=BUILDINGS.find(x=>x.id===id);
    return b?'<span style="font-size:1.8rem;line-height:1;animation:popIn .3s ease;cursor:default;transition:transform .15s;display:inline-block;" title="'+b.name+' (人口+'+b.pop+')">'+b.e+'</span>':'';
  }).join('');
}

function renderBldShop(){
  const owned=getOwnedBuildings();
  const gold=getGold();
  document.getElementById('bldShop').innerHTML=BUILDINGS.map(b=>{
    const isOwned=owned.includes(b.id);
    const canBuy=!isOwned&&gold>=b.cost;
    const cls='bld-item'+(isOwned?' bld-owned':!canBuy?' bld-cant':'');
    const costCls=isOwned?'c-own':canBuy?'c-gold':'c-lock';
    const costTxt=isOwned?'建設済み ✓':gold>=b.cost?b.cost.toLocaleString()+' G':'🔒 '+b.cost.toLocaleString()+' G';
    return '<div class="'+cls+'" onclick="'+(canBuy?"buyBuilding(&quot;"+b.id+"&quot;)":"")+'">'+
      '<div class="bld-icon">'+b.e+'</div>'+
      '<div class="bld-info"><div class="bld-name">'+b.name+'</div><div class="bld-desc">'+b.desc+' (人口+'+b.pop+')</div></div>'+
      '<div class="bld-cost '+costCls+'">'+costTxt+'</div></div>';
  }).join('');
}

// ================================================================
// SLEEP
// ================================================================
function getSleepIdeals(){return ls_get('sleep_ideals')||{sleepH:23,sleepM:0,wakeH:6,wakeM:30,dur:450};}
function setSleepIdeals(v){ls_set('sleep_ideals',v);}
function getIdealSleep(){var i=getSleepIdeals();return i.sleepH*60+i.sleepM;}
function getIdealWake(){var i=getSleepIdeals();return i.wakeH*60+i.wakeM;}
function getIdealDur(){return getSleepIdeals().dur;}
var IDEAL_SLEEP=getIdealSleep(), IDEAL_WAKE=getIdealWake(), IDEAL_DUR=getIdealDur();
function refreshIdeals(){IDEAL_SLEEP=getIdealSleep();IDEAL_WAKE=getIdealWake();IDEAL_DUR=getIdealDur();updateIdealDisplay();}
function updateIdealDisplay(){
  var i=getSleepIdeals();
  var el=document.getElementById('idealDisplay');
  if(el)el.textContent=String(i.sleepH).padStart(2,'0')+':'+String(i.sleepM).padStart(2,'0')+'就寝 / '+String(i.wakeH).padStart(2,'0')+':'+String(i.wakeM).padStart(2,'0')+'起床 / '+(i.dur/60)+'h';
}
function openSleepIdealEditor(){document.getElementById('sleepIdealModal').classList.add('show');var i=getSleepIdeals();document.getElementById('idealSleepInput').value=String(i.sleepH).padStart(2,'0')+':'+String(i.sleepM).padStart(2,'0');document.getElementById('idealWakeInput').value=String(i.wakeH).padStart(2,'0')+':'+String(i.wakeM).padStart(2,'0');}
function saveSleepIdeals(){
  var s=document.getElementById('idealSleepInput').value;var w=document.getElementById('idealWakeInput').value;
  if(!s||!w){toast('時刻を入力','err');return;}
  var sp=s.split(':').map(Number),wp=w.split(':').map(Number);
  var sm=sp[0]*60+sp[1],wm=wp[0]*60+wp[1];if(wm<=sm)wm+=1440;
  setSleepIdeals({sleepH:sp[0],sleepM:sp[1],wakeH:wp[0],wakeM:wp[1],dur:wm-sm});
  refreshIdeals();closeModal('sleepIdealModal');toast('睡眠の理想値を更新しました');
  onSleepInput(); // recalculate score
}

function calcSleepScore(sv,wv){
  if(!sv||!wv)return null;
  let sm=t2m(sv),wm=t2m(wv);
  if(wm<=sm)wm+=24*60;
  const dur=wm-sm;
  const durScore=Math.max(0,50-Math.abs(dur-IDEAL_DUR)*0.22);
  let sDiff=Math.abs(sm-IDEAL_SLEEP);if(sDiff>12*60)sDiff=24*60-sDiff;
  let wDiff=Math.abs((wm%(24*60))-IDEAL_WAKE);if(wDiff>12*60)wDiff=24*60-wDiff;
  const timingScore=Math.max(0,50-(sDiff+wDiff)*0.14);
  return Math.round(durScore+timingScore);
}

function onSleepInput(){
  // Legacy: sleep is now auto-calculated from blocks. This function is kept for compatibility.
  recalcSleepFromBlocks(currentDate);
  renderP1();
}

function updateSleepUI(score){
  const el=document.getElementById('sleepScore');
  const arc=document.getElementById('sleepArc');
  const band=document.getElementById('sleepBand');
  const msg=document.getElementById('sleepMsg');
  document.getElementById('m_sleep').textContent=score!==null?score+'点':'--';
  if(score===null){el.textContent='--';arc.setAttribute('stroke-dashoffset','232.48');band.style.width='0%';msg.textContent='時刻を入力してください';msg.style.color='var(--muted2)';return;}
  el.textContent=score;
  arc.setAttribute('stroke-dashoffset',232.48*(1-score/100));
  const c=score>=85?'#4ade80':score>=65?'#fbbf24':score>=45?'#fb923c':'#fb7185';
  arc.setAttribute('stroke',c);
  band.style.width=score+'%';band.style.background=c;
  if(score>=90){msg.textContent='🌟 完璧な睡眠！';msg.style.color='#4ade80';}
  else if(score>=75){msg.textContent='😊 良い睡眠';msg.style.color='#4ade80';}
  else if(score>=60){msg.textContent='😐 もう少し';msg.style.color='#fbbf24';}
  else if(score>=40){msg.textContent='😴 改善しよう';msg.style.color='#fb923c';}
  else{msg.textContent='😵 睡眠を見直そう';msg.style.color='#fb7185';}
}

// ================================================================
// STREAK
// ================================================================
function calcStreak(){
  // Unrecorded days are "pauses" — they don't break the streak
  var today=todayStr();
  var s=0, maxGap=3, gap=0, check=today;
  for(var i=0;i<400;i++){
    var d=getDayData(check);
    var hasRecord=d.blocks.length>0||d.sleepScore!==null;
    if(hasRecord){s++;gap=0;}
    else{gap++;if(gap>maxGap)break;} // allow up to 3 unrecorded days as pause
    check=addDays(check,-1);
  }
  return s;
}
function isDayUnrecorded(dateStr){
  var d=getDayData(dateStr);
  return d.blocks.length===0&&d.sleepScore===null&&d.sleepTime===null;
}

// ================================================================
// EFFORT
// ================================================================
function getEffortMins(blocks){return blocks.filter(b=>catLookup(b.category).effort).reduce((s,b)=>s+t2m(b.end)-t2m(b.start),0);}
function getCatMins(blocks,cat){return blocks.filter(b=>catBase(b.category)===cat).reduce((s,b)=>s+t2m(b.end)-t2m(b.start),0);}
function getSubCatMins(blocks,fullCat){return blocks.filter(b=>b.category===fullCat).reduce((s,b)=>s+t2m(b.end)-t2m(b.start),0);}

// ================================================================
// PAGE 1 RENDER
// ================================================================
function renderP1(){
  // Date pill
  const pill=document.getElementById('datePill');
  pill.textContent=formatDate(currentDate);
  pill.className='date-pill'+(currentDate===todayStr()?' today':'');

  const day=getDayData(currentDate);
  // Auto-calc sleep from blocks
  recalcSleepFromBlocks(currentDate);
  var dayRefresh=getDayData(currentDate);
  updateSleepUI(dayRefresh.sleepScore||null);
  // Show sleep block info
  var sInfo=document.getElementById('sleepBlockInfo');
  if(sInfo){
    var sleepBlks=dayRefresh.blocks.filter(function(b){return catBase(b.category)==='睡眠';});
    if(sleepBlks.length>0){
      var totalM=sleepBlks.reduce(function(s,b){return s+t2m(b.end)-t2m(b.start);},0);
      sInfo.innerHTML='🌙 '+sleepBlks.map(function(b){return b.start+'〜'+b.end;}).join(' + ')+' <span style="color:var(--cyan);font-weight:700;">'+m2hm(totalM)+'</span>';
    } else {
      sInfo.innerHTML='🌙 睡眠ブロックを追加すると自動計算されます';
    }
  }

  renderBlockList(day.blocks);
  renderTimeline(day.blocks);
  renderPie(day.blocks);
  renderEffort(day.blocks);
  updateMetrics(day);
  renderSpecialList();
  renderQuickAdds();
  renderDayTplBar();
  renderDailyQuests();
  renderTodos();
  renderPerformance();
  updateDayXPBar(day.blocks);
  updateNav();
}

function updateDayXPBar(blocks){
  const total=blocks.reduce((s,b)=>{var bc=catBase(b.category);if(NO_XP_CATS.includes(bc))return s;return s+(catLookup(b.category).effort?Math.round((t2m(b.end)-t2m(b.start))/60*XP_PER_EFFORT_HOUR):Math.round((t2m(b.end)-t2m(b.start))/60*XP_PER_OTHER_HOUR));},0);
  const pct=Math.min(100,total/100*100);
  document.getElementById('dayXPBar').style.width=pct+'%';
  document.getElementById('dayXPVal').textContent=total;
}

function renderBlockList(blocks){
  const el=document.getElementById('blockList');
  if(!blocks.length){el.innerHTML='<div style="text-align:center;color:rgba(255,255,255,0.2);font-size:0.78rem;padding:20px;line-height:1.8;">まだ記録がない日です<br><span style="font-size:.65rem;color:rgba(255,255,255,0.12);">再開はいつでもできます</span></div>';return;}
  el.innerHTML=blocks.map(b=>{
    const cat=catLookup(b.category);
    const m=t2m(b.end)-t2m(b.start);
    const isEditing=(editingBlockId===b.id);
    const autoTag=b.autoSleep?'<span style="font-size:.5rem;background:rgba(129,140,248,.15);color:#818cf8;padding:1px 5px;border-radius:4px;margin-left:4px;">自動</span>':'';
    if(isEditing){
      var catOpts=buildCatOptions(b.category);
      return '<div class="bitem editing">'+
        '<div class="bdot" style="background:'+cat.color+'"></div>'+
        '<div class="binfo">'+
          '<div class="bcat">'+catLabel(b.category)+autoTag+'</div>'+
          '<div class="bedit-row">'+
            '<input type="time" id="bedit_s_'+b.id+'" value="'+b.start+'" step="600">'+
            '<span style="color:var(--muted);font-size:.65rem;">〜</span>'+
            '<input type="time" id="bedit_e_'+b.id+'" value="'+b.end+'" step="600">'+
            '<select id="bedit_c_'+b.id+'">'+catOpts+'</select>'+
          '</div>'+
          '<div class="bedit-row" style="margin-top:4px;">'+
            '<button class="bedit-save" onclick="event.stopPropagation();saveEditBlock('+b.id+')">✓ 保存</button>'+
            '<button class="bedit-cancel" onclick="event.stopPropagation();cancelEditBlock()">✕</button>'+
          '</div>'+
        '</div>'+
      '</div>';
    }
    return '<div class="bitem" onclick="startEditBlock('+b.id+')"><div class="bdot" style="background:'+cat.color+'"></div><div class="binfo"><div class="bcat">'+catLabel(b.category)+autoTag+'</div><div class="btime">'+b.start+'–'+b.end+' '+m2hm(m)+'</div></div><button class="bdel" onclick="event.stopPropagation();deleteBlock('+b.id+')">×</button></div>';
  }).join('');
}

function renderTimeline(blocks){
  const el=document.getElementById('timeline');
  if(!blocks.length){el.innerHTML='<div style="display:flex;height:100%;align-items:center;justify-content:center;color:var(--muted);font-size:0.68rem;">タイムライン</div>';return;}
  el.innerHTML=blocks.map(b=>{const cat=catLookup(b.category);const l=(t2m(b.start)/1440*100).toFixed(2),w=((t2m(b.end)-t2m(b.start))/1440*100).toFixed(2);return `<div class="tl-seg" style="left:${l}%;width:${w}%;background:${cat.color}" title="${b.category} ${b.start}-${b.end}"></div>`;}).join('');
}

function renderPie(blocks){
  // Category totals for legend
  var totals={};
  blocks.forEach(function(b){var m=t2m(b.end)-t2m(b.start);var bc=catBase(b.category);totals[bc]=(totals[bc]||0)+m;});
  var total=Object.values(totals).reduce(function(a,b){return a+b;},0);
  document.getElementById('pieTotal').textContent=total?m2hm(total)+'h':'0h';
  var labels=Object.keys(totals),data=labels.map(function(l){return totals[l];}),colors=labels.map(function(l){return (CATS[l]||{color:'#64748b'}).color;});
  document.getElementById('pieLegend').innerHTML=labels.length?labels.map(function(l,i){
    var pct=total?(data[i]/total*100).toFixed(0):0;
    return '<div class="leg-item"><div class="leg-dot" style="background:'+colors[i]+'"></div><div class="leg-name">'+l+'</div><div class="leg-val">'+m2hm(data[i])+' <span style="color:var(--muted);font-size:0.62rem">'+pct+'%</span></div></div><div class="leg-bar" style="width:'+pct+'%;background:'+colors[i]+'"></div>';
  }).join(''):'<div style="color:var(--muted);font-size:0.75rem;">データなし</div>';

  // 24h clock chart
  var canvas=document.getElementById('clockCanvas');
  var ctx=canvas.getContext('2d');
  var W=canvas.width, H=canvas.height;
  var cx=W/2, cy=H/2, R=W/2-42, innerR=R*0.50;
  ctx.clearRect(0,0,W,H);

  // Background ring
  ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.arc(cx,cy,innerR,0,Math.PI*2,true);ctx.fillStyle='rgba(30,41,59,0.4)';ctx.fill();

  // Hour grid lines (subtle radial lines every hour)
  for(var h=0;h<24;h++){
    var angle=(h/24)*Math.PI*2 - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(cx+Math.cos(angle)*innerR, cy+Math.sin(angle)*innerR);
    ctx.lineTo(cx+Math.cos(angle)*R, cy+Math.sin(angle)*R);
    ctx.strokeStyle='rgba(51,65,85,0.5)';
    ctx.lineWidth=1;
    ctx.stroke();
  }

  // Draw blocks as arcs
  var sortedBlocks=blocks.slice().sort(function(a,b){return t2m(a.start)-t2m(b.start);});
  sortedBlocks.forEach(function(b){
    var sm=t2m(b.start), em=t2m(b.end);
    if(em<=sm)return;
    var startAngle=(sm/1440)*Math.PI*2 - Math.PI/2;
    var endAngle=(em/1440)*Math.PI*2 - Math.PI/2;
    var cat=catLookup(b.category);
    ctx.beginPath();
    ctx.arc(cx,cy,R,startAngle,endAngle);
    ctx.arc(cx,cy,innerR,endAngle,startAngle,true);
    ctx.closePath();
    ctx.fillStyle=cat.color;
    ctx.fill();
    ctx.strokeStyle='rgba(10,10,15,0.6)';ctx.lineWidth=2;ctx.stroke();

    // Label
    var midAngle=(startAngle+endAngle)/2;
    var dur=em-sm;
    if(dur>=30){
      var labelR=(R+innerR)/2;
      var lx=cx+Math.cos(midAngle)*labelR;
      var ly=cy+Math.sin(midAngle)*labelR;
      ctx.fillStyle='#fff';
      ctx.font='bold '+(dur>=120?'26':dur>=60?'22':'16')+'px "M PLUS Rounded 1c",sans-serif';
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.shadowColor='rgba(0,0,0,0.8)';ctx.shadowBlur=6;
      ctx.fillText(b.category,lx,ly);
      if(dur>=60){
        ctx.font='14px "JetBrains Mono",monospace';
        ctx.fillStyle='rgba(255,255,255,0.7)';
        ctx.fillText(b.start+'-'+b.end,lx,ly+18);
      }
      ctx.shadowBlur=0;
    }
  });

  // Hour ticks and numbers — every hour
  for(var h=0;h<24;h++){
    var angle=(h/24)*Math.PI*2 - Math.PI/2;
    var isMajor=(h%6===0);
    var is3h=(h%3===0);
    var tickLen=isMajor?12:is3h?8:5;
    var tickOuter=R+tickLen;
    var tickInner=R+1;
    ctx.beginPath();
    ctx.moveTo(cx+Math.cos(angle)*tickInner, cy+Math.sin(angle)*tickInner);
    ctx.lineTo(cx+Math.cos(angle)*tickOuter, cy+Math.sin(angle)*tickOuter);
    ctx.strokeStyle=isMajor?'rgba(148,163,184,0.8)':is3h?'rgba(148,163,184,0.5)':'rgba(100,116,139,0.35)';
    ctx.lineWidth=isMajor?2.5:is3h?1.5:1;
    ctx.stroke();

    // Number label for every hour
    var numR=R+(isMajor?26:is3h?22:18);
    var nx=cx+Math.cos(angle)*numR;
    var ny=cy+Math.sin(angle)*numR;
    ctx.fillStyle=isMajor?'rgba(203,213,225,0.9)':is3h?'rgba(148,163,184,0.7)':'rgba(100,116,139,0.5)';
    ctx.font=(isMajor?'bold 22':is3h?'bold 18':'16')+'px "JetBrains Mono",monospace';
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(h,nx,ny);
  }
}

function renderEffort(blocks){
  const total=getEffortMins(blocks);
  document.getElementById('effortBig').textContent=m2hm(total);
  document.getElementById('m_effort').textContent=m2hm(total);
  const maxM=8*60;
  document.getElementById('effortBars').innerHTML=EFFORT_CATS.map(c=>{
    const m=getCatMins(blocks,c),pct=Math.min(100,m/maxM*100),cat=CATS[c];
    return `<div class="ebar"><div class="ebar-lbl">${cat.emoji}${c}</div><div class="ebar-track"><div class="ebar-fill" style="width:${pct}%;background:${cat.color}"></div></div><div class="ebar-val">${m2hm(m)}</div></div>`;
  }).join('');
}

function updateMetrics(day){
  const totalM=day.blocks.reduce((s,b)=>s+t2m(b.end)-t2m(b.start),0);
  document.getElementById('m_total').textContent=m2hm(totalM);
  const yd=getDayData(addDays(currentDate,-1));
  function trend(a,b){if(!b)return'';const d=a-b,p=Math.round(d/b*100);if(d>0)return`<span style="color:var(--green)">▲${p}%</span>`;if(d<0)return`<span style="color:var(--rose)">▼${Math.abs(p)}%</span>`;return`<span style="color:var(--muted)">→</span>`;}
  document.getElementById('m_total_trend').innerHTML=trend(totalM,yd.blocks.reduce((s,b)=>s+t2m(b.end)-t2m(b.start),0));
  document.getElementById('m_effort_trend').innerHTML=trend(getEffortMins(day.blocks),getEffortMins(yd.blocks));
  document.getElementById('m_sleep_trend').innerHTML=day.sleepScore&&yd.sleepScore?trend(day.sleepScore,yd.sleepScore):'';
}

// ================================================================
// BLOCK EDITING (inline)
// ================================================================
var editingBlockId=null;
function startEditBlock(id){
  editingBlockId=id;
  renderP1();
}
function cancelEditBlock(){
  editingBlockId=null;
  renderP1();
}
function saveEditBlock(id){
  var s=document.getElementById('bedit_s_'+id).value;
  var e=document.getElementById('bedit_e_'+id).value;
  var c=document.getElementById('bedit_c_'+id).value;
  if(!s||!e){toast('時刻を入力してください','err');return;}
  var day=getDayData(currentDate);
  var block=day.blocks.find(function(b){return b.id===id;});
  if(!block){toast('ブロックが見つかりません','err');return;}
  // Overlap check (exclude self)
  var sm=t2m(s),em=t2m(e);
  if(em<=sm){toast('終了時刻が開始より前です','err');return;}
  for(var i=0;i<day.blocks.length;i++){
    var b=day.blocks[i];
    if(b.id===id)continue;
    var bS=t2m(b.start),bE=t2m(b.end);
    if(sm<bE&&em>bS){toast('⚠ '+b.start+'〜'+b.end+'と重複','err');return;}
  }
  block.start=s;block.end=e;block.category=c;
  mergeBlocks(day);
  setDayData(currentDate,day);
  recalcSleepFromBlocks(currentDate);
  editingBlockId=null;
  toast('✏️ ブロックを更新しました');
  renderP1();
}

// ================================================================
// DAY TEMPLATES (preset daily schedules)
// ================================================================
function getDayTemplates(){return ls_get('day_templates')||[];}
function setDayTemplates(v){ls_set('day_templates',v);}
var editingDayTplIdx=null;

function renderDayTplBar(){
  var el=document.getElementById('dayTplBar');
  var tpls=getDayTemplates();
  var chips=tpls.map(function(t,i){
    return '<span class="daytpl-chip" onclick="applyDayTpl('+i+')" title="'+t.blocks.length+'件の行動を適用">'+t.name+'</span>';
  }).join('');
  el.innerHTML='<span style="font-size:.62rem;color:var(--muted2);flex-shrink:0;">📅 一日テンプレ：</span>'+chips+
    '<span class="daytpl-chip" onclick="openDayTplManager()" style="opacity:.6;font-size:.58rem;">⚙️ 管理</span>';
}

function openDayTplManager(){
  document.getElementById('dayTplModal').classList.add('show');
  renderDayTplManagerList();
}

function renderDayTplManagerList(){
  var tpls=getDayTemplates();
  var el=document.getElementById('dayTplList');
  if(!tpls.length){
    el.innerHTML='<div style="text-align:center;color:var(--muted);font-size:.72rem;padding:16px;">テンプレートがありません<br><span style="font-size:.62rem;">下のボタンから作成してください</span></div>';
    return;
  }
  el.innerHTML=tpls.map(function(t,i){
    var blockPreview=t.blocks.slice(0,4).map(function(b){
      var cat=catLookup(b.cat);
      return '<span style="font-size:.55rem;background:var(--s3);border:1px solid var(--border);padding:1px 5px;border-radius:4px;">'+cat.emoji+b.start+'-'+b.end+'</span>';
    }).join(' ')+(t.blocks.length>4?' <span style="font-size:.55rem;color:var(--muted);">+他'+(t.blocks.length-4)+'件</span>':'');
    return '<div style="background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:6px;">'+
      '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">'+
        '<span style="font-weight:700;font-size:.8rem;">'+t.name+'</span>'+
        '<span style="font-size:.58rem;color:var(--muted);">'+t.blocks.length+'件</span>'+
      '</div>'+
      '<div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:8px;">'+blockPreview+'</div>'+
      '<div style="display:flex;gap:4px;">'+
        '<button class="btn sm" onclick="applyDayTpl('+i+');closeModal(\'dayTplModal\')" style="border-color:var(--green);color:var(--green);flex:1;font-size:.62rem;">▶ 適用</button>'+
        '<button class="btn sm" onclick="editDayTpl('+i+')" style="font-size:.62rem;flex:1;">✏️ 編集</button>'+
        '<button class="btn sm" onclick="deleteDayTpl('+i+')" style="color:var(--rose);font-size:.62rem;">🗑</button>'+
      '</div>'+
    '</div>';
  }).join('');
}

function saveDayTplFromCurrent(){
  var name=document.getElementById('dayTplName').value.trim();
  if(!name){toast('テンプレート名を入力してください','err');return;}
  var day=getDayData(currentDate);
  if(!day.blocks.length){toast('今日の記録がありません','err');return;}
  var tplBlocks=day.blocks.filter(function(b){return !b.autoSleep;}).map(function(b){return {start:b.start,end:b.end,cat:b.category};});
  if(!tplBlocks.length){toast('保存できるブロックがありません','err');return;}
  var tpls=getDayTemplates();
  tpls.push({name:name,blocks:tplBlocks});
  setDayTemplates(tpls);
  document.getElementById('dayTplName').value='';
  toast('📅 「'+name+'」を保存しました');
  renderDayTplManagerList();
  renderDayTplBar();
}

function saveDayTplEmpty(){
  var name=document.getElementById('dayTplName').value.trim();
  if(!name){toast('テンプレート名を入力してください','err');return;}
  var tpls=getDayTemplates();
  tpls.push({name:name,blocks:[]});
  setDayTemplates(tpls);
  document.getElementById('dayTplName').value='';
  toast('📅 「'+name+'」を作成しました（空）');
  renderDayTplManagerList();
  renderDayTplBar();
  // Open edit immediately
  editDayTpl(tpls.length-1);
}

function deleteDayTpl(i){
  var tpls=getDayTemplates();
  var name=tpls[i].name;
  tpls.splice(i,1);
  setDayTemplates(tpls);
  toast('🗑 「'+name+'」を削除しました');
  renderDayTplManagerList();
  renderDayTplBar();
}

function editDayTpl(i){
  editingDayTplIdx=i;
  closeModal('dayTplModal');
  var tpls=getDayTemplates();
  var t=tpls[i];
  document.getElementById('dayTplEditTitle').textContent='✏️ '+t.name+' を編集';
  // Populate cat select
  document.getElementById('dtplNewCat').innerHTML=Object.keys(CATS).map(function(c){return '<option value="'+c+'">'+CATS[c].emoji+' '+c+'</option>';}).join('');
  document.getElementById('dayTplEditModal').classList.add('show');
  renderDayTplEditList();
}

function renderDayTplEditList(){
  var tpls=getDayTemplates();
  var t=tpls[editingDayTplIdx];
  var el=document.getElementById('dayTplEditList');
  if(!t.blocks.length){
    el.innerHTML='<div style="text-align:center;color:var(--muted);font-size:.72rem;padding:16px;">ブロックがありません</div>';
    return;
  }
  el.innerHTML=t.blocks.map(function(b,bi){
    var cat=catLookup(b.cat);
    return '<div style="display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid var(--border);">'+
      '<div style="width:8px;height:8px;border-radius:50%;background:'+cat.color+';flex-shrink:0;"></div>'+
      '<span style="font-size:.75rem;font-weight:700;">'+cat.emoji+' '+b.cat+'</span>'+
      '<span style="font-size:.65rem;color:var(--muted);font-family:JetBrains Mono,monospace;margin-left:auto;">'+b.start+' - '+b.end+'</span>'+
      '<button class="btn sm" onclick="removeDayTplBlock('+bi+')" style="font-size:.55rem;color:var(--rose);padding:2px 6px;">×</button>'+
    '</div>';
  }).join('');
}

function addBlockToDayTpl(){
  var s=document.getElementById('dtplNewStart').value;
  var e=document.getElementById('dtplNewEnd').value;
  var c=document.getElementById('dtplNewCat').value;
  if(!s||!e){toast('時刻を入力してください','err');return;}
  var tpls=getDayTemplates();
  var t=tpls[editingDayTplIdx];
  t.blocks.push({start:s,end:e,cat:c});
  t.blocks.sort(function(a,b){return t2m(a.start)-t2m(b.start);});
  setDayTemplates(tpls);
  renderDayTplEditList();
  renderDayTplBar();
  toast('＋ ブロック追加');
}

function removeDayTplBlock(bi){
  var tpls=getDayTemplates();
  tpls[editingDayTplIdx].blocks.splice(bi,1);
  setDayTemplates(tpls);
  renderDayTplEditList();
  renderDayTplBar();
}

function applyDayTpl(i){
  var tpls=getDayTemplates();
  var t=tpls[i];
  if(!t.blocks.length){toast('このテンプレートにはブロックがありません','err');return;}
  var day=getDayData(currentDate);
  var existingNonAuto=day.blocks.filter(function(b){return !b.autoSleep;});
  var added=0,skipped=0;
  t.blocks.forEach(function(tb){
    var sm=t2m(tb.start),em=t2m(tb.end);
    // Check overlap with existing
    var overlaps=false;
    for(var j=0;j<day.blocks.length;j++){
      var b=day.blocks[j];
      var bS=t2m(b.start),bE=t2m(b.end);
      if(sm<bE&&em>bS){overlaps=true;break;}
    }
    if(!overlaps){
      var block={start:tb.start,end:tb.end,category:tb.cat,id:Date.now()+Math.random()*10000|0};
      day.blocks.push(block);
      // XP
      var dur=em-sm;
      var isEffort=CATS[tb.cat]&&CATS[tb.cat].effort;
      var isNoXP=NO_XP_CATS.includes(tb.cat);
      var xpGain=isNoXP?0:(isEffort?Math.round(dur/60*XP_PER_EFFORT_HOUR):Math.round(dur/60*XP_PER_OTHER_HOUR));
      addXP(xpGain,block);
      added++;
    } else {
      skipped++;
    }
  });
  mergeBlocks(day);
  setDayData(currentDate,day);
  recalcSleepFromBlocks(currentDate);
  renderP1();
  var msg='📅 「'+t.name+'」を適用 — '+added+'件追加';
  if(skipped>0)msg+='（'+skipped+'件は重複スキップ）';
  toast(msg);
}

function renderQuickAdds(){
  var el=document.getElementById('quickAdds');
  QUICK_TEMPLATES=getQuickTemplates();
  var chips=QUICK_TEMPLATES.map(function(t){return '<span class="qa-chip" onclick=\'quickAdd('+JSON.stringify(t).replace(/'/g,"&#39;")+')\'>'+(CATS[t.cat]?CATS[t.cat].emoji+' ':'')+t.label+'</span>';}).join('');
  el.innerHTML='<span style="font-size:0.62rem;color:var(--muted2);align-self:center;flex-shrink:0;">よく使う：</span>'+chips+'<span class="qa-chip" onclick="openTplEditor()" style="opacity:.5;font-size:.58rem;">✏️</span>';
}
function openTplEditor(){document.getElementById('tplEditorModal').classList.add('show');renderTplEditor();}
function renderTplEditor(){
  var tpls=getQuickTemplates();
  document.getElementById('tplEditorList').innerHTML=tpls.map(function(t,i){
    return '<div style="display:flex;align-items:center;gap:4px;padding:5px 0;border-bottom:1px solid var(--border);"><span style="flex:1;font-size:.72rem;color:var(--text);">'+(CATS[t.cat]?CATS[t.cat].emoji+' ':'')+t.label+' <span style="font-size:.58rem;color:var(--muted);">'+t.start+'-'+t.end+'</span></span><button class="btn sm" onclick="removeTpl('+i+')" style="font-size:.6rem;color:var(--rose);padding:2px 8px;">×</button></div>';
  }).join('');
}
function removeTpl(i){var t=getQuickTemplates();t.splice(i,1);setQuickTemplates(t);renderTplEditor();renderQuickAdds();}
function addTpl(){
  var l=document.getElementById('tplLabel').value.trim(),s=document.getElementById('tplStart').value,e=document.getElementById('tplEnd').value,c=document.getElementById('tplCat').value;
  if(!l||!s||!e){toast('全項目を入力してください','err');return;}
  var t=getQuickTemplates();t.push({label:l,start:s,end:e,cat:c});setQuickTemplates(t);
  document.getElementById('tplLabel').value='';renderTplEditor();renderQuickAdds();toast('テンプレート追加！');
}

// ================================================================
// PAGE 2 RENDER
// ================================================================
// ===== CATEGORY SUMMARY =====
var sumTab='week';
function setSumTab(t){sumTab=t;document.getElementById('sumWeek').className='tstep-btn'+(t==='week'?' active':'');document.getElementById('sumAll').className='tstep-btn'+(t==='all'?' active':'');renderCatSummary();}
function renderCatSummary(){
  var el=document.getElementById('catSummary');if(!el)return;
  var dates=[];
  if(sumTab==='week'){for(var i=6;i>=0;i--){var d=new Date();d.setDate(d.getDate()-i);dates.push(d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'));}}
  else{for(var i=0;i<localStorage.length;i++){var k=localStorage.key(i);if(k&&k.startsWith('tf3_d_'))dates.push(k.replace('tf3_d_',''));}dates.sort();}
  var baseMins={},fullMins={};
  dates.forEach(function(dt){var day=getDayData(dt);if(!day||!day.blocks)return;
    day.blocks.forEach(function(b){var m=t2m(b.end)-t2m(b.start);if(m<=0)return;var bc=catBase(b.category);baseMins[bc]=(baseMins[bc]||0)+m;fullMins[b.category]=(fullMins[b.category]||0)+m;});
  });
  var sorted=Object.keys(baseMins).sort(function(a,b){return baseMins[b]-baseMins[a];});
  if(!sorted.length){el.innerHTML='<div style="color:var(--muted2);text-align:center;padding:16px;">記録がありません</div>';return;}
  var totalM=sorted.reduce(function(s,c){return s+baseMins[c];},0);
  var fmtM=function(m){return Math.floor(m/60)+'h'+String(m%60).padStart(2,'0')+'m';};
  var html='<div style="display:flex;flex-direction:column;gap:3px;">';
  sorted.forEach(function(c){
    var cat=CATS[c]||{emoji:'📋',color:'#64748b'};var m=baseMins[c];var pct=totalM>0?Math.round(m/totalM*100):0;
    html+='<div style="padding:8px 10px;background:var(--s1);border-radius:8px;">';
    html+='<div style="display:flex;justify-content:space-between;align-items:center;">';
    html+='<span style="font-weight:700;">'+cat.emoji+' '+c+'</span>';
    html+='<span style="font-family:\'JetBrains Mono\',monospace;font-weight:700;color:'+cat.color+';">'+fmtM(m)+'<span style="color:var(--muted2);font-size:.55rem;margin-left:4px;">'+pct+'%</span></span>';
    html+='</div>';
    html+='<div style="height:4px;background:var(--s3);border-radius:2px;margin-top:4px;overflow:hidden;"><div style="height:100%;width:'+pct+'%;background:'+cat.color+';border-radius:2px;"></div></div>';
    // Sub-categories
    var subs=Object.keys(fullMins).filter(function(k){return k.startsWith(c+'::');}).sort(function(a,b){return fullMins[b]-fullMins[a];});
    subs.forEach(function(key){
      var sn=catSub(key),sm=fullMins[key],sp=m>0?Math.round(sm/m*100):0;
      html+='<div style="display:flex;justify-content:space-between;padding:3px 0 3px 16px;font-size:.68rem;color:var(--muted2);">';
      html+='<span>└ '+sn+'</span>';
      html+='<span style="font-family:\'JetBrains Mono\',monospace;color:var(--muted);">'+fmtM(sm)+' <span style="font-size:.52rem;">'+sp+'%</span></span></div>';
    });
    html+='</div>';
  });
  html+='<div style="text-align:right;font-size:.65rem;color:var(--muted2);margin-top:6px;">合計: <span style="font-family:\'JetBrains Mono\',monospace;color:var(--text);font-weight:700;">'+fmtM(totalM)+'</span></div></div>';
  el.innerHTML=html;
}

function renderP2(){
  const allDates=getAllDates();
  const streak=calcStreak();

  // cue
  const hour=new Date().getHours();
  const msgs=[
    ['🌅','おはようございます！今日の計画を確認しよう','朝の統計チェックが習慣を強化します'],
    ['⚡','今日の進捗はいかがですか？','午後の追い込みで目標達成しよう'],
    ['🌙','今日もお疲れ様でした','記録を振り返って明日に活かそう'],
  ];
  const m=hour<11?msgs[0]:hour<17?msgs[1]:msgs[2];
  document.getElementById('cueEmoji').textContent=m[0];
  document.getElementById('cueMain').textContent=m[1];
  document.getElementById('cueSub').textContent=m[2];

  // big stats
  document.getElementById('bs_streak').textContent=streak;
  document.getElementById('bs_xp').textContent=getTotalXP();
  // Only count days with actual data for averages (exclude unrecorded "pause" days)
  const recordedDates=allDates.filter(d=>{const dd=getDayData(d);return dd.blocks.length>0||dd.sleepScore!==null;});
  const allEffort=recordedDates.reduce((s,d)=>s+getEffortMins(getDayData(d).blocks),0);
  document.getElementById('bs_effort').textContent=m2hm(allEffort);
  const allD=recordedDates.filter(d=>getDayData(d).sleepScore);
  const avgSleep=allD.length?Math.round(allD.reduce((s,d)=>s+getDayData(d).sleepScore,0)/allD.length):null;
  document.getElementById('bs_sleep').textContent=avgSleep!==null?avgSleep:'--';
  document.getElementById('bs_effort_sub').textContent=recordedDates.length?`記録${recordedDates.length}日 / 平均${m2hm(allEffort/recordedDates.length)}`:'記録なし';

  renderTrends();
  renderHabitGrid();
  renderHistory();
  renderCatSummary();
}

function setTrend(m){
  trendMode=m;
  document.getElementById('trendDayBtn').classList.toggle('active',m==='day');
  document.getElementById('trendWeekBtn').classList.toggle('active',m==='week');
  renderTrends();
}

function getWeekStart(d){const dt=parseDate(d),day=dt.getDay(),diff=day===0?-6:1-day;dt.setDate(dt.getDate()+diff);return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');}

function renderTrends(){
  let labels,data;
  if(trendMode==='day'){
    labels=[];data=[];
    for(let i=13;i>=0;i--){const d=addDays(currentDate,-i);labels.push(formatShort(d));data.push(getDayData(d));}
  } else {
    const wm={};getAllDates().forEach(d=>{const w=getWeekStart(d);if(!wm[w])wm[w]=[];wm[w].push(getDayData(d));});
    const weeks=Object.keys(wm).sort().slice(-8);
    labels=weeks.map(w=>{const dt=parseDate(w);return `${dt.getMonth()+1}/${dt.getDate()}W`;});
    data=weeks.map(w=>{const days=wm[w],blocks=days.flatMap(d=>d.blocks),scores=days.map(d=>d.sleepScore).filter(Boolean);return{blocks,sleepScore:scores.length?Math.round(scores.reduce((a,b)=>a+b)/scores.length):null};});
  }
  _renderLine(labels,data);
  _renderEffortLine(labels,data);
}

const CO={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#4a6080',font:{family:'JetBrains Mono',size:9}}},y:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#4a6080',font:{family:'JetBrains Mono',size:9}}}}};

function _renderLine(labels,data){
  const ctx=document.getElementById('lineChart').getContext('2d');
  if(lineChart)lineChart.destroy();
  const cats=['仕事','学習','運動','趣味','休憩'];
  lineChart=new Chart(ctx,{type:'line',data:{labels,datasets:cats.map(c=>({label:c,data:data.map(d=>+(getCatMins(d.blocks,c)/60).toFixed(1)),borderColor:CATS[c].color,backgroundColor:CATS[c].color+'18',tension:0.4,pointRadius:3,borderWidth:2}))},options:{...CO,plugins:{legend:{display:true,labels:{color:'#6a85a8',font:{family:'M PLUS Rounded 1c',size:10},boxWidth:8,boxHeight:8}}}}});
}

function _renderEffortLine(labels,data){
  const ctx=document.getElementById('effortChart').getContext('2d');
  if(effortChart)effortChart.destroy();
  // Gray out unrecorded days: use different color per bar
  const effortData=data.map(d=>+(getEffortMins(d.blocks||[])/60).toFixed(1));
  const barColors=data.map(d=>{
    var hasBlocks=d.blocks&&d.blocks.length>0;
    var hasSleep=d.sleepScore!==null&&d.sleepScore!==undefined;
    if(hasBlocks||hasSleep)return 'rgba(74,222,128,0.25)';
    return 'rgba(255,255,255,0.06)'; // unrecorded = very faint white
  });
  const barBorders=data.map(d=>{
    var hasBlocks=d.blocks&&d.blocks.length>0;
    var hasSleep=d.sleepScore!==null&&d.sleepScore!==undefined;
    if(hasBlocks||hasSleep)return '#4ade80';
    return 'rgba(255,255,255,0.15)';
  });
  // For unrecorded days, show a tiny gray placeholder bar
  const displayData=effortData.map((v,i)=>{
    if(v===0&&barColors[i].includes('255,255,255')){return 0.05;} // tiny placeholder
    return v;
  });
  effortChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{type:'bar',label:'努力時間(h)',data:displayData,backgroundColor:barColors,borderColor:barBorders,borderWidth:1,yAxisID:'y'},{type:'line',label:'睡眠スコア',data:data.map(d=>d.sleepScore||null),borderColor:'#c084fc',backgroundColor:'transparent',tension:0.4,pointRadius:4,pointBackgroundColor:'#c084fc',borderWidth:2,yAxisID:'y2',spanGaps:true}]},options:{...CO,scales:{x:CO.scales.x,y:{...CO.scales.y,position:'left',title:{display:true,text:'h',color:'#4a6080',font:{size:9}}},y2:{...CO.scales.y,position:'right',min:0,max:100,grid:{drawOnChartArea:false},title:{display:true,text:'Score',color:'#4a6080',font:{size:9}}}},plugins:{legend:{display:true,labels:{color:'#6a85a8',font:{family:'M PLUS Rounded 1c',size:10},boxWidth:8,boxHeight:8}}}}});
}

function renderHabitGrid(){
  const el=document.getElementById('habitGrid');
  const today=todayStr();
  const allDates=getAllDates();
  let html='';
  for(let i=55;i>=0;i--){
    const d=addDays(today,-i);
    const hasData=allDates.includes(d)&&getDayData(d).blocks.length>0;
    const isFuture=parseDate(d)>new Date();
    const isPast=!isFuture&&!hasData&&parseDate(d)<new Date();
    const score=hasData?Math.min(100,getEffortMins(getDayData(d).blocks)/360*100):0;
    const opacity=hasData?Math.max(0.2,score/100):0.04;
    const dd=parseDate(d);
    let bg,border,titleSuffix;
    if(hasData){
      bg='rgba(74,222,128,'+opacity+')';border='rgba(74,222,128,0.3)';titleSuffix=' ✓';
    } else if(isPast){
      // Unrecorded past day — white/soft (not failure, just "pause")
      bg='rgba(255,255,255,0.04)';border='rgba(255,255,255,0.08)';titleSuffix=' ⏸ 一時停止';
    } else {
      bg='rgba(26,40,32,0.2)';border='var(--border)';titleSuffix='';
    }
    if(d===today){border='var(--cyan)';}
    html+='<div class="hcell '+(hasData?'filled':'')+' '+(d===today?'today-cell':'')+'" style="background:'+bg+';border-color:'+border+';" onclick="jumpDate(\''+d+'\')" title="'+formatShort(d)+titleSuffix+'">'+dd.getDate()+'</div>';
  }
  el.innerHTML=html;
  updateStreakReward();
}

// ================================================================
// STREAK REWARD SYSTEM
// ================================================================
function getStreakRewardAmount(streak){
  // Base 10G, increases with streak: 10, 15, 20, 30, 50, 80, 120, 180, 250, 350...
  if(streak<=0)return 0;
  if(streak<=3)return 10+streak*5;
  if(streak<=7)return 20+streak*8;
  if(streak<=14)return 40+(streak-7)*15;
  if(streak<=30)return 150+(streak-14)*20;
  return 500+Math.floor((streak-30)*30);
}

function getStreakRewardCollected(date){return ls_get('streak_collected_'+date)||false;}
function setStreakRewardCollected(date){ls_set('streak_collected_'+date,true);}

function updateStreakReward(){
  var streak=calcStreak();
  var today=todayStr();
  var todayData=getDayData(today);
  var hasRecord=todayData.blocks.length>0||todayData.sleepScore!==null;
  var collected=getStreakRewardCollected(today);
  var amount=getStreakRewardAmount(streak);
  var area=document.getElementById('streakRewardArea');
  var btn=document.getElementById('streakRewardBtn');
  var days=document.getElementById('streakRewardDays');
  var desc=document.getElementById('streakRewardDesc');
  if(!area)return;
  days.textContent=streak;
  if(!hasRecord){
    desc.textContent='今日の記録を追加するとボーナスがもらえます';
    btn.textContent='記録なし';btn.disabled=true;btn.style.opacity='0.35';
  } else if(collected){
    desc.textContent='本日分は受取済み（+'+amount+'G）';
    btn.textContent='✓ 済';btn.disabled=true;btn.style.opacity='0.35';
  } else {
    desc.textContent=streak+'日継続で +'+amount+'G がもらえます！';
    btn.textContent='📥 +'+amount+'G';btn.disabled=false;btn.style.opacity='1';
  }
}

function collectStreakReward(){
  var today=todayStr();
  if(getStreakRewardCollected(today)){toast('今日はもう受け取り済みです','err');return;}
  var todayData=getDayData(today);
  if(todayData.blocks.length===0&&todayData.sleepScore===null){toast('まず今日の記録を追加してください','err');return;}
  var streak=calcStreak();
  var amount=getStreakRewardAmount(streak);
  setStreakRewardCollected(today);
  setGold(getGold()+amount);
  setTotalEarned(getTotalEarned()+amount);
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'🔥 +'+amount+'G');
  addEventLog('🔥 '+streak+'日継続ボーナス +'+amount+'G','money');
  toast('🔥 継続ボーナス +'+amount+'G！');
  updateNav();updateStreakReward();
  if(curPage===2){renderEconomy();}
  checkAchievements();
}

function renderHistory(){
  // Show last 30 days including unrecorded days
  var el=document.getElementById('histList');
  var today=todayStr();
  var cats=['仕事','学習','運動','趣味','休憩'];
  var html='';
  for(var i=0;i<30;i++){
    var d=addDays(today,-i);
    var day=getDayData(d);
    var hasData=day.blocks.length>0||day.sleepScore!==null;
    if(hasData){
      var eff=getEffortMins(day.blocks);
      var bars=cats.map(function(c){var m=getCatMins(day.blocks,c),h=Math.min(16,m/60/8*16);return '<div class="hist-bar" style="height:'+h+'px;background:'+CATS[c].color+';width:10px;opacity:'+(h>0?0.8:0.15)+';"></div>';}).join('');
      html+='<div class="hist-item'+(d===currentDate?' cur':'')+'" onclick="jumpDate(\''+d+'\')">'
        +'<div class="hist-date">'+formatShort(d)+'</div>'
        +'<div class="hist-mini">'+bars+'</div>'
        +'<div class="hist-effort">'+m2hm(eff)+'</div>'
        +'<div class="hist-score">'+(day.sleepScore!==null&&day.sleepScore!==undefined?day.sleepScore+'点':'--')+'</div>'
        +'</div>';
    } else if(i>0){
      // Unrecorded past day — gentle white pause display
      html+='<div class="hist-item'+(d===currentDate?' cur':'')+'" onclick="jumpDate(\''+d+'\')" style="opacity:.45;background:rgba(255,255,255,0.015);border-color:rgba(255,255,255,0.04);">'
        +'<div class="hist-date" style="color:rgba(255,255,255,0.25);">'+formatShort(d)+'</div>'
        +'<div class="hist-mini" style="flex:1;"></div>'
        +'<div style="font-size:.62rem;color:rgba(255,255,255,0.2);font-style:italic;">⏸ 一時停止</div>'
        +'</div>';
    }
  }
  if(!html)html='<div style="text-align:center;color:var(--muted);font-size:0.78rem;padding:14px;">まだ記録がありません</div>';
  el.innerHTML=html;
}

function jumpDate(d){currentDate=d;gotoPage(0);renderP1();}

// ================================================================
// PAGE 3: SKILL TREE
// ================================================================

// --- Compute actual hours from all records ---
function getAllCatHours(cat){
  return getAllDates().reduce((s,d)=>s+getCatMins(getDayData(d).blocks,cat),0)/60;
}

function getSkillActualValue(skill){
  const boosts=getSkillBoosts();
  const boostHours=(boosts[skill.id]||0)*2/60; // 1xp = 2 extra minutes
  if(!skill.specialCalc){
    return getAllCatHours(DOMAINS.find(d=>d.skills.find(s=>s.id===skill.id))?.cat||'仕事')+boostHours;
  }
  switch(skill.specialCalc){
    case 'streak': return calcStreak();
    case 'days':   return getAllDates().filter(d=>getDayData(d).blocks.length>0).length;
    case 'sleep': {
      const good=getAllDates().filter(d=>(getDayData(d).sleepScore||0)>=60).length;
      return good+boostHours;
    }
    case 'sleep_deep': {
      const great=getAllDates().filter(d=>(getDayData(d).sleepScore||0)>=70).length;
      return great+boostHours;
    }
    case 'sleep_days': {
      const sl=getAllDates().filter(d=>getDayData(d).sleepTime).length;
      return sl+boostHours;
    }
    case 'alldomain': {
      const domLevels=DOMAINS.map(dom=>getSkillLevel(dom.skills[0]));
      return Math.min(...domLevels);
    }
    default: return 0;
  }
}

function getSkillLevel(skill){
  // Check if this skill is unlocked (previous skill in domain must be maxed)
  if(!isSkillUnlocked(skill)) return 0;
  const val=getSkillActualValue(skill);
  let lv=0;
  for(let i=0;i<skill.thresholds.length;i++) if(val>=skill.thresholds[i]) lv=i;
  return lv;
}

function isSkillUnlocked(skill){
  for(var d=0;d<DOMAINS.length;d++){
    var dom=DOMAINS[d];
    for(var s=0;s<dom.skills.length;s++){
      if(dom.skills[s].id===skill.id){
        if(s===0) return true; // First skill always unlocked
        var prev=dom.skills[s-1];
        var prevVal=getSkillActualValue(prev);
        var prevMaxThreshold=prev.thresholds[prev.thresholds.length-1];
        // Previous skill must reach max threshold to unlock next
        if(prevVal>=prevMaxThreshold) return true;
        // Also check if awakened
        if(getAwakenedSkills().includes(prev.id)) return true;
        return false;
      }
    }
  }
  return true;
}

function getSkillProgress(skill){
  const lv=getSkillLevel(skill);
  const maxLv=skill.thresholds.length-1;
  if(lv>=maxLv) return 1;
  const val=getSkillActualValue(skill);
  const curr=skill.thresholds[lv];
  const next=skill.thresholds[lv+1];
  return Math.min(1,(val-curr)/(next-curr));
}

function getDomainLevel(domain){
  const lvs=domain.skills.map(s=>getSkillLevel(s));
  return Math.floor(lvs.reduce((a,b)=>a+b,0)/lvs.length);
}

function getDomainHours(domain){
  if(domain.cat) return getAllCatHours(domain.cat);
  // balance domain: average of all
  return DOMAINS.filter(d=>d.cat).reduce((s,d)=>s+getAllCatHours(d.cat),0)/5;
}

// --- Render self status ---
function renderSelfStatus(){
  const xp=getTotalXP();
  const lv=getLevel(xp);
  const lvIdx=LEVELS.indexOf(lv);
  const streak=calcStreak();
  const allDates=getAllDates();
  const allEffort=allDates.reduce((s,d)=>s+getEffortMins(getDayData(d).blocks),0);

  document.getElementById('avatarEmoji').textContent=lv.avatar;
  document.getElementById('avatarEmoji').style.fontSize='3rem';
  document.getElementById('avatarLv').textContent='Lv.'+( lvIdx+1);
  document.getElementById('avatarEmoji').style.borderColor=lv.color;
  document.getElementById('avatarEmoji').style.boxShadow=`0 0 30px ${lv.color}55`;
  document.getElementById('selfTitle').textContent=lv.title;
  document.getElementById('selfTitle').style.background=`${lv.color}22`;
  document.getElementById('selfTitle').style.borderColor=`${lv.color}55`;
  document.getElementById('selfTitle').style.color=lv.color;

  document.getElementById('ss_days').textContent=allDates.length;
  document.getElementById('ss_streak').textContent=streak;
  document.getElementById('ss_effort').textContent=m2hm(allEffort);
  document.getElementById('ss_totalxp').textContent=xp;
  const wage=calcWage();
  const el_w=document.getElementById('ss_wage');
  const el_g=document.getElementById('ss_gold');
  if(el_w) el_w.textContent=wage.toLocaleString()+' G/h';
  if(el_g) el_g.textContent=getTotalEarned().toLocaleString();

  // Self bars: each domain
  document.getElementById('selfBars').innerHTML=DOMAINS.map(dom=>{
    const h=getDomainHours(dom);
    const maxH=Math.max(1,...DOMAINS.map(d=>getDomainHours(d)));
    const pct=Math.min(100,h/maxH*100);
    return `<div class="sbar-row">
      <div class="sbar-lbl">${dom.icon}${dom.name}</div>
      <div class="sbar-track"><div class="sbar-fill" style="width:${pct}%;background:${dom.color};"></div></div>
      <div class="sbar-val">${Math.floor(h)}h</div>
    </div>`;
  }).join('');
}

// --- Render domain grid ---
function renderDomains(){
  const el=document.getElementById('domainGrid');
  el.innerHTML=DOMAINS.map(dom=>{
    const lv=getDomainLevel(dom);
    const hours=getDomainHours(dom);
    const maxH=100;
    const pct=Math.min(100,hours/maxH*100);
    const isActive=selectedDomainId===dom.id;
    return `<div class="domain-card ${isActive?'active-domain':''}"
      style="border-color:${isActive?dom.color:''};box-shadow:${isActive?`0 0 20px ${dom.color}30`:''}"
      onclick="selectDomain('${dom.id}')">
      <div class="domain-top">
        <div class="domain-icon">${dom.icon}</div>
        <div>
          <div class="domain-name" style="color:${dom.color}">${dom.name}</div>
          <div class="domain-lv">Lv.${lv} / 4</div>
        </div>
      </div>
      <div class="domain-bar-wrap"><div class="domain-bar" style="width:${pct}%;background:${dom.color}"></div></div>
      <div class="domain-xp-row">
        <span>${dom.desc}</span>
        <span class="domain-xp" style="color:${dom.color}">${Math.floor(hours)}h</span>
      </div>
      <div style="position:absolute;inset:0;border-radius:14px;pointer-events:none;" class="domain-card::after"></div>
    </div>`;
  }).join('');
}

// --- Select domain → show tree ---
function selectDomain(domId){
  selectedDomainId=domId;
  setSTTab('tree');
}

function setSTTab(tab){
  stTab=tab;
  document.getElementById('sttab0').classList.toggle('active',tab==='domains');
  document.getElementById('sttab1').classList.toggle('active',tab==='tree');
  document.getElementById('domainView').style.display=tab==='domains'?'block':'none';
  document.getElementById('treeView').style.display=tab==='tree'?'block':'none';
  if(tab==='domains') renderDomains();
  if(tab==='tree'&&selectedDomainId) renderSkillTree(selectedDomainId);
}

// --- Render SVG skill tree for a domain ---
function renderSkillTree(domId){
  const dom=DOMAINS.find(d=>d.id===domId);
  if(!dom) return;
  document.getElementById('selectedDomainName').textContent=`${dom.icon} ${dom.name} — スキルツリー`;

  const skills=dom.skills;
  const n=skills.length;
  const W=Math.max(500, n*100+60), H=300;
  // Dynamic layout: distribute nodes evenly
  const positions=[];
  const spacing=Math.floor((W-80)/(n-1||1));
  for(let i=0;i<n;i++){
    const row=i%2===0?140:160; // slight zigzag for visual interest
    positions.push({x:40+i*spacing, y:row});
  }

  let svg=`<svg viewBox="0 0 ${W} ${H}" class="skill-tree-svg" style="max-height:280px;">
    <defs>
      <filter id="glow"><feGaussianBlur stdDeviation="3" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>`;

  // Draw connecting lines
  for(let i=0;i<skills.length-1;i++){
    const a=positions[i],b=positions[i+1];
    const lvA=getSkillLevel(skills[i]);
    const unlocked=lvA>0;
    svg+=`<line x1="${a.x+36}" y1="${a.y}" x2="${b.x-36}" y2="${b.y}" stroke="${dom.color}" class="skill-line ${unlocked?'unlocked':''}"/>`;
  }

  // Draw skill nodes
  skills.forEach((skill,i)=>{
    const pos=positions[i];
    const lv=getSkillLevel(skill);
    const prog=getSkillProgress(skill);
    const maxLv=skill.thresholds.length-1;
    const isAwakened=lv>=maxLv&&getAwakenedSkills().includes(skill.id);
    const isSelected=selectedSkillId===skill.id;
    const nodeColor=lv>0?dom.color:'#3a4a6a';
    const r=34;

    // Progress arc
    const circumference=2*Math.PI*r;
    const dash=circumference*prog;
    const gap=circumference-dash;

    svg+=`<g class="skill-node" onclick="selectSkill('${skill.id}','${domId}')" transform="translate(${pos.x},${pos.y})">
      <!-- bg circle -->
      <circle r="${r}" fill="${lv>0?nodeColor+'18':'#1a2640'}" stroke="${isSelected?nodeColor:'#2a3a5a'}" stroke-width="${isSelected?3:1.5}"/>
      <!-- progress arc -->
      <circle r="${r}" fill="none" stroke="${nodeColor}" stroke-width="4" stroke-dasharray="${dash} ${gap}" stroke-linecap="round" transform="rotate(-90)" opacity="${lv>0?0.8:0.3}"/>
      <!-- awakened glow -->
      ${isAwakened?`<circle r="${r+6}" fill="none" stroke="${nodeColor}" stroke-width="1" opacity="0.4" style="animation:pulse 2s infinite;"/>`:''} 
      <!-- icon -->
      <text text-anchor="middle" dominant-baseline="central" font-size="20" y="${lv===0?-6:-8}">${skill.icon}</text>
      <!-- level indicator dots -->
      ${Array.from({length:maxLv},(_,di)=>`<circle cx="${-(maxLv*2)+di*4}" cy="${r-10}" r="2.5" fill="${di<lv?nodeColor:'#2a3a5a'}"/>`).join('')}
      <!-- name -->
      <text class="sn-label" text-anchor="middle" y="${r+16}" fill="${lv>0?'#dce8f8':'#4a6080'}">${skill.name}</text>
      ${isAwakened?`<text text-anchor="middle" y="${r+28}" font-size="9" fill="${nodeColor}" font-family="JetBrains Mono">★覚醒</text>`:`<text class="sn-lv" text-anchor="middle" y="${r+28}" fill="${lv>0?nodeColor:'#3a4a6a'}">Lv.${lv}/${maxLv}</text>`}
    </g>`;
  });

  svg+=`</svg>`;
  document.getElementById('skillTreeSVGWrap').innerHTML=svg;
}

function selectSkill(skillId, domId){
  selectedSkillId=skillId;
  selectedDomainId=domId;
  renderSkillTree(domId);
  renderSkillDetail(skillId, domId);
}

function renderSkillDetail(skillId, domId){
  const dom=DOMAINS.find(d=>d.id===domId);
  const skill=dom?.skills.find(s=>s.id===skillId);
  if(!skill){document.getElementById('skillDetail').innerHTML='<div class="sd-empty">← スキルを選択</div>';return;}
  const lv=getSkillLevel(skill);
  const prog=getSkillProgress(skill);
  const maxLv=skill.thresholds.length-1;
  const val=getSkillActualValue(skill);
  const nextThresh=lv<maxLv?skill.thresholds[lv+1]:null;
  const avail=getAvailXP();
  const boostCost=50; // 50 XP = 2h boost
  const canBoost=avail>=boostCost&&lv<maxLv;
  const isAwakened=getAwakenedSkills().includes(skill.id);

  const nodeColor=lv>0?dom.color:'#64748b';
  const pctNum=Math.round(prog*100);

  document.getElementById('skillDetail').innerHTML=`
    <div class="sd-icon">${skill.icon}${isAwakened?'✨':''}</div>
    <div class="sd-name" style="color:${nodeColor}">${skill.name}</div>
    <div class="sd-desc">${skill.desc}</div>
    <div class="sd-lv-row">
      <span class="sd-lv-label">現在レベル</span>
      <span class="sd-lv-val" style="color:${nodeColor}">Lv.${lv} / ${maxLv} &nbsp; ${pctNum}%</span>
    </div>
    <div class="sd-bar"><div class="sd-bar-fill" style="width:${pctNum}%;background:linear-gradient(90deg,${nodeColor},${nodeColor}aa)"></div></div>
    <div class="sd-effect">
      <div class="sd-effect-title">現在の効果</div>
      <div style="color:${nodeColor}">${skill.effects[lv]}</div>
    </div>
    ${lv<maxLv?`
      <div class="sd-effect" style="margin-bottom:8px;">
        <div class="sd-effect-title">次のレベルへ</div>
        <div style="color:var(--muted2)">あと ${nextThresh?Math.max(0,(nextThresh-val)).toFixed(1):'-'} ${skill.specialCalc?'日/回':'時間'}</div>
        <div style="font-size:0.65rem;color:var(--muted);margin-top:2px;">${skill.effects[lv+1]}</div>
      </div>
      <div style="font-size:.6rem;color:var(--muted);margin-bottom:4px;">⚡ XPで加速（所持: ${avail} XP）</div>
      <div style="display:flex;flex-direction:column;gap:4px;">
        ${[{xp:50,h:2,label:'少し'},{xp:200,h:8,label:'ガッツリ'},{xp:1000,h:40,label:'大量投入'},{xp:5000,h:200,label:'全力ブースト'}].map(t=>{
          var ok=avail>=t.xp&&lv<maxLv;
          return '<button class="sd-upgrade-btn '+(ok?'can':'cant')+'" onclick="'+(ok?"boostSkillAmt('"+skillId+"','"+domId+"',"+t.xp+")":'')+'" style="padding:8px 12px;font-size:.72rem;">'+(ok?'⚡ '+t.label+' ('+t.xp+' XP = +'+t.h+'h換算)':'XP不足 (必要:'+t.xp+')')+'</button>';
        }).join('')}
      </div>
    `:isAwakened?`<div style="text-align:center;padding:12px;background:rgba(74,222,128,0.08);border-radius:10px;border:1px solid rgba(74,222,128,0.3);">
        <div style="font-size:1.2rem;">✨</div>
        <div style="font-weight:800;color:var(--green);font-size:0.85rem;">覚醒済み</div>
        <div style="font-size:0.68rem;color:var(--muted2);margin-top:4px;">${skill.effects[maxLv]}</div>
      </div>`:
      `<div style="text-align:center;padding:10px;">
        <div style="font-weight:800;color:${nodeColor}">最大レベル到達！</div>
        <button class="sd-upgrade-btn can" onclick="awakenSkill('${skillId}','${domId}')" style="margin-top:10px;">
          ✨ 覚醒させる
        </button>
      </div>`}`;
}

function boostSkill(skillId, domId){
  boostSkillAmt(skillId, domId, 50);
}

function boostSkillAmt(skillId, domId, amount){
  if(getAvailXP()<amount){toast('XPが足りません','err');return;}
  const boosts=getSkillBoosts();
  boosts[skillId]=(boosts[skillId]||0)+amount;
  setSkillBoosts(boosts);
  setSpentXP(getSpentXP()+amount);
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'⚡ +'+amount+'XP投資！');
  addEventLog(`⚡ 「${DOMAINS.find(d=>d.id===domId)?.skills.find(s=>s.id===skillId)?.name}」に${amount}XPを投資した`,'levelup');
  renderSkillDetail(skillId,domId);
  renderSkillTree(domId);
  renderSelfStatus();
  updateNav();
  checkAwakenings();
}

function awakenSkill(skillId, domId){
  const skill=DOMAINS.find(d=>d.id===domId)?.skills.find(s=>s.id===skillId);
  if(!skill) return;
  const awakened=getAwakenedSkills();
  if(awakened.includes(skillId)) return;
  awakened.push(skillId);
  setAwakenedSkills(awakened);
  addEventLog(`✨ 「${skill.name}」が覚醒した！${skill.effects[skill.thresholds.length-1]}`,'awakening');
  triggerAwakening(skill);
  renderP3();
}

function checkAwakenings(){
  // Check if any skill newly reached max level
  DOMAINS.forEach(dom=>{
    dom.skills.forEach(skill=>{
      const lv=getSkillLevel(skill);
      const maxLv=skill.thresholds.length-1;
      if(lv>=maxLv&&!getAwakenedSkills().includes(skill.id)){
        // Auto-prompt awakening
        addEventLog(`🔔 「${skill.name}」が覚醒条件を満たした！覚醒ボタンを押そう`,'warning');
      }
    });
  });
}

function triggerAwakening(skill){
  const particles=['⚡','✨','🌟','💎','🔥'];
  document.getElementById('awParticles').textContent=particles[Math.floor(Math.random()*particles.length)];
  document.getElementById('awTitle').textContent=`${skill.name} — 覚醒`;
  document.getElementById('awSub').textContent=`${skill.effects[skill.thresholds.length-1]}\n\nあなたの継続した記録がこのスキルを解放しました。`;
  document.getElementById('awakeningOverlay').classList.add('show');
}
function closeAwakening(){document.getElementById('awakeningOverlay').classList.remove('show');}

// Event log
function addEventLog(text, type='levelup'){
  const log=getEventLog();
  log.unshift({text, type, date:todayStr()});
  setEventLog(log);
  renderEventLog();
}

function renderEventLog(){
  const log=getEventLog();
  const el=document.getElementById('eventLog');
  if(!log.length){
    el.innerHTML='<div style="text-align:center;color:var(--muted);font-size:0.75rem;padding:12px;">記録を始めると物語が動き出します</div>';
    return;
  }
  el.innerHTML=log.slice(0,20).map(e=>`
    <div class="el-item ${e.type}">
      ${e.text}
      <div class="el-date">${formatShort(e.date)}</div>
    </div>`).join('');
}

function renderP3(){
  updateNav();
  renderSelfStatus();
  renderEconomy();
  renderDomains();
  renderEventLog();
  if(stTab==='tree'&&selectedDomainId) renderSkillTree(selectedDomainId);
  if(selectedSkillId&&selectedDomainId) renderSkillDetail(selectedSkillId,selectedDomainId);
  const avail=getAvailXP();
  const el_xp=document.getElementById('gardenXP');
  const el_bar=document.getElementById('gardenXPBar');
  if(el_xp) el_xp.textContent=avail+' XP';
  if(el_bar) el_bar.style.width=Math.min(100,avail/Math.max(100,getTotalXP())*100)+'%';
  // v5 extensions
  updateSleepXPBadge();
  tickPassiveIncome();
  renderInvestments();
  if(curP3Tab==='life')renderLifestyle();
  if(curP3Tab==='ach')renderAchievements();
  renderTownRank();
  setTimeout(()=>checkAchievements(),200);
}

// ================================================================
// REWARD
// ================================================================
function showReward(emoji,title,sub){
  document.getElementById('rewardEmoji').textContent=emoji;
  document.getElementById('rewardTitle').textContent=title;
  document.getElementById('rewardSub').textContent=sub;
  document.getElementById('rewardOverlay').classList.add('show');
}
function closeReward(){document.getElementById('rewardOverlay').classList.remove('show');}

// ================================================================
// TOAST
// ================================================================
function toast(msg,type='ok'){
  const t=document.getElementById('toast');
  document.getElementById('toastIcon').textContent=type==='err'?'⚠':'✓';
  document.getElementById('toastMsg').textContent=msg;
  t.className='toast'+(type==='err'?' err':'')+' on';
  t.style.borderColor=type==='err'?'var(--rose)':'var(--green)';
  clearTimeout(t._t);
  t._t=setTimeout(()=>{t.className='toast'+(type==='err'?' err':'');},2400);
}

// Emit event on block add
function onBlockAdded(cat){
  const prevWage=calcWage();
  const dom=DOMAINS.find(d=>d.cat===cat);
  if(dom){
    setTimeout(()=>{
      dom.skills.forEach(skill=>{
        const lv=getSkillLevel(skill);
        const prevKey='prev_lv_'+skill.id;
        const prevLv=parseInt(ls_get(prevKey)||'0');
        if(lv>prevLv){
          ls_set(prevKey,lv);
          const newWage=calcWage();
          addEventLog(`📈 「${skill.name}」がLv.${lv}に！${skill.effects[lv]}`,'levelup');
          if(newWage>prevWage){
            addEventLog(`💰 時給アップ！ ${prevWage}→${newWage} G/h`,'money');
            showReward(dom.icon,`${dom.name}スキルアップ！`,`「${skill.name}」がLv.${lv}に成長！\n${skill.effects[lv]}\n\n💰 時給が${newWage.toLocaleString()}に上昇！`);
          }
        }
      });
      checkAwakenings();
      checkAchievements();
    },150);
  }
}
// ================================================================
// DAILY QUESTS SYSTEM
// ================================================================
const DEFAULT_QUESTS = [
  {id:'dq_record',name:'とりあえず記録してみる',xp:15},
  {id:'dq_editquest',name:'デイリークエストを編集してみる',xp:10},
];

function getQuests(){return ls_get('daily_quests')||DEFAULT_QUESTS;}
function setQuests(v){ls_set('daily_quests',v);}
function getQuestChecks(date){return ls_get('dq_checks_'+date)||[];}
function setQuestChecks(date,v){ls_set('dq_checks_'+date,v);}

function toggleQuest(qId){
  var checks=getQuestChecks(currentDate);
  var idx=checks.indexOf(qId);
  if(idx>=0){
    checks.splice(idx,1);
    // Remove XP? No, keep it simple - just toggle display
  } else {
    checks.push(qId);
    var q=getQuests().find(function(x){return x.id===qId;});
    if(q){
      addXPRaw(q.xp);
      toast('✅ '+q.name+' +'+q.xp+'XP');
      spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'+'+q.xp+'XP');
    }
  }
  setQuestChecks(currentDate,checks);
  renderDailyQuests();
  updateNav();
}

function renderDailyQuests(){
  var quests=getQuests();
  var checks=getQuestChecks(currentDate);
  var el=document.getElementById('dqList');
  if(!el)return;
  document.getElementById('dqDate').textContent=formatDate(currentDate);
  el.innerHTML=quests.map(function(q){
    var done=checks.includes(q.id);
    return '<div class="dq-item'+(done?' done':'')+'" onclick="'+(done?'':'toggleQuest(\''+q.id+'\')')+'">'+ 
      '<div class="dq-check">'+(done?'✓':'')+'</div>'+
      '<div class="dq-label">'+q.name+'</div>'+
      '<div class="dq-xp">'+(done?'✓':'+')+q.xp+' XP</div>'+
    '</div>';
  }).join('');
  var done=checks.length;
  var total=quests.length;
  document.getElementById('dqProg').textContent=done+'/'+total;
  var pct=total>0?Math.round(done/total*100):0;
  document.getElementById('dqProgBar').style.width=pct+'%';
  // All-clear bonus
  var bonusEl=document.getElementById('dqBonus');
  if(done>=total&&total>0){
    bonusEl.textContent='🎉 全クリア！';
    bonusEl.style.color='var(--amber)';
  } else {
    bonusEl.textContent='あと'+(total-done)+'個';
    bonusEl.style.color='var(--muted2)';
  }
}

function openQuestEditor(){
  document.getElementById('questModal').classList.add('show');
  renderQuestEditor();
}

function renderQuestEditor(){
  var quests=getQuests();
  document.getElementById('questEditorList').innerHTML=quests.map(function(q,i){
    return '<div style="display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--s2);border:1px solid var(--border);border-radius:6px;">'+
      '<span style="flex:1;font-size:.72rem;">'+q.name+'</span>'+
      '<span style="font-size:.62rem;color:var(--green);font-family:JetBrains Mono,monospace;">+'+q.xp+'XP</span>'+
      '<button class="bdel" onclick="removeQuest('+i+')">×</button>'+
    '</div>';
  }).join('');
}

function addQuest(){
  var name=document.getElementById('newQuestName').value.trim();
  var xp=parseInt(document.getElementById('newQuestXP').value)||10;
  if(!name){toast('名前を入力してください','err');return;}
  var quests=getQuests();
  quests.push({id:'dq_'+Date.now(),name:name,xp:xp});
  setQuests(quests);
  document.getElementById('newQuestName').value='';
  renderQuestEditor();
  renderDailyQuests();
  toast('✅ 「'+name+'」を追加しました');
}

function removeQuest(idx){
  var quests=getQuests();
  quests.splice(idx,1);
  setQuests(quests);
  renderQuestEditor();
  renderDailyQuests();
}

// ================================================================
// PERFORMANCE COMPARISON + RANKING
// ================================================================
function renderPerformance(){
  var card=document.getElementById('perfCard');
  if(!card)return;

  var today=currentDate;
  var yesterday=addDays(today,-1);
  var todayData=getDayData(today);
  var ydData=getDayData(yesterday);

  var todayEffort=getEffortMins(todayData.blocks);
  var ydEffort=getEffortMins(ydData.blocks);
  var todaySleep=todayData.sleepScore||0;
  var ydSleep=ydData.sleepScore||0;

  // Only show if there's yesterday data
  if(ydData.blocks.length===0&&!ydData.sleepScore){
    card.style.display='none';
    return;
  }
  card.style.display='block';

  // Effort display
  document.getElementById('perf_effort').textContent=m2hm(todayEffort);
  if(ydEffort>0){
    var eDelta=todayEffort-ydEffort;
    var ePct=Math.round(eDelta/ydEffort*100);
    var eColor=eDelta>0?'var(--green)':eDelta<0?'var(--rose)':'var(--muted)';
    var eArrow=eDelta>0?'▲':eDelta<0?'▼':'→';
    document.getElementById('perf_effort_delta').innerHTML='<span style="color:'+eColor+';">'+eArrow+(eDelta>0?'+':'')+ePct+'% (前日 '+m2hm(ydEffort)+')</span>';
  } else {
    document.getElementById('perf_effort_delta').innerHTML='<span style="color:var(--muted);">前日データなし</span>';
  }

  // Sleep display
  document.getElementById('perf_sleep').textContent=todaySleep?todaySleep+'点':'--';
  if(ydSleep>0&&todaySleep>0){
    var sDelta=todaySleep-ydSleep;
    var sColor=sDelta>0?'var(--green)':sDelta<0?'var(--rose)':'var(--muted)';
    var sArrow=sDelta>0?'▲':sDelta<0?'▼':'→';
    document.getElementById('perf_sleep_delta').innerHTML='<span style="color:'+sColor+';">'+sArrow+(sDelta>0?'+':'')+sDelta+'点 (前日 '+ydSleep+'点)</span>';
  } else {
    document.getElementById('perf_sleep_delta').innerHTML='<span style="color:var(--muted);">'+(todaySleep?'前日スコアなし':'未記録')+'</span>';
  }

  // Performance ranking over past 10 days
  var rankEl=document.getElementById('perfRank');
  // We rank YESTERDAY's performance (completed day)
  if(ydData.blocks.length===0){
    rankEl.innerHTML='';
    return;
  }

  var dates=[];
  for(var i=1;i<=10;i++){
    var d=addDays(today,-i);
    var dd=getDayData(d);
    if(dd.blocks.length>0){
      var eff=getEffortMins(dd.blocks);
      var sl=dd.sleepScore||0;
      // Composite score: effort minutes + sleep score * 3
      var score=eff+sl*3;
      dates.push({date:d,effort:eff,sleep:sl,score:score});
    }
  }

  if(dates.length<2){
    rankEl.innerHTML='<span style="color:var(--muted2);font-size:.65rem;">ランキングには2日以上のデータが必要です</span>';
    return;
  }

  // Sort by score descending
  dates.sort(function(a,b){return b.score-a.score;});
  var ydRank=-1;
  for(var j=0;j<dates.length;j++){
    if(dates[j].date===yesterday){ydRank=j+1;break;}
  }

  if(ydRank<0){
    rankEl.innerHTML='';
    return;
  }

  var total=dates.length;
  var rankColor=ydRank<=1?'var(--amber)':ydRank<=3?'var(--green)':ydRank<=Math.ceil(total/2)?'var(--cyan)':'var(--rose)';
  var msgs=['','🥇 素晴らしい！最高のパフォーマンスでした！','🥈 非常に優秀！トップクラスの1日でした。','🥉 良い調子！この勢いを維持しよう。'];
  var rankMsg='';
  if(ydRank===1) rankMsg=msgs[1];
  else if(ydRank===2) rankMsg=msgs[2];
  else if(ydRank===3) rankMsg=msgs[3];
  else if(ydRank<=Math.ceil(total/2)) rankMsg='👍 平均以上！もう少しで上位に入れます。';
  else rankMsg='🔥 昨日は振るわなかった… 今日こそ巻き返そう！';

  rankEl.innerHTML='昨日のスコアは過去'+total+'日間で<br>'+
    '<span class="perf-rank-num" style="color:'+rankColor+';">'+ydRank+'位</span> / '+total+'日中<br>'+
    '<span style="font-size:.68rem;">'+rankMsg+'</span>';
}

// ================================================================
// INIT
// ================================================================
renderP1();
updateNav();
setTimeout(()=>{
  initStockPrices();
  tickStockPrices();
  migrateOldInvestments();
  initDebt();
  updateDebtUI();
  if(getEventLog().length===0){
    addEventLog('🌱 タイムフローへようこそ！時間を記録してスキルを育て、時給を上げよう','levelup');
    addEventLog('💡 ヒント: スキルLvが上がるたびに時給が少しずつ上がります（+4%/Lv）','money');
  }
  // init prev_lv tracking
  DOMAINS.forEach(d=>d.skills.forEach(s=>{
    if(!ls_get('prev_lv_'+s.id)) ls_set('prev_lv_'+s.id, getSkillLevel(s));
  }));
  checkAwakenings();
  updatePachinkoDisplay();
  renderMysteryCollection();
},500);
// ================================================================
// HELP
// ================================================================
function confirmReset(){executeReset();}
// ===== DATA EXPORT / IMPORT =====
// ===== CLIPBOARD BACKUP =====
function exportClipboard(){
  try{
    var data={};
    for(var i=0;i<localStorage.length;i++){
      var k=localStorage.key(i);
      data[k]=localStorage.getItem(k);
    }
    var exportObj={
      _meta:{app:'TimeFlow',version:'5.0',exportDate:new Date().toISOString(),keyCount:Object.keys(data).length},
      data:data
    };
    var text=JSON.stringify(exportObj);
    if(navigator.clipboard&&navigator.clipboard.writeText){
      navigator.clipboard.writeText(text).then(function(){
        toast('📋 クリップボードにコピーしました！メモアプリやLINEに貼り付けて保存してください');
        var msg=document.getElementById('dataManageMsg');
        if(msg)msg.innerHTML='<span style="color:var(--green);">✅ コピー完了（'+Object.keys(data).length+'項目）— メモアプリ等に貼り付けて保存してください</span>';
      }).catch(function(){
        fallbackCopy(text);
      });
    } else {
      fallbackCopy(text);
    }
  }catch(e){
    toast('❌ コピーに失敗しました','err');
  }
}
function fallbackCopy(text){
  var ta=document.createElement('textarea');
  ta.value=text;
  ta.style.cssText='position:fixed;top:0;left:0;opacity:0;';
  document.body.appendChild(ta);
  ta.focus();ta.select();
  try{document.execCommand('copy');toast('📋 コピーしました！メモアプリ等に貼り付けて保存してください');}
  catch(e){toast('❌ コピーに失敗しました。手動でコピーしてください','err');}
  document.body.removeChild(ta);
}
function showImportPaste(){
  document.getElementById('pasteArea').style.display='block';
  document.getElementById('pasteInput').value='';
  document.getElementById('pasteInput').focus();
}
function importFromPaste(){
  var text=document.getElementById('pasteInput').value.trim();
  if(!text){toast('データを貼り付けてください','err');return;}
  try{
    var parsed=JSON.parse(text);
    if(!parsed.data||!parsed._meta||parsed._meta.app!=='TimeFlow'){
      toast('❌ 無効なバックアップデータです','err');return;
    }
    var keyCount=Object.keys(parsed.data).length;
    var exportDate=parsed._meta.exportDate?parsed._meta.exportDate.slice(0,10):'不明';
    if(!confirm('データを復元しますか？\n\nバックアップ日: '+exportDate+'\n'+keyCount+'項目\n\n現在のデータは上書きされます。'))return;
    localStorage.clear();
    var count=0;
    for(var k in parsed.data){
      if(parsed.data.hasOwnProperty(k)){localStorage.setItem(k,parsed.data[k]);count++;}
    }
    toast('📥 復元しました（'+count+'項目）。再読み込みします…');
    setTimeout(function(){location.reload();},1500);
  }catch(e){
    toast('❌ データの形式が正しくありません','err');
  }
}

function exportData(){
  try{
    var data={};
    var tfKeys=[];
    for(var i=0;i<localStorage.length;i++){
      var k=localStorage.key(i);
      if(k.startsWith('tf_')||k.startsWith('timeflow')||k==='blocks'||k==='skills'||k==='gold'||k==='xp'||k==='totalXP'){
        data[k]=localStorage.getItem(k);
        tfKeys.push(k);
      }
    }
    // Also grab all keys to be safe
    for(var i=0;i<localStorage.length;i++){
      var k=localStorage.key(i);
      if(!data[k]){
        data[k]=localStorage.getItem(k);
      }
    }
    var exportObj={
      _meta:{
        app:'TimeFlow',
        version:'5.0',
        exportDate:new Date().toISOString(),
        keyCount:Object.keys(data).length
      },
      data:data
    };
    var blob=new Blob([JSON.stringify(exportObj,null,2)],{type:'application/json'});
    var url=URL.createObjectURL(blob);
    var a=document.createElement('a');
    var dateStr=new Date().toISOString().slice(0,10);
    a.href=url;
    a.download='timeflow-backup-'+dateStr+'.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    var msg=document.getElementById('dataManageMsg');
    if(msg)msg.innerHTML='<span style="color:var(--green);">✅ バックアップを保存しました（'+dateStr+'）— '+Object.keys(data).length+'項目</span>';
    toast('📤 バックアップを保存しました');
  }catch(e){
    toast('❌ バックアップ保存に失敗しました','err');
    console.error('Export error:',e);
  }
}

function importData(event){
  var file=event.target.files[0];
  if(!file)return;
  // Reset file input so same file can be re-selected
  var fileInput=document.getElementById('importFile');
  
  var reader=new FileReader();
  reader.onload=function(e){
    try{
      var parsed=JSON.parse(e.target.result);
      // Validate structure
      if(!parsed.data||!parsed._meta||parsed._meta.app!=='TimeFlow'){
        toast('❌ 無効なバックアップファイルです','err');
        fileInput.value='';
        return;
      }
      var keyCount=Object.keys(parsed.data).length;
      var exportDate=parsed._meta.exportDate?parsed._meta.exportDate.slice(0,10):'不明';
      
      // Show confirmation
      var msg=document.getElementById('dataManageMsg');
      if(msg){
        msg.innerHTML='<div style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);border-radius:8px;padding:12px;margin-top:6px;">'+
          '<div style="font-size:.78rem;font-weight:700;color:#fbbf24;margin-bottom:6px;">⚠️ データを復元しますか？</div>'+
          '<div style="font-size:.68rem;color:var(--muted);margin-bottom:8px;">バックアップ日: '+exportDate+' / '+keyCount+'項目<br>現在のデータは上書きされます。この操作は取り消せません。</div>'+
          '<div style="display:flex;gap:6px;">'+
          '<button onclick="confirmImport()" style="padding:8px 18px;border:1px solid rgba(56,189,248,.4);border-radius:8px;background:rgba(56,189,248,.15);color:var(--cyan);font-size:.75rem;font-weight:700;cursor:pointer;">復元する</button>'+
          '<button onclick="cancelImport()" style="padding:8px 18px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--muted);font-size:.75rem;font-weight:700;cursor:pointer;">キャンセル</button>'+
          '</div></div>';
      }
      // Store parsed data temporarily
      window._pendingImport=parsed.data;
    }catch(ex){
      toast('❌ ファイルの読み込みに失敗しました','err');
      fileInput.value='';
      console.error('Import parse error:',ex);
    }
  };
  reader.readAsText(file);
}

function confirmImport(){
  if(!window._pendingImport)return;
  try{
    // Clear current localStorage
    localStorage.clear();
    // Restore all keys
    var data=window._pendingImport;
    var count=0;
    for(var k in data){
      if(data.hasOwnProperty(k)){
        localStorage.setItem(k,data[k]);
        count++;
      }
    }
    window._pendingImport=null;
    document.getElementById('importFile').value='';
    toast('📥 データを復元しました（'+count+'項目）。再読み込みします…');
    setTimeout(function(){location.reload();},1500);
  }catch(e){
    toast('❌ 復元に失敗しました','err');
    console.error('Import restore error:',e);
  }
}

function cancelImport(){
  window._pendingImport=null;
  document.getElementById('importFile').value='';
  var msg=document.getElementById('dataManageMsg');
  if(msg)msg.innerHTML='<span style="color:var(--muted);">キャンセルしました</span>';
}

function showResetConfirm(){
  document.getElementById('resetBtn1').style.display='none';
  var el=document.getElementById('resetConfirmArea');
  el.style.display='block';
  el.innerHTML=
    '<div style="background:rgba(239,68,68,.08);border:2px solid rgba(239,68,68,.4);border-radius:12px;padding:16px;">'+
      '<div style="font-size:.85rem;font-weight:800;color:#fb7185;margin-bottom:8px;">⚠️ 本当にリセットしますか？</div>'+
      '<div style="font-size:.68rem;color:var(--muted);line-height:1.6;margin-bottom:12px;">すべての記録・スキル・ゴールド・実績・投資・建物が消えます。<br>この操作は<span style="color:#fb7185;font-weight:700;">取り消せません</span>。</div>'+
      '<div style="display:flex;gap:6px;">'+
        '<button onclick="showResetFinal()" style="flex:1;padding:10px;border:2px solid #ef4444;border-radius:8px;background:rgba(239,68,68,.2);color:#fb7185;font-size:.8rem;font-weight:800;cursor:pointer;">はい、リセットする</button>'+
        '<button onclick="cancelReset()" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--text);font-size:.75rem;cursor:pointer;">キャンセル</button>'+
      '</div>'+
    '</div>';
}
function showResetFinal(){
  var el=document.getElementById('resetConfirmArea');
  el.innerHTML=
    '<div style="background:rgba(239,68,68,.12);border:2px solid #ef4444;border-radius:12px;padding:16px;">'+
      '<div style="font-size:1rem;font-weight:900;color:#ef4444;margin-bottom:8px;text-align:center;">⚠️ 最終確認</div>'+
      '<div style="font-size:.72rem;color:#fb7185;text-align:center;margin-bottom:12px;">下のボタンを押すと全データが削除されます</div>'+
      '<div style="display:flex;gap:6px;">'+
        '<button onclick="executeReset()" style="flex:1;padding:12px;border:none;border-radius:8px;background:#ef4444;color:#fff;font-size:.85rem;font-weight:900;cursor:pointer;">🗑 完全に削除する</button>'+
        '<button onclick="cancelReset()" style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--text);font-size:.75rem;cursor:pointer;">やめる</button>'+
      '</div>'+
    '</div>';
}
function cancelReset(){
  document.getElementById('resetConfirmArea').style.display='none';
  document.getElementById('resetBtn1').style.display='';
}
function executeReset(){
  var keys=[];
  for(var i=0;i<localStorage.length;i++){
    var k=localStorage.key(i);
    if(k&&k.startsWith('tf3_'))keys.push(k);
  }
  keys.forEach(function(k){localStorage.removeItem(k);});
  location.reload();
}

// ================================================================
// REBIRTH (転生) — TIME LEGACY SYSTEM
// ================================================================
function getRebirthCount(){return ls_get('rebirth_count')||0;}
function setRebirthCount(v){ls_set('rebirth_count',v);}
function getRebirthWageMulti(){return 1+getRebirthCount()*0.5;} // 1x, 1.5x, 2x, 2.5x...
function getRebirthXPMulti(){return 1+getRebirthCount()*0.1;} // 1x, 1.1x, 1.2x...
function getRebirthTitles(){
  var titles=[
    {count:1,name:'転生者',icon:'🔄',color:'#60a5fa'},
    {count:2,name:'輪廻の旅人',icon:'🌀',color:'#818cf8'},
    {count:3,name:'時の支配者',icon:'⏳',color:'#a78bfa'},
    {count:5,name:'永劫回帰',icon:'♾️',color:'#c084fc'},
    {count:7,name:'超越者',icon:'🌌',color:'#e879f9'},
    {count:10,name:'神',icon:'👁️',color:'#fcd34d'},
  ];
  var c=getRebirthCount();
  return titles.filter(function(t){return c>=t.count;});
}
function getHighestRebirthTitle(){
  var titles=getRebirthTitles();
  return titles.length>0?titles[titles.length-1]:null;
}

function canRebirth(){
  var hasCastle=getCurrentHousing()>=8;
  var hasEmpire=getBizCount('biz_empire')>=1;
  var dayCount=getAllDates().filter(function(d){return getDayData(d).blocks.length>0;}).length;
  var hasDays=dayCount>=30;
  var allBld=BUILDINGS.every(function(b){return getOwnedBuildings().includes(b.id);});
  var maxHousing=getCurrentHousing()>=HOUSING.length-1;
  var allInt=INTERIOR.filter(function(i){return !i.gachaOnly;}).every(function(i){return getOwnedInterior().includes(i.id);});
  var allRE=REAL_ESTATE.every(function(r){return getRECount(r.id)>=1;});
  var allBiz=BUSINESSES.every(function(b){return getBizCount(b.id)>=1;});
  return hasCastle&&hasEmpire&&hasDays&&allBld&&maxHousing&&allInt&&allRE&&allBiz;
}

function getRebirthConditions(){
  var hasCastle=getCurrentHousing()>=8;
  var hasEmpire=getBizCount('biz_empire')>=1;
  var dayCount=getAllDates().filter(function(d){return getDayData(d).blocks.length>0;}).length;
  var ownedBld=getOwnedBuildings();
  var allBld=BUILDINGS.every(function(b){return ownedBld.includes(b.id);});
  var maxHousing=getCurrentHousing()>=HOUSING.length-1;
  var ownedInt=getOwnedInterior();
  var buyableInt=INTERIOR.filter(function(i){return !i.gachaOnly;});
  var allInt=buyableInt.every(function(i){return ownedInt.includes(i.id);});
  var allRE=REAL_ESTATE.every(function(r){return getRECount(r.id)>=1;});
  var allBiz=BUSINESSES.every(function(b){return getBizCount(b.id)>=1;});
  return [
    {name:'住居を最大レベル（'+HOUSING[HOUSING.length-1].name+'）まで強化',met:maxHousing},
    {name:'全建物を建設（'+ownedBld.length+'/'+BUILDINGS.length+'）',met:allBld},
    {name:'全購入可能インテリア（'+buyableInt.filter(function(i){return ownedInt.includes(i.id);}).length+'/'+buyableInt.length+'）',met:allInt},
    {name:'全不動産を各1件以上保有（'+REAL_ESTATE.filter(function(r){return getRECount(r.id)>=1;}).length+'/'+REAL_ESTATE.length+'）',met:allRE},
    {name:'全事業を各1社以上設立（'+BUSINESSES.filter(function(b){return getBizCount(b.id)>=1;}).length+'/'+BUSINESSES.length+'）',met:allBiz},
    {name:'帝国ホールディングス保有',met:hasEmpire},
    {name:'記録日数30日以上（現在'+dayCount+'日）',met:dayCount>=30},
  ];
}

function doRebirth(){
  if(!canRebirth()){toast('転生条件を満たしていません','err');return;}
  if(!confirm('⏳ 時の遺産 — 転生を行いますか？\n\n引き継ぎ: 株式ポートフォリオ・帝国HD(+投資額)・全記録データ・転生ボーナス\nリセット: ゴールド・スキル・建物・不動産・他事業・住居・インテリア・実績'))return;
  if(!confirm('本当に転生しますか？\n次の周回では時給 ×'+(1+(getRebirthCount()+1)*0.5).toFixed(1)+' でスタートします。'))return;

  // Save persistent data
  var rebirthN=getRebirthCount()+1;
  var portfolio=getPortfolio(); // stocks survive
  var empireHoldings=getBizHoldings().filter(function(h){return h.id==='biz_empire';}); // only empire survives
  var empireInvest=getEmpireInvestment(); // extra investment survives
  var allDayKeys=[];
  for(var i=0;i<localStorage.length;i++){
    var k=localStorage.key(i);
    if(k&&k.startsWith('tf3_d_'))allDayKeys.push(k);
  }
  var dayData={};
  allDayKeys.forEach(function(k){try{dayData[k]=localStorage.getItem(k);}catch{}});
  var mystColl=getMysteryCollection(); // gacha collection too
  var quickTpl=getQuickTemplates();
  var sleepIdeals=getSleepIdeals();
  var quests=ls_get('daily_quests');

  // Wipe everything
  var keys=[];
  for(var i=0;i<localStorage.length;i++){
    var k=localStorage.key(i);
    if(k&&k.startsWith('tf3_'))keys.push(k);
  }
  keys.forEach(function(k){localStorage.removeItem(k);});

  // Restore persistent data
  setRebirthCount(rebirthN);
  setPortfolio(portfolio);
  setBizHoldings(empireHoldings);
  setEmpireInvestment(empireInvest);
  Object.keys(dayData).forEach(function(k){try{localStorage.setItem(k,dayData[k]);}catch{}});
  setMysteryCollection(mystColl);
  setQuickTemplates(quickTpl);
  setSleepIdeals(sleepIdeals);
  if(quests)ls_set('daily_quests',quests);

  // Starting bonus gold based on rebirth count
  var startGold=rebirthN*1000;
  ls_set('gold',startGold);

  addEventLog('⏳ 第'+rebirthN+'回転生！ 時給×'+(1+rebirthN*0.5).toFixed(1)+' で新たな旅が始まる','awakening');

  location.reload();
}

// ================================================================
// EMPIRE HOLDINGS EXTRA INVESTMENT
// ================================================================
function getEmpireInvestment(){return ls_get('empire_invest')||0;}
function setEmpireInvestment(v){ls_set('empire_invest',v);}
function getEmpireDailyBonus(){
  // Each 100,000G invested adds +500G/day, diminishing returns (sqrt scaling)
  var inv=getEmpireInvestment();
  if(inv<=0)return 0;
  return Math.round(500*Math.sqrt(inv/100000));
}

function investInEmpire(){
  if(getBizCount('biz_empire')===0){toast('帝国ホールディングスを設立してください','err');return;}
  var amounts=[100000,500000,1000000];
  var amtStr=prompt('帝国ホールディングスに追加投資\n現在の追加投資額: '+getEmpireInvestment().toLocaleString()+'G\n現在の追加リターン: +'+getEmpireDailyBonus().toLocaleString()+' G/日\n\n投資額を入力（最低10,000G）:','100000');
  if(!amtStr)return;
  var amt=parseInt(amtStr.replace(/,/g,''));
  if(isNaN(amt)||amt<10000){toast('10,000G以上を入力してください','err');return;}
  if(getGold()<amt){toast('ゴールドが足りません','err');return;}
  setGold(getGold()-amt);
  var prev=getEmpireInvestment();
  setEmpireInvestment(prev+amt);
  var newBonus=getEmpireDailyBonus();
  addEventLog('👑 帝国HDに'+amt.toLocaleString()+'G追加投資（累計'+((prev+amt)/1000).toFixed(0)+'K → +'+newBonus.toLocaleString()+' G/日）','money');
  toast('👑 追加投資完了！ リターン +'+newBonus.toLocaleString()+' G/日');
  updateNav();renderEconomy();renderInvestments();
}
function openHelp(){document.getElementById('helpOverlay').classList.add('show');updateIdealDisplay();}

function showEconomySim(){
  // Calculate total cost of everything
  var bldCost=BUILDINGS.reduce(function(s,b){return s+b.cost;},0);
  var housingCost=HOUSING.reduce(function(s,h){return s+h.cost;},0);
  var intCost=INTERIOR.filter(function(i){return !i.gachaOnly;}).reduce(function(s,i){return s+i.cost;},0);
  var stkCost=STOCKS.reduce(function(s,st){return s+st.basePrice;},0); // 1 share each
  var reCost=REAL_ESTATE.reduce(function(s,r){return s+r.cost;},0);
  var bizCost=BUSINESSES.reduce(function(s,b){return s+b.cost;},0);
  var totalCost=bldCost+housingCost+intCost+stkCost+reCost+bizCost;

  // Max wage with max town bonus
  var maxWage=WAGE_TIERS[WAGE_TIERS.length-1].wage;
  var maxTownBonus=TOWN_RANKS[TOWN_RANKS.length-1].wageBonus;
  var effectiveWage=Math.round(maxWage*(1+maxTownBonus));

  var hoursNeeded=Math.ceil(totalCost/effectiveWage);
  var daysAt8h=Math.ceil(hoursNeeded/8);
  var daysAt4h=Math.ceil(hoursNeeded/4);

  var el=document.getElementById('econSimResult');
  el.innerHTML='<div style="color:var(--cyan);font-weight:700;font-size:.78rem;margin-bottom:6px;">📊 全コンテンツ完了シミュレーション</div>'+
    '<div style="border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:6px;">'+
    '🏗️ 建物全種: <span style="color:#4ade80;">'+bldCost.toLocaleString()+' G</span><br>'+
    '🏠 住居全段階: <span style="color:#4ade80;">'+housingCost.toLocaleString()+' G</span><br>'+
    '🪑 インテリア(購入可能): <span style="color:#4ade80;">'+intCost.toLocaleString()+' G</span><br>'+
    '📊 株式(各1口): <span style="color:#4ade80;">'+stkCost.toLocaleString()+' G</span><br>'+
    '🏢 不動産全種: <span style="color:#4ade80;">'+reCost.toLocaleString()+' G</span><br>'+
    '🏭 事業全種: <span style="color:#4ade80;">'+bizCost.toLocaleString()+' G</span><br>'+
    '</div>'+
    '<div style="font-size:.82rem;font-weight:800;color:#fbbf24;margin-bottom:4px;">💎 総額: '+totalCost.toLocaleString()+' G</div>'+
    '<div style="border-top:1px solid var(--border);padding-top:6px;margin-top:6px;">'+
    '⚡ 最高時給: '+effectiveWage.toLocaleString()+' G/h <span style="color:var(--muted);">('+maxWage+' × '+(1+maxTownBonus)+')</span><br>'+
    '⏱️ 必要時間: <span style="color:var(--cyan);font-weight:700;">'+hoursNeeded.toLocaleString()+'時間</span><br>'+
    '📅 8h/日換金: <span style="color:var(--amber);font-weight:700;">約'+daysAt8h.toLocaleString()+'日</span> ('+Math.round(daysAt8h/30)+'ヶ月)<br>'+
    '📅 4h/日換金: <span style="color:var(--rose);font-weight:700;">約'+daysAt4h.toLocaleString()+'日</span> ('+Math.round(daysAt4h/30)+'ヶ月)<br>'+
    '</div>'+
    '<div style="font-size:.58rem;color:var(--muted);margin-top:6px;">※ ガチャ費用・生活コスト・不労所得は含まず</div>';
}
function closeHelp(){document.getElementById('helpOverlay').classList.remove('show');}

// ================================================================
// PAGE 3 SUB-TABS
// ================================================================
function setP3Tab(tab){
  curP3Tab=tab;
  ['skills','invest','life','town','slot','ach'].forEach(t=>{
    const btn=document.getElementById('p3t_'+t);
    const panel=document.getElementById('panel_'+t);
    if(btn)btn.classList.toggle('active',t===tab);
    if(panel)panel.classList.toggle('active',t===tab);
  });
  if(tab==='invest')renderInvestments();
  if(tab==='life')renderLifestyle();
  if(tab==='town'){renderTownVis();renderBldShop();renderTownRank();}
  if(tab==='ach')renderAchievements();
  updateDebtUI();
}

function updateDebtUI(){
  var locked=hasDebtSystem()&&!isDebtPaid();
  // Locked panels get overlay
  ['invest','town'].forEach(function(id){
    var panel=document.getElementById('panel_'+id);
    if(!panel)return;
    var overlay=panel.querySelector('.debt-lock-overlay');
    if(locked){
      panel.style.position='relative';
      if(!overlay){
        overlay=document.createElement('div');
        overlay.className='debt-lock-overlay';
        overlay.innerHTML='<div style="background:rgba(0,0,0,0.7);border:1px solid rgba(251,191,36,.3);border-radius:12px;padding:16px 24px;text-align:center;backdrop-filter:blur(2px);">'+
          '<div style="font-size:1.5rem;margin-bottom:6px;">🔒</div>'+
          '<div style="font-size:.8rem;font-weight:700;color:#fbbf24;">ローンを返済すると解禁</div>'+
          '<div style="font-size:.65rem;color:var(--muted);margin-top:4px;">残り: <span id="debtLockAmt_'+id+'">0</span>G</div>'+
        '</div>';
        panel.appendChild(overlay);
      }
      var amtEl=document.getElementById('debtLockAmt_'+id);
      if(amtEl)amtEl.textContent=getDebt().toLocaleString();
    } else {
      if(overlay)overlay.remove();
    }
  });
  // Tab buttons subtle lock icon
  var investBtn=document.getElementById('p3t_invest');
  var townBtn=document.getElementById('p3t_town');
  if(investBtn)investBtn.style.opacity=locked?'0.6':'1';
  if(townBtn)townBtn.style.opacity=locked?'0.6':'1';
}

// ================================================================
// SLEEP XP MODIFIER
// ================================================================
function getSleepXPMultiplier(){
  const today=todayStr();
  const dd=getDayData(today);
  const score=dd.sleepScore;
  if(score===null||score===undefined)return 1.0;
  if(score>=90)return 1.5;
  if(score>=75)return 1.25;
  if(score>=60)return 1.0;
  if(score>=40)return 0.8;
  return 0.6;
}

function updateSleepXPBadge(){
  const mult=getSleepXPMultiplier();
  const el=document.getElementById('sleepXPBadge');
  if(!el)return;
  el.textContent='×'+mult.toFixed(2);
  const cls='sleep-xp-badge ';
  if(mult>=1.5)el.className=cls+'excellent';
  else if(mult>=1.25)el.className=cls+'good';
  else if(mult>=1.0)el.className=cls+'normal';
  else if(mult>=0.8)el.className=cls+'poor';
  else el.className=cls+'bad';
}

// Override addXP to apply sleep multiplier
const _origAddXP = addXP;
addXP = function(amount, blockEl){
  const mult = getSleepXPMultiplier();
  const adjusted = Math.round(amount * mult);
  _origAddXP(adjusted, blockEl);
  if(mult!==1.0 && blockEl){
    const tag = mult>1 ? '😊' : '😴';
    toast(tag+' 睡眠倍率 ×'+mult.toFixed(2)+' → '+adjusted+' XP');
  }
};

// ================================================================
// INVESTMENT SYSTEM
// ================================================================
const STOCKS = [
  {id:'stk_idx',name:'S&P500インデックス',icon:'📊',desc:'米国大型株500社に連動。長期投資の王道。',basePrice:5000,volatility:0.015,drift:0.0003,risk:'低',req:null},
  {id:'stk_topix',name:'TOPIXファンド',icon:'🗾',desc:'東証上場銘柄に広く分散。国内経済と連動。',basePrice:3000,volatility:0.012,drift:0.0002,risk:'低',req:null},
  {id:'stk_nasdaq',name:'NASDAQ100',icon:'💻',desc:'ハイテク大型株に集中。成長期待大。',basePrice:8000,volatility:0.025,drift:0.0005,risk:'中',req:{skill:'strategy',lv:2}},
  {id:'stk_emerging',name:'新興国株ファンド',icon:'🌍',desc:'BRICSなど新興国に投資。高成長・高リスク。',basePrice:4000,volatility:0.03,drift:0.0002,risk:'中',req:{skill:'strategy',lv:2}},
  {id:'stk_reit',name:'グローバルREIT',icon:'🏗️',desc:'世界の不動産投資信託。配当利回り高め。',basePrice:6000,volatility:0.018,drift:0.0003,risk:'中',req:{skill:'depth',lv:2}},
  {id:'stk_crypto',name:'暗号資産ファンド',icon:'₿',desc:'BTC/ETH中心。ハイリスク・ハイリターン。',basePrice:10000,volatility:0.06,drift:0.0004,risk:'高',req:{skill:'depth',lv:2}},
  {id:'stk_leverage',name:'レバレッジNASDAQ(3倍)',icon:'⚡',desc:'NASDAQ100の3倍値動き。暴落リスク極大。',basePrice:12000,volatility:0.075,drift:0.0006,risk:'極高',req:{skill:'strategy',lv:3}},
  {id:'stk_venture',name:'ベンチャーキャピタル',icon:'🚀',desc:'未上場企業に出資。大化けか紙切れか。',basePrice:25000,volatility:0.16,drift:0.0003,risk:'極高',req:{skill:'strategy',lv:3}},
];

const REAL_ESTATE = [
  {id:'re_apt',name:'ワンルームアパート',icon:'🏠',desc:'築古1R。利回り高めだが減価も速い。',cost:5000,monthlyRent:250,depRate:0.003,req:null},
  {id:'re_mansion',name:'マンション1室',icon:'🏢',desc:'都心の1LDK。安定した家賃収入。',cost:15000,monthlyRent:650,depRate:0.002,req:{skill:'output',lv:2}},
  {id:'re_family',name:'ファミリーマンション',icon:'🏘️',desc:'3LDK。ファミリー向けで空室率低め。',cost:30000,monthlyRent:1100,depRate:0.0018,req:{skill:'output',lv:2}},
  {id:'re_bldg',name:'テナントビル',icon:'🏬',desc:'テナント数社が入る商業ビル。',cost:60000,monthlyRent:2500,depRate:0.0015,req:{skill:'strategy',lv:3}},
  {id:'re_office',name:'オフィスビル',icon:'🏙️',desc:'都心一等地のオフィス。法人契約で安定。',cost:120000,monthlyRent:4500,depRate:0.0012,req:{skill:'strategy',lv:3}},
  {id:'re_tower',name:'タワーマンション',icon:'🗼',desc:'超高層マンション。ブランド力で値崩れしにくい。',cost:250000,monthlyRent:8000,depRate:0.001,req:{skill:'output',lv:4}},
  {id:'re_resort',name:'リゾートホテル',icon:'🏝️',desc:'観光地の高級ホテル経営。季節変動あり。',cost:500000,monthlyRent:15000,depRate:0.0008,req:{skill:'strategy',lv:4}},
];

const BUSINESSES = [
  {id:'biz_stall',name:'屋台',icon:'🍢',desc:'小さな屋台で商売開始。',cost:1500,daily:15,staff:1,req:null},
  {id:'biz_cafe',name:'カフェ経営',icon:'☕',desc:'おしゃれなカフェを開業。',cost:5000,daily:40,staff:5,req:null},
  {id:'biz_shop',name:'オンラインショップ',icon:'🛒',desc:'ECサイトを運営。少人数で高効率。',cost:12000,daily:100,staff:8,req:{skill:'output',lv:2}},
  {id:'biz_restaurant',name:'レストランチェーン',icon:'🍽️',desc:'3店舗展開のレストラン。',cost:25000,daily:200,staff:30,req:{skill:'connect',lv:2}},
  {id:'biz_consul',name:'コンサルティングファーム',icon:'👔',desc:'経営コンサル。専門知識が武器。',cost:40000,daily:350,staff:50,req:{skill:'connect',lv:3}},
  {id:'biz_factory',name:'製造工場',icon:'🏭',desc:'自社製品を量産。',cost:60000,daily:500,staff:150,req:{skill:'output',lv:3}},
  {id:'biz_hospital',name:'医療法人',icon:'🏥',desc:'病院グループを経営。',cost:100000,daily:800,staff:300,req:{skill:'depth',lv:3}},
  {id:'biz_tech',name:'テック企業',icon:'🖥️',desc:'SaaS事業を展開。IPO視野。',cost:150000,daily:1200,staff:500,req:{skill:'strategy',lv:4}},
  {id:'biz_bank',name:'投資銀行',icon:'🏦',desc:'M&A・資金調達の巨人。',cost:300000,daily:2500,staff:2000,req:{skill:'strategy',lv:4}},
  {id:'biz_conglomerate',name:'総合商社',icon:'🌐',desc:'資源からITまで。世界を動かす。',cost:600000,daily:4000,staff:8000,req:{skill:'self_design',lv:3}},
  {id:'biz_empire',name:'帝国ホールディングス',icon:'👑',desc:'全産業を統括する財閥。従業員3万人超。',cost:1500000,daily:12000,staff:30000,req:{skill:'self_design',lv:4}},
];

const LIFESTYLES = [
  {id:'lf_gym',name:'ジム会員',icon:'🏋️',desc:'毎日のワークアウト環境',costPerDay:5,xpBonus:0.05,req:null},
  {id:'lf_coffee',name:'高級コーヒー定期便',icon:'☕',desc:'集中力を高める一杯',costPerDay:10,xpBonus:0.05,req:null},
  {id:'lf_office',name:'コワーキングスペース',icon:'💼',desc:'最適な作業環境',costPerDay:30,xpBonus:0.1,req:{skill:'focus',lv:2}},
  {id:'lf_coach',name:'パーソナルコーチ',icon:'🧑‍🏫',desc:'専門家の指導でXP大幅UP',costPerDay:100,xpBonus:0.2,req:{skill:'self_design',lv:2}},
];

function getOwnedInvestments(){return ls_get('owned_inv')||[];}
function setOwnedInvestments(v){ls_set('owned_inv',v);}
function getActiveLifestyles(){return ls_get('active_ls')||[];}
function setActiveLifestyles(v){ls_set('active_ls',v);}
function getLastCollectDate(){return ls_get('last_collect')||null;}
function setLastCollectDate(v){ls_set('last_collect',v);}
function getPendingPassive(){return ls_get('pending_passive')||0;}
function setPendingPassive(v){ls_set('pending_passive',v);}

function checkSkillReq(req){
  if(!req)return true;
  const skill=null;
  for(const dom of DOMAINS){
    const s=dom.skills.find(sk=>sk.id===req.skill);
    if(s)return getSkillLevel(s)>=req.lv;
  }
  return false;
}

function getSkillNameById(id){
  for(const dom of DOMAINS)for(const s of dom.skills)if(s.id===id)return s.name;
  return id;
}

// ============================================================
// STOCK PRICE SIMULATION (geometric Brownian motion)
// ============================================================
function getStockPrices(){return ls_get('stock_prices')||{};}
function setStockPrices(v){ls_set('stock_prices',v);}
function getStockLastUpdate(){return ls_get('stock_price_date')||null;}
function setStockLastUpdate(v){ls_set('stock_price_date',v);}

function initStockPrices(){
  var prices=getStockPrices();
  var changed=false;
  STOCKS.forEach(function(s){
    if(!prices[s.id]){prices[s.id]=s.basePrice;changed=true;}
  });
  if(changed)setStockPrices(prices);
  if(!getStockLastUpdate())setStockLastUpdate(todayStr());
}

function simulateStockDay(prices){
  var newP={};
  STOCKS.forEach(function(s){
    var p=prices[s.id]||s.basePrice;
    // GBM: dS = mu*S*dt + sigma*S*dW
    var z=(Math.random()+Math.random()+Math.random()+Math.random()+Math.random()+Math.random()-3)/1.73; // approx normal
    var ret=s.drift+s.volatility*z;
    var np=Math.max(Math.round(p*(1+ret)),Math.round(s.basePrice*0.05)); // floor at 5% of base
    newP[s.id]=np;
  });
  return newP;
}

function tickStockPrices(){
  var last=getStockLastUpdate();
  if(!last){setStockLastUpdate(todayStr());return;}
  var today=todayStr();
  if(last===today)return;
  var d1=parseDate(last),d2=parseDate(today);
  var days=Math.max(1,Math.min(30,Math.round((d2-d1)/(1000*60*60*24))));
  var prices=getStockPrices();
  for(var i=0;i<days;i++){prices=simulateStockDay(prices);}
  setStockPrices(prices);
  setStockLastUpdate(today);
}

// ============================================================
// STOCK PORTFOLIO: [{id, buyPrice, quantity}]
// ============================================================
function getPortfolio(){return ls_get('stock_portfolio')||[];}
function setPortfolio(v){ls_set('stock_portfolio',v);}

function getPortfolioCount(stkId){
  return getPortfolio().filter(function(p){return p.id===stkId;}).reduce(function(s,p){return s+p.quantity;},0);
}

// ============================================================
// REAL ESTATE HOLDINGS: [{id, buyPrice, buyDate}]
// ============================================================
function getREHoldings(){return ls_get('re_holdings')||[];}
function setREHoldings(v){ls_set('re_holdings',v);}
function getRECount(reId){return getREHoldings().filter(function(h){return h.id===reId;}).length;}
function getLastRentDate(){return ls_get('last_rent_date')||null;}
function setLastRentDate(v){ls_set('last_rent_date',v);}

function calcREValue(holding){
  var item=REAL_ESTATE.find(function(x){return x.id===holding.id;});
  if(!item)return 0;
  var buyD=parseDate(holding.buyDate||todayStr());
  var now=parseDate(todayStr());
  var days=Math.max(0,Math.round((now-buyD)/(1000*60*60*24)));
  // depreciation: value * (1 - depRate)^days
  var val=Math.round(holding.buyPrice*Math.pow(1-item.depRate,days));
  return Math.max(Math.round(item.cost*0.1),val); // floor at 10% of original cost
}

// ============================================================
// BUSINESS: track owned + staff check against town pop
// ============================================================
function getBizHoldings(){return ls_get('biz_holdings')||[];}
function setBizHoldings(v){ls_set('biz_holdings',v);}
function getBizCount(bizId){return getBizHoldings().filter(function(h){return h.id===bizId;}).length;}
function getTotalStaffUsed(){
  return getBizHoldings().reduce(function(s,h){
    var b=BUSINESSES.find(function(x){return x.id===h.id;});
    return s+(b?b.staff:0);
  },0);
}
function getAvailableStaff(){return Math.max(0,getTownPop()-getTotalStaffUsed());}

// ============================================================
// BUY / SELL functions
// ============================================================
function buyStock(id){
  var stk=STOCKS.find(function(x){return x.id===id;});
  if(!stk)return;
  if(!checkSkillReq(stk.req)){toast('スキル要件を満たしていません','err');return;}
  var prices=getStockPrices();
  var price=prices[id]||stk.basePrice;
  var fee=Math.round(price*0.01); // 1% purchase fee
  var totalCost=price+fee;
  if(getGold()<totalCost){toast('ゴールドが足りません（必要: '+totalCost.toLocaleString()+'G = 価格'+price.toLocaleString()+'G + 手数料'+fee.toLocaleString()+'G）','err');return;}
  setGold(getGold()-totalCost);
  var pf=getPortfolio();
  pf.push({id:id,buyPrice:price,quantity:1});
  setPortfolio(pf);
  var total=getPortfolioCount(id);
  addEventLog('📈 「'+stk.name+'」を'+price.toLocaleString()+'Gで購入（手数料'+fee.toLocaleString()+'G）計'+total+'口','money');
  toast('📈 '+stk.name+' を購入！（手数料1%: '+fee.toLocaleString()+'G）');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'📈 購入！');
  updateNav();renderInvestments();renderEconomy();
}

function sellStock(id){
  var stk=STOCKS.find(function(x){return x.id===id;});
  if(!stk)return;
  var pf=getPortfolio();
  var idx=-1;
  for(var i=0;i<pf.length;i++){if(pf[i].id===id){idx=i;break;}}
  if(idx<0){toast('保有していません','err');return;}
  var prices=getStockPrices();
  var price=prices[id]||stk.basePrice;
  var buyP=pf[idx].buyPrice;
  var pnl=price-buyP;
  pf.splice(idx,1);
  setPortfolio(pf);
  setGold(getGold()+price);
  setTotalEarned(getTotalEarned()+Math.max(0,price));
  var pnlStr=pnl>=0?'+'+pnl.toLocaleString():pnl.toLocaleString();
  addEventLog('💰 「'+stk.name+'」を'+price.toLocaleString()+'Gで売却 (損益:'+pnlStr+'G)','money');
  toast('💰 '+stk.name+' 売却！ 損益: '+pnlStr+'G');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'💰 '+pnlStr+'G');
  updateNav();renderInvestments();renderEconomy();
}

function buyRE(id){
  var item=REAL_ESTATE.find(function(x){return x.id===id;});
  if(!item)return;
  if(!checkSkillReq(item.req)){toast('スキル要件を満たしていません','err');return;}
  if(getGold()<item.cost){toast('ゴールドが足りません（必要: '+item.cost.toLocaleString()+'G）','err');return;}
  setGold(getGold()-item.cost);
  var h=getREHoldings();
  h.push({id:id,buyPrice:item.cost,buyDate:todayStr()});
  setREHoldings(h);
  addEventLog('🏠 「'+item.name+'」を'+item.cost.toLocaleString()+'Gで購入','money');
  toast('🏠 '+item.name+' を購入！');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'🏠 購入！');
  updateNav();renderInvestments();renderEconomy();
}

function sellRE(id){
  var h=getREHoldings();
  var idx=-1;
  for(var i=0;i<h.length;i++){if(h[i].id===id){idx=i;break;}}
  if(idx<0){toast('保有していません','err');return;}
  var item=REAL_ESTATE.find(function(x){return x.id===id;});
  var salePrice=calcREValue(h[idx]);
  var buyP=h[idx].buyPrice;
  var pnl=salePrice-buyP;
  h.splice(idx,1);
  setREHoldings(h);
  setGold(getGold()+salePrice);
  setTotalEarned(getTotalEarned()+Math.max(0,salePrice));
  var pnlStr=pnl>=0?'+'+pnl.toLocaleString():pnl.toLocaleString();
  addEventLog('🏠 「'+item.name+'」を'+salePrice.toLocaleString()+'Gで売却 (損益:'+pnlStr+'G)','money');
  toast('🏠 '+item.name+' 売却！ 売却額: '+salePrice.toLocaleString()+'G (損益:'+pnlStr+'G)');
  updateNav();renderInvestments();renderEconomy();
}

function buyBiz(id){
  var biz=BUSINESSES.find(function(x){return x.id===id;});
  if(!biz)return;
  if(!checkSkillReq(biz.req)){toast('スキル要件を満たしていません','err');return;}
  if(getGold()<biz.cost){toast('ゴールドが足りません（必要: '+biz.cost.toLocaleString()+'G）','err');return;}
  var avail=getAvailableStaff();
  if(biz.staff>avail){toast('従業員が足りません（必要: '+biz.staff.toLocaleString()+'人 / 空き: '+avail.toLocaleString()+'人）\n街の人口を増やしましょう！','err');return;}
  setGold(getGold()-biz.cost);
  var h=getBizHoldings();
  h.push({id:id,buyDate:todayStr()});
  setBizHoldings(h);
  addEventLog('🏢 「'+biz.name+'」を設立！ 従業員'+biz.staff.toLocaleString()+'人雇用','money');
  toast('🏢 '+biz.name+' を設立！');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'🏢 設立！');
  updateNav();renderInvestments();renderEconomy();
}

// Legacy migration: convert old owned_inv to new system
function migrateOldInvestments(){
  var old=ls_get('owned_inv');
  if(!old||old.length===0)return;
  var pf=getPortfolio();
  var reh=getREHoldings();
  var bizh=getBizHoldings();
  old.forEach(function(id){
    if(STOCKS.find(function(s){return s.id===id;})){
      var s=STOCKS.find(function(s){return s.id===id;});
      pf.push({id:id,buyPrice:s.basePrice,quantity:1});
    } else if(REAL_ESTATE.find(function(r){return r.id===id;})){
      var r=REAL_ESTATE.find(function(r){return r.id===id;});
      reh.push({id:id,buyPrice:r.cost,buyDate:todayStr()});
    } else if(BUSINESSES.find(function(b){return b.id===id;})){
      bizh.push({id:id,buyDate:todayStr()});
    }
  });
  setPortfolio(pf);setREHoldings(reh);setBizHoldings(bizh);
  ls_set('owned_inv',[]); // clear old
}

function toggleLifestyle(id){
  const item=LIFESTYLES.find(x=>x.id===id);
  if(!item)return;
  if(!checkSkillReq(item.req)){toast('スキル要件を満たしていません','err');return;}
  const active=getActiveLifestyles();
  const idx=active.indexOf(id);
  if(idx>=0){
    active.splice(idx,1);
    setActiveLifestyles(active);
    toast('🛋️ '+item.name+' を解約しました');
  } else {
    active.push(id);
    setActiveLifestyles(active);
    toast('🛋️ '+item.name+' を契約しました！ (XP +'+Math.round(item.xpBonus*100)+'%)');
  }
  renderInvestments();
}

function calcDailyPassive(){
  let total=0;
  // Business income (daily)
  getBizHoldings().forEach(function(h){
    var biz=BUSINESSES.find(function(x){return x.id===h.id;});
    if(biz)total+=biz.daily;
  });
  // Empire extra investment bonus
  total+=getEmpireDailyBonus();
  // Lifestyle costs
  const active=getActiveLifestyles();
  LIFESTYLES.forEach(ls=>{if(active.includes(ls.id))total-=ls.costPerDay;});
  return total;
}

// Monthly rent collection for real estate
function collectRent(){
  var holdings=getREHoldings();
  if(holdings.length===0){toast('不動産を保有していません','err');return;}
  var last=getLastRentDate();
  var today=todayStr();
  if(last){
    var d1=parseDate(last),d2=parseDate(today);
    var daysSince=Math.round((d2-d1)/(1000*60*60*24));
    if(daysSince<30){toast('家賃は月1回です（あと'+(30-daysSince)+'日）','err');return;}
  }
  var totalRent=0;
  holdings.forEach(function(h){
    var item=REAL_ESTATE.find(function(x){return x.id===h.id;});
    if(item)totalRent+=item.monthlyRent;
  });
  setGold(getGold()+totalRent);
  setTotalEarned(getTotalEarned()+totalRent);
  setLastRentDate(today);
  addEventLog('🏠 家賃収入 '+totalRent.toLocaleString()+' G を受け取った','money');
  toast('🏠 家賃収入 +'+totalRent.toLocaleString()+' G！');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'🏠 +'+totalRent.toLocaleString()+'G');
  updateNav();renderEconomy();renderInvestments();
}

function getLifestyleXPBonus(){
  const active=getActiveLifestyles();
  let bonus=0;
  LIFESTYLES.forEach(ls=>{if(active.includes(ls.id))bonus+=ls.xpBonus;});
  return bonus;
}

function collectPassive(){
  const pending=getPendingPassive();
  if(pending<=0){toast('受け取る不労所得がありません','err');return;}
  setGold(getGold()+Math.max(0,pending));
  setTotalEarned(getTotalEarned()+Math.max(0,pending));
  setPendingPassive(0);
  setLastCollectDate(todayStr());
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'📥 +'+pending.toLocaleString()+' G');
  addEventLog('📥 不労所得 '+pending.toLocaleString()+' G を受け取った','money');
  toast('📥 '+pending.toLocaleString()+' G 受け取りました！');
  updateNav();
  renderEconomy();
}

// Daily passive income accumulation
function tickPassiveIncome(){
  const lastCollect=getLastCollectDate();
  if(!lastCollect)return;
  const today=todayStr();
  if(lastCollect===today)return;
  const d1=parseDate(lastCollect);
  const d2=parseDate(today);
  const daysDiff=Math.max(1,Math.round((d2-d1)/(1000*60*60*24)));
  let totalPassive=0;
  for(let i=0;i<daysDiff;i++){
    totalPassive+=calcDailyPassive();
  }
  setPendingPassive(getPendingPassive()+totalPassive);
  // Also tick stock prices
  tickStockPrices();
}

function renderInvestments(){
  var gold=getGold();
  var prices=getStockPrices();
  var active=getActiveLifestyles();
  var availStaff=getAvailableStaff();
  var totalStaffUsed=getTotalStaffUsed();
  var townPop=getTownPop();

  // === STOCKS ===
  var sGrid=document.getElementById('stockGrid');
  if(sGrid){
    sGrid.innerHTML=STOCKS.map(function(stk){
      var price=prices[stk.id]||stk.basePrice;
      var count=getPortfolioCount(stk.id);
      var meetsReq=checkSkillReq(stk.req);
      var canBuy=meetsReq&&gold>=price;
      var reqText=stk.req&&!meetsReq?'🔒 '+getSkillNameById(stk.req.skill)+' Lv.'+stk.req.lv+' 必要':'';
      // calc avg buy price & PnL
      var holdings=getPortfolio().filter(function(p){return p.id===stk.id;});
      var avgBuy=count>0?Math.round(holdings.reduce(function(s,p){return s+p.buyPrice;},0)/count):0;
      var totalVal=price*count;
      var totalCost=holdings.reduce(function(s,p){return s+p.buyPrice;},0);
      var pnl=totalVal-totalCost;
      var pnlPct=totalCost>0?((pnl/totalCost)*100).toFixed(1):'0';
      var pnlColor=pnl>=0?'var(--green)':'var(--rose)';
      var priceChange=price-stk.basePrice;
      var changePct=((price/stk.basePrice-1)*100).toFixed(1);
      var changeColor=priceChange>=0?'var(--green)':'var(--rose)';

      var badge=count>0?'<div style="position:absolute;top:6px;right:8px;background:rgba(56,189,248,.15);border:1px solid rgba(56,189,248,.3);color:var(--cyan);font-size:.6rem;padding:1px 6px;border-radius:8px;font-family:JetBrains Mono,monospace;">×'+count+'</div>':'';

      return '<div class="inv-card'+(meetsReq?'':' locked')+'" style="position:relative;">'+badge+
        '<div class="inv-icon">'+stk.icon+'</div>'+
        '<div class="inv-name">'+stk.name+'</div>'+
        '<div class="inv-desc">'+stk.desc+'</div>'+
        '<div style="font-family:JetBrains Mono,monospace;font-size:.75rem;margin:4px 0;">'+
          '現在値: <span style="color:'+changeColor+';">'+price.toLocaleString()+' G</span>'+
          ' <span style="font-size:.6rem;color:'+changeColor+';">('+changePct+'%)</span>'+
        '</div>'+
        '<div style="font-size:.6rem;color:var(--muted2);">ボラティリティ: '+(stk.volatility*100).toFixed(1)+'% | リスク: '+stk.risk+'</div>'+
        (count>0?'<div style="margin-top:4px;padding:4px 6px;background:rgba(255,255,255,.03);border-radius:6px;font-size:.62rem;">'+
          '平均取得: '+avgBuy.toLocaleString()+'G | 評価額: '+totalVal.toLocaleString()+'G<br>'+
          '<span style="color:'+pnlColor+';font-weight:700;">損益: '+(pnl>=0?'+':'')+pnl.toLocaleString()+'G ('+pnlPct+'%)</span>'+
        '</div>':'')+
        '<div style="display:flex;gap:4px;margin-top:6px;">'+
          (canBuy?'<button onclick="event.stopPropagation();buyStock(\''+stk.id+'\')" style="flex:1;padding:5px;border:none;border-radius:6px;background:linear-gradient(135deg,#38bdf8,#818cf8);color:#fff;font-size:.7rem;font-weight:700;cursor:pointer;">購入 '+(price+Math.round(price*0.01)).toLocaleString()+'G</button>':
          '<button disabled style="flex:1;padding:5px;border:none;border-radius:6px;background:var(--s2);color:var(--muted);font-size:.7rem;cursor:not-allowed;">'+(meetsReq?price.toLocaleString()+'G':'🔒')+'</button>')+
          (count>0?'<button onclick="event.stopPropagation();sellStock(\''+stk.id+'\')" style="flex:1;padding:5px;border:none;border-radius:6px;background:linear-gradient(135deg,#f97316,#ef4444);color:#fff;font-size:.7rem;font-weight:700;cursor:pointer;">売却 1口</button>':'')+
        '</div>'+
        (reqText?'<div class="inv-lock">'+reqText+'</div>':'')+
      '</div>';
    }).join('');
  }

  // === REAL ESTATE ===
  var reGrid=document.getElementById('realEstateGrid');
  if(reGrid){
    reGrid.innerHTML=REAL_ESTATE.map(function(item){
      var count=getRECount(item.id);
      var meetsReq=checkSkillReq(item.req);
      var canBuy=meetsReq&&gold>=item.cost;
      var reqText=item.req&&!meetsReq?'🔒 '+getSkillNameById(item.req.skill)+' Lv.'+item.req.lv+' 必要':'';
      var holdings=getREHoldings().filter(function(h){return h.id===item.id;});
      var badge=count>0?'<div style="position:absolute;top:6px;right:8px;background:rgba(74,222,128,.15);border:1px solid rgba(74,222,128,.3);color:var(--green);font-size:.6rem;padding:1px 6px;border-radius:8px;font-family:JetBrains Mono,monospace;">×'+count+'</div>':'';

      var detailHtml='';
      if(count>0){
        detailHtml='<div style="margin-top:4px;font-size:.6rem;">';
        holdings.forEach(function(h,i){
          var cv=calcREValue(h);
          var dep=h.buyPrice-cv;
          detailHtml+='<div style="padding:2px 4px;background:rgba(255,255,255,.03);border-radius:4px;margin-bottom:2px;">'+
            '#'+(i+1)+' 取得:'+h.buyPrice.toLocaleString()+'G → 現在:'+cv.toLocaleString()+'G <span style="color:var(--rose);">(-'+dep.toLocaleString()+'G)</span>'+
          '</div>';
        });
        detailHtml+='</div>';
      }

      return '<div class="inv-card'+(meetsReq?'':' locked')+'" style="position:relative;">'+badge+
        '<div class="inv-icon">'+item.icon+'</div>'+
        '<div class="inv-name">'+item.name+'</div>'+
        '<div class="inv-desc">'+item.desc+'</div>'+
        '<div class="inv-yield">家賃: 月 '+item.monthlyRent.toLocaleString()+' G / 戸</div>'+
        '<div style="font-size:.6rem;color:var(--muted2);">減価率: '+((item.depRate*100).toFixed(2))+'%/日 | 利回り: '+(item.monthlyRent*12/item.cost*100).toFixed(1)+'%/年</div>'+
        detailHtml+
        '<div style="display:flex;gap:4px;margin-top:6px;">'+
          (canBuy?'<button onclick="event.stopPropagation();buyRE(\''+item.id+'\')" style="flex:1;padding:5px;border:none;border-radius:6px;background:linear-gradient(135deg,#4ade80,#22d3ee);color:#000;font-size:.7rem;font-weight:700;cursor:pointer;">購入 '+item.cost.toLocaleString()+'G</button>':
          '<button disabled style="flex:1;padding:5px;border:none;border-radius:6px;background:var(--s2);color:var(--muted);font-size:.7rem;cursor:not-allowed;">'+(meetsReq?item.cost.toLocaleString()+'G':'🔒')+'</button>')+
          (count>0?'<button onclick="event.stopPropagation();sellRE(\''+item.id+'\')" style="flex:1;padding:5px;border:none;border-radius:6px;background:linear-gradient(135deg,#f97316,#ef4444);color:#fff;font-size:.7rem;font-weight:700;cursor:pointer;">売却 1戸</button>':'')+
        '</div>'+
        (reqText?'<div class="inv-lock">'+reqText+'</div>':'')+
      '</div>';
    }).join('');
  }

  // === BUSINESS ===
  var bizGrid=document.getElementById('businessGrid');
  if(bizGrid){
    // Staff info header
    var staffInfo='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--s2);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;font-size:.7rem;">'+
      '<span>👥 街の人口: <span style="color:var(--cyan);font-family:JetBrains Mono,monospace;">'+townPop.toLocaleString()+'</span>人</span>'+
      '<span>雇用中: <span style="color:var(--amber);font-family:JetBrains Mono,monospace;">'+totalStaffUsed.toLocaleString()+'</span>人</span>'+
      '<span>空き: <span style="color:'+(availStaff>0?'var(--green)':'var(--rose)')+';font-family:JetBrains Mono,monospace;">'+availStaff.toLocaleString()+'</span>人</span>'+
    '</div>';

    bizGrid.innerHTML=staffInfo+BUSINESSES.map(function(biz){
      var count=getBizCount(biz.id);
      var meetsReq=checkSkillReq(biz.req);
      var canAfford=gold>=biz.cost;
      var hasStaff=availStaff>=biz.staff;
      var canBuy=meetsReq&&canAfford&&hasStaff;
      var reqText=biz.req&&!meetsReq?'🔒 '+getSkillNameById(biz.req.skill)+' Lv.'+biz.req.lv+' 必要':'';
      var badge=count>0?'<div style="position:absolute;top:6px;right:8px;background:rgba(168,85,247,.15);border:1px solid rgba(168,85,247,.3);color:var(--violet);font-size:.6rem;padding:1px 6px;border-radius:8px;font-family:JetBrains Mono,monospace;">×'+count+'</div>':'';

      var staffColor=hasStaff?'var(--green)':'var(--rose)';

      return '<div class="inv-card'+(meetsReq?'':' locked')+'" style="position:relative;">'+badge+
        '<div class="inv-icon">'+biz.icon+'</div>'+
        '<div class="inv-name">'+biz.name+'</div>'+
        '<div class="inv-desc">'+biz.desc+'</div>'+
        '<div class="inv-yield">毎日 +'+biz.daily.toLocaleString()+' G'+(count>0?' (計: +'+biz.daily*count+' G/日)':'')+'</div>'+
        (biz.id==='biz_empire'&&count>0?'<div style="font-size:.58rem;color:#fcd34d;margin:3px 0;">👑 追加投資: '+getEmpireInvestment().toLocaleString()+'G → +'+getEmpireDailyBonus().toLocaleString()+' G/日</div>':'')+
        '<div style="font-size:.6rem;color:'+staffColor+';">👥 必要従業員: '+biz.staff.toLocaleString()+'人'+(!hasStaff&&meetsReq?' (不足！)':'')+'</div>'+
        '<div style="display:flex;gap:4px;margin-top:6px;">'+
          (canBuy?'<button onclick="event.stopPropagation();buyBiz(\''+biz.id+'\')" style="flex:1;padding:5px;border:none;border-radius:6px;background:linear-gradient(135deg,#a855f7,#ec4899);color:#fff;font-size:.7rem;font-weight:700;cursor:pointer;">設立 '+biz.cost.toLocaleString()+'G</button>':
          '<button disabled style="flex:1;padding:5px;border:none;border-radius:6px;background:var(--s2);color:var(--muted);font-size:.7rem;cursor:not-allowed;">'+(meetsReq?(canAfford?'👥 人口不足':biz.cost.toLocaleString()+'G'):'🔒')+'</button>')+
          (biz.id==='biz_empire'&&count>0?'<button onclick="event.stopPropagation();investInEmpire()" style="padding:5px 8px;border:none;border-radius:6px;background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#000;font-size:.65rem;font-weight:700;cursor:pointer;">💰 追加投資</button>':'')+
        '</div>'+
        (reqText?'<div class="inv-lock">'+reqText+'</div>':'')+
      '</div>';
    }).join('');
  }

  // === LIFESTYLE ===
  var lsEl=document.getElementById('lifestyleGrid');
  if(lsEl){
    lsEl.innerHTML=LIFESTYLES.map(function(item){
      var isActive=active.includes(item.id);
      var meetsReq=checkSkillReq(item.req);
      var cls='ls-card'+(isActive?' ls-active':'')+(!meetsReq?' locked':'');
      return '<div class="'+cls+'" onclick="'+(meetsReq?"toggleLifestyle('"+item.id+"')":'')+'" style="'+(meetsReq?'':'opacity:.4;cursor:not-allowed;')+'">'+
        '<div class="ls-icon">'+item.icon+'</div>'+
        '<div class="ls-name">'+item.name+(isActive?' ✓':'')+'</div>'+
        '<div class="ls-desc">'+item.desc+'</div>'+
        '<div class="ls-cost">-'+item.costPerDay+' G/日</div>'+
        '<div class="ls-bonus">XP +'+Math.round(item.xpBonus*100)+'%</div>'+
        (item.req&&!meetsReq?'<div style="font-size:.55rem;color:var(--rose);margin-top:2px;">🔒 '+getSkillNameById(item.req.skill)+' Lv.'+item.req.lv+'</div>':'')+
      '</div>';
    }).join('');
  }

  // === PASSIVE INCOME DISPLAY ===
  var totalDaily=calcDailyPassive();
  var reMonthly=getREHoldings().reduce(function(s,h){var r=REAL_ESTATE.find(function(x){return x.id===h.id;});return s+(r?r.monthlyRent:0);},0);
  var bizDaily=getBizHoldings().reduce(function(s,h){var b=BUSINESSES.find(function(x){return x.id===h.id;});return s+(b?b.daily:0);},0);
  var lsCost=LIFESTYLES.filter(function(l){return active.includes(l.id);}).reduce(function(s,l){return s+l.costPerDay;},0);
  var stockVal=getPortfolio().reduce(function(s,p){var pr=prices[p.id]||0;return s+pr;},0);

  var passDisp=document.getElementById('passiveDisplay');
  if(passDisp)passDisp.textContent=(totalDaily>=0?'+':'')+totalDaily.toLocaleString()+' G/日';
  var passDetail=document.getElementById('passiveDetail');
  if(passDetail){
    passDetail.textContent='事業:+'+bizDaily+'G/日 | 家賃:+'+reMonthly.toLocaleString()+'G/月 | 株評価額:'+stockVal.toLocaleString()+'G | 生活費:-'+lsCost+'G/日';
  }

  // Pending passive bar
  var pending=getPendingPassive();
  var passBar=document.getElementById('passiveBar');
  if(passBar)passBar.style.display=pending>0?'flex':'none';
  var passAmt=document.getElementById('passiveCollectAmt');
  if(passAmt)passAmt.textContent=pending.toLocaleString()+' G';

  // Rent button
  var rentBtn=document.getElementById('rentCollectBtn');
  if(rentBtn){
    var lastRent=getLastRentDate();
    var canRent=getREHoldings().length>0;
    var daysLeft=0;
    if(lastRent){
      var d1=parseDate(lastRent),d2=parseDate(todayStr());
      daysLeft=Math.max(0,30-Math.round((d2-d1)/(1000*60*60*24)));
    }
    rentBtn.style.display=canRent?'flex':'none';
    rentBtn.textContent=daysLeft>0?'🏠 家賃回収まで '+daysLeft+'日':'🏠 家賃を回収する (+'+reMonthly.toLocaleString()+'G)';
    rentBtn.disabled=daysLeft>0;
    rentBtn.style.opacity=daysLeft>0?'0.5':'1';
    rentBtn.style.cursor=daysLeft>0?'not-allowed':'pointer';
  }
}

// ================================================================
// GACHA SYSTEM
// ================================================================

// ================================================================
// HOUSING UPGRADE SYSTEM
// ================================================================
const HOUSING = [
  {id:'h0',name:'野宿',icon:'🛖',cost:0,xpBonus:0,desc:'星空の下で'},
  {id:'h1',name:'テント',icon:'⛺',cost:200,xpBonus:0.03,desc:'雨はしのげる'},
  {id:'h2',name:'小部屋',icon:'🚪',cost:800,xpBonus:0.06,desc:'自分だけの空間'},
  {id:'h3',name:'アパート',icon:'🏠',cost:2500,xpBonus:0.10,desc:'普通の暮らし'},
  {id:'h4',name:'マンション',icon:'🏢',cost:8000,xpBonus:0.15,desc:'都心の1LDK'},
  {id:'h5',name:'一戸建て',icon:'🏡',cost:25000,xpBonus:0.20,desc:'庭付きの家'},
  {id:'h6',name:'デザイナーズ',icon:'🏛️',cost:80000,xpBonus:0.28,desc:'建築家設計の邸宅'},
  {id:'h7',name:'ペントハウス',icon:'🌃',cost:250000,xpBonus:0.35,desc:'最上階の眺望'},
  {id:'h8',name:'城',icon:'🏰',cost:800000,xpBonus:0.45,desc:'あなただけの城'},
  {id:'h9',name:'宮殿',icon:'👑',cost:2000000,xpBonus:0.55,desc:'王宮レベルの住居'},
  {id:'h10',name:'海底ドーム',icon:'🫧',cost:5000000,xpBonus:0.65,desc:'海の底の楽園'},
  {id:'h11',name:'軌道上ステーション',icon:'🛸',cost:15000000,xpBonus:0.80,desc:'宇宙から地球を見下ろす'},
  {id:'h12',name:'異次元邸宅',icon:'🌌',cost:50000000,xpBonus:1.00,desc:'時空を超えた究極の住処'},
];

const INTERIOR = [
  {id:'int_desk',name:'ワークデスク',icon:'🪑',cost:300,xpBonus:0.02,desc:'集中できる作業環境'},
  {id:'int_bookshelf',name:'本棚',icon:'📚',cost:500,xpBonus:0.02,desc:'知識の壁'},
  {id:'int_plant',name:'観葉植物',icon:'🌱',cost:200,xpBonus:0.01,desc:'癒しの緑'},
  {id:'int_art',name:'アート作品',icon:'🖼️',cost:1500,xpBonus:0.03,desc:'インスピレーションの源'},
  {id:'int_speaker',name:'高級スピーカー',icon:'🔊',cost:2000,xpBonus:0.03,desc:'音で空間を満たす'},
  {id:'int_bed',name:'高級ベッド',icon:'🛏️',cost:3000,xpBonus:0.04,desc:'睡眠の質が劇的向上'},
  {id:'int_kitchen',name:'システムキッチン',icon:'🍳',cost:5000,xpBonus:0.04,desc:'自炊で健康に'},
  {id:'int_bath',name:'ジェットバス',icon:'🛁',cost:8000,xpBonus:0.05,desc:'極上のリラックス'},
  {id:'int_gym',name:'ホームジム',icon:'🏋️',cost:12000,xpBonus:0.06,desc:'いつでもトレーニング'},
  {id:'int_theater',name:'ホームシアター',icon:'🎬',cost:20000,xpBonus:0.06,desc:'映画館が自宅に'},
  {id:'int_wine',name:'ワインセラー',icon:'🍷',cost:35000,xpBonus:0.05,desc:'時を重ねる贅沢'},
  {id:'int_sauna',name:'プライベートサウナ',icon:'🧖',cost:50000,xpBonus:0.08,desc:'究極の回復空間'},
  {id:'int_rooftop',name:'ルーフトップテラス',icon:'🌅',cost:70000,xpBonus:0.07,desc:'夕日を独り占め'},
  {id:'int_lab',name:'ホームラボ',icon:'🔬',cost:90000,xpBonus:0.08,desc:'自宅で実験'},
  {id:'int_dojo',name:'道場',icon:'🥋',cost:120000,xpBonus:0.09,desc:'精神と身体を鍛える'},
  {id:'int_observatory',name:'プラネタリウム室',icon:'🌌',cost:180000,xpBonus:0.10,desc:'天井に星空を映す'},
  {id:'int_library',name:'プライベート図書室',icon:'📖',cost:250000,xpBonus:0.12,desc:'1万冊の知の殿堂'},
  {id:'int_pool',name:'インフィニティプール',icon:'🏊',cost:400000,xpBonus:0.12,desc:'地平線と溶け合う水面'},
  {id:'int_holo',name:'ホログラム部屋',icon:'🔮',cost:800000,xpBonus:0.15,desc:'光で作る仮想空間'},
  {id:'int_zen',name:'枯山水庭園',icon:'⛩️',cost:1500000,xpBonus:0.18,desc:'究極の静寂'},
  // gacha-only items
  {id:'int_chandelier',name:'シャンデリア',icon:'✨',cost:0,xpBonus:0.10,desc:'天井を飾る輝き',gachaOnly:true},
  {id:'int_aquarium',name:'巨大水槽',icon:'🐠',cost:0,xpBonus:0.08,desc:'熱帯魚が泳ぐ癒し空間',gachaOnly:true},
  {id:'int_piano',name:'グランドピアノ',icon:'🎹',cost:0,xpBonus:0.12,desc:'芸術の極み',gachaOnly:true},
  {id:'int_telescope',name:'天体望遠鏡',icon:'🔭',cost:0,xpBonus:0.09,desc:'星を見る贅沢',gachaOnly:true},
  {id:'int_garden',name:'屋上庭園',icon:'🌸',cost:0,xpBonus:0.15,desc:'空に浮かぶ楽園',gachaOnly:true},
  {id:'int_aurora',name:'オーロラ発生装置',icon:'🌈',cost:0,xpBonus:0.13,desc:'室内にオーロラが舞う',gachaOnly:true},
  {id:'int_antigrav',name:'無重力チェア',icon:'🪐',cost:0,xpBonus:0.11,desc:'浮遊するリラクゼーション',gachaOnly:true},
  {id:'int_timeclock',name:'時の大時計',icon:'⏰',cost:0,xpBonus:0.14,desc:'時を刻む芸術品',gachaOnly:true},
];

function getCurrentHousing(){return ls_get('housing_level')||0;}
function setCurrentHousing(v){ls_set('housing_level',v);}
function getOwnedInterior(){return ls_get('owned_interior')||[];}
function setOwnedInterior(v){ls_set('owned_interior',v);}

function getHousingXPBonus(){
  const hLv=getCurrentHousing();
  const h=HOUSING[hLv]||HOUSING[0];
  let bonus=h.xpBonus;
  getOwnedInterior().forEach(id=>{const it=INTERIOR.find(x=>x.id===id);if(it)bonus+=it.xpBonus;});
  return bonus;
}

function upgradeHousing(level){
  const h=HOUSING[level];
  if(!h)return;
  if(level<=getCurrentHousing()){toast('すでにこの住居以上です','err');return;}
  if(level!==getCurrentHousing()+1){toast('1段階ずつアップグレードしてください','err');return;}
  if(getGold()<h.cost){toast('ゴールドが足りません（必要: '+h.cost.toLocaleString()+'G）','err');return;}
  setGold(getGold()-h.cost);
  setCurrentHousing(level);
  addEventLog('🏠 住居を「'+h.name+'」にアップグレード！ XP+'+Math.round(h.xpBonus*100)+'%','money');
  showReward(h.icon,'住居アップグレード！','「'+h.name+'」に引っ越しました！\nXPボーナス +'+Math.round(h.xpBonus*100)+'%');
  updateNav();renderEconomy();renderLifestyle();
}

function buyInterior(id){
  const item=INTERIOR.find(x=>x.id===id);
  if(!item)return;
  const owned=getOwnedInterior();
  if(owned.includes(id)){toast('すでに購入済みです','err');return;}
  if(getGold()<item.cost){toast('ゴールドが足りません（必要: '+item.cost.toLocaleString()+'G）','err');return;}
  setGold(getGold()-item.cost);
  owned.push(id);setOwnedInterior(owned);
  addEventLog('🛋️ 「'+item.name+'」を購入！ XP+'+Math.round(item.xpBonus*100)+'%','money');
  toast('🛋️ '+item.name+' を設置しました！');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'XP+'+Math.round(item.xpBonus*100)+'%');
  updateNav();renderEconomy();renderLifestyle();
}
function renderLifestyle(){
  var curH=getCurrentHousing();
  var h=HOUSING[curH];
  var owned=getOwnedInterior();
  var gold=getGold();
  var active=getActiveLifestyles();
  var intBonus=owned.reduce(function(s,id){var it=INTERIOR.find(function(x){return x.id===id;});return s+(it?it.xpBonus:0);},0);
  var totalBonus=getHousingXPBonus()+getLifestyleXPBonus();

  document.getElementById('curHousingIcon').textContent=h.icon;
  document.getElementById('curHousingName').textContent=h.name;
  document.getElementById('curHousingBonus').textContent='XPボーナス合計: +'+Math.round(totalBonus*100)+'% (住居+'+Math.round(h.xpBonus*100)+'% / 家具+'+Math.round(intBonus*100)+'% / サブスク+'+Math.round(getLifestyleXPBonus()*100)+'%)';

  var hList=document.getElementById('housingList');
  if(hList){
    hList.innerHTML=HOUSING.slice(1).map(function(hh,i){
      var level=i+1;
      var isOwned=curH>=level;
      var isNext=level===curH+1;
      var canBuy=isNext&&gold>=hh.cost;
      var cls='bld-item'+(isOwned?' bld-owned':!isNext?' bld-cant':'');
      return '<div class="'+cls+'" onclick="'+(canBuy?'upgradeHousing('+level+')':'')+'">'+
        '<div class="bld-icon">'+hh.icon+'</div>'+
        '<div class="bld-info"><div class="bld-name">'+hh.name+'</div><div class="bld-desc">'+hh.desc+' (XP +'+Math.round(hh.xpBonus*100)+'%)</div></div>'+
        '<div class="bld-cost '+(isOwned?'c-own':canBuy?'c-gold':'c-lock')+'">'+(isOwned?'入居中 ✓':hh.cost.toLocaleString()+' G')+'</div></div>';
    }).join('');
  }

  var iGrid=document.getElementById('interiorGrid');
  if(iGrid){
    iGrid.innerHTML=INTERIOR.filter(function(item){return !item.gachaOnly;}).map(function(item){
      var isOwned=owned.includes(item.id);
      var canBuy=!isOwned&&gold>=item.cost;
      return '<div class="inv-card'+(isOwned?' owned':'')+'" onclick="'+(!isOwned&&canBuy?'buyInterior(\''+item.id+'\')':'')+'" style="'+(isOwned?'':canBuy?'cursor:pointer;':'cursor:not-allowed;opacity:.5;')+'">'+
        '<div class="inv-icon">'+item.icon+'</div>'+
        '<div class="inv-name">'+item.name+'</div>'+
        '<div class="inv-desc">'+item.desc+'</div>'+
        '<div class="inv-yield">XP +'+Math.round(item.xpBonus*100)+'%</div>'+
        (isOwned?'':'<div class="inv-cost">'+item.cost.toLocaleString()+' G</div>')+
      '</div>';
    }).join('');
    // Show gacha-only items as locked
    var gachaItems=INTERIOR.filter(function(item){return item.gachaOnly;});
    if(gachaItems.length>0){
      iGrid.innerHTML+='<div style="width:100%;font-size:.62rem;color:var(--violet);margin-top:6px;padding-top:6px;border-top:1px solid var(--border);">🎰 高級ガチャ限定アイテム</div>';
      iGrid.innerHTML+=gachaItems.map(function(item){
        var isOwned=owned.includes(item.id);
        return '<div class="inv-card'+(isOwned?' owned':'')+'" style="border-color:rgba(168,85,247,.25);'+(isOwned?'':'opacity:.6;cursor:default;')+'">'+
          '<div class="inv-icon">'+item.icon+'</div>'+
          '<div class="inv-name">'+item.name+(isOwned?' ✓':'')+'</div>'+
          '<div class="inv-desc">'+item.desc+'</div>'+
          '<div class="inv-yield">XP +'+Math.round(item.xpBonus*100)+'%</div>'+
          (isOwned?'':'<div style="font-size:.55rem;color:var(--violet);">🎰 高級ガチャでのみ入手</div>')+
        '</div>';
      }).join('');
    }
  }

  var lsEl=document.getElementById('lifestyleGrid');
  if(lsEl){
    lsEl.innerHTML=LIFESTYLES.map(function(item){
      var isActive=active.includes(item.id);
      var meetsReq=checkSkillReq(item.req);
      return '<div class="ls-card'+(isActive?' ls-active':'')+'" onclick="'+(meetsReq?'toggleLifestyle(\''+item.id+'\')':'')+'" style="'+(meetsReq?'':'opacity:.4;cursor:not-allowed;')+'">'+
        '<div class="ls-icon">'+item.icon+'</div>'+
        '<div class="ls-name">'+item.name+(isActive?' ✓':'')+'</div>'+
        '<div class="ls-desc">'+item.desc+'</div>'+
        '<div class="ls-cost">-'+item.costPerDay+' G/日</div>'+
        '<div class="ls-bonus">XP +'+Math.round(item.xpBonus*100)+'%</div>'+
        (item.req&&!meetsReq?'<div style="font-size:.55rem;color:var(--rose);margin-top:2px;">🔒 '+getSkillNameById(item.req.skill)+' Lv.'+item.req.lv+'</div>':'')+
      '</div>';
    }).join('');
  }
}

// ================================================================
// TOWN RANK SYSTEM
// ================================================================
const TOWN_RANKS = [
  {name:'更地',minPop:0,icon:'🏜️',wageBonus:0,goldBonus:0},
  {name:'集落',minPop:50,icon:'🏕️',wageBonus:0.02,goldBonus:50},
  {name:'村',minPop:120,icon:'🏘️',wageBonus:0.05,goldBonus:150},
  {name:'町',minPop:250,icon:'🏙️',wageBonus:0.08,goldBonus:300},
  {name:'小都市',minPop:500,icon:'🌆',wageBonus:0.12,goldBonus:500},
  {name:'都市',minPop:800,icon:'🌇',wageBonus:0.18,goldBonus:1000},
  {name:'大都市',minPop:1200,icon:'🌃',wageBonus:0.25,goldBonus:2000},
  {name:'メガシティ',minPop:1800,icon:'🗼',wageBonus:0.32,goldBonus:4000},
  {name:'メトロポリス',minPop:2500,icon:'🌐',wageBonus:0.40,goldBonus:8000},
  {name:'帝都',minPop:3500,icon:'👑',wageBonus:0.50,goldBonus:15000},
  {name:'銀河都市',minPop:5000,icon:'🌌',wageBonus:0.65,goldBonus:30000},
];

function getTownPop(){
  return getOwnedBuildings().reduce(function(s,id){var b=BUILDINGS.find(function(x){return x.id===id;});return s+(b?b.pop:0);},0);
}

function getTownRank(){
  var pop=getTownPop();
  var rank=TOWN_RANKS[0];
  for(var i=0;i<TOWN_RANKS.length;i++){if(pop>=TOWN_RANKS[i].minPop)rank=TOWN_RANKS[i];}
  return rank;
}

function getTownWageBonus(){return getTownRank().wageBonus;}

function renderTownRank(){
  var pop=getTownPop();
  var rank=getTownRank();
  var rankIdx=TOWN_RANKS.indexOf(rank);
  var next=TOWN_RANKS[rankIdx+1];
  var badge=document.getElementById('townRankBadge');
  if(badge)badge.textContent=rank.icon+' '+rank.name;
  var label=document.getElementById('townRankLabel');
  var prog=document.getElementById('townRankProg');
  var bar=document.getElementById('townRankBar');
  if(next){
    if(label)label.textContent='次のランク: '+next.name;
    if(prog)prog.textContent=pop+'/'+next.minPop+'人';
    if(bar)bar.style.width=Math.min(100,(pop/next.minPop)*100)+'%';
  } else {
    if(label)label.textContent='最高ランク達成！';
    if(prog)prog.textContent=pop+'人';
    if(bar)bar.style.width='100%';
  }
  var bonus=document.getElementById('townBonusText');
  if(bonus){
    if(rank.wageBonus>0){
      bonus.textContent='時給 +'+Math.round(rank.wageBonus*100)+'% | ランクアップ報酬: '+rank.goldBonus.toLocaleString()+'G';
    } else {
      bonus.textContent='建物を建てて人口を増やすとボーナス解放！';
    }
  }
}

// Override calcWage to include town bonus + rebirth bonus
var _baseCalcWage = calcWage;
calcWage = function(){
  return Math.round(_baseCalcWage() * (1 + getTownWageBonus()) * getRebirthWageMulti());
};

// Override buyBuilding to check town rank up
var _origBuyBld2 = buyBuilding;
buyBuilding = function(id){
  var prevRank = getTownRank().name;
  _origBuyBld2(id);
  var newRank = getTownRank();
  if(newRank.name !== prevRank && newRank.goldBonus > 0){
    setGold(getGold() + newRank.goldBonus);
    setTotalEarned(getTotalEarned() + newRank.goldBonus);
    addEventLog('🏙️ 街ランクUP！「'+newRank.name+'」 +'+newRank.goldBonus+'G','awakening');
    showReward(newRank.icon,'街ランクアップ！','「'+newRank.name+'」に昇格！\n\n🎁 報酬: '+newRank.goldBonus.toLocaleString()+' G\n💰 時給 +'+Math.round(newRank.wageBonus*100)+'%');
  }
  renderTownRank();
};

// Override addXP to apply housing+lifestyle+rebirth bonus
var _prevAddXP = addXP;
addXP = function(amount, blockEl){
  var housingBonus = getHousingXPBonus();
  var rebirthMulti = getRebirthXPMulti();
  var adjusted = Math.round(amount * (1 + housingBonus) * rebirthMulti);
  _prevAddXP(adjusted, blockEl);
};
// ================================================================
// LUXURY INTERIOR GACHA
// ================================================================
function luxuryGacha(){
  if(getGold()<10000){toast('ゴールドが足りません（必要: 10,000G）','err');return;}
  setGold(getGold()-10000);
  updateNav();renderEconomy();
  var gachaItems=INTERIOR.filter(function(i){return i.gachaOnly;});
  var owned=getOwnedInterior();
  var unowned=gachaItems.filter(function(i){return !owned.includes(i.id);});
  var el=document.getElementById('luxGachaResult');
  if(unowned.length===0){
    el.innerHTML='<div style="color:var(--amber);">全てコンプ済み！ +2000G返金</div>';
    setGold(getGold()+2000);updateNav();renderEconomy();
    return;
  }
  // Weighted: rarer items less likely
  var weights=[40,30,15,10,5]; // corresponds to gachaItems order
  var totalW=0;
  unowned.forEach(function(item){
    var idx=gachaItems.indexOf(item);
    totalW+=weights[idx]||10;
  });
  var r=Math.random()*totalW;
  var winner=unowned[0];
  for(var i=0;i<unowned.length;i++){
    var idx=gachaItems.indexOf(unowned[i]);
    r-=(weights[idx]||10);
    if(r<=0){winner=unowned[i];break;}
  }
  // 50% chance of miss (get gold back partially)
  if(Math.random()<0.50){
    var refund=Math.round(1000+Math.random()*3000);
    setGold(getGold()+refund);
    el.innerHTML='<div style="color:var(--muted2);">💨 はずれ... +'+refund+'G 返金</div>';
    updateNav();renderEconomy();
    return;
  }
  owned.push(winner.id);
  setOwnedInterior(owned);
  el.innerHTML='<div style="color:var(--violet);font-size:1.2rem;">'+winner.icon+' '+winner.name+'</div><div style="font-size:.65rem;color:var(--green);">XP +'+Math.round(winner.xpBonus*100)+'% 獲得！</div>';
  addEventLog('💎 高級ガチャで「'+winner.name+'」を入手！','awakening');
  showReward(winner.icon,'レアアイテム！','「'+winner.name+'」を入手！\nXPボーナス +'+Math.round(winner.xpBonus*100)+'%');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,winner.icon+' GET!');
  updateNav();renderEconomy();
  var ownedLabel=document.getElementById('luxGachaOwned');
  if(ownedLabel)ownedLabel.textContent=INTERIOR.filter(function(i){return i.gachaOnly&&owned.includes(i.id);}).length+'/'+gachaItems.length+' コンプ';
  if(curP3Tab==='life')renderLifestyle();
}

// ================================================================
// SLOT MACHINE
// ================================================================
const SLOT_SYMBOLS=['🍒','🍋','⭐','💎','7️⃣','🔔'];
let slotSpinning=false;

function spinSlot(){
  if(slotSpinning)return;
  if(getGold()<80){toast('ゴールドが足りません（必要: 80G）','err');return;}
  setGold(getGold()-80);
  updateNav();
  renderEconomy();
  slotSpinning=true;
  const reels=[0,1,2];
  const finalSymbols=reels.map(()=>SLOT_SYMBOLS[Math.floor(Math.random()*SLOT_SYMBOLS.length)]);

  // Spinning animation
  reels.forEach(i=>document.getElementById('reel'+i).classList.add('spinning'));
  let stopped=0;
  reels.forEach((r,i)=>{
    const interval=setInterval(()=>{
      document.getElementById('reel'+i).textContent=SLOT_SYMBOLS[Math.floor(Math.random()*SLOT_SYMBOLS.length)];
    },80);
    setTimeout(()=>{
      clearInterval(interval);
      document.getElementById('reel'+i).textContent=finalSymbols[i];
      document.getElementById('reel'+i).classList.remove('spinning');
      stopped++;
      if(stopped===3){
        slotSpinning=false;
        evaluateSlot(finalSymbols);
      }
    },600+i*400);
  });
  updateNav();
}

function evaluateSlot(symbols){
  const el=document.getElementById('slotResult');
  if(symbols[0]===symbols[1]&&symbols[1]===symbols[2]){
    const s=symbols[0];
    const prize=s==='7️⃣'?5000:s==='💎'?2000:250;
    setGold(getGold()+prize);
    setTotalEarned(getTotalEarned()+prize);
    const big=prize>=2000;
    el.innerHTML='<div style="color:var(--gold);font-size:.9rem;font-weight:800;">🎊 '+(big?'JACKPOT!!! ':'3つ揃い! ')+'+'+prize+'G</div>';
    spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'🎰 +'+prize+'G!!');
    addEventLog('🎰 スロット'+(big?'ジャックポット！':'当たり！')+' +'+prize+'G','money');
  } else if(symbols[0]===symbols[1]||symbols[1]===symbols[2]||symbols[0]===symbols[2]){
    setGold(getGold()+20);
    el.innerHTML='<div style="color:var(--amber);">✨ 2つ揃い! +20G</div>';
  } else {
    el.innerHTML='<div style="color:var(--muted2);">残念...次こそは！ (-80G)</div>';
  }
  updateNav();
  renderEconomy();
}

// ================================================================
// ENTERTAINMENT TAB SWITCH
// ================================================================
var curEntTab='slot';
function setEntTab(tab){
  curEntTab=tab;
  ['slot','pachinko','mystery','luxgacha','loan'].forEach(function(t){
    var panel=document.getElementById('entPanel_'+t);
    var btn=document.getElementById('entTab_'+t);
    if(panel)panel.style.display=t===tab?'':'none';
    if(btn){btn.style.background=t===tab?'var(--s3)':'var(--s2)';btn.style.borderColor=t===tab?(t==='slot'?'var(--orange)':t==='pachinko'?'#c084fc':t==='mystery'?'var(--cyan)':t==='loan'?'#4ade80':'var(--violet)'):'var(--border)';btn.style.color=t===tab?(t==='slot'?'var(--orange)':t==='pachinko'?'#c084fc':t==='mystery'?'var(--cyan)':t==='loan'?'#4ade80':'var(--violet)'):'var(--text)';}
  });
  if(tab==='mystery')renderMysteryCollection();
  if(tab==='loan')renderLoanUI();
}

// ================================================================
// FORTUNE MACHINE SYSTEM (フィーバー・時短ルール)
// ================================================================
var pachinkoSpinning=false;
function getPachinkoState(){return ls_get('pachinko_state')||{mode:'normal',jitan:0,chain:0};}
function setPachinkoState(s){ls_set('pachinko_state',s);}
var PACHINKO_NUMS=['1','2','3','4','5','6','7','8','9'];

var pachiMiniMode=false;
function playPachinko(mini){
  if(pachinkoSpinning)return;
  pachiMiniMode=!!mini;
  var scale=mini?0.1:1;
  var state=getPachinkoState();
  var cost=Math.round(((state.mode==='kakuhen'&&state.jitan>0)?50:100)*scale);
  if(getGold()<cost){toast('ゴールドが足りません（必要: '+cost+'G）','err');return;}
  setGold(getGold()-cost);
  updateNav();renderEconomy();
  pachinkoSpinning=true;
  document.getElementById('pachinkoBtn').disabled=true;
  document.getElementById('pachinkoResult').textContent='';

  // Determine outcome
  var hitRate=state.mode==='kakuhen'?3:10; // 1/3 vs 1/10
  var isHit=Math.random()*hitRate<1;

  // Pick drums
  var d0=PACHINKO_NUMS[Math.floor(Math.random()*PACHINKO_NUMS.length)];
  var d1,d2;
  if(isHit){
    d1=d0;d2=d0; // triple
  } else {
    // Reach (2 match) ~30% of time on miss
    if(Math.random()<0.3){
      d1=d0;
      do{d2=PACHINKO_NUMS[Math.floor(Math.random()*PACHINKO_NUMS.length)];}while(d2===d0);
    } else {
      do{d1=PACHINKO_NUMS[Math.floor(Math.random()*PACHINKO_NUMS.length)];}while(d1===d0);
      d2=PACHINKO_NUMS[Math.floor(Math.random()*PACHINKO_NUMS.length)];
    }
  }

  // Animate pachinko ball on canvas
  animatePachinkoBall();

  // Spin drums
  var drums=[d0,d1,d2];
  [0,1,2].forEach(function(i){document.getElementById('pDrum'+i).classList.add('spinning');});
  var stopped=0;
  [0,1,2].forEach(function(i){
    var iv=setInterval(function(){
      document.getElementById('pDrum'+i).textContent=PACHINKO_NUMS[Math.floor(Math.random()*PACHINKO_NUMS.length)];
    },90);
    setTimeout(function(){
      clearInterval(iv);
      document.getElementById('pDrum'+i).textContent=drums[i];
      document.getElementById('pDrum'+i).classList.remove('spinning');
      stopped++;
      if(stopped===3)resolvePachinko(isHit,drums,state);
    },700+i*500);
  });
}

function animatePachinkoBall(){
  var canvas=document.getElementById('pachinkoCanvas');
  if(!canvas)return;
  var ctx=canvas.getContext('2d');
  var w=canvas.width,h=canvas.height;
  var ball={x:w/2+Math.random()*40-20,y:10,vx:Math.random()*2-1,vy:0,r:5};
  // pegs
  var pegs=[];
  for(var row=0;row<6;row++){
    var cols=row%2===0?5:4;
    for(var c=0;c<cols;c++){
      pegs.push({x:(row%2===0?30:50)+c*45,y:30+row*28});
    }
  }
  var frame=0;
  var maxFrames=60;
  function draw(){
    ctx.clearRect(0,0,w,h);
    // draw pegs
    pegs.forEach(function(p){
      ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fillStyle='rgba(192,132,252,0.4)';ctx.fill();
    });
    // physics
    ball.vy+=0.5;ball.x+=ball.vx;ball.y+=ball.vy;
    pegs.forEach(function(p){
      var dx=ball.x-p.x,dy=ball.y-p.y,dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<8){ball.vx=dx/dist*2+Math.random()-0.5;ball.vy=-Math.abs(ball.vy)*0.5;ball.y=p.y-8;}
    });
    if(ball.x<5){ball.x=5;ball.vx=Math.abs(ball.vx);}
    if(ball.x>w-5){ball.x=w-5;ball.vx=-Math.abs(ball.vx);}
    // draw ball
    ctx.beginPath();ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);
    ctx.fillStyle='#fcd34d';ctx.shadowBlur=8;ctx.shadowColor='#fbbf24';ctx.fill();ctx.shadowBlur=0;
    frame++;
    if(frame<maxFrames&&ball.y<h-5)requestAnimationFrame(draw);
  }
  draw();
}

function resolvePachinko(isHit,drums,state){
  pachinkoSpinning=false;
  document.getElementById('pachinkoBtn').disabled=false;
  var el=document.getElementById('pachinkoResult');
  var scale=pachiMiniMode?0.1:1;

  if(isHit){
    var num=parseInt(drums[0]);
    var prize;
    if(num===7) prize=2500;
    else if(num>=5) prize=800;
    else prize=400;
    if(state.mode==='kakuhen')prize=Math.round(prize*1.2);
    prize=Math.round(prize*scale);
    setGold(getGold()+prize);
    setTotalEarned(getTotalEarned()+prize);

    // Determine kakuhen
    var newKakuhen=Math.random()<0.5;
    state.chain++;
    if(newKakuhen){
      state.mode='kakuhen';state.jitan=10;
      el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">🎊 大当たり！ +'+prize+'G</div><div style="color:#f472b6;font-size:.78rem;font-weight:800;margin-top:3px;">✨ フィーバー突入！（時短10回付）</div>';
      addEventLog('🔮 フォーチュン大当たり +'+prize+'G → フィーバー突入！（'+state.chain+'連チャン）','money');
    } else {
      state.mode='normal';state.jitan=0;
      el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">🎊 大当たり！ +'+prize+'G</div><div style="color:var(--muted2);font-size:.7rem;margin-top:3px;">通常に戻る</div>';
      addEventLog('🔮 フォーチュン大当たり +'+prize+'G（'+state.chain+'連チャン）','money');
      state.chain=0;
    }
    spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'🔮 +'+prize+'G!!');
    if(prize>=2500)showReward('🔮','フォーチュン大当たり！','+'+prize+'G獲得！'+(newKakuhen?'\n✨ フィーバー突入！大連チャンのチャンス！':''));
  } else {
    // Miss
    if(drums[0]===drums[1]){
      // Reach miss - consolation
      var consol=Math.round(((state.mode==='kakuhen')?15:20)*scale);
      setGold(getGold()+consol);
      el.innerHTML='<div style="color:var(--amber);">リーチ！ 惜しい... +'+consol+'G</div>';
    } else {
      el.innerHTML='<div style="color:var(--muted2);">はずれ...</div>';
    }
    if(state.mode==='kakuhen'&&state.jitan>0){
      state.jitan--;
      if(state.jitan<=0){state.mode='normal';state.chain=0;
        el.innerHTML+='<div style="font-size:.65rem;color:var(--rose);margin-top:3px;">時短終了 → 通常モードに戻る</div>';
      }
    }
  }
  setPachinkoState(state);
  updatePachinkoDisplay();
  updateNav();renderEconomy();
  checkAchievements();
}

function updatePachinkoDisplay(){
  var state=getPachinkoState();
  var modeEl=document.getElementById('pachinkoMode');
  var jitanEl=document.getElementById('pachinkoJitan');
  var chainEl=document.getElementById('pachinkoChain');
  if(modeEl){
    if(state.mode==='kakuhen'){modeEl.textContent='フィーバー中';modeEl.style.color='#fcd34d';}
    else{modeEl.textContent='通常';modeEl.style.color='var(--muted2)';}
  }
  if(jitanEl){jitanEl.textContent=state.jitan>0?state.jitan+'回':'--';jitanEl.style.color=state.jitan>0?'#38bdf8':'var(--muted2)';}
  if(chainEl){chainEl.textContent=state.chain;chainEl.style.color=state.chain>0?'#f472b6':'#c084fc';}
  var btn=document.getElementById('pachinkoBtn');
  if(btn){
    var cost=(state.mode==='kakuhen'&&state.jitan>0)?50:100;
    btn.textContent='打つ ('+cost+'G)';
  }
}

// Machine selector
var curPachiMachine='std';
function setPachiMachine(m){
  curPachiMachine=m;
  ['std','umi','gen'].forEach(function(id){
    var p=document.getElementById('pachiPanel_'+id);
    var b=document.getElementById('pachiSel_'+id);
    if(p)p.style.display=id===m?'':'none';
    if(b)b.classList.toggle('active',id===m);
  });
  if(m==='umi')updateUmiDisplay();
  if(m==='gen')updateGenDisplay();
}

// ================================================================
// FORTUNE 2: ラッキーオーシャン (フィーバーループタイプ)
// ================================================================
var UMI_NUMS=['1','2','3','4','5','6','7','8','9'];
function getUmiState(){return ls_get('umi_state')||{mode:'normal',chain:0};}
function setUmiState(s){ls_set('umi_state',s);}
var umiSpinning=false;

var umiMiniMode=false;
function playUmi(mini){
  if(umiSpinning)return;
  umiMiniMode=!!mini;
  var scale=mini?0.1:1;
  var cost=Math.round((getUmiState().mode==='kakuhen'?40:80)*scale);
  var state=getUmiState();
  if(getGold()<cost){toast('ゴールドが足りません（必要: '+cost+'G）','err');return;}
  setGold(getGold()-cost);updateNav();renderEconomy();
  umiSpinning=true;
  document.getElementById('umiBtn').disabled=true;
  document.getElementById('umiResult').textContent='';

  // Hit rate: normal 1/320, kakuhen 1/40
  var hitRate=state.mode==='kakuhen'?40:320;
  var isHit=Math.random()*hitRate<1;
  var d0=UMI_NUMS[Math.floor(Math.random()*UMI_NUMS.length)];
  var d1,d2;
  if(isHit){d1=d0;d2=d0;}
  else{
    if(Math.random()<0.15){d1=d0;do{d2=UMI_NUMS[Math.floor(Math.random()*UMI_NUMS.length)];}while(d2===d0);}
    else{do{d1=UMI_NUMS[Math.floor(Math.random()*UMI_NUMS.length)];}while(d1===d0);d2=UMI_NUMS[Math.floor(Math.random()*UMI_NUMS.length)];}
  }
  var drums=[d0,d1,d2];
  [0,1,2].forEach(function(i){
    var iv=setInterval(function(){document.getElementById('uDrum'+i).textContent=UMI_NUMS[Math.floor(Math.random()*UMI_NUMS.length)];},90);
    setTimeout(function(){clearInterval(iv);document.getElementById('uDrum'+i).textContent=drums[i];if(i===2)resolveUmi(isHit,drums,state);},700+i*500);
  });
}

function resolveUmi(isHit,drums,state){
  umiSpinning=false;document.getElementById('umiBtn').disabled=false;
  var el=document.getElementById('umiResult');
  var scale=umiMiniMode?0.1:1;
  if(isHit){
    var num=parseInt(drums[0]);
    var prize=Math.round((num>=7?5000:num>=4?2500:1500)*scale);
    setGold(getGold()+prize);setTotalEarned(getTotalEarned()+prize);
    state.chain++;
    if(Math.random()<0.65){
      state.mode='kakuhen';
      el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">🌊 大当たり！ +'+prize+'G</div><div style="color:#38bdf8;font-size:.78rem;font-weight:800;">✨ フィーバー継続！（'+state.chain+'連）</div>';
      addEventLog('🌊 ラッキーオーシャン 大当たり +'+prize+'G → フィーバーループ（'+state.chain+'連）','money');
    } else {
      state.mode='normal';
      el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">🌊 大当たり！ +'+prize+'G</div><div style="color:var(--muted2);font-size:.7rem;">通常に戻る（'+state.chain+'連）</div>';
      addEventLog('🌊 ラッキーオーシャン 大当たり +'+prize+'G（'+state.chain+'連）','money');
      state.chain=0;
    }
    spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'🌊 +'+prize+'G!!');
  } else {
    var consol=Math.round(10*scale);
    if(drums[0]===drums[1]){setGold(getGold()+consol);el.innerHTML='<div style="color:var(--amber);">リーチ！ +'+consol+'G</div>';}
    else{el.innerHTML='<div style="color:var(--muted2);">はずれ...</div>';}
  }
  setUmiState(state);updateUmiDisplay();updateNav();renderEconomy();checkAchievements();
}

function updateUmiDisplay(){
  var s=getUmiState();
  var m=document.getElementById('umiMode'),c=document.getElementById('umiChain'),l=document.getElementById('umiLoop');
  if(m){m.textContent=s.mode==='kakuhen'?'フィーバー中':'通常';m.style.color=s.mode==='kakuhen'?'#38bdf8':'var(--muted2)';}
  if(c){c.textContent=s.chain;c.style.color=s.chain>0?'#38bdf8':'var(--muted2)';}
  if(l){l.textContent=s.mode==='kakuhen'?'継続中':'--';l.style.color=s.mode==='kakuhen'?'#4ade80':'var(--muted2)';}
  var btn=document.getElementById('umiBtn');
  if(btn)btn.textContent='打つ ('+(s.mode==='kakuhen'?40:80)+'G)';
}

// ================================================================
// FORTUNE 3: ゴールドラッシュ
// ================================================================
var GEN_NUMS=['1','2','3','4','5','6','7','8','9'];
function getGenState(){return ls_get('gen_state')||{mode:'normal',chain:0,rush:false};}
function setGenState(s){ls_set('gen_state',s);}
var genSpinning=false;
var genMiniMode=false;

function playGen(mini){
  if(genSpinning)return;
  genMiniMode=!!mini;
  var scale=mini?0.1:1;
  var state=getGenState();
  var cost=Math.round((state.rush?30:60)*scale);
  if(getGold()<cost){toast('ゴールドが足りません（必要: '+cost+'G）','err');return;}
  setGold(getGold()-cost);updateNav();renderEconomy();
  genSpinning=true;
  document.getElementById('genBtn').disabled=true;
  document.getElementById('genResult').textContent='';

  // Hit rate: normal 1/199, rush 1/8
  var hitRate=state.rush?8:199;
  var isHit=Math.random()*hitRate<1;
  var d0=GEN_NUMS[Math.floor(Math.random()*GEN_NUMS.length)];
  var d1,d2;
  if(isHit){d1=d0;d2=d0;}
  else{
    if(Math.random()<0.12){d1=d0;do{d2=GEN_NUMS[Math.floor(Math.random()*GEN_NUMS.length)];}while(d2===d0);}
    else{do{d1=GEN_NUMS[Math.floor(Math.random()*GEN_NUMS.length)];}while(d1===d0);d2=GEN_NUMS[Math.floor(Math.random()*GEN_NUMS.length)];}
  }
  var drums=[d0,d1,d2];
  // Fast animation for rush feel
  [0,1,2].forEach(function(i){
    var iv=setInterval(function(){document.getElementById('gDrum'+i).textContent=GEN_NUMS[Math.floor(Math.random()*GEN_NUMS.length)];},60);
    setTimeout(function(){clearInterval(iv);document.getElementById('gDrum'+i).textContent=drums[i];if(i===2)resolveGen(isHit,drums,state);},400+i*300);
  });
}

function resolveGen(isHit,drums,state){
  genSpinning=false;document.getElementById('genBtn').disabled=false;
  var el=document.getElementById('genResult');
  var scale=genMiniMode?0.1:1;
  if(isHit){
    var num=parseInt(drums[0]);
    var prize;
    if(state.rush){
      prize=Math.round((num>=7?2000:num>=4?1200:800)*scale);
      state.chain++;
      if(Math.random()<0.81){
        el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">⚡ RUSH当たり！ +'+prize+'G</div><div style="color:#fbbf24;font-size:.78rem;font-weight:800;">⚡ RUSH継続！（'+state.chain+'連）</div>';
        addEventLog('⚡ ゴールドラッシュRUSH +'+prize+'G（'+state.chain+'連チャン！）','money');
      } else {
        state.rush=false;state.mode='normal';
        el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">⚡ 当たり！ +'+prize+'G</div><div style="color:var(--rose);font-size:.7rem;">RUSH終了（'+state.chain+'連）</div>';
        addEventLog('⚡ ゴールドラッシュ +'+prize+'G RUSH終了（'+state.chain+'連）','money');
        state.chain=0;
      }
    } else {
      prize=Math.round((num>=7?1000:num>=4?500:300)*scale);
      if(Math.random()<0.30){
        state.rush=true;state.mode='rush';state.chain=1;
        el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">⚡ 大当たり！ +'+prize+'G</div><div style="color:#fbbf24;font-size:.85rem;font-weight:900;">🔥 RUSH突入！！ 爆速連チャンSTART！</div>';
        addEventLog('⚡ ゴールドラッシュ 大当たり +'+prize+'G → RUSH突入！！','money');
      } else {
        el.innerHTML='<div style="color:#fcd34d;font-size:.9rem;font-weight:800;">当たり！ +'+prize+'G</div><div style="color:var(--muted2);font-size:.65rem;">RUSH突入ならず…</div>';
        addEventLog('⚡ ゴールドラッシュ 当たり +'+prize+'G（RUSH突入せず）','money');
      }
    }
    setGold(getGold()+prize);setTotalEarned(getTotalEarned()+prize);
    spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'⚡ +'+prize+'G!!');
  } else {
    if(drums[0]===drums[1]){el.innerHTML='<div style="color:var(--amber);">リーチ！ 惜しい...</div>';}
    else{el.innerHTML='<div style="color:var(--muted2);">はずれ...</div>';}
  }
  setGenState(state);updateGenDisplay();updateNav();renderEconomy();checkAchievements();
}

function updateGenDisplay(){
  var s=getGenState();
  var m=document.getElementById('genMode'),c=document.getElementById('genChain'),r=document.getElementById('genRush');
  if(m){m.textContent=s.rush?'RUSH中':'通常';m.style.color=s.rush?'#fbbf24':'var(--muted2)';}
  if(c){c.textContent=s.chain;c.style.color=s.chain>0?'#fbbf24':'var(--muted2)';}
  if(r){r.textContent=s.rush?'継続中':'--';r.style.color=s.rush?'#fb7185':'var(--muted2)';}
  var btn=document.getElementById('genBtn');
  if(btn)btn.textContent='打つ ('+(s.rush?30:60)+'G)';
}

// ================================================================
// MYSTERY GACHA (123 items collection)
// ================================================================
var MYSTERY_ITEMS=[];
(function(){
  var pool=[
    ['🪨','謎の石','なんの変哲もない石。でも何か感じる。'],['🧲','磁石のかけら','N極しかない不思議な磁石。'],['🪶','見覚えのない羽','どの鳥のものでもない。'],['🫧','永遠のシャボン玉','割れないらしい。本当？'],['🍄','光るキノコ','暗闇で淡く光る。食べたら危険。'],
    ['🦷','古代の歯','誰のだろう...恐竜？'],['🔩','錆びたネジ','何かの部品だったはず。'],['🧩','迷子のピース','どのパズルにも合わない。'],['🎪','ミニサーカステント','手のひらサイズ。中を覗くと...'],['🪄','折れた魔法の杖','先端がちょっと光る。'],
    ['📎','最強のクリップ','伝説の文房具。'],['🧊','溶けない氷','常温でも固体のまま。'],['🪞','逆さ鏡','映ったものが全部逆。'],['🎐','無音の風鈴','風が吹いても鳴らない。'],['🧃','空のジュース箱','でもなぜか重い。'],
    ['🪅','踊るこけし','夜中に動くという噂。'],['🎭','半分の仮面','もう半分はどこに？'],['🧸','片目のクマ','片目だけウインクしてる。'],['🎠','回らないメリーゴーラウンド','置物サイズ。時々回る。'],['🪆','底なしマトリョーシカ','開けても開けても...'],
    ['🔮','曇りの水晶玉','過去だけ見える。'],['🕯️','消えない蝋燭','火をつけなくても光る。'],['🪤','優しいネズミ捕り','挟まれると気持ちいい。'],['🧿','逆ナザール','幸運を吸い取る目。'],['🎋','枯れない笹','願いは叶わないけど枯れない。'],
    ['🪃','戻ってこないブーメラン','投げたら行方不明。'],['🏺','底のない壺','何を入れても消える。'],['🪬','意味不明のお守り','効果不明だが高級感はある。'],['🧲','反発する磁石','全てを押し返す。'],['🎿','砂漠用スキー板','なぜか砂の上を滑れる。'],
    ['🪙','表しかないコイン','裏がない。賭けに最適。'],['🧵','切れない糸','でも針は通らない。'],['🪡','曲がった針','直線だけ縫えない。'],['🧶','解けない毛糸玉','編もうとすると固まる。'],['🪢','永久結び','結んだら二度と解けない。'],
    ['🧲','浮く石','水に入れると浮かぶ。'],['🪨','柔らかい石','触るとぷにぷに。'],['🧱','透明なレンガ','見えないけど確かにある。'],['🪵','歌う木片','耳を当てると歌が聞こえる。'],['🪸','陸のサンゴ','土の上で育つ。'],
    ['🫧','固いシャボン玉','パンチしても割れない。'],['🎈','沈む風船','ヘリウムなのに落ちる。'],['🧊','熱い氷','触ると温かい。'],['🔥','冷たい炎','手をかざすと涼しい。'],['💧','乾いた水滴','濡れない水。'],
    ['🌪️','瓶詰めの竜巻','開けると部屋が散らかる。'],['⛈️','雷のかけら','静電気がすごい。'],['🌈','白黒の虹','モノクロだけど虹。'],['☁️','重い雲','手に持つとずっしり。'],['⭐','落ちた星','まだ少し温かい。'],
    ['🌙','欠けない三日月','満月にならない。'],['☀️','小さな太陽','暗い部屋を明るくする。'],['🪐','卓上の土星','輪っかが回る。'],['🌍','平らな地球儀','フラットアース。'],['🌋','ミニ火山','時々噴火する（安全）。'],
    ['🍕','永遠のピザ','食べても減らない。'],['🍩','四角いドーナツ','穴も四角。'],['🍳','生に戻る目玉焼き','冷めると生卵に。'],['🧁','見えないカップケーキ','美味しい匂いだけ。'],['🍭','辛いキャンディ','見た目は甘そう。'],
    ['🎵','聞こえない音符','目に見える音楽。'],['🎶','触れるメロディ','手触りがいい。'],['🔔','音のない鐘','振っても無音。'],['🎸','弦のないギター','エアギター専用。'],['🥁','叩けないドラム','手が通り抜ける。'],
    ['📖','白紙の本','読むと物語が浮かぶ。'],['📜','解読不能の巻物','どの言語でもない。'],['🗝️','鍵穴のない鍵','何を開けるのか不明。'],['🗺️','空白の地図','歩くと描かれていく。'],['🧭','嘘つきコンパス','南を指す。'],
    ['⏳','逆さの砂時計','砂が上に落ちる。'],['⌚','遅れる時計','常に5分遅い。'],['🔭','近くが見える望遠鏡','遠くは見えない。'],['🔬','大きく見えない顕微鏡','小さく見える。'],['🪜','短くなるはしご','登ると縮む。'],
    ['🚪','どこでもないドア','開けると壁。'],['🪟','景色が変わる窓','毎回違う場所が見える。'],['🛗','動かないエレベーター','ドアは開閉する。'],['🎢','平坦なジェットコースター','スリルゼロ。'],['🎡','超小型観覧車','指で回す。'],
    ['👑','重すぎる王冠','首が鍛えられる。'],['👒','浮く帽子','被ると浮遊感。'],['🧤','右手用が2つ','左手には使えない。'],['🧣','短すぎるマフラー','首に巻けない。'],['👓','何も見えない眼鏡','装着すると真っ暗。'],
    ['🎨','色のないパレット','透明な絵が描ける。'],['🖌️','描けない筆','インクを弾く。'],['✏️','書けない鉛筆','紙の上を滑る。'],['📏','伸縮する定規','測るたびに長さが変わる。'],['✂️','切れないハサミ','でも音はする。'],
    ['🧲','木の磁石','金属を避ける。'],['🪝','曲がらないフック','真っ直ぐ。'],['🔧','柔らかいスパナ','締められない。'],['🔨','跳ねるハンマー','釘を打つと飛ぶ。'],['⚙️','逆回転の歯車','反対に回る。'],
    ['💊','何もしない薬','プラセボ以下。'],['🧪','空のフラスコ','何を入れても消える。'],['🔋','充電できない電池','最初からフル。'],['💡','暗くなる電球','つけると暗い。'],['🔌','差せないプラグ','どのコンセントにも合わない。'],
    ['🎲','全面1のサイコロ','何を振っても1。'],['🃏','白紙のジョーカー','好きなカードになる。'],['♟️','動かないチェスの駒','盤上で固定される。'],['🀄','読めない麻雀牌','新しい役？'],['🎯','外れないダーツ','的に吸い込まれる。'],
    ['🧫','空の培養皿','何も育たない。'],['🦠','友好的な菌','挨拶してくる。'],['🧬','ねじれすぎたDNA','三重らせん。'],['🔎','遠くなる虫眼鏡','小さく見える。'],['🪤','逆さのトラップ','踏むと飛び上がる。'],
    ['🛸','飛ばないUFO','地面を走る。'],['🤖','電源のないロボット','でも動く。'],['👾','友好的なインベーダー','攻撃してこない。'],['🎃','通年カボチャ','季節感ゼロ。'],['🧛','日焼けしたヴァンパイア','ビーチが好き。'],
    ['🦄','角のないユニコーン','ただの馬では？'],['🐉','手のひらサイズの竜','火は出ない。'],['🍀','五つ葉のクローバー','逆に不吉？'],['🌸','冬に咲く桜','雪の中で満開。'],['🍂','緑の落ち葉','落ちたのに緑。'],
    ['🗿','ミニモアイ','目が動く（気がする）。'],['🏛️','柱だけの神殿','屋根がない。'],['⚓','浮く錨','船が流される。'],
  ];
  for(var i=0;i<123;i++){
    var item=pool[i%pool.length];
    MYSTERY_ITEMS.push({id:'myst_'+i,emoji:item[0],name:item[1],desc:item[2]});
  }
})();

function getMysteryCollection(){return ls_get('mystery_coll')||[];}
function setMysteryCollection(v){ls_set('mystery_coll',v);}
function hasGoldenEagle(){return ls_get('golden_eagle')||false;}
function setGoldenEagle(v){ls_set('golden_eagle',v);}

function pullMysteryGacha(count){
  var cost=count===10?450:50*count;
  if(getGold()<cost){toast('ゴールドが足りません（必要: '+cost+'G）','err');return;}
  setGold(getGold()-cost);
  updateNav();renderEconomy();

  var coll=getMysteryCollection();
  var results=[];

  // Check if 124th item (golden eagle) is unlocked and not yet obtained
  var eagleUnlocked=(coll.length>=123 && !hasGoldenEagle());

  for(var i=0;i<count;i++){
    // If eagle is unlocked, roll 1/124 chance
    if(eagleUnlocked && Math.random()<(1/124)){
      setGoldenEagle(true);
      setGold(getGold()+1240000);
      setTotalEarned(getTotalEarned()+1240000);
      results.push({item:{id:'myst_eagle',emoji:'🦅',name:'トリプルイーグル金貨',desc:'伝説の金貨。124万Gの価値がある。'},isNew:true,isEagle:true});
      eagleUnlocked=false; // only once
      addEventLog('🦅 トリプルイーグル金貨を入手！ +1,240,000G！！','awakening');
      continue;
    }
    var item=MYSTERY_ITEMS[Math.floor(Math.random()*MYSTERY_ITEMS.length)];
    if(!coll.includes(item.id)){
      coll.push(item.id);
      results.push({item:item,isNew:true});
    } else {
      results.push({item:item,isNew:false});
    }
  }
  setMysteryCollection(coll);

  var gc=(ls_get('gacha_count')||0)+count;
  ls_set('gacha_count',gc);

  var display=document.getElementById('mysteryGachaDisplay');
  var resultEl=document.getElementById('mysteryGachaResult');
  var newCount=results.filter(function(r){return r.isNew;}).length;
  var dupeCount=count-newCount;
  var refund=dupeCount*15;
  if(refund>0){setGold(getGold()+refund);updateNav();renderEconomy();}

  // Check for eagle in results
  var eagleResult=results.find(function(r){return r.isEagle;});

  if(count===1){
    var r=results[0];
    display.textContent=r.item.emoji;
    display.style.borderColor=r.isEagle?'#fcd34d':r.isNew?'var(--cyan)':'var(--muted)';
    display.style.boxShadow=r.isEagle?'0 0 30px rgba(252,211,77,.5)':r.isNew?'0 0 20px rgba(0,212,255,.3)':'none';
    if(r.isEagle){
      resultEl.innerHTML='<div style="color:#fcd34d;font-weight:800;font-size:1rem;">🦅 トリプルイーグル金貨！！</div><div style="color:#4ade80;font-weight:700;">+1,240,000G 獲得！</div>';
    } else {
      resultEl.innerHTML=r.isNew
        ?'<div style="color:var(--cyan);font-weight:700;">NEW! '+r.item.emoji+' '+r.item.name+'</div><div style="font-size:.65rem;color:var(--muted2);">'+r.item.desc+'</div>'
        :'<div style="color:var(--muted2);">ダブり... '+r.item.emoji+' '+r.item.name+' (+15G返金)</div>';
    }
  } else {
    display.textContent=eagleResult?'🦅':'🎁';
    display.style.borderColor=eagleResult?'#fcd34d':'var(--cyan)';
    display.style.boxShadow=eagleResult?'0 0 30px rgba(252,211,77,.5)':'0 0 20px rgba(0,212,255,.2)';
    var html='<div style="font-size:.72rem;margin-bottom:4px;color:var(--cyan);font-weight:700;">10連結果: NEW '+newCount+'種'+(dupeCount>0?' / ダブり '+dupeCount+'種 (+'+refund+'G)':'')+'</div>';
    if(eagleResult)html+='<div style="color:#fcd34d;font-weight:800;font-size:.9rem;margin:4px 0;">🦅 トリプルイーグル金貨！ +1,240,000G！！</div>';
    html+='<div style="display:flex;flex-wrap:wrap;justify-content:center;gap:3px;">';
    results.forEach(function(r){
      html+='<span title="'+r.item.name+'" style="font-size:1.1rem;opacity:'+(r.isNew?'1':'0.35')+';'+(r.isNew?'text-shadow:0 0 6px rgba(0,212,255,.5);':'')+(r.isEagle?'text-shadow:0 0 10px rgba(252,211,77,.8);':'')+'">'+r.item.emoji+'</span>';
    });
    html+='</div>';
    resultEl.innerHTML=html;
  }

  if(newCount>0){
    addEventLog('🎁 ナゾガチャで'+newCount+'種の新アイテム入手！（'+coll.length+'/123）','money');
    if(coll.length>=123 && !hasGoldenEagle()){
      addEventLog('🏆 ナゾガチャ全123種コンプリート！ 124番目が解放された...','awakening');
      toast('🏆 全123種コンプ！ 124番目の「???」が出現！ 1/124の確率で抽選...');
    }
  }

  updateNav();renderEconomy();
  renderMysteryCollection();
  checkAchievements();
}

function renderMysteryCollection(){
  var coll=getMysteryCollection();
  var countEl=document.getElementById('mysteryCollCount');
  var barEl=document.getElementById('mysteryCollBar');
  var gridEl=document.getElementById('mysteryCollGrid');
  var totalItems=123+(coll.length>=123?1:0);
  if(countEl)countEl.textContent=coll.length+(hasGoldenEagle()?'+1':'')+' / '+totalItems;
  if(barEl)barEl.style.width=Math.round((coll.length+(hasGoldenEagle()?1:0))/totalItems*100)+'%';
  if(gridEl){
    var html=MYSTERY_ITEMS.map(function(item,idx){
      var owned=coll.includes(item.id);
      return '<div onclick="'+(owned?"showMysteryDetail("+idx+")":"")+'" style="width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:1rem;background:'+(owned?'var(--s2)':'var(--s1)')+';border:1px solid '+(owned?'rgba(0,212,255,.3)':'var(--border)')+';border-radius:6px;opacity:'+(owned?'1':'0.2')+';cursor:'+(owned?'pointer':'default')+';transition:transform .1s;'+(owned?'':'')+'\" onmouseenter="this.style.transform=\'scale(1.15)\'" onmouseleave="this.style.transform=\'scale(1)\'">'+(owned?item.emoji:'?')+'</div>';
    }).join('');
    // 124th item: Golden Eagle
    if(coll.length>=123){
      var eagleOwned=hasGoldenEagle();
      html+='<div onclick="'+(eagleOwned?"showMysteryDetail(-1)":"")+'" style="width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:1rem;background:'+(eagleOwned?'linear-gradient(135deg,#78350f,#92400e)':'var(--s1)')+';border:2px solid '+(eagleOwned?'rgba(252,211,77,.6)':'rgba(252,211,77,.2)')+';border-radius:6px;opacity:'+(eagleOwned?'1':'0.5')+';cursor:'+(eagleOwned?'pointer':'default')+';'+(eagleOwned?'box-shadow:0 0 8px rgba(252,211,77,.3);':'')+'">'+(eagleOwned?'🦅':'❓')+'</div>';
    }
    gridEl.innerHTML=html;
  }
}

function showMysteryDetail(idx){
  var item;
  if(idx===-1){
    item={emoji:'🦅',name:'トリプルイーグル金貨',desc:'伝説の金貨。124万Gの価値がある。1/124の奇跡を引き当てた証。'};
  } else {
    item=MYSTERY_ITEMS[idx];
  }
  if(!item)return;
  // Show detail popup
  var el=document.getElementById('mysteryDetailPopup');
  if(!el){
    el=document.createElement('div');
    el.id='mysteryDetailPopup';
    el.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;display:flex;align-items:center;justify-content:center;';
    el.onclick=function(e){if(e.target===el)el.style.display='none';};
    document.body.appendChild(el);
  }
  el.style.display='flex';
  el.innerHTML='<div style="background:#111827;border:1px solid '+(idx===-1?'rgba(252,211,77,.4)':'rgba(0,212,255,.3)')+';border-radius:16px;padding:28px;text-align:center;max-width:280px;width:90%;">'+
    '<div style="font-size:3.5rem;margin-bottom:8px;">'+item.emoji+'</div>'+
    '<div style="font-size:1rem;font-weight:800;color:'+(idx===-1?'#fcd34d':'var(--cyan)')+';margin-bottom:6px;">'+item.name+'</div>'+
    '<div style="font-size:.75rem;color:var(--muted2);line-height:1.6;">'+item.desc+'</div>'+
    '<div style="font-size:.6rem;color:var(--muted);margin-top:10px;">No.'+(idx===-1?'124':(idx+1))+' / '+(idx===-1?'124':'123')+'</div>'+
    '<button onclick="document.getElementById(\'mysteryDetailPopup\').style.display=\'none\'" style="margin-top:12px;padding:6px 20px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--text);font-size:.7rem;cursor:pointer;">閉じる</button>'+
  '</div>';
}

// ================================================================
// TODO GOAL SYSTEM
// ================================================================
function getTodos(){return ls_get('todo_goals')||[];}
function setTodos(v){ls_set('todo_goals',v);}

function openAddTodo(){
  document.getElementById('todoAddForm').style.display='block';
  document.getElementById('todoTitle').value='';
  document.getElementById('todoDesc').value='';
  document.getElementById('todoTitle').focus();
}

function addTodoItem(){
  var title=document.getElementById('todoTitle').value.trim();
  if(!title){toast('タイトルを入力してください','err');return;}
  var desc=document.getElementById('todoDesc').value.trim();
  var xp=parseInt(document.getElementById('todoXP').value)||500;
  var todos=getTodos();
  todos.push({id:Date.now(),title:title,desc:desc,xp:xp,done:false,createdAt:todayStr()});
  setTodos(todos);
  document.getElementById('todoAddForm').style.display='none';
  toast('📋 目標を追加しました');
  renderTodos();
}

function completeTodo(id){
  var todos=getTodos();
  var todo=todos.find(function(t){return t.id===id;});
  if(!todo||todo.done)return;
  if(!confirm('「'+todo.title+'」を達成済みにしますか？\n+'+todo.xp+' XP がもらえます！'))return;
  todo.done=true;
  todo.doneAt=todayStr();
  setTodos(todos);
  addXPRaw(todo.xp);
  addEventLog('📋 目標達成！「'+todo.title+'」 +'+todo.xp+' XP','awakening');
  toast('🎉 目標達成！ +'+todo.xp+' XP！');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'📋 +'+todo.xp+'XP');
  updateNav();
  renderTodos();
}

function deleteTodo(id){
  if(!confirm('この目標を削除しますか？'))return;
  var todos=getTodos().filter(function(t){return t.id!==id;});
  setTodos(todos);
  renderTodos();
}

function renderTodos(){
  var todos=getTodos();
  var el=document.getElementById('todoList');
  var countEl=document.getElementById('todoCount');
  var active=todos.filter(function(t){return !t.done;});
  var done=todos.filter(function(t){return t.done;});
  if(countEl)countEl.textContent=active.length+'個の目標'+(done.length>0?' (達成'+done.length+'個)':'');
  if(!el)return;
  if(todos.length===0){
    el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted);font-size:.75rem;">目標を追加して大きなXPボーナスを獲得しよう！<br><span style="font-size:.65rem;color:var(--muted2);">例: 「TOEIC 800点」「体重-5kg」「本を10冊読む」</span></div>';
    return;
  }
  var html='';
  // Active goals
  active.forEach(function(t){
    html+='<div style="background:var(--s1);border:1px solid rgba(74,222,128,.2);border-radius:12px;padding:12px 14px;">'+
      '<div style="display:flex;align-items:center;gap:8px;">'+
        '<div style="font-size:1.2rem;cursor:pointer;" onclick="completeTodo('+t.id+')" title="達成！">⬜</div>'+
        '<div style="flex:1;">'+
          '<div style="font-size:.82rem;font-weight:700;color:var(--text);">'+t.title+'</div>'+
          (t.desc?'<div style="font-size:.62rem;color:var(--muted2);margin-top:2px;">'+t.desc+'</div>':'')+
        '</div>'+
        '<div style="text-align:right;">'+
          '<div style="font-size:.75rem;font-weight:800;color:#4ade80;font-family:JetBrains Mono,monospace;">+'+t.xp+' XP</div>'+
          '<div style="font-size:.55rem;color:var(--muted);">'+t.createdAt+'〜</div>'+
        '</div>'+
        '<button onclick="deleteTodo('+t.id+')" style="border:none;background:none;color:var(--muted);cursor:pointer;font-size:.7rem;padding:4px;">🗑</button>'+
      '</div>'+
    '</div>';
  });
  // Done goals
  if(done.length>0){
    html+='<div style="font-size:.65rem;color:var(--muted);margin-top:6px;">✅ 達成済み</div>';
    done.forEach(function(t){
      html+='<div style="background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:10px 14px;opacity:.5;">'+
        '<div style="display:flex;align-items:center;gap:8px;">'+
          '<div style="font-size:1rem;">✅</div>'+
          '<div style="flex:1;text-decoration:line-through;font-size:.75rem;color:var(--muted);">'+t.title+'</div>'+
          '<div style="font-size:.6rem;color:var(--muted2);">+'+t.xp+'XP 達成:'+t.doneAt+'</div>'+
          '<button onclick="deleteTodo('+t.id+')" style="border:none;background:none;color:var(--muted);cursor:pointer;font-size:.6rem;padding:4px;">×</button>'+
        '</div>'+
      '</div>';
    });
  }
  el.innerHTML=html;
}

// ================================================================
// CONSUMER FINANCE SYSTEM (消費者金融)
// ================================================================
function getLoanData(){return ls_get('loan_data')||{status:'none',principal:0,borrowed:0,interest:0,lastTick:null,repaid:false,approved:false,limit:50000,contractDate:null};}
function setLoanData(v){ls_set('loan_data',v);}

function getLoanInterestRate(principal){
  // 利息制限法: 10万未満20%, 10万〜100万未満18%, 100万以上15%
  if(principal<100000)return 0.20;
  if(principal<1000000)return 0.18;
  return 0.15;
}

function getLoanDailyRate(principal){
  return getLoanInterestRate(principal)/365;
}

function calcAnnualIncome(){
  // 時給 × 8h × (365 - 100休日) = 年収
  var wage=calcWage();
  return wage*8*265;
}

function getLoanLimit(ld){
  if(!ld.repaid){
    return 50000; // 初回: 1万〜5万
  }
  // 返済実績あり: 年収の1/3
  return Math.floor(calcAnnualIncome()/3);
}

function tickLoanInterest(){
  var ld=getLoanData();
  if(ld.status!=='active'||ld.borrowed<=0)return;
  var today=todayStr();
  if(ld.lastTick===today)return;
  var last=ld.lastTick?parseDate(ld.lastTick):parseDate(ld.contractDate);
  var now=parseDate(today);
  var days=Math.max(1,Math.round((now-last)/(1000*60*60*24)));
  var rate=getLoanDailyRate(ld.borrowed);
  var newInterest=Math.round(ld.borrowed*rate*days);
  ld.interest+=newInterest;
  ld.lastTick=today;
  
  // Monthly minimum payment check (4.5% of borrowed)
  if(!ld.lastMinPayDate) ld.lastMinPayDate=ld.contractDate;
  var lastPay=parseDate(ld.lastMinPayDate);
  var daysSinceLastPay=Math.round((now-lastPay)/(1000*60*60*24));
  if(daysSinceLastPay>=30){
    var minPay=Math.max(1,Math.ceil(ld.borrowed*0.045));
    var gold=getGold();
    if(gold>=minPay){
      // Auto-deduct minimum payment
      var intPay=Math.min(minPay,ld.interest);
      ld.interest-=intPay;
      var prinPay=minPay-intPay;
      ld.borrowed=Math.max(0,ld.borrowed-prinPay);
      setGold(gold-minPay);
      ld.lastMinPayDate=today;
      addEventLog('🏦 消費者金融: 最低返済額 '+minPay.toLocaleString()+'G を自動引き落とし','money');
      toast('🏦 最低返済額 '+minPay.toLocaleString()+'G が引き落とされました');
      if(ld.borrowed<=0&&ld.interest<=0){
        ld.status='none';ld.borrowed=0;ld.interest=0;ld.repaid=true;
        ld.limit=getLoanLimit(ld);
        addEventLog('🎉 消費者金融完済！','money');
      }
    } else {
      // Cannot pay — penalty: interest doubles for this period + warning
      if(!ld.overdueCount) ld.overdueCount=0;
      ld.overdueCount++;
      var penalty=Math.ceil(ld.borrowed*0.01*ld.overdueCount);
      ld.interest+=penalty;
      ld.lastMinPayDate=today;
      addEventLog('⚠️ 消費者金融: 最低返済額 '+minPay.toLocaleString()+'G を支払えず！遅延損害金 +'+penalty.toLocaleString()+'G','money');
      toast('⚠️ 返済遅延！遅延損害金 +'+penalty.toLocaleString()+'G が加算されました','err');
      // Force deduction if any gold
      if(gold>0){
        var forcePay=gold;
        var iP=Math.min(forcePay,ld.interest);
        ld.interest-=iP;
        ld.borrowed=Math.max(0,ld.borrowed-(forcePay-iP));
        setGold(0);
        addEventLog('💸 所持金 '+forcePay.toLocaleString()+'G を強制回収されました','money');
      }
    }
  }
  
  setLoanData(ld);
}

function loanApply(){
  var ld=getLoanData();
  if(ld.status==='active'){toast('既に借入中です','err');return;}
  if(ld.status==='reviewing'){toast('審査中です。しばらくお待ちください','err');return;}
  ld.status='reviewing';
  setLoanData(ld);
  renderLoanUI();
  toast('📋 お申し込みを受け付けました。CIC信用情報を照会中...');
  // Simulate review (3 seconds)
  setTimeout(function(){
    var ld2=getLoanData();
    if(ld2.status!=='reviewing')return;
    ld2.status='approved';
    ld2.approved=true;
    ld2.limit=getLoanLimit(ld2);
    setLoanData(ld2);
    addEventLog('🏦 TFファイナンス審査通過！ 借入枠: '+ld2.limit.toLocaleString()+'G','money');
    toast('✅ 審査通過！ 契約手続きに進めます。');
    renderLoanUI();
  },3000);
}

function loanContract(){
  // Show inline contract form
  var ld=getLoanData();
  if(ld.status!=='approved')return;
  var limit=getLoanLimit(ld);
  var minAmt=10000;
  var maxAmt=limit;
  var actEl=document.getElementById('loanActions');
  actEl.innerHTML=
    '<div style="background:var(--s1);border:1px solid rgba(251,191,36,.3);border-radius:12px;padding:14px;margin-top:8px;">'+
      '<div style="font-size:.8rem;font-weight:700;color:#fbbf24;margin-bottom:8px;">📝 借入金額を入力</div>'+
      '<div style="font-size:.6rem;color:var(--muted);margin-bottom:6px;line-height:1.5;">'+
        '借入可能額: '+minAmt.toLocaleString()+'G 〜 '+maxAmt.toLocaleString()+'G<br>'+
        '適用金利: 年'+Math.round(getLoanInterestRate(maxAmt)*100)+'%（利息制限法準拠）<br>'+
        '※ 総量規制: 年収('+calcAnnualIncome().toLocaleString()+'G)の1/3 = '+Math.floor(calcAnnualIncome()/3).toLocaleString()+'G'+
      '</div>'+
      '<div style="display:flex;gap:4px;margin-bottom:8px;"><input id="loanAmtInput" type="number" min="'+minAmt+'" max="'+maxAmt+'" value="'+Math.min(maxAmt,50000)+'" style="flex:1;padding:10px;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:1rem;font-weight:700;font-family:JetBrains Mono,monospace;box-sizing:border-box;">'+
      '<button onclick="document.getElementById(\'loanAmtInput\').value='+maxAmt+';document.getElementById(\'loanAmtInput\').oninput();" style="padding:10px 14px;border:1px solid rgba(251,191,36,.4);border-radius:8px;background:rgba(251,191,36,.15);color:#fbbf24;font-size:.75rem;font-weight:800;cursor:pointer;white-space:nowrap;">MAX</button></div>'+
      '<div id="loanAmtPreview" style="font-size:.6rem;color:var(--muted);margin-bottom:10px;"></div>'+
      '<div style="display:flex;gap:6px;">'+
        '<button onclick="loanContractConfirm()" style="flex:1;padding:10px;border:none;border-radius:8px;background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000;font-size:.8rem;font-weight:800;cursor:pointer;">契約する</button>'+
        '<button onclick="renderLoanUI()" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--text);font-size:.75rem;cursor:pointer;">戻る</button>'+
      '</div>'+
    '</div>';
  // Live preview
  var inp=document.getElementById('loanAmtInput');
  function updatePreview(){
    var v=parseInt(inp.value)||0;
    var r=getLoanInterestRate(v);
    var minP=Math.max(1,Math.ceil(v*0.045));
    document.getElementById('loanAmtPreview').innerHTML=
      '実質年率: <span style="color:#fbbf24;font-weight:700;">'+Math.round(r*100)+'%</span> | '+
      '1日あたり利息: <span style="color:#fb7185;">約'+Math.round(v*r/365).toLocaleString()+'G/日</span><br>'+
      '💳 毎月の最低返済額（4.5%）: <span style="color:#f97316;font-weight:700;">'+minP.toLocaleString()+'G/月</span>'+
      ' <span style="color:var(--muted);font-size:.55rem;">— 30日ごとに自動引落。不足時は遅延損害金+強制回収</span>';
  }
  inp.oninput=updatePreview;
  updatePreview();
}

function loanContractConfirm(){
  var ld=getLoanData();
  var limit=getLoanLimit(ld);
  var minAmt=10000;var maxAmt=limit;
  var inp=document.getElementById('loanAmtInput');
  var amt=parseInt(inp.value);
  if(isNaN(amt)||amt<minAmt||amt>maxAmt){toast('借入額は'+minAmt.toLocaleString()+'G〜'+maxAmt.toLocaleString()+'Gの範囲で入力してください','err');return;}
  var rate=getLoanInterestRate(amt);
  // Show confirmation inline
  var actEl=document.getElementById('loanActions');
  actEl.innerHTML=
    '<div style="background:var(--s1);border:2px solid rgba(251,191,36,.4);border-radius:12px;padding:16px;">'+
      '<div style="font-size:.85rem;font-weight:800;color:#fbbf24;text-align:center;margin-bottom:10px;">📋 貸付契約書</div>'+
      '<div style="background:var(--s2);border-radius:8px;padding:10px;margin-bottom:10px;">'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="font-size:.65rem;color:var(--muted);">貸付金額</span><span style="font-size:.9rem;font-weight:800;color:var(--text);font-family:JetBrains Mono,monospace;">'+amt.toLocaleString()+' G</span></div>'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="font-size:.65rem;color:var(--muted);">実質年率</span><span style="font-size:.8rem;font-weight:700;color:#fbbf24;">'+Math.round(rate*100)+'.0%</span></div>'+
        '<div style="display:flex;justify-content:space-between;"><span style="font-size:.65rem;color:var(--muted);">1日あたり利息</span><span style="font-size:.75rem;color:#fb7185;">約'+Math.round(amt*rate/365).toLocaleString()+'G</span></div>'+
      '</div>'+
      '<div style="font-size:.5rem;color:var(--muted);line-height:1.5;margin-bottom:10px;">TFファイナンス株式会社<br>貸金業登録番号 タイムフロー財務局長（3）第4219号</div>'+
      '<div style="display:flex;gap:6px;">'+
        '<button onclick="loanExecute('+amt+')" style="flex:1;padding:12px;border:none;border-radius:8px;background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000;font-size:.85rem;font-weight:900;cursor:pointer;">✅ 同意して契約</button>'+
        '<button onclick="renderLoanUI()" style="padding:12px 16px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--text);font-size:.7rem;cursor:pointer;">戻る</button>'+
      '</div>'+
    '</div>';
}

function loanExecute(amt){
  var ld=getLoanData();
  var rate=getLoanInterestRate(amt);
  ld.status='active';
  ld.principal=amt;
  ld.borrowed=amt;
  ld.interest=0;
  ld.lastTick=todayStr();
  ld.contractDate=todayStr();
  setLoanData(ld);
  setGold(getGold()+amt);
  addEventLog('🏦 消費者金融から'+amt.toLocaleString()+'G借入（年率'+Math.round(rate*100)+'%）','money');
  toast('💰 '+amt.toLocaleString()+'G を借入しました');
  updateNav();renderEconomy();renderLoanUI();
}

function loanRepay(){
  // Show inline repay form
  var ld=getLoanData();
  if(ld.status!=='active'||ld.borrowed<=0)return;
  tickLoanInterest();
  ld=getLoanData();
  var total=ld.borrowed+ld.interest;
  var gold=getGold();
  var actEl=document.getElementById('loanActions');
  actEl.innerHTML=
    '<div style="background:var(--s1);border:1px solid rgba(74,222,128,.3);border-radius:12px;padding:14px;margin-top:8px;">'+
      '<div style="font-size:.8rem;font-weight:700;color:#4ade80;margin-bottom:8px;">💸 返済</div>'+
      '<div style="font-size:.6rem;color:var(--muted);margin-bottom:8px;line-height:1.5;">'+
        '元本残高: <span style="color:#fb7185;font-weight:700;">'+ld.borrowed.toLocaleString()+'G</span><br>'+
        '利息: <span style="color:#fbbf24;font-weight:700;">'+ld.interest.toLocaleString()+'G</span><br>'+
        '返済総額: <span style="color:#fb7185;font-weight:700;">'+total.toLocaleString()+'G</span><br>'+
        '所持金: <span style="color:var(--text);font-weight:700;">'+gold.toLocaleString()+'G</span>'+
      '</div>'+
      '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;">'+
        '<button onclick="loanRepayExec('+Math.min(gold,total)+')" style="flex:1;padding:8px;border:none;border-radius:8px;background:linear-gradient(135deg,#4ade80,#22c55e);color:#000;font-size:.72rem;font-weight:800;cursor:pointer;">全額返済<br><span style="font-size:.6rem;">'+Math.min(gold,total).toLocaleString()+'G</span></button>'+
        (total>10000&&gold>=10000?'<button onclick="loanRepayExec(10000)" style="flex:1;padding:8px;border:none;border-radius:8px;background:rgba(74,222,128,.15);border:1px solid rgba(74,222,128,.3);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">10,000G<br><span style="font-size:.6rem;">一部返済</span></button>':'')+
        (total>50000&&gold>=50000?'<button onclick="loanRepayExec(50000)" style="flex:1;padding:8px;border:none;border-radius:8px;background:rgba(74,222,128,.15);border:1px solid rgba(74,222,128,.3);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">50,000G<br><span style="font-size:.6rem;">一部返済</span></button>':'')+
      '</div>'+
      '<div style="display:flex;gap:4px;align-items:center;margin-bottom:8px;">'+
        '<input id="loanRepayInput" type="number" min="1" max="'+Math.min(gold,total)+'" placeholder="金額を入力" style="flex:1;padding:8px;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.8rem;font-family:JetBrains Mono,monospace;box-sizing:border-box;">'+
        '<button onclick="var v=parseInt(document.getElementById(\'loanRepayInput\').value);if(v>0)loanRepayExec(v);else toast(\'金額を入力してください\',\'err\');" style="padding:8px 14px;border:none;border-radius:8px;background:rgba(74,222,128,.2);border:1px solid rgba(74,222,128,.3);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">返済</button>'+
      '</div>'+
      '<button onclick="renderLoanUI()" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--muted);font-size:.68rem;cursor:pointer;">戻る</button>'+
    '</div>';
}

function loanRepayExec(payAmt){
  var ld=getLoanData();
  var gold=getGold();
  var total=ld.borrowed+ld.interest;
  payAmt=Math.min(payAmt,gold,total);
  if(payAmt<=0){toast('返済額が0です','err');return;}
  var intPay=Math.min(payAmt,ld.interest);
  ld.interest-=intPay;
  var prinPay=payAmt-intPay;
  ld.borrowed-=prinPay;
  setGold(gold-payAmt);
  if(ld.borrowed<=0&&ld.interest<=0){
    ld.status='none';
    ld.borrowed=0;ld.interest=0;
    ld.repaid=true;
    ld.limit=getLoanLimit(ld);
    addEventLog('🎉 消費者金融完済！ 借入枠が年収の1/3に拡大','money');
    toast('🎉 完済！ 借入可能額がアップしました！');
  } else {
    toast('💸 '+payAmt.toLocaleString()+'G返済（残り元本:'+ld.borrowed.toLocaleString()+'G / 利息:'+ld.interest.toLocaleString()+'G）');
    addEventLog('💸 消費者金融へ'+payAmt.toLocaleString()+'G返済（残'+ld.borrowed.toLocaleString()+'G）','money');
  }
  setLoanData(ld);
  updateNav();renderEconomy();renderLoanUI();
}

function renderLoanUI(){
  tickLoanInterest();
  var ld=getLoanData();
  var statusEl=document.getElementById('loanStatus');
  var actEl=document.getElementById('loanActions');
  if(!statusEl||!actEl)return;

  var income=calcAnnualIncome();
  var limit=getLoanLimit(ld);
  var rate=ld.borrowed>0?getLoanInterestRate(ld.borrowed):0.18;

  // Status display
  if(ld.status==='active'){
    var total=ld.borrowed+ld.interest;
    var minPay=Math.max(1,Math.ceil(ld.borrowed*0.045));
    var lastMinPayDate=ld.lastMinPayDate||ld.contractDate;
    var daysSinceMinPay=Math.round((parseDate(todayStr())-parseDate(lastMinPayDate))/(1000*60*60*24));
    var daysUntilMinPay=Math.max(0,30-daysSinceMinPay);
    var overdueWarning=(ld.overdueCount&&ld.overdueCount>0)?'<div style="background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:6px 10px;margin-top:8px;font-size:.62rem;color:#fb7185;text-align:center;">⚠️ 返済遅延 '+ld.overdueCount+'回 — 遅延損害金が加算されています</div>':'';
    statusEl.innerHTML=
      '<div style="display:flex;justify-content:space-between;margin-bottom:8px;">'+
        '<div style="font-size:.65rem;color:var(--muted2);">契約状況</div>'+
        '<div style="font-size:.65rem;color:#fb7185;font-weight:700;">借入中</div>'+
      '</div>'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">'+
        '<div style="background:var(--s2);border-radius:8px;padding:8px;text-align:center;">'+
          '<div style="font-size:.55rem;color:var(--muted);">元本残高</div>'+
          '<div style="font-size:1rem;font-weight:800;color:#fb7185;font-family:JetBrains Mono,monospace;">'+ld.borrowed.toLocaleString()+'G</div>'+
        '</div>'+
        '<div style="background:var(--s2);border-radius:8px;padding:8px;text-align:center;">'+
          '<div style="font-size:.55rem;color:var(--muted);">利息累計</div>'+
          '<div style="font-size:1rem;font-weight:800;color:#fbbf24;font-family:JetBrains Mono,monospace;">'+ld.interest.toLocaleString()+'G</div>'+
        '</div>'+
      '</div>'+
      '<div style="background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.2);border-radius:8px;padding:8px 10px;margin-top:8px;">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;">'+
          '<div style="font-size:.62rem;color:var(--muted2);">💳 毎月の最低返済額（借入の4.5%）</div>'+
          '<div style="font-size:.85rem;font-weight:800;color:#fbbf24;font-family:JetBrains Mono,monospace;">'+minPay.toLocaleString()+'G</div>'+
        '</div>'+
        '<div style="font-size:.55rem;color:var(--muted);margin-top:4px;">次回引落まで <span style="color:'+(daysUntilMinPay<=7?'#fb7185':'var(--cyan)')+';font-weight:700;">'+daysUntilMinPay+'日</span>'+
        ' — 所持金から自動引落されます。不足時は遅延損害金が発生し、所持金を強制回収します。</div>'+
      '</div>'+
      overdueWarning+
      '<div style="font-size:.6rem;color:var(--muted);margin-top:6px;text-align:center;">返済総額: <span style="color:#fb7185;font-weight:700;">'+total.toLocaleString()+'G</span> | 年率'+Math.round(rate*100)+'% | 契約日: '+ld.contractDate+'</div>';

    actEl.innerHTML='<button onclick="loanRepay()" style="width:100%;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#4ade80,#22c55e);color:#000;font-size:.85rem;font-weight:800;cursor:pointer;">💸 返済する</button>';
  } else if(ld.status==='reviewing'){
    statusEl.innerHTML=
      '<div style="text-align:center;padding:16px;">'+
        '<div style="font-size:1.5rem;margin-bottom:6px;">🔍</div>'+
        '<div style="font-size:.8rem;font-weight:700;color:var(--cyan);">審査中...</div>'+
        '<div style="font-size:.6rem;color:var(--muted);margin-top:4px;">CIC信用情報機関に照会中です。<br>少々お待ちください。</div>'+
        '<div style="margin-top:8px;height:4px;background:var(--s2);border-radius:2px;overflow:hidden;"><div style="height:100%;width:60%;background:var(--cyan);animation:pulse 1.5s ease-in-out infinite;"></div></div>'+
      '</div>';
    actEl.innerHTML='';
  } else if(ld.status==='approved'){
    statusEl.innerHTML=
      '<div style="text-align:center;padding:10px;">'+
        '<div style="font-size:1.2rem;margin-bottom:4px;">✅</div>'+
        '<div style="font-size:.8rem;font-weight:700;color:#4ade80;">審査通過</div>'+
        '<div style="font-size:.65rem;color:var(--muted);margin-top:4px;">借入可能額: <span style="color:#4ade80;font-weight:700;">'+limit.toLocaleString()+'G</span></div>'+
        '<div style="font-size:.55rem;color:var(--muted);margin-top:2px;">年収'+income.toLocaleString()+'G × 時給'+calcWage().toLocaleString()+'G/h'+(ld.repaid?' (総量規制: 年収の1/3)':'')+'</div>'+
      '</div>';
    actEl.innerHTML='<button onclick="loanContract()" style="width:100%;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000;font-size:.85rem;font-weight:800;cursor:pointer;">📝 契約手続きへ</button>'+
      '<div style="text-align:center;margin-top:6px;font-size:.55rem;color:var(--muted);">ご利用は計画的に。</div>';
  } else {
    // Not applied
    statusEl.innerHTML=
      '<div style="text-align:center;padding:10px;">'+
        '<div style="font-size:.75rem;color:var(--muted2);margin-bottom:6px;">お借入の状況</div>'+
        (ld.repaid?
          '<div style="font-size:.65rem;color:#4ade80;">✅ 過去の完済実績あり → 借入枠UP</div><div style="font-size:.6rem;color:var(--muted);margin-top:4px;">借入可能額: <span style="color:#4ade80;font-weight:700;">'+limit.toLocaleString()+'G</span>（年収の1/3）</div>'
          :'<div style="font-size:.65rem;color:var(--muted);">初回ご利用: 10,000G 〜 50,000G</div>')+
      '</div>';
    actEl.innerHTML='<button onclick="loanApply()" style="width:100%;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#059669,#10b981);color:#fff;font-size:.85rem;font-weight:800;cursor:pointer;">📋 お申し込み</button>'+
      '<div style="text-align:center;margin-top:6px;font-size:.55rem;color:var(--muted);">ご利用は計画的に。</div>';
  }
}

// Tick loan interest on page load
function initLoanTick(){tickLoanInterest();}

// ================================================================
// ACHIEVEMENT SYSTEM
// ================================================================
const ACHIEVEMENTS = [
  {id:'ach_3day',  name:'3日連続記録',      emoji:'🔥', desc:'3日連続で時間を記録',    rew:'XP +50',  check:()=>calcStreak()>=3, reward:()=>addXPRaw(50)},
  {id:'ach_7day',  name:'1週間の習慣',      emoji:'📅', desc:'7日連続で時間を記録',    rew:'XP +150', check:()=>calcStreak()>=7, reward:()=>addXPRaw(150)},
  {id:'ach_21day', name:'習慣の定着',        emoji:'💪', desc:'21日連続で時間を記録',   rew:'XP +500 & +200G', check:()=>calcStreak()>=21, reward:()=>{addXPRaw(500);setGold(getGold()+200);}},
  {id:'ach_sleep90',name:'完璧な眠り',       emoji:'🌙', desc:'睡眠スコア90点以上を記録',rew:'XP +100', check:()=>{const d=getDayData(todayStr());return d.sleepScore&&d.sleepScore>=90;}, reward:()=>addXPRaw(100)},
  {id:'ach_1000g', name:'千金持ち',          emoji:'💰', desc:'累計1,000G稼ぐ',         rew:'XP +50',  check:()=>getTotalEarned()>=1000, reward:()=>addXPRaw(50)},
  {id:'ach_10000g',name:'万金持ち',          emoji:'💎', desc:'累計10,000G稼ぐ',        rew:'XP +200', check:()=>getTotalEarned()>=10000, reward:()=>addXPRaw(200)},
  {id:'ach_100000g',name:'大富豪',           emoji:'👑', desc:'累計100,000G稼ぐ',       rew:'+500G',   check:()=>getTotalEarned()>=100000, reward:()=>setGold(getGold()+500)},
  {id:'ach_alldom',name:'オールラウンダー',   emoji:'⚖️', desc:'全ドメインにスキルLv2以上',rew:'XP +300',check:()=>{return DOMAINS.every(d=>d.skills.some(s=>getSkillLevel(s)>=2));}, reward:()=>addXPRaw(300)},
  {id:'ach_1inv',  name:'初めての投資',      emoji:'📈', desc:'最初の投資を購入',        rew:'+100G',   check:()=>(getPortfolio().length+getREHoldings().length+getBizHoldings().length)>=1, reward:()=>setGold(getGold()+100)},
  {id:'ach_5inv',  name:'分散投資家',        emoji:'🏦', desc:'5つの投資を保有',         rew:'+500G',   check:()=>(getPortfolio().length+getREHoldings().length+getBizHoldings().length)>=5, reward:()=>setGold(getGold()+500)},
  {id:'ach_1bld',  name:'最初の建設',        emoji:'🏠', desc:'最初の建物を建設',        rew:'XP +50',  check:()=>getOwnedBuildings().length>=1, reward:()=>addXPRaw(50)},
  {id:'ach_castle',name:'城主',              emoji:'🏰', desc:'城を建設する',            rew:'XP +1000',check:()=>getOwnedBuildings().includes('b14'), reward:()=>addXPRaw(1000)},
  {id:'ach_awaken1',name:'最初の覚醒',       emoji:'✨', desc:'スキルを1つ覚醒させる',   rew:'+300G',   check:()=>getAwakenedSkills().length>=1, reward:()=>setGold(getGold()+300)},
  {id:'ach_effort100',name:'努力の100時間',  emoji:'⏰', desc:'累計努力時間100時間達成', rew:'XP +500', check:()=>{let t=0;getAllDates().forEach(d=>{t+=getEffortMins(getDayData(d).blocks);});return t>=6000;}, reward:()=>addXPRaw(500)},
  {id:'ach_gacha50',name:'ガチャ中毒',       emoji:'🎰', desc:'ガチャを50回引く',        rew:'+200G',   check:()=>(ls_get('gacha_count')||0)>=50, reward:()=>setGold(getGold()+200)},

  // Hidden achievements (description hidden until unlocked)
  {id:'ach_hidden_night',name:'???',emoji:'🌙',desc:'???',rew:'+500G',hidden:true,realName:'夜型人間',realDesc:'深夜1時以降に記録を追加',check:function(){var d=getDayData(todayStr());return d.blocks.some(function(b){return parseInt(b.start.split(':')[0])>=1&&parseInt(b.start.split(':')[0])<5;});},reward:function(){setGold(getGold()+500);}},
  {id:'ach_hidden_10h',name:'???',emoji:'⏰',desc:'???',rew:'XP +500',hidden:true,realName:'10時間戦士',realDesc:'1日に10時間以上の努力時間を記録',check:function(){var d=getDayData(todayStr());return getEffortMins(d.blocks)>=600;},reward:function(){addXPRaw(500);}},
  {id:'ach_hidden_broke',name:'???',emoji:'💸',desc:'???',rew:'+1000G',hidden:true,realName:'一文無し',realDesc:'所持金が0Gになる',check:function(){return getGold()===0;},reward:function(){setGold(getGold()+1000);}},
  {id:'ach_hidden_housing8',name:'???',emoji:'🏰',desc:'???',rew:'XP +2000',hidden:true,realName:'城主',realDesc:'住居を城にアップグレード',check:function(){return getCurrentHousing()>=8;},reward:function(){addXPRaw(2000);}},
  {id:'ach_hidden_slot777',name:'???',emoji:'🎰',desc:'???',rew:'+3000G',hidden:true,realName:'ラッキーセブン',realDesc:'スロットで7️⃣を3つ揃える',check:function(){return ls_get('slot_jackpot')||false;},reward:function(){setGold(getGold()+3000);}},
  {id:'ach_hidden_allskill',name:'???',emoji:'🌈',desc:'???',rew:'XP +3000 & +5000G',hidden:true,realName:'全知全能',realDesc:'全スキルを覚醒させる',check:function(){return getAwakenedSkills().length>=30;},reward:function(){addXPRaw(3000);setGold(getGold()+5000);}},
  {id:'ach_mystery10',name:'ナゾコレクター見習い',emoji:'🎁',desc:'ナゾガチャ10種コンプ',rew:'+100G',check:function(){return getMysteryCollection().length>=10;},reward:function(){setGold(getGold()+100);}},
  {id:'ach_mystery50',name:'ナゾマニア',emoji:'🎁',desc:'ナゾガチャ50種コンプ',rew:'+500G & XP +300',check:function(){return getMysteryCollection().length>=50;},reward:function(){setGold(getGold()+500);addXPRaw(300);}},
  {id:'ach_mystery100',name:'ナゾマスター',emoji:'🎁',desc:'ナゾガチャ100種コンプ',rew:'+2000G & XP +1000',check:function(){return getMysteryCollection().length>=100;},reward:function(){setGold(getGold()+2000);addXPRaw(1000);}},
  {id:'ach_mystery123',name:'???',emoji:'🌟',desc:'???',rew:'+5000G & XP +2000',hidden:true,realName:'ナゾの支配者',realDesc:'ナゾガチャ全123種コンプリート',check:function(){return getMysteryCollection().length>=123;},reward:function(){setGold(getGold()+5000);addXPRaw(2000);}},
  {id:'ach_pachinko_kakuhen',name:'???',emoji:'🔮',desc:'???',rew:'+500G',hidden:true,realName:'フォーチュンマスター',realDesc:'フォーチュンマシンで3連チャン以上',check:function(){return getPachinkoState().chain>=3;},reward:function(){setGold(getGold()+500);}},
  {id:'ach_pachinko_fever',name:'???',emoji:'🔮',desc:'???',rew:'+3000G & XP +1000',hidden:true,realName:'フィーバーレジェンド',realDesc:'フォーチュンマシンで7連チャン以上',check:function(){return getPachinkoState().chain>=7;},reward:function(){setGold(getGold()+3000);addXPRaw(1000);}},

  // New achievements
  {id:'ach_14day',name:'2週間の継続',emoji:'📆',desc:'14日連続で時間を記録',rew:'XP +300 & +200G',check:()=>calcStreak()>=14,reward:()=>{addXPRaw(300);setGold(getGold()+200);}},
  {id:'ach_50day',name:'50日の鉄人',emoji:'🗓️',desc:'50日連続で時間を記録',rew:'XP +2000 & +1000G',check:()=>calcStreak()>=50,reward:()=>{addXPRaw(2000);setGold(getGold()+1000);}},
  {id:'ach_lv10',name:'Lv.10到達',emoji:'⭐',desc:'プレイヤーレベル10に到達',rew:'+500G',check:()=>getLevel()>=10,reward:()=>setGold(getGold()+500)},
  {id:'ach_lv25',name:'Lv.25到達',emoji:'🌟',desc:'プレイヤーレベル25に到達',rew:'+2000G & XP +500',check:()=>getLevel()>=25,reward:()=>{setGold(getGold()+2000);addXPRaw(500);}},
  {id:'ach_effort500',name:'努力の500時間',emoji:'🏋️',desc:'累計努力時間500時間達成',rew:'XP +2000 & +1000G',check:()=>{let t=0;getAllDates().forEach(d=>{t+=getEffortMins(getDayData(d).blocks);});return t>=30000;},reward:()=>{addXPRaw(2000);setGold(getGold()+1000);}},
  {id:'ach_1000000g',name:'ミリオネア',emoji:'💎',desc:'累計1,000,000G稼ぐ',rew:'XP +1000 & +5000G',check:()=>getTotalEarned()>=1000000,reward:()=>{addXPRaw(1000);setGold(getGold()+5000);}},
  {id:'ach_awaken5',name:'五つの覚醒',emoji:'🔥',desc:'スキルを5つ覚醒させる',rew:'+1000G',check:()=>getAwakenedSkills().length>=5,reward:()=>setGold(getGold()+1000)},
  {id:'ach_awaken15',name:'覚醒の半ば',emoji:'💫',desc:'スキルを15個覚醒させる',rew:'XP +1500 & +3000G',check:()=>getAwakenedSkills().length>=15,reward:()=>{addXPRaw(1500);setGold(getGold()+3000);}},
  {id:'ach_10bld',name:'街の開拓者',emoji:'🏗️',desc:'建物を10個建設する',rew:'+500G',check:()=>getOwnedBuildings().length>=10,reward:()=>setGold(getGold()+500)},
  {id:'ach_allbld',name:'???',emoji:'🏙️',desc:'???',rew:'XP +3000 & +5000G',hidden:true,realName:'完全都市',realDesc:'全建物を建設する',check:()=>BUILDINGS.every(b=>getOwnedBuildings().includes(b.id)),reward:()=>{addXPRaw(3000);setGold(getGold()+5000);}},
  {id:'ach_debt_clear',name:'ローン完済',emoji:'🎊',desc:'初期ローンを完済する',rew:'XP +100',check:()=>isDebtPaid(),reward:()=>addXPRaw(100)},
  {id:'ach_todo3',name:'目標達成者',emoji:'📋',desc:'ToDoリストの目標を3つ達成',rew:'XP +300 & +300G',check:()=>(getTodos().filter(t=>t.done).length>=3),reward:()=>{addXPRaw(300);setGold(getGold()+300);}},
  {id:'ach_hidden_loan',name:'???',emoji:'🏦',desc:'???',rew:'+500G',hidden:true,realName:'信用取引の達人',realDesc:'消費者金融から借入する',check:function(){return getLoanData().status==='active'||getLoanData().repaid;},reward:function(){setGold(getGold()+500);}},
  {id:'ach_hidden_loan1m',name:'???',emoji:'🏦',desc:'???',rew:'+10000G & XP +2000',hidden:true,realName:'ミリオンクレジット',realDesc:'消費者金融で100万G以上を借入する',check:function(){var ld=getLoanData();return ld.borrowed>=1000000||(ld.principal&&ld.principal>=1000000);},reward:function(){setGold(getGold()+10000);addXPRaw(2000);}},
];

// raw XP add without sleep modifier (for achievement rewards)
function addXPRaw(amount){
  const prev=getTotalXP();
  setTotalXP(prev+amount);
  checkLevelUp(prev,prev+amount);
  updateNav();
}

function getUnlockedAchievements(){return ls_get('unlocked_ach')||[];}
function setUnlockedAchievements(v){ls_set('unlocked_ach',v);}

function checkAchievements(){
  const unlocked=getUnlockedAchievements();
  let newlyUnlocked=false;
  ACHIEVEMENTS.forEach(ach=>{
    if(unlocked.includes(ach.id))return;
    try{
      if(ach.check()){
        unlocked.push(ach.id);
        ach.reward();
        addEventLog('🏆 実績解除！「'+(ach.realName||ach.name)+'」 → '+ach.rew,'awakening');
        showReward(ach.emoji,'実績解除！','「'+(ach.realName||ach.name)+'」\n'+(ach.realDesc||ach.desc)+'\n\n🎁 報酬: '+ach.rew);
        newlyUnlocked=true;
      }
    }catch(e){}
  });
  if(newlyUnlocked)setUnlockedAchievements(unlocked);
}

function renderAchievements(){
  const unlocked=getUnlockedAchievements();
  const el=document.getElementById('achGrid');
  if(!el)return;
  el.innerHTML=ACHIEVEMENTS.map(function(ach){
    var isUl=unlocked.includes(ach.id);
    var isHidden=ach.hidden&&!isUl;
    var name=isHidden?'???':(ach.realName||ach.name);
    var desc=isHidden?'条件を満たすと解放されます':(ach.realDesc||ach.desc);
    var emoji=isHidden?'❓':ach.emoji;
    return '<div class="ach-card'+(isUl?' unlocked':'')+'">'+
      '<div class="ach-icon">'+emoji+'</div>'+
      '<div class="ach-info">'+
        '<div class="ach-name">'+name+(isUl?' ✓':'')+'</div>'+
        '<div class="ach-desc">'+desc+'</div>'+
        '<div class="ach-rew">🎁 '+(isHidden?'???':ach.rew)+'</div>'+
      '</div></div>';
  }).join('');

  // Rebirth status
  var rCount=getRebirthCount();
  var statusEl=document.getElementById('rebirthStatus');
  if(statusEl){
    if(rCount>0){
      var rt=getHighestRebirthTitle();
      var titles=getRebirthTitles();
      statusEl.innerHTML='<div style="font-size:1.8rem;margin-bottom:4px;">'+(rt?rt.icon:'⏳')+'</div>'+
        '<div style="color:'+(rt?rt.color:'#c084fc')+';font-weight:800;font-size:1rem;">'+rCount+'周目</div>'+
        '<div style="font-size:.65rem;color:var(--muted2);margin-top:4px;">称号: '+titles.map(function(t){return t.icon+' '+t.name;}).join(' → ')+'</div>'+
        '<div style="font-size:.65rem;color:#fcd34d;margin-top:4px;">⏰ 時給 ×'+getRebirthWageMulti().toFixed(1)+' | ⚡ XP ×'+getRebirthXPMulti().toFixed(1)+'</div>';
    } else {
      statusEl.innerHTML='<div style="font-size:1.5rem;opacity:.3;">⏳</div><div style="font-size:.7rem;color:var(--muted);">まだ転生していません</div>';
    }
  }

  // Rebirth conditions
  var condEl=document.getElementById('rebirthConditions');
  var btn=document.getElementById('rebirthBtn');
  if(condEl){
    var conds=getRebirthConditions();
    condEl.innerHTML='<div style="font-size:.65rem;color:var(--muted2);margin-bottom:6px;">転生条件:</div>'+
      conds.map(function(c){return '<div style="font-size:.7rem;padding:3px 0;color:'+(c.met?'var(--green)':'var(--muted)')+';">'+(c.met?'✅':'⬜')+' '+c.name+'</div>';}).join('');
    if(btn){
      var ready=canRebirth();
      btn.disabled=!ready;
      btn.style.opacity=ready?1:0.35;
      btn.style.cursor=ready?'pointer':'not-allowed';
      if(ready){btn.style.borderColor='rgba(192,132,252,.6)';btn.style.background='rgba(192,132,252,.2)';btn.style.boxShadow='0 0 20px rgba(192,132,252,.15)';}
    }
  }
}

// On initial collect date setup
if(!getLastCollectDate()){
  setLastCollectDate(todayStr());
}
initLoanTick();

</script>

<!-- HELP OVERLAY -->
<div class="help-overlay" id="helpOverlay">
  <div class="help-box">
    <div class="hb-title">
      <span id="helpTitleIcon" style="cursor:default;">📖 TIMEFLOW ガイド</span>
      <button class="btn sm" onclick="closeHelp()">✕ 閉じる</button>
    </div>
    <div style="margin-bottom:16px;"><button onclick="closeHelp();setTimeout(openTutorial,300);" style="width:100%;padding:12px;border:2px solid rgba(0,212,255,.3);border-radius:12px;background:linear-gradient(135deg,rgba(0,212,255,.08),rgba(168,85,247,.06));color:var(--cyan);font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s;font-family:'M PLUS Rounded 1c',sans-serif;">🎓 チュートリアルを見る</button></div>
    <div class="hb-section"><div class="hb-h">🎮 基本コンセプト</div><div class="hb-p">現実の時間記録が育成ゲームに直結する人生RPG。行動を記録するとスキルが成長し、時給が上がり、ゴールドで資産を運用できます。</div></div>
    <div class="hb-section"><div class="hb-h">📝 基本ループ</div><div class="hb-p"><span class="hb-tag">記録</span>→<span class="hb-tag">XP＆スキル成長</span>→<span class="hb-tag">時給上昇</span>→<span class="hb-tag">換金</span>→<span class="hb-tag">資産運用</span>→<span class="hb-tag">不労所得</span>のループ</div></div>
    <div class="hb-section"><div class="hb-h">⚡ 睡眠スコアとXP倍率</div>
      <table class="hb-tbl"><tr><th>睡眠スコア</th><th>XP倍率</th><th>効果</th></tr>
        <tr><td>90〜100点</td><td style="color:#4ade80">×1.5</td><td>完璧</td></tr>
        <tr><td>75〜89点</td><td style="color:#38bdf8">×1.25</td><td>良好</td></tr>
        <tr><td>60〜74点</td><td>×1.0</td><td>標準</td></tr>
        <tr><td>40〜59点</td><td style="color:#fbbf24">×0.8</td><td>不足</td></tr>
        <tr><td>0〜39点</td><td style="color:#fb7185">×0.6</td><td>危険</td></tr>
      </table>
      <div class="hb-p" style="margin-top:5px;">理想: <strong style="color:#c084fc;">23:00就寝 / 6:30起床 / 7.5h睡眠</strong></div>
    </div>
    <div class="hb-section"><div class="hb-h">💰 時給の仕組み</div>
      <div class="hb-p">時給はスキルLvの合計に応じて30段階で上昇（90G〜8,000G/h）。無職→日雇い→アルバイト→…→社長→CEO→伝説の経営者まで。「換金」ボタンでゴールドに変換できます。</div>
    </div>
    <div class="hb-section"><div class="hb-h">📈 資産運用</div>
      <div class="hb-p"><strong style="color:#38bdf8;">株式</strong>: 株価が日々変動。複数口購入・売却可能。S&P500のようにリアルな値動き。<br><strong style="color:#4ade80;">不動産</strong>: 複数物件保有可。家賃は月1回回収。物件は経年で減価し、売却時は時価。<br><strong style="color:#c084fc;">事業</strong>: 街の人口＝雇用可能人数。大企業ほど大量の従業員が必要。<br><strong style="color:#fbbf24;">生活水準</strong>: 毎日コストがかかるがXP倍率ボーナス。<br>事業収入は毎日「📥 受け取る」で獲得。</div>
    </div>
    <div class="hb-section"><div class="hb-h">🧬 スキルツリーの行動解放</div>
      <div class="hb-p">スキルLvが上がると資産運用の選択肢が解放されます。例: 戦略思考Lv2 → 株式投資が解放。スキルを育てるほどできることが増えます。</div>
    </div>
    <div class="hb-section"><div class="hb-h">💸 ローンシステム</div>
      <div class="hb-p">ゲーム開始時に5,000Gのスタートローンがあります。時間を換金すると自動的に返済に回ります。完済すると資産運用（株・不動産・事業）と街づくりが解禁されます。まずはローン返済を目指しましょう！所持金がある場合は手動で返済することもできます。</div>
    </div>
    <div class="hb-section"><div class="hb-h">🏦 消費者金融</div>
      <div class="hb-p">
        娯楽タブの「🏦 消費者金融」からお金を借りることができます。<br><br>
        <strong style="color:#fb7185;">手順</strong>: お申し込み → CIC信用情報照会（審査約3秒） → 契約 → 借入<br><br>
        <strong style="color:#fbbf24;">金利（利息制限法準拠）</strong>:<br>
        ・元本10万G未満: 年20%（日約0.0548%）<br>
        ・元本10万〜100万G未満: 年18%（日約0.0493%）<br>
        ・元本100万G以上: 年15%（日約0.0411%）<br><br>
        <strong style="color:#4ade80;">借入限度額</strong>:<br>
        ・初回: 10,000G〜50,000G<br>
        ・完済実績あり: 年収（時給×8h×265日）の1/3まで（総量規制）<br><br>
        <strong style="color:#f97316;">💳 毎月の最低返済額（重要）</strong>:<br>
        ・借入元本の <strong>4.5%</strong> が毎月の最低返済額として設定されます<br>
        ・契約日から30日ごとに、所持金から<strong>自動引き落とし</strong>されます<br>
        ・所持金が最低返済額に満たない場合：<br>
        　→ <span style="color:#fb7185;font-weight:700;">遅延損害金</span>が加算されます（回数×元本の1%）<br>
        　→ 所持金が<strong>全額強制回収</strong>されます<br>
        ・遅延を繰り返すほど損害金が膨らむため、計画的な返済が重要です<br><br>
        <span style="font-size:.6rem;color:var(--muted);">例: 100,000G借入 → 最低返済額 4,500G/月。返済時は利息→元本の順に充当されます。</span>
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">🔥 習慣チェーン＆継続ボーナス</div>
      <div class="hb-p">統計ページの「習慣チェーン」は過去56日分の記録状況を表示します。記録した日は緑色で表示されます。<br><br><strong style="color:#fbbf24;">継続ボーナス</strong>: 毎日記録するとゴールドがもらえます。連続日数が増えるほど金額がアップ！（3日で25G→7日で76G→14日で145G→30日で470G…）。「📥 受け取る」ボタンで回収してください。<br><br><strong style="color:rgba(255,255,255,0.3);">一時停止</strong>: 記録できなかった日は「一時停止」扱いです（最大3日）。ストリークは壊れません。罰もありません。再開はいつでもできます。</div>
    </div>
    <div class="hb-section"><div class="hb-h">⭐ 特別XP項目</div>
      <div class="hb-p">自分が特に重要視する行動を登録してXPボーナスを得る仕組みです。例えば「学習を120分以上」でXP×3倍、といった設定ができます。記録ページの「＋追加」から設定してください。条件を満たした記録を追加すると自動的にXPが増加します。</div>
    </div>
    <div class="hb-section"><div class="hb-h">⏩ よく使うテンプレート</div>
      <div class="hb-p">記録ページの「朝仕事 9-12」「昼食 12-13」などのボタンを押すと、時間とカテゴリが自動入力されます。毎日同じ時間に同じことをする場合に便利です。</div>
    </div>
    <div class="hb-section"><div class="hb-h">🎰 スロット・フォーチュンマシン・ガチャ</div>
      <div class="hb-p">
        <strong style="color:#fbbf24;">🎰 スロット</strong>: 80Gで回す。3つ揃い=250〜5000G、2つ揃い=20G、はずれ=-80G。777でジャックポット！<br><br>
        <strong style="color:#c084fc;">🔮 フォーチュンマシン（フィーバー・時短ルール付き）</strong><br>
        ・1回100Gで玉を打つ。ドラムが回転し、揃えば大当たり。<br>
        ・<strong style="color:#f472b6;">通常モード</strong>: 大当たり確率 1/10。当たると+500〜3000G。<br>
        ・<strong style="color:#fcd34d;">フィーバー（確率変動）</strong>: 大当たり後、50%の確率で突入。大当たり確率が 1/3 に大幅UP。さらに時短10回もセットで付与。次の大当たりまでフィーバーは継続。<br>
        ・<strong style="color:#38bdf8;">時短</strong>: フィーバー突入時に10回付与。時短中は打ち玉コストが50G（通常の半額）に。時短を使い切ると通常モードに戻る。<br>
        ・フィーバー中に大当たりすると、再び50%でフィーバーに。フィーバーループで大連チャンのチャンス！<br>
        ・リーチ（2つ揃い）ではずれた場合も慰めの+30G。<br><br>
        <strong style="color:#06b6d4;">🎁 ナゾガチャ</strong>: 50Gで「よくわからないもの」が出る。全123種コンプで実績＆特別ボーナス。10連は450G（1回分お得）。コレクション魂を刺激する。<br><br>
        <strong style="color:#a855f7;">💎 高級インテリアガチャ</strong>: 8,000Gで超レアインテリアが当たるかも。XPボーナス付きの限定品。
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">✅ デイリークエスト</div>
      <div class="hb-p">
        毎日チェックする自分だけの「やることリスト」です。<br><br>
        <strong style="color:#4ade80;">仕組み</strong>: 記録ページの下にチェックリストが表示されます。達成した項目をタップするとXPがもらえます。チェックは1日ごとにリセットされます。<br><br>
        <strong style="color:#38bdf8;">カスタマイズ</strong>: 「⚙ クエスト編集」ボタンから、項目の追加・削除・XP設定ができます。自分の習慣に合わせて自由に編集してください。最初は「とりあえず記録してみる」だけでOK。慣れてきたら少しずつ増やしましょう。<br><br>
        <strong style="color:#fbbf24;">コツ</strong>: 項目は3〜5個が続けやすい。多すぎると逆効果。「簡単にクリアできるもの」を1つ入れておくとモチベが保ちやすいです。
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">🏘️ 街づくり</div>
      <div class="hb-p">ゴールドで建物を建設すると街の人口が増えます。人口が増えると街ランクが上昇し、時給ボーナスやランクアップ報酬がもらえます。<br><br>
        <strong>街ランク一覧:</strong><br>
        🏜️ 更地(0人) → 🏕️ 集落(50人) → 🏘️ 村(120人) → 🏙️ 町(250人) → 🌆 小都市(500人) → 🌇 都市(800人) → 🌃 大都市(1200人) → 🗼 メガシティ(1800人) → 🌐 メトロポリス(2500人) → 👑 帝都(3500人) → 🌌 銀河都市(5000人)<br><br>
        ランクが上がるほど時給ボーナスが増加（最大+65%）。また事業で雇える人数は街の人口に依存するため、大きな事業には大きな街が必要です。
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">🏆 実績</div>
      <div class="hb-p">条件を満たすと実績が解除され、永続ボーナス（XP・ゴールド）が得られます。隠し実績も多数存在します。「???」は条件を満たすと正体が明かされます。ナゾガチャの10種/50種/100種/123種コンプ、フォーチュンマシンでフィーバー3連チャン以上、スロットで777なども実績に。</div>
    </div>
    <div class="hb-section"><div class="hb-h">🏠 住居・インテリア</div>
      <div class="hb-p">
        <strong style="color:#fbbf24;">住居アップグレード</strong>: 全13段階。野宿(0G)→テント(200G)→小部屋(800G)→…→城(80万G)→宮殿(200万G)→海底ドーム(500万G)→軌道上ステーション(1500万G)→異次元邸宅(5000万G)。住居が良いほどXPボーナスが増加（最大+100%）。<br><br>
        <strong style="color:#06b6d4;">インテリア</strong>: 購入可能な通常アイテム20種＋高級ガチャ専用8種。それぞれXPボーナスが付き、全て積み重ねで効果が加算されます。<br><br>
        <strong style="color:#a855f7;">高級インテリアガチャ</strong>: 10,000Gで回す。50%の確率ではずれ（一部返金）。ガチャ専用アイテムはショップでは買えない限定品。
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">👑 帝国ホールディングス — 追加投資</div>
      <div class="hb-p">
        帝国ホールディングス（150万G）を設立すると、「💰 追加投資」ボタンが出現します。<br><br>
        <strong style="color:#fcd34d;">投資額とリターン</strong>: 追加投資した金額に応じて日次リターンが増加。計算式は <code>+500 × √(投資額 ÷ 100,000)</code> G/日。<br>
        例: 10万G投資 → +500 G/日、100万G → +1,581 G/日、1000万G → +5,000 G/日<br><br>
        <strong style="color:#c084fc;">ポイント</strong>: 平方根スケーリングなので、少額でも効果があり、大金を投入しても際限なく増えることはありません。転生後も追加投資額は引き継がれます。
      </div>
    </div>
    <div class="hb-section" style="border-top:2px solid rgba(192,132,252,.3);padding-top:16px;margin-top:8px;">
      <div class="hb-h" style="color:#c084fc;">⏳ 時の遺産 — 転生システム</div>
      <div class="hb-p">
        全コンテンツを極めたプレイヤーのためのエンドコンテンツです。<br><br>
        <strong style="color:#e879f9;">転生条件</strong>: ① 住居を最大レベルまで強化、② 全建物を建設、③ 全購入可能インテリアを入手、④ 全不動産を各1件以上保有、⑤ 全事業を各1社以上設立（帝国HD含む）、⑥ 記録日数30日以上<br><br>
        <strong style="color:#fcd34d;">転生ボーナス（周回ごとに累積）</strong>:<br>
        ・時給 ×1.5（2周目）→ ×2.0（3周目）→ ×2.5（4周目）…<br>
        ・XP ×1.1（2周目）→ ×1.2（3周目）→ ×1.3（4周目）…<br>
        ・初期ゴールド: 周回数×1,000G<br><br>
        <strong style="color:#4ade80;">引き継がれるもの</strong>:<br>
        ✅ 株式ポートフォリオ（全保有株）<br>
        ✅ 帝国ホールディングス（＋追加投資額）<br>
        ✅ 全日の時間記録データ<br>
        ✅ ナゾガチャコレクション<br>
        ✅ テンプレート設定・睡眠理想値・デイリークエスト<br><br>
        <strong style="color:#fb7185;">リセットされるもの</strong>:<br>
        ❌ ゴールド（初期ボーナスで再スタート）<br>
        ❌ スキルレベル・覚醒<br>
        ❌ 建物・街ランク<br>
        ❌ 不動産・帝国以外の事業<br>
        ❌ 住居・インテリア<br>
        ❌ 実績（再取得でボーナス再獲得）<br><br>
        <strong style="color:#818cf8;">称号</strong>: 1周＝転生者、2周＝輪廻の旅人、3周＝時の支配者、5周＝永劫回帰、7周＝超越者、10周＝神<br><br>
        育成タブ → 🏆 実績 の下部にある「⏳ 転生する」ボタンから実行できます。
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">🌙 睡眠評価と時間ブロック自動連携</div>
      <div class="hb-p">
        睡眠評価で就寝・起床時刻を入力すると、「🌙 睡眠」ブロックが自動で時間ブロックに反映されます。手動入力は不要です。日をまたぐ場合は2つのブロック（就寝〜24:00 ＋ 0:00〜起床）に分割されます。「自動」タグが付いたブロックは削除不可で、睡眠評価の変更時に自動更新されます。<br><br>
        理想の睡眠時刻は「✏️」ボタンでカスタマイズ可能です。変更すると睡眠スコアの基準が更新されます。
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">⏸ 灰色自動補完（一時停止）</div>
      <div class="hb-p">
        記録できなかった日は「一時停止」扱いです。ゼロ評価ではなく「観測不能日」として処理されます。<br>
        ・継続日数: 最大3日の空白まではストリークを維持<br>
        ・平均計算: 未記録日は平均値計算から除外（スコアが下がらない）<br>
        ・グラフ: 極薄の白バー（失敗ではなく一時停止）<br>
        ・UIメッセージ: 「再開はいつでもできます」
      </div>
    </div>

    <!-- Browser Notice -->
    <div class="hb-section" style="background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.2);border-radius:10px;padding:14px;">
      <div class="hb-h" style="color:var(--cyan);">📱 データの保存について</div>
      <div class="hb-p" style="line-height:1.7;">
        TimeFlowのデータは<b>お使いのブラウザ内</b>に保存されます。<br>
        以下の場合、データにアクセスできなくなります：<br>
        <span style="color:#fb7185;">✗</span> 別のブラウザで開いた（Chrome → Safari など）<br>
        <span style="color:#fb7185;">✗</span> 別の端末で開いた（スマホ → PC など）<br>
        <span style="color:#fb7185;">✗</span> SNSアプリ内ブラウザで開いた<br>
        <span style="color:#fb7185;">✗</span> ブラウザのデータを消去した<br><br>
        <b style="color:var(--green);">💡 いつも同じブラウザで開いてください。</b><br>
        万が一に備えて、下の「データ管理」から定期的にバックアップを取ることをおすすめします。
      </div>
    </div>

    <!-- Data Management Section -->
    <div class="hb-section" style="border-top:2px solid rgba(56,189,248,.3);padding-top:16px;margin-top:8px;">
      <div class="hb-h" style="color:var(--cyan);">💾 データ管理</div>
      <div class="hb-p">バックアップの保存や、別端末へのデータ移行ができます。</div>
      <div style="background:rgba(56,189,248,.06);border:1px solid rgba(56,189,248,.15);border-radius:8px;padding:10px;margin-top:8px;margin-bottom:8px;">
        <div style="font-size:.68rem;font-weight:700;color:var(--cyan);margin-bottom:6px;">📱 スマホの方はこちら（おすすめ）</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;">
          <button onclick="exportClipboard()" style="flex:1;min-width:120px;padding:10px 14px;border:1px solid rgba(74,222,128,.4);border-radius:10px;background:rgba(74,222,128,.1);color:var(--green);font-size:.78rem;font-weight:700;cursor:pointer;">📋 コピーして保存</button>
          <button onclick="showImportPaste()" style="flex:1;min-width:120px;padding:10px 14px;border:1px solid rgba(251,191,36,.4);border-radius:10px;background:rgba(251,191,36,.1);color:var(--amber);font-size:.78rem;font-weight:700;cursor:pointer;">📋 貼り付けて復元</button>
        </div>
        <div id="pasteArea" style="display:none;margin-top:8px;">
          <textarea id="pasteInput" placeholder="コピーしたバックアップデータをここに貼り付けてください" style="width:100%;height:80px;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px;font-size:.7rem;font-family:'JetBrains Mono',monospace;resize:vertical;box-sizing:border-box;"></textarea>
          <div style="display:flex;gap:6px;margin-top:6px;">
            <button onclick="importFromPaste()" style="padding:8px 16px;border:1px solid rgba(56,189,248,.4);border-radius:8px;background:rgba(56,189,248,.15);color:var(--cyan);font-size:.72rem;font-weight:700;cursor:pointer;">復元する</button>
            <button onclick="document.getElementById('pasteArea').style.display='none'" style="padding:8px 16px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--muted);font-size:.72rem;cursor:pointer;">キャンセル</button>
          </div>
        </div>
      </div>
      <div style="font-size:.62rem;color:var(--muted2);margin-bottom:8px;">💻 PCの方はファイル形式も使えます：</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button onclick="exportData()" style="flex:1;min-width:140px;padding:10px 14px;border:1px solid rgba(56,189,248,.25);border-radius:10px;background:rgba(56,189,248,.06);color:var(--cyan);font-size:.75rem;font-weight:700;cursor:pointer;transition:all .2s;">📤 ファイルで保存</button>
        <button onclick="document.getElementById('importFile').click()" style="flex:1;min-width:140px;padding:10px 14px;border:1px solid rgba(168,85,247,.25);border-radius:10px;background:rgba(168,85,247,.06);color:#c084fc;font-size:.75rem;font-weight:700;cursor:pointer;transition:all .2s;">📥 ファイルで復元</button>
        <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
      </div>
      <div id="dataManageMsg" style="margin-top:8px;font-size:.7rem;color:var(--muted);"></div>
      <div style="margin-top:10px;font-size:.62rem;color:var(--muted2);line-height:1.6;">
        <b>📋 コピーして保存:</b> データをクリップボードにコピー → メモアプリやLINEの自分宛てに貼り付け<br>
        <b>📋 貼り付けて復元:</b> 保存したテキストをコピー → 貼り付けて復元<br>
        <b>💡 おすすめ:</b> 週に1回はバックアップを取りましょう。
      </div>
    </div>

    <div class="hb-section" id="debugSection" style="border-top:2px solid rgba(245,158,11,.3);padding-top:16px;margin-top:8px;display:none;">
      <div style="margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid rgba(239,68,68,.2);">
        <div class="hb-h" style="color:#fb7185;">⚠ データリセット</div>
        <div class="hb-p">すべてのセーブデータを削除して最初からやり直します。この操作は取り消せません。</div>
        <button onclick="showResetConfirm()" id="resetBtn1" style="margin-top:10px;padding:10px 24px;border:2px solid #ef4444;border-radius:10px;background:rgba(239,68,68,.15);color:#fb7185;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s;">🗑 全データをリセットして最初から</button>
        <div id="resetConfirmArea" style="display:none;margin-top:10px;"></div>
      </div>
      <div class="hb-h" style="color:#fbbf24;">🔧 デバッグツール</div>
      <div class="hb-p">テスト用にゴールドやXPを追加できます。</div>
      <div style="margin-bottom:10px;">
        <div style="font-size:.65rem;color:var(--muted2);margin-bottom:4px;">⚡ XPレート（スキル成長速度）</div>
        <div style="display:flex;gap:4px;">
          <button class="xprate-btn tstep-btn" data-mode="easy" onclick="setXPRate('easy')" style="flex:1;">ゆるめ ×0.5</button>
          <button class="xprate-btn tstep-btn" data-mode="normal" onclick="setXPRate('normal')" style="flex:1;">ふつう ×1.0</button>
          <button class="xprate-btn tstep-btn" data-mode="hard" onclick="setXPRate('hard')" style="flex:1;">ハード ×2.0</button>
        </div>
        <div style="font-size:.52rem;color:var(--muted);margin-top:3px;">ゆるめ=のんびり成長 / ハード=爆速成長（記録時間あたりのXP量が変わります）</div>
      </div>
      <script>document.querySelectorAll('.xprate-btn').forEach(function(b){b.classList.toggle('active',b.dataset.mode===xpRateMode);});</script>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;">
        <button onclick="setGold(getGold()+10000);updateNav();renderEconomy();toast('💰 +10,000G')" style="padding:7px 14px;border:1px solid rgba(245,158,11,.4);border-radius:8px;background:rgba(245,158,11,.1);color:#fbbf24;font-size:.72rem;font-weight:700;cursor:pointer;">+10,000G</button>
        <button onclick="setGold(getGold()+100000);updateNav();renderEconomy();toast('💰 +100,000G')" style="padding:7px 14px;border:1px solid rgba(245,158,11,.4);border-radius:8px;background:rgba(245,158,11,.1);color:#fbbf24;font-size:.72rem;font-weight:700;cursor:pointer;">+100,000G</button>
        <button onclick="setGold(getGold()+1000000);updateNav();renderEconomy();toast('💰 +1,000,000G')" style="padding:7px 14px;border:1px solid rgba(245,158,11,.4);border-radius:8px;background:rgba(245,158,11,.1);color:#fbbf24;font-size:.72rem;font-weight:700;cursor:pointer;">+1,000,000G</button>
        <button onclick="addXPRaw(1000);updateNav();toast('⚡ +1,000XP')" style="padding:7px 14px;border:1px solid rgba(74,222,128,.4);border-radius:8px;background:rgba(74,222,128,.1);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">+1,000XP</button>
        <button onclick="addXPRaw(5000);updateNav();toast('⚡ +5,000XP')" style="padding:7px 14px;border:1px solid rgba(74,222,128,.4);border-radius:8px;background:rgba(74,222,128,.1);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">+5,000XP</button>
        <button onclick="addXPRaw(20000);updateNav();toast('⚡ +20,000XP')" style="padding:7px 14px;border:1px solid rgba(74,222,128,.4);border-radius:8px;background:rgba(74,222,128,.1);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">+20,000XP</button>
        <button onclick="addXPRaw(100000);updateNav();toast('⚡ +100,000XP')" style="padding:7px 14px;border:1px solid rgba(74,222,128,.4);border-radius:8px;background:rgba(74,222,128,.1);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">+100,000XP</button>
      </div>
      <button onclick="showEconomySim()" style="margin-top:10px;padding:8px 18px;border:1px solid rgba(56,189,248,.4);border-radius:8px;background:rgba(56,189,248,.1);color:var(--cyan);font-size:.72rem;font-weight:700;cursor:pointer;">📊 完了シミュレーター</button>
      <div id="econSimResult" style="margin-top:10px;font-size:.65rem;color:var(--muted2);line-height:1.8;max-height:300px;overflow-y:auto;"></div>
    </div>
  </div>
</div>
<!-- Sleep Ideal Editor Modal -->
<div class="modal" id="sleepIdealModal">
  <div class="modal-box" style="max-width:350px;">
    <div class="modal-hd">🌙 睡眠の理想値を編集<button class="modal-close" onclick="closeModal('sleepIdealModal')">×</button></div>
    <div style="font-size:.68rem;color:var(--muted2);margin-bottom:12px;">睡眠スコアの基準となる理想的な就寝・起床時刻を設定します。</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
      <div><div class="inp-lbl">理想の就寝</div><input type="time" id="idealSleepInput" value="23:00" step="600" style="width:100%;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px;font-size:.85rem;font-family:'JetBrains Mono',monospace;"></div>
      <div><div class="inp-lbl">理想の起床</div><input type="time" id="idealWakeInput" value="06:30" step="600" style="width:100%;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px;font-size:.85rem;font-family:'JetBrains Mono',monospace;"></div>
    </div>
    <button class="btn" onclick="saveSleepIdeals()" style="width:100%;background:linear-gradient(135deg,#818cf8,#6366f1);color:#fff;padding:10px;font-weight:700;">保存</button>
  </div>
</div>

<!-- Template Editor Modal -->
<div class="modal" id="tplEditorModal">
  <div class="modal-box" style="max-width:420px;">
    <div class="modal-hd">✏️ テンプレート編集<button class="modal-close" onclick="closeModal('tplEditorModal')">×</button></div>
    <div style="font-size:.68rem;color:var(--muted2);margin-bottom:10px;">「よく使う」テンプレートをカスタマイズ。</div>
    <div id="tplEditorList" style="max-height:200px;overflow-y:auto;margin-bottom:10px;"></div>
    <div style="font-size:.65rem;color:var(--muted2);margin-bottom:6px;">新しいテンプレートを追加:</div>
    <div style="display:flex;gap:4px;flex-wrap:wrap;align-items:center;">
      <input type="text" id="tplLabel" placeholder="ラベル名" style="flex:1;min-width:80px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 8px;font-size:.72rem;">
      <input type="time" id="tplStart" value="09:00" step="600" style="width:75px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;">
      <input type="time" id="tplEnd" value="12:00" step="600" style="width:75px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;">
      <select id="tplCat" style="background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;"></select>
      <button class="btn sm" onclick="addTpl()">追加</button>
    </div>
    <script>document.getElementById('tplCat').innerHTML=Object.keys(CATS).map(function(c){return '<option value="'+c+'">'+c+'</option>';}).join('');</script>
  </div>
</div>

<!-- Day Template Manager Modal -->
<div class="modal" id="dayTplModal">
  <div class="modal-box" style="max-width:500px;">
    <div class="modal-hd">📅 一日テンプレート管理<button class="modal-close" onclick="closeModal('dayTplModal')">×</button></div>
    <div style="font-size:.68rem;color:var(--muted2);margin-bottom:12px;line-height:1.6;">
      一日の行動パターンを保存して、ワンボタンで適用できます。<br>平日用・土日用など、複数パターンを作成可能です。
    </div>
    <div id="dayTplList" style="max-height:300px;overflow-y:auto;margin-bottom:14px;"></div>
    <div style="border-top:1px solid var(--border);padding-top:12px;">
      <div style="font-size:.7rem;font-weight:700;color:var(--text);margin-bottom:8px;">新しいテンプレートを作成</div>
      <div style="display:flex;gap:6px;align-items:center;margin-bottom:8px;">
        <input type="text" id="dayTplName" placeholder="テンプレート名（例: 平日用）" style="flex:1;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px 10px;font-size:.75rem;">
      </div>
      <div style="display:flex;gap:6px;">
        <button class="btn sm" onclick="saveDayTplFromCurrent()" style="border-color:var(--cyan);color:var(--cyan);flex:1;">📝 今日の記録から作成</button>
        <button class="btn sm" onclick="saveDayTplEmpty()" style="border-color:var(--amber);color:var(--amber);">空で作成</button>
      </div>
    </div>
  </div>
</div>

<!-- Day Template Edit Modal -->
<div class="modal" id="dayTplEditModal">
  <div class="modal-box" style="max-width:500px;">
    <div class="modal-hd"><span id="dayTplEditTitle">テンプレート編集</span><button class="modal-close" onclick="closeModal('dayTplEditModal')">×</button></div>
    <div id="dayTplEditList" style="max-height:280px;overflow-y:auto;margin-bottom:12px;"></div>
    <div style="border-top:1px solid var(--border);padding-top:10px;">
      <div style="font-size:.65rem;color:var(--muted2);margin-bottom:6px;">ブロックを追加:</div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;align-items:center;">
        <input type="time" id="dtplNewStart" value="09:00" step="600" style="width:80px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;">
        <span style="color:var(--muted);">〜</span>
        <input type="time" id="dtplNewEnd" value="12:00" step="600" style="width:80px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;">
        <select id="dtplNewCat" style="background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;"></select>
        <button class="btn sm" onclick="addBlockToDayTpl()" style="border-color:var(--green);color:var(--green);">＋</button>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn sm" onclick="closeModal('dayTplEditModal')" style="flex:1;">✕ 閉じる</button>
    </div>
  </div>
</div>

<!-- Quest Editor Modal -->
<div class="modal" id="questModal">
  <div class="modal-box" style="max-width:450px;">
    <div class="modal-hd">⚙ デイリークエスト編集<button class="modal-close" onclick="closeModal('questModal')">×</button></div>
    <div style="font-size:.68rem;color:var(--muted2);margin-bottom:10px;">毎日チェックする項目を設定。クリアするとXPがもらえます。</div>
    <div style="display:flex;flex-direction:column;gap:6px;" id="questEditorList"></div>
    <div style="margin-top:10px;display:flex;gap:6px;">
      <input type="text" id="newQuestName" placeholder="新しいクエスト名" style="flex:1;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:6px 8px;font-size:.75rem;">
      <input type="number" id="newQuestXP" placeholder="XP" value="10" style="width:60px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:6px 8px;font-size:.75rem;">
      <button class="btn sm" onclick="addQuest()">追加</button>
    </div>
  </div>
</div>
<!-- ==================== BROWSER NOTICE MODAL ==================== -->
<div class="tut-overlay" id="browserNoticeOverlay">
  <div class="tut-card">
    <div class="tut-inner">
      <div class="tut-emoji">📱</div>
      <div class="tut-title">データの保存について<br><span style="font-size:.7rem;color:var(--green);">— はじめにお読みください —</span></div>
      <div class="tut-desc" style="text-align:left;padding:0 8px;">
        TimeFlowのデータは<strong>今お使いのブラウザ内</strong>に保存されます。<br><br>
        そのため、以下の場合は<strong style="color:#fb7185;">データにアクセスできなくなります</strong>：<br><br>
        <span style="display:flex;align-items:center;gap:6px;margin:3px 0;"><span style="color:#fb7185;font-weight:800;">✗</span> 別のブラウザで開いた（Chrome → Safari など）</span>
        <span style="display:flex;align-items:center;gap:6px;margin:3px 0;"><span style="color:#fb7185;font-weight:800;">✗</span> 別の端末で開いた（スマホ → PC など）</span>
        <span style="display:flex;align-items:center;gap:6px;margin:3px 0;"><span style="color:#fb7185;font-weight:800;">✗</span> X（Twitter）やLINEのアプリ内で開いた</span>
        <span style="display:flex;align-items:center;gap:6px;margin:3px 0;"><span style="color:#fb7185;font-weight:800;">✗</span> ブラウザのデータ・キャッシュを消去した</span>
        <br>
        <div style="background:rgba(0,255,136,.06);border:1px solid rgba(0,255,136,.2);border-radius:10px;padding:10px 12px;margin:4px 0;">
          <strong style="color:var(--green);">💡 おすすめの使い方</strong><br>
          <span style="font-size:.68rem;line-height:1.7;">
            ① <strong>いつも同じブラウザ</strong>（Chrome等）で開く<br>
            ② ホーム画面にブックマーク追加するとアプリ感覚で使える<br>
            ③ 📖ガイド内の「💾 データ管理」から<strong>週1バックアップ</strong>で安心
          </span>
        </div>
      </div>
      <div class="tut-btns" style="margin-top:16px;">
        <button class="tut-btn primary" onclick="closeBrowserNotice()">OK、わかった 👍</button>
      </div>
    </div>
  </div>
</div>
<script>
function closeBrowserNotice(){
  document.getElementById('browserNoticeOverlay').classList.remove('show');
  localStorage.setItem('tf_browser_notice_done','1');
  // After closing browser notice, show tutorial if first visit
  if(!localStorage.getItem('tf_tutorial_done')){
    setTimeout(function(){ openTutorial(); }, 400);
  }
}
</script>
<!-- ==================== TUTORIAL OVERLAY ==================== -->
<div class="tut-overlay" id="tutOverlay">
  <div class="tut-card">
    <div class="tut-inner">
      <div class="tut-step-indicator" id="tutDots"></div>
      <div class="tut-emoji" id="tutEmoji"></div>
      <div class="tut-title" id="tutTitle"></div>
      <div class="tut-desc" id="tutDesc"></div>
      <div class="tut-btns">
        <button class="tut-btn skip" id="tutSkip" onclick="closeTutorial()">スキップ</button>
        <button class="tut-btn secondary" id="tutPrev" onclick="tutPrev()">← 戻る</button>
        <button class="tut-btn primary" id="tutNext" onclick="tutNext()">次へ →</button>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
var TUT_STEPS = [
  {
    emoji:'👁️',
    title:'まず、自分の一日を「見る」ことから',
    desc:'あなたは昨日、何に何時間使いましたか？<br>正確に答えられる人はほとんどいません。<br><br>TIMEFLOWの出発点は<strong>「記録すること」</strong>です。<br>計画を立てるのではなく、まず<strong>自分の現実を正確に知る</strong>。<br><br>一日を俯瞰できるようになると、<br>何を変えるべきかが<strong>自然と見えてきます</strong>。'
  },
  {
    emoji:'📝',
    title:'① 記録する — ただ事実を残すだけ',
    desc:'<span class="th">📝 記録</span> ページで、<strong>何をしたか・いつ・どれだけ</strong>を入力します。<br><br>タイムラインとドーナツグラフで、一日の全体像が一目でわかる。<br>「思ったより仕事してない」「休憩が多い」「移動に2時間も…」<br><br>この<strong>気づき</strong>がすべての改善の起点です。<br>完璧に記録する必要はありません。ざっくりでOKです。'
  },
  {
    emoji:'📊',
    title:'② 俯瞰する — スコアで自分を客観視',
    desc:'<span class="th">📊 統計</span> ページで、日々の記録が<strong>グラフとスコア</strong>になります。<br><br>カテゴリ別の推移、努力時間の日足・週足、56日分の習慣グリッド。<br><br>昨日の自分と、先週の自分を比較する。<br>「なんとなく頑張った」を<strong>「数字で見える成長」</strong>に変える。<br><br>スコアが上がれば嬉しいし、下がれば気づける。<br>これが<strong>改善のサイクル</strong>の始まりです。'
  },
  {
    emoji:'😴',
    title:'③ 睡眠 — すべての努力の土台',
    desc:'どれだけ頑張っても、睡眠が崩れたら効率は落ちます。<br><br>就寝・起床時刻を入力すると<strong>睡眠スコア</strong>（0〜100点）が算出。<br>理想は <span class="tg">23:00就寝 / 6:30起床 / 7.5h</span> で90点超え。<br><br>スコアが<strong>XP倍率</strong>に直結するので：<br>90点 → <span class="tg">×1.5</span>　75点 → <span class="tg">×1.25</span>　60点未満 → <span class="tr">×0.8</span><br><br>「早く寝た方が得」と体で覚える仕組みです。'
  },
  {
    emoji:'🔁',
    title:'④ 記録するだけで報酬が生まれる',
    desc:'記録するたびに <span class="tg">XP</span> が増え、スキルが伸び、グラフが動く。<br><br>「今日も記録した」という小さな行為自体が<strong>達成感</strong>になる。<br>外部のご褒美ではなく、<strong>行為そのものに喜びを感じる</strong>状態。<br><br>これが<strong>内発的動機</strong>です。<br>やらされるのではなく、やりたくなる。<br>記録が習慣になった時、努力も自然についてきます。'
  },
  {
    emoji:'🧬',
    title:'⑤ システムが改善を後押しする',
    desc:'<span class="th">🎮 育成</span> ページで、記録が<strong>30種のスキル</strong>に自動変換されます。<br><br><div class="tut-flow"><span class="tf-node">記録する</span><span class="tf-arrow">→</span><span class="tf-node">スキル成長</span><span class="tf-arrow">→</span><span class="tf-node">時給UP</span><span class="tf-arrow">→</span><span class="tf-node">換金</span><span class="tf-arrow">→</span><span class="tf-node">ゴールド獲得</span></div><br>どのスキルが伸びていて、どこが足りないかが一目瞭然。<br><br>⭐ <strong>特別XP項目</strong>で重点分野にボーナスを設定<br>📋 <strong>デイリークエスト</strong>で小さな行動をチェック<br>📅 <strong>一日テンプレ</strong>で理想の一日パターンを適用<br><br>スコアとシステムが、次の一手を示してくれます。'
  },
  {
    emoji:'🏗️',
    title:'⑥ 続けた先に広がるおまけの世界',
    desc:'ゴールドが貯まると、<strong>おまけ要素</strong>が解禁されます：<br><br>📈 <strong>資産運用</strong> — 株・不動産・事業で不労所得<br>🏘️ <strong>街づくり</strong> — 54種の建物で自分だけの街を発展<br>🎰 <strong>娯楽</strong> — スロット、フォーチュンマシン、コレクション<br>🏆 <strong>隠し実績</strong> — 条件不明の???を発見する楽しみ<br><br>これらは努力の<strong>副産物</strong>。記録を続けた人だけが遊べる世界です。'
  },
  {
    emoji:'🔥',
    title:'さあ、今日を記録しよう。',
    desc:'TIMEFLOWに正解はありません。<br><br>大事なのは<strong>「完璧な一日を過ごすこと」ではなく、<br>「自分の一日を見ること」</strong>です。<br><br><div class="tut-flow"><span class="tf-node">記録する</span><span class="tf-arrow">→</span><span class="tf-node">俯瞰する</span><span class="tf-arrow">→</span><span class="tf-node">気づく</span><span class="tf-arrow">→</span><span class="tf-node">少しだけ変える</span></div><br>見えるから変えられる。変わるから続けたくなる。<br><br>まずは今日の行動を、1つ記録してみてください。<br><br><strong style="color:var(--cyan);">ヘルプは右上の ? からいつでも確認できます。</strong>'
  }
];

var tutStep = 0;

function renderTut(){
  var s = TUT_STEPS[tutStep];
  document.getElementById('tutEmoji').textContent = s.emoji;
  document.getElementById('tutTitle').textContent = s.title;
  document.getElementById('tutDesc').innerHTML = s.desc;
  // dots
  var dots = '';
  for(var i=0;i<TUT_STEPS.length;i++){
    var cls = i<tutStep?'tut-dot done':i===tutStep?'tut-dot active':'tut-dot';
    dots += '<div class="'+cls+'"></div>';
  }
  document.getElementById('tutDots').innerHTML = dots;
  // buttons
  document.getElementById('tutPrev').style.display = tutStep===0?'none':'inline-block';
  if(tutStep === TUT_STEPS.length-1){
    document.getElementById('tutNext').textContent = 'はじめる！ 🎮';
    document.getElementById('tutSkip').style.display = 'none';
  } else {
    document.getElementById('tutNext').textContent = '次へ →';
    document.getElementById('tutSkip').style.display = 'inline-block';
  }
}

window.tutNext = function(){
  if(tutStep < TUT_STEPS.length-1){
    tutStep++;
    renderTut();
  } else {
    closeTutorial();
  }
};
window.tutPrev = function(){
  if(tutStep > 0){
    tutStep--;
    renderTut();
  }
};
window.closeTutorial = function(){
  document.getElementById('tutOverlay').classList.remove('show');
  localStorage.setItem('tf_tutorial_done','1');
};
window.openTutorial = function(){
  tutStep = 0;
  renderTut();
  document.getElementById('tutOverlay').classList.add('show');
};

// Auto-show on first visit: browser notice first, then tutorial
if(!localStorage.getItem('tf_browser_notice_done')){
  setTimeout(function(){
    document.getElementById('browserNoticeOverlay').classList.add('show');
  }, 800);
} else if(!localStorage.getItem('tf_tutorial_done')){
  setTimeout(function(){
    openTutorial();
  }, 800);
}
})();
</script>
<script>
(function(){
  var debugTaps=0;
  var debugTimer=null;
  var debugActive=localStorage.getItem('tf_debug')==='1';
  if(debugActive){
    var ds=document.getElementById('debugSection');
    if(ds)ds.style.display='block';
  }
  document.getElementById('helpTitleIcon').addEventListener('click',function(){
    debugTaps++;
    clearTimeout(debugTimer);
    debugTimer=setTimeout(function(){debugTaps=0;},2000);
    if(debugTaps>=7){
      debugTaps=0;
      debugActive=!debugActive;
      localStorage.setItem('tf_debug',debugActive?'1':'0');
      var ds=document.getElementById('debugSection');
      if(ds)ds.style.display=debugActive?'block':'none';
      if(debugActive){
        toast('🔧 デバッグモード ON');
      } else {
        toast('🔧 デバッグモード OFF');
      }
    }
  });
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TIMEFLOW</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=DotGothic16&family=M+PLUS+Rounded+1c:wght@300;400;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

:root {
  --bg:#0c0f1a; --s1:#111827; --s2:#1a2236; --s3:#212f47;
  --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.14);
  --text:#dce8f8; --muted:#4a6080; --muted2:#7a9ab8;
  --cyan:#38bdf8; --green:#4ade80; --amber:#fbbf24;
  --violet:#c084fc; --rose:#fb7185; --orange:#fb923c;
  --pixel:#1a2820; --gold:#f59e0b; --gold2:#fcd34d;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'M PLUS Rounded 1c',sans-serif;min-height:100vh;overflow-x:hidden;}

/* ===== NAV ===== */
.nav{
  position:fixed;top:0;left:0;right:0;z-index:100;
  background:rgba(12,15,26,0.92);backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 24px;height:56px;gap:8px;
}
.nav-logo{font-family:'DotGothic16',monospace;font-size:1.1rem;color:var(--cyan);letter-spacing:0.05em;margin-right:16px;}
.nav-tabs{display:flex;gap:4px;flex:1;}
.ntab{
  background:transparent;border:none;
  padding:6px 18px;border-radius:8px;
  color:var(--muted2);cursor:pointer;
  font-family:'M PLUS Rounded 1c',sans-serif;font-size:0.82rem;font-weight:700;
  transition:all 0.2s;position:relative;
}
.ntab.active{background:var(--s2);color:var(--text);border:1px solid var(--border2);}
.ntab:hover:not(.active){background:var(--s1);color:var(--text);}
.ntab .badge{
  position:absolute;top:-4px;right:-4px;
  background:var(--amber);color:#000;
  font-size:0.55rem;font-weight:800;padding:1px 5px;border-radius:10px;
  font-family:'JetBrains Mono',monospace;
}
.nav-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.xp-pill{
  background:var(--s2);border:1px solid rgba(74,222,128,0.3);
  border-radius:20px;padding:4px 14px;
  font-family:'JetBrains Mono',monospace;font-size:0.75rem;
  display:flex;align-items:center;gap:6px;
}
.xp-num{color:var(--green);font-weight:700;}
.streak-pill{
  background:var(--s2);border:1px solid rgba(251,191,36,0.3);
  border-radius:20px;padding:4px 12px;
  font-family:'JetBrains Mono',monospace;font-size:0.75rem;
  color:var(--amber);font-weight:700;
}

/* ===== PAGES ===== */
.page{display:none;padding-top:72px;min-height:100vh;}
.page.active{display:block;}
.wrap{max-width:1360px;margin:0 auto;padding:20px 24px;}

/* ===== CARDS ===== */
.card{background:var(--s1);border:1px solid var(--border);border-radius:16px;padding:18px;}
.card-hd{font-size:0.65rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:14px;display:flex;align-items:center;gap:7px;}
.card-hd-dot{width:5px;height:5px;border-radius:50%;background:var(--cyan);flex-shrink:0;}

/* ===== BUTTONS ===== */
.btn{background:var(--s2);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:8px 16px;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;font-size:0.82rem;font-weight:700;transition:all 0.15s;}
.btn:hover{background:var(--s3);border-color:var(--border2);}
.btn.primary{background:linear-gradient(135deg,#38bdf8,#818cf8);border:none;color:#fff;}
.btn.primary:hover{opacity:0.9;transform:translateY(-1px);box-shadow:0 4px 20px rgba(56,189,248,0.3);}
.btn.green{background:linear-gradient(135deg,#4ade80,#22d3ee);border:none;color:#000;font-weight:800;}
.btn.amber{background:linear-gradient(135deg,#fbbf24,#fb923c);border:none;color:#000;font-weight:800;}
.btn.sm{padding:5px 12px;font-size:0.75rem;}

/* inputs */
input[type=time],select.sel,input[type=text],input[type=number]{
  background:var(--s2);border:1px solid var(--border);border-radius:8px;
  color:var(--text);padding:8px 10px;
  font-family:'M PLUS Rounded 1c',sans-serif;font-size:0.85rem;
  transition:border-color 0.15s;width:100%;
}
input[type=time]:focus,select.sel:focus,input[type=text]:focus,input[type=number]:focus{outline:none;border-color:var(--cyan);box-shadow:0 0 0 2px rgba(56,189,248,0.12);}
select.sel{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='7'%3E%3Cpath d='M0 0l5 7 5-7z' fill='%234a6080'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:28px;cursor:pointer;}
.inp-lbl{font-size:0.68rem;color:var(--muted2);margin-bottom:4px;font-family:'JetBrains Mono',monospace;}

/* ===== PAGE 1: RECORD ===== */
.p1-grid{display:grid;grid-template-columns:400px 1fr;gap:16px;}
.input-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
.add-btn{width:100%;margin-top:8px;background:linear-gradient(135deg,#38bdf8,#818cf8);border:none;border-radius:10px;color:#fff;font-weight:800;font-size:0.9rem;padding:11px;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;transition:all 0.2s;letter-spacing:0.02em;}
.add-btn:hover{opacity:0.9;transform:translateY(-1px);box-shadow:0 4px 20px rgba(56,189,248,0.3);}
.quick-adds{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;}
.time-sel{background:var(--s2);border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px 12px;font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;width:100%;appearance:none;-webkit-appearance:none;cursor:pointer;}
.time-sel:focus{outline:none;border-color:var(--cyan);box-shadow:0 0 0 2px rgba(56,189,248,.12);}
.time-sel option{background:#111827;color:#e2e8f0;padding:4px 8px;}
.time-sel option.hr-mark{color:#38bdf8;font-weight:800;}
.tstep-btn{padding:4px 10px;border:1px solid var(--border);border-radius:6px;background:var(--s2);color:var(--muted);font-size:.62rem;font-weight:600;cursor:pointer;transition:all .15s;}
.tstep-btn.active{background:rgba(56,189,248,.15);border-color:rgba(56,189,248,.4);color:var(--cyan);font-weight:700;}
.tstep-btn:hover{border-color:var(--cyan);}
.qa-chip{background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:3px 10px;font-size:0.7rem;color:var(--muted2);cursor:pointer;transition:all 0.15s;}
.qa-chip:hover{border-color:var(--cyan);color:var(--text);background:var(--s3);}
.tl-wrap{position:relative;height:38px;background:var(--bg);border-radius:8px;overflow:hidden;margin:10px 0 4px;border:1px solid var(--border);}
.tl-seg{position:absolute;top:0;height:100%;opacity:0.85;cursor:pointer;transition:opacity 0.15s;}
.tl-seg:hover{opacity:1;}
.tl-ticks{display:flex;justify-content:space-between;padding:0 2px;}
.tl-tick{font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--muted);}
.blist{max-height:200px;overflow-y:auto;margin-top:8px;}
.blist::-webkit-scrollbar{width:3px;}
.blist::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.bitem{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:8px;background:var(--s2);border:1px solid var(--border);margin-bottom:4px;animation:popIn 0.2s cubic-bezier(0.34,1.56,0.64,1);cursor:pointer;transition:border-color .15s;}
.bitem:hover{border-color:var(--border2);}
.bitem.editing{border-color:var(--cyan);background:var(--s3);}
.bedit-row{display:flex;gap:4px;align-items:center;margin-top:5px;}
.bedit-row input,.bedit-row select{background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:4px 6px;font-size:.68rem;font-family:'JetBrains Mono',monospace;}
.bedit-row input[type=time]{width:80px;}
.bedit-row button{padding:3px 10px;border:none;border-radius:6px;font-size:.65rem;font-weight:700;cursor:pointer;transition:all .15s;}
.bedit-save{background:var(--cyan);color:#000;}
.bedit-cancel{background:var(--s2);color:var(--muted2);border:1px solid var(--border)!important;}
/* day template presets */
.daytpl-bar{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:8px;align-items:center;}
.daytpl-chip{padding:5px 12px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--muted2);font-size:.68rem;font-weight:700;cursor:pointer;transition:all .15s;}
.daytpl-chip:hover{border-color:var(--cyan);color:var(--text);background:var(--s3);}
.daytpl-chip.active{border-color:var(--cyan);color:var(--cyan);background:rgba(0,212,255,.08);}
@keyframes popIn{from{opacity:0;transform:scale(0.9) translateY(-4px);}to{opacity:1;transform:scale(1) translateY(0);}}
.bdot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.binfo{flex:1;}
.bcat{font-size:0.8rem;font-weight:700;}
.btime{font-size:0.68rem;color:var(--muted2);font-family:'JetBrains Mono',monospace;}
.bdel{background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.9rem;padding:3px 6px;border-radius:4px;transition:all 0.15s;}
.bdel:hover{background:var(--rose);color:#fff;}

/* sleep */
.sleep-grid{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center;}
.sleep-arc-wrap{position:relative;width:88px;height:88px;}
.sleep-arc-wrap svg{width:88px;height:88px;}
.sleep-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.sleep-num{font-family:'JetBrains Mono',monospace;font-size:1.4rem;font-weight:700;}
.sleep-unit{font-size:0.58rem;color:var(--muted2);}
.sleep-inputs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
.sleep-band{height:5px;background:var(--bg);border-radius:3px;overflow:hidden;}
.sleep-band-fill{height:100%;border-radius:3px;transition:width 0.6s ease,background 0.4s;}
.sleep-msg{font-size:0.72rem;margin-top:5px;font-weight:700;}

/* special xp items */
.special-list{display:flex;flex-direction:column;gap:8px;}
.special-item{display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--s2);border:1px solid var(--border);border-radius:10px;}
.special-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.special-info{flex:1;}
.special-name{font-size:0.82rem;font-weight:700;}
.special-meta{font-size:0.68rem;color:var(--muted2);}
.special-xp{font-family:'JetBrains Mono',monospace;font-size:0.78rem;color:var(--amber);font-weight:700;}
.special-del{background:none;border:none;color:var(--muted);cursor:pointer;padding:2px 6px;border-radius:4px;transition:all 0.15s;}
.special-del:hover{background:var(--rose);color:#fff;}

/* right col */
.right-col{display:flex;flex-direction:column;gap:14px;}
.metrics-row{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.metric-card{background:var(--s1);border:1px solid var(--border);border-radius:12px;padding:14px 16px;transition:all 0.2s;}
.metric-card:hover{border-color:var(--border2);transform:translateY(-1px);}
.metric-val{font-family:'JetBrains Mono',monospace;font-size:1.7rem;font-weight:700;line-height:1;}
.metric-lbl{font-size:0.68rem;color:var(--muted2);margin-top:3px;}
.metric-trend{font-size:0.68rem;margin-top:5px;}
.pie-row{display:flex;gap:14px;align-items:center;flex-wrap:wrap;}
.pie-pos{position:relative;height:220px;width:220px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.pie-mid{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none;}
.pie-mid-h{font-family:'JetBrains Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--cyan);}
.pie-mid-l{font-size:0.65rem;color:var(--muted2);}
.legend{display:flex;flex-direction:column;gap:5px;}
.leg-item{display:flex;align-items:center;gap:6px;font-size:0.73rem;}
.leg-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.leg-name{flex:1;color:var(--muted2);}
.leg-val{font-family:'JetBrains Mono',monospace;font-size:0.7rem;}
.leg-bar{height:2px;border-radius:2px;margin-top:2px;transition:width 0.5s ease;}
.effort-banner{background:linear-gradient(90deg,#071a10,var(--s1));border:1px solid rgba(74,222,128,0.2);border-radius:12px;padding:14px 18px;display:flex;align-items:center;gap:18px;}
.effort-big{font-family:'JetBrains Mono',monospace;font-size:2.3rem;font-weight:700;color:var(--green);line-height:1;}
.effort-lbl{font-size:0.68rem;color:var(--muted2);margin-top:2px;}
.ebar{display:flex;align-items:center;gap:7px;margin-bottom:5px;}
.ebar-lbl{font-size:0.68rem;width:44px;color:var(--muted2);}
.ebar-track{flex:1;height:4px;background:var(--bg);border-radius:2px;overflow:hidden;}
.ebar-fill{height:100%;border-radius:2px;transition:width 0.5s ease;}
.ebar-val{font-family:'JetBrains Mono',monospace;font-size:0.68rem;color:var(--text);width:34px;text-align:right;}

/* date nav */
.date-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:10px;flex-wrap:wrap;}
.date-ctrl{display:flex;align-items:center;gap:8px;}
.nav-btn{width:34px;height:34px;border-radius:9px;background:var(--s2);border:1px solid var(--border);color:var(--text);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all 0.15s;user-select:none;}
.nav-btn:hover{background:var(--s3);border-color:var(--cyan);color:var(--cyan);transform:scale(1.05);}
.nav-btn:active{transform:scale(0.95);}
.date-pill{background:var(--s2);border:1px solid var(--border);border-radius:9px;padding:6px 16px;font-family:'JetBrains Mono',monospace;font-size:0.82rem;min-width:145px;text-align:center;}
.date-pill.today{border-color:var(--cyan);color:var(--cyan);}
.today-btn{background:transparent;border:1px solid var(--border);border-radius:9px;padding:6px 14px;color:var(--muted2);cursor:pointer;font-size:0.75rem;font-family:'JetBrains Mono',monospace;transition:all 0.15s;}
.today-btn:hover{border-color:var(--cyan);color:var(--cyan);}

/* ===== PAGE 2: STATS ===== */
.cue-card{background:linear-gradient(135deg,rgba(56,189,248,0.08),rgba(192,132,252,0.06));border:1px solid rgba(56,189,248,0.2);border-radius:12px;padding:12px 18px;margin-bottom:16px;display:flex;align-items:center;gap:14px;}
.cue-emoji{font-size:1.6rem;}
.cue-main{font-size:0.88rem;font-weight:700;}
.cue-sub{font-size:0.72rem;color:var(--muted2);margin-top:2px;}

.big-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;}
.bstat{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:16px;text-align:center;transition:all 0.2s;}
.bstat:hover{transform:translateY(-2px);border-color:var(--border2);}
.bstat-icon{font-size:1.8rem;margin-bottom:6px;}
.bstat-val{font-family:'JetBrains Mono',monospace;font-size:1.6rem;font-weight:700;line-height:1;}
.bstat-lbl{font-size:0.68rem;color:var(--muted2);margin-top:3px;}
.bstat-sub{font-size:0.65rem;margin-top:4px;}

.trend-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.trend-title{font-family:'JetBrains Mono',monospace;font-size:0.8rem;letter-spacing:0.06em;}
.trend-tabs{display:flex;gap:3px;background:var(--s1);border:1px solid var(--border);border-radius:8px;padding:3px;}
.ttab{background:transparent;border:none;border-radius:6px;padding:5px 14px;color:var(--muted2);cursor:pointer;font-family:'JetBrains Mono',monospace;font-size:0.72rem;transition:all 0.15s;}
.ttab.active{background:var(--s3);color:var(--text);}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;}
.chart-card{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:16px;}
.chart-title{font-size:0.65rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:10px;}
.chart-h{height:190px;position:relative;}

/* habit chain */
.hgrid{display:flex;gap:4px;flex-wrap:wrap;margin-top:10px;}
.hcell{width:26px;height:26px;border-radius:6px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:0.58rem;font-family:'JetBrains Mono',monospace;color:var(--muted);cursor:pointer;transition:all 0.15s;}
.hcell.filled{color:var(--text);}
.hcell.today-cell{border-color:var(--cyan);}

/* history */
.hist-list{max-height:260px;overflow-y:auto;}
.hist-list::-webkit-scrollbar{width:3px;}
.hist-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.hist-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:9px;background:var(--s2);border:1px solid var(--border);margin-bottom:5px;cursor:pointer;transition:all 0.15s;}
.hist-item:hover{border-color:var(--border2);background:var(--s3);}
.hist-item.cur{border-color:var(--cyan);background:rgba(56,189,248,0.05);}
.hist-date{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--cyan);width:76px;flex-shrink:0;}
.hist-mini{flex:1;display:flex;gap:2px;height:16px;align-items:flex-end;}
.hist-bar{border-radius:2px 2px 0 0;min-width:5px;}
.hist-effort{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--green);width:38px;text-align:right;flex-shrink:0;}
.hist-score{font-size:0.66rem;color:var(--muted2);width:40px;text-align:right;flex-shrink:0;}

/* ===== PAGE 3: SKILL TREE ===== */

/* XP header */
.xp-spend-bar{background:var(--s1);border:1px solid rgba(74,222,128,0.2);border-radius:12px;padding:12px 16px;margin-bottom:14px;}
.xp-spend-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.xp-spend-label{font-size:0.72rem;color:var(--muted2);}
.xp-spend-val{font-family:'JetBrains Mono',monospace;font-size:0.88rem;color:var(--green);font-weight:700;}
.xp-track{height:8px;background:var(--bg);border-radius:4px;overflow:hidden;margin-top:4px;}
.xp-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--green),var(--cyan));transition:width 0.8s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 0 8px rgba(74,222,128,0.3);}

/* level banner */
.lv-banner{background:linear-gradient(135deg,rgba(251,191,36,0.1),rgba(251,146,60,0.08));border:1px solid rgba(251,191,36,0.25);border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.lv-circle{width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#fbbf24,#fb923c);display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;font-family:'JetBrains Mono',monospace;box-shadow:0 0 16px rgba(251,191,36,0.3);}
.lv-num{font-size:1.2rem;font-weight:700;color:#000;line-height:1;}
.lv-lbl{font-size:0.5rem;color:rgba(0,0,0,0.6);letter-spacing:0.08em;}
.lv-info{flex:1;}
.lv-name{font-weight:800;font-size:0.9rem;color:var(--amber);}
.lv-next{font-size:0.68rem;color:var(--muted2);margin-top:2px;}
.lv-track{height:6px;background:var(--bg);border-radius:3px;overflow:hidden;margin-top:6px;}
.lv-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,#fbbf24,#fb923c);transition:width 0.8s ease;}

/* SELF STATUS ‚Äî top hero area */
.self-status {
  display:grid;grid-template-columns:auto 1fr;gap:20px;
  background:linear-gradient(135deg,#0c1a2e,#0f1830);
  border:1px solid rgba(56,189,248,0.2);border-radius:20px;
  padding:24px;margin-bottom:20px;position:relative;overflow:hidden;
}
.self-status::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 60% 80% at 20% 50%,rgba(56,189,248,0.04),transparent);pointer-events:none;}
.avatar-wrap{position:relative;width:100px;flex-shrink:0;}
.avatar-ring{width:100px;height:100px;border-radius:50%;border:3px solid var(--cyan);display:flex;align-items:center;justify-content:center;font-size:3rem;background:var(--s2);position:relative;box-shadow:0 0 30px rgba(56,189,248,0.2);animation:avatarPulse 3s ease-in-out infinite;}
@keyframes avatarPulse{0%,100%{box-shadow:0 0 20px rgba(56,189,248,0.2);}50%{box-shadow:0 0 40px rgba(56,189,248,0.4);}}
.avatar-lv-badge{position:absolute;bottom:-4px;right:-4px;background:linear-gradient(135deg,#fbbf24,#fb923c);color:#000;font-family:'JetBrains Mono',monospace;font-size:0.65rem;font-weight:800;padding:2px 7px;border-radius:10px;border:2px solid var(--bg);}
.self-info{display:flex;flex-direction:column;justify-content:center;gap:10px;}
.self-name-row{display:flex;align-items:center;gap:10px;}
.self-name{font-size:1.3rem;font-weight:900;color:var(--text);}
.self-title-badge{background:rgba(192,132,252,0.15);border:1px solid rgba(192,132,252,0.3);border-radius:20px;padding:3px 12px;font-size:0.72rem;color:var(--violet);font-weight:700;}
.self-stats-row{display:flex;gap:16px;flex-wrap:wrap;}
.ss-stat{text-align:center;}
.ss-val{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;color:var(--cyan);}
.ss-lbl{font-size:0.6rem;color:var(--muted2);margin-top:1px;}
.self-bars{display:flex;flex-direction:column;gap:5px;}
.sbar-row{display:flex;align-items:center;gap:8px;}
.sbar-lbl{font-size:0.65rem;color:var(--muted2);width:52px;text-align:right;}
.sbar-track{flex:1;height:7px;background:var(--bg);border-radius:4px;overflow:hidden;border:1px solid var(--border);}
.sbar-fill{height:100%;border-radius:4px;transition:width 0.8s cubic-bezier(0.34,1.56,0.64,1);}
.sbar-val{font-family:'JetBrains Mono',monospace;font-size:0.62rem;color:var(--text);width:32px;}

/* SKILL TREE layout */
.st-layout{display:grid;grid-template-columns:1fr 300px;gap:16px;}

/* Skill tree canvas area */
.st-canvas{background:radial-gradient(ellipse 100% 100% at 50% 50%,#0d1a2e,#070b12);border:1px solid var(--border);border-radius:20px;padding:24px;position:relative;min-height:560px;}
.st-canvas-title{font-family:'DotGothic16',monospace;font-size:1rem;color:var(--cyan);margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;}
.st-tabs{display:flex;gap:4px;}
.sttab{background:var(--s2);border:1px solid var(--border);border-radius:7px;padding:4px 12px;cursor:pointer;font-size:0.72rem;font-weight:700;color:var(--muted2);transition:all 0.15s;}
.sttab.active{background:rgba(56,189,248,0.15);border-color:rgba(56,189,248,0.4);color:var(--cyan);}

/* Domain cards ‚Äî 6 skill domains */
.domain-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
.domain-card{
  background:var(--s2);border:1px solid var(--border);border-radius:14px;
  padding:14px;cursor:pointer;transition:all 0.2s;
  position:relative;overflow:hidden;
}
.domain-card:hover{transform:translateY(-2px);}
.domain-card.active-domain{border-width:2px;}
.domain-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;border-radius:0 0 14px 14px;}
.domain-top{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.domain-icon{font-size:1.4rem;}
.domain-name{font-size:0.78rem;font-weight:800;}
.domain-lv{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--muted2);}
.domain-bar-wrap{height:4px;background:var(--bg);border-radius:2px;overflow:hidden;margin-bottom:6px;}
.domain-bar{height:100%;border-radius:2px;transition:width 0.6s ease;}
.domain-xp-row{display:flex;justify-content:space-between;font-size:0.62rem;color:var(--muted2);}
.domain-xp{font-family:'JetBrains Mono',monospace;}

/* Skill tree SVG node area */
.skill-tree-area{margin-top:16px;position:relative;}
.skill-tree-svg{width:100%;overflow:visible;}
.skill-node{cursor:pointer;transition:all 0.2s;}
.skill-node:hover .sn-circle{filter:brightness(1.3);}
.sn-circle{transition:all 0.25s;}
.sn-label{font-family:'M PLUS Rounded 1c',sans-serif;font-size:11px;font-weight:700;}
.sn-lv{font-family:'JetBrains Mono',monospace;font-size:9px;}
.skill-line{stroke-opacity:0.3;stroke-width:2;stroke-dasharray:4 3;}
.skill-line.unlocked{stroke-opacity:0.7;stroke-dasharray:none;}

/* Right panel: detail + events */
.st-right{display:flex;flex-direction:column;gap:12px;}

/* Selected skill detail */
.skill-detail{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:16px;}
.sd-empty{text-align:center;color:var(--muted);font-size:0.78rem;padding:20px 0;}
.sd-icon{font-size:2.5rem;text-align:center;margin-bottom:8px;}
.sd-name{font-size:1rem;font-weight:900;text-align:center;}
.sd-desc{font-size:0.72rem;color:var(--muted2);text-align:center;margin:6px 0 12px;line-height:1.5;}
.sd-lv-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.sd-lv-label{font-size:0.65rem;color:var(--muted2);}
.sd-lv-val{font-family:'JetBrains Mono',monospace;font-size:0.72rem;font-weight:700;}
.sd-bar{height:8px;background:var(--bg);border-radius:4px;overflow:hidden;margin-bottom:10px;}
.sd-bar-fill{height:100%;border-radius:4px;transition:width 0.6s ease;}
.sd-effect{background:var(--s2);border-radius:8px;padding:8px;font-size:0.72rem;margin-bottom:10px;}
.sd-effect-title{font-size:0.62rem;color:var(--muted2);margin-bottom:4px;font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:0.08em;}
.sd-upgrade-btn{width:100%;padding:9px;border:none;border-radius:9px;font-family:'M PLUS Rounded 1c',sans-serif;font-size:0.82rem;font-weight:800;cursor:pointer;transition:all 0.2s;}
.sd-upgrade-btn.can{background:linear-gradient(135deg,#fbbf24,#fb923c);color:#000;}
.sd-upgrade-btn.can:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(251,191,36,0.4);}
.sd-upgrade-btn.cant{background:var(--s2);color:var(--muted);cursor:not-allowed;}

/* Narrative event log */
.event-log{background:var(--s1);border:1px solid var(--border);border-radius:14px;padding:14px;flex:1;}
.el-title{font-family:'DotGothic16',monospace;font-size:0.82rem;color:var(--amber);margin-bottom:10px;}
.el-list{max-height:220px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.el-list::-webkit-scrollbar{width:3px;}
.el-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.el-item{padding:8px 10px;border-radius:8px;background:var(--s2);border-left:3px solid transparent;font-size:0.72rem;line-height:1.5;animation:popIn 0.3s ease;}
.el-item.awakening{border-left-color:var(--amber);}
.el-item.levelup{border-left-color:var(--cyan);}
.el-item.streak{border-left-color:var(--green);}
.el-item.warning{border-left-color:var(--rose);}
.el-date{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--muted);margin-top:2px;}

/* Awakening modal special */
.awakening-overlay{position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);}
.awakening-overlay.show{display:flex;}
.awakening-box{
  background:linear-gradient(135deg,#0a0f1e,#1a0f30);
  border:2px solid var(--amber);border-radius:24px;
  padding:48px;text-align:center;max-width:400px;
  box-shadow:0 0 100px rgba(251,191,36,0.3),0 0 200px rgba(192,132,252,0.1);
  animation:awakeIn 0.5s cubic-bezier(0.34,1.56,0.64,1);
}
@keyframes awakeIn{from{transform:scale(0.3) rotate(-10deg);opacity:0;}to{transform:scale(1) rotate(0deg);opacity:1;}}
.aw-particles{font-size:2rem;margin-bottom:12px;animation:spin 2s linear infinite;}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
.aw-title{font-family:'DotGothic16',monospace;font-size:1.6rem;color:var(--amber);margin-bottom:8px;text-shadow:0 0 20px rgba(251,191,36,0.5);}
.aw-sub{font-size:0.82rem;color:var(--muted2);line-height:1.6;margin-bottom:20px;}
.aw-close{background:linear-gradient(135deg,#fbbf24,#fb923c);border:none;border-radius:10px;padding:10px 30px;color:#000;font-weight:800;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;}

@media(max-width:900px){
  .st-layout,.self-status{grid-template-columns:1fr;}
  .domain-grid{grid-template-columns:repeat(2,1fr);}
  .self-stats-row{gap:10px;}
}

/* ===== REWARD POP ===== */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;display:none;align-items:center;justify-content:center;}
.overlay.show{display:flex;}
.reward-box{
  background:linear-gradient(135deg,#0f1e14,#0d1230);
  border:2px solid var(--amber);border-radius:20px;
  padding:36px 48px;text-align:center;
  box-shadow:0 0 80px rgba(251,191,36,0.25);
  animation:rewardIn 0.4s cubic-bezier(0.34,1.56,0.64,1);
  max-width:360px;
}
@keyframes rewardIn{from{transform:scale(0.5);opacity:0;}to{transform:scale(1);opacity:1;}}
.reward-emoji{font-size:3.5rem;display:block;margin-bottom:10px;animation:bounce 0.6s ease infinite alternate;}
@keyframes bounce{from{transform:translateY(0);}to{transform:translateY(-8px);}}
.reward-title{font-family:'DotGothic16',monospace;font-size:1.3rem;color:var(--amber);margin-bottom:6px;}
.reward-sub{font-size:0.82rem;color:var(--muted2);line-height:1.5;}
.reward-close{margin-top:20px;background:var(--s3);border:1px solid var(--border);border-radius:8px;padding:7px 24px;color:var(--text);cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;font-size:0.82rem;font-weight:700;transition:all 0.15s;}
.reward-close:hover{background:var(--amber);color:#000;}

/* modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:150;display:none;align-items:center;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:150;display:none;align-items:center;justify-content:center;}
.modal.show{display:flex;}
.modal-box{background:var(--s1);border:1px solid var(--border2);border-radius:16px;padding:24px;max-width:400px;width:90%;animation:rewardIn 0.3s ease;}
.modal-title{font-weight:800;font-size:1rem;margin-bottom:14px;}
.modal-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;}
.modal-close{margin-top:12px;}

/* toast */
.toast{position:fixed;bottom:24px;right:24px;background:var(--s2);border:1px solid var(--green);color:var(--text);padding:10px 16px;border-radius:10px;font-size:0.82rem;z-index:9999;transform:translateY(60px);opacity:0;transition:all 0.3s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;gap:8px;box-shadow:0 8px 30px rgba(0,0,0,0.5);}
.toast.on{transform:translateY(0);opacity:1;}
.toast.err{border-color:var(--rose);}

/* floating xp */
.xp-float{position:fixed;font-family:'DotGothic16',monospace;font-size:1rem;color:var(--amber);pointer-events:none;z-index:999;animation:floatUp 1.2s ease forwards;}
@keyframes floatUp{0%{opacity:1;transform:translateY(0) scale(1);}100%{opacity:0;transform:translateY(-60px) scale(1.3);}}

/* ===== ECONOMY / WAGE ===== */
.eco-bar{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;}
.eco-card{border-radius:14px;padding:16px 20px;position:relative;overflow:hidden;}
.eco-card.wage{background:linear-gradient(135deg,#120d04,#1e1608);border:1px solid rgba(245,158,11,.3);}
.eco-card.money{background:linear-gradient(135deg,#071a0f,var(--s1));border:1px solid rgba(74,222,128,.25);}
.eco-card.info{background:var(--s1);border:1px solid var(--border);}
.eco-label{font-size:.65rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:6px;}
.eco-big{font-family:'JetBrains Mono',monospace;font-size:2.6rem;font-weight:800;line-height:1;text-shadow:0 0 20px currentColor;letter-spacing:-.02em;}
.eco-unit{font-size:.72rem;color:var(--muted2);margin-top:3px;font-weight:600;}
.eco-sub{font-size:.62rem;color:var(--muted);margin-top:4px;}
.eco-bar-track{height:5px;background:var(--bg);border-radius:3px;overflow:hidden;margin-top:8px;}
.eco-bar-fill{height:100%;border-radius:3px;transition:width .8s ease;}
.eco-wage-next{font-size:.65rem;color:var(--muted);margin-top:5px;}
.wage-ladder{display:flex;flex-direction:column;gap:3px;margin-top:8px;}
.wl-row{display:flex;align-items:center;gap:6px;font-size:.67rem;opacity:.5;transition:opacity .2s;}
.wl-row.cur{opacity:1;font-weight:700;}
.wl-row.past{opacity:.35;}
.wl-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;background:var(--muted);}
.wl-row.cur .wl-dot{background:var(--gold);}
.wl-name{flex:1;color:var(--muted2);}
.wl-row.cur .wl-name{color:var(--text);}
.wl-wage{font-family:'JetBrains Mono',monospace;color:var(--muted);}
.wl-row.cur .wl-wage{color:var(--gold);}
.work-btn{width:100%;padding:11px;border:none;border-radius:10px;background:linear-gradient(135deg,#f59e0b,#fb923c);color:#000;font-weight:800;font-size:.9rem;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;transition:all .2s;margin-top:10px;}
.work-btn:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 18px rgba(245,158,11,.4);}
.work-btn:disabled{opacity:.4;cursor:not-allowed;transform:none;}

/* work modal */
.work-modal{background:linear-gradient(135deg,#0d1220,#120f06);border:2px solid var(--gold);border-radius:20px;padding:28px;max-width:420px;width:90%;animation:rewardIn .35s cubic-bezier(.34,1.56,.64,1);}
.wm-title{font-family:'DotGothic16',monospace;font-size:1.1rem;color:var(--gold);text-align:center;margin-bottom:4px;}
.wm-sub{font-size:.72rem;color:var(--muted2);text-align:center;margin-bottom:16px;line-height:1.5;}
.wm-wage-box{background:rgba(245,158,11,.09);border:1px solid rgba(245,158,11,.22);border-radius:11px;padding:12px;text-align:center;margin-bottom:14px;}
.wm-wage-big{font-family:'JetBrains Mono',monospace;font-size:2.1rem;font-weight:700;color:var(--gold);}
.wm-wage-lbl{font-size:.65rem;color:var(--muted2);margin-top:2px;}
.wm-hours-inp{background:var(--s2);border:1px solid var(--border);border-radius:9px;color:var(--text);padding:10px;font-family:'JetBrains Mono',monospace;font-size:1.1rem;width:100%;text-align:center;font-weight:700;margin-bottom:8px;}
.wm-hours-inp:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 2px rgba(245,158,11,.12);}
.wm-preview{text-align:center;font-size:.8rem;color:var(--muted2);margin-bottom:14px;}
.wm-preview strong{color:var(--green);font-family:'JetBrains Mono',monospace;font-size:1rem;}
.wm-worked-notice{font-size:.65rem;color:var(--rose);text-align:center;margin-top:8px;}

/* building shop */
.bld-section{display:flex;flex-direction:column;gap:6px;max-height:320px;overflow-y:auto;}
.bld-section::-webkit-scrollbar{width:3px;}
.bld-section::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.bld-item{display:flex;align-items:center;gap:9px;padding:8px 10px;background:var(--s2);border:1px solid var(--border);border-radius:9px;cursor:pointer;transition:all .15s;}
.bld-item:hover:not(.bld-owned){border-color:var(--gold);background:var(--s3);}
.bld-item.bld-owned{opacity:.5;cursor:default;}
.bld-item.bld-cant{opacity:.3;cursor:not-allowed;}
.bld-icon{font-size:1.3rem;flex-shrink:0;width:30px;text-align:center;}
.bld-info{flex:1;}
.bld-name{font-size:.78rem;font-weight:700;}
.bld-desc{font-size:.62rem;color:var(--muted2);}
.bld-cost{font-family:'JetBrains Mono',monospace;font-size:.72rem;font-weight:700;white-space:nowrap;}
.bld-cost.c-own{color:var(--green);}
.bld-cost.c-gold{color:var(--gold);}
.bld-cost.c-lock{color:var(--muted);}

/* town grid in page3 */
.town-display{background:linear-gradient(180deg,#060e1e,#0a1428);border:1px solid rgba(56,189,248,.12);border-radius:16px;padding:16px;margin-bottom:14px;}
.town-grid-vis{display:flex;flex-wrap:wrap;gap:6px;min-height:80px;align-items:flex-start;}
.town-bld{font-size:1.6rem;line-height:1;animation:popIn .3s ease;cursor:pointer;transition:transform .15s;}
.town-bld:hover{transform:scale(1.15);}
.town-empty{font-size:.72rem;color:var(--muted);padding:20px;text-align:center;width:100%;}
.town-pop{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--cyan);margin-top:8px;}

:root{--gold:#f59e0b;--gold2:#fcd34d;}

@media(max-width:900px){
  .p1-grid,.st-layout{grid-template-columns:1fr;}
  .charts-grid,.big-stats{grid-template-columns:1fr 1fr;}
  .eco-bar{grid-template-columns:1fr;}
}

/* ===== INVESTMENTS ===== */
.inv-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:10px;margin-top:10px;}
.inv-card{background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:14px;transition:all .2s;cursor:pointer;position:relative;overflow:hidden;}
.inv-card:hover{border-color:var(--cyan);transform:translateY(-2px);box-shadow:0 4px 16px rgba(56,189,248,.1);}
.inv-card.locked{opacity:.4;cursor:not-allowed;}
.inv-card.locked:hover{transform:none;border-color:var(--border);}
.inv-card .inv-icon{font-size:1.6rem;margin-bottom:6px;}
.inv-card .inv-name{font-size:.82rem;font-weight:700;margin-bottom:2px;}
.inv-card .inv-desc{font-size:.62rem;color:var(--muted2);line-height:1.5;margin-bottom:6px;}
.inv-card .inv-yield{font-family:'JetBrains Mono',monospace;font-size:.72rem;color:var(--green);}
.inv-card .inv-cost{font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--gold);}
.inv-card .inv-lock{font-size:.6rem;color:var(--rose);margin-top:4px;}
.inv-card.owned{border-color:rgba(74,222,128,.3);background:linear-gradient(135deg,var(--s2),#0a1a10);}
.inv-card.owned::after{content:'‚úì ‰øùÊúâ‰∏≠';position:absolute;top:8px;right:10px;font-size:.58rem;color:var(--green);background:rgba(74,222,128,.12);padding:2px 7px;border-radius:8px;}
.passive-bar{background:linear-gradient(135deg,#071a10,#0d1a0a);border:1px solid rgba(74,222,128,.2);border-radius:14px;padding:14px 18px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
.passive-big{font-family:'JetBrains Mono',monospace;font-size:1.6rem;font-weight:700;color:var(--green);}
.passive-lbl{font-size:.62rem;color:var(--muted2);}
.collect-btn{padding:9px 22px;border:none;border-radius:10px;background:linear-gradient(135deg,#4ade80,#22d3ee);color:#000;font-weight:800;font-size:.82rem;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;transition:all .2s;}
.collect-btn:hover{opacity:.9;transform:translateY(-1px);box-shadow:0 4px 14px rgba(74,222,128,.3);}
.collect-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;}

/* ===== LIFESTYLE ===== */
.lifestyle-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;margin-top:8px;}
.ls-card{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px;cursor:pointer;transition:all .15s;}
.ls-card:hover{border-color:var(--amber);}
.ls-card.ls-active{border-color:rgba(251,191,36,.4);background:linear-gradient(135deg,var(--s2),#1a1508);}
.ls-card .ls-icon{font-size:1.3rem;}
.ls-card .ls-name{font-size:.78rem;font-weight:700;margin:3px 0 1px;}
.ls-card .ls-desc{font-size:.58rem;color:var(--muted2);}
.ls-card .ls-cost{font-family:'JetBrains Mono',monospace;font-size:.65rem;color:var(--gold);margin-top:4px;}
.ls-card .ls-bonus{font-size:.58rem;color:var(--green);}

/* ===== GACHA / SLOT ===== */
.gacha-section{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px;}
.gacha-box{background:linear-gradient(135deg,#120818,#0a0520);border:1px solid rgba(168,85,247,.25);border-radius:14px;padding:16px;text-align:center;}
.gacha-title{font-family:'DotGothic16',monospace;font-size:.95rem;color:var(--violet);margin-bottom:6px;}
.gacha-desc{font-size:.62rem;color:var(--muted2);margin-bottom:10px;line-height:1.5;}
.gacha-btn{padding:10px 24px;border:none;border-radius:10px;font-weight:800;font-size:.85rem;cursor:pointer;font-family:'M PLUS Rounded 1c',sans-serif;transition:all .2s;}
.gacha-btn:hover{opacity:.9;transform:translateY(-1px);}
.gacha-btn:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.gacha-btn.violet{background:linear-gradient(135deg,#a855f7,#7c3aed);color:#fff;}
.gacha-btn.gold{background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;}
.slot-box{background:linear-gradient(135deg,#1a0c08,#140a02);border:1px solid rgba(251,146,60,.25);border-radius:14px;padding:16px;text-align:center;}
.slot-title{font-family:'DotGothic16',monospace;font-size:.95rem;color:var(--orange);margin-bottom:6px;}
.slot-reels{display:flex;justify-content:center;gap:8px;margin:12px 0;}
.slot-reel{width:52px;height:52px;background:var(--bg);border:2px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;transition:all .15s;}
.slot-reel.spinning{animation:slotSpin .15s infinite;}
@keyframes slotSpin{0%{transform:translateY(-3px);}50%{transform:translateY(3px);}100%{transform:translateY(-3px);}}
.slot-result{font-size:.75rem;color:var(--amber);min-height:20px;margin-top:6px;}

/* ===== ACHIEVEMENTS ===== */
.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;margin-top:10px;}
.ach-card{background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;align-items:center;gap:10px;transition:all .15s;}
.ach-card.unlocked{border-color:rgba(251,191,36,.3);background:linear-gradient(135deg,var(--s2),#161008);}
.ach-card.unlocked .ach-icon{filter:none;}
.ach-card .ach-icon{font-size:1.4rem;filter:grayscale(1) brightness(.4);flex-shrink:0;}
.ach-card .ach-info{flex:1;min-width:0;}
.ach-card .ach-name{font-size:.72rem;font-weight:700;}
.ach-card .ach-desc{font-size:.58rem;color:var(--muted2);}
.ach-card .ach-rew{font-size:.55rem;color:var(--green);}

/* ===== HELP MODAL ===== */
.help-btn{background:var(--s2);border:1px solid var(--border);width:36px;height:36px;border-radius:50%;color:var(--cyan);font-size:1rem;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;}
.help-btn:hover{background:var(--s3);border-color:var(--cyan);box-shadow:0 0 12px rgba(56,189,248,.2);}
.help-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.75);backdrop-filter:blur(8px);display:none;align-items:flex-start;justify-content:center;padding:60px 20px;overflow-y:auto;}
.help-overlay.show{display:flex;}
.help-box{background:var(--s1);border:1px solid var(--border2);border-radius:20px;max-width:700px;width:100%;padding:28px;max-height:85vh;overflow-y:auto;}
.help-box::-webkit-scrollbar{width:4px;}
.help-box::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.hb-title{font-family:'DotGothic16',monospace;font-size:1.1rem;color:var(--cyan);margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;}
.hb-section{margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid var(--border);}
.hb-section:last-child{border:none;margin-bottom:0;padding-bottom:0;}
.hb-h{font-size:.82rem;font-weight:700;margin-bottom:6px;color:var(--text);}
.hb-p{font-size:.7rem;color:var(--muted2);line-height:1.7;}
.hb-tag{display:inline-block;background:var(--s3);border:1px solid var(--border);padding:2px 8px;border-radius:6px;font-size:.6rem;color:var(--cyan);margin:0 2px;}
.hb-tbl{width:100%;border-collapse:collapse;margin-top:6px;font-size:.65rem;}
.hb-tbl th{background:var(--s2);padding:5px 8px;text-align:left;color:var(--muted2);font-weight:700;}
.hb-tbl td{padding:5px 8px;border-top:1px solid var(--border);color:var(--text);}

/* ===== SLEEP XP MODIFIER BADGE ===== */
.sleep-xp-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:8px;font-size:.6rem;font-family:'JetBrains Mono',monospace;font-weight:700;}
.sleep-xp-badge.excellent{background:rgba(74,222,128,.12);color:#4ade80;border:1px solid rgba(74,222,128,.25);}
.sleep-xp-badge.good{background:rgba(56,189,248,.1);color:#38bdf8;border:1px solid rgba(56,189,248,.2);}
.sleep-xp-badge.normal{background:rgba(100,116,139,.1);color:#94a3b8;border:1px solid rgba(100,116,139,.2);}
.sleep-xp-badge.poor{background:rgba(251,191,36,.1);color:#fbbf24;border:1px solid rgba(251,191,36,.2);}
.sleep-xp-badge.bad{background:rgba(251,113,133,.1);color:#fb7185;border:1px solid rgba(251,113,133,.2);}

/* sub-tabs in page3 */
.p3-subtabs{display:flex;gap:4px;margin-bottom:14px;flex-wrap:wrap;}
.p3-stab{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:6px 14px;color:var(--muted2);cursor:pointer;font-size:.75rem;font-weight:700;transition:all .15s;font-family:'M PLUS Rounded 1c',sans-serif;}
.p3-stab:hover{background:var(--s3);color:var(--text);}
.p3-stab.active{background:var(--s3);color:var(--text);border-color:var(--border2);}
.p3-panel{display:none;}
.p3-panel.active{display:block;}
.debt-lock-overlay{position:absolute;inset:0;z-index:10;display:flex;align-items:center;justify-content:center;background:rgba(10,10,15,0.55);border-radius:12px;pointer-events:none;}

@media(max-width:900px){
  .inv-grid{grid-template-columns:1fr;}
  .gacha-section{grid-template-columns:1fr;}
  .ach-grid{grid-template-columns:1fr 1fr;}
  .lifestyle-grid{grid-template-columns:1fr 1fr;}
}

/* Daily Quests */
.dq-card{background:linear-gradient(135deg,var(--s1),#0f1b2e);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;}
.dq-title{font-size:.78rem;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.dq-list{display:flex;flex-direction:column;gap:5px;}
.dq-item{display:flex;align-items:center;gap:8px;padding:7px 10px;background:var(--s2);border:1px solid var(--border);border-radius:8px;cursor:pointer;transition:all .15s;font-size:.74rem;}
.dq-item:hover{border-color:var(--cyan);background:var(--s3);}
.dq-item.done{border-color:rgba(74,222,128,.3);background:linear-gradient(135deg,rgba(74,222,128,.05),transparent);}
.dq-check{width:18px;height:18px;border-radius:50%;border:2px solid var(--muted);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;font-size:.6rem;}
.dq-item.done .dq-check{border-color:var(--green);background:var(--green);color:#000;}
.dq-label{flex:1;}
.dq-xp{font-family:'JetBrains Mono',monospace;font-size:.62rem;color:var(--green);flex-shrink:0;}
.dq-item.done .dq-label{text-decoration:line-through;opacity:.6;}
.dq-prog{display:flex;align-items:center;gap:6px;margin-top:6px;font-size:.62rem;color:var(--muted2);}
.dq-prog-bar{flex:1;height:4px;background:var(--s2);border-radius:2px;overflow:hidden;}
.dq-prog-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--cyan));border-radius:2px;transition:width .3s;}
/* Performance card */
.perf-card{background:linear-gradient(135deg,#0d1520,#111d30);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;}
.perf-row{display:flex;gap:8px;margin-bottom:8px;}
.perf-metric{flex:1;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center;}
.perf-val{font-family:'JetBrains Mono',monospace;font-size:1rem;font-weight:700;}
.perf-delta{font-family:'JetBrains Mono',monospace;font-size:.68rem;margin-top:2px;}
.perf-lbl{font-size:.58rem;color:var(--muted2);margin-top:2px;}
.perf-rank{text-align:center;padding:8px;background:var(--s2);border:1px solid var(--border);border-radius:8px;font-size:.72rem;line-height:1.6;}
.perf-rank-num{font-family:'JetBrains Mono',monospace;font-size:1.2rem;font-weight:800;}
/* ===== TUTORIAL ===== */
.tut-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.82);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;padding:20px;transition:opacity .3s;}
.tut-overlay.show{display:flex;}
.tut-card{background:linear-gradient(145deg,#0d1220,#111828);border:1px solid rgba(0,212,255,.2);border-radius:22px;max-width:460px;width:100%;padding:32px 28px;animation:tutIn .4s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden;}
.tut-card::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:conic-gradient(from 0deg,transparent,rgba(0,212,255,.04),transparent,rgba(168,85,247,.04),transparent);animation:tutGlow 8s linear infinite;}
@keyframes tutIn{from{opacity:0;transform:scale(.85) translateY(20px);}to{opacity:1;transform:scale(1) translateY(0);}}
@keyframes tutGlow{to{transform:rotate(360deg);}}
.tut-inner{position:relative;z-index:1;}
.tut-step-indicator{display:flex;justify-content:center;gap:6px;margin-bottom:20px;}
.tut-dot{width:8px;height:8px;border-radius:50%;background:var(--s3);border:1px solid var(--border);transition:all .3s;}
.tut-dot.active{background:var(--cyan);border-color:var(--cyan);box-shadow:0 0 8px rgba(0,212,255,.5);}
.tut-dot.done{background:var(--green);border-color:var(--green);}
.tut-emoji{font-size:2.8rem;text-align:center;margin-bottom:14px;filter:drop-shadow(0 4px 16px rgba(0,0,0,.5));}
.tut-title{font-family:'DotGothic16',monospace;font-size:1.1rem;color:var(--cyan);text-align:center;margin-bottom:10px;text-shadow:0 0 12px rgba(0,212,255,.3);}
.tut-desc{font-size:.75rem;color:var(--muted2);line-height:1.8;text-align:center;margin-bottom:20px;}
.tut-desc strong{color:var(--text);font-weight:700;}
.tut-desc .th{display:inline-block;background:var(--s3);border:1px solid var(--border);padding:1px 7px;border-radius:5px;font-size:.65rem;color:var(--cyan);margin:1px 2px;font-weight:700;}
.tut-desc .tg{display:inline-block;background:rgba(0,255,136,.08);border:1px solid rgba(0,255,136,.2);padding:1px 7px;border-radius:5px;font-size:.65rem;color:var(--green);margin:1px 2px;font-weight:700;}
.tut-desc .tr{display:inline-block;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);padding:1px 7px;border-radius:5px;font-size:.65rem;color:var(--amber);margin:1px 2px;font-weight:700;}
.tut-btns{display:flex;gap:8px;justify-content:center;}
.tut-btn{padding:10px 28px;border:none;border-radius:12px;font-weight:800;font-size:.82rem;cursor:pointer;transition:all .2s;font-family:'M PLUS Rounded 1c',sans-serif;}
.tut-btn:hover{transform:translateY(-1px);}
.tut-btn.primary{background:linear-gradient(135deg,#00d4ff,#0ea5e9);color:#000;box-shadow:0 4px 20px rgba(0,212,255,.3);}
.tut-btn.secondary{background:var(--s3);color:var(--muted2);border:1px solid var(--border);}
.tut-btn.skip{background:none;border:none;color:var(--muted);font-size:.68rem;padding:6px 12px;}
.tut-flow{display:flex;align-items:center;justify-content:center;gap:6px;margin:12px 0;flex-wrap:wrap;}
.tut-flow .tf-node{background:var(--s3);border:1px solid var(--border);padding:4px 10px;border-radius:8px;font-size:.62rem;font-weight:700;color:var(--text);}
.tut-flow .tf-arrow{color:var(--cyan);font-size:.7rem;}
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="nav-logo">TIMEFLOW</div>
  <div class="nav-tabs">
    <button class="ntab active" id="nt0" onclick="gotoPage(0)">üìù Ë®òÈå≤</button>
    <button class="ntab" id="nt1" onclick="gotoPage(1)">üìä Áµ±Ë®à</button>
    <button class="ntab" id="nt2" onclick="gotoPage(2)">üåø ËÇ≤Êàê</button>
  </div>
  <div class="nav-right">
    <div class="xp-pill" style="border-color:rgba(245,158,11,.35);">üí∞ <span style="color:#f59e0b;font-weight:700;" id="navGold">0</span> <span style="color:var(--muted2)">G</span></div>
    <div class="xp-pill">‚ö° <span class="xp-num" id="navXP">0</span> <span style="color:var(--muted2)">XP</span></div>
    <div class="streak-pill">üî• <span id="navStreak">0</span>Êó•</div>
    <div class="streak-pill" id="rebirthPill" style="display:none;border-color:rgba(192,132,252,.4);"></div>
  
    <button class="help-btn" onclick="openHelp()" title="„Éò„É´„Éó">?</button></div>
</nav>

<!-- ==================== PAGE 1: RECORD ==================== -->
<div class="page active" id="page0">
<div class="wrap">

  <!-- date nav -->
  <div class="date-row">
    <div class="date-ctrl">
      <button class="nav-btn" onclick="changeDate(-1)">&#8592;</button>
      <div class="date-pill" id="datePill"></div>
      <button class="nav-btn" onclick="changeDate(1)">&#8594;</button>
      <button class="today-btn" onclick="goToday()">‰ªäÊó•</button>
    </div>
  </div>

  <div class="p1-grid">
    <!-- LEFT: input -->
    <div style="display:flex;flex-direction:column;gap:14px;">
      <div class="card">
        <div class="card-hd"><div class="card-hd-dot"></div>ÊôÇÈñì„Éñ„É≠„ÉÉ„ÇØÂÖ•Âäõ</div>
        <div class="input-row">
          <div><div class="inp-lbl">ÈñãÂßã</div><input type="time" id="startTime" value="09:00" step="600" class="time-sel"></div>
          <div><div class="inp-lbl">ÁµÇ‰∫Ü</div><input type="time" id="endTime" value="10:00" step="600" class="time-sel"></div>
        </div>
        <div><div class="inp-lbl">„Ç´„ÉÜ„Ç¥„É™</div>
          <select class="sel" id="category">
            <option value="‰ªï‰∫ã">üíº ‰ªï‰∫ã</option>
            <option value="Â≠¶Áøí">üìö Â≠¶Áøí</option>
            <option value="ÈÅãÂãï">üèÉ ÈÅãÂãï</option>
            <option value="Ë∂£Âë≥">üéÆ Ë∂£Âë≥</option>
            <option value="È£ü‰∫ã">üç± È£ü‰∫ã</option>
            <option value="‰ºëÊÜ©">‚òï ‰ºëÊÜ©</option>
            <option value="ÁßªÂãï">üöÉ ÁßªÂãï</option>
            <option value="Áù°Áú†">üåô Áù°Áú†</option>
            <option value="„Åù„ÅÆ‰ªñ">üìã „Åù„ÅÆ‰ªñ</option>
          </select>
        </div>
        <button class="add-btn" onclick="addBlock()">Ôºã ËøΩÂä†</button>
        <div class="daytpl-bar" id="dayTplBar">
          <span style="font-size:.62rem;color:var(--muted2);flex-shrink:0;">üìÖ ‰∏ÄÊó•„ÉÜ„É≥„Éó„É¨Ôºö</span>
        </div>
        <div class="quick-adds" id="quickAdds"></div>

        <!-- XP progress mini -->
        <div style="display:flex;align-items:center;gap:8px;margin-top:10px;">
          <span style="font-size:0.65rem;color:var(--muted2);font-family:'JetBrains Mono',monospace;white-space:nowrap;">Êú¨Êó•XP</span>
          <div class="xp-track" style="flex:1;height:6px;"><div class="xp-fill" id="dayXPBar" style="width:0%"></div></div>
          <span style="font-size:0.65rem;color:var(--green);font-family:'JetBrains Mono',monospace;" id="dayXPVal">0</span>
        </div>

        <div class="tl-wrap" id="timeline">
          <div style="display:flex;height:100%;align-items:center;justify-content:center;color:var(--muted);font-size:0.68rem;">„Çø„Ç§„É†„É©„Ç§„É≥</div>
        </div>
        <div class="tl-ticks"><span class="tl-tick">0</span><span class="tl-tick">6</span><span class="tl-tick">12</span><span class="tl-tick">18</span><span class="tl-tick">24</span></div>
        <div class="blist" id="blockList"><div style="text-align:center;color:var(--muted);font-size:0.78rem;padding:14px;">„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div></div>
      </div>

      <!-- Sleep (auto-calculated from sleep blocks) -->
      <div class="card" style="background:linear-gradient(135deg,var(--s1) 60%,#110a2a);border-color:rgba(192,132,252,0.15);">
        <div class="card-hd"><div class="card-hd-dot" style="background:var(--violet);"></div>Áù°Áú†„Çπ„Ç≥„Ç¢
          <span style="font-size:0.62rem;color:var(--muted);margin-left:auto;cursor:pointer;" onclick="openSleepIdealEditor()" title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÁêÜÊÉ≥ÂÄ§„ÇíÁ∑®ÈõÜ">ÁêÜÊÉ≥: <span id="idealDisplay">23:00Â∞±ÂØù / 6:30Ëµ∑Â∫ä / 7.5h</span> ‚úèÔ∏è</span>
        </div>
        <div class="sleep-grid">
          <div class="sleep-arc-wrap">
            <svg viewBox="0 0 88 88"><circle cx="44" cy="44" r="37" fill="none" stroke="var(--s3)" stroke-width="7"/><circle id="sleepArc" cx="44" cy="44" r="37" fill="none" stroke="#c084fc" stroke-width="7" stroke-dasharray="232.48" stroke-dashoffset="232.48" transform="rotate(-90 44 44)" stroke-linecap="round"/></svg>
            <div class="sleep-center"><div class="sleep-num" id="sleepScore" style="color:var(--violet)">--</div><div class="sleep-unit">ÁÇπ</div></div>
          </div>
          <div>
            <div id="sleepBlockInfo" style="font-size:.72rem;color:var(--muted2);margin-bottom:6px;">üåô Áù°Áú†„Éñ„É≠„ÉÉ„ÇØ„ÇíËøΩÂä†„Åô„Çã„Å®Ëá™ÂãïË®àÁÆó„Åï„Çå„Åæ„Åô</div>
            <div class="sleep-band"><div class="sleep-band-fill" id="sleepBand" style="width:0%"></div></div>
            <div class="sleep-msg" id="sleepMsg" style="color:var(--muted2)">Áù°Áú†„Ç´„ÉÜ„Ç¥„É™„ÅßÊôÇÈñì„ÇíË®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            <div style="font-size:.55rem;color:var(--muted);margin-top:4px;">üí° Êó•„Åæ„Åü„ÅéOKÔºö‰æã 23:00‚Üí07:00 „ÅßËá™ÂãïÂàÜÂâ≤</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: metrics + pie -->
    <div class="right-col">
      <div class="metrics-row">
        <div class="metric-card">
          <div class="metric-val" id="m_total" style="color:var(--cyan)">0:00</div>
          <div class="metric-lbl">Ë®òÈå≤ÊôÇÈñì</div>
          <div class="metric-trend" id="m_total_trend"></div>
        </div>
        <div class="metric-card">
          <div class="metric-val" id="m_effort" style="color:var(--green)">0:00</div>
          <div class="metric-lbl">Âä™ÂäõÊôÇÈñì</div>
          <div class="metric-trend" id="m_effort_trend"></div>
        </div>
        <div class="metric-card">
          <div class="metric-val" id="m_sleep" style="color:var(--violet)">--</div>
          <div class="metric-lbl">Áù°Áú†„Çπ„Ç≥„Ç¢</div>
          <div class="metric-trend" id="m_sleep_trend"></div>
        </div>
      </div>

      <!-- Performance comparison card -->
      <div class="perf-card" id="perfCard" style="display:none;">
        <div style="font-size:.78rem;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;">üìä ÂâçÊó•ÊØî„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ</div>
        <div class="perf-row">
          <div class="perf-metric">
            <div class="perf-val" id="perf_effort" style="color:var(--green);">--</div>
            <div class="perf-delta" id="perf_effort_delta"></div>
            <div class="perf-lbl">Âä™ÂäõÊôÇÈñì</div>
          </div>
          <div class="perf-metric">
            <div class="perf-val" id="perf_sleep" style="color:var(--violet);">--</div>
            <div class="perf-delta" id="perf_sleep_delta"></div>
            <div class="perf-lbl">Áù°Áú†„Çπ„Ç≥„Ç¢</div>
          </div>
        </div>
        <div class="perf-rank" id="perfRank"></div>
      </div>

      <!-- Pie Chart -->
      <div class="card">
        <div class="card-hd"><div class="card-hd-dot"></div>24ÊôÇÈñì„Çø„Ç§„É†„É©„Ç§„É≥</div>
        <div style="display:flex;flex-direction:column;align-items:center;gap:12px;">
          <div style="position:relative;width:340px;height:340px;flex-shrink:0;">
            <canvas id="clockCanvas" width="680" height="680" style="width:340px;height:340px;"></canvas>
            <div class="pie-mid"><div class="pie-mid-h" id="pieTotal">0h</div><div class="pie-mid-l">Ë®òÈå≤</div></div>
          </div>
          <div class="legend" id="pieLegend" style="width:100%;"></div>
        </div>
      </div>

      <div class="effort-banner">
        <div><div class="effort-big" id="effortBig">0:00</div><div class="effort-lbl">Á∑èÂä™ÂäõÊôÇÈñì</div><div style="font-size:0.62rem;color:var(--muted);margin-top:2px;">‰ªï‰∫ã„ÉªÂ≠¶Áøí„ÉªÈÅãÂãïÔºãÁâπÂà•È†ÖÁõÆ</div></div>
        <div style="flex:1;" id="effortBars"></div>
      </div>

      <!-- Daily Quests -->
      <div class="dq-card">
        <div class="dq-title">‚úÖ „Éá„Ç§„É™„Éº„ÇØ„Ç®„Çπ„Éà <span style="font-size:.6rem;color:var(--muted2);font-weight:400;" id="dqDate"></span></div>
        <div class="dq-list" id="dqList"></div>
        <div class="dq-prog"><span id="dqProg">0/0</span><div class="dq-prog-bar"><div class="dq-prog-fill" id="dqProgBar" style="width:0%;"></div></div><span id="dqBonus" style="color:var(--green);"></span></div>
        <div style="margin-top:6px;display:flex;gap:4px;">
          <button class="btn sm" onclick="openQuestEditor()" style="font-size:.62rem;">‚öô „ÇØ„Ç®„Çπ„ÉàÁ∑®ÈõÜ</button>
        </div>
      </div>

      <!-- ToDo Goals -->
      <div class="card">
        <div class="card-hd" style="justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:7px;"><div class="card-hd-dot" style="background:#4ade80;"></div>üìã ÁõÆÊ®ô„É™„Çπ„Éà <span style="font-size:.58rem;color:var(--muted);font-weight:400;" id="todoCount">0ÂÄã</span></div>
          <button class="btn sm" onclick="openAddTodo()">Ôºã ËøΩÂä†</button>
        </div>
        <div id="todoList" style="display:flex;flex-direction:column;gap:8px;"></div>
        <div id="todoAddForm" style="display:none;background:var(--s2);border:1px solid var(--border);border-radius:12px;padding:14px;margin-top:12px;">
          <div style="font-size:.75rem;font-weight:700;margin-bottom:8px;">üìã Êñ∞„Åó„ÅÑÁõÆÊ®ô</div>
          <input id="todoTitle" placeholder="ÁõÆÊ®ô„ÅÆ„Çø„Ç§„Éà„É´" maxlength="60" style="width:100%;padding:8px 10px;background:var(--s1);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.8rem;margin-bottom:6px;box-sizing:border-box;">
          <textarea id="todoDesc" placeholder="Ë©≥Á¥∞„É°„É¢Ôºà‰ªªÊÑèÔºâ" maxlength="200" rows="2" style="width:100%;padding:8px 10px;background:var(--s1);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.7rem;resize:none;margin-bottom:6px;box-sizing:border-box;"></textarea>
          <div style="margin-bottom:8px;"><div class="inp-lbl" style="font-size:.6rem;">ÈÅîÊàêXP</div>
            <select id="todoXP" style="width:100%;padding:6px;background:var(--s1);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.75rem;">
              <option value="100">100 XPÔºàÂ∞è„Åï„ÅÑÁõÆÊ®ôÔºâ</option>
              <option value="300">300 XPÔºà‰∏≠„Åè„Çâ„ÅÑÔºâ</option>
              <option value="500" selected>500 XPÔºàÂ§ß„Åç„ÅÑÁõÆÊ®ôÔºâ</option>
              <option value="1000">1,000 XPÔºàË∂ÖÂ§ßÁâ©Ôºâ</option>
              <option value="2000">2,000 XPÔºà‰∫∫Áîü„É¨„Éô„É´Ôºâ</option>
            </select>
          </div>
          <div style="display:flex;gap:6px;">
            <button class="btn sm" onclick="addTodoItem()" style="background:linear-gradient(135deg,#4ade80,#22c55e);color:#000;font-weight:700;">ËøΩÂä†</button>
            <button class="btn sm" onclick="document.getElementById('todoAddForm').style.display='none'">„Ç≠„É£„É≥„Çª„É´</button>
          </div>
        </div>
      </div>

      <!-- Special high-xp items -->
      <div class="card">
        <div class="card-hd" style="justify-content:space-between;">
          <div style="display:flex;align-items:center;gap:7px;"><div class="card-hd-dot" style="background:var(--amber);"></div>‚≠ê ÁâπÂà•XPÈ†ÖÁõÆ</div>
          <button class="btn sm" onclick="openSpecialModal()">Ôºã ËøΩÂä†</button>
        </div>
        <div class="special-list" id="specialList"><div style="font-size:0.75rem;color:var(--muted);text-align:center;padding:10px;">ÁâπÂà•È†ÖÁõÆ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br><span style="font-size:0.65rem;">Ëá™ÂàÜ„ÅåÈáçË¶ÅË¶ñ„Åô„ÇãË°åÂãï„ÇíÁôªÈå≤„Åó„Å¶XP„Éú„Éº„Éä„Çπ„ÇíÂæó„Çà„ÅÜ</span></div></div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ==================== PAGE 2: STATS ==================== -->
<div class="page" id="page1">
<div class="wrap">
  <div class="cue-card" id="cueCard">
    <div class="cue-emoji" id="cueEmoji">üìä</div>
    <div class="cue-text"><div class="cue-main" id="cueMain">Áµ±Ë®à„ÇíÁ¢∫Ë™ç„Åó„Çà„ÅÜ</div><div class="cue-sub" id="cueSub">Ë®òÈå≤„ÅåÁ©ç„ÅøÈáç„Å™„Çã„Åª„Å©Ê¥ûÂØü„ÅåÊ∑±„Åæ„Çä„Åæ„Åô</div></div>
  </div>

  <div class="big-stats">
    <div class="bstat"><div class="bstat-icon">üî•</div><div class="bstat-val" id="bs_streak" style="color:var(--amber)">0</div><div class="bstat-lbl">Á∂ôÁ∂ö</div><div class="bstat-sub" style="color:var(--muted2)">Êó•</div></div>
    <div class="bstat"><div class="bstat-icon">‚ö°</div><div class="bstat-val" id="bs_xp" style="color:var(--green)">0</div><div class="bstat-lbl">Á¥ØË®àXP</div><div class="bstat-sub" style="color:var(--muted2)">„Éù„Ç§„É≥„Éà</div></div>
    <div class="bstat"><div class="bstat-icon">üí™</div><div class="bstat-val" id="bs_effort" style="color:var(--cyan)">0h</div><div class="bstat-lbl">Á¥ØË®àÂä™ÂäõÊôÇÈñì</div><div class="bstat-sub" id="bs_effort_sub" style="color:var(--muted2)">Ë®òÈå≤Êó•Âπ≥Âùá</div></div>
    <div class="bstat"><div class="bstat-icon">üåô</div><div class="bstat-val" id="bs_sleep" style="color:var(--violet)">--</div><div class="bstat-lbl">Âπ≥ÂùáÁù°Áú†„Çπ„Ç≥„Ç¢</div><div class="bstat-sub" style="color:var(--muted2)">/ 100ÁÇπ</div></div>
  </div>

  <div class="trend-hd">
    <div class="trend-title">Êé®Áßª„Ç∞„É©„Éï</div>
    <div class="trend-tabs"><button class="ttab active" id="trendDayBtn" onclick="setTrend('day')">Êó•Ë∂≥</button><button class="ttab" id="trendWeekBtn" onclick="setTrend('week')">ÈÄ±Ë∂≥</button></div>
  </div>
  <div class="charts-grid">
    <div class="chart-card"><div class="chart-title">„Ç´„ÉÜ„Ç¥„É™Âà•Êé®Áßª</div><div class="chart-h"><canvas id="lineChart"></canvas></div></div>
    <div class="chart-card"><div class="chart-title">Âä™ÂäõÊôÇÈñì √ó Áù°Áú†„Çπ„Ç≥„Ç¢</div><div class="chart-h"><canvas id="effortChart"></canvas></div></div>
  </div>

  <div class="card" style="margin-bottom:14px;">
    <div class="card-hd"><div class="card-hd-dot" style="background:var(--amber);"></div>ÁøíÊÖ£„ÉÅ„Çß„Éº„É≥ ‚Äî Á∂ö„Åë„Å¶Áπã„Åí„Çà„ÅÜ</div>
    <div class="hgrid" id="habitGrid"></div>
    <div id="streakRewardArea" style="margin-top:10px;display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.15);border-radius:10px;">
      <div>
        <div style="font-size:.68rem;color:var(--amber);font-weight:700;">üî• <span id="streakRewardDays">0</span>Êó•Á∂ôÁ∂ö„Éú„Éº„Éä„Çπ</div>
        <div style="font-size:.58rem;color:var(--muted2);" id="streakRewardDesc">Ë®òÈå≤„Åô„Çã„Å®„Éú„Éº„Éä„ÇπG„Åå„ÇÇ„Çâ„Åà„Åæ„Åô</div>
      </div>
      <button id="streakRewardBtn" class="gacha-btn gold" onclick="collectStreakReward()" style="font-size:.72rem;padding:6px 16px;">üì• Âèó„ÅëÂèñ„Çã</button>
    </div>
  </div>

  <div class="card">
    <div class="card-hd"><div class="card-hd-dot"></div>Ë®òÈå≤Â±•Ê≠¥</div>
    <div class="hist-list" id="histList"><div style="text-align:center;color:var(--muted);font-size:0.78rem;padding:14px;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div></div>
  </div>
</div>
</div>

<!-- ==================== PAGE 3: LIFE RPG ==================== -->
<div class="page" id="page2">
<div class="wrap">

  <!-- SLEEP XP MODIFIER DISPLAY -->
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
    <span style="font-size:.65rem;color:var(--muted2);">Áù°Áú†XPÂÄçÁéá:</span>
    <span class="sleep-xp-badge normal" id="sleepXPBadge">√ó1.0</span>
  </div>

  <!-- ECONOMY BAR -->
  <div class="eco-bar">
    <div class="eco-card wage">
      <div class="eco-label"><span style="font-size:1.6rem;vertical-align:middle;margin-right:4px;">‚è∞</span> ÁèæÂú®„ÅÆÊôÇÁµ¶</div>
      <div class="eco-big" id="wageDisplay" style="color:#f59e0b;">500 G/h</div>
      <div class="eco-unit">/ ÊôÇÈñì</div>
      <div class="eco-bar-track"><div class="eco-bar-fill" id="wageBarFill" style="width:0%;background:linear-gradient(90deg,#f59e0b,#fcd34d);"></div></div>
      <div class="eco-wage-next" id="wageNext">„Çπ„Ç≠„É´„ÇíËÇ≤„Å¶„Çã„Å®ÊôÇÁµ¶„Åå‰∏äÊòá„Åó„Åæ„Åô</div>
      <div class="wage-ladder" id="wageLadder"></div>
    </div>
    <div class="eco-card money">
      <div class="eco-label"><span style="font-size:1.6rem;vertical-align:middle;margin-right:4px;">üí∞</span> ÊâÄÊåÅÈáë</div>
      <div class="eco-big" id="goldDisplay" style="color:var(--green);">0 G</div>
      <div class="eco-unit">„Ç¥„Éº„É´„Éâ</div>
      <div class="eco-sub" id="goldToday">Êú¨Êó•„ÅÆÁ®º„Åé: 0 G</div>
      <div class="eco-sub" id="debtDisplay" style="display:none;color:var(--rose);font-weight:700;font-size:.78rem;margin-top:4px;">üí∏ „É≠„Éº„É≥ÊÆãÈ´ò: 0 G</div>
      <button id="debtPayBtn" onclick="manualPayDebt()" style="display:none;margin-top:4px;padding:5px 12px;border:none;border-radius:6px;background:linear-gradient(135deg,#ef4444,#f97316);color:#fff;font-size:.68rem;font-weight:700;cursor:pointer;">üí∏ ÊâÄÊåÅÈáë„Åã„ÇâËøîÊ∏à„Åô„Çã</button>
      <button class="work-btn" id="workBtn" onclick="openWorkModal()">‚öí ÊôÇÈñì„ÇíÊèõÈáë„Åô„Çã</button>
      <div class="wm-worked-notice" id="workedNotice" style="display:none;">‚úì ‰ªäÊó•„ÅØ„Åô„Åß„Å´ÊèõÈáëÊ∏à„Åø„Åß„Åô</div>
    </div>
    <div class="eco-card info">
      <div class="eco-label"><span style="font-size:1.6rem;vertical-align:middle;margin-right:4px;">üìä</span> ‰∏çÂä¥ÊâÄÂæó</div>
      <div class="eco-big" id="passiveDisplay" style="color:var(--green);">0 G</div>
      <div class="eco-unit">/ Êó•</div>
      <div class="eco-sub" id="passiveDetail">ÊäïË≥á„ÇÑ‰∫ãÊ•≠„Åã„ÇâÊØéÊó•Ëá™Âãï„ÅßÂèéÂÖ•„ÇíÂæó„Çâ„Çå„Åæ„Åô</div>
    </div>
  </div>

  <!-- PASSIVE INCOME COLLECT BAR -->
  <div class="passive-bar" id="passiveBar" style="display:none;">
    <div>
      <div class="passive-lbl">üì• Êú™ÂèóÂèñ„ÅÆ‰∏çÂä¥ÊâÄÂæó</div>
      <div class="passive-big" id="passiveCollectAmt">0 G</div>
    </div>
    <button class="collect-btn" id="collectBtn" onclick="collectPassive()">üì• Âèó„ÅëÂèñ„Çã</button>
  </div>

  <!-- XP bar -->
  <div style="background:var(--s1);border:1px solid rgba(74,222,128,.18);border-radius:12px;padding:11px 16px;margin-bottom:14px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
      <span style="font-size:.65rem;color:var(--muted2);">‚ö° ‰ΩøÁî®ÂèØËÉΩXP</span>
      <span style="font-family:'JetBrains Mono',monospace;font-size:.85rem;color:var(--green);font-weight:700;" id="gardenXP">0 XP</span>
    </div>
    <div class="xp-track" style="height:7px;"><div class="xp-fill" id="gardenXPBar" style="width:0%"></div></div>
  </div>

  <!-- Self status -->
  <div class="self-status">
    <div class="avatar-wrap">
      <div class="avatar-ring" id="avatarEmoji">üßë</div>
      <div class="avatar-lv-badge" id="avatarLv">Lv.1</div>
    </div>
    <div class="self-info">
      <div class="self-name-row">
        <div class="self-name">„ÅÇ„Å™„Åü</div>
        <div class="self-title-badge" id="selfTitle">Ë¶ãÁøí„ÅÑ</div>
      </div>
      <div class="self-stats-row">
        <div class="ss-stat"><div class="ss-val" id="ss_days">0</div><div class="ss-lbl">Ë®òÈå≤Êó•Êï∞</div></div>
        <div class="ss-stat"><div class="ss-val" id="ss_streak">0</div><div class="ss-lbl">ÈÄ£Á∂ö</div></div>
        <div class="ss-stat"><div class="ss-val" id="ss_effort">0h</div><div class="ss-lbl">Á¥ØË®àÂä™Âäõ</div></div>
        <div class="ss-stat"><div class="ss-val" id="ss_totalxp">0</div><div class="ss-lbl">Á∑èXP</div></div>
        <div class="ss-stat"><div class="ss-val" id="ss_wage" style="color:#f59e0b;">500 G/h</div><div class="ss-lbl">ÊôÇÁµ¶</div></div>
        <div class="ss-stat"><div class="ss-val" id="ss_gold" style="color:var(--green);">0</div><div class="ss-lbl">Á¥ØË®àÂèéÂÖ•G</div></div>
      </div>
      <div class="self-bars" id="selfBars"></div>
    </div>
  </div>

  <!-- SUB-TABS -->
  <div class="p3-subtabs">
    <button class="p3-stab active" id="p3t_skills" onclick="setP3Tab('skills')">üß¨ „Çπ„Ç≠„É´</button>
    <button class="p3-stab" id="p3t_invest" onclick="setP3Tab('invest')">üìà Ë≥áÁî£ÈÅãÁî®</button>
    <button class="p3-stab" id="p3t_life" onclick="setP3Tab('life')">üè† ÁîüÊ¥ª</button>
    <button class="p3-stab" id="p3t_town" onclick="setP3Tab('town')">üèòÔ∏è Ë°ó</button>
    <button class="p3-stab" id="p3t_slot" onclick="setP3Tab('slot')">üé∞ Â®ØÊ•Ω</button>
    <button class="p3-stab" id="p3t_ach" onclick="setP3Tab('ach')">üèÜ ÂÆüÁ∏æ</button>
  </div>

  <!-- PANEL: SKILLS -->
  <div class="p3-panel active" id="panel_skills">
    <div class="st-layout">
      <div class="st-canvas">
        <div class="st-canvas-title">
          <span>„Çπ„Ç≠„É´„ÉÑ„É™„Éº ‚Äî Ëá™Â∑±Ë®≠Ë®à</span>
          <div class="st-tabs">
            <button class="sttab active" id="sttab0" onclick="setSTTab('domains')">„Éâ„É°„Ç§„É≥</button>
            <button class="sttab" id="sttab1" onclick="setSTTab('tree')">„Çπ„Ç≠„É´</button>
          </div>
        </div>
        <div id="domainView">
          <div style="font-size:.7rem;color:var(--muted2);margin-bottom:10px;">Ë®òÈå≤ÊôÇÈñì‚Üí„Çπ„Ç≠„É´ÊàêÈï∑‚ÜíÊôÇÁµ¶‰∏äÊòá‚Üí„Ç¥„Éº„É´„Éâ‚ÜíË≥áÁî£ÈÅãÁî® „ÅÆÂÆåÂÖ®„Å™„É´„Éº„Éó</div>
          <div class="domain-grid" id="domainGrid"></div>
        </div>
        <div id="treeView" style="display:none;">
          <div style="display:flex;align-items:center;gap:7px;margin-bottom:10px;">
            <button class="btn sm" onclick="setSTTab('domains')">‚Üê Êàª„Çã</button>
            <span style="font-size:.8rem;font-weight:800;" id="selectedDomainName"></span>
          </div>
          <div id="skillTreeSVGWrap"></div>
        </div>
      </div>
      <div class="st-right">
        <div class="skill-detail" id="skillDetail">
          <div class="sd-empty">‚Üê „Çπ„Ç≠„É´„ÇíÈÅ∏Êäû<br><span style="font-size:.65rem;display:block;margin-top:4px;">„Éâ„É°„Ç§„É≥„Ç´„Éº„Éâ„Çí„ÇØ„É™„ÉÉ„ÇØ</span></div>
        </div>
        <div class="event-log">
          <div class="el-title">üìñ ÊàêÈï∑„ÅÆË®òÈå≤</div>
          <div class="el-list" id="eventLog"><div style="text-align:center;color:var(--muted);font-size:.72rem;padding:10px;">Ë®òÈå≤„ÇíÂßã„ÇÅ„Çã„Å®Áâ©Ë™û„ÅåÂãï„ÅçÂá∫„Åó„Åæ„Åô</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PANEL: INVESTMENTS -->
  <div class="p3-panel" id="panel_invest">
    <div class="card" style="margin-bottom:12px;">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--green);"></div>üìà Ê†™ÂºèÊäïË≥á</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:8px;">Ê†™‰æ°„ÅØÊó•„ÄÖÂ§âÂãï„Åó„Åæ„Åô„ÄÇË§áÊï∞Âè£Ë≥ºÂÖ•„ÉªÂ£≤Âç¥ÂèØËÉΩ„ÄÇÂÆâ„ÅèË≤∑„Å£„Å¶È´ò„ÅèÂ£≤„Çç„ÅÜ„ÄÇ</div>
      <div class="inv-grid" id="stockGrid"></div>
    </div>
    <div class="card" style="margin-bottom:12px;">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--amber);"></div>üè† ‰∏çÂãïÁî£</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:8px;">Ë§áÊï∞Áâ©‰ª∂„Çí‰øùÊúâÂèØËÉΩ„ÄÇÂÆ∂Ë≥É„ÅØÊúà1ÂõûÂõûÂèé„ÄÇÁâ©‰ª∂„ÅØÁµåÂπ¥„ÅßÊ∏õ‰æ°„Åó„Åæ„Åô„ÄÇ</div>
      <button id="rentCollectBtn" onclick="collectRent()" style="display:none;width:100%;padding:8px;margin-bottom:8px;border:none;border-radius:8px;background:linear-gradient(135deg,#4ade80,#22d3ee);color:#000;font-size:.78rem;font-weight:700;cursor:pointer;">üè† ÂÆ∂Ë≥É„ÇíÂõûÂèé„Åô„Çã</button>
      <div class="inv-grid" id="realEstateGrid"></div>
    </div>
    <div class="card" style="margin-bottom:12px;">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--violet);"></div>üè¢ ‰∫ãÊ•≠„Éª‰∫∫Êùê</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:8px;">Ë°ó„ÅÆ‰∫∫Âè£„Åã„ÇâÂæìÊ•≠Âì°„ÇíÈõáÁî®„ÄÇÂêå„Åò‰∫ãÊ•≠„ÇíË§áÊï∞Ë®≠Á´ãÂèØËÉΩ„ÄÇ‰∫∫Âè£„ÅåË∂≥„Çä„Å™„ÅÑ„Å®Èõá„Åà„Åæ„Åõ„Çì„ÄÇ</div>
      <div class="inv-grid" id="businessGrid"></div>
    </div>
  </div>

  <!-- PANEL: TOWN -->
  <div class="p3-panel" id="panel_town">
    <!-- Town Title & Rank -->
    <div style="background:linear-gradient(180deg,#060e1e,#0a1428);border:1px solid rgba(56,189,248,.12);border-radius:16px;padding:16px;margin-bottom:12px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:var(--cyan);">üèòÔ∏è „Éû„Ç§„Çø„Ç¶„É≥</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:.65rem;color:var(--muted2);" id="townPopLabel">‰∫∫Âè£: 0‰∫∫</span>
          <span style="font-size:.65rem;background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.25);color:var(--cyan);padding:2px 8px;border-radius:8px;font-family:'JetBrains Mono',monospace;" id="townRankBadge">Êùë</span>
        </div>
      </div>
      <div id="townGridVis" style="display:flex;flex-wrap:wrap;gap:6px;min-height:70px;align-items:flex-start;"></div>
      <div id="townPop" style="font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--cyan);margin-top:8px;"></div>
      <!-- Town rank progress -->
      <div style="margin-top:8px;">
        <div style="display:flex;justify-content:space-between;font-size:.6rem;color:var(--muted2);margin-bottom:3px;">
          <span id="townRankLabel">Ê¨°„ÅÆ„É©„É≥„ÇØ: ÈõÜËêΩ</span>
          <span id="townRankProg">0/50‰∫∫</span>
        </div>
        <div class="xp-track" style="height:6px;"><div class="xp-fill" id="townRankBar" style="width:0%;background:linear-gradient(90deg,#38bdf8,#818cf8);"></div></div>
      </div>
      <!-- Town bonus display -->
      <div style="margin-top:8px;padding:8px;background:rgba(56,189,248,.06);border:1px solid rgba(56,189,248,.12);border-radius:8px;">
        <div style="font-size:.6rem;color:var(--muted2);margin-bottom:3px;">üéÅ Ë°ó„É©„É≥„ÇØ„Éú„Éº„Éä„Çπ</div>
        <div style="font-size:.68rem;color:var(--cyan);font-family:'JetBrains Mono',monospace;" id="townBonusText">„Éú„Éº„Éä„Çπ„Å™„Åó</div>
      </div>
    </div>
    <!-- Build shop -->
    <div class="card">
      <div class="card-hd" style="justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:6px;"><div class="card-hd-dot" style="background:#f59e0b;"></div>Âª∫Ë®≠„Ç∑„Éß„ÉÉ„Éó</div>
        <span style="font-size:.65rem;color:var(--muted2);">ÊâÄÊåÅÈáë: <span id="shopGoldLabel" style="color:#f59e0b;font-family:'JetBrains Mono',monospace;">0 G</span></span>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;max-height:600px;overflow-y:auto;" id="bldShop"></div>
    </div>
  </div>

  <!-- PANEL: LIFE (ÁîüÊ¥ªÊ∞¥Ê∫ñ) -->
  <div class="p3-panel" id="panel_life">
    <!-- Housing -->
    <div class="card" style="margin-bottom:12px;">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--amber);"></div>üè† ‰ΩèÂ±Ö„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:4px;">‰Ωè„Åæ„ÅÑ„ÇíËâØ„Åè„Åô„Çã„Å®XP„Éú„Éº„Éä„Çπ„ÅåÊ∞∏Á∂öÁöÑ„Å´‰∏ä„Åå„Çä„Åæ„Åô„ÄÇ</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:10px;background:var(--s2);border:1px solid var(--border);border-radius:10px;">
        <span style="font-size:2rem;" id="curHousingIcon">üõñ</span>
        <div>
          <div style="font-size:.82rem;font-weight:700;" id="curHousingName">ÈáéÂÆø</div>
          <div style="font-size:.6rem;color:var(--muted2);" id="curHousingBonus">XP„Éú„Éº„Éä„Çπ: +0%</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:5px;" id="housingList"></div>
    </div>
    <!-- Interior -->
    <div class="card" style="margin-bottom:12px;">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--rose);"></div>üõãÔ∏è „Ç§„É≥„ÉÜ„É™„Ç¢</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:8px;">ÂÆ∂ÂÖ∑„ÇÑË®≠ÂÇô„ÇíÊèÉ„Åà„Å¶XP„Éú„Éº„Éä„Çπ„Çí„Åï„Çâ„Å´Á©ç„Åø‰∏ä„Åí„Çà„ÅÜ„ÄÇ</div>
      <div class="inv-grid" id="interiorGrid"></div>
    </div>
    <!-- Subscriptions -->
    <div class="card">
      <div class="card-hd"><div class="card-hd-dot" style="background:var(--violet);"></div>üì± „Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥</div>
      <div style="font-size:.68rem;color:var(--muted2);margin-bottom:8px;">ÊØéÊó•„Ç≥„Çπ„Éà„Åå„Åã„Åã„Çã„ÅåXPÂÄçÁéá„Éú„Éº„Éä„Çπ„ÄÇËß£Á¥Ñ„ÇÇÂèØËÉΩ„ÄÇ</div>
      <div class="lifestyle-grid" id="lifestyleGrid"></div>
    </div>
  </div>

  <!-- PANEL: SLOT -->
  <div class="p3-panel" id="panel_slot">
    <!-- Entertainment sub-tabs -->
    <div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;">
      <button class="btn sm" id="entTab_slot" onclick="setEntTab('slot')" style="background:var(--s3);border-color:var(--orange);color:var(--orange);">üé∞ „Çπ„É≠„ÉÉ„Éà</button>
      <button class="btn sm" id="entTab_pachinko" onclick="setEntTab('pachinko')" style="background:var(--s2);">üîÆ „Éï„Ç©„Éº„ÉÅ„É•„É≥„Éû„Ç∑„É≥</button>
      <button class="btn sm" id="entTab_mystery" onclick="setEntTab('mystery')" style="background:var(--s2);">üéÅ „Éä„Çæ„Ç¨„ÉÅ„É£</button>
      <button class="btn sm" id="entTab_luxgacha" onclick="setEntTab('luxgacha')" style="background:var(--s2);">üíé È´òÁ¥ö„Ç¨„ÉÅ„É£</button>
      <button class="btn sm" id="entTab_loan" onclick="setEntTab('loan')" style="background:var(--s2);">üè¶ Ê∂àË≤ªËÄÖÈáëËûç</button>
    </div>


      <div style="background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.2);border-radius:10px;padding:10px 14px;margin-bottom:14px;font-size:.65rem;color:var(--muted2);line-height:1.6;text-align:center;">
        ‚ö†Ô∏è <span style="color:var(--cyan);font-weight:700;">Ê≥®ÊÑè</span>Ôºö„Åì„ÅÆ„Ç≤„Éº„É†ÂÜÖ„ÅÆ„Äå„Éï„Ç©„Éº„ÉÅ„É•„É≥„Éû„Ç∑„É≥„Äç„Äå„Çπ„É≠„ÉÉ„Éà„Äç„ÄåÊ∂àË≤ªËÄÖÈáëËûç„ÄçÁ≠â„ÅØ„Åô„Åπ„Å¶<span style="font-weight:700;color:var(--text);">Êû∂Á©∫„ÅÆ„Ç≤„Éº„É†ÂÜÖÈÄöË≤®Ôºà„Ç¥„Éº„É´„ÉâÔºâ</span>„Çí‰ΩøÁî®„Åô„ÇãÊºîÂá∫„Åß„Åô„ÄÇÁèæÂÆü„ÅÆÈáëÈä≠„ÉªË≥≠Âçö„ÉªÈáëËûçÂèñÂºï„Å®„ÅØ‰∏ÄÂàáÈñ¢‰øÇ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÆâÂøÉ„Åó„Å¶„Ç≤„Éº„É†„Çí„ÅäÊ•Ω„Åó„Åø„Åè„Å†„Åï„ÅÑ„ÄÇ
      </div>
    <!-- SLOT -->
    <div id="entPanel_slot">
      <div class="slot-box" style="max-width:420px;margin:0 auto;">
        <div class="slot-title">üé∞ „Çπ„É≠„ÉÉ„Éà„Éû„Ç∑„É≥</div>
        <div class="gacha-desc">ÈÅãË©¶„ÅóÔºÅ ÊúüÂæÖÂÄ§„ÅØ„Éû„Ç§„Éä„Çπ„Å†„Åë„Å©ÂΩì„Åü„Çå„Å∞„Éá„Ç´„ÅÑ„ÄÇ<br>777„ÅßË∂Ö„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„ÉàÔºÅ</div>
        <div class="slot-reels">
          <div class="slot-reel" id="reel0">üçí</div>
          <div class="slot-reel" id="reel1">üçã</div>
          <div class="slot-reel" id="reel2">‚≠ê</div>
        </div>
        <button class="gacha-btn gold" onclick="spinSlot()">Âõû„Åô (80G)</button>
        <div class="slot-result" id="slotResult"></div>
        <div style="margin-top:12px;font-size:.6rem;color:var(--muted);text-align:center;">
          3„Å§ÊèÉ„ÅÑ: +250„Äú5000G | 2„Å§ÊèÉ„ÅÑ: +20G | „ÅØ„Åö„Çå: -80G<br>
          ÊúüÂæÖÂÄ§: Á¥Ñ -30G/Âõû ‚Äª Â®ØÊ•Ω„Åß„Åô
        </div>
      </div>
    </div>

    <!-- PACHINKO (3 machines) -->
    <div id="entPanel_pachinko" style="display:none;">
      <div style="display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap;">
        <button class="btn sm pachi-sel active" id="pachiSel_std" onclick="setPachiMachine('std')" style="flex:1;font-size:.58rem;">üîÆ „Éï„Ç©„Éº„ÉÅ„É•„É≥„Çπ„Éî„É≥</button>
        <button class="btn sm pachi-sel" id="pachiSel_umi" onclick="setPachiMachine('umi')" style="flex:1;font-size:.58rem;">üåä „É©„ÉÉ„Ç≠„Éº„Ç™„Éº„Ç∑„É£„É≥</button>
        <button class="btn sm pachi-sel" id="pachiSel_gen" onclick="setPachiMachine('gen')" style="flex:1;font-size:.58rem;">‚ö° „Ç¥„Éº„É´„Éâ„É©„ÉÉ„Ç∑„É•</button>
      </div>

      <!-- Machine 1: Standard -->
      <div id="pachiPanel_std" style="max-width:460px;margin:0 auto;background:linear-gradient(135deg,#1a0a1e,#0f0825);border:1px solid rgba(192,132,252,.3);border-radius:16px;padding:20px;text-align:center;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:#c084fc;margin-bottom:4px;">üîÆ „Éï„Ç©„Éº„ÉÅ„É•„É≥„Çπ„Éî„É≥</div>
        <div class="gacha-desc">„Éï„Ç£„Éº„Éê„ÉºÁ™ÅÂÖ•„ÅßÈÄ£„ÉÅ„É£„É≥„ÅÆÂ§ß„ÉÅ„É£„É≥„ÇπÔºÅ</div>
        <div id="pachinkoField" style="position:relative;width:240px;height:200px;margin:10px auto;background:radial-gradient(ellipse at 50% 30%,#2a1040,#0d0518);border:2px solid rgba(192,132,252,.3);border-radius:14px;overflow:hidden;"><canvas id="pachinkoCanvas" width="240" height="200" style="width:100%;height:100%;"></canvas></div>
        <div style="display:flex;justify-content:center;gap:10px;margin:8px 0;">
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">Áä∂ÊÖã</div><div id="pachinkoMode" style="font-size:.72rem;font-weight:800;">ÈÄöÂ∏∏</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">ÊôÇÁü≠</div><div id="pachinkoJitan" style="font-size:.72rem;font-weight:800;">--</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">ÈÄ£„ÉÅ„É£„É≥</div><div id="pachinkoChain" style="font-size:.72rem;font-weight:800;color:#c084fc;">0</div></div>
        </div>
        <div style="display:flex;justify-content:center;gap:6px;margin:8px 0;"><div class="slot-reel" id="pDrum0" style="border-color:rgba(192,132,252,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="pDrum1" style="border-color:rgba(192,132,252,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="pDrum2" style="border-color:rgba(192,132,252,.4);font-size:1.4rem;">-</div></div>
        <div id="pachinkoResult" style="font-size:.78rem;min-height:22px;margin:6px 0;color:var(--amber);"></div>
        <div style="display:flex;justify-content:center;gap:6px;"><button class="gacha-btn" onclick="playPachinko()" id="pachinkoBtn" style="background:linear-gradient(135deg,#a855f7,#7c3aed);color:#fff;">Êâì„Å§ (100G)</button><button class="gacha-btn" onclick="playPachinko(true)" id="pachinkoBtn2" style="background:linear-gradient(135deg,#7c3aed55,#a855f755);color:#c084fc;font-size:.7rem;border:1px solid rgba(168,85,247,.4);">„Éü„Éã (10G)</button></div>
        <div style="margin-top:10px;font-size:.55rem;color:var(--muted);line-height:1.5;">1/10 ‚Üí „Éï„Ç£„Éº„Éê„Éº1/3 | „Éï„Ç£„Éº„Éê„Éº50% | +400„Äú2500G | ÊúüÂæÖÂÄ§85%</div>
      </div>

      <!-- Machine 2: Lucky Ocean („Éï„Ç£„Éº„Éê„Éº„É´„Éº„Éó) -->
      <div id="pachiPanel_umi" style="display:none;max-width:460px;margin:0 auto;background:linear-gradient(135deg,#051520,#081028);border:1px solid rgba(56,189,248,.3);border-radius:16px;padding:20px;text-align:center;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:#38bdf8;margin-bottom:4px;">üåä „É©„ÉÉ„Ç≠„Éº„Ç™„Éº„Ç∑„É£„É≥</div>
        <div class="gacha-desc">„Éï„Ç£„Éº„Éê„Éº„É´„Éº„Éó„ÅßÂÆâÂÆöÈÄ£„ÉÅ„É£„É≥ÔºÅÂΩì„Åü„Çå„Å∞65%„ÅßÂÜç„Éï„Ç£„Éº„Éê„Éº„ÄÇ</div>
        <div style="display:flex;justify-content:center;gap:10px;margin:10px 0;">
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">Áä∂ÊÖã</div><div id="umiMode" style="font-size:.72rem;font-weight:800;">ÈÄöÂ∏∏</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">ÈÄ£„ÉÅ„É£„É≥</div><div id="umiChain" style="font-size:.72rem;font-weight:800;color:#38bdf8;">0</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">„Éï„Ç£„Éº„Éê„Éº„É´„Éº„Éó</div><div id="umiLoop" style="font-size:.72rem;font-weight:800;">--</div></div>
        </div>
        <div style="display:flex;justify-content:center;gap:6px;margin:8px 0;"><div class="slot-reel" id="uDrum0" style="border-color:rgba(56,189,248,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="uDrum1" style="border-color:rgba(56,189,248,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="uDrum2" style="border-color:rgba(56,189,248,.4);font-size:1.4rem;">-</div></div>
        <div id="umiResult" style="font-size:.78rem;min-height:22px;margin:6px 0;color:var(--amber);"></div>
        <div style="display:flex;justify-content:center;gap:6px;"><button class="gacha-btn" onclick="playUmi()" id="umiBtn" style="background:linear-gradient(135deg,#0ea5e9,#0369a1);color:#fff;">Êâì„Å§ (80G)</button><button class="gacha-btn" onclick="playUmi(true)" id="umiBtn2" style="background:linear-gradient(135deg,#0369a155,#0ea5e955);color:#38bdf8;font-size:.7rem;border:1px solid rgba(56,189,248,.4);">„Éü„Éã (8G)</button></div>
        <div style="margin-top:10px;font-size:.55rem;color:var(--muted);line-height:1.5;">1/320 ‚Üí „Éï„Ç£„Éº„Éê„Éº1/40 | „Éï„Ç£„Éº„Éê„Éº„É´„Éº„Éó65% | +1500„Äú5000G | ÊúüÂæÖÂÄ§85%</div>
      </div>

      <!-- Machine 3: Gold Rush -->
      <div id="pachiPanel_gen" style="display:none;max-width:460px;margin:0 auto;background:linear-gradient(135deg,#1a1005,#201008);border:1px solid rgba(251,191,36,.3);border-radius:16px;padding:20px;text-align:center;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:#fbbf24;margin-bottom:4px;">‚ö° „Ç¥„Éº„É´„Éâ„É©„ÉÉ„Ç∑„É•</div>
        <div class="gacha-desc">ÂàùÂΩì„Åü„ÇäËªΩ„ÇÅÔºÅRUSHÁ™ÅÂÖ•„ÅßÁàÜÈÄüÈÄ£„ÉÅ„É£„É≥ÔºÅ‰ΩìÊÑü„Çπ„Éî„Éº„ÉâÂº∑ÁÉà„ÄÇ</div>
        <div style="display:flex;justify-content:center;gap:10px;margin:10px 0;">
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">Áä∂ÊÖã</div><div id="genMode" style="font-size:.72rem;font-weight:800;">ÈÄöÂ∏∏</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">ÈÄ£„ÉÅ„É£„É≥</div><div id="genChain" style="font-size:.72rem;font-weight:800;color:#fbbf24;">0</div></div>
          <div style="background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;"><div style="font-size:.5rem;color:var(--muted2);">RUSH</div><div id="genRush" style="font-size:.72rem;font-weight:800;">--</div></div>
        </div>
        <div style="display:flex;justify-content:center;gap:6px;margin:8px 0;"><div class="slot-reel" id="gDrum0" style="border-color:rgba(251,191,36,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="gDrum1" style="border-color:rgba(251,191,36,.4);font-size:1.4rem;">-</div><div class="slot-reel" id="gDrum2" style="border-color:rgba(251,191,36,.4);font-size:1.4rem;">-</div></div>
        <div id="genResult" style="font-size:.78rem;min-height:22px;margin:6px 0;color:var(--amber);"></div>
        <div style="display:flex;justify-content:center;gap:6px;"><button class="gacha-btn" onclick="playGen()" id="genBtn" style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;">Êâì„Å§ (60G)</button><button class="gacha-btn" onclick="playGen(true)" id="genBtn2" style="background:linear-gradient(135deg,#d9770655,#f59e0b55);color:#fbbf24;font-size:.7rem;border:1px solid rgba(251,191,36,.4);">„Éü„Éã (6G)</button></div>
        <div style="margin-top:10px;font-size:.55rem;color:var(--muted);line-height:1.5;">1/199 ‚Üí RUSH1/8 | RUSHÁ™ÅÂÖ•30% Á∂ôÁ∂ö81% | +300„Äú2000G | ÊúüÂæÖÂÄ§85%</div>
      </div>
    </div>

    </div>
    <div id="entPanel_mystery" style="display:none;">
      <div style="max-width:460px;margin:0 auto;background:linear-gradient(135deg,#0a1518,#081020);border:1px solid rgba(0,212,255,.25);border-radius:16px;padding:20px;text-align:center;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:var(--cyan);margin-bottom:4px;">üéÅ „Éä„Çæ„Ç¨„ÉÅ„É£ ÔΩû„Çà„Åè„Çè„Åã„Çâ„Å™„ÅÑ„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÔΩû</div>
        <div class="gacha-desc">‰∏Ä‰Ωì„Å™„Å´„ÅåÂá∫„Çã„ÅÆ„Åã„ÄÅË™∞„Å´„ÇÇ„Çè„Åã„Çâ„Å™„ÅÑ„ÄÇ<br>ÂÖ®123Á®Æ„Ç≥„É≥„Éó„É™„Éº„Éà„ÇíÁõÆÊåá„ÅõÔºÅ</div>
        <div id="mysteryGachaDisplay" style="width:80px;height:80px;margin:14px auto;background:var(--s2);border:2px solid var(--border);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:2.5rem;transition:all .3s;">‚ùì</div>
        <div id="mysteryGachaResult" style="font-size:.82rem;min-height:24px;margin:8px 0;"></div>
        <div style="display:flex;justify-content:center;gap:8px;margin:10px 0;">
          <button class="gacha-btn" onclick="pullMysteryGacha(1)" style="background:linear-gradient(135deg,#06b6d4,#0891b2);color:#fff;">1Âõû (50G)</button>
          <button class="gacha-btn" onclick="pullMysteryGacha(10)" style="background:linear-gradient(135deg,#0ea5e9,#0284c7);color:#fff;">10ÈÄ£ (450G)</button>
        </div>
        <div style="margin:10px 0;font-size:.72rem;color:var(--cyan);font-weight:700;">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥: <span id="mysteryCollCount">0</span> / 123</div>
        <div style="background:var(--s1);border:1px solid var(--border);border-radius:6px;height:8px;overflow:hidden;margin-bottom:10px;">
          <div id="mysteryCollBar" style="height:100%;background:linear-gradient(90deg,var(--cyan),#06b6d4);width:0%;transition:width .5s;"></div>
        </div>
        <!-- Collection grid -->
        <div id="mysteryCollGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(32px,1fr));gap:3px;max-height:250px;overflow-y:auto;padding:4px;"></div>
      </div>
    </div>

    <!-- LUXURY GACHA -->
    <div id="entPanel_luxgacha" style="display:none;">
      <div class="card" style="max-width:420px;margin:0 auto;background:linear-gradient(135deg,var(--s1),#120820);border-color:rgba(168,85,247,.2);">
        <div class="card-hd"><div class="card-hd-dot" style="background:var(--violet);"></div>üíé È´òÁ¥ö„Ç§„É≥„ÉÜ„É™„Ç¢„Ç¨„ÉÅ„É£</div>
        <div style="font-size:.68rem;color:var(--muted2);margin-bottom:10px;">Ë∂Ö„É¨„Ç¢„Å™„Ç§„É≥„ÉÜ„É™„Ç¢„ÅåÂΩì„Åü„Çã„Åã„ÇÇ„ÄÇ„Ç∑„Éß„ÉÉ„Éó„Åß„ÅØË≤∑„Åà„Å™„ÅÑÈôêÂÆöÂìÅ„ÄÇ</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="gacha-btn violet" onclick="luxuryGacha()">Âõû„Åô (10,000G)</button>
          <span style="font-size:.6rem;color:var(--muted2);" id="luxGachaOwned">0/5 „Ç≥„É≥„Éó</span>
        </div>
        <div id="luxGachaResult" style="margin-top:8px;font-size:.75rem;min-height:24px;"></div>
      </div>
    </div>

    <!-- CONSUMER FINANCE -->
    <div id="entPanel_loan" style="display:none;">
      <div style="max-width:480px;margin:0 auto;background:linear-gradient(135deg,#0f1a0a,#0a1510);border:1px solid rgba(74,222,128,.2);border-radius:16px;padding:20px;">
        <div style="font-family:'DotGothic16',monospace;font-size:1rem;color:#4ade80;margin-bottom:2px;">üè¶ TF„Éï„Ç°„Ç§„Éä„É≥„Çπ</div>
        <div style="font-size:.55rem;color:var(--muted);margin-bottom:12px;line-height:1.6;">
          Ë≤∏ÈáëÊ•≠ÁôªÈå≤Áï™Âè∑ „Çø„Ç§„É†„Éï„É≠„ÉºË≤°ÂãôÂ±ÄÈï∑Ôºà3ÔºâÁ¨¨4219Âè∑<br>
          Êó•Êú¨Ë≤∏ÈáëÊ•≠Âçî‰ºö‰ºöÂì° Á¨¨TF001234Âè∑
        </div>

        <!-- Status -->
        <div id="loanStatus" style="background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px;"></div>

        <!-- Application / Management -->
        <div id="loanActions"></div>

        <!-- Fine print -->
        <div style="margin-top:14px;font-size:.52rem;color:rgba(100,116,139,.6);line-height:1.7;border-top:1px solid var(--border);padding-top:8px;">
          ‚ñ† ÂÆüË≥™Âπ¥Áéá 4.5„Äú18.0%ÔºàÂà©ÊÅØÂà∂ÈôêÊ≥ï„Å´Âü∫„Å•„ÅèÔºâ<br>
          ‚ñ† ÂÖÉÊú¨10‰∏áGÊú™Ê∫Ä: Âπ¥20% / 10‰∏á„Äú100‰∏áGÊú™Ê∫Ä: Âπ¥18% / 100‰∏áG‰ª•‰∏ä: Âπ¥15%<br>
          ‚ñ† Ë≤∏ÈáëÊ•≠Ê≥ï„Å´Âü∫„Å•„ÅèÁ∑èÈáèË¶èÂà∂: ÂÄüÂÖ•‰∏äÈôê„ÅØÂπ¥Âèé„ÅÆ1/3„Åæ„Åß<br>
          ‚ñ† ËøîÊ∏àÊñπÂºè: ÂÖÉÂà©‰∏ÄÊã¨ËøîÊ∏à / ÈöèÊôÇËøîÊ∏à<br>
          ‚ñ† „ÅîÂà©Áî®„ÅØË®àÁîªÁöÑ„Å´„ÄÇ<br>
          ‚ñ† ÂØ©Êüª„ÅÆÁµêÊûú„ÄÅ„ÅîÂ∏åÊúõ„Å´Ê∑ª„Åà„Å™„ÅÑÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
        </div>
      </div>
    </div>

  </div>
    <!-- PANEL: ACHIEVEMENTS -->
  <div class="p3-panel" id="panel_ach">
    <div style="font-size:.7rem;color:var(--muted2);margin-bottom:8px;">ÂÆüÁ∏æ„ÇíËß£Èô§„Åô„Çã„Å®Ê∞∏Á∂ö„Éú„Éº„Éä„Çπ„ÅåÂæó„Çâ„Çå„Åæ„Åô„ÄÇ</div>
    <div class="ach-grid" id="achGrid"></div>

    <!-- REBIRTH SECTION -->
    <div style="margin-top:20px;background:linear-gradient(135deg,#0f051a,#1a0a2e);border:2px solid rgba(192,132,252,.25);border-radius:16px;padding:20px;text-align:center;">
      <div style="font-family:'DotGothic16',monospace;font-size:1.1rem;color:#c084fc;">‚è≥ ÊôÇ„ÅÆÈÅ∫Áî£ ‚Äî Ëª¢Áîü</div>
      <div style="font-size:.68rem;color:var(--muted2);margin:6px 0 12px;">ÂÖ®„Å¶„ÇíÊ•µ„ÇÅ„ÅóËÄÖ„Å†„Åë„ÅåÂà∞ÈÅî„Åß„Åç„ÇãÊñ∞„Åü„Å™ÊóÖË∑Ø„ÄÇ<br>Ëª¢Áîü„Åô„Çã„Å®„Éú„Éº„Éä„Çπ‰ªò„Åç„Åß2Âë®ÁõÆ„ÅåÂßã„Åæ„Çã„ÄÇ</div>
      <div id="rebirthStatus" style="margin-bottom:12px;"></div>
      <div id="rebirthConditions" style="text-align:left;margin-bottom:12px;"></div>
      <button id="rebirthBtn" onclick="doRebirth()" disabled style="padding:12px 30px;border:2px solid rgba(192,132,252,.4);border-radius:12px;background:rgba(192,132,252,.1);color:#c084fc;font-size:.9rem;font-weight:800;cursor:pointer;transition:all .3s;font-family:'DotGothic16',monospace;">‚è≥ Ëª¢Áîü„Åô„Çã</button>
    </div>
  </div>

</div>
</div>

<!-- Awakening animation overlay -->
<div class="awakening-overlay" id="awakeningOverlay">
  <div class="awakening-box">
    <div class="aw-particles" id="awParticles">‚ú®</div>
    <div class="aw-title" id="awTitle">Ë¶öÈÜí</div>
    <div class="aw-sub" id="awSub"></div>
    <button class="aw-close" onclick="closeAwakening()">Âèó„ÅëÂÖ•„Çå„Çã</button>
  </div>
</div>

<!-- WORK MODAL -->
<div class="overlay" id="workOverlay">
  <div class="work-modal">
    <div class="wm-title">‚öí ÊôÇÈñì„ÇíÊèõÈáë„Åô„Çã</div>
    <div class="wm-sub">Ë®òÈå≤„Åó„ÅüÂä™ÂäõÊôÇÈñìÔºà‰ªï‰∫ã„ÉªÂ≠¶Áøí„ÉªÈÅãÂãïÔºâ„ÇíÊèõÈáë„Åß„Åç„Åæ„Åô„ÄÇ</div>
    <div style="text-align:center;font-size:.72rem;color:var(--cyan);margin-bottom:8px;">ÊèõÈáëÂèØËÉΩ: <strong id="workAvailHours" style="font-family:'JetBrains Mono',monospace;">0h</strong></div>
    <div class="wm-wage-box">
      <div style="font-size:.62rem;color:var(--muted2);margin-bottom:2px;">ÁèæÂú®„ÅÆÊôÇÁµ¶</div>
      <div class="wm-wage-big" id="workModalWage">500 G/h</div>
      <div class="wm-wage-lbl">/ ÊôÇÈñì</div>
    </div>
    <div class="inp-lbl" style="margin-bottom:4px;">ÊèõÈáë„Åô„ÇãÊôÇÈñìÊï∞</div>
    <input type="number" class="wm-hours-inp" id="workHoursInput" value="1" min="0.1" max="24" step="0.5" oninput="updateWorkPreview()">
    <div class="wm-preview">Áç≤Âæó‰∫àÂÆö: <strong id="workPreviewGold">500 G</strong></div>
    <div style="display:flex;gap:8px;">
      <button class="btn primary" style="flex:1;background:linear-gradient(135deg,#f59e0b,#fb923c);border:none;color:#000;font-weight:800;" onclick="doWork()">üí∞ ÊèõÈáë„Åô„Çã</button>
      <button class="btn" style="flex:1;" onclick="closeModal('workOverlay')">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
    <div style="font-size:.6rem;color:var(--muted);margin-top:9px;text-align:center;">‚Äª ‰ªï‰∫ã„ÉªÂ≠¶Áøí„ÉªÈÅãÂãï„ÅÆÊú™ÊèõÈáëÊôÇÈñì„ÅÆ„ÅøÂØæË±°</div>
  </div>
</div>

<!-- REWARD OVERLAY -->
<div class="overlay" id="rewardOverlay">
  <div class="reward-box">
    <span class="reward-emoji" id="rewardEmoji">üéâ</span>
    <div class="reward-title" id="rewardTitle">ÈÅîÊàêÔºÅ</div>
    <div class="reward-sub" id="rewardSub"></div>
    <button class="reward-close" onclick="closeReward()">Á∂ö„Åë„Çã ‚Üí</button>
  </div>
</div>

<!-- SPECIAL ITEM MODAL -->
<div class="modal-overlay" id="specialModal">
  <div class="modal-box">
    <div class="modal-title">‚≠ê ÁâπÂà•XPÈ†ÖÁõÆ„ÇíËøΩÂä†</div>
    <div style="font-size:0.75rem;color:var(--muted2);margin-bottom:12px;">Ëá™ÂàÜ„ÅåÈáçË¶ÅË¶ñ„Åô„ÇãË°åÂãï„ÇíÁôªÈå≤„ÄÇË®òÈå≤„Åô„Çã„Å®È´ò„ÅÑXP„ÇíÂæó„Çâ„Çå„Åæ„Åô„ÄÇ</div>
    <div class="modal-row">
      <div><div class="inp-lbl">È†ÖÁõÆÂêç</div><input type="text" id="si_name" placeholder="‰æã: ÁûëÊÉ≥"></div>
      <div><div class="inp-lbl">„Ç´„ÉÜ„Ç¥„É™</div>
        <select class="sel" id="si_cat">
          <option value="‰ªï‰∫ã">üíº ‰ªï‰∫ã</option><option value="Â≠¶Áøí">üìö Â≠¶Áøí</option>
          <option value="ÈÅãÂãï">üèÉ ÈÅãÂãï</option><option value="Ë∂£Âë≥">üéÆ Ë∂£Âë≥</option>
          <option value="„Åù„ÅÆ‰ªñ">üìã „Åù„ÅÆ‰ªñ</option>
        </select>
      </div>
    </div>
    <div class="modal-row">
      <div><div class="inp-lbl">ÁõÆÊ®ôÊôÇÈñì (ÂàÜ)</div><input type="number" id="si_mins" value="30" min="5" max="480"></div>
      <div><div class="inp-lbl">XPÂÄçÁéá</div>
        <select class="sel" id="si_multi">
          <option value="2">√ó2 (ÈáçË¶Å)</option><option value="3">√ó3 (ÊúÄÈáçË¶Å)</option>
          <option value="5">√ó5 (ÊúÄÂÑ™ÂÖà)</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn primary" style="flex:1;" onclick="addSpecialItem()">ËøΩÂä†„Åô„Çã</button>
      <button class="btn modal-close" onclick="closeModal('specialModal')">„Ç≠„É£„É≥„Çª„É´</button>
    </div>
  </div>
</div>

<!-- PLOT MODAL -->
<div class="modal-overlay" id="plotModal">
  <div class="modal-box" id="plotModalContent"></div>
</div>

<div class="toast" id="toast"><span id="toastIcon">‚úì</span> <span id="toastMsg"></span></div>

<script>
// ================================================================
// CONFIG
// ================================================================
const CATS = {
  '‰ªï‰∫ã':  {color:'#38bdf8',effort:true, emoji:'üíº'},
  'Â≠¶Áøí':  {color:'#818cf8',effort:true, emoji:'üìö'},
  'ÈÅãÂãï':  {color:'#4ade80',effort:true, emoji:'üèÉ'},
  'Ë∂£Âë≥':  {color:'#fbbf24',effort:false,emoji:'üéÆ'},
  'È£ü‰∫ã':  {color:'#fb923c',effort:false,emoji:'üç±'},
  '‰ºëÊÜ©':  {color:'#6b7280',effort:false,emoji:'‚òï'},
  'ÁßªÂãï':  {color:'#a78bfa',effort:false,emoji:'üöÉ'},
  'Áù°Áú†':  {color:'#1e3a5f',effort:false,emoji:'üåô'},
  '„Åù„ÅÆ‰ªñ':{color:'#475569',effort:false,emoji:'üìã'},
};

const EFFORT_CATS = ['‰ªï‰∫ã','Â≠¶Áøí','ÈÅãÂãï'];
const NO_XP_CATS = ['ÁßªÂãï','‰ºëÊÜ©','È£ü‰∫ã','Ë∂£Âë≥'];

const LEVELS = [
  {min:0,    name:'Ë¶ãÁøí„ÅÑ',       title:'Ë¶ãÁøí„ÅÑ',      avatar:'üßë', color:'#64748b'},
  {min:100,  name:'ÂÆüË∑µËÄÖ',       title:'ÂÆüË∑µËÄÖ',      avatar:'üßë‚Äçüíª', color:'#38bdf8'},
  {min:300,  name:'ÊåëÊà¶ËÄÖ',       title:'ÊåëÊà¶ËÄÖ',      avatar:'‚ö°',  color:'#818cf8'},
  {min:700,  name:'ÁÜüÁ∑¥ËÄÖ',       title:'ÁÜüÁ∑¥ËÄÖ',      avatar:'üî•',  color:'#4ade80'},
  {min:1500, name:'„Éû„Çπ„Çø„Éº',     title:'„Éû„Çπ„Çø„Éº',    avatar:'üíé',  color:'#fbbf24'},
  {min:3000, name:'„Ç®„Ç≠„Çπ„Éë„Éº„Éà', title:'„Ç®„Ç≠„Çπ„Éë„Éº„Éà',avatar:'üëë',  color:'#c084fc'},
  {min:6000, name:'‰ºùË™¨',         title:'‰ºùË™¨',        avatar:'üåü',  color:'#fb7185'},
];

// ================================================================
// SKILL TREE DEFINITION
// 6 domains √ó skills, each with: hours needed to unlock each level
// Levels driven by ACTUAL recorded time, not XP spending
// XP spending = accelerate growth (1 XP = 2 extra minutes of "practice")
// ================================================================
const DOMAINS = [
  {id:'work',name:'‰ªï‰∫ã',icon:'üíº',color:'#38bdf8',cat:'‰ªï‰∫ã',desc:'Â∞ÇÈñÄÊÄß„ÉªÁîüÁî£ÊÄß„ÉªÈõÜ‰∏≠Âäõ',skills:[
    {id:'focus',name:'ÈõÜ‰∏≠Âäõ',icon:'üéØ',desc:'Ê∑±„ÅÑÈõÜ‰∏≠Áä∂ÊÖã„Å´ÂÖ•„ÇãËÉΩÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,5,30,100,250],effects:['Ëß£ÊîæÊ∏à„Åø','ÈõÜ‰∏≠5hÈÅîÊàê','ÈõÜ‰∏≠30hÁ™ÅÁ†¥','Ê∑±ÈõÜ‰∏≠„ÇíÁøíÂæó','„Éï„É≠„ÉºÁä∂ÊÖã„Çí‰ΩìÂæó'],awaken:4},
    {id:'output',name:'ÁîüÁî£ÊÄß',icon:'üì§',desc:'ÊàêÊûúÁâ©„ÇíÁîü„ÅøÂá∫„ÅôÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,15,60,180,400],effects:['Ëß£ÊîæÊ∏à„Åø','‰ªï‰∫ã15hË®òÈå≤','‰ªï‰∫ã60hÁ™ÅÁ†¥','‰ªï‰∫ã180hÁ™ÅÁ†¥','ÁîüÁî£Ê©üÊ¢∞„ÅÆÂ¢ÉÂú∞'],awaken:4},
    {id:'strategy',name:'Êà¶Áï•ÊÄùËÄÉ',icon:'‚ôüÔ∏è',desc:'Èï∑ÊúüË¶ñÁÇπ„ÅßËÄÉ„Åà„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,30,120,300,650],effects:['Ëß£ÊîæÊ∏à„Åø','‰ªï‰∫ã30hË®òÈå≤','‰ªï‰∫ã120hÁ™ÅÁ†¥','‰ªï‰∫ã300hÁ™ÅÁ†¥','Êà¶Áï•ÂÆ∂„ÅÆË¶öÈÜí'],awaken:4},
    {id:'decision',name:'ÊÑèÊÄùÊ±∫ÂÆö',icon:'‚ö°',desc:'Á¥†Êó©„ÅèÊ≠£Á¢∫„Å´Âà§Êñ≠„Åô„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,20,80,220,500],effects:['Ëß£ÊîæÊ∏à„Åø','‰ªï‰∫ã20hË®òÈå≤','Âà§Êñ≠ÂäõÂêë‰∏ä','Áõ¥ÊÑüÁöÑÊ±∫Êñ≠Âäõ','Áû¨Êñ≠„ÅÆË¶öÈÜí'],awaken:4},
    {id:'leadership',name:'Áµ±ÁéáÂäõ',icon:'ü¶Ö',desc:'‰∫∫„ÇÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂ∞é„ÅèÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,40,150,400,850],effects:['Ëß£ÊîæÊ∏à„Åø','‰ªï‰∫ã40hË®òÈå≤','„É™„Éº„ÉÄ„Éº„ÅÆÁ¥†È§ä','ÊåáÊèÆËÉΩÂäõ','ÁéãËÄÖ„ÅÆÁµ±ÁéáË¶öÈÜí'],awaken:4},
  ]},
  {id:'learn',name:'Â≠¶Áøí',icon:'üìö',color:'#818cf8',cat:'Â≠¶Áøí',desc:'Áü•Ë≠òÂê∏Âèé„ÉªÁêÜËß£„ÉªÂøúÁî®',skills:[
    {id:'absorb',name:'Âê∏ÂèéÂäõ',icon:'üß†',desc:'Êñ∞„Åó„ÅÑÁü•Ë≠ò„ÇíÁ¥†Êó©„ÅèÂèñ„ÇäËæº„ÇÄÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,3,20,70,180],effects:['Ëß£ÊîæÊ∏à„Åø','Â≠¶Áøí3hË®òÈå≤','Â≠¶Áøí20hÁ™ÅÁ†¥','Â≠¶Áøí70hÁ™ÅÁ†¥','Ë∂ÖÂ≠¶ÁøíËÄÖ„ÅÆË¶öÈÜí'],awaken:4},
    {id:'connect',name:'ÈÄ£ÁµêÂäõ',icon:'üîó',desc:'Áü•Ë≠òÂêåÂ£´„ÇíÁµê„Å≥„Å§„Åë„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,10,50,150,350],effects:['Ëß£ÊîæÊ∏à„Åø','Â≠¶Áøí10hË®òÈå≤','Â≠¶Áøí50hÁ™ÅÁ†¥','Â≠¶Áøí150hÁ™ÅÁ†¥','Áü•Ë≠òÁµ±Âêà„ÅÆË¶öÈÜí'],awaken:4},
    {id:'depth',name:'Â∞ÇÈñÄÊ∑±Â∫¶',icon:'üåä',desc:'‰∏Ä„Å§„ÅÆ„Åì„Å®„ÇíÊ∑±„ÅèÊéò„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,20,80,250,550],effects:['Ëß£ÊîæÊ∏à„Åø','Â≠¶Áøí20hË®òÈå≤','Â≠¶Áøí80hÁ™ÅÁ†¥','Â≠¶Áøí250hÁ™ÅÁ†¥','Â∞ÇÈñÄÂÆ∂„ÅÆÂ¢ÉÂú∞'],awaken:4},
    {id:'memory',name:'Ë®òÊÜ∂ÂÆöÁùÄ',icon:'üíæ',desc:'Â≠¶„Çì„Å†„Åì„Å®„ÇíÂøò„Çå„Å™„ÅÑÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,8,40,130,300],effects:['Ëß£ÊîæÊ∏à„Åø','Â≠¶Áøí8hË®òÈå≤','Ë®òÊÜ∂Ë°ì„ÅÆÂü∫Á§é','Èï∑ÊúüË®òÊÜ∂Âäõ','ÂÆåÂÖ®Ë®òÊÜ∂„ÅÆË¶öÈÜí'],awaken:4},
    {id:'critical',name:'ÊâπÂà§ÁöÑÊÄùËÄÉ',icon:'üîç',desc:'ÊÉÖÂ†±„ÇíÊ≠£„Åó„ÅèË©ï‰æ°„Åô„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,15,65,200,450],effects:['Ëß£ÊîæÊ∏à„Åø','Â≠¶Áøí15hË®òÈå≤','ÂàÜÊûêÂäõÂêë‰∏ä','Ë´ñÁêÜ„ÅÆÈÅî‰∫∫','ÁúüÁêÜ„ÅÆË¶öÈÜí'],awaken:4},
  ]},
  {id:'body',name:'Ë∫´‰Ωì',icon:'üèÉ',color:'#4ade80',cat:'ÈÅãÂãï',desc:'‰ΩìÂäõ„ÉªÊåÅ‰πÖÂäõ„ÉªÂõûÂæ©Âäõ',skills:[
    {id:'stamina',name:'ÊåÅ‰πÖÂäõ',icon:'üí™',desc:'Èï∑„ÅèÂãï„ÅçÁ∂ö„Åë„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,2,15,50,130],effects:['Ëß£ÊîæÊ∏à„Åø','ÈÅãÂãï2hË®òÈå≤','ÈÅãÂãï15hÁ™ÅÁ†¥','ÈÅãÂãï50hÁ™ÅÁ†¥','„Ç¢„Çπ„É™„Éº„Éà„ÅÆË¶öÈÜí'],awaken:4},
    {id:'recovery',name:'ÂõûÂæ©Âäõ',icon:'‚öïÔ∏è',desc:'Áñ≤„Çå„Åã„ÇâÊó©„ÅèÁ´ã„Å°Áõ¥„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,5,30,90,220],effects:['Ëß£ÊîæÊ∏à„Åø','ÈÅãÂãï5hË®òÈå≤','ÈÅãÂãï30hÁ™ÅÁ†¥','ÈÅãÂãï90hÁ™ÅÁ†¥','‰∏çÊ≠ªÈ≥•„ÅÆÂõûÂæ©'],awaken:4},
    {id:'vitality',name:'ÁîüÂëΩÂäõ',icon:'üåø',desc:'Ê†πÊú¨ÁöÑ„Å™„Ç®„Éç„É´„ÇÆ„ÉºÈáè',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,10,50,150,350],effects:['Ëß£ÊîæÊ∏à„Åø','ÈÅãÂãï10hË®òÈå≤','ÈÅãÂãï50hÁ™ÅÁ†¥','ÈÅãÂãï150hÁ™ÅÁ†¥','ÁîüÂëΩÂäõË¶öÈÜí'],awaken:4},
    {id:'agility',name:'Ê©üÊïèÊÄß',icon:'‚ö°',desc:'Á¥†Êó©„ÅèÊ≠£Á¢∫„Å´Âãï„ÅèÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,4,25,80,200],effects:['Ëß£ÊîæÊ∏à„Åø','ÈÅãÂãï4hË®òÈå≤','ÂèçÂ∞ÑÁ•ûÁµåÂêë‰∏ä','Ë∂ÖÂèçÂøú','ÈñÉÂÖâ„ÅÆË¶öÈÜí'],awaken:4},
    {id:'mental_t',name:'Á≤æÁ•ûËÄêÊÄß',icon:'üõ°Ô∏è',desc:'ËÇâ‰ΩìÁöÑËã¶Áóõ„Çí‰πó„ÇäË∂ä„Åà„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,8,40,120,280],effects:['Ëß£ÊîæÊ∏à„Åø','ÈÅãÂãï8hË®òÈå≤','ÂøçËÄêÂäõÂêë‰∏ä','Èãº„ÅÆÁ≤æÁ•û','‰∏çÂ±à„ÅÆË¶öÈÜí'],awaken:4},
  ]},
  {id:'sleep',name:'Áù°Áú†',icon:'üåô',color:'#c084fc',cat:'Áù°Áú†',desc:'Áù°Áú†„ÅÆË≥™„ÉªÊ¶ÇÊó•„É™„Ç∫„É†',skills:[
    {id:'rhythm',name:'Ê¶ÇÊó•„É™„Ç∫„É†',icon:'üïê',desc:'‰ΩìÂÜÖÊôÇË®à„ÇíÊï¥„Åà„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,7,30,90,250],effects:['Ëß£ÊîæÊ∏à„Åø','„Çπ„Ç≥„Ç¢60+7Êó•','„Çπ„Ç≥„Ç¢70+30Êó•','90Êó•ÈÄ£Á∂öË®òÈå≤','Ê¶ÇÊó•„Éû„Çπ„Çø„ÉºË¶öÈÜí'],awaken:4,specialCalc:'sleep'},
    {id:'depth_s',name:'Ê∑±Áù°Áú†',icon:'üí§',desc:'Ê∑±„ÅèÁú†„ÇäËÑ≥„ÇíÂõûÂæ©„Åï„Åõ„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,3,15,50,150],effects:['Ëß£ÊîæÊ∏à„Åø','„Çπ„Ç≥„Ç¢70+3Êó•','„Çπ„Ç≥„Ç¢80+15Êó•','„Çπ„Ç≥„Ç¢90+50Êó•','ÂÆåÂÖ®Áù°Áú†„ÅÆË¶öÈÜí'],awaken:4,specialCalc:'sleep_deep'},
    {id:'restoration',name:'‰øÆÂæ©Âäõ',icon:'‚ú®',desc:'Áù°Áú†„ÅßÁøåÊó•„ÇíÊúÄÂ§ßÂåñ„Åô„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,10,50,150,330],effects:['Ëß£ÊîæÊ∏à„Åø','Áù°Áú†Ë®òÈå≤10Êó•','Áù°Áú†Ë®òÈå≤50Êó•','Áù°Áú†Ë®òÈå≤150Êó•','Áù°Áú†„Éû„Çπ„Çø„ÉºË¶öÈÜí'],awaken:4,specialCalc:'sleep_days'},
    {id:'dream',name:'Â§¢Ë¶ãÂäõ',icon:'üåå',desc:'Áù°Áú†‰∏≠„ÅÆËÑ≥„ÅÆÂâµÈÄ†ÊÄß',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,14,60,180,365],effects:['Ëß£ÊîæÊ∏à„Åø','14Êó•Ë®òÈå≤','60Êó•Ë®òÈå≤','180Êó•Ë®òÈå≤','Â§¢„ÅÆË¶öÈÜí'],awaken:4,specialCalc:'sleep_days'},
    {id:'nap_master',name:'‰ªÆÁú†Ë°ì',icon:'üò¥',desc:'Áü≠ÊôÇÈñì„ÅßÊúÄÂ§ßÂõûÂæ©„Åô„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,7,30,100,270],effects:['Ëß£ÊîæÊ∏à„Åø','7Êó•Ë®òÈå≤','30Êó•Ë®òÈå≤','100Êó•Ë®òÈå≤','Áû¨Áú†„ÅÆË¶öÈÜí'],awaken:4,specialCalc:'sleep_days'},
  ]},
  {id:'creative',name:'ÂâµÈÄ†',icon:'üé®',color:'#fb923c',cat:'Ë∂£Âë≥',desc:'ÂâµÈÄ†ÊÄß„ÉªË°®Áèæ„ÉªÂ§öÊßòÊÄß',skills:[
    {id:'curiosity',name:'Â•ΩÂ•áÂøÉ',icon:'üî≠',desc:'Êñ∞„Åó„ÅÑ„ÇÇ„ÅÆ„Å´È£õ„Å≥Ëæº„ÇÄÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,5,30,100,250],effects:['Ëß£ÊîæÊ∏à„Åø','Ë∂£Âë≥5hË®òÈå≤','Ë∂£Âë≥30hÁ™ÅÁ†¥','Ë∂£Âë≥100hÁ™ÅÁ†¥','Â•ΩÂ•áÂøÉ„ÅÆË¶öÈÜí'],awaken:4},
    {id:'flow',name:'„Éï„É≠„Éº',icon:'üåä',desc:'Ê≤°ÂÖ•Áä∂ÊÖã„ÇíÊÑèÂõ≥ÁöÑ„Å´‰Ωú„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,10,50,150,350],effects:['Ëß£ÊîæÊ∏à„Åø','Ë∂£Âë≥10hË®òÈå≤','Ë∂£Âë≥50hÁ™ÅÁ†¥','Ë∂£Âë≥150hÁ™ÅÁ†¥','ÂâµÈÄ†„Éï„É≠„ÉºË¶öÈÜí'],awaken:4},
    {id:'expression',name:'Ë°®ÁèæÂäõ',icon:'‚úçÔ∏è',desc:'ÂÜÖÂÅ¥„Å´„ÅÇ„Çã„ÇÇ„ÅÆ„ÇíÂ§ñ„Å´Âá∫„ÅôÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,20,80,250,550],effects:['Ëß£ÊîæÊ∏à„Åø','Ë∂£Âë≥20hË®òÈå≤','Ë∂£Âë≥80hÁ™ÅÁ†¥','Ë∂£Âë≥250hÁ™ÅÁ†¥','Ë°®ÁèæËÄÖ„ÅÆË¶öÈÜí'],awaken:4},
    {id:'aesthetic',name:'ÂØ©ÁæéÁúº',icon:'üëÅÔ∏è',desc:'Áæé„Åó„Åï„ÇíË¶ãÊ•µ„ÇÅ„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,15,60,180,400],effects:['Ëß£ÊîæÊ∏à„Åø','Ë∂£Âë≥15hË®òÈå≤','ÁæéÁöÑÊÑüË¶öÂêë‰∏ä','Áæé„ÅÆÈÅî‰∫∫','ÂØ©Áæé„ÅÆË¶öÈÜí'],awaken:4},
    {id:'improvise',name:'Âç≥ËààÂäõ',icon:'üé≠',desc:'„Åù„ÅÆÂ†¥„ÅßÁîü„ÅøÂá∫„ÅôÁû¨Áô∫Âäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,8,40,130,300],effects:['Ëß£ÊîæÊ∏à„Åø','Ë∂£Âë≥8hË®òÈå≤','„Å≤„Çâ„ÇÅ„ÅçÂêë‰∏ä','Â§©ÊâçÁöÑÂç≥Ëàà','ÈñÉ„Åç„ÅÆË¶öÈÜí'],awaken:4},
  ]},
  {id:'balance',name:'Áµ±Âêà',icon:'‚öñÔ∏è',color:'#fbbf24',cat:null,desc:'ÂÖ®ÂàÜÈáé„ÅÆË™øÂíå„ÉªËá™Â∑±Ë®≠Ë®à',skills:[
    {id:'consistency',name:'‰∏ÄË≤´ÊÄß',icon:'üîó',desc:'ÊØéÊó•Á∂ö„Åë„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,7,30,90,300],effects:['Ëß£ÊîæÊ∏à„Åø','7Êó•ÈÄ£Á∂ö','30Êó•ÈÄ£Á∂ö','90Êó•ÈÄ£Á∂ö','‰ºùË™¨„ÅÆ‰∏ÄË≤´ÊÄßË¶öÈÜí'],awaken:4,specialCalc:'streak'},
    {id:'self_design',name:'Ëá™Â∑±Ë®≠Ë®à',icon:'üß¨',desc:'Ëá™ÂàÜ„Çí„Ç∑„Çπ„ÉÜ„É†„Å®„Åó„Å¶ÊúÄÈÅ©Âåñ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,14,60,200,365],effects:['Ëß£ÊîæÊ∏à„Åø','Ë®òÈå≤14Êó•','Ë®òÈå≤60Êó•','Ë®òÈå≤200Êó•','Ëá™Â∑±Ë®≠Ë®à„ÅÆË¶öÈÜí'],awaken:4,specialCalc:'days'},
    {id:'meta',name:'„É°„ÇøË™çÁü•',icon:'ü™û',desc:'Ëá™ÂàÜ„ÇíÂÆ¢Ë¶≥ÁöÑ„Å´Ë¶≥ÂØü„Åô„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,3,10,40,120],effects:['Ëß£ÊîæÊ∏à„Åø','ÂÖ®ÂàÜÈáé„Å´Ë®òÈå≤','ÂÖ®Lv2‰ª•‰∏ä','ÂÖ®Lv3‰ª•‰∏ä','„É°„Çø„Éû„Çπ„Çø„ÉºË¶öÈÜí'],awaken:4,specialCalc:'alldomain'},
    {id:'adaptability',name:'ÈÅ©ÂøúÂäõ',icon:'üåÄ',desc:'Â§âÂåñ„Å´Á¥†Êó©„ÅèÂØæÂøú„Åô„ÇãÂäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,10,45,150,330],effects:['Ëß£ÊîæÊ∏à„Åø','10Êó•Â§öËßíÁöÑË®òÈå≤','45Êó•Ë®òÈå≤','ÊüîËªü„Å™ÂØæÂøúÂäõ','„Ç´„É°„É¨„Ç™„É≥Ë¶öÈÜí'],awaken:4,specialCalc:'days'},
    {id:'willpower',name:'ÊÑèÂøóÂäõ',icon:'üî•',desc:'Ëá™ÂàÜ„ÇíÂæã„Åô„ÇãÊ†πÊ∫êÁöÑ„Å™Âäõ',levels:['ÂàùÊ≠©','Âü∫Á§é','ÂøúÁî®','ÁÜüÈÅî','Ë¶öÈÜí'],thresholds:[0,7,30,100,350],effects:['Ëß£ÊîæÊ∏à„Åø','7Êó•Á∂ôÁ∂ö','30Êó•Á∂ôÁ∂ö','100Êó•Á∂ôÁ∂ö','ÈâÑ„ÅÆÊÑèÂøóË¶öÈÜí'],awaken:4,specialCalc:'streak'},
  ]},
];

var DEFAULT_QUICK_TEMPLATES = [
  {label:'Êúù‰ªï‰∫ã 9-12',start:'09:00',end:'12:00',cat:'‰ªï‰∫ã'},
  {label:'ÊòºÈ£ü 12-13',start:'12:00',end:'13:00',cat:'È£ü‰∫ã'},
  {label:'ÂçàÂæå 13-17',start:'13:00',end:'17:00',cat:'‰ªï‰∫ã'},
  {label:'Â§úÂ≠¶Áøí 20-22',start:'20:00',end:'22:00',cat:'Â≠¶Áøí'},
  {label:'ÊúùÈÅãÂãï 7-8',start:'07:00',end:'08:00',cat:'ÈÅãÂãï'},
];
function getQuickTemplates(){return ls_get('quick_tpl')||DEFAULT_QUICK_TEMPLATES;}
function setQuickTemplates(v){ls_set('quick_tpl',v);}
var QUICK_TEMPLATES = getQuickTemplates();

var BASE_XP_EFFORT = 20;
var BASE_XP_OTHER  = 5;
var xpRateMode = ls_get('xp_rate_mode') || 'normal';
function getXPMultiplier(){ return xpRateMode==='easy'?0.5:xpRateMode==='hard'?2.0:1.0; }
var XP_PER_EFFORT_HOUR = Math.round(BASE_XP_EFFORT * getXPMultiplier());
var XP_PER_OTHER_HOUR  = Math.round(BASE_XP_OTHER  * getXPMultiplier());
function setXPRate(mode){ xpRateMode=mode; ls_set('xp_rate_mode',mode); XP_PER_EFFORT_HOUR=Math.round(BASE_XP_EFFORT*getXPMultiplier()); XP_PER_OTHER_HOUR=Math.round(BASE_XP_OTHER*getXPMultiplier()); document.querySelectorAll('.xprate-btn').forEach(function(b){b.classList.toggle('active',b.dataset.mode===mode);}); toast('‚ö° XP„É¨„Éº„Éà: '+(mode==='easy'?'„ÇÜ„Çã„ÇÅ(√ó0.5)':mode==='hard'?'„Éè„Éº„Éâ(√ó2.0)':'„Åµ„Å§„ÅÜ(√ó1.0)')); }
const XP_SLEEP_BONUS     = 15;

// ================================================================
// STATE
// ================================================================
let currentDate = todayStr();

// Populate time selects with configurable intervals
var currentTimeStep=10;
function buildTimeOptions(step){
  var opts='';
  for(var h=0;h<24;h++){
    for(var m=0;m<60;m+=step){
      var v=String(h).padStart(2,'0')+':'+String(m).padStart(2,'0');
      var isHour=(m===0);
      var label=isHour?'‚îÅ '+v+' ‚îÅ':v;
      opts+='<option value="'+v+'"'+(isHour?' class="hr-mark" style="color:#38bdf8;font-weight:800;"':'')+'>'+label+'</option>';
    }
  }
  opts+='<option value="23:59">23:59</option>';
  return opts;
}
function setTimeStep(step){
  var prevS=document.getElementById('startTime').value;
  var prevE=document.getElementById('endTime').value;
  currentTimeStep=step;
  var opts=buildTimeOptions(step);
  ['startTime','endTime'].forEach(function(id){
    var el=document.getElementById(id);if(el)el.innerHTML=opts;
  });
  // Try to restore previous values, snap to nearest valid
  function snapTo(val,s){
    var m=t2m(val);
    var snapped=Math.round(m/s)*s;
    if(snapped>=1440)snapped=1440-s;
    return String(Math.floor(snapped/60)).padStart(2,'0')+':'+String(snapped%60).padStart(2,'0');
  }
  document.getElementById('startTime').value=snapTo(prevS,step);
  document.getElementById('endTime').value=snapTo(prevE,step);
  // Update button states
  [10,30,60].forEach(function(s){
    var btn=document.getElementById('tstep'+s);
    if(btn){btn.className='tstep-btn'+(s===step?' active':'');}
  });
}
(function(){
  // Time inputs are native type="time" with step=600
})();
let trendMode   = 'day';
let selectedDomainId = null;
let selectedSkillId  = null;
let stTab = 'domains';
let pieChart=null, lineChart=null, effortChart=null;

// ================================================================
// STORAGE
// ================================================================
function ls_get(k){try{const r=localStorage.getItem('tf3_'+k);return r?JSON.parse(r):null;}catch{return null;}}
function ls_set(k,v){try{localStorage.setItem('tf3_'+k,JSON.stringify(v));}catch{}}

function getDayData(d){return ls_get('d_'+d)||{blocks:[],sleepTime:null,wakeTime:null,sleepScore:null};}
function setDayData(d,v){ls_set('d_'+d,v);}
function getSpecials(){return ls_get('specials')||[];}
function setSpecials(v){ls_set('specials',v);}
function getTotalXP(){return ls_get('total_xp')||0;}
function setTotalXP(v){ls_set('total_xp',v);}
function getSpentXP(){return ls_get('spent_xp')||0;}
function setSpentXP(v){ls_set('spent_xp',v);}
function getAvailXP(){return Math.max(0,getTotalXP()-getSpentXP());}
function getSkillBoosts(){return ls_get('skill_boosts')||{};}
function setSkillBoosts(v){ls_set('skill_boosts',v);}
function getEventLog(){return ls_get('event_log')||[];}
function setEventLog(v){ls_set('event_log',v.slice(0,50));}
function getAwakenedSkills(){return ls_get('awakened')||[];}
function setAwakenedSkills(v){ls_set('awakened',v);}
function getGold(){return ls_get('gold')||0;}
function setGold(v){ls_set('gold',v);}
function getDebt(){return ls_get('debt');}
function setDebt(v){ls_set('debt',v);}
function isDebtPaid(){var d=getDebt();return d!==null&&d<=0;}
function hasDebtSystem(){return getDebt()!==null;}
function initDebt(){
  if(getDebt()===null){
    setDebt(5000);
    setGold(0);
    addEventLog('üéÆ „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´ÈñãÂßãÔºÅ ÂàùÊúü„É≠„Éº„É≥ 5,000G „ÇíËøîÊ∏à„Åó„Å¶Ë≥áÁî£ÈÅãÁî®„ÇíËß£Êîæ„Åó„Çà„ÅÜÔºÅ','money');
  }
}
function payDebt(amount){
  var debt=getDebt();
  if(!debt||debt<=0)return amount; // no debt, return full amount
  var payment=Math.min(amount,debt);
  var remainder=amount-payment;
  setDebt(debt-payment);
  if(debt-payment<=0){
    addEventLog('üéâ „É≠„Éº„É≥ÂÆåÊ∏àÔºÅË≥áÁî£ÈÅãÁî®„Å®Ë°ó„Å•„Åè„Çä„ÅåËß£Á¶Å„Åï„Çå„Åæ„Åó„ÅüÔºÅ','levelup');
    toast('üéâ „É≠„Éº„É≥„ÇíÂÆåÊ∏à„Åó„Åæ„Åó„ÅüÔºÅË≥áÁî£ÈÅãÁî®„ÉªË°ó„ÅåËß£Á¶ÅÔºÅ');
    showReward('üéâ','„É≠„Éº„É≥ÂÆåÊ∏àÔºÅ','Ë≥áÁî£ÈÅãÁî®„Å®Ë°ó„Å•„Åè„Çä„ÅåËß£Á¶Å„Åï„Çå„Åæ„Åó„ÅüÔºÅ\\n„Åì„Åì„Åã„Çâ„ÅåÊú¨ÂΩì„ÅÆ„Çπ„Çø„Éº„Éà„Åß„Åô„ÄÇ');
  } else {
    toast('üí∏ '+payment.toLocaleString()+'G „ÇíËøîÊ∏à (ÊÆã„Çä: '+(debt-payment).toLocaleString()+'G)');
  }
  return remainder;
}
function manualPayDebt(){
  var debt=getDebt();
  if(!debt||debt<=0){toast('„É≠„Éº„É≥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì','err');return;}
  var gold=getGold();
  if(gold<=0){toast('ÊâÄÊåÅÈáë„Åå„ÅÇ„Çä„Åæ„Åõ„Çì','err');return;}
  var payment=Math.min(gold,debt);
  setGold(gold-payment);
  setDebt(debt-payment);
  addEventLog('üí∏ ÊâÄÊåÅÈáë„Åã„Çâ '+payment.toLocaleString()+'G „ÇíËøîÊ∏à (ÊÆã„Çä: '+Math.max(0,debt-payment).toLocaleString()+'G)','money');
  if(debt-payment<=0){
    addEventLog('üéâ „É≠„Éº„É≥ÂÆåÊ∏àÔºÅË≥áÁî£ÈÅãÁî®„Å®Ë°ó„Å•„Åè„Çä„ÅåËß£Á¶Å„Åï„Çå„Åæ„Åó„ÅüÔºÅ','levelup');
    toast('üéâ „É≠„Éº„É≥„ÇíÂÆåÊ∏à„Åó„Åæ„Åó„ÅüÔºÅË≥áÁî£ÈÅãÁî®„ÉªË°ó„ÅåËß£Á¶ÅÔºÅ');
    showReward('üéâ','„É≠„Éº„É≥ÂÆåÊ∏àÔºÅ','Ë≥áÁî£ÈÅãÁî®„Å®Ë°ó„Å•„Åè„Çä„ÅåËß£Á¶Å„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
  } else {
    toast('üí∏ '+payment.toLocaleString()+'G „ÇíËøîÊ∏à (ÊÆã„Çä: '+(debt-payment).toLocaleString()+'G)');
  }
  updateNav();renderEconomy();
}
function getTotalEarned(){return ls_get('total_earned')||0;}
function setTotalEarned(v){ls_set('total_earned',v);}
function getOwnedBuildings(){return ls_get('owned_bld')||[];}
function setOwnedBuildings(v){ls_set('owned_bld',v);}
function getDayWorked(d){return ls_get('worked_'+d)||false;}
function setDayWorked(d){ls_set('worked_'+d,true);}

// ================================================================
// ECONOMY CONFIG
// ================================================================
const BASE_WAGE = 90;
const WAGE_PER_SKILL_LV = 0.037; // scaled so Lv120 ‚Üí ~8000

const BUILDINGS = [
  // === ÂàùÊúü„ÉªÂü∫Á§é„Ç§„É≥„Éï„É© („Äú5,000G) === subtotal: ~350
  {id:'b0',  e:'üè†', name:'Â∞èÂ±ã',           cost:300,      pop:10,  desc:'ÊúÄÂàù„ÅÆ‰Ωè„Åæ„ÅÑ'},
  {id:'b1',  e:'‚õ∫', name:'„ÉÜ„É≥„ÉàÂ∫ÉÂ†¥',      cost:600,      pop:20,  desc:'ÊÜ©„ÅÑ„ÅÆÂ†¥'},
  {id:'b35', e:'üöè', name:'„Éê„ÇπÂÅú',          cost:800,      pop:15,  desc:'ÂÖ¨ÂÖ±‰∫§ÈÄö„ÅÆÂßã„Åæ„Çä'},
  {id:'b2',  e:'üå≤', name:'ÂÖ¨Âúí',            cost:1200,     pop:25,  desc:'Á∑ë„ÅåË°ó„ÇíÊΩ§„Åô'},
  {id:'b36', e:'ü™µ', name:'Êú®ÊùêÁΩÆ„ÅçÂ†¥',      cost:1500,     pop:20,  desc:'Ë≥áÊùê„ÅÆÊã†ÁÇπ'},
  {id:'b37', e:'üßë‚Äçüåæ',name:'Ëæ≤Â†¥',          cost:2000,     pop:40,  desc:'È£ü„ÅÆËá™Áµ¶Ëá™Ë∂≥'},
  {id:'b3',  e:'üè™', name:'ÂïÜÂ∫ó',            cost:2500,     pop:50,  desc:'ÁµåÊ∏àÊ¥ªÂãï„ÅåÂßã„Åæ„Çã'},
  {id:'b38', e:'üçû', name:'„Éë„É≥Â±ã',          cost:3000,     pop:30,  desc:'ÁÑº„Åç„Åü„Å¶„ÅÆÈ¶ô„Çä'},
  {id:'b39', e:'üì¨', name:'ÈÉµ‰æøÂ±Ä',          cost:3500,     pop:40,  desc:'ÊâãÁ¥ô„ÅåÂ±ä„ÅèË°ó'},
  {id:'b40', e:'‚õ™', name:'Êïô‰ºö',            cost:4000,     pop:45,  desc:'Á•à„Çä„ÅÆÂ†¥ÊâÄ'},
  {id:'b4',  e:'üè´', name:'Â≠¶Ê†°',            cost:5000,     pop:80,  desc:'Áü•Ë≠ò„ÅåË°ó„ÇíË±ä„Åã„Å´'},

  // === ÂÖ¨ÂÖ±ÊñΩË®≠„Éª‰∏≠Ë¶èÊ®° (5,000„Äú20,000G) === subtotal: ~1,100
  {id:'b41', e:'üöí', name:'Ê∂àÈò≤ÁΩ≤',          cost:6000,     pop:70,  desc:'Â∏ÇÊ∞ë„ÅÆÂÆâÂÖ®„ÇíÂÆà„ÇãÁÇé„ÅÆÁï™‰∫∫'},
  {id:'b42', e:'üëÆ', name:'Ë≠¶ÂØüÁΩ≤',          cost:6500,     pop:70,  desc:'Ê≤ªÂÆâ„ÅåË°ó„ÅÆÂü∫Áõ§'},
  {id:'b5',  e:'‚õ≤', name:'Âô¥Ê∞¥Â∫ÉÂ†¥',        cost:7000,     pop:60,  desc:'Ë°ó„ÅÆ‰∏≠ÂøÉ„Å´Ëºù„Åè'},
  {id:'b43', e:'üìñ', name:'‰øùËÇ≤Âúí',          cost:7500,     pop:55,  desc:'Â≠ê„Å©„ÇÇ„Åü„Å°„ÅÆÁ¨ë„ÅÑÂ£∞'},
  {id:'b44', e:'üèãÔ∏è',name:'„Çπ„Éù„Éº„ÉÑ„Ç∏„É†',    cost:8000,     pop:65,  desc:'ÂÅ•Â∫∑„Å™Ë∫´‰Ωì„ÅØË≥áÊú¨'},
  {id:'b45', e:'üêï', name:'ÂãïÁâ©‰øùË≠∑ÊñΩË®≠',    cost:8500,     pop:50,  desc:'ÂëΩ„ÇíÂÆà„ÇãÂ†¥ÊâÄ'},
  {id:'b46', e:'‚ôªÔ∏è', name:'„É™„Çµ„Ç§„ÇØ„É´„Çª„É≥„Çø„Éº',cost:9000,   pop:45,  desc:'ÊåÅÁ∂öÂèØËÉΩ„Å™Êú™Êù•„Å∏'},
  {id:'b47', e:'üèä', name:'Â∏ÇÊ∞ë„Éó„Éº„É´',      cost:10000,    pop:80,  desc:'Ê∞¥„Åó„Å∂„Åç„ÅÆÊ≠ìÂ£∞'},
  {id:'b6',  e:'üè•', name:'ÁóÖÈô¢',            cost:12000,    pop:120, desc:'Â∏ÇÊ∞ë„ÅÆÂÅ•Â∫∑„ÇíÂÆà„Çã'},
  {id:'b48', e:'üî•', name:'Ê∏©Ê≥âÊñΩË®≠',        cost:13000,    pop:70,  desc:'Áñ≤„Çå„ÇíÁôí„ÅôÊ∫êÊ≥â'},
  {id:'b49', e:'üè§', name:'Â∏ÇÂΩπÊâÄ',          cost:15000,    pop:100, desc:'Ë°åÊîø„ÅÆ‰∏≠Êû¢'},
  {id:'b7',  e:'üé≠', name:'ÂäáÂ†¥',            cost:18000,    pop:100, desc:'ÊñáÂåñ„ÅåÊ†π‰ªò„Åè'},
  {id:'b50', e:'üì°', name:'ÈÄö‰ø°Â°î',          cost:20000,    pop:80,  desc:'ÈõªÊ≥¢„ÅåË°ó„ÇíÁπã„Åê'},

  // === ÂïÜÊ•≠„ÉªÊñáÂåñÊñΩË®≠ (20,000„Äú80,000G) === subtotal: ~2,700
  {id:'b51', e:'üé¨', name:'Êò†ÁîªÈ§®',          cost:22000,    pop:120, desc:'„Çπ„ÇØ„É™„Éº„É≥„Å´Â§¢„ÅåÊò†„Çã'},
  {id:'b52', e:'üç∫', name:'„Éñ„É´„ÉØ„É™„Éº',      cost:25000,    pop:100, desc:'Âú∞„Éì„Éº„É´„ÅÆË™á„Çä'},
  {id:'b53', e:'üé™', name:'ÈÅäÂúíÂú∞',          cost:28000,    pop:200, desc:'Á¨ëÈ°î„Åå„ÅÇ„Åµ„Çå„Çã'},
  {id:'b8',  e:'üè¶', name:'ÈäÄË°å',            cost:30000,    pop:180, desc:'Ë≥áÊú¨„ÅåË°ó„ÇíÂãï„Åã„Åô'},
  {id:'b54', e:'üêò', name:'ÂãïÁâ©Âúí',          cost:35000,    pop:200, desc:'ÂãïÁâ©„Åü„Å°„Å®„ÅÆÂá∫‰ºö„ÅÑ'},
  {id:'b55', e:'üé®', name:'ÁæéË°ìÈ§®',          cost:38000,    pop:150, desc:'„Ç¢„Éº„Éà„ÅåË°ó„Å´ÂΩ©„Çä„Çí'},
  {id:'b56', e:'üè¨', name:'„Éá„Éë„Éº„Éà',        cost:40000,    pop:250, desc:'‰Ωï„Åß„ÇÇÊèÉ„ÅÜÁôæË≤®Â∫ó'},
  {id:'b57', e:'üéµ', name:'„Ç≥„É≥„Çµ„Éº„Éà„Éõ„Éº„É´',cost:45000,    pop:180, desc:'Èü≥Ê•Ω„ÅåÈüø„ÅçÊ∏°„Çã'},
  {id:'b9',  e:'üèõÔ∏è',name:'Âõ≥Êõ∏È§®',          cost:50000,    pop:200, desc:'Áü•„ÅÆÊÆøÂ†Ç'},
  {id:'b58', e:'üî¨', name:'Á†îÁ©∂ÊâÄ',          cost:55000,    pop:180, desc:'ÁßëÂ≠¶„ÅåÊú™Êù•„ÇíÊãì„Åè'},
  {id:'b59', e:'üõçÔ∏è',name:'Â§ßÂûãÂïÜÊ•≠ÊñΩË®≠',    cost:60000,    pop:300, desc:'„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞„É¢„Éº„É´„ÅßË≥ë„Çè„ÅÜ'},
  {id:'b60', e:'üè®', name:'È´òÁ¥ö„Éõ„ÉÜ„É´',      cost:65000,    pop:200, desc:'„Åä„ÇÇ„Å¶„Å™„Åó„ÅÆÈ†ÇÁÇπ'},
  {id:'b61', e:'üéì', name:'Â§ßÂ≠¶',            cost:70000,    pop:350, desc:'ÊúÄÈ´òÂ≠¶Â∫ú„ÅåË°ó„ÅÆË™á„Çä'},
  {id:'b10', e:'üåâ', name:'Â§ßÊ©ã',            cost:80000,    pop:250, desc:'Ë°ó„ÅåÁπã„Åå„Çã'},

  // === Â§ßÂûã„Ç§„É≥„Éï„É© (80,000„Äú200,000G) === subtotal: ~5,500
  {id:'b62', e:'üèóÔ∏è',name:'Ë∂ÖÈ´òÂ±§„Éì„É´',      cost:85000,    pop:400, desc:'„Çπ„Ç´„Ç§„É©„Ç§„É≥„ÇíÂ§â„Åà„Çã'},
  {id:'b63', e:'‚ö°', name:'ÁÅ´ÂäõÁô∫ÈõªÊâÄ',      cost:90000,    pop:300, desc:'ÈõªÂäõ„ÅåË°ó„ÇíÁÖß„Çâ„Åô'},
  {id:'b64', e:'üåä', name:'Ê∞¥ÂäõÁô∫ÈõªÊâÄ',      cost:100000,   pop:350, desc:'Ê∞¥„ÅÆÂäõ„ÇíÈõªÂäõ„Å´'},
  {id:'b65', e:'üöá', name:'Âú∞‰∏ãÈâÑ',          cost:110000,   pop:500, desc:'Âú∞‰∏ã„ÇíËµ∞„ÇãÂ§ßÂãïËÑà'},
  {id:'b11', e:'üèüÔ∏è',name:'Á´∂ÊäÄÂ†¥',          cost:120000,   pop:500, desc:'„Çπ„Éù„Éº„ÉÑ„ÅåË°ó„ÇíÁÜ±„Åè'},
  {id:'b66', e:'‚ò¢Ô∏è', name:'ÂéüÂ≠êÂäõÁô∫ÈõªÊâÄ',    cost:130000,   pop:350, desc:'Ëé´Â§ß„Å™„Ç®„Éç„É´„ÇÆ„Éº'},
  {id:'b67', e:'üé∞', name:'„Ç´„Ç∏„Éé',          cost:140000,   pop:450, desc:'‰∏ÄÊî´ÂçÉÈáë„ÅÆÂ§¢'},
  {id:'b68', e:'‚öì', name:'Ê∏ØÊπæÊñΩË®≠',        cost:150000,   pop:500, desc:'Êµ∑„ÅÆÁéÑÈñ¢Âè£'},
  {id:'b69', e:'üèéÔ∏è',name:'F1„Çµ„Éº„Ç≠„ÉÉ„Éà',    cost:160000,   pop:400, desc:'„Ç®„É≥„Ç∏„É≥„ÅåÂî∏„Çã'},
  {id:'b70', e:'üé¢', name:'„ÉÜ„Éº„Éû„Éë„Éº„ÇØ',    cost:180000,   pop:600, desc:'Â§¢„Å®È≠îÊ≥ï„ÅÆÁéãÂõΩ'},
  {id:'b12', e:'‚õ©Ô∏è',name:'Á•ûÁ§æ',            cost:200000,   pop:500, desc:'Á≤æÁ•û„ÅÆÊã†„ÇäÊâÄ'},

  // === Ë∂ÖÂ§ßÂûã„Éª„É©„É≥„Éâ„Éû„Éº„ÇØ (200,000„Äú600,000G) === subtotal: ~10,500
  {id:'b71', e:'‚úàÔ∏è', name:'ÂõΩÈöõÁ©∫Ê∏Ø',        cost:220000,   pop:700, desc:'‰∏ñÁïå„Å®Áπã„Åå„ÇãÁøº'},
  {id:'b72', e:'üåø', name:'ÂõΩÁ´ãÂÖ¨Âúí',        cost:250000,   pop:500, desc:'Ëá™ÁÑ∂„Å®ÂÖ±„Å´Áîü„Åç„Çã'},
  {id:'b73', e:'üèôÔ∏è',name:'ÈáëËûçË°ó',          cost:280000,   pop:800, desc:'„Ç¶„Ç©„Éº„É´Ë°ó„ÅåÁîü„Åæ„Çå„Çã'},
  {id:'b74', e:'‚òÄÔ∏è', name:'Â§™ÈôΩÂÖâÁô∫ÈõªÊâÄ',    cost:300000,   pop:450, desc:'„ÇØ„É™„Éº„É≥„Ç®„Éç„É´„ÇÆ„Éº„ÅÆÊú™Êù•'},
  {id:'b13', e:'üóº', name:'„Çø„ÉØ„Éº',          cost:350000,   pop:800, desc:'Á©∫„Å´Â±ä„Åè„Ç∑„É≥„Éú„É´'},
  {id:'b75', e:'üß¨', name:'„Éê„Ç§„Ç™Á†îÁ©∂„Çª„É≥„Çø„Éº',cost:380000, pop:600, desc:'ÁîüÂëΩÁßëÂ≠¶„ÅÆÊúÄÂâçÁ∑ö'},
  {id:'b76', e:'üõ°Ô∏è',name:'Ëªç‰∫ãÂü∫Âú∞',        cost:400000,   pop:700, desc:'ÂõΩÈò≤„ÅÆË¶Å'},
  {id:'b77', e:'üåê', name:'„Éá„Éº„Çø„Çª„É≥„Çø„Éº',  cost:420000,   pop:600, desc:'„Éá„Ç∏„Çø„É´Á§æ‰ºö„ÅÆÂøÉËáì'},
  {id:'b78', e:'üöÑ', name:'Êñ∞ÂππÁ∑öÈßÖ',        cost:450000,   pop:900, desc:'Ë∂ÖÈ´òÈÄü„ÅßÈÉΩÂ∏Ç„ÇíÁµê„Å∂'},
  {id:'b79', e:'üèñÔ∏è',name:'„É™„Çæ„Éº„ÉàÈñãÁô∫',    cost:500000,   pop:700, desc:'Ê•ΩÂúí„Åå„Åì„Åì„Å´'},
  {id:'b80', e:'‚öΩ', name:'„ÉØ„Éº„É´„Éâ„Ç´„ÉÉ„Éó„Çπ„Çø„Ç∏„Ç¢„É†',cost:550000,pop:1000,desc:'‰∏ñÁïå„ÅåÊ≥®ÁõÆ„Åô„ÇãËàûÂè∞'},
  {id:'b14', e:'üè∞', name:'Âüé',              cost:600000,   pop:1200, desc:'‰ºùË™¨„ÅÆÂüé„ÄÇ„ÅÇ„Å™„Åü„ÅÆÁéãÂõΩ'},

  // === ÂõΩÂÆ∂„ÉªÂÆáÂÆôË¶èÊ®° (600,000G„Äú) === subtotal: ~12,500
  {id:'b81', e:'üé°', name:'‰∏áÂçö‰ºöÂ†¥',        cost:700000,   pop:1200, desc:'‰∏ñÁïå„ÅÆÊñáÂåñ„ÅåÈõÜ„ÅÜ'},
  {id:'b82', e:'üèîÔ∏è',name:'„Çπ„Ç≠„Éº„É™„Çæ„Éº„Éà',  cost:800000,   pop:1000, desc:'ÁôΩÈäÄ„ÅÆ‰∏ñÁïå'},
  {id:'b83', e:'üíé', name:'ÂÆùÁü≥ÂèñÂºïÊâÄ',      cost:900000,   pop:800,  desc:'Ëºù„ÅèÂØå„ÅÆÈõÜÁ©çÂú∞'},
  {id:'b84', e:'üî≠', name:'Â§©ÊñáÂè∞',          cost:1000000,  pop:1000, desc:'ÂÆáÂÆô„ÅÆÁ•ûÁßò„ÇíË¶ó„Åè'},
  {id:'b85', e:'üöÄ', name:'NASAÂÆáÂÆô„Çª„É≥„Çø„Éº',cost:1500000,  pop:1500, desc:'‰∫∫È°û„ÅØÂÆáÂÆô„Å∏'},
  {id:'b86', e:'üåï', name:'ÊúàÈù¢Âü∫Âú∞',        cost:2500000,  pop:2000, desc:'Êúà„Å´Ë°ó„ÇíÁØâ„Åè'},
  {id:'b87', e:'ü™ê', name:'ÂÆáÂÆô„Çπ„ÉÜ„Éº„Ç∑„Éß„É≥',cost:5000000,  pop:2500, desc:'ËªåÈÅì‰∏ä„ÅÆÊñ∞ÈÉΩÂ∏Ç'},
  {id:'b88', e:'üåå', name:'„ÉÄ„Ç§„ÇΩ„É≥ÁêÉ',      cost:10000000, pop:3500, desc:'ÊÅíÊòü„ÅÆ„Ç®„Éç„É´„ÇÆ„Éº„ÇíÊîØÈÖç„Åô„ÇãÁ©∂Ê•µ„ÅÆÊßãÈÄ†Áâ©'},
];

const WAGE_TIERS = [
  {label:'ÁÑ°ËÅ∑',           totalLv:0,   wage:90},
  {label:'Êó•Èõá„ÅÑÂä¥ÂÉçËÄÖ',    totalLv:2,   wage:150},
  {label:'Ë¶ãÁøí„ÅÑ',          totalLv:4,   wage:220},
  {label:'„Ç¢„É´„Éê„Ç§„Éà',      totalLv:6,   wage:300},
  {label:'Â•ëÁ¥ÑÁ§æÂì°',        totalLv:9,   wage:400},
  {label:'‰∏ÄËà¨‰∫ãÂãô',        totalLv:12,  wage:500},
  {label:'‰ΩúÊ•≠Âì°',          totalLv:15,  wage:620},
  {label:'Âñ∂Ê•≠ËÅ∑',          totalLv:18,  wage:750},
  {label:'ÊäÄËÉΩÂ∑•',          totalLv:22,  wage:900},
  {label:'‰∏ª‰ªª',            totalLv:26,  wage:1050},
  {label:'ÊäÄË°ìËÄÖ',          totalLv:30,  wage:1200},
  {label:'‰øÇÈï∑',            totalLv:34,  wage:1400},
  {label:'Â∞ÇÈñÄËÅ∑',          totalLv:38,  wage:1600},
  {label:'Ë™≤Èï∑‰ª£ÁêÜ',        totalLv:42,  wage:1800},
  {label:'Ë™≤Èï∑',            totalLv:47,  wage:2000},
  {label:'‰∏äÁ¥öÊäÄË°ìËÄÖ',      totalLv:52,  wage:2250},
  {label:'„Ç∑„Éã„Ç¢„Ç®„É≥„Ç∏„Éã„Ç¢',totalLv:57,  wage:2500},
  {label:'Ê¨°Èï∑',            totalLv:62,  wage:2800},
  {label:'ÈÉ®Èï∑',            totalLv:67,  wage:3100},
  {label:'„Ç®„Ç≠„Çπ„Éë„Éº„Éà',    totalLv:72,  wage:3500},
  {label:'Áµ±Êã¨ÈÉ®Èï∑',        totalLv:77,  wage:3900},
  {label:'Âü∑Ë°åÂΩπÂì°',        totalLv:82,  wage:4300},
  {label:'‰∏äÁ¥öÂü∑Ë°åÂΩπÂì°',    totalLv:87,  wage:4800},
  {label:'Â∏∏ÂãôÂèñÁ∑†ÂΩπ',      totalLv:92,  wage:5300},
  {label:'Â∞ÇÂãôÂèñÁ∑†ÂΩπ',      totalLv:97,  wage:5800},
  {label:'ÂâØÁ§æÈï∑',          totalLv:102, wage:6300},
  {label:'Á§æÈï∑',            totalLv:107, wage:6800},
  {label:'CEO',             totalLv:112, wage:7400},
  {label:'Ë≤°Èñ•Á∑èÂ∏•',        totalLv:117, wage:7800},
  {label:'‰ºùË™¨„ÅÆÁµåÂñ∂ËÄÖ',    totalLv:120, wage:8000},
];

function getAllDates(){
  const keys=[];
  try{for(let i=0;i<localStorage.length;i++){const k=localStorage.key(i);if(k&&k.startsWith('tf3_d_'))keys.push(k.replace('tf3_d_',''));}}catch{}
  return keys.sort();
}

// ================================================================
// DATE UTILS
// ================================================================
function todayStr(){const n=new Date();return n.getFullYear()+'-'+String(n.getMonth()+1).padStart(2,'0')+'-'+String(n.getDate()).padStart(2,'0');}
function parseDate(s){const[y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d);}
function addDays(s,n){const d=parseDate(s);d.setDate(d.getDate()+n);return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function formatDate(s){const d=parseDate(s);const D=['Êó•','Êúà','ÁÅ´','Ê∞¥','Êú®','Èáë','Âúü'];return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')} (${D[d.getDay()]})`;}
function formatShort(s){const d=parseDate(s);return `${d.getMonth()+1}/${d.getDate()}`;}

function changeDate(delta){currentDate=addDays(currentDate,delta);renderP1();}
function goToday(){currentDate=todayStr();renderP1();}

// ================================================================
// TIME UTILS
// ================================================================
function t2m(t){const[h,m]=t.split(':').map(Number);return h*60+m;}
function m2hm(m){const h=Math.floor(Math.abs(m)/60),mn=Math.abs(m)%60;return `${h}:${String(mn).padStart(2,'0')}`;}

// ================================================================
// PAGE NAV
// ================================================================
let curPage=0;
let curP3Tab='skills';
function gotoPage(n){
  // Close ALL modals and overlays when switching pages
  document.querySelectorAll('.modal.show,.overlay.show,.modal-overlay.show').forEach(function(m){m.classList.remove('show');});
  document.querySelectorAll('.page').forEach((p,i)=>p.classList.toggle('active',i===n));
  document.querySelectorAll('.ntab').forEach((t,i)=>t.classList.toggle('active',i===n));
  curPage=n;
  if(n===1)renderP2();
  if(n===2)renderP3();
  updateNav();
}

// ================================================================
// BLOCK MANAGEMENT
// ================================================================
function addBlock(forceOverwrite){
  const s=document.getElementById('startTime').value;
  const e=document.getElementById('endTime').value;
  const c=document.getElementById('category').value;
  if(!s||!e){toast('ÊôÇÂàª„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}

  var sm=t2m(s), em=t2m(e);
  var crossesMidnight=(em<=sm);

  if(!crossesMidnight){
    // Same-day block: overlap check on current date
    var day=getDayData(currentDate);
    var overlapping=[];
    for(var i=0;i<day.blocks.length;i++){
      var b=day.blocks[i];
      var bS=t2m(b.start), bE=t2m(b.end);
      if(sm<bE && em>bS){overlapping.push(b);}
    }
    if(overlapping.length>0 && !forceOverwrite){
      var names=overlapping.map(function(b){return (CATS[b.category]?CATS[b.category].emoji:'')+ b.category+' '+b.start+'„Äú'+b.end;}).join('„ÄÅ');
      showOverwriteConfirm(names);
      return;
    }
    // Remove overlapping blocks
    if(overlapping.length>0){
      var removeIds=overlapping.map(function(b){return b.id;});
      day.blocks=day.blocks.filter(function(b){return removeIds.indexOf(b.id)===-1;});
    }
    var block={start:s,end:e,category:c,id:Date.now()};
    day.blocks.push(block);
    mergeBlocks(day);
    setDayData(currentDate,day);
    recalcSleepFromBlocks(currentDate);

    // XP
    var dur=em-sm;
    var isEffort=CATS[c]&&CATS[c].effort;
    var isNoXP=NO_XP_CATS.includes(c);
    var specials=getSpecials().filter(function(sp){return sp.cat===c;});
    var xpGain=isNoXP?0:(isEffort?Math.round(dur/60*XP_PER_EFFORT_HOUR):Math.round(dur/60*XP_PER_OTHER_HOUR));
    var bonusMsg='';
    if(specials.length>0){var sp=specials[0];var multi=sp.multi||2;if(dur>=sp.mins){xpGain=Math.round(xpGain*multi);bonusMsg=' (‚≠ê√ó'+multi+'„Éú„Éº„Éä„Çπ!)';}}
    addXP(xpGain,block);
    var overMsg=overlapping.length>0?'Ôºà‰∏äÊõ∏„ÅçÔºâ':'';
    toast((CATS[c]?CATS[c].emoji:'')+c+' +'+xpGain+'XP'+bonusMsg+overMsg);
    onBlockAdded(c);
  } else {
    // Crosses midnight: split into today + tomorrow
    var day1=getDayData(currentDate);
    var nextDate=addDays(currentDate,1);
    var day2=getDayData(nextDate);

    var overlap1=[],overlap2=[];
    if(sm<1440){
      for(var i=0;i<day1.blocks.length;i++){
        var b=day1.blocks[i];
        if(sm<t2m(b.end)&&1440>t2m(b.start)){overlap1.push(b);}
      }
    }
    if(em>0){
      for(var i=0;i<day2.blocks.length;i++){
        var b=day2.blocks[i];
        if(0<t2m(b.end)&&em>t2m(b.start)){overlap2.push(b);}
      }
    }
    if((overlap1.length>0||overlap2.length>0) && !forceOverwrite){
      var all=overlap1.concat(overlap2);
      var names=all.map(function(b){return (CATS[b.category]?CATS[b.category].emoji:'')+b.category+' '+b.start+'„Äú'+b.end;}).join('„ÄÅ');
      showOverwriteConfirm(names);
      return;
    }
    // Remove overlapping
    if(overlap1.length>0){var ids1=overlap1.map(function(b){return b.id;});day1.blocks=day1.blocks.filter(function(b){return ids1.indexOf(b.id)===-1;});}
    if(overlap2.length>0){var ids2=overlap2.map(function(b){return b.id;});day2.blocks=day2.blocks.filter(function(b){return ids2.indexOf(b.id)===-1;});}

    var block1={start:s,end:'23:59',category:c,id:Date.now()};
    var block2={start:'00:00',end:e,category:c,id:Date.now()+1};
    if(sm<1440)day1.blocks.push(block1);
    if(em>0)day2.blocks.push(block2);
    mergeBlocks(day1);mergeBlocks(day2);
    setDayData(currentDate,day1);
    setDayData(nextDate,day2);
    recalcSleepFromBlocks(currentDate);
    recalcSleepFromBlocks(nextDate);

    // XP for total duration
    var totalDur=(1440-sm)+em;
    var isEffort=CATS[c]&&CATS[c].effort;
    var isNoXP=NO_XP_CATS.includes(c);
    var xpGain=isNoXP?0:(isEffort?Math.round(totalDur/60*XP_PER_EFFORT_HOUR):Math.round(totalDur/60*XP_PER_OTHER_HOUR));
    addXP(xpGain,block1);
    toast((CATS[c]?CATS[c].emoji:'')+c+' +'+xpGain+'XPÔºàÊó•„Çí„Åæ„Åü„ÅéÂàÜÂâ≤Ôºâ');
    onBlockAdded(c);
  }

  // Advance times
  document.getElementById('startTime').value=e;
  var nem=t2m(e)+60;
  var snapM=Math.round(Math.min(nem,1430)/currentTimeStep)*currentTimeStep;
  if(snapM>=1440)snapM=1440-currentTimeStep;
  document.getElementById('endTime').value=String(Math.floor(snapM/60)).padStart(2,'0')+':'+String(snapM%60).padStart(2,'0');

  renderP1();
}

function showOverwriteConfirm(names){
  var el=document.getElementById('overwriteConfirm');
  if(!el){
    el=document.createElement('div');
    el.id='overwriteConfirm';
    el.style.cssText='position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.75);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding:20px;';
    document.body.appendChild(el);
  }
  el.style.display='flex';
  el.innerHTML=
    '<div style="background:var(--s1);border:2px solid rgba(251,191,36,.4);border-radius:16px;padding:24px;max-width:380px;width:100%;animation:rewardIn .3s ease;">'+
      '<div style="font-size:1.2rem;text-align:center;margin-bottom:8px;">‚ö†Ô∏è</div>'+
      '<div style="font-size:.85rem;font-weight:700;color:#fbbf24;text-align:center;margin-bottom:10px;">ÊôÇÈñì„ÅåÈáçË§á„Åó„Å¶„ÅÑ„Åæ„Åô</div>'+
      '<div style="font-size:.7rem;color:var(--muted2);text-align:center;margin-bottom:14px;line-height:1.6;">‰ª•‰∏ã„ÅÆË®òÈå≤„Çí‰∏äÊõ∏„Åç„Åó„Å¶„ÇÇ„Çà„ÅÑ„Åß„Åô„ÅãÔºü<br><span style="color:var(--text);font-weight:700;">'+names+'</span></div>'+
      '<div style="display:flex;gap:8px;">'+
        '<button onclick="document.getElementById(\'overwriteConfirm\').style.display=\'none\'" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--s2);color:var(--muted2);font-size:.8rem;font-weight:700;cursor:pointer;">„Ç≠„É£„É≥„Çª„É´</button>'+
        '<button onclick="document.getElementById(\'overwriteConfirm\').style.display=\'none\';addBlock(true)" style="flex:1;padding:10px;border:none;border-radius:10px;background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000;font-size:.8rem;font-weight:800;cursor:pointer;">‰∏äÊõ∏„Åç„Åô„Çã</button>'+
      '</div>'+
    '</div>';
}

// Auto-merge consecutive blocks of the same category
function mergeBlocks(day){
  if(day.blocks.length<2)return;
  day.blocks.sort(function(a,b){return a.start.localeCompare(b.start);});
  var merged=[];
  var cur=Object.assign({},day.blocks[0]);
  for(var i=1;i<day.blocks.length;i++){
    var b=day.blocks[i];
    // Merge if same category and adjacent/overlapping
    if(b.category===cur.category && t2m(b.start)<=t2m(cur.end)+1){
      cur.end=t2m(b.end)>t2m(cur.end)?b.end:cur.end;
    } else {
      merged.push(cur);
      cur=Object.assign({},b);
    }
  }
  merged.push(cur);
  day.blocks=merged;
}

// Recalculate sleep score from sleep blocks
function recalcSleepFromBlocks(dateStr){
  var day=getDayData(dateStr);
  var sleepBlocks=day.blocks.filter(function(b){return b.category==='Áù°Áú†';});
  if(sleepBlocks.length===0){
    day.sleepScore=null;day.sleepTime=null;day.wakeTime=null;
    setDayData(dateStr,day);return;
  }
  // Find total sleep time and boundaries
  var totalSleepMins=0;
  var earliest=9999, latest=0;
  sleepBlocks.forEach(function(b){
    var sm=t2m(b.start),em=t2m(b.end);
    totalSleepMins+=(em-sm);
    if(sm<earliest)earliest=sm;
    if(em>latest)latest=em;
  });
  // Determine sleep/wake times for scoring
  // If there's a block ending in morning (0:00-12:00), that's wakeTime
  // If there's a block starting in evening (18:00-24:00), that's sleepTime
  var sleepStart=null, wakeEnd=null;
  sleepBlocks.forEach(function(b){
    var sm=t2m(b.start),em=t2m(b.end);
    if(sm>=1080){sleepStart=b.start;} // after 18:00
    if(em<=720 && em>0){wakeEnd=b.end;} // before 12:00
  });
  // Fallback
  if(!sleepStart)sleepStart=sleepBlocks[0].start;
  if(!wakeEnd)wakeEnd=sleepBlocks[sleepBlocks.length-1].end;

  var score=calcSleepScore(sleepStart,wakeEnd);
  var hadScore=day.sleepScore;
  day.sleepTime=sleepStart;day.wakeTime=wakeEnd;day.sleepScore=score;
  setDayData(dateStr,day);
  if(dateStr===currentDate){
    updateSleepUI(score);
    if(score>=80&&hadScore===null){addXP(XP_SLEEP_BONUS);}
  }
}

function deleteBlock(id){
  const day=getDayData(currentDate);
  day.blocks=day.blocks.filter(b=>b.id!==id);
  setDayData(currentDate,day);
  recalcSleepFromBlocks(currentDate);
  renderP1();
}

function quickAdd(tpl){
  document.getElementById('startTime').value=tpl.start;
  document.getElementById('endTime').value=tpl.end;
  document.getElementById('category').value=tpl.cat;
}

// ================================================================
// SPECIAL ITEMS
// ================================================================
function openSpecialModal(){document.getElementById('specialModal').classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}

function addSpecialItem(){
  const name=document.getElementById('si_name').value.trim();
  const cat=document.getElementById('si_cat').value;
  const mins=parseInt(document.getElementById('si_mins').value)||30;
  const multi=parseInt(document.getElementById('si_multi').value)||2;
  if(!name){toast('È†ÖÁõÆÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  const specials=getSpecials();
  specials.push({id:Date.now(),name,cat,mins,multi});
  setSpecials(specials);
  closeModal('specialModal');
  toast(`‚≠ê "${name}" „ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`);
  renderSpecialList();
}

function deleteSpecial(id){
  const s=getSpecials().filter(x=>x.id!==id);
  setSpecials(s);
  renderSpecialList();
}

function renderSpecialList(){
  const el=document.getElementById('specialList');
  const specials=getSpecials();
  if(!specials.length){
    el.innerHTML='<div style="font-size:0.75rem;color:var(--muted);text-align:center;padding:10px;">ÁâπÂà•È†ÖÁõÆ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br><span style="font-size:0.65rem;">Ëá™ÂàÜ„ÅåÈáçË¶ÅË¶ñ„Åô„ÇãË°åÂãï„ÇíÁôªÈå≤„Åó„Å¶XP„Éú„Éº„Éä„Çπ„ÇíÂæó„Çà„ÅÜ</span></div>';
    return;
  }
  el.innerHTML=specials.map(sp=>{
    const cat=CATS[sp.cat]||{color:'#64748b',emoji:'üìã'};
    return `<div class="special-item">
      <div class="special-dot" style="background:${cat.color}"></div>
      <div class="special-info">
        <div class="special-name">${cat.emoji} ${sp.name}</div>
        <div class="special-meta">${sp.cat} / ${sp.mins}ÂàÜ‰ª•‰∏ä ‚Üí XP √ó${sp.multi}</div>
      </div>
      <div class="special-xp">√ó${sp.multi}</div>
      <button class="special-del" onclick="deleteSpecial(${sp.id})">√ó</button>
    </div>`;
  }).join('');
}

// ================================================================
// XP
// ================================================================
function addXP(amount,blockEl){
  const prev=getTotalXP();
  const next=prev+amount;
  setTotalXP(next);
  checkLevelUp(prev,next);
  updateNav();
  // float
  if(blockEl){
    const x=window.innerWidth/2+Math.random()*100-50;
    const y=window.innerHeight/2;
    spawnFloatXP(x,y,'+'+amount+' XP');
  }
}

function spawnFloatXP(x,y,text){
  const el=document.createElement('div');
  el.className='xp-float';
  el.textContent=text;
  el.style.left=x+'px';
  el.style.top=y+'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1200);
}

function getLevel(xp){let lv=LEVELS[0];for(const l of LEVELS)if(xp>=l.min)lv=l;return lv;}

function checkLevelUp(prev,next){
  const pLv=getLevel(prev),nLv=getLevel(next);
  if(nLv.name!==pLv.name){
    showReward('üéä','„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ',`${nLv.name} „Å´„Å™„Çä„Åæ„Åó„ÅüÔºÅ\n„Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÅßËá™ÂàÜ„ÅÆÊàêÈï∑„ÇíÁ¢∫Ë™ç„Åó„Çà„ÅÜ ‚ú®`);
    addEventLog(`üéä „É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅ„Äå${nLv.name}„Äç„Å´„Å™„Å£„ÅüÔºÅ`,'levelup');
  }
}

function calcTotalSkillLevels(){
  let t=0;
  DOMAINS.forEach(d=>d.skills.forEach(s=>{t+=getSkillLevel(s);}));
  return t;
}

function calcWage(){
  const lvs=calcTotalSkillLevels();
  // Use tier-based wage with interpolation
  let curTier=WAGE_TIERS[0];
  let nextTier=null;
  for(let i=0;i<WAGE_TIERS.length;i++){
    if(lvs>=WAGE_TIERS[i].totalLv){curTier=WAGE_TIERS[i];nextTier=WAGE_TIERS[i+1]||null;}
  }
  if(!nextTier)return curTier.wage;
  // Interpolate between tiers
  var progress=(lvs-curTier.totalLv)/(nextTier.totalLv-curTier.totalLv);
  return Math.round(curTier.wage+(nextTier.wage-curTier.wage)*progress);
}

function updateNav(){
  const xp=getTotalXP();
  const streak=calcStreak();
  const lv=getLevel(xp);
  const lvIdx=LEVELS.indexOf(lv);
  document.getElementById('navXP').textContent=xp;
  document.getElementById('navStreak').textContent=streak;
  document.getElementById('navGold').textContent=getGold().toLocaleString();
  // Rebirth display
  var rCount=getRebirthCount();
  var rPill=document.getElementById('rebirthPill');
  if(rPill){
    if(rCount>0){
      var rt=getHighestRebirthTitle();
      rPill.style.display='';
      rPill.innerHTML=(rt?rt.icon:'')+' <span style="color:'+(rt?rt.color:'#c084fc')+';font-weight:700;">'+rCount+'Âë®ÁõÆ</span>';
      rPill.style.borderColor=(rt?rt.color:'rgba(192,132,252,.4)');
    } else {rPill.style.display='none';}
  }
  const avail=getAvailXP();
  const el_xp=document.getElementById('gardenXP');
  const el_bar=document.getElementById('gardenXPBar');
  if(el_xp) el_xp.textContent=avail+' XP';
  if(el_bar) el_bar.style.width=Math.min(100,avail/Math.max(100,xp)*100)+'%';
}

// ================================================================
// ECONOMY FUNCTIONS
// ================================================================
function getConvertableHours(){
  // Sum all unconverted effort hours across ALL dates
  var dates=getAllDates();
  var totalMins=0;
  dates.forEach(function(d){
    var dd=getDayData(d);
    var effort=getEffortMins(dd.blocks);
    var converted=dd.convertedMins||0;
    totalMins+=Math.max(0,effort-converted);
  });
  return totalMins/60;
}

function markConvertedHours(hoursToConvert){
  // Distribute conversion across dates (oldest first)
  var remaining=Math.round(hoursToConvert*60);
  var dates=getAllDates();
  for(var i=0;i<dates.length&&remaining>0;i++){
    var dd=getDayData(dates[i]);
    var effort=getEffortMins(dd.blocks);
    var converted=dd.convertedMins||0;
    var available=Math.max(0,effort-converted);
    if(available>0){
      var take=Math.min(available,remaining);
      dd.convertedMins=(converted+take);
      setDayData(dates[i],dd);
      remaining-=take;
    }
  }
}

function openWorkModal(){
  const wage=calcWage();
  const avail=getConvertableHours();
  const maxH=Math.floor(avail*10)/10;
  if(maxH<=0){toast('ÊèõÈáëÂèØËÉΩ„Å™Âä™ÂäõÊôÇÈñì„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ‰ªï‰∫ã„ÉªÂ≠¶Áøí„ÉªÈÅãÂãï„ÇíË®òÈå≤„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  document.getElementById('workModalWage').textContent='\u00a5'+wage.toLocaleString();
  document.getElementById('workHoursInput').value=maxH;
  document.getElementById('workHoursInput').max=maxH;
  updateWorkPreview();
  const availEl=document.getElementById('workAvailHours');
  if(availEl)availEl.textContent=maxH.toFixed(1)+'h';
  document.getElementById('workOverlay').classList.add('show');
}

function updateWorkPreview(){
  const h=parseFloat(document.getElementById('workHoursInput').value)||0;
  const wage=calcWage();
  document.getElementById('workPreviewGold').textContent=(Math.round(h*wage)).toLocaleString()+' G';
}

function doWork(){
  const h=parseFloat(document.getElementById('workHoursInput').value)||0;
  if(h<=0){toast('ÊèõÈáë„Åô„ÇãÊôÇÈñì„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  const avail=getConvertableHours();
  if(h>avail+0.01){toast('ÊèõÈáëÂèØËÉΩ„Å™Âä™ÂäõÊôÇÈñì„ÅØ '+avail.toFixed(1)+'h „Åß„Åô','err');return;}
  const today=todayStr();
  const wage=calcWage();
  const earn=Math.round(h*wage);
  // Debt auto-repayment
  var debt=getDebt();
  var actualGold=earn;
  if(debt&&debt>0){
    actualGold=payDebt(earn);
    var paid=earn-actualGold;
    if(paid>0)addEventLog('üí∏ '+paid.toLocaleString()+'G „Çí„É≠„Éº„É≥ËøîÊ∏à„Å´ÂÖÖÂΩì (ÊÆã„Çä: '+Math.max(0,debt-paid).toLocaleString()+'G)','money');
  }
  setGold(getGold()+actualGold);
  setTotalEarned(getTotalEarned()+earn);
  const dd=getDayData(today);
  dd.earnedGold=(dd.earnedGold||0)+earn;
  setDayData(today,dd);
  markConvertedHours(h);
  closeModal('workOverlay');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'+'+earn.toLocaleString()+' G');
  addEventLog(h+'hÊèõÈáë '+earn.toLocaleString()+' G (ÊôÇÁµ¶ '+wage+' G/h)','money');
  toast(earn.toLocaleString()+' G Áç≤ÂæóÔºÅ');
  updateNav();
  renderEconomy();
  if(curPage===2)renderP3();
  const total=getTotalEarned();
  [1000,5000,10000,50000,100000,500000].forEach(m=>{if(total-earn<m&&total>=m){showReward('üí∞','ÂèéÂÖ•„Éû„Ç§„É´„Çπ„Éà„Éº„É≥ÔºÅ','Á¥ØË®àÂèéÂÖ•„Åå '+total.toLocaleString()+' G„Å´ÈÅî„Åó„ÅüÔºÅ');}});
}

function buyBuilding(id){
  const b=BUILDINGS.find(x=>x.id===id);if(!b)return;
  const owned=getOwnedBuildings();
  if(owned.includes(id)){toast('„Åô„Åß„Å´Âª∫Ë®≠Ê∏à„Åø„Åß„Åô','err');return;}
  if(getGold()<b.cost){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: '+b.cost.toLocaleString()+' GÔºâ','err');return;}
  setGold(getGold()-b.cost);
  owned.push(id);setOwnedBuildings(owned);
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üèóÔ∏è Âª∫Ë®≠ÂÆå‰∫ÜÔºÅ');
  addEventLog('üèóÔ∏è „Äå'+b.name+'„Äç„ÇíÂª∫Ë®≠„Åó„ÅüÔºÅ (-'+b.cost.toLocaleString()+'G)','money');
  showReward(b.e,'Âª∫Ë®≠ÂÆå‰∫ÜÔºÅ','„Äå'+b.name+'„Äç„ÇíÂª∫„Å¶„Åæ„Åó„ÅüÔºÅ\n‰∫∫Âè£„Åå +'+b.pop+' Â¢ó„Åà„Åæ„Åó„Åü üèòÔ∏è');
  updateNav();
  if(curPage===2)renderP3();
}

function renderEconomy(){
  const wage=calcWage();
  const gold=getGold();
  const totalLvs=calcTotalSkillLevels();
  const maxLvs=120;

  // wage card
  document.getElementById('wageDisplay').textContent=wage.toLocaleString()+' G/h';
  document.getElementById('wageBarFill').style.width=Math.min(100,totalLvs/maxLvs*100)+'%';

  // find current tier
  let curTier=WAGE_TIERS[0];
  for(const t of WAGE_TIERS) if(totalLvs>=t.totalLv) curTier=t;
  const nextTier=WAGE_TIERS[WAGE_TIERS.indexOf(curTier)+1];
  document.getElementById('wageNext').textContent=nextTier
    ? '„ÅÇ„Å® '+(nextTier.totalLv-totalLvs)+' „Çπ„Ç≠„É´Lv„Åß '+nextTier.wage+' G/h'
    : '‚ú® ÊúÄÈ´òÊôÇÁµ¶ÈÅîÊàêÔºÅ';

  // wage ladder - show only nearby tiers (1 before, current, up to 4 after)
  var curIdx=WAGE_TIERS.indexOf(curTier);
  var startIdx=Math.max(0,curIdx-1);
  var endIdx=Math.min(WAGE_TIERS.length-1,curIdx+4);
  var visibleTiers=WAGE_TIERS.slice(startIdx,endIdx+1);
  var ladderHtml='';
  if(startIdx>0)ladderHtml+='<div style="font-size:.55rem;color:var(--muted);text-align:center;padding:2px;">‚ñ≤ '+startIdx+'ÊÆµÈöéÂâç</div>';
  ladderHtml+=visibleTiers.map(function(t){
    var isPast=totalLvs>t.totalLv&&curTier!==t;
    var isCur=curTier===t;
    var cls=isCur?'wl-row cur':isPast?'wl-row past':'wl-row';
    return '<div class="'+cls+'"><div class="wl-dot"></div><span class="wl-name">'+t.label+'</span><span class="wl-wage">'+t.wage.toLocaleString()+' G</span></div>';
  }).join('');
  if(endIdx<WAGE_TIERS.length-1)ladderHtml+='<div style="font-size:.55rem;color:var(--muted);text-align:center;padding:2px;">‚ñº „ÅÇ„Å®'+(WAGE_TIERS.length-1-endIdx)+'ÊÆµÈöé (ÊúÄÈ´ò '+WAGE_TIERS[WAGE_TIERS.length-1].wage.toLocaleString()+' G)</div>';
  document.getElementById('wageLadder').innerHTML=ladderHtml;

  // gold card
  document.getElementById('goldDisplay').textContent=gold.toLocaleString()+' G';
  const today=todayStr();
  const dayData=getDayData(today);
  document.getElementById('goldToday').textContent='Êú¨Êó•„ÅÆÁ®º„Åé: '+(dayData.earnedGold||0).toLocaleString()+' G';

  // debt display
  var debtEl=document.getElementById('debtDisplay');
  var debtPayBtn=document.getElementById('debtPayBtn');
  if(debtEl){
    var debt=getDebt();
    if(debt&&debt>0){
      debtEl.style.display='block';
      debtEl.textContent='üí∏ „É≠„Éº„É≥ÊÆãÈ´ò: '+debt.toLocaleString()+' G';
      if(debtPayBtn){
        debtPayBtn.style.display=gold>0?'inline-block':'none';
        debtPayBtn.textContent='üí∏ ÊâÄÊåÅÈáë„Åã„ÇâËøîÊ∏à„Åô„Çã ('+Math.min(gold,debt).toLocaleString()+'G)';
      }
    } else {
      debtEl.style.display='none';
      if(debtPayBtn)debtPayBtn.style.display='none';
    }
  }
  updateDebtUI();

  // self status wage
  const el_wage=document.getElementById('ss_wage');
  const el_gold=document.getElementById('ss_gold');
  if(el_wage) el_wage.textContent=wage.toLocaleString()+' G/h';
  if(el_gold) el_gold.textContent=getTotalEarned().toLocaleString();
  document.getElementById('shopGoldLabel').textContent=gold.toLocaleString()+' G';

  // town
  renderTownVis();
  renderBldShop();
}

function renderTownVis(){
  const owned=getOwnedBuildings();
  const el=document.getElementById('townGridVis');
  const pop=owned.reduce((s,id)=>{const b=BUILDINGS.find(x=>x.id===id);return s+(b?b.pop:0);},0);
  document.getElementById('townPopLabel').textContent='‰∫∫Âè£: '+pop+'‰∫∫';
  document.getElementById('townPop').textContent=owned.length?'Âª∫Ë®≠Êï∞: '+owned.length+'Ê£ü | Á∑è‰∫∫Âè£: '+pop+'‰∫∫':'';
  if(!owned.length){
    el.innerHTML='<div style="font-size:.72rem;color:var(--muted);padding:20px;text-align:center;width:100%;">„Åæ„Å†Âª∫Áâ©„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊôÇÈñì„ÇíÂÉç„ÅÑ„Å¶„Ç¥„Éº„É´„Éâ„ÇíÁ®º„Åî„ÅÜÔºÅ</div>';
    return;
  }
  el.innerHTML=owned.map(id=>{
    const b=BUILDINGS.find(x=>x.id===id);
    return b?'<span style="font-size:1.8rem;line-height:1;animation:popIn .3s ease;cursor:default;transition:transform .15s;display:inline-block;" title="'+b.name+' (‰∫∫Âè£+'+b.pop+')">'+b.e+'</span>':'';
  }).join('');
}

function renderBldShop(){
  const owned=getOwnedBuildings();
  const gold=getGold();
  document.getElementById('bldShop').innerHTML=BUILDINGS.map(b=>{
    const isOwned=owned.includes(b.id);
    const canBuy=!isOwned&&gold>=b.cost;
    const cls='bld-item'+(isOwned?' bld-owned':!canBuy?' bld-cant':'');
    const costCls=isOwned?'c-own':canBuy?'c-gold':'c-lock';
    const costTxt=isOwned?'Âª∫Ë®≠Ê∏à„Åø ‚úì':gold>=b.cost?b.cost.toLocaleString()+' G':'üîí '+b.cost.toLocaleString()+' G';
    return '<div class="'+cls+'" onclick="'+(canBuy?"buyBuilding(&quot;"+b.id+"&quot;)":"")+'">'+
      '<div class="bld-icon">'+b.e+'</div>'+
      '<div class="bld-info"><div class="bld-name">'+b.name+'</div><div class="bld-desc">'+b.desc+' (‰∫∫Âè£+'+b.pop+')</div></div>'+
      '<div class="bld-cost '+costCls+'">'+costTxt+'</div></div>';
  }).join('');
}

// ================================================================
// SLEEP
// ================================================================
function getSleepIdeals(){return ls_get('sleep_ideals')||{sleepH:23,sleepM:0,wakeH:6,wakeM:30,dur:450};}
function setSleepIdeals(v){ls_set('sleep_ideals',v);}
function getIdealSleep(){var i=getSleepIdeals();return i.sleepH*60+i.sleepM;}
function getIdealWake(){var i=getSleepIdeals();return i.wakeH*60+i.wakeM;}
function getIdealDur(){return getSleepIdeals().dur;}
var IDEAL_SLEEP=getIdealSleep(), IDEAL_WAKE=getIdealWake(), IDEAL_DUR=getIdealDur();
function refreshIdeals(){IDEAL_SLEEP=getIdealSleep();IDEAL_WAKE=getIdealWake();IDEAL_DUR=getIdealDur();updateIdealDisplay();}
function updateIdealDisplay(){
  var i=getSleepIdeals();
  var el=document.getElementById('idealDisplay');
  if(el)el.textContent=String(i.sleepH).padStart(2,'0')+':'+String(i.sleepM).padStart(2,'0')+'Â∞±ÂØù / '+String(i.wakeH).padStart(2,'0')+':'+String(i.wakeM).padStart(2,'0')+'Ëµ∑Â∫ä / '+(i.dur/60)+'h';
}
function openSleepIdealEditor(){document.getElementById('sleepIdealModal').classList.add('show');var i=getSleepIdeals();document.getElementById('idealSleepInput').value=String(i.sleepH).padStart(2,'0')+':'+String(i.sleepM).padStart(2,'0');document.getElementById('idealWakeInput').value=String(i.wakeH).padStart(2,'0')+':'+String(i.wakeM).padStart(2,'0');}
function saveSleepIdeals(){
  var s=document.getElementById('idealSleepInput').value;var w=document.getElementById('idealWakeInput').value;
  if(!s||!w){toast('ÊôÇÂàª„ÇíÂÖ•Âäõ','err');return;}
  var sp=s.split(':').map(Number),wp=w.split(':').map(Number);
  var sm=sp[0]*60+sp[1],wm=wp[0]*60+wp[1];if(wm<=sm)wm+=1440;
  setSleepIdeals({sleepH:sp[0],sleepM:sp[1],wakeH:wp[0],wakeM:wp[1],dur:wm-sm});
  refreshIdeals();closeModal('sleepIdealModal');toast('Áù°Áú†„ÅÆÁêÜÊÉ≥ÂÄ§„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
  onSleepInput(); // recalculate score
}

function calcSleepScore(sv,wv){
  if(!sv||!wv)return null;
  let sm=t2m(sv),wm=t2m(wv);
  if(wm<=sm)wm+=24*60;
  const dur=wm-sm;
  const durScore=Math.max(0,50-Math.abs(dur-IDEAL_DUR)*0.22);
  let sDiff=Math.abs(sm-IDEAL_SLEEP);if(sDiff>12*60)sDiff=24*60-sDiff;
  let wDiff=Math.abs((wm%(24*60))-IDEAL_WAKE);if(wDiff>12*60)wDiff=24*60-wDiff;
  const timingScore=Math.max(0,50-(sDiff+wDiff)*0.14);
  return Math.round(durScore+timingScore);
}

function onSleepInput(){
  // Legacy: sleep is now auto-calculated from blocks. This function is kept for compatibility.
  recalcSleepFromBlocks(currentDate);
  renderP1();
}

function updateSleepUI(score){
  const el=document.getElementById('sleepScore');
  const arc=document.getElementById('sleepArc');
  const band=document.getElementById('sleepBand');
  const msg=document.getElementById('sleepMsg');
  document.getElementById('m_sleep').textContent=score!==null?score+'ÁÇπ':'--';
  if(score===null){el.textContent='--';arc.setAttribute('stroke-dashoffset','232.48');band.style.width='0%';msg.textContent='ÊôÇÂàª„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';msg.style.color='var(--muted2)';return;}
  el.textContent=score;
  arc.setAttribute('stroke-dashoffset',232.48*(1-score/100));
  const c=score>=85?'#4ade80':score>=65?'#fbbf24':score>=45?'#fb923c':'#fb7185';
  arc.setAttribute('stroke',c);
  band.style.width=score+'%';band.style.background=c;
  if(score>=90){msg.textContent='üåü ÂÆåÁíß„Å™Áù°Áú†ÔºÅ';msg.style.color='#4ade80';}
  else if(score>=75){msg.textContent='üòä ËâØ„ÅÑÁù°Áú†';msg.style.color='#4ade80';}
  else if(score>=60){msg.textContent='üòê „ÇÇ„ÅÜÂ∞ë„Åó';msg.style.color='#fbbf24';}
  else if(score>=40){msg.textContent='üò¥ ÊîπÂñÑ„Åó„Çà„ÅÜ';msg.style.color='#fb923c';}
  else{msg.textContent='üòµ Áù°Áú†„ÇíË¶ãÁõ¥„Åù„ÅÜ';msg.style.color='#fb7185';}
}

// ================================================================
// STREAK
// ================================================================
function calcStreak(){
  // Unrecorded days are "pauses" ‚Äî they don't break the streak
  var today=todayStr();
  var s=0, maxGap=3, gap=0, check=today;
  for(var i=0;i<400;i++){
    var d=getDayData(check);
    var hasRecord=d.blocks.length>0||d.sleepScore!==null;
    if(hasRecord){s++;gap=0;}
    else{gap++;if(gap>maxGap)break;} // allow up to 3 unrecorded days as pause
    check=addDays(check,-1);
  }
  return s;
}
function isDayUnrecorded(dateStr){
  var d=getDayData(dateStr);
  return d.blocks.length===0&&d.sleepScore===null&&d.sleepTime===null;
}

// ================================================================
// EFFORT
// ================================================================
function getEffortMins(blocks){return blocks.filter(b=>CATS[b.category]?.effort).reduce((s,b)=>s+t2m(b.end)-t2m(b.start),0);}
function getCatMins(blocks,cat){return blocks.filter(b=>b.category===cat).reduce((s,b)=>s+t2m(b.end)-t2m(b.start),0);}

// ================================================================
// PAGE 1 RENDER
// ================================================================
function renderP1(){
  // Date pill
  const pill=document.getElementById('datePill');
  pill.textContent=formatDate(currentDate);
  pill.className='date-pill'+(currentDate===todayStr()?' today':'');

  const day=getDayData(currentDate);
  // Auto-calc sleep from blocks
  recalcSleepFromBlocks(currentDate);
  var dayRefresh=getDayData(currentDate);
  updateSleepUI(dayRefresh.sleepScore||null);
  // Show sleep block info
  var sInfo=document.getElementById('sleepBlockInfo');
  if(sInfo){
    var sleepBlks=dayRefresh.blocks.filter(function(b){return b.category==='Áù°Áú†';});
    if(sleepBlks.length>0){
      var totalM=sleepBlks.reduce(function(s,b){return s+t2m(b.end)-t2m(b.start);},0);
      sInfo.innerHTML='üåô '+sleepBlks.map(function(b){return b.start+'„Äú'+b.end;}).join(' + ')+' <span style="color:var(--cyan);font-weight:700;">'+m2hm(totalM)+'</span>';
    } else {
      sInfo.innerHTML='üåô Áù°Áú†„Éñ„É≠„ÉÉ„ÇØ„ÇíËøΩÂä†„Åô„Çã„Å®Ëá™ÂãïË®àÁÆó„Åï„Çå„Åæ„Åô';
    }
  }

  renderBlockList(day.blocks);
  renderTimeline(day.blocks);
  renderPie(day.blocks);
  renderEffort(day.blocks);
  updateMetrics(day);
  renderSpecialList();
  renderQuickAdds();
  renderDayTplBar();
  renderDailyQuests();
  renderTodos();
  renderPerformance();
  updateDayXPBar(day.blocks);
  updateNav();
}

function updateDayXPBar(blocks){
  const total=blocks.reduce((s,b)=>{if(NO_XP_CATS.includes(b.category))return s;return s+(CATS[b.category]?.effort?Math.round((t2m(b.end)-t2m(b.start))/60*XP_PER_EFFORT_HOUR):Math.round((t2m(b.end)-t2m(b.start))/60*XP_PER_OTHER_HOUR));},0);
  const pct=Math.min(100,total/100*100);
  document.getElementById('dayXPBar').style.width=pct+'%';
  document.getElementById('dayXPVal').textContent=total;
}

function renderBlockList(blocks){
  const el=document.getElementById('blockList');
  if(!blocks.length){el.innerHTML='<div style="text-align:center;color:rgba(255,255,255,0.2);font-size:0.78rem;padding:20px;line-height:1.8;">„Åæ„Å†Ë®òÈå≤„Åå„Å™„ÅÑÊó•„Åß„Åô<br><span style="font-size:.65rem;color:rgba(255,255,255,0.12);">ÂÜçÈñã„ÅØ„ÅÑ„Å§„Åß„ÇÇ„Åß„Åç„Åæ„Åô</span></div>';return;}
  el.innerHTML=blocks.map(b=>{
    const cat=CATS[b.category]||{color:'#64748b',emoji:'üìã'};
    const m=t2m(b.end)-t2m(b.start);
    const isEditing=(editingBlockId===b.id);
    const autoTag=b.autoSleep?'<span style="font-size:.5rem;background:rgba(129,140,248,.15);color:#818cf8;padding:1px 5px;border-radius:4px;margin-left:4px;">Ëá™Âãï</span>':'';
    if(isEditing){
      var catOpts=Object.keys(CATS).map(function(c){return '<option value="'+c+'"'+(c===b.category?' selected':'')+'>'+CATS[c].emoji+' '+c+'</option>';}).join('');
      return '<div class="bitem editing">'+
        '<div class="bdot" style="background:'+cat.color+'"></div>'+
        '<div class="binfo">'+
          '<div class="bcat">'+cat.emoji+' '+b.category+autoTag+'</div>'+
          '<div class="bedit-row">'+
            '<input type="time" id="bedit_s_'+b.id+'" value="'+b.start+'" step="600">'+
            '<span style="color:var(--muted);font-size:.65rem;">„Äú</span>'+
            '<input type="time" id="bedit_e_'+b.id+'" value="'+b.end+'" step="600">'+
            '<select id="bedit_c_'+b.id+'">'+catOpts+'</select>'+
          '</div>'+
          '<div class="bedit-row" style="margin-top:4px;">'+
            '<button class="bedit-save" onclick="event.stopPropagation();saveEditBlock('+b.id+')">‚úì ‰øùÂ≠ò</button>'+
            '<button class="bedit-cancel" onclick="event.stopPropagation();cancelEditBlock()">‚úï</button>'+
          '</div>'+
        '</div>'+
      '</div>';
    }
    return '<div class="bitem" onclick="startEditBlock('+b.id+')"><div class="bdot" style="background:'+cat.color+'"></div><div class="binfo"><div class="bcat">'+cat.emoji+' '+b.category+autoTag+'</div><div class="btime">'+b.start+'‚Äì'+b.end+' '+m2hm(m)+'</div></div><button class="bdel" onclick="event.stopPropagation();deleteBlock('+b.id+')">√ó</button></div>';
  }).join('');
}

function renderTimeline(blocks){
  const el=document.getElementById('timeline');
  if(!blocks.length){el.innerHTML='<div style="display:flex;height:100%;align-items:center;justify-content:center;color:var(--muted);font-size:0.68rem;">„Çø„Ç§„É†„É©„Ç§„É≥</div>';return;}
  el.innerHTML=blocks.map(b=>{const cat=CATS[b.category]||{color:'#64748b'};const l=(t2m(b.start)/1440*100).toFixed(2),w=((t2m(b.end)-t2m(b.start))/1440*100).toFixed(2);return `<div class="tl-seg" style="left:${l}%;width:${w}%;background:${cat.color}" title="${b.category} ${b.start}-${b.end}"></div>`;}).join('');
}

function renderPie(blocks){
  // Category totals for legend
  var totals={};
  blocks.forEach(function(b){var m=t2m(b.end)-t2m(b.start);totals[b.category]=(totals[b.category]||0)+m;});
  var total=Object.values(totals).reduce(function(a,b){return a+b;},0);
  document.getElementById('pieTotal').textContent=total?m2hm(total)+'h':'0h';
  var labels=Object.keys(totals),data=labels.map(function(l){return totals[l];}),colors=labels.map(function(l){return (CATS[l]||{color:'#64748b'}).color;});
  document.getElementById('pieLegend').innerHTML=labels.length?labels.map(function(l,i){
    var pct=total?(data[i]/total*100).toFixed(0):0;
    return '<div class="leg-item"><div class="leg-dot" style="background:'+colors[i]+'"></div><div class="leg-name">'+l+'</div><div class="leg-val">'+m2hm(data[i])+' <span style="color:var(--muted);font-size:0.62rem">'+pct+'%</span></div></div><div class="leg-bar" style="width:'+pct+'%;background:'+colors[i]+'"></div>';
  }).join(''):'<div style="color:var(--muted);font-size:0.75rem;">„Éá„Éº„Çø„Å™„Åó</div>';

  // 24h clock chart
  var canvas=document.getElementById('clockCanvas');
  var ctx=canvas.getContext('2d');
  var W=canvas.width, H=canvas.height;
  var cx=W/2, cy=H/2, R=W/2-42, innerR=R*0.50;
  ctx.clearRect(0,0,W,H);

  // Background ring
  ctx.beginPath();ctx.arc(cx,cy,R,0,Math.PI*2);ctx.arc(cx,cy,innerR,0,Math.PI*2,true);ctx.fillStyle='rgba(30,41,59,0.4)';ctx.fill();

  // Hour grid lines (subtle radial lines every hour)
  for(var h=0;h<24;h++){
    var angle=(h/24)*Math.PI*2 - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(cx+Math.cos(angle)*innerR, cy+Math.sin(angle)*innerR);
    ctx.lineTo(cx+Math.cos(angle)*R, cy+Math.sin(angle)*R);
    ctx.strokeStyle='rgba(51,65,85,0.5)';
    ctx.lineWidth=1;
    ctx.stroke();
  }

  // Draw blocks as arcs
  var sortedBlocks=blocks.slice().sort(function(a,b){return t2m(a.start)-t2m(b.start);});
  sortedBlocks.forEach(function(b){
    var sm=t2m(b.start), em=t2m(b.end);
    if(em<=sm)return;
    var startAngle=(sm/1440)*Math.PI*2 - Math.PI/2;
    var endAngle=(em/1440)*Math.PI*2 - Math.PI/2;
    var cat=CATS[b.category]||{color:'#64748b'};
    ctx.beginPath();
    ctx.arc(cx,cy,R,startAngle,endAngle);
    ctx.arc(cx,cy,innerR,endAngle,startAngle,true);
    ctx.closePath();
    ctx.fillStyle=cat.color;
    ctx.fill();
    ctx.strokeStyle='rgba(10,10,15,0.6)';ctx.lineWidth=2;ctx.stroke();

    // Label
    var midAngle=(startAngle+endAngle)/2;
    var dur=em-sm;
    if(dur>=30){
      var labelR=(R+innerR)/2;
      var lx=cx+Math.cos(midAngle)*labelR;
      var ly=cy+Math.sin(midAngle)*labelR;
      ctx.fillStyle='#fff';
      ctx.font='bold '+(dur>=120?'26':dur>=60?'22':'16')+'px "M PLUS Rounded 1c",sans-serif';
      ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.shadowColor='rgba(0,0,0,0.8)';ctx.shadowBlur=6;
      ctx.fillText(b.category,lx,ly);
      if(dur>=60){
        ctx.font='14px "JetBrains Mono",monospace';
        ctx.fillStyle='rgba(255,255,255,0.7)';
        ctx.fillText(b.start+'-'+b.end,lx,ly+18);
      }
      ctx.shadowBlur=0;
    }
  });

  // Hour ticks and numbers ‚Äî every hour
  for(var h=0;h<24;h++){
    var angle=(h/24)*Math.PI*2 - Math.PI/2;
    var isMajor=(h%6===0);
    var is3h=(h%3===0);
    var tickLen=isMajor?12:is3h?8:5;
    var tickOuter=R+tickLen;
    var tickInner=R+1;
    ctx.beginPath();
    ctx.moveTo(cx+Math.cos(angle)*tickInner, cy+Math.sin(angle)*tickInner);
    ctx.lineTo(cx+Math.cos(angle)*tickOuter, cy+Math.sin(angle)*tickOuter);
    ctx.strokeStyle=isMajor?'rgba(148,163,184,0.8)':is3h?'rgba(148,163,184,0.5)':'rgba(100,116,139,0.35)';
    ctx.lineWidth=isMajor?2.5:is3h?1.5:1;
    ctx.stroke();

    // Number label for every hour
    var numR=R+(isMajor?26:is3h?22:18);
    var nx=cx+Math.cos(angle)*numR;
    var ny=cy+Math.sin(angle)*numR;
    ctx.fillStyle=isMajor?'rgba(203,213,225,0.9)':is3h?'rgba(148,163,184,0.7)':'rgba(100,116,139,0.5)';
    ctx.font=(isMajor?'bold 22':is3h?'bold 18':'16')+'px "JetBrains Mono",monospace';
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(h,nx,ny);
  }
}

function renderEffort(blocks){
  const total=getEffortMins(blocks);
  document.getElementById('effortBig').textContent=m2hm(total);
  document.getElementById('m_effort').textContent=m2hm(total);
  const maxM=8*60;
  document.getElementById('effortBars').innerHTML=EFFORT_CATS.map(c=>{
    const m=getCatMins(blocks,c),pct=Math.min(100,m/maxM*100),cat=CATS[c];
    return `<div class="ebar"><div class="ebar-lbl">${cat.emoji}${c}</div><div class="ebar-track"><div class="ebar-fill" style="width:${pct}%;background:${cat.color}"></div></div><div class="ebar-val">${m2hm(m)}</div></div>`;
  }).join('');
}

function updateMetrics(day){
  const totalM=day.blocks.reduce((s,b)=>s+t2m(b.end)-t2m(b.start),0);
  document.getElementById('m_total').textContent=m2hm(totalM);
  const yd=getDayData(addDays(currentDate,-1));
  function trend(a,b){if(!b)return'';const d=a-b,p=Math.round(d/b*100);if(d>0)return`<span style="color:var(--green)">‚ñ≤${p}%</span>`;if(d<0)return`<span style="color:var(--rose)">‚ñº${Math.abs(p)}%</span>`;return`<span style="color:var(--muted)">‚Üí</span>`;}
  document.getElementById('m_total_trend').innerHTML=trend(totalM,yd.blocks.reduce((s,b)=>s+t2m(b.end)-t2m(b.start),0));
  document.getElementById('m_effort_trend').innerHTML=trend(getEffortMins(day.blocks),getEffortMins(yd.blocks));
  document.getElementById('m_sleep_trend').innerHTML=day.sleepScore&&yd.sleepScore?trend(day.sleepScore,yd.sleepScore):'';
}

// ================================================================
// BLOCK EDITING (inline)
// ================================================================
var editingBlockId=null;
function startEditBlock(id){
  editingBlockId=id;
  renderP1();
}
function cancelEditBlock(){
  editingBlockId=null;
  renderP1();
}
function saveEditBlock(id){
  var s=document.getElementById('bedit_s_'+id).value;
  var e=document.getElementById('bedit_e_'+id).value;
  var c=document.getElementById('bedit_c_'+id).value;
  if(!s||!e){toast('ÊôÇÂàª„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  var day=getDayData(currentDate);
  var block=day.blocks.find(function(b){return b.id===id;});
  if(!block){toast('„Éñ„É≠„ÉÉ„ÇØ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì','err');return;}
  // Overlap check (exclude self)
  var sm=t2m(s),em=t2m(e);
  if(em<=sm){toast('ÁµÇ‰∫ÜÊôÇÂàª„ÅåÈñãÂßã„Çà„ÇäÂâç„Åß„Åô','err');return;}
  for(var i=0;i<day.blocks.length;i++){
    var b=day.blocks[i];
    if(b.id===id)continue;
    var bS=t2m(b.start),bE=t2m(b.end);
    if(sm<bE&&em>bS){toast('‚ö† '+b.start+'„Äú'+b.end+'„Å®ÈáçË§á','err');return;}
  }
  block.start=s;block.end=e;block.category=c;
  mergeBlocks(day);
  setDayData(currentDate,day);
  recalcSleepFromBlocks(currentDate);
  editingBlockId=null;
  toast('‚úèÔ∏è „Éñ„É≠„ÉÉ„ÇØ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
  renderP1();
}

// ================================================================
// DAY TEMPLATES (preset daily schedules)
// ================================================================
function getDayTemplates(){return ls_get('day_templates')||[];}
function setDayTemplates(v){ls_set('day_templates',v);}
var editingDayTplIdx=null;

function renderDayTplBar(){
  var el=document.getElementById('dayTplBar');
  var tpls=getDayTemplates();
  var chips=tpls.map(function(t,i){
    return '<span class="daytpl-chip" onclick="applyDayTpl('+i+')" title="'+t.blocks.length+'‰ª∂„ÅÆË°åÂãï„ÇíÈÅ©Áî®">'+t.name+'</span>';
  }).join('');
  el.innerHTML='<span style="font-size:.62rem;color:var(--muted2);flex-shrink:0;">üìÖ ‰∏ÄÊó•„ÉÜ„É≥„Éó„É¨Ôºö</span>'+chips+
    '<span class="daytpl-chip" onclick="openDayTplManager()" style="opacity:.6;font-size:.58rem;">‚öôÔ∏è ÁÆ°ÁêÜ</span>';
}

function openDayTplManager(){
  document.getElementById('dayTplModal').classList.add('show');
  renderDayTplManagerList();
}

function renderDayTplManagerList(){
  var tpls=getDayTemplates();
  var el=document.getElementById('dayTplList');
  if(!tpls.length){
    el.innerHTML='<div style="text-align:center;color:var(--muted);font-size:.72rem;padding:16px;">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì<br><span style="font-size:.62rem;">‰∏ã„ÅÆ„Éú„Çø„É≥„Åã„Çâ‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span></div>';
    return;
  }
  el.innerHTML=tpls.map(function(t,i){
    var blockPreview=t.blocks.slice(0,4).map(function(b){
      var cat=CATS[b.cat]||{emoji:'üìã'};
      return '<span style="font-size:.55rem;background:var(--s3);border:1px solid var(--border);padding:1px 5px;border-radius:4px;">'+cat.emoji+b.start+'-'+b.end+'</span>';
    }).join(' ')+(t.blocks.length>4?' <span style="font-size:.55rem;color:var(--muted);">+‰ªñ'+(t.blocks.length-4)+'‰ª∂</span>':'');
    return '<div style="background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;margin-bottom:6px;">'+
      '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">'+
        '<span style="font-weight:700;font-size:.8rem;">'+t.name+'</span>'+
        '<span style="font-size:.58rem;color:var(--muted);">'+t.blocks.length+'‰ª∂</span>'+
      '</div>'+
      '<div style="display:flex;flex-wrap:wrap;gap:3px;margin-bottom:8px;">'+blockPreview+'</div>'+
      '<div style="display:flex;gap:4px;">'+
        '<button class="btn sm" onclick="applyDayTpl('+i+');closeModal(\'dayTplModal\')" style="border-color:var(--green);color:var(--green);flex:1;font-size:.62rem;">‚ñ∂ ÈÅ©Áî®</button>'+
        '<button class="btn sm" onclick="editDayTpl('+i+')" style="font-size:.62rem;flex:1;">‚úèÔ∏è Á∑®ÈõÜ</button>'+
        '<button class="btn sm" onclick="deleteDayTpl('+i+')" style="color:var(--rose);font-size:.62rem;">üóë</button>'+
      '</div>'+
    '</div>';
  }).join('');
}

function saveDayTplFromCurrent(){
  var name=document.getElementById('dayTplName').value.trim();
  if(!name){toast('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  var day=getDayData(currentDate);
  if(!day.blocks.length){toast('‰ªäÊó•„ÅÆË®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì','err');return;}
  var tplBlocks=day.blocks.filter(function(b){return !b.autoSleep;}).map(function(b){return {start:b.start,end:b.end,cat:b.category};});
  if(!tplBlocks.length){toast('‰øùÂ≠ò„Åß„Åç„Çã„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì','err');return;}
  var tpls=getDayTemplates();
  tpls.push({name:name,blocks:tplBlocks});
  setDayTemplates(tpls);
  document.getElementById('dayTplName').value='';
  toast('üìÖ „Äå'+name+'„Äç„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
  renderDayTplManagerList();
  renderDayTplBar();
}

function saveDayTplEmpty(){
  var name=document.getElementById('dayTplName').value.trim();
  if(!name){toast('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  var tpls=getDayTemplates();
  tpls.push({name:name,blocks:[]});
  setDayTemplates(tpls);
  document.getElementById('dayTplName').value='';
  toast('üìÖ „Äå'+name+'„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„ÅüÔºàÁ©∫Ôºâ');
  renderDayTplManagerList();
  renderDayTplBar();
  // Open edit immediately
  editDayTpl(tpls.length-1);
}

function deleteDayTpl(i){
  var tpls=getDayTemplates();
  var name=tpls[i].name;
  tpls.splice(i,1);
  setDayTemplates(tpls);
  toast('üóë „Äå'+name+'„Äç„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
  renderDayTplManagerList();
  renderDayTplBar();
}

function editDayTpl(i){
  editingDayTplIdx=i;
  closeModal('dayTplModal');
  var tpls=getDayTemplates();
  var t=tpls[i];
  document.getElementById('dayTplEditTitle').textContent='‚úèÔ∏è '+t.name+' „ÇíÁ∑®ÈõÜ';
  // Populate cat select
  document.getElementById('dtplNewCat').innerHTML=Object.keys(CATS).map(function(c){return '<option value="'+c+'">'+CATS[c].emoji+' '+c+'</option>';}).join('');
  document.getElementById('dayTplEditModal').classList.add('show');
  renderDayTplEditList();
}

function renderDayTplEditList(){
  var tpls=getDayTemplates();
  var t=tpls[editingDayTplIdx];
  var el=document.getElementById('dayTplEditList');
  if(!t.blocks.length){
    el.innerHTML='<div style="text-align:center;color:var(--muted);font-size:.72rem;padding:16px;">„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
    return;
  }
  el.innerHTML=t.blocks.map(function(b,bi){
    var cat=CATS[b.cat]||{emoji:'üìã',color:'#64748b'};
    return '<div style="display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid var(--border);">'+
      '<div style="width:8px;height:8px;border-radius:50%;background:'+cat.color+';flex-shrink:0;"></div>'+
      '<span style="font-size:.75rem;font-weight:700;">'+cat.emoji+' '+b.cat+'</span>'+
      '<span style="font-size:.65rem;color:var(--muted);font-family:JetBrains Mono,monospace;margin-left:auto;">'+b.start+' - '+b.end+'</span>'+
      '<button class="btn sm" onclick="removeDayTplBlock('+bi+')" style="font-size:.55rem;color:var(--rose);padding:2px 6px;">√ó</button>'+
    '</div>';
  }).join('');
}

function addBlockToDayTpl(){
  var s=document.getElementById('dtplNewStart').value;
  var e=document.getElementById('dtplNewEnd').value;
  var c=document.getElementById('dtplNewCat').value;
  if(!s||!e){toast('ÊôÇÂàª„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  var tpls=getDayTemplates();
  var t=tpls[editingDayTplIdx];
  t.blocks.push({start:s,end:e,cat:c});
  t.blocks.sort(function(a,b){return t2m(a.start)-t2m(b.start);});
  setDayTemplates(tpls);
  renderDayTplEditList();
  renderDayTplBar();
  toast('Ôºã „Éñ„É≠„ÉÉ„ÇØËøΩÂä†');
}

function removeDayTplBlock(bi){
  var tpls=getDayTemplates();
  tpls[editingDayTplIdx].blocks.splice(bi,1);
  setDayTemplates(tpls);
  renderDayTplEditList();
  renderDayTplBar();
}

function applyDayTpl(i){
  var tpls=getDayTemplates();
  var t=tpls[i];
  if(!t.blocks.length){toast('„Åì„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å´„ÅØ„Éñ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì','err');return;}
  var day=getDayData(currentDate);
  var existingNonAuto=day.blocks.filter(function(b){return !b.autoSleep;});
  var added=0,skipped=0;
  t.blocks.forEach(function(tb){
    var sm=t2m(tb.start),em=t2m(tb.end);
    // Check overlap with existing
    var overlaps=false;
    for(var j=0;j<day.blocks.length;j++){
      var b=day.blocks[j];
      var bS=t2m(b.start),bE=t2m(b.end);
      if(sm<bE&&em>bS){overlaps=true;break;}
    }
    if(!overlaps){
      var block={start:tb.start,end:tb.end,category:tb.cat,id:Date.now()+Math.random()*10000|0};
      day.blocks.push(block);
      // XP
      var dur=em-sm;
      var isEffort=CATS[tb.cat]&&CATS[tb.cat].effort;
      var isNoXP=NO_XP_CATS.includes(tb.cat);
      var xpGain=isNoXP?0:(isEffort?Math.round(dur/60*XP_PER_EFFORT_HOUR):Math.round(dur/60*XP_PER_OTHER_HOUR));
      addXP(xpGain,block);
      added++;
    } else {
      skipped++;
    }
  });
  mergeBlocks(day);
  setDayData(currentDate,day);
  recalcSleepFromBlocks(currentDate);
  renderP1();
  var msg='üìÖ „Äå'+t.name+'„Äç„ÇíÈÅ©Áî® ‚Äî '+added+'‰ª∂ËøΩÂä†';
  if(skipped>0)msg+='Ôºà'+skipped+'‰ª∂„ÅØÈáçË§á„Çπ„Ç≠„ÉÉ„ÉóÔºâ';
  toast(msg);
}

function renderQuickAdds(){
  var el=document.getElementById('quickAdds');
  QUICK_TEMPLATES=getQuickTemplates();
  var chips=QUICK_TEMPLATES.map(function(t){return '<span class="qa-chip" onclick=\'quickAdd('+JSON.stringify(t).replace(/'/g,"&#39;")+')\'>'+(CATS[t.cat]?CATS[t.cat].emoji+' ':'')+t.label+'</span>';}).join('');
  el.innerHTML='<span style="font-size:0.62rem;color:var(--muted2);align-self:center;flex-shrink:0;">„Çà„Åè‰Ωø„ÅÜÔºö</span>'+chips+'<span class="qa-chip" onclick="openTplEditor()" style="opacity:.5;font-size:.58rem;">‚úèÔ∏è</span>';
}
function openTplEditor(){document.getElementById('tplEditorModal').classList.add('show');renderTplEditor();}
function renderTplEditor(){
  var tpls=getQuickTemplates();
  document.getElementById('tplEditorList').innerHTML=tpls.map(function(t,i){
    return '<div style="display:flex;align-items:center;gap:4px;padding:5px 0;border-bottom:1px solid var(--border);"><span style="flex:1;font-size:.72rem;color:var(--text);">'+(CATS[t.cat]?CATS[t.cat].emoji+' ':'')+t.label+' <span style="font-size:.58rem;color:var(--muted);">'+t.start+'-'+t.end+'</span></span><button class="btn sm" onclick="removeTpl('+i+')" style="font-size:.6rem;color:var(--rose);padding:2px 8px;">√ó</button></div>';
  }).join('');
}
function removeTpl(i){var t=getQuickTemplates();t.splice(i,1);setQuickTemplates(t);renderTplEditor();renderQuickAdds();}
function addTpl(){
  var l=document.getElementById('tplLabel').value.trim(),s=document.getElementById('tplStart').value,e=document.getElementById('tplEnd').value,c=document.getElementById('tplCat').value;
  if(!l||!s||!e){toast('ÂÖ®È†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  var t=getQuickTemplates();t.push({label:l,start:s,end:e,cat:c});setQuickTemplates(t);
  document.getElementById('tplLabel').value='';renderTplEditor();renderQuickAdds();toast('„ÉÜ„É≥„Éó„É¨„Éº„ÉàËøΩÂä†ÔºÅ');
}

// ================================================================
// PAGE 2 RENDER
// ================================================================
function renderP2(){
  const allDates=getAllDates();
  const streak=calcStreak();

  // cue
  const hour=new Date().getHours();
  const msgs=[
    ['üåÖ','„Åä„ÅØ„Çà„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ‰ªäÊó•„ÅÆË®àÁîª„ÇíÁ¢∫Ë™ç„Åó„Çà„ÅÜ','Êúù„ÅÆÁµ±Ë®à„ÉÅ„Çß„ÉÉ„ÇØ„ÅåÁøíÊÖ£„ÇíÂº∑Âåñ„Åó„Åæ„Åô'],
    ['‚ö°','‰ªäÊó•„ÅÆÈÄ≤Êçó„ÅØ„ÅÑ„Åã„Åå„Åß„Åô„ÅãÔºü','ÂçàÂæå„ÅÆËøΩ„ÅÑËæº„Åø„ÅßÁõÆÊ®ôÈÅîÊàê„Åó„Çà„ÅÜ'],
    ['üåô','‰ªäÊó•„ÇÇ„ÅäÁñ≤„ÇåÊßò„Åß„Åó„Åü','Ë®òÈå≤„ÇíÊåØ„ÇäËøî„Å£„Å¶ÊòéÊó•„Å´Ê¥ª„Åã„Åù„ÅÜ'],
  ];
  const m=hour<11?msgs[0]:hour<17?msgs[1]:msgs[2];
  document.getElementById('cueEmoji').textContent=m[0];
  document.getElementById('cueMain').textContent=m[1];
  document.getElementById('cueSub').textContent=m[2];

  // big stats
  document.getElementById('bs_streak').textContent=streak;
  document.getElementById('bs_xp').textContent=getTotalXP();
  // Only count days with actual data for averages (exclude unrecorded "pause" days)
  const recordedDates=allDates.filter(d=>{const dd=getDayData(d);return dd.blocks.length>0||dd.sleepScore!==null;});
  const allEffort=recordedDates.reduce((s,d)=>s+getEffortMins(getDayData(d).blocks),0);
  document.getElementById('bs_effort').textContent=m2hm(allEffort);
  const allD=recordedDates.filter(d=>getDayData(d).sleepScore);
  const avgSleep=allD.length?Math.round(allD.reduce((s,d)=>s+getDayData(d).sleepScore,0)/allD.length):null;
  document.getElementById('bs_sleep').textContent=avgSleep!==null?avgSleep:'--';
  document.getElementById('bs_effort_sub').textContent=recordedDates.length?`Ë®òÈå≤${recordedDates.length}Êó• / Âπ≥Âùá${m2hm(allEffort/recordedDates.length)}`:'Ë®òÈå≤„Å™„Åó';

  renderTrends();
  renderHabitGrid();
  renderHistory();
}

function setTrend(m){
  trendMode=m;
  document.getElementById('trendDayBtn').classList.toggle('active',m==='day');
  document.getElementById('trendWeekBtn').classList.toggle('active',m==='week');
  renderTrends();
}

function getWeekStart(d){const dt=parseDate(d),day=dt.getDay(),diff=day===0?-6:1-day;dt.setDate(dt.getDate()+diff);return dt.getFullYear()+'-'+String(dt.getMonth()+1).padStart(2,'0')+'-'+String(dt.getDate()).padStart(2,'0');}

function renderTrends(){
  let labels,data;
  if(trendMode==='day'){
    labels=[];data=[];
    for(let i=13;i>=0;i--){const d=addDays(currentDate,-i);labels.push(formatShort(d));data.push(getDayData(d));}
  } else {
    const wm={};getAllDates().forEach(d=>{const w=getWeekStart(d);if(!wm[w])wm[w]=[];wm[w].push(getDayData(d));});
    const weeks=Object.keys(wm).sort().slice(-8);
    labels=weeks.map(w=>{const dt=parseDate(w);return `${dt.getMonth()+1}/${dt.getDate()}W`;});
    data=weeks.map(w=>{const days=wm[w],blocks=days.flatMap(d=>d.blocks),scores=days.map(d=>d.sleepScore).filter(Boolean);return{blocks,sleepScore:scores.length?Math.round(scores.reduce((a,b)=>a+b)/scores.length):null};});
  }
  _renderLine(labels,data);
  _renderEffortLine(labels,data);
}

const CO={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#4a6080',font:{family:'JetBrains Mono',size:9}}},y:{grid:{color:'rgba(255,255,255,0.03)'},ticks:{color:'#4a6080',font:{family:'JetBrains Mono',size:9}}}}};

function _renderLine(labels,data){
  const ctx=document.getElementById('lineChart').getContext('2d');
  if(lineChart)lineChart.destroy();
  const cats=['‰ªï‰∫ã','Â≠¶Áøí','ÈÅãÂãï','Ë∂£Âë≥','‰ºëÊÜ©'];
  lineChart=new Chart(ctx,{type:'line',data:{labels,datasets:cats.map(c=>({label:c,data:data.map(d=>+(getCatMins(d.blocks,c)/60).toFixed(1)),borderColor:CATS[c].color,backgroundColor:CATS[c].color+'18',tension:0.4,pointRadius:3,borderWidth:2}))},options:{...CO,plugins:{legend:{display:true,labels:{color:'#6a85a8',font:{family:'M PLUS Rounded 1c',size:10},boxWidth:8,boxHeight:8}}}}});
}

function _renderEffortLine(labels,data){
  const ctx=document.getElementById('effortChart').getContext('2d');
  if(effortChart)effortChart.destroy();
  // Gray out unrecorded days: use different color per bar
  const effortData=data.map(d=>+(getEffortMins(d.blocks||[])/60).toFixed(1));
  const barColors=data.map(d=>{
    var hasBlocks=d.blocks&&d.blocks.length>0;
    var hasSleep=d.sleepScore!==null&&d.sleepScore!==undefined;
    if(hasBlocks||hasSleep)return 'rgba(74,222,128,0.25)';
    return 'rgba(255,255,255,0.06)'; // unrecorded = very faint white
  });
  const barBorders=data.map(d=>{
    var hasBlocks=d.blocks&&d.blocks.length>0;
    var hasSleep=d.sleepScore!==null&&d.sleepScore!==undefined;
    if(hasBlocks||hasSleep)return '#4ade80';
    return 'rgba(255,255,255,0.15)';
  });
  // For unrecorded days, show a tiny gray placeholder bar
  const displayData=effortData.map((v,i)=>{
    if(v===0&&barColors[i].includes('255,255,255')){return 0.05;} // tiny placeholder
    return v;
  });
  effortChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{type:'bar',label:'Âä™ÂäõÊôÇÈñì(h)',data:displayData,backgroundColor:barColors,borderColor:barBorders,borderWidth:1,yAxisID:'y'},{type:'line',label:'Áù°Áú†„Çπ„Ç≥„Ç¢',data:data.map(d=>d.sleepScore||null),borderColor:'#c084fc',backgroundColor:'transparent',tension:0.4,pointRadius:4,pointBackgroundColor:'#c084fc',borderWidth:2,yAxisID:'y2',spanGaps:true}]},options:{...CO,scales:{x:CO.scales.x,y:{...CO.scales.y,position:'left',title:{display:true,text:'h',color:'#4a6080',font:{size:9}}},y2:{...CO.scales.y,position:'right',min:0,max:100,grid:{drawOnChartArea:false},title:{display:true,text:'Score',color:'#4a6080',font:{size:9}}}},plugins:{legend:{display:true,labels:{color:'#6a85a8',font:{family:'M PLUS Rounded 1c',size:10},boxWidth:8,boxHeight:8}}}}});
}

function renderHabitGrid(){
  const el=document.getElementById('habitGrid');
  const today=todayStr();
  const allDates=getAllDates();
  let html='';
  for(let i=55;i>=0;i--){
    const d=addDays(today,-i);
    const hasData=allDates.includes(d)&&getDayData(d).blocks.length>0;
    const isFuture=parseDate(d)>new Date();
    const isPast=!isFuture&&!hasData&&parseDate(d)<new Date();
    const score=hasData?Math.min(100,getEffortMins(getDayData(d).blocks)/360*100):0;
    const opacity=hasData?Math.max(0.2,score/100):0.04;
    const dd=parseDate(d);
    let bg,border,titleSuffix;
    if(hasData){
      bg='rgba(74,222,128,'+opacity+')';border='rgba(74,222,128,0.3)';titleSuffix=' ‚úì';
    } else if(isPast){
      // Unrecorded past day ‚Äî white/soft (not failure, just "pause")
      bg='rgba(255,255,255,0.04)';border='rgba(255,255,255,0.08)';titleSuffix=' ‚è∏ ‰∏ÄÊôÇÂÅúÊ≠¢';
    } else {
      bg='rgba(26,40,32,0.2)';border='var(--border)';titleSuffix='';
    }
    if(d===today){border='var(--cyan)';}
    html+='<div class="hcell '+(hasData?'filled':'')+' '+(d===today?'today-cell':'')+'" style="background:'+bg+';border-color:'+border+';" onclick="jumpDate(\''+d+'\')" title="'+formatShort(d)+titleSuffix+'">'+dd.getDate()+'</div>';
  }
  el.innerHTML=html;
  updateStreakReward();
}

// ================================================================
// STREAK REWARD SYSTEM
// ================================================================
function getStreakRewardAmount(streak){
  // Base 10G, increases with streak: 10, 15, 20, 30, 50, 80, 120, 180, 250, 350...
  if(streak<=0)return 0;
  if(streak<=3)return 10+streak*5;
  if(streak<=7)return 20+streak*8;
  if(streak<=14)return 40+(streak-7)*15;
  if(streak<=30)return 150+(streak-14)*20;
  return 500+Math.floor((streak-30)*30);
}

function getStreakRewardCollected(date){return ls_get('streak_collected_'+date)||false;}
function setStreakRewardCollected(date){ls_set('streak_collected_'+date,true);}

function updateStreakReward(){
  var streak=calcStreak();
  var today=todayStr();
  var todayData=getDayData(today);
  var hasRecord=todayData.blocks.length>0||todayData.sleepScore!==null;
  var collected=getStreakRewardCollected(today);
  var amount=getStreakRewardAmount(streak);
  var area=document.getElementById('streakRewardArea');
  var btn=document.getElementById('streakRewardBtn');
  var days=document.getElementById('streakRewardDays');
  var desc=document.getElementById('streakRewardDesc');
  if(!area)return;
  days.textContent=streak;
  if(!hasRecord){
    desc.textContent='‰ªäÊó•„ÅÆË®òÈå≤„ÇíËøΩÂä†„Åô„Çã„Å®„Éú„Éº„Éä„Çπ„Åå„ÇÇ„Çâ„Åà„Åæ„Åô';
    btn.textContent='Ë®òÈå≤„Å™„Åó';btn.disabled=true;btn.style.opacity='0.35';
  } else if(collected){
    desc.textContent='Êú¨Êó•ÂàÜ„ÅØÂèóÂèñÊ∏à„ÅøÔºà+'+amount+'GÔºâ';
    btn.textContent='‚úì Ê∏à';btn.disabled=true;btn.style.opacity='0.35';
  } else {
    desc.textContent=streak+'Êó•Á∂ôÁ∂ö„Åß +'+amount+'G „Åå„ÇÇ„Çâ„Åà„Åæ„ÅôÔºÅ';
    btn.textContent='üì• +'+amount+'G';btn.disabled=false;btn.style.opacity='1';
  }
}

function collectStreakReward(){
  var today=todayStr();
  if(getStreakRewardCollected(today)){toast('‰ªäÊó•„ÅØ„ÇÇ„ÅÜÂèó„ÅëÂèñ„ÇäÊ∏à„Åø„Åß„Åô','err');return;}
  var todayData=getDayData(today);
  if(todayData.blocks.length===0&&todayData.sleepScore===null){toast('„Åæ„Åö‰ªäÊó•„ÅÆË®òÈå≤„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  var streak=calcStreak();
  var amount=getStreakRewardAmount(streak);
  setStreakRewardCollected(today);
  setGold(getGold()+amount);
  setTotalEarned(getTotalEarned()+amount);
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üî• +'+amount+'G');
  addEventLog('üî• '+streak+'Êó•Á∂ôÁ∂ö„Éú„Éº„Éä„Çπ +'+amount+'G','money');
  toast('üî• Á∂ôÁ∂ö„Éú„Éº„Éä„Çπ +'+amount+'GÔºÅ');
  updateNav();updateStreakReward();
  if(curPage===2){renderEconomy();}
  checkAchievements();
}

function renderHistory(){
  // Show last 30 days including unrecorded days
  var el=document.getElementById('histList');
  var today=todayStr();
  var cats=['‰ªï‰∫ã','Â≠¶Áøí','ÈÅãÂãï','Ë∂£Âë≥','‰ºëÊÜ©'];
  var html='';
  for(var i=0;i<30;i++){
    var d=addDays(today,-i);
    var day=getDayData(d);
    var hasData=day.blocks.length>0||day.sleepScore!==null;
    if(hasData){
      var eff=getEffortMins(day.blocks);
      var bars=cats.map(function(c){var m=getCatMins(day.blocks,c),h=Math.min(16,m/60/8*16);return '<div class="hist-bar" style="height:'+h+'px;background:'+CATS[c].color+';width:10px;opacity:'+(h>0?0.8:0.15)+';"></div>';}).join('');
      html+='<div class="hist-item'+(d===currentDate?' cur':'')+'" onclick="jumpDate(\''+d+'\')">'
        +'<div class="hist-date">'+formatShort(d)+'</div>'
        +'<div class="hist-mini">'+bars+'</div>'
        +'<div class="hist-effort">'+m2hm(eff)+'</div>'
        +'<div class="hist-score">'+(day.sleepScore!==null&&day.sleepScore!==undefined?day.sleepScore+'ÁÇπ':'--')+'</div>'
        +'</div>';
    } else if(i>0){
      // Unrecorded past day ‚Äî gentle white pause display
      html+='<div class="hist-item'+(d===currentDate?' cur':'')+'" onclick="jumpDate(\''+d+'\')" style="opacity:.45;background:rgba(255,255,255,0.015);border-color:rgba(255,255,255,0.04);">'
        +'<div class="hist-date" style="color:rgba(255,255,255,0.25);">'+formatShort(d)+'</div>'
        +'<div class="hist-mini" style="flex:1;"></div>'
        +'<div style="font-size:.62rem;color:rgba(255,255,255,0.2);font-style:italic;">‚è∏ ‰∏ÄÊôÇÂÅúÊ≠¢</div>'
        +'</div>';
    }
  }
  if(!html)html='<div style="text-align:center;color:var(--muted);font-size:0.78rem;padding:14px;">„Åæ„Å†Ë®òÈå≤„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
  el.innerHTML=html;
}

function jumpDate(d){currentDate=d;gotoPage(0);renderP1();}

// ================================================================
// PAGE 3: SKILL TREE
// ================================================================

// --- Compute actual hours from all records ---
function getAllCatHours(cat){
  return getAllDates().reduce((s,d)=>s+getCatMins(getDayData(d).blocks,cat),0)/60;
}

function getSkillActualValue(skill){
  const boosts=getSkillBoosts();
  const boostHours=(boosts[skill.id]||0)*2/60; // 1xp = 2 extra minutes
  if(!skill.specialCalc){
    return getAllCatHours(DOMAINS.find(d=>d.skills.find(s=>s.id===skill.id))?.cat||'‰ªï‰∫ã')+boostHours;
  }
  switch(skill.specialCalc){
    case 'streak': return calcStreak();
    case 'days':   return getAllDates().filter(d=>getDayData(d).blocks.length>0).length;
    case 'sleep': {
      const good=getAllDates().filter(d=>(getDayData(d).sleepScore||0)>=60).length;
      return good+boostHours;
    }
    case 'sleep_deep': {
      const great=getAllDates().filter(d=>(getDayData(d).sleepScore||0)>=70).length;
      return great+boostHours;
    }
    case 'sleep_days': {
      const sl=getAllDates().filter(d=>getDayData(d).sleepTime).length;
      return sl+boostHours;
    }
    case 'alldomain': {
      const domLevels=DOMAINS.map(dom=>getSkillLevel(dom.skills[0]));
      return Math.min(...domLevels);
    }
    default: return 0;
  }
}

function getSkillLevel(skill){
  // Check if this skill is unlocked (previous skill in domain must be maxed)
  if(!isSkillUnlocked(skill)) return 0;
  const val=getSkillActualValue(skill);
  let lv=0;
  for(let i=0;i<skill.thresholds.length;i++) if(val>=skill.thresholds[i]) lv=i;
  return lv;
}

function isSkillUnlocked(skill){
  for(var d=0;d<DOMAINS.length;d++){
    var dom=DOMAINS[d];
    for(var s=0;s<dom.skills.length;s++){
      if(dom.skills[s].id===skill.id){
        if(s===0) return true; // First skill always unlocked
        var prev=dom.skills[s-1];
        var prevVal=getSkillActualValue(prev);
        var prevMaxThreshold=prev.thresholds[prev.thresholds.length-1];
        // Previous skill must reach max threshold to unlock next
        if(prevVal>=prevMaxThreshold) return true;
        // Also check if awakened
        if(getAwakenedSkills().includes(prev.id)) return true;
        return false;
      }
    }
  }
  return true;
}

function getSkillProgress(skill){
  const lv=getSkillLevel(skill);
  const maxLv=skill.thresholds.length-1;
  if(lv>=maxLv) return 1;
  const val=getSkillActualValue(skill);
  const curr=skill.thresholds[lv];
  const next=skill.thresholds[lv+1];
  return Math.min(1,(val-curr)/(next-curr));
}

function getDomainLevel(domain){
  const lvs=domain.skills.map(s=>getSkillLevel(s));
  return Math.floor(lvs.reduce((a,b)=>a+b,0)/lvs.length);
}

function getDomainHours(domain){
  if(domain.cat) return getAllCatHours(domain.cat);
  // balance domain: average of all
  return DOMAINS.filter(d=>d.cat).reduce((s,d)=>s+getAllCatHours(d.cat),0)/5;
}

// --- Render self status ---
function renderSelfStatus(){
  const xp=getTotalXP();
  const lv=getLevel(xp);
  const lvIdx=LEVELS.indexOf(lv);
  const streak=calcStreak();
  const allDates=getAllDates();
  const allEffort=allDates.reduce((s,d)=>s+getEffortMins(getDayData(d).blocks),0);

  document.getElementById('avatarEmoji').textContent=lv.avatar;
  document.getElementById('avatarEmoji').style.fontSize='3rem';
  document.getElementById('avatarLv').textContent='Lv.'+( lvIdx+1);
  document.getElementById('avatarEmoji').style.borderColor=lv.color;
  document.getElementById('avatarEmoji').style.boxShadow=`0 0 30px ${lv.color}55`;
  document.getElementById('selfTitle').textContent=lv.title;
  document.getElementById('selfTitle').style.background=`${lv.color}22`;
  document.getElementById('selfTitle').style.borderColor=`${lv.color}55`;
  document.getElementById('selfTitle').style.color=lv.color;

  document.getElementById('ss_days').textContent=allDates.length;
  document.getElementById('ss_streak').textContent=streak;
  document.getElementById('ss_effort').textContent=m2hm(allEffort);
  document.getElementById('ss_totalxp').textContent=xp;
  const wage=calcWage();
  const el_w=document.getElementById('ss_wage');
  const el_g=document.getElementById('ss_gold');
  if(el_w) el_w.textContent=wage.toLocaleString()+' G/h';
  if(el_g) el_g.textContent=getTotalEarned().toLocaleString();

  // Self bars: each domain
  document.getElementById('selfBars').innerHTML=DOMAINS.map(dom=>{
    const h=getDomainHours(dom);
    const maxH=Math.max(1,...DOMAINS.map(d=>getDomainHours(d)));
    const pct=Math.min(100,h/maxH*100);
    return `<div class="sbar-row">
      <div class="sbar-lbl">${dom.icon}${dom.name}</div>
      <div class="sbar-track"><div class="sbar-fill" style="width:${pct}%;background:${dom.color};"></div></div>
      <div class="sbar-val">${Math.floor(h)}h</div>
    </div>`;
  }).join('');
}

// --- Render domain grid ---
function renderDomains(){
  const el=document.getElementById('domainGrid');
  el.innerHTML=DOMAINS.map(dom=>{
    const lv=getDomainLevel(dom);
    const hours=getDomainHours(dom);
    const maxH=100;
    const pct=Math.min(100,hours/maxH*100);
    const isActive=selectedDomainId===dom.id;
    return `<div class="domain-card ${isActive?'active-domain':''}"
      style="border-color:${isActive?dom.color:''};box-shadow:${isActive?`0 0 20px ${dom.color}30`:''}"
      onclick="selectDomain('${dom.id}')">
      <div class="domain-top">
        <div class="domain-icon">${dom.icon}</div>
        <div>
          <div class="domain-name" style="color:${dom.color}">${dom.name}</div>
          <div class="domain-lv">Lv.${lv} / 4</div>
        </div>
      </div>
      <div class="domain-bar-wrap"><div class="domain-bar" style="width:${pct}%;background:${dom.color}"></div></div>
      <div class="domain-xp-row">
        <span>${dom.desc}</span>
        <span class="domain-xp" style="color:${dom.color}">${Math.floor(hours)}h</span>
      </div>
      <div style="position:absolute;inset:0;border-radius:14px;pointer-events:none;" class="domain-card::after"></div>
    </div>`;
  }).join('');
}

// --- Select domain ‚Üí show tree ---
function selectDomain(domId){
  selectedDomainId=domId;
  setSTTab('tree');
}

function setSTTab(tab){
  stTab=tab;
  document.getElementById('sttab0').classList.toggle('active',tab==='domains');
  document.getElementById('sttab1').classList.toggle('active',tab==='tree');
  document.getElementById('domainView').style.display=tab==='domains'?'block':'none';
  document.getElementById('treeView').style.display=tab==='tree'?'block':'none';
  if(tab==='domains') renderDomains();
  if(tab==='tree'&&selectedDomainId) renderSkillTree(selectedDomainId);
}

// --- Render SVG skill tree for a domain ---
function renderSkillTree(domId){
  const dom=DOMAINS.find(d=>d.id===domId);
  if(!dom) return;
  document.getElementById('selectedDomainName').textContent=`${dom.icon} ${dom.name} ‚Äî „Çπ„Ç≠„É´„ÉÑ„É™„Éº`;

  const skills=dom.skills;
  const n=skills.length;
  const W=Math.max(500, n*100+60), H=300;
  // Dynamic layout: distribute nodes evenly
  const positions=[];
  const spacing=Math.floor((W-80)/(n-1||1));
  for(let i=0;i<n;i++){
    const row=i%2===0?140:160; // slight zigzag for visual interest
    positions.push({x:40+i*spacing, y:row});
  }

  let svg=`<svg viewBox="0 0 ${W} ${H}" class="skill-tree-svg" style="max-height:280px;">
    <defs>
      <filter id="glow"><feGaussianBlur stdDeviation="3" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    </defs>`;

  // Draw connecting lines
  for(let i=0;i<skills.length-1;i++){
    const a=positions[i],b=positions[i+1];
    const lvA=getSkillLevel(skills[i]);
    const unlocked=lvA>0;
    svg+=`<line x1="${a.x+36}" y1="${a.y}" x2="${b.x-36}" y2="${b.y}" stroke="${dom.color}" class="skill-line ${unlocked?'unlocked':''}"/>`;
  }

  // Draw skill nodes
  skills.forEach((skill,i)=>{
    const pos=positions[i];
    const lv=getSkillLevel(skill);
    const prog=getSkillProgress(skill);
    const maxLv=skill.thresholds.length-1;
    const isAwakened=lv>=maxLv&&getAwakenedSkills().includes(skill.id);
    const isSelected=selectedSkillId===skill.id;
    const nodeColor=lv>0?dom.color:'#3a4a6a';
    const r=34;

    // Progress arc
    const circumference=2*Math.PI*r;
    const dash=circumference*prog;
    const gap=circumference-dash;

    svg+=`<g class="skill-node" onclick="selectSkill('${skill.id}','${domId}')" transform="translate(${pos.x},${pos.y})">
      <!-- bg circle -->
      <circle r="${r}" fill="${lv>0?nodeColor+'18':'#1a2640'}" stroke="${isSelected?nodeColor:'#2a3a5a'}" stroke-width="${isSelected?3:1.5}"/>
      <!-- progress arc -->
      <circle r="${r}" fill="none" stroke="${nodeColor}" stroke-width="4" stroke-dasharray="${dash} ${gap}" stroke-linecap="round" transform="rotate(-90)" opacity="${lv>0?0.8:0.3}"/>
      <!-- awakened glow -->
      ${isAwakened?`<circle r="${r+6}" fill="none" stroke="${nodeColor}" stroke-width="1" opacity="0.4" style="animation:pulse 2s infinite;"/>`:''} 
      <!-- icon -->
      <text text-anchor="middle" dominant-baseline="central" font-size="20" y="${lv===0?-6:-8}">${skill.icon}</text>
      <!-- level indicator dots -->
      ${Array.from({length:maxLv},(_,di)=>`<circle cx="${-(maxLv*2)+di*4}" cy="${r-10}" r="2.5" fill="${di<lv?nodeColor:'#2a3a5a'}"/>`).join('')}
      <!-- name -->
      <text class="sn-label" text-anchor="middle" y="${r+16}" fill="${lv>0?'#dce8f8':'#4a6080'}">${skill.name}</text>
      ${isAwakened?`<text text-anchor="middle" y="${r+28}" font-size="9" fill="${nodeColor}" font-family="JetBrains Mono">‚òÖË¶öÈÜí</text>`:`<text class="sn-lv" text-anchor="middle" y="${r+28}" fill="${lv>0?nodeColor:'#3a4a6a'}">Lv.${lv}/${maxLv}</text>`}
    </g>`;
  });

  svg+=`</svg>`;
  document.getElementById('skillTreeSVGWrap').innerHTML=svg;
}

function selectSkill(skillId, domId){
  selectedSkillId=skillId;
  selectedDomainId=domId;
  renderSkillTree(domId);
  renderSkillDetail(skillId, domId);
}

function renderSkillDetail(skillId, domId){
  const dom=DOMAINS.find(d=>d.id===domId);
  const skill=dom?.skills.find(s=>s.id===skillId);
  if(!skill){document.getElementById('skillDetail').innerHTML='<div class="sd-empty">‚Üê „Çπ„Ç≠„É´„ÇíÈÅ∏Êäû</div>';return;}
  const lv=getSkillLevel(skill);
  const prog=getSkillProgress(skill);
  const maxLv=skill.thresholds.length-1;
  const val=getSkillActualValue(skill);
  const nextThresh=lv<maxLv?skill.thresholds[lv+1]:null;
  const avail=getAvailXP();
  const boostCost=50; // 50 XP = 2h boost
  const canBoost=avail>=boostCost&&lv<maxLv;
  const isAwakened=getAwakenedSkills().includes(skill.id);

  const nodeColor=lv>0?dom.color:'#64748b';
  const pctNum=Math.round(prog*100);

  document.getElementById('skillDetail').innerHTML=`
    <div class="sd-icon">${skill.icon}${isAwakened?'‚ú®':''}</div>
    <div class="sd-name" style="color:${nodeColor}">${skill.name}</div>
    <div class="sd-desc">${skill.desc}</div>
    <div class="sd-lv-row">
      <span class="sd-lv-label">ÁèæÂú®„É¨„Éô„É´</span>
      <span class="sd-lv-val" style="color:${nodeColor}">Lv.${lv} / ${maxLv} &nbsp; ${pctNum}%</span>
    </div>
    <div class="sd-bar"><div class="sd-bar-fill" style="width:${pctNum}%;background:linear-gradient(90deg,${nodeColor},${nodeColor}aa)"></div></div>
    <div class="sd-effect">
      <div class="sd-effect-title">ÁèæÂú®„ÅÆÂäπÊûú</div>
      <div style="color:${nodeColor}">${skill.effects[lv]}</div>
    </div>
    ${lv<maxLv?`
      <div class="sd-effect" style="margin-bottom:8px;">
        <div class="sd-effect-title">Ê¨°„ÅÆ„É¨„Éô„É´„Å∏</div>
        <div style="color:var(--muted2)">„ÅÇ„Å® ${nextThresh?Math.max(0,(nextThresh-val)).toFixed(1):'-'} ${skill.specialCalc?'Êó•/Âõû':'ÊôÇÈñì'}</div>
        <div style="font-size:0.65rem;color:var(--muted);margin-top:2px;">${skill.effects[lv+1]}</div>
      </div>
      <div style="font-size:.6rem;color:var(--muted);margin-bottom:4px;">‚ö° XP„ÅßÂä†ÈÄüÔºàÊâÄÊåÅ: ${avail} XPÔºâ</div>
      <div style="display:flex;flex-direction:column;gap:4px;">
        ${[{xp:50,h:2,label:'Â∞ë„Åó'},{xp:200,h:8,label:'„Ç¨„ÉÉ„ÉÑ„É™'},{xp:1000,h:40,label:'Â§ßÈáèÊäïÂÖ•'},{xp:5000,h:200,label:'ÂÖ®Âäõ„Éñ„Éº„Çπ„Éà'}].map(t=>{
          var ok=avail>=t.xp&&lv<maxLv;
          return '<button class="sd-upgrade-btn '+(ok?'can':'cant')+'" onclick="'+(ok?"boostSkillAmt('"+skillId+"','"+domId+"',"+t.xp+")":'')+'" style="padding:8px 12px;font-size:.72rem;">'+(ok?'‚ö° '+t.label+' ('+t.xp+' XP = +'+t.h+'hÊèõÁÆó)':'XP‰∏çË∂≥ (ÂøÖË¶Å:'+t.xp+')')+'</button>';
        }).join('')}
      </div>
    `:isAwakened?`<div style="text-align:center;padding:12px;background:rgba(74,222,128,0.08);border-radius:10px;border:1px solid rgba(74,222,128,0.3);">
        <div style="font-size:1.2rem;">‚ú®</div>
        <div style="font-weight:800;color:var(--green);font-size:0.85rem;">Ë¶öÈÜíÊ∏à„Åø</div>
        <div style="font-size:0.68rem;color:var(--muted2);margin-top:4px;">${skill.effects[maxLv]}</div>
      </div>`:
      `<div style="text-align:center;padding:10px;">
        <div style="font-weight:800;color:${nodeColor}">ÊúÄÂ§ß„É¨„Éô„É´Âà∞ÈÅîÔºÅ</div>
        <button class="sd-upgrade-btn can" onclick="awakenSkill('${skillId}','${domId}')" style="margin-top:10px;">
          ‚ú® Ë¶öÈÜí„Åï„Åõ„Çã
        </button>
      </div>`}`;
}

function boostSkill(skillId, domId){
  boostSkillAmt(skillId, domId, 50);
}

function boostSkillAmt(skillId, domId, amount){
  if(getAvailXP()<amount){toast('XP„ÅåË∂≥„Çä„Åæ„Åõ„Çì','err');return;}
  const boosts=getSkillBoosts();
  boosts[skillId]=(boosts[skillId]||0)+amount;
  setSkillBoosts(boosts);
  setSpentXP(getSpentXP()+amount);
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'‚ö° +'+amount+'XPÊäïË≥áÔºÅ');
  addEventLog(`‚ö° „Äå${DOMAINS.find(d=>d.id===domId)?.skills.find(s=>s.id===skillId)?.name}„Äç„Å´${amount}XP„ÇíÊäïË≥á„Åó„Åü`,'levelup');
  renderSkillDetail(skillId,domId);
  renderSkillTree(domId);
  renderSelfStatus();
  updateNav();
  checkAwakenings();
}

function awakenSkill(skillId, domId){
  const skill=DOMAINS.find(d=>d.id===domId)?.skills.find(s=>s.id===skillId);
  if(!skill) return;
  const awakened=getAwakenedSkills();
  if(awakened.includes(skillId)) return;
  awakened.push(skillId);
  setAwakenedSkills(awakened);
  addEventLog(`‚ú® „Äå${skill.name}„Äç„ÅåË¶öÈÜí„Åó„ÅüÔºÅ${skill.effects[skill.thresholds.length-1]}`,'awakening');
  triggerAwakening(skill);
  renderP3();
}

function checkAwakenings(){
  // Check if any skill newly reached max level
  DOMAINS.forEach(dom=>{
    dom.skills.forEach(skill=>{
      const lv=getSkillLevel(skill);
      const maxLv=skill.thresholds.length-1;
      if(lv>=maxLv&&!getAwakenedSkills().includes(skill.id)){
        // Auto-prompt awakening
        addEventLog(`üîî „Äå${skill.name}„Äç„ÅåË¶öÈÜíÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åó„ÅüÔºÅË¶öÈÜí„Éú„Çø„É≥„ÇíÊäº„Åù„ÅÜ`,'warning');
      }
    });
  });
}

function triggerAwakening(skill){
  const particles=['‚ö°','‚ú®','üåü','üíé','üî•'];
  document.getElementById('awParticles').textContent=particles[Math.floor(Math.random()*particles.length)];
  document.getElementById('awTitle').textContent=`${skill.name} ‚Äî Ë¶öÈÜí`;
  document.getElementById('awSub').textContent=`${skill.effects[skill.thresholds.length-1]}\n\n„ÅÇ„Å™„Åü„ÅÆÁ∂ôÁ∂ö„Åó„ÅüË®òÈå≤„Åå„Åì„ÅÆ„Çπ„Ç≠„É´„ÇíËß£Êîæ„Åó„Åæ„Åó„Åü„ÄÇ`;
  document.getElementById('awakeningOverlay').classList.add('show');
}
function closeAwakening(){document.getElementById('awakeningOverlay').classList.remove('show');}

// Event log
function addEventLog(text, type='levelup'){
  const log=getEventLog();
  log.unshift({text, type, date:todayStr()});
  setEventLog(log);
  renderEventLog();
}

function renderEventLog(){
  const log=getEventLog();
  const el=document.getElementById('eventLog');
  if(!log.length){
    el.innerHTML='<div style="text-align:center;color:var(--muted);font-size:0.75rem;padding:12px;">Ë®òÈå≤„ÇíÂßã„ÇÅ„Çã„Å®Áâ©Ë™û„ÅåÂãï„ÅçÂá∫„Åó„Åæ„Åô</div>';
    return;
  }
  el.innerHTML=log.slice(0,20).map(e=>`
    <div class="el-item ${e.type}">
      ${e.text}
      <div class="el-date">${formatShort(e.date)}</div>
    </div>`).join('');
}

function renderP3(){
  updateNav();
  renderSelfStatus();
  renderEconomy();
  renderDomains();
  renderEventLog();
  if(stTab==='tree'&&selectedDomainId) renderSkillTree(selectedDomainId);
  if(selectedSkillId&&selectedDomainId) renderSkillDetail(selectedSkillId,selectedDomainId);
  const avail=getAvailXP();
  const el_xp=document.getElementById('gardenXP');
  const el_bar=document.getElementById('gardenXPBar');
  if(el_xp) el_xp.textContent=avail+' XP';
  if(el_bar) el_bar.style.width=Math.min(100,avail/Math.max(100,getTotalXP())*100)+'%';
  // v5 extensions
  updateSleepXPBadge();
  tickPassiveIncome();
  renderInvestments();
  if(curP3Tab==='life')renderLifestyle();
  if(curP3Tab==='ach')renderAchievements();
  renderTownRank();
  setTimeout(()=>checkAchievements(),200);
}

// ================================================================
// REWARD
// ================================================================
function showReward(emoji,title,sub){
  document.getElementById('rewardEmoji').textContent=emoji;
  document.getElementById('rewardTitle').textContent=title;
  document.getElementById('rewardSub').textContent=sub;
  document.getElementById('rewardOverlay').classList.add('show');
}
function closeReward(){document.getElementById('rewardOverlay').classList.remove('show');}

// ================================================================
// TOAST
// ================================================================
function toast(msg,type='ok'){
  const t=document.getElementById('toast');
  document.getElementById('toastIcon').textContent=type==='err'?'‚ö†':'‚úì';
  document.getElementById('toastMsg').textContent=msg;
  t.className='toast'+(type==='err'?' err':'')+' on';
  t.style.borderColor=type==='err'?'var(--rose)':'var(--green)';
  clearTimeout(t._t);
  t._t=setTimeout(()=>{t.className='toast'+(type==='err'?' err':'');},2400);
}

// Emit event on block add
function onBlockAdded(cat){
  const prevWage=calcWage();
  const dom=DOMAINS.find(d=>d.cat===cat);
  if(dom){
    setTimeout(()=>{
      dom.skills.forEach(skill=>{
        const lv=getSkillLevel(skill);
        const prevKey='prev_lv_'+skill.id;
        const prevLv=parseInt(ls_get(prevKey)||'0');
        if(lv>prevLv){
          ls_set(prevKey,lv);
          const newWage=calcWage();
          addEventLog(`üìà „Äå${skill.name}„Äç„ÅåLv.${lv}„Å´ÔºÅ${skill.effects[lv]}`,'levelup');
          if(newWage>prevWage){
            addEventLog(`üí∞ ÊôÇÁµ¶„Ç¢„ÉÉ„ÉóÔºÅ ${prevWage}‚Üí${newWage} G/h`,'money');
            showReward(dom.icon,`${dom.name}„Çπ„Ç≠„É´„Ç¢„ÉÉ„ÉóÔºÅ`,`„Äå${skill.name}„Äç„ÅåLv.${lv}„Å´ÊàêÈï∑ÔºÅ\n${skill.effects[lv]}\n\nüí∞ ÊôÇÁµ¶„Åå${newWage.toLocaleString()}„Å´‰∏äÊòáÔºÅ`);
          }
        }
      });
      checkAwakenings();
      checkAchievements();
    },150);
  }
}
// ================================================================
// DAILY QUESTS SYSTEM
// ================================================================
const DEFAULT_QUESTS = [
  {id:'dq_record',name:'„Å®„Çä„ÅÇ„Åà„ÅöË®òÈå≤„Åó„Å¶„Åø„Çã',xp:15},
  {id:'dq_editquest',name:'„Éá„Ç§„É™„Éº„ÇØ„Ç®„Çπ„Éà„ÇíÁ∑®ÈõÜ„Åó„Å¶„Åø„Çã',xp:10},
];

function getQuests(){return ls_get('daily_quests')||DEFAULT_QUESTS;}
function setQuests(v){ls_set('daily_quests',v);}
function getQuestChecks(date){return ls_get('dq_checks_'+date)||[];}
function setQuestChecks(date,v){ls_set('dq_checks_'+date,v);}

function toggleQuest(qId){
  var checks=getQuestChecks(currentDate);
  var idx=checks.indexOf(qId);
  if(idx>=0){
    checks.splice(idx,1);
    // Remove XP? No, keep it simple - just toggle display
  } else {
    checks.push(qId);
    var q=getQuests().find(function(x){return x.id===qId;});
    if(q){
      addXPRaw(q.xp);
      toast('‚úÖ '+q.name+' +'+q.xp+'XP');
      spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'+'+q.xp+'XP');
    }
  }
  setQuestChecks(currentDate,checks);
  renderDailyQuests();
  updateNav();
}

function renderDailyQuests(){
  var quests=getQuests();
  var checks=getQuestChecks(currentDate);
  var el=document.getElementById('dqList');
  if(!el)return;
  document.getElementById('dqDate').textContent=formatDate(currentDate);
  el.innerHTML=quests.map(function(q){
    var done=checks.includes(q.id);
    return '<div class="dq-item'+(done?' done':'')+'" onclick="'+(done?'':'toggleQuest(\''+q.id+'\')')+'">'+ 
      '<div class="dq-check">'+(done?'‚úì':'')+'</div>'+
      '<div class="dq-label">'+q.name+'</div>'+
      '<div class="dq-xp">'+(done?'‚úì':'+')+q.xp+' XP</div>'+
    '</div>';
  }).join('');
  var done=checks.length;
  var total=quests.length;
  document.getElementById('dqProg').textContent=done+'/'+total;
  var pct=total>0?Math.round(done/total*100):0;
  document.getElementById('dqProgBar').style.width=pct+'%';
  // All-clear bonus
  var bonusEl=document.getElementById('dqBonus');
  if(done>=total&&total>0){
    bonusEl.textContent='üéâ ÂÖ®„ÇØ„É™„Ç¢ÔºÅ';
    bonusEl.style.color='var(--amber)';
  } else {
    bonusEl.textContent='„ÅÇ„Å®'+(total-done)+'ÂÄã';
    bonusEl.style.color='var(--muted2)';
  }
}

function openQuestEditor(){
  document.getElementById('questModal').classList.add('show');
  renderQuestEditor();
}

function renderQuestEditor(){
  var quests=getQuests();
  document.getElementById('questEditorList').innerHTML=quests.map(function(q,i){
    return '<div style="display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--s2);border:1px solid var(--border);border-radius:6px;">'+
      '<span style="flex:1;font-size:.72rem;">'+q.name+'</span>'+
      '<span style="font-size:.62rem;color:var(--green);font-family:JetBrains Mono,monospace;">+'+q.xp+'XP</span>'+
      '<button class="bdel" onclick="removeQuest('+i+')">√ó</button>'+
    '</div>';
  }).join('');
}

function addQuest(){
  var name=document.getElementById('newQuestName').value.trim();
  var xp=parseInt(document.getElementById('newQuestXP').value)||10;
  if(!name){toast('ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  var quests=getQuests();
  quests.push({id:'dq_'+Date.now(),name:name,xp:xp});
  setQuests(quests);
  document.getElementById('newQuestName').value='';
  renderQuestEditor();
  renderDailyQuests();
  toast('‚úÖ „Äå'+name+'„Äç„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
}

function removeQuest(idx){
  var quests=getQuests();
  quests.splice(idx,1);
  setQuests(quests);
  renderQuestEditor();
  renderDailyQuests();
}

// ================================================================
// PERFORMANCE COMPARISON + RANKING
// ================================================================
function renderPerformance(){
  var card=document.getElementById('perfCard');
  if(!card)return;

  var today=currentDate;
  var yesterday=addDays(today,-1);
  var todayData=getDayData(today);
  var ydData=getDayData(yesterday);

  var todayEffort=getEffortMins(todayData.blocks);
  var ydEffort=getEffortMins(ydData.blocks);
  var todaySleep=todayData.sleepScore||0;
  var ydSleep=ydData.sleepScore||0;

  // Only show if there's yesterday data
  if(ydData.blocks.length===0&&!ydData.sleepScore){
    card.style.display='none';
    return;
  }
  card.style.display='block';

  // Effort display
  document.getElementById('perf_effort').textContent=m2hm(todayEffort);
  if(ydEffort>0){
    var eDelta=todayEffort-ydEffort;
    var ePct=Math.round(eDelta/ydEffort*100);
    var eColor=eDelta>0?'var(--green)':eDelta<0?'var(--rose)':'var(--muted)';
    var eArrow=eDelta>0?'‚ñ≤':eDelta<0?'‚ñº':'‚Üí';
    document.getElementById('perf_effort_delta').innerHTML='<span style="color:'+eColor+';">'+eArrow+(eDelta>0?'+':'')+ePct+'% (ÂâçÊó• '+m2hm(ydEffort)+')</span>';
  } else {
    document.getElementById('perf_effort_delta').innerHTML='<span style="color:var(--muted);">ÂâçÊó•„Éá„Éº„Çø„Å™„Åó</span>';
  }

  // Sleep display
  document.getElementById('perf_sleep').textContent=todaySleep?todaySleep+'ÁÇπ':'--';
  if(ydSleep>0&&todaySleep>0){
    var sDelta=todaySleep-ydSleep;
    var sColor=sDelta>0?'var(--green)':sDelta<0?'var(--rose)':'var(--muted)';
    var sArrow=sDelta>0?'‚ñ≤':sDelta<0?'‚ñº':'‚Üí';
    document.getElementById('perf_sleep_delta').innerHTML='<span style="color:'+sColor+';">'+sArrow+(sDelta>0?'+':'')+sDelta+'ÁÇπ (ÂâçÊó• '+ydSleep+'ÁÇπ)</span>';
  } else {
    document.getElementById('perf_sleep_delta').innerHTML='<span style="color:var(--muted);">'+(todaySleep?'ÂâçÊó•„Çπ„Ç≥„Ç¢„Å™„Åó':'Êú™Ë®òÈå≤')+'</span>';
  }

  // Performance ranking over past 10 days
  var rankEl=document.getElementById('perfRank');
  // We rank YESTERDAY's performance (completed day)
  if(ydData.blocks.length===0){
    rankEl.innerHTML='';
    return;
  }

  var dates=[];
  for(var i=1;i<=10;i++){
    var d=addDays(today,-i);
    var dd=getDayData(d);
    if(dd.blocks.length>0){
      var eff=getEffortMins(dd.blocks);
      var sl=dd.sleepScore||0;
      // Composite score: effort minutes + sleep score * 3
      var score=eff+sl*3;
      dates.push({date:d,effort:eff,sleep:sl,score:score});
    }
  }

  if(dates.length<2){
    rankEl.innerHTML='<span style="color:var(--muted2);font-size:.65rem;">„É©„É≥„Ç≠„É≥„Ç∞„Å´„ÅØ2Êó•‰ª•‰∏ä„ÅÆ„Éá„Éº„Çø„ÅåÂøÖË¶Å„Åß„Åô</span>';
    return;
  }

  // Sort by score descending
  dates.sort(function(a,b){return b.score-a.score;});
  var ydRank=-1;
  for(var j=0;j<dates.length;j++){
    if(dates[j].date===yesterday){ydRank=j+1;break;}
  }

  if(ydRank<0){
    rankEl.innerHTML='';
    return;
  }

  var total=dates.length;
  var rankColor=ydRank<=1?'var(--amber)':ydRank<=3?'var(--green)':ydRank<=Math.ceil(total/2)?'var(--cyan)':'var(--rose)';
  var msgs=['','ü•á Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅÊúÄÈ´ò„ÅÆ„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Åß„Åó„ÅüÔºÅ','ü•à ÈùûÂ∏∏„Å´ÂÑ™ÁßÄÔºÅ„Éà„ÉÉ„Éó„ÇØ„É©„Çπ„ÅÆ1Êó•„Åß„Åó„Åü„ÄÇ','ü•â ËâØ„ÅÑË™øÂ≠êÔºÅ„Åì„ÅÆÂã¢„ÅÑ„ÇíÁ∂≠ÊåÅ„Åó„Çà„ÅÜ„ÄÇ'];
  var rankMsg='';
  if(ydRank===1) rankMsg=msgs[1];
  else if(ydRank===2) rankMsg=msgs[2];
  else if(ydRank===3) rankMsg=msgs[3];
  else if(ydRank<=Math.ceil(total/2)) rankMsg='üëç Âπ≥Âùá‰ª•‰∏äÔºÅ„ÇÇ„ÅÜÂ∞ë„Åó„Åß‰∏ä‰Ωç„Å´ÂÖ•„Çå„Åæ„Åô„ÄÇ';
  else rankMsg='üî• Êò®Êó•„ÅØÊåØ„Çã„Çè„Å™„Åã„Å£„Åü‚Ä¶ ‰ªäÊó•„Åì„ÅùÂ∑ª„ÅçËøî„Åù„ÅÜÔºÅ';

  rankEl.innerHTML='Êò®Êó•„ÅÆ„Çπ„Ç≥„Ç¢„ÅØÈÅéÂéª'+total+'Êó•Èñì„Åß<br>'+
    '<span class="perf-rank-num" style="color:'+rankColor+';">'+ydRank+'‰Ωç</span> / '+total+'Êó•‰∏≠<br>'+
    '<span style="font-size:.68rem;">'+rankMsg+'</span>';
}

// ================================================================
// INIT
// ================================================================
renderP1();
updateNav();
setTimeout(()=>{
  initStockPrices();
  tickStockPrices();
  migrateOldInvestments();
  initDebt();
  updateDebtUI();
  if(getEventLog().length===0){
    addEventLog('üå± „Çø„Ç§„É†„Éï„É≠„Éº„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅÊôÇÈñì„ÇíË®òÈå≤„Åó„Å¶„Çπ„Ç≠„É´„ÇíËÇ≤„Å¶„ÄÅÊôÇÁµ¶„Çí‰∏ä„Åí„Çà„ÅÜ','levelup');
    addEventLog('üí° „Éí„É≥„Éà: „Çπ„Ç≠„É´Lv„Åå‰∏ä„Åå„Çã„Åü„Å≥„Å´ÊôÇÁµ¶„ÅåÂ∞ë„Åó„Åö„Å§‰∏ä„Åå„Çä„Åæ„ÅôÔºà+4%/LvÔºâ','money');
  }
  // init prev_lv tracking
  DOMAINS.forEach(d=>d.skills.forEach(s=>{
    if(!ls_get('prev_lv_'+s.id)) ls_set('prev_lv_'+s.id, getSkillLevel(s));
  }));
  checkAwakenings();
  updatePachinkoDisplay();
  renderMysteryCollection();
},500);
// ================================================================
// HELP
// ================================================================
function confirmReset(){executeReset();}
function showResetConfirm(){
  document.getElementById('resetBtn1').style.display='none';
  var el=document.getElementById('resetConfirmArea');
  el.style.display='block';
  el.innerHTML=
    '<div style="background:rgba(239,68,68,.08);border:2px solid rgba(239,68,68,.4);border-radius:12px;padding:16px;">'+
      '<div style="font-size:.85rem;font-weight:800;color:#fb7185;margin-bottom:8px;">‚ö†Ô∏è Êú¨ÂΩì„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü</div>'+
      '<div style="font-size:.68rem;color:var(--muted);line-height:1.6;margin-bottom:12px;">„Åô„Åπ„Å¶„ÅÆË®òÈå≤„Éª„Çπ„Ç≠„É´„Éª„Ç¥„Éº„É´„Éâ„ÉªÂÆüÁ∏æ„ÉªÊäïË≥á„ÉªÂª∫Áâ©„ÅåÊ∂à„Åà„Åæ„Åô„ÄÇ<br>„Åì„ÅÆÊìç‰Ωú„ÅØ<span style="color:#fb7185;font-weight:700;">Âèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì</span>„ÄÇ</div>'+
      '<div style="display:flex;gap:6px;">'+
        '<button onclick="showResetFinal()" style="flex:1;padding:10px;border:2px solid #ef4444;border-radius:8px;background:rgba(239,68,68,.2);color:#fb7185;font-size:.8rem;font-weight:800;cursor:pointer;">„ÅØ„ÅÑ„ÄÅ„É™„Çª„ÉÉ„Éà„Åô„Çã</button>'+
        '<button onclick="cancelReset()" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--text);font-size:.75rem;cursor:pointer;">„Ç≠„É£„É≥„Çª„É´</button>'+
      '</div>'+
    '</div>';
}
function showResetFinal(){
  var el=document.getElementById('resetConfirmArea');
  el.innerHTML=
    '<div style="background:rgba(239,68,68,.12);border:2px solid #ef4444;border-radius:12px;padding:16px;">'+
      '<div style="font-size:1rem;font-weight:900;color:#ef4444;margin-bottom:8px;text-align:center;">‚ö†Ô∏è ÊúÄÁµÇÁ¢∫Ë™ç</div>'+
      '<div style="font-size:.72rem;color:#fb7185;text-align:center;margin-bottom:12px;">‰∏ã„ÅÆ„Éú„Çø„É≥„ÇíÊäº„Åô„Å®ÂÖ®„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô</div>'+
      '<div style="display:flex;gap:6px;">'+
        '<button onclick="executeReset()" style="flex:1;padding:12px;border:none;border-radius:8px;background:#ef4444;color:#fff;font-size:.85rem;font-weight:900;cursor:pointer;">üóë ÂÆåÂÖ®„Å´ÂâäÈô§„Åô„Çã</button>'+
        '<button onclick="cancelReset()" style="flex:1;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--text);font-size:.75rem;cursor:pointer;">„ÇÑ„ÇÅ„Çã</button>'+
      '</div>'+
    '</div>';
}
function cancelReset(){
  document.getElementById('resetConfirmArea').style.display='none';
  document.getElementById('resetBtn1').style.display='';
}
function executeReset(){
  var keys=[];
  for(var i=0;i<localStorage.length;i++){
    var k=localStorage.key(i);
    if(k&&k.startsWith('tf3_'))keys.push(k);
  }
  keys.forEach(function(k){localStorage.removeItem(k);});
  location.reload();
}

// ================================================================
// REBIRTH (Ëª¢Áîü) ‚Äî TIME LEGACY SYSTEM
// ================================================================
function getRebirthCount(){return ls_get('rebirth_count')||0;}
function setRebirthCount(v){ls_set('rebirth_count',v);}
function getRebirthWageMulti(){return 1+getRebirthCount()*0.5;} // 1x, 1.5x, 2x, 2.5x...
function getRebirthXPMulti(){return 1+getRebirthCount()*0.1;} // 1x, 1.1x, 1.2x...
function getRebirthTitles(){
  var titles=[
    {count:1,name:'Ëª¢ÁîüËÄÖ',icon:'üîÑ',color:'#60a5fa'},
    {count:2,name:'Ëº™Âªª„ÅÆÊóÖ‰∫∫',icon:'üåÄ',color:'#818cf8'},
    {count:3,name:'ÊôÇ„ÅÆÊîØÈÖçËÄÖ',icon:'‚è≥',color:'#a78bfa'},
    {count:5,name:'Ê∞∏Âä´ÂõûÂ∏∞',icon:'‚ôæÔ∏è',color:'#c084fc'},
    {count:7,name:'Ë∂ÖË∂äËÄÖ',icon:'üåå',color:'#e879f9'},
    {count:10,name:'Á•û',icon:'üëÅÔ∏è',color:'#fcd34d'},
  ];
  var c=getRebirthCount();
  return titles.filter(function(t){return c>=t.count;});
}
function getHighestRebirthTitle(){
  var titles=getRebirthTitles();
  return titles.length>0?titles[titles.length-1]:null;
}

function canRebirth(){
  var hasCastle=getCurrentHousing()>=8;
  var hasEmpire=getBizCount('biz_empire')>=1;
  var dayCount=getAllDates().filter(function(d){return getDayData(d).blocks.length>0;}).length;
  var hasDays=dayCount>=30;
  var allBld=BUILDINGS.every(function(b){return getOwnedBuildings().includes(b.id);});
  var maxHousing=getCurrentHousing()>=HOUSING.length-1;
  var allInt=INTERIOR.filter(function(i){return !i.gachaOnly;}).every(function(i){return getOwnedInterior().includes(i.id);});
  var allRE=REAL_ESTATE.every(function(r){return getRECount(r.id)>=1;});
  var allBiz=BUSINESSES.every(function(b){return getBizCount(b.id)>=1;});
  return hasCastle&&hasEmpire&&hasDays&&allBld&&maxHousing&&allInt&&allRE&&allBiz;
}

function getRebirthConditions(){
  var hasCastle=getCurrentHousing()>=8;
  var hasEmpire=getBizCount('biz_empire')>=1;
  var dayCount=getAllDates().filter(function(d){return getDayData(d).blocks.length>0;}).length;
  var ownedBld=getOwnedBuildings();
  var allBld=BUILDINGS.every(function(b){return ownedBld.includes(b.id);});
  var maxHousing=getCurrentHousing()>=HOUSING.length-1;
  var ownedInt=getOwnedInterior();
  var buyableInt=INTERIOR.filter(function(i){return !i.gachaOnly;});
  var allInt=buyableInt.every(function(i){return ownedInt.includes(i.id);});
  var allRE=REAL_ESTATE.every(function(r){return getRECount(r.id)>=1;});
  var allBiz=BUSINESSES.every(function(b){return getBizCount(b.id)>=1;});
  return [
    {name:'‰ΩèÂ±Ö„ÇíÊúÄÂ§ß„É¨„Éô„É´Ôºà'+HOUSING[HOUSING.length-1].name+'Ôºâ„Åæ„ÅßÂº∑Âåñ',met:maxHousing},
    {name:'ÂÖ®Âª∫Áâ©„ÇíÂª∫Ë®≠Ôºà'+ownedBld.length+'/'+BUILDINGS.length+'Ôºâ',met:allBld},
    {name:'ÂÖ®Ë≥ºÂÖ•ÂèØËÉΩ„Ç§„É≥„ÉÜ„É™„Ç¢Ôºà'+buyableInt.filter(function(i){return ownedInt.includes(i.id);}).length+'/'+buyableInt.length+'Ôºâ',met:allInt},
    {name:'ÂÖ®‰∏çÂãïÁî£„ÇíÂêÑ1‰ª∂‰ª•‰∏ä‰øùÊúâÔºà'+REAL_ESTATE.filter(function(r){return getRECount(r.id)>=1;}).length+'/'+REAL_ESTATE.length+'Ôºâ',met:allRE},
    {name:'ÂÖ®‰∫ãÊ•≠„ÇíÂêÑ1Á§æ‰ª•‰∏äË®≠Á´ãÔºà'+BUSINESSES.filter(function(b){return getBizCount(b.id)>=1;}).length+'/'+BUSINESSES.length+'Ôºâ',met:allBiz},
    {name:'Â∏ùÂõΩ„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„Çπ‰øùÊúâ',met:hasEmpire},
    {name:'Ë®òÈå≤Êó•Êï∞30Êó•‰ª•‰∏äÔºàÁèæÂú®'+dayCount+'Êó•Ôºâ',met:dayCount>=30},
  ];
}

function doRebirth(){
  if(!canRebirth()){toast('Ëª¢ÁîüÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì','err');return;}
  if(!confirm('‚è≥ ÊôÇ„ÅÆÈÅ∫Áî£ ‚Äî Ëª¢Áîü„ÇíË°å„ÅÑ„Åæ„Åô„ÅãÔºü\n\nÂºï„ÅçÁ∂ô„Åé: Ê†™Âºè„Éù„Éº„Éà„Éï„Ç©„É™„Ç™„ÉªÂ∏ùÂõΩHD(+ÊäïË≥áÈ°ç)„ÉªÂÖ®Ë®òÈå≤„Éá„Éº„Çø„ÉªËª¢Áîü„Éú„Éº„Éä„Çπ\n„É™„Çª„ÉÉ„Éà: „Ç¥„Éº„É´„Éâ„Éª„Çπ„Ç≠„É´„ÉªÂª∫Áâ©„Éª‰∏çÂãïÁî£„Éª‰ªñ‰∫ãÊ•≠„Éª‰ΩèÂ±Ö„Éª„Ç§„É≥„ÉÜ„É™„Ç¢„ÉªÂÆüÁ∏æ'))return;
  if(!confirm('Êú¨ÂΩì„Å´Ëª¢Áîü„Åó„Åæ„Åô„ÅãÔºü\nÊ¨°„ÅÆÂë®Âõû„Åß„ÅØÊôÇÁµ¶ √ó'+(1+(getRebirthCount()+1)*0.5).toFixed(1)+' „Åß„Çπ„Çø„Éº„Éà„Åó„Åæ„Åô„ÄÇ'))return;

  // Save persistent data
  var rebirthN=getRebirthCount()+1;
  var portfolio=getPortfolio(); // stocks survive
  var empireHoldings=getBizHoldings().filter(function(h){return h.id==='biz_empire';}); // only empire survives
  var empireInvest=getEmpireInvestment(); // extra investment survives
  var allDayKeys=[];
  for(var i=0;i<localStorage.length;i++){
    var k=localStorage.key(i);
    if(k&&k.startsWith('tf3_d_'))allDayKeys.push(k);
  }
  var dayData={};
  allDayKeys.forEach(function(k){try{dayData[k]=localStorage.getItem(k);}catch{}});
  var mystColl=getMysteryCollection(); // gacha collection too
  var quickTpl=getQuickTemplates();
  var sleepIdeals=getSleepIdeals();
  var quests=ls_get('daily_quests');

  // Wipe everything
  var keys=[];
  for(var i=0;i<localStorage.length;i++){
    var k=localStorage.key(i);
    if(k&&k.startsWith('tf3_'))keys.push(k);
  }
  keys.forEach(function(k){localStorage.removeItem(k);});

  // Restore persistent data
  setRebirthCount(rebirthN);
  setPortfolio(portfolio);
  setBizHoldings(empireHoldings);
  setEmpireInvestment(empireInvest);
  Object.keys(dayData).forEach(function(k){try{localStorage.setItem(k,dayData[k]);}catch{}});
  setMysteryCollection(mystColl);
  setQuickTemplates(quickTpl);
  setSleepIdeals(sleepIdeals);
  if(quests)ls_set('daily_quests',quests);

  // Starting bonus gold based on rebirth count
  var startGold=rebirthN*1000;
  ls_set('gold',startGold);

  addEventLog('‚è≥ Á¨¨'+rebirthN+'ÂõûËª¢ÁîüÔºÅ ÊôÇÁµ¶√ó'+(1+rebirthN*0.5).toFixed(1)+' „ÅßÊñ∞„Åü„Å™ÊóÖ„ÅåÂßã„Åæ„Çã','awakening');

  location.reload();
}

// ================================================================
// EMPIRE HOLDINGS EXTRA INVESTMENT
// ================================================================
function getEmpireInvestment(){return ls_get('empire_invest')||0;}
function setEmpireInvestment(v){ls_set('empire_invest',v);}
function getEmpireDailyBonus(){
  // Each 100,000G invested adds +500G/day, diminishing returns (sqrt scaling)
  var inv=getEmpireInvestment();
  if(inv<=0)return 0;
  return Math.round(500*Math.sqrt(inv/100000));
}

function investInEmpire(){
  if(getBizCount('biz_empire')===0){toast('Â∏ùÂõΩ„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„Çπ„ÇíË®≠Á´ã„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  var amounts=[100000,500000,1000000];
  var amtStr=prompt('Â∏ùÂõΩ„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„Çπ„Å´ËøΩÂä†ÊäïË≥á\nÁèæÂú®„ÅÆËøΩÂä†ÊäïË≥áÈ°ç: '+getEmpireInvestment().toLocaleString()+'G\nÁèæÂú®„ÅÆËøΩÂä†„É™„Çø„Éº„É≥: +'+getEmpireDailyBonus().toLocaleString()+' G/Êó•\n\nÊäïË≥áÈ°ç„ÇíÂÖ•ÂäõÔºàÊúÄ‰Ωé10,000GÔºâ:','100000');
  if(!amtStr)return;
  var amt=parseInt(amtStr.replace(/,/g,''));
  if(isNaN(amt)||amt<10000){toast('10,000G‰ª•‰∏ä„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  if(getGold()<amt){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„Çì','err');return;}
  setGold(getGold()-amt);
  var prev=getEmpireInvestment();
  setEmpireInvestment(prev+amt);
  var newBonus=getEmpireDailyBonus();
  addEventLog('üëë Â∏ùÂõΩHD„Å´'+amt.toLocaleString()+'GËøΩÂä†ÊäïË≥áÔºàÁ¥ØË®à'+((prev+amt)/1000).toFixed(0)+'K ‚Üí +'+newBonus.toLocaleString()+' G/Êó•Ôºâ','money');
  toast('üëë ËøΩÂä†ÊäïË≥áÂÆå‰∫ÜÔºÅ „É™„Çø„Éº„É≥ +'+newBonus.toLocaleString()+' G/Êó•');
  updateNav();renderEconomy();renderInvestments();
}
function openHelp(){document.getElementById('helpOverlay').classList.add('show');updateIdealDisplay();}

function showEconomySim(){
  // Calculate total cost of everything
  var bldCost=BUILDINGS.reduce(function(s,b){return s+b.cost;},0);
  var housingCost=HOUSING.reduce(function(s,h){return s+h.cost;},0);
  var intCost=INTERIOR.filter(function(i){return !i.gachaOnly;}).reduce(function(s,i){return s+i.cost;},0);
  var stkCost=STOCKS.reduce(function(s,st){return s+st.basePrice;},0); // 1 share each
  var reCost=REAL_ESTATE.reduce(function(s,r){return s+r.cost;},0);
  var bizCost=BUSINESSES.reduce(function(s,b){return s+b.cost;},0);
  var totalCost=bldCost+housingCost+intCost+stkCost+reCost+bizCost;

  // Max wage with max town bonus
  var maxWage=WAGE_TIERS[WAGE_TIERS.length-1].wage;
  var maxTownBonus=TOWN_RANKS[TOWN_RANKS.length-1].wageBonus;
  var effectiveWage=Math.round(maxWage*(1+maxTownBonus));

  var hoursNeeded=Math.ceil(totalCost/effectiveWage);
  var daysAt8h=Math.ceil(hoursNeeded/8);
  var daysAt4h=Math.ceil(hoursNeeded/4);

  var el=document.getElementById('econSimResult');
  el.innerHTML='<div style="color:var(--cyan);font-weight:700;font-size:.78rem;margin-bottom:6px;">üìä ÂÖ®„Ç≥„É≥„ÉÜ„É≥„ÉÑÂÆå‰∫Ü„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥</div>'+
    '<div style="border-bottom:1px solid var(--border);padding-bottom:6px;margin-bottom:6px;">'+
    'üèóÔ∏è Âª∫Áâ©ÂÖ®Á®Æ: <span style="color:#4ade80;">'+bldCost.toLocaleString()+' G</span><br>'+
    'üè† ‰ΩèÂ±ÖÂÖ®ÊÆµÈöé: <span style="color:#4ade80;">'+housingCost.toLocaleString()+' G</span><br>'+
    'ü™ë „Ç§„É≥„ÉÜ„É™„Ç¢(Ë≥ºÂÖ•ÂèØËÉΩ): <span style="color:#4ade80;">'+intCost.toLocaleString()+' G</span><br>'+
    'üìä Ê†™Âºè(ÂêÑ1Âè£): <span style="color:#4ade80;">'+stkCost.toLocaleString()+' G</span><br>'+
    'üè¢ ‰∏çÂãïÁî£ÂÖ®Á®Æ: <span style="color:#4ade80;">'+reCost.toLocaleString()+' G</span><br>'+
    'üè≠ ‰∫ãÊ•≠ÂÖ®Á®Æ: <span style="color:#4ade80;">'+bizCost.toLocaleString()+' G</span><br>'+
    '</div>'+
    '<div style="font-size:.82rem;font-weight:800;color:#fbbf24;margin-bottom:4px;">üíé Á∑èÈ°ç: '+totalCost.toLocaleString()+' G</div>'+
    '<div style="border-top:1px solid var(--border);padding-top:6px;margin-top:6px;">'+
    '‚ö° ÊúÄÈ´òÊôÇÁµ¶: '+effectiveWage.toLocaleString()+' G/h <span style="color:var(--muted);">('+maxWage+' √ó '+(1+maxTownBonus)+')</span><br>'+
    '‚è±Ô∏è ÂøÖË¶ÅÊôÇÈñì: <span style="color:var(--cyan);font-weight:700;">'+hoursNeeded.toLocaleString()+'ÊôÇÈñì</span><br>'+
    'üìÖ 8h/Êó•ÊèõÈáë: <span style="color:var(--amber);font-weight:700;">Á¥Ñ'+daysAt8h.toLocaleString()+'Êó•</span> ('+Math.round(daysAt8h/30)+'„É∂Êúà)<br>'+
    'üìÖ 4h/Êó•ÊèõÈáë: <span style="color:var(--rose);font-weight:700;">Á¥Ñ'+daysAt4h.toLocaleString()+'Êó•</span> ('+Math.round(daysAt4h/30)+'„É∂Êúà)<br>'+
    '</div>'+
    '<div style="font-size:.58rem;color:var(--muted);margin-top:6px;">‚Äª „Ç¨„ÉÅ„É£Ë≤ªÁî®„ÉªÁîüÊ¥ª„Ç≥„Çπ„Éà„Éª‰∏çÂä¥ÊâÄÂæó„ÅØÂê´„Åæ„Åö</div>';
}
function closeHelp(){document.getElementById('helpOverlay').classList.remove('show');}

// ================================================================
// PAGE 3 SUB-TABS
// ================================================================
function setP3Tab(tab){
  curP3Tab=tab;
  ['skills','invest','life','town','slot','ach'].forEach(t=>{
    const btn=document.getElementById('p3t_'+t);
    const panel=document.getElementById('panel_'+t);
    if(btn)btn.classList.toggle('active',t===tab);
    if(panel)panel.classList.toggle('active',t===tab);
  });
  if(tab==='invest')renderInvestments();
  if(tab==='life')renderLifestyle();
  if(tab==='town'){renderTownVis();renderBldShop();renderTownRank();}
  if(tab==='ach')renderAchievements();
  updateDebtUI();
}

function updateDebtUI(){
  var locked=hasDebtSystem()&&!isDebtPaid();
  // Locked panels get overlay
  ['invest','town'].forEach(function(id){
    var panel=document.getElementById('panel_'+id);
    if(!panel)return;
    var overlay=panel.querySelector('.debt-lock-overlay');
    if(locked){
      panel.style.position='relative';
      if(!overlay){
        overlay=document.createElement('div');
        overlay.className='debt-lock-overlay';
        overlay.innerHTML='<div style="background:rgba(0,0,0,0.7);border:1px solid rgba(251,191,36,.3);border-radius:12px;padding:16px 24px;text-align:center;backdrop-filter:blur(2px);">'+
          '<div style="font-size:1.5rem;margin-bottom:6px;">üîí</div>'+
          '<div style="font-size:.8rem;font-weight:700;color:#fbbf24;">„É≠„Éº„É≥„ÇíËøîÊ∏à„Åô„Çã„Å®Ëß£Á¶Å</div>'+
          '<div style="font-size:.65rem;color:var(--muted);margin-top:4px;">ÊÆã„Çä: <span id="debtLockAmt_'+id+'">0</span>G</div>'+
        '</div>';
        panel.appendChild(overlay);
      }
      var amtEl=document.getElementById('debtLockAmt_'+id);
      if(amtEl)amtEl.textContent=getDebt().toLocaleString();
    } else {
      if(overlay)overlay.remove();
    }
  });
  // Tab buttons subtle lock icon
  var investBtn=document.getElementById('p3t_invest');
  var townBtn=document.getElementById('p3t_town');
  if(investBtn)investBtn.style.opacity=locked?'0.6':'1';
  if(townBtn)townBtn.style.opacity=locked?'0.6':'1';
}

// ================================================================
// SLEEP XP MODIFIER
// ================================================================
function getSleepXPMultiplier(){
  const today=todayStr();
  const dd=getDayData(today);
  const score=dd.sleepScore;
  if(score===null||score===undefined)return 1.0;
  if(score>=90)return 1.5;
  if(score>=75)return 1.25;
  if(score>=60)return 1.0;
  if(score>=40)return 0.8;
  return 0.6;
}

function updateSleepXPBadge(){
  const mult=getSleepXPMultiplier();
  const el=document.getElementById('sleepXPBadge');
  if(!el)return;
  el.textContent='√ó'+mult.toFixed(2);
  const cls='sleep-xp-badge ';
  if(mult>=1.5)el.className=cls+'excellent';
  else if(mult>=1.25)el.className=cls+'good';
  else if(mult>=1.0)el.className=cls+'normal';
  else if(mult>=0.8)el.className=cls+'poor';
  else el.className=cls+'bad';
}

// Override addXP to apply sleep multiplier
const _origAddXP = addXP;
addXP = function(amount, blockEl){
  const mult = getSleepXPMultiplier();
  const adjusted = Math.round(amount * mult);
  _origAddXP(adjusted, blockEl);
  if(mult!==1.0 && blockEl){
    const tag = mult>1 ? 'üòä' : 'üò¥';
    toast(tag+' Áù°Áú†ÂÄçÁéá √ó'+mult.toFixed(2)+' ‚Üí '+adjusted+' XP');
  }
};

// ================================================================
// INVESTMENT SYSTEM
// ================================================================
const STOCKS = [
  {id:'stk_idx',name:'S&P500„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ',icon:'üìä',desc:'Á±≥ÂõΩÂ§ßÂûãÊ†™500Á§æ„Å´ÈÄ£Âãï„ÄÇÈï∑ÊúüÊäïË≥á„ÅÆÁéãÈÅì„ÄÇ',basePrice:5000,volatility:0.015,drift:0.0003,risk:'‰Ωé',req:null},
  {id:'stk_topix',name:'TOPIX„Éï„Ç°„É≥„Éâ',icon:'üóæ',desc:'Êù±Ë®º‰∏äÂ†¥ÈäòÊüÑ„Å´Â∫É„ÅèÂàÜÊï£„ÄÇÂõΩÂÜÖÁµåÊ∏à„Å®ÈÄ£Âãï„ÄÇ',basePrice:3000,volatility:0.012,drift:0.0002,risk:'‰Ωé',req:null},
  {id:'stk_nasdaq',name:'NASDAQ100',icon:'üíª',desc:'„Éè„Ç§„ÉÜ„ÇØÂ§ßÂûãÊ†™„Å´ÈõÜ‰∏≠„ÄÇÊàêÈï∑ÊúüÂæÖÂ§ß„ÄÇ',basePrice:8000,volatility:0.025,drift:0.0005,risk:'‰∏≠',req:{skill:'strategy',lv:2}},
  {id:'stk_emerging',name:'Êñ∞ËààÂõΩÊ†™„Éï„Ç°„É≥„Éâ',icon:'üåç',desc:'BRICS„Å™„Å©Êñ∞ËààÂõΩ„Å´ÊäïË≥á„ÄÇÈ´òÊàêÈï∑„ÉªÈ´ò„É™„Çπ„ÇØ„ÄÇ',basePrice:4000,volatility:0.03,drift:0.0002,risk:'‰∏≠',req:{skill:'strategy',lv:2}},
  {id:'stk_reit',name:'„Ç∞„É≠„Éº„Éê„É´REIT',icon:'üèóÔ∏è',desc:'‰∏ñÁïå„ÅÆ‰∏çÂãïÁî£ÊäïË≥á‰ø°Ë®ó„ÄÇÈÖçÂΩìÂà©Âõû„ÇäÈ´ò„ÇÅ„ÄÇ',basePrice:6000,volatility:0.018,drift:0.0003,risk:'‰∏≠',req:{skill:'depth',lv:2}},
  {id:'stk_crypto',name:'ÊöóÂè∑Ë≥áÁî£„Éï„Ç°„É≥„Éâ',icon:'‚Çø',desc:'BTC/ETH‰∏≠ÂøÉ„ÄÇ„Éè„Ç§„É™„Çπ„ÇØ„Éª„Éè„Ç§„É™„Çø„Éº„É≥„ÄÇ',basePrice:10000,volatility:0.06,drift:0.0004,risk:'È´ò',req:{skill:'depth',lv:2}},
  {id:'stk_leverage',name:'„É¨„Éê„É¨„ÉÉ„Ç∏NASDAQ(3ÂÄç)',icon:'‚ö°',desc:'NASDAQ100„ÅÆ3ÂÄçÂÄ§Âãï„Åç„ÄÇÊö¥ËêΩ„É™„Çπ„ÇØÊ•µÂ§ß„ÄÇ',basePrice:12000,volatility:0.075,drift:0.0006,risk:'Ê•µÈ´ò',req:{skill:'strategy',lv:3}},
  {id:'stk_venture',name:'„Éô„É≥„ÉÅ„É£„Éº„Ç≠„É£„Éî„Çø„É´',icon:'üöÄ',desc:'Êú™‰∏äÂ†¥‰ºÅÊ•≠„Å´Âá∫Ë≥á„ÄÇÂ§ßÂåñ„Åë„ÅãÁ¥ôÂàá„Çå„Åã„ÄÇ',basePrice:25000,volatility:0.16,drift:0.0003,risk:'Ê•µÈ´ò',req:{skill:'strategy',lv:3}},
];

const REAL_ESTATE = [
  {id:'re_apt',name:'„ÉØ„É≥„É´„Éº„É†„Ç¢„Éë„Éº„Éà',icon:'üè†',desc:'ÁØâÂè§1R„ÄÇÂà©Âõû„ÇäÈ´ò„ÇÅ„Å†„ÅåÊ∏õ‰æ°„ÇÇÈÄü„ÅÑ„ÄÇ',cost:5000,monthlyRent:250,depRate:0.003,req:null},
  {id:'re_mansion',name:'„Éû„É≥„Ç∑„Éß„É≥1ÂÆ§',icon:'üè¢',desc:'ÈÉΩÂøÉ„ÅÆ1LDK„ÄÇÂÆâÂÆö„Åó„ÅüÂÆ∂Ë≥ÉÂèéÂÖ•„ÄÇ',cost:15000,monthlyRent:650,depRate:0.002,req:{skill:'output',lv:2}},
  {id:'re_family',name:'„Éï„Ç°„Éü„É™„Éº„Éû„É≥„Ç∑„Éß„É≥',icon:'üèòÔ∏è',desc:'3LDK„ÄÇ„Éï„Ç°„Éü„É™„ÉºÂêë„Åë„ÅßÁ©∫ÂÆ§Áéá‰Ωé„ÇÅ„ÄÇ',cost:30000,monthlyRent:1100,depRate:0.0018,req:{skill:'output',lv:2}},
  {id:'re_bldg',name:'„ÉÜ„Éä„É≥„Éà„Éì„É´',icon:'üè¨',desc:'„ÉÜ„Éä„É≥„ÉàÊï∞Á§æ„ÅåÂÖ•„ÇãÂïÜÊ•≠„Éì„É´„ÄÇ',cost:60000,monthlyRent:2500,depRate:0.0015,req:{skill:'strategy',lv:3}},
  {id:'re_office',name:'„Ç™„Éï„Ç£„Çπ„Éì„É´',icon:'üèôÔ∏è',desc:'ÈÉΩÂøÉ‰∏ÄÁ≠âÂú∞„ÅÆ„Ç™„Éï„Ç£„Çπ„ÄÇÊ≥ï‰∫∫Â•ëÁ¥Ñ„ÅßÂÆâÂÆö„ÄÇ',cost:120000,monthlyRent:4500,depRate:0.0012,req:{skill:'strategy',lv:3}},
  {id:'re_tower',name:'„Çø„ÉØ„Éº„Éû„É≥„Ç∑„Éß„É≥',icon:'üóº',desc:'Ë∂ÖÈ´òÂ±§„Éû„É≥„Ç∑„Éß„É≥„ÄÇ„Éñ„É©„É≥„ÉâÂäõ„ÅßÂÄ§Â¥©„Çå„Åó„Å´„Åè„ÅÑ„ÄÇ',cost:250000,monthlyRent:8000,depRate:0.001,req:{skill:'output',lv:4}},
  {id:'re_resort',name:'„É™„Çæ„Éº„Éà„Éõ„ÉÜ„É´',icon:'üèùÔ∏è',desc:'Ë¶≥ÂÖâÂú∞„ÅÆÈ´òÁ¥ö„Éõ„ÉÜ„É´ÁµåÂñ∂„ÄÇÂ≠£ÁØÄÂ§âÂãï„ÅÇ„Çä„ÄÇ',cost:500000,monthlyRent:15000,depRate:0.0008,req:{skill:'strategy',lv:4}},
];

const BUSINESSES = [
  {id:'biz_stall',name:'Â±ãÂè∞',icon:'üç¢',desc:'Â∞è„Åï„Å™Â±ãÂè∞„ÅßÂïÜÂ£≤ÈñãÂßã„ÄÇ',cost:1500,daily:15,staff:1,req:null},
  {id:'biz_cafe',name:'„Ç´„Éï„ÇßÁµåÂñ∂',icon:'‚òï',desc:'„Åä„Åó„ÇÉ„Çå„Å™„Ç´„Éï„Çß„ÇíÈñãÊ•≠„ÄÇ',cost:5000,daily:40,staff:5,req:null},
  {id:'biz_shop',name:'„Ç™„É≥„É©„Ç§„É≥„Ç∑„Éß„ÉÉ„Éó',icon:'üõí',desc:'EC„Çµ„Ç§„Éà„ÇíÈÅãÂñ∂„ÄÇÂ∞ë‰∫∫Êï∞„ÅßÈ´òÂäπÁéá„ÄÇ',cost:12000,daily:100,staff:8,req:{skill:'output',lv:2}},
  {id:'biz_restaurant',name:'„É¨„Çπ„Éà„É©„É≥„ÉÅ„Çß„Éº„É≥',icon:'üçΩÔ∏è',desc:'3Â∫óËàóÂ±ïÈñã„ÅÆ„É¨„Çπ„Éà„É©„É≥„ÄÇ',cost:25000,daily:200,staff:30,req:{skill:'connect',lv:2}},
  {id:'biz_consul',name:'„Ç≥„É≥„Çµ„É´„ÉÜ„Ç£„É≥„Ç∞„Éï„Ç°„Éº„É†',icon:'üëî',desc:'ÁµåÂñ∂„Ç≥„É≥„Çµ„É´„ÄÇÂ∞ÇÈñÄÁü•Ë≠ò„ÅåÊ≠¶Âô®„ÄÇ',cost:40000,daily:350,staff:50,req:{skill:'connect',lv:3}},
  {id:'biz_factory',name:'Ë£ΩÈÄ†Â∑•Â†¥',icon:'üè≠',desc:'Ëá™Á§æË£ΩÂìÅ„ÇíÈáèÁî£„ÄÇ',cost:60000,daily:500,staff:150,req:{skill:'output',lv:3}},
  {id:'biz_hospital',name:'ÂåªÁôÇÊ≥ï‰∫∫',icon:'üè•',desc:'ÁóÖÈô¢„Ç∞„É´„Éº„Éó„ÇíÁµåÂñ∂„ÄÇ',cost:100000,daily:800,staff:300,req:{skill:'depth',lv:3}},
  {id:'biz_tech',name:'„ÉÜ„ÉÉ„ÇØ‰ºÅÊ•≠',icon:'üñ•Ô∏è',desc:'SaaS‰∫ãÊ•≠„ÇíÂ±ïÈñã„ÄÇIPOË¶ñÈáé„ÄÇ',cost:150000,daily:1200,staff:500,req:{skill:'strategy',lv:4}},
  {id:'biz_bank',name:'ÊäïË≥áÈäÄË°å',icon:'üè¶',desc:'M&A„ÉªË≥áÈáëË™øÈÅî„ÅÆÂ∑®‰∫∫„ÄÇ',cost:300000,daily:2500,staff:2000,req:{skill:'strategy',lv:4}},
  {id:'biz_conglomerate',name:'Á∑èÂêàÂïÜÁ§æ',icon:'üåê',desc:'Ë≥áÊ∫ê„Åã„ÇâIT„Åæ„Åß„ÄÇ‰∏ñÁïå„ÇíÂãï„Åã„Åô„ÄÇ',cost:600000,daily:4000,staff:8000,req:{skill:'self_design',lv:3}},
  {id:'biz_empire',name:'Â∏ùÂõΩ„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„Çπ',icon:'üëë',desc:'ÂÖ®Áî£Ê•≠„ÇíÁµ±Êã¨„Åô„ÇãË≤°Èñ•„ÄÇÂæìÊ•≠Âì°3‰∏á‰∫∫Ë∂Ö„ÄÇ',cost:1500000,daily:12000,staff:30000,req:{skill:'self_design',lv:4}},
];

const LIFESTYLES = [
  {id:'lf_gym',name:'„Ç∏„É†‰ºöÂì°',icon:'üèãÔ∏è',desc:'ÊØéÊó•„ÅÆ„ÉØ„Éº„ÇØ„Ç¢„Ç¶„ÉàÁí∞Â¢É',costPerDay:5,xpBonus:0.05,req:null},
  {id:'lf_coffee',name:'È´òÁ¥ö„Ç≥„Éº„Éí„ÉºÂÆöÊúü‰æø',icon:'‚òï',desc:'ÈõÜ‰∏≠Âäõ„ÇíÈ´ò„ÇÅ„Çã‰∏ÄÊùØ',costPerDay:10,xpBonus:0.05,req:null},
  {id:'lf_office',name:'„Ç≥„ÉØ„Éº„Ç≠„É≥„Ç∞„Çπ„Éö„Éº„Çπ',icon:'üíº',desc:'ÊúÄÈÅ©„Å™‰ΩúÊ•≠Áí∞Â¢É',costPerDay:30,xpBonus:0.1,req:{skill:'focus',lv:2}},
  {id:'lf_coach',name:'„Éë„Éº„ÇΩ„Éä„É´„Ç≥„Éº„ÉÅ',icon:'üßë‚Äçüè´',desc:'Â∞ÇÈñÄÂÆ∂„ÅÆÊåáÂ∞é„ÅßXPÂ§ßÂπÖUP',costPerDay:100,xpBonus:0.2,req:{skill:'self_design',lv:2}},
];

function getOwnedInvestments(){return ls_get('owned_inv')||[];}
function setOwnedInvestments(v){ls_set('owned_inv',v);}
function getActiveLifestyles(){return ls_get('active_ls')||[];}
function setActiveLifestyles(v){ls_set('active_ls',v);}
function getLastCollectDate(){return ls_get('last_collect')||null;}
function setLastCollectDate(v){ls_set('last_collect',v);}
function getPendingPassive(){return ls_get('pending_passive')||0;}
function setPendingPassive(v){ls_set('pending_passive',v);}

function checkSkillReq(req){
  if(!req)return true;
  const skill=null;
  for(const dom of DOMAINS){
    const s=dom.skills.find(sk=>sk.id===req.skill);
    if(s)return getSkillLevel(s)>=req.lv;
  }
  return false;
}

function getSkillNameById(id){
  for(const dom of DOMAINS)for(const s of dom.skills)if(s.id===id)return s.name;
  return id;
}

// ============================================================
// STOCK PRICE SIMULATION (geometric Brownian motion)
// ============================================================
function getStockPrices(){return ls_get('stock_prices')||{};}
function setStockPrices(v){ls_set('stock_prices',v);}
function getStockLastUpdate(){return ls_get('stock_price_date')||null;}
function setStockLastUpdate(v){ls_set('stock_price_date',v);}

function initStockPrices(){
  var prices=getStockPrices();
  var changed=false;
  STOCKS.forEach(function(s){
    if(!prices[s.id]){prices[s.id]=s.basePrice;changed=true;}
  });
  if(changed)setStockPrices(prices);
  if(!getStockLastUpdate())setStockLastUpdate(todayStr());
}

function simulateStockDay(prices){
  var newP={};
  STOCKS.forEach(function(s){
    var p=prices[s.id]||s.basePrice;
    // GBM: dS = mu*S*dt + sigma*S*dW
    var z=(Math.random()+Math.random()+Math.random()+Math.random()+Math.random()+Math.random()-3)/1.73; // approx normal
    var ret=s.drift+s.volatility*z;
    var np=Math.max(Math.round(p*(1+ret)),Math.round(s.basePrice*0.05)); // floor at 5% of base
    newP[s.id]=np;
  });
  return newP;
}

function tickStockPrices(){
  var last=getStockLastUpdate();
  if(!last){setStockLastUpdate(todayStr());return;}
  var today=todayStr();
  if(last===today)return;
  var d1=parseDate(last),d2=parseDate(today);
  var days=Math.max(1,Math.min(30,Math.round((d2-d1)/(1000*60*60*24))));
  var prices=getStockPrices();
  for(var i=0;i<days;i++){prices=simulateStockDay(prices);}
  setStockPrices(prices);
  setStockLastUpdate(today);
}

// ============================================================
// STOCK PORTFOLIO: [{id, buyPrice, quantity}]
// ============================================================
function getPortfolio(){return ls_get('stock_portfolio')||[];}
function setPortfolio(v){ls_set('stock_portfolio',v);}

function getPortfolioCount(stkId){
  return getPortfolio().filter(function(p){return p.id===stkId;}).reduce(function(s,p){return s+p.quantity;},0);
}

// ============================================================
// REAL ESTATE HOLDINGS: [{id, buyPrice, buyDate}]
// ============================================================
function getREHoldings(){return ls_get('re_holdings')||[];}
function setREHoldings(v){ls_set('re_holdings',v);}
function getRECount(reId){return getREHoldings().filter(function(h){return h.id===reId;}).length;}
function getLastRentDate(){return ls_get('last_rent_date')||null;}
function setLastRentDate(v){ls_set('last_rent_date',v);}

function calcREValue(holding){
  var item=REAL_ESTATE.find(function(x){return x.id===holding.id;});
  if(!item)return 0;
  var buyD=parseDate(holding.buyDate||todayStr());
  var now=parseDate(todayStr());
  var days=Math.max(0,Math.round((now-buyD)/(1000*60*60*24)));
  // depreciation: value * (1 - depRate)^days
  var val=Math.round(holding.buyPrice*Math.pow(1-item.depRate,days));
  return Math.max(Math.round(item.cost*0.1),val); // floor at 10% of original cost
}

// ============================================================
// BUSINESS: track owned + staff check against town pop
// ============================================================
function getBizHoldings(){return ls_get('biz_holdings')||[];}
function setBizHoldings(v){ls_set('biz_holdings',v);}
function getBizCount(bizId){return getBizHoldings().filter(function(h){return h.id===bizId;}).length;}
function getTotalStaffUsed(){
  return getBizHoldings().reduce(function(s,h){
    var b=BUSINESSES.find(function(x){return x.id===h.id;});
    return s+(b?b.staff:0);
  },0);
}
function getAvailableStaff(){return Math.max(0,getTownPop()-getTotalStaffUsed());}

// ============================================================
// BUY / SELL functions
// ============================================================
function buyStock(id){
  var stk=STOCKS.find(function(x){return x.id===id;});
  if(!stk)return;
  if(!checkSkillReq(stk.req)){toast('„Çπ„Ç≠„É´Ë¶Å‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì','err');return;}
  var prices=getStockPrices();
  var price=prices[id]||stk.basePrice;
  var fee=Math.round(price*0.01); // 1% purchase fee
  var totalCost=price+fee;
  if(getGold()<totalCost){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: '+totalCost.toLocaleString()+'G = ‰æ°Ê†º'+price.toLocaleString()+'G + ÊâãÊï∞Êñô'+fee.toLocaleString()+'GÔºâ','err');return;}
  setGold(getGold()-totalCost);
  var pf=getPortfolio();
  pf.push({id:id,buyPrice:price,quantity:1});
  setPortfolio(pf);
  var total=getPortfolioCount(id);
  addEventLog('üìà „Äå'+stk.name+'„Äç„Çí'+price.toLocaleString()+'G„ÅßË≥ºÂÖ•ÔºàÊâãÊï∞Êñô'+fee.toLocaleString()+'GÔºâË®à'+total+'Âè£','money');
  toast('üìà '+stk.name+' „ÇíË≥ºÂÖ•ÔºÅÔºàÊâãÊï∞Êñô1%: '+fee.toLocaleString()+'GÔºâ');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üìà Ë≥ºÂÖ•ÔºÅ');
  updateNav();renderInvestments();renderEconomy();
}

function sellStock(id){
  var stk=STOCKS.find(function(x){return x.id===id;});
  if(!stk)return;
  var pf=getPortfolio();
  var idx=-1;
  for(var i=0;i<pf.length;i++){if(pf[i].id===id){idx=i;break;}}
  if(idx<0){toast('‰øùÊúâ„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì','err');return;}
  var prices=getStockPrices();
  var price=prices[id]||stk.basePrice;
  var buyP=pf[idx].buyPrice;
  var pnl=price-buyP;
  pf.splice(idx,1);
  setPortfolio(pf);
  setGold(getGold()+price);
  setTotalEarned(getTotalEarned()+Math.max(0,price));
  var pnlStr=pnl>=0?'+'+pnl.toLocaleString():pnl.toLocaleString();
  addEventLog('üí∞ „Äå'+stk.name+'„Äç„Çí'+price.toLocaleString()+'G„ÅßÂ£≤Âç¥ (ÊêçÁõä:'+pnlStr+'G)','money');
  toast('üí∞ '+stk.name+' Â£≤Âç¥ÔºÅ ÊêçÁõä: '+pnlStr+'G');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üí∞ '+pnlStr+'G');
  updateNav();renderInvestments();renderEconomy();
}

function buyRE(id){
  var item=REAL_ESTATE.find(function(x){return x.id===id;});
  if(!item)return;
  if(!checkSkillReq(item.req)){toast('„Çπ„Ç≠„É´Ë¶Å‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì','err');return;}
  if(getGold()<item.cost){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: '+item.cost.toLocaleString()+'GÔºâ','err');return;}
  setGold(getGold()-item.cost);
  var h=getREHoldings();
  h.push({id:id,buyPrice:item.cost,buyDate:todayStr()});
  setREHoldings(h);
  addEventLog('üè† „Äå'+item.name+'„Äç„Çí'+item.cost.toLocaleString()+'G„ÅßË≥ºÂÖ•','money');
  toast('üè† '+item.name+' „ÇíË≥ºÂÖ•ÔºÅ');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üè† Ë≥ºÂÖ•ÔºÅ');
  updateNav();renderInvestments();renderEconomy();
}

function sellRE(id){
  var h=getREHoldings();
  var idx=-1;
  for(var i=0;i<h.length;i++){if(h[i].id===id){idx=i;break;}}
  if(idx<0){toast('‰øùÊúâ„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì','err');return;}
  var item=REAL_ESTATE.find(function(x){return x.id===id;});
  var salePrice=calcREValue(h[idx]);
  var buyP=h[idx].buyPrice;
  var pnl=salePrice-buyP;
  h.splice(idx,1);
  setREHoldings(h);
  setGold(getGold()+salePrice);
  setTotalEarned(getTotalEarned()+Math.max(0,salePrice));
  var pnlStr=pnl>=0?'+'+pnl.toLocaleString():pnl.toLocaleString();
  addEventLog('üè† „Äå'+item.name+'„Äç„Çí'+salePrice.toLocaleString()+'G„ÅßÂ£≤Âç¥ (ÊêçÁõä:'+pnlStr+'G)','money');
  toast('üè† '+item.name+' Â£≤Âç¥ÔºÅ Â£≤Âç¥È°ç: '+salePrice.toLocaleString()+'G (ÊêçÁõä:'+pnlStr+'G)');
  updateNav();renderInvestments();renderEconomy();
}

function buyBiz(id){
  var biz=BUSINESSES.find(function(x){return x.id===id;});
  if(!biz)return;
  if(!checkSkillReq(biz.req)){toast('„Çπ„Ç≠„É´Ë¶Å‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì','err');return;}
  if(getGold()<biz.cost){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: '+biz.cost.toLocaleString()+'GÔºâ','err');return;}
  var avail=getAvailableStaff();
  if(biz.staff>avail){toast('ÂæìÊ•≠Âì°„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: '+biz.staff.toLocaleString()+'‰∫∫ / Á©∫„Åç: '+avail.toLocaleString()+'‰∫∫Ôºâ\nË°ó„ÅÆ‰∫∫Âè£„ÇíÂ¢ó„ÇÑ„Åó„Åæ„Åó„Çá„ÅÜÔºÅ','err');return;}
  setGold(getGold()-biz.cost);
  var h=getBizHoldings();
  h.push({id:id,buyDate:todayStr()});
  setBizHoldings(h);
  addEventLog('üè¢ „Äå'+biz.name+'„Äç„ÇíË®≠Á´ãÔºÅ ÂæìÊ•≠Âì°'+biz.staff.toLocaleString()+'‰∫∫ÈõáÁî®','money');
  toast('üè¢ '+biz.name+' „ÇíË®≠Á´ãÔºÅ');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üè¢ Ë®≠Á´ãÔºÅ');
  updateNav();renderInvestments();renderEconomy();
}

// Legacy migration: convert old owned_inv to new system
function migrateOldInvestments(){
  var old=ls_get('owned_inv');
  if(!old||old.length===0)return;
  var pf=getPortfolio();
  var reh=getREHoldings();
  var bizh=getBizHoldings();
  old.forEach(function(id){
    if(STOCKS.find(function(s){return s.id===id;})){
      var s=STOCKS.find(function(s){return s.id===id;});
      pf.push({id:id,buyPrice:s.basePrice,quantity:1});
    } else if(REAL_ESTATE.find(function(r){return r.id===id;})){
      var r=REAL_ESTATE.find(function(r){return r.id===id;});
      reh.push({id:id,buyPrice:r.cost,buyDate:todayStr()});
    } else if(BUSINESSES.find(function(b){return b.id===id;})){
      bizh.push({id:id,buyDate:todayStr()});
    }
  });
  setPortfolio(pf);setREHoldings(reh);setBizHoldings(bizh);
  ls_set('owned_inv',[]); // clear old
}

function toggleLifestyle(id){
  const item=LIFESTYLES.find(x=>x.id===id);
  if(!item)return;
  if(!checkSkillReq(item.req)){toast('„Çπ„Ç≠„É´Ë¶Å‰ª∂„ÇíÊ∫Ä„Åü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì','err');return;}
  const active=getActiveLifestyles();
  const idx=active.indexOf(id);
  if(idx>=0){
    active.splice(idx,1);
    setActiveLifestyles(active);
    toast('üõãÔ∏è '+item.name+' „ÇíËß£Á¥Ñ„Åó„Åæ„Åó„Åü');
  } else {
    active.push(id);
    setActiveLifestyles(active);
    toast('üõãÔ∏è '+item.name+' „ÇíÂ•ëÁ¥Ñ„Åó„Åæ„Åó„ÅüÔºÅ (XP +'+Math.round(item.xpBonus*100)+'%)');
  }
  renderInvestments();
}

function calcDailyPassive(){
  let total=0;
  // Business income (daily)
  getBizHoldings().forEach(function(h){
    var biz=BUSINESSES.find(function(x){return x.id===h.id;});
    if(biz)total+=biz.daily;
  });
  // Empire extra investment bonus
  total+=getEmpireDailyBonus();
  // Lifestyle costs
  const active=getActiveLifestyles();
  LIFESTYLES.forEach(ls=>{if(active.includes(ls.id))total-=ls.costPerDay;});
  return total;
}

// Monthly rent collection for real estate
function collectRent(){
  var holdings=getREHoldings();
  if(holdings.length===0){toast('‰∏çÂãïÁî£„Çí‰øùÊúâ„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì','err');return;}
  var last=getLastRentDate();
  var today=todayStr();
  if(last){
    var d1=parseDate(last),d2=parseDate(today);
    var daysSince=Math.round((d2-d1)/(1000*60*60*24));
    if(daysSince<30){toast('ÂÆ∂Ë≥É„ÅØÊúà1Âõû„Åß„ÅôÔºà„ÅÇ„Å®'+(30-daysSince)+'Êó•Ôºâ','err');return;}
  }
  var totalRent=0;
  holdings.forEach(function(h){
    var item=REAL_ESTATE.find(function(x){return x.id===h.id;});
    if(item)totalRent+=item.monthlyRent;
  });
  setGold(getGold()+totalRent);
  setTotalEarned(getTotalEarned()+totalRent);
  setLastRentDate(today);
  addEventLog('üè† ÂÆ∂Ë≥ÉÂèéÂÖ• '+totalRent.toLocaleString()+' G „ÇíÂèó„ÅëÂèñ„Å£„Åü','money');
  toast('üè† ÂÆ∂Ë≥ÉÂèéÂÖ• +'+totalRent.toLocaleString()+' GÔºÅ');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üè† +'+totalRent.toLocaleString()+'G');
  updateNav();renderEconomy();renderInvestments();
}

function getLifestyleXPBonus(){
  const active=getActiveLifestyles();
  let bonus=0;
  LIFESTYLES.forEach(ls=>{if(active.includes(ls.id))bonus+=ls.xpBonus;});
  return bonus;
}

function collectPassive(){
  const pending=getPendingPassive();
  if(pending<=0){toast('Âèó„ÅëÂèñ„Çã‰∏çÂä¥ÊâÄÂæó„Åå„ÅÇ„Çä„Åæ„Åõ„Çì','err');return;}
  setGold(getGold()+Math.max(0,pending));
  setTotalEarned(getTotalEarned()+Math.max(0,pending));
  setPendingPassive(0);
  setLastCollectDate(todayStr());
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üì• +'+pending.toLocaleString()+' G');
  addEventLog('üì• ‰∏çÂä¥ÊâÄÂæó '+pending.toLocaleString()+' G „ÇíÂèó„ÅëÂèñ„Å£„Åü','money');
  toast('üì• '+pending.toLocaleString()+' G Âèó„ÅëÂèñ„Çä„Åæ„Åó„ÅüÔºÅ');
  updateNav();
  renderEconomy();
}

// Daily passive income accumulation
function tickPassiveIncome(){
  const lastCollect=getLastCollectDate();
  if(!lastCollect)return;
  const today=todayStr();
  if(lastCollect===today)return;
  const d1=parseDate(lastCollect);
  const d2=parseDate(today);
  const daysDiff=Math.max(1,Math.round((d2-d1)/(1000*60*60*24)));
  let totalPassive=0;
  for(let i=0;i<daysDiff;i++){
    totalPassive+=calcDailyPassive();
  }
  setPendingPassive(getPendingPassive()+totalPassive);
  // Also tick stock prices
  tickStockPrices();
}

function renderInvestments(){
  var gold=getGold();
  var prices=getStockPrices();
  var active=getActiveLifestyles();
  var availStaff=getAvailableStaff();
  var totalStaffUsed=getTotalStaffUsed();
  var townPop=getTownPop();

  // === STOCKS ===
  var sGrid=document.getElementById('stockGrid');
  if(sGrid){
    sGrid.innerHTML=STOCKS.map(function(stk){
      var price=prices[stk.id]||stk.basePrice;
      var count=getPortfolioCount(stk.id);
      var meetsReq=checkSkillReq(stk.req);
      var canBuy=meetsReq&&gold>=price;
      var reqText=stk.req&&!meetsReq?'üîí '+getSkillNameById(stk.req.skill)+' Lv.'+stk.req.lv+' ÂøÖË¶Å':'';
      // calc avg buy price & PnL
      var holdings=getPortfolio().filter(function(p){return p.id===stk.id;});
      var avgBuy=count>0?Math.round(holdings.reduce(function(s,p){return s+p.buyPrice;},0)/count):0;
      var totalVal=price*count;
      var totalCost=holdings.reduce(function(s,p){return s+p.buyPrice;},0);
      var pnl=totalVal-totalCost;
      var pnlPct=totalCost>0?((pnl/totalCost)*100).toFixed(1):'0';
      var pnlColor=pnl>=0?'var(--green)':'var(--rose)';
      var priceChange=price-stk.basePrice;
      var changePct=((price/stk.basePrice-1)*100).toFixed(1);
      var changeColor=priceChange>=0?'var(--green)':'var(--rose)';

      var badge=count>0?'<div style="position:absolute;top:6px;right:8px;background:rgba(56,189,248,.15);border:1px solid rgba(56,189,248,.3);color:var(--cyan);font-size:.6rem;padding:1px 6px;border-radius:8px;font-family:JetBrains Mono,monospace;">√ó'+count+'</div>':'';

      return '<div class="inv-card'+(meetsReq?'':' locked')+'" style="position:relative;">'+badge+
        '<div class="inv-icon">'+stk.icon+'</div>'+
        '<div class="inv-name">'+stk.name+'</div>'+
        '<div class="inv-desc">'+stk.desc+'</div>'+
        '<div style="font-family:JetBrains Mono,monospace;font-size:.75rem;margin:4px 0;">'+
          'ÁèæÂú®ÂÄ§: <span style="color:'+changeColor+';">'+price.toLocaleString()+' G</span>'+
          ' <span style="font-size:.6rem;color:'+changeColor+';">('+changePct+'%)</span>'+
        '</div>'+
        '<div style="font-size:.6rem;color:var(--muted2);">„Éú„É©„ÉÜ„Ç£„É™„ÉÜ„Ç£: '+(stk.volatility*100).toFixed(1)+'% | „É™„Çπ„ÇØ: '+stk.risk+'</div>'+
        (count>0?'<div style="margin-top:4px;padding:4px 6px;background:rgba(255,255,255,.03);border-radius:6px;font-size:.62rem;">'+
          'Âπ≥ÂùáÂèñÂæó: '+avgBuy.toLocaleString()+'G | Ë©ï‰æ°È°ç: '+totalVal.toLocaleString()+'G<br>'+
          '<span style="color:'+pnlColor+';font-weight:700;">ÊêçÁõä: '+(pnl>=0?'+':'')+pnl.toLocaleString()+'G ('+pnlPct+'%)</span>'+
        '</div>':'')+
        '<div style="display:flex;gap:4px;margin-top:6px;">'+
          (canBuy?'<button onclick="event.stopPropagation();buyStock(\''+stk.id+'\')" style="flex:1;padding:5px;border:none;border-radius:6px;background:linear-gradient(135deg,#38bdf8,#818cf8);color:#fff;font-size:.7rem;font-weight:700;cursor:pointer;">Ë≥ºÂÖ• '+(price+Math.round(price*0.01)).toLocaleString()+'G</button>':
          '<button disabled style="flex:1;padding:5px;border:none;border-radius:6px;background:var(--s2);color:var(--muted);font-size:.7rem;cursor:not-allowed;">'+(meetsReq?price.toLocaleString()+'G':'üîí')+'</button>')+
          (count>0?'<button onclick="event.stopPropagation();sellStock(\''+stk.id+'\')" style="flex:1;padding:5px;border:none;border-radius:6px;background:linear-gradient(135deg,#f97316,#ef4444);color:#fff;font-size:.7rem;font-weight:700;cursor:pointer;">Â£≤Âç¥ 1Âè£</button>':'')+
        '</div>'+
        (reqText?'<div class="inv-lock">'+reqText+'</div>':'')+
      '</div>';
    }).join('');
  }

  // === REAL ESTATE ===
  var reGrid=document.getElementById('realEstateGrid');
  if(reGrid){
    reGrid.innerHTML=REAL_ESTATE.map(function(item){
      var count=getRECount(item.id);
      var meetsReq=checkSkillReq(item.req);
      var canBuy=meetsReq&&gold>=item.cost;
      var reqText=item.req&&!meetsReq?'üîí '+getSkillNameById(item.req.skill)+' Lv.'+item.req.lv+' ÂøÖË¶Å':'';
      var holdings=getREHoldings().filter(function(h){return h.id===item.id;});
      var badge=count>0?'<div style="position:absolute;top:6px;right:8px;background:rgba(74,222,128,.15);border:1px solid rgba(74,222,128,.3);color:var(--green);font-size:.6rem;padding:1px 6px;border-radius:8px;font-family:JetBrains Mono,monospace;">√ó'+count+'</div>':'';

      var detailHtml='';
      if(count>0){
        detailHtml='<div style="margin-top:4px;font-size:.6rem;">';
        holdings.forEach(function(h,i){
          var cv=calcREValue(h);
          var dep=h.buyPrice-cv;
          detailHtml+='<div style="padding:2px 4px;background:rgba(255,255,255,.03);border-radius:4px;margin-bottom:2px;">'+
            '#'+(i+1)+' ÂèñÂæó:'+h.buyPrice.toLocaleString()+'G ‚Üí ÁèæÂú®:'+cv.toLocaleString()+'G <span style="color:var(--rose);">(-'+dep.toLocaleString()+'G)</span>'+
          '</div>';
        });
        detailHtml+='</div>';
      }

      return '<div class="inv-card'+(meetsReq?'':' locked')+'" style="position:relative;">'+badge+
        '<div class="inv-icon">'+item.icon+'</div>'+
        '<div class="inv-name">'+item.name+'</div>'+
        '<div class="inv-desc">'+item.desc+'</div>'+
        '<div class="inv-yield">ÂÆ∂Ë≥É: Êúà '+item.monthlyRent.toLocaleString()+' G / Êà∏</div>'+
        '<div style="font-size:.6rem;color:var(--muted2);">Ê∏õ‰æ°Áéá: '+((item.depRate*100).toFixed(2))+'%/Êó• | Âà©Âõû„Çä: '+(item.monthlyRent*12/item.cost*100).toFixed(1)+'%/Âπ¥</div>'+
        detailHtml+
        '<div style="display:flex;gap:4px;margin-top:6px;">'+
          (canBuy?'<button onclick="event.stopPropagation();buyRE(\''+item.id+'\')" style="flex:1;padding:5px;border:none;border-radius:6px;background:linear-gradient(135deg,#4ade80,#22d3ee);color:#000;font-size:.7rem;font-weight:700;cursor:pointer;">Ë≥ºÂÖ• '+item.cost.toLocaleString()+'G</button>':
          '<button disabled style="flex:1;padding:5px;border:none;border-radius:6px;background:var(--s2);color:var(--muted);font-size:.7rem;cursor:not-allowed;">'+(meetsReq?item.cost.toLocaleString()+'G':'üîí')+'</button>')+
          (count>0?'<button onclick="event.stopPropagation();sellRE(\''+item.id+'\')" style="flex:1;padding:5px;border:none;border-radius:6px;background:linear-gradient(135deg,#f97316,#ef4444);color:#fff;font-size:.7rem;font-weight:700;cursor:pointer;">Â£≤Âç¥ 1Êà∏</button>':'')+
        '</div>'+
        (reqText?'<div class="inv-lock">'+reqText+'</div>':'')+
      '</div>';
    }).join('');
  }

  // === BUSINESS ===
  var bizGrid=document.getElementById('businessGrid');
  if(bizGrid){
    // Staff info header
    var staffInfo='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:var(--s2);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;font-size:.7rem;">'+
      '<span>üë• Ë°ó„ÅÆ‰∫∫Âè£: <span style="color:var(--cyan);font-family:JetBrains Mono,monospace;">'+townPop.toLocaleString()+'</span>‰∫∫</span>'+
      '<span>ÈõáÁî®‰∏≠: <span style="color:var(--amber);font-family:JetBrains Mono,monospace;">'+totalStaffUsed.toLocaleString()+'</span>‰∫∫</span>'+
      '<span>Á©∫„Åç: <span style="color:'+(availStaff>0?'var(--green)':'var(--rose)')+';font-family:JetBrains Mono,monospace;">'+availStaff.toLocaleString()+'</span>‰∫∫</span>'+
    '</div>';

    bizGrid.innerHTML=staffInfo+BUSINESSES.map(function(biz){
      var count=getBizCount(biz.id);
      var meetsReq=checkSkillReq(biz.req);
      var canAfford=gold>=biz.cost;
      var hasStaff=availStaff>=biz.staff;
      var canBuy=meetsReq&&canAfford&&hasStaff;
      var reqText=biz.req&&!meetsReq?'üîí '+getSkillNameById(biz.req.skill)+' Lv.'+biz.req.lv+' ÂøÖË¶Å':'';
      var badge=count>0?'<div style="position:absolute;top:6px;right:8px;background:rgba(168,85,247,.15);border:1px solid rgba(168,85,247,.3);color:var(--violet);font-size:.6rem;padding:1px 6px;border-radius:8px;font-family:JetBrains Mono,monospace;">√ó'+count+'</div>':'';

      var staffColor=hasStaff?'var(--green)':'var(--rose)';

      return '<div class="inv-card'+(meetsReq?'':' locked')+'" style="position:relative;">'+badge+
        '<div class="inv-icon">'+biz.icon+'</div>'+
        '<div class="inv-name">'+biz.name+'</div>'+
        '<div class="inv-desc">'+biz.desc+'</div>'+
        '<div class="inv-yield">ÊØéÊó• +'+biz.daily.toLocaleString()+' G'+(count>0?' (Ë®à: +'+biz.daily*count+' G/Êó•)':'')+'</div>'+
        (biz.id==='biz_empire'&&count>0?'<div style="font-size:.58rem;color:#fcd34d;margin:3px 0;">üëë ËøΩÂä†ÊäïË≥á: '+getEmpireInvestment().toLocaleString()+'G ‚Üí +'+getEmpireDailyBonus().toLocaleString()+' G/Êó•</div>':'')+
        '<div style="font-size:.6rem;color:'+staffColor+';">üë• ÂøÖË¶ÅÂæìÊ•≠Âì°: '+biz.staff.toLocaleString()+'‰∫∫'+(!hasStaff&&meetsReq?' (‰∏çË∂≥ÔºÅ)':'')+'</div>'+
        '<div style="display:flex;gap:4px;margin-top:6px;">'+
          (canBuy?'<button onclick="event.stopPropagation();buyBiz(\''+biz.id+'\')" style="flex:1;padding:5px;border:none;border-radius:6px;background:linear-gradient(135deg,#a855f7,#ec4899);color:#fff;font-size:.7rem;font-weight:700;cursor:pointer;">Ë®≠Á´ã '+biz.cost.toLocaleString()+'G</button>':
          '<button disabled style="flex:1;padding:5px;border:none;border-radius:6px;background:var(--s2);color:var(--muted);font-size:.7rem;cursor:not-allowed;">'+(meetsReq?(canAfford?'üë• ‰∫∫Âè£‰∏çË∂≥':biz.cost.toLocaleString()+'G'):'üîí')+'</button>')+
          (biz.id==='biz_empire'&&count>0?'<button onclick="event.stopPropagation();investInEmpire()" style="padding:5px 8px;border:none;border-radius:6px;background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#000;font-size:.65rem;font-weight:700;cursor:pointer;">üí∞ ËøΩÂä†ÊäïË≥á</button>':'')+
        '</div>'+
        (reqText?'<div class="inv-lock">'+reqText+'</div>':'')+
      '</div>';
    }).join('');
  }

  // === LIFESTYLE ===
  var lsEl=document.getElementById('lifestyleGrid');
  if(lsEl){
    lsEl.innerHTML=LIFESTYLES.map(function(item){
      var isActive=active.includes(item.id);
      var meetsReq=checkSkillReq(item.req);
      var cls='ls-card'+(isActive?' ls-active':'')+(!meetsReq?' locked':'');
      return '<div class="'+cls+'" onclick="'+(meetsReq?"toggleLifestyle('"+item.id+"')":'')+'" style="'+(meetsReq?'':'opacity:.4;cursor:not-allowed;')+'">'+
        '<div class="ls-icon">'+item.icon+'</div>'+
        '<div class="ls-name">'+item.name+(isActive?' ‚úì':'')+'</div>'+
        '<div class="ls-desc">'+item.desc+'</div>'+
        '<div class="ls-cost">-'+item.costPerDay+' G/Êó•</div>'+
        '<div class="ls-bonus">XP +'+Math.round(item.xpBonus*100)+'%</div>'+
        (item.req&&!meetsReq?'<div style="font-size:.55rem;color:var(--rose);margin-top:2px;">üîí '+getSkillNameById(item.req.skill)+' Lv.'+item.req.lv+'</div>':'')+
      '</div>';
    }).join('');
  }

  // === PASSIVE INCOME DISPLAY ===
  var totalDaily=calcDailyPassive();
  var reMonthly=getREHoldings().reduce(function(s,h){var r=REAL_ESTATE.find(function(x){return x.id===h.id;});return s+(r?r.monthlyRent:0);},0);
  var bizDaily=getBizHoldings().reduce(function(s,h){var b=BUSINESSES.find(function(x){return x.id===h.id;});return s+(b?b.daily:0);},0);
  var lsCost=LIFESTYLES.filter(function(l){return active.includes(l.id);}).reduce(function(s,l){return s+l.costPerDay;},0);
  var stockVal=getPortfolio().reduce(function(s,p){var pr=prices[p.id]||0;return s+pr;},0);

  var passDisp=document.getElementById('passiveDisplay');
  if(passDisp)passDisp.textContent=(totalDaily>=0?'+':'')+totalDaily.toLocaleString()+' G/Êó•';
  var passDetail=document.getElementById('passiveDetail');
  if(passDetail){
    passDetail.textContent='‰∫ãÊ•≠:+'+bizDaily+'G/Êó• | ÂÆ∂Ë≥É:+'+reMonthly.toLocaleString()+'G/Êúà | Ê†™Ë©ï‰æ°È°ç:'+stockVal.toLocaleString()+'G | ÁîüÊ¥ªË≤ª:-'+lsCost+'G/Êó•';
  }

  // Pending passive bar
  var pending=getPendingPassive();
  var passBar=document.getElementById('passiveBar');
  if(passBar)passBar.style.display=pending>0?'flex':'none';
  var passAmt=document.getElementById('passiveCollectAmt');
  if(passAmt)passAmt.textContent=pending.toLocaleString()+' G';

  // Rent button
  var rentBtn=document.getElementById('rentCollectBtn');
  if(rentBtn){
    var lastRent=getLastRentDate();
    var canRent=getREHoldings().length>0;
    var daysLeft=0;
    if(lastRent){
      var d1=parseDate(lastRent),d2=parseDate(todayStr());
      daysLeft=Math.max(0,30-Math.round((d2-d1)/(1000*60*60*24)));
    }
    rentBtn.style.display=canRent?'flex':'none';
    rentBtn.textContent=daysLeft>0?'üè† ÂÆ∂Ë≥ÉÂõûÂèé„Åæ„Åß '+daysLeft+'Êó•':'üè† ÂÆ∂Ë≥É„ÇíÂõûÂèé„Åô„Çã (+'+reMonthly.toLocaleString()+'G)';
    rentBtn.disabled=daysLeft>0;
    rentBtn.style.opacity=daysLeft>0?'0.5':'1';
    rentBtn.style.cursor=daysLeft>0?'not-allowed':'pointer';
  }
}

// ================================================================
// GACHA SYSTEM
// ================================================================

// ================================================================
// HOUSING UPGRADE SYSTEM
// ================================================================
const HOUSING = [
  {id:'h0',name:'ÈáéÂÆø',icon:'üõñ',cost:0,xpBonus:0,desc:'ÊòüÁ©∫„ÅÆ‰∏ã„Åß'},
  {id:'h1',name:'„ÉÜ„É≥„Éà',icon:'‚õ∫',cost:200,xpBonus:0.03,desc:'Èõ®„ÅØ„Åó„ÅÆ„Åí„Çã'},
  {id:'h2',name:'Â∞èÈÉ®Â±ã',icon:'üö™',cost:800,xpBonus:0.06,desc:'Ëá™ÂàÜ„Å†„Åë„ÅÆÁ©∫Èñì'},
  {id:'h3',name:'„Ç¢„Éë„Éº„Éà',icon:'üè†',cost:2500,xpBonus:0.10,desc:'ÊôÆÈÄö„ÅÆÊöÆ„Çâ„Åó'},
  {id:'h4',name:'„Éû„É≥„Ç∑„Éß„É≥',icon:'üè¢',cost:8000,xpBonus:0.15,desc:'ÈÉΩÂøÉ„ÅÆ1LDK'},
  {id:'h5',name:'‰∏ÄÊà∏Âª∫„Å¶',icon:'üè°',cost:25000,xpBonus:0.20,desc:'Â∫≠‰ªò„Åç„ÅÆÂÆ∂'},
  {id:'h6',name:'„Éá„Ç∂„Ç§„Éä„Éº„Ç∫',icon:'üèõÔ∏è',cost:80000,xpBonus:0.28,desc:'Âª∫ÁØâÂÆ∂Ë®≠Ë®à„ÅÆÈÇ∏ÂÆÖ'},
  {id:'h7',name:'„Éö„É≥„Éà„Éè„Ç¶„Çπ',icon:'üåÉ',cost:250000,xpBonus:0.35,desc:'ÊúÄ‰∏äÈöé„ÅÆÁú∫Êúõ'},
  {id:'h8',name:'Âüé',icon:'üè∞',cost:800000,xpBonus:0.45,desc:'„ÅÇ„Å™„Åü„Å†„Åë„ÅÆÂüé'},
  {id:'h9',name:'ÂÆÆÊÆø',icon:'üëë',cost:2000000,xpBonus:0.55,desc:'ÁéãÂÆÆ„É¨„Éô„É´„ÅÆ‰ΩèÂ±Ö'},
  {id:'h10',name:'Êµ∑Â∫ï„Éâ„Éº„É†',icon:'ü´ß',cost:5000000,xpBonus:0.65,desc:'Êµ∑„ÅÆÂ∫ï„ÅÆÊ•ΩÂúí'},
  {id:'h11',name:'ËªåÈÅì‰∏ä„Çπ„ÉÜ„Éº„Ç∑„Éß„É≥',icon:'üõ∏',cost:15000000,xpBonus:0.80,desc:'ÂÆáÂÆô„Åã„ÇâÂú∞ÁêÉ„ÇíË¶ã‰∏ã„Çç„Åô'},
  {id:'h12',name:'Áï∞Ê¨°ÂÖÉÈÇ∏ÂÆÖ',icon:'üåå',cost:50000000,xpBonus:1.00,desc:'ÊôÇÁ©∫„ÇíË∂Ö„Åà„ÅüÁ©∂Ê•µ„ÅÆ‰ΩèÂá¶'},
];

const INTERIOR = [
  {id:'int_desk',name:'„ÉØ„Éº„ÇØ„Éá„Çπ„ÇØ',icon:'ü™ë',cost:300,xpBonus:0.02,desc:'ÈõÜ‰∏≠„Åß„Åç„Çã‰ΩúÊ•≠Áí∞Â¢É'},
  {id:'int_bookshelf',name:'Êú¨Ê£ö',icon:'üìö',cost:500,xpBonus:0.02,desc:'Áü•Ë≠ò„ÅÆÂ£Å'},
  {id:'int_plant',name:'Ë¶≥ËëâÊ§çÁâ©',icon:'üå±',cost:200,xpBonus:0.01,desc:'Áôí„Åó„ÅÆÁ∑ë'},
  {id:'int_art',name:'„Ç¢„Éº„Éà‰ΩúÂìÅ',icon:'üñºÔ∏è',cost:1500,xpBonus:0.03,desc:'„Ç§„É≥„Çπ„Éî„É¨„Éº„Ç∑„Éß„É≥„ÅÆÊ∫ê'},
  {id:'int_speaker',name:'È´òÁ¥ö„Çπ„Éî„Éº„Ç´„Éº',icon:'üîä',cost:2000,xpBonus:0.03,desc:'Èü≥„ÅßÁ©∫Èñì„ÇíÊ∫Ä„Åü„Åô'},
  {id:'int_bed',name:'È´òÁ¥ö„Éô„ÉÉ„Éâ',icon:'üõèÔ∏è',cost:3000,xpBonus:0.04,desc:'Áù°Áú†„ÅÆË≥™„ÅåÂäáÁöÑÂêë‰∏ä'},
  {id:'int_kitchen',name:'„Ç∑„Çπ„ÉÜ„É†„Ç≠„ÉÉ„ÉÅ„É≥',icon:'üç≥',cost:5000,xpBonus:0.04,desc:'Ëá™ÁÇä„ÅßÂÅ•Â∫∑„Å´'},
  {id:'int_bath',name:'„Ç∏„Çß„ÉÉ„Éà„Éê„Çπ',icon:'üõÅ',cost:8000,xpBonus:0.05,desc:'Ê•µ‰∏ä„ÅÆ„É™„É©„ÉÉ„ÇØ„Çπ'},
  {id:'int_gym',name:'„Éõ„Éº„É†„Ç∏„É†',icon:'üèãÔ∏è',cost:12000,xpBonus:0.06,desc:'„ÅÑ„Å§„Åß„ÇÇ„Éà„É¨„Éº„Éã„É≥„Ç∞'},
  {id:'int_theater',name:'„Éõ„Éº„É†„Ç∑„Ç¢„Çø„Éº',icon:'üé¨',cost:20000,xpBonus:0.06,desc:'Êò†ÁîªÈ§®„ÅåËá™ÂÆÖ„Å´'},
  {id:'int_wine',name:'„ÉØ„Ç§„É≥„Çª„É©„Éº',icon:'üç∑',cost:35000,xpBonus:0.05,desc:'ÊôÇ„ÇíÈáç„Å≠„ÇãË¥ÖÊ≤¢'},
  {id:'int_sauna',name:'„Éó„É©„Ç§„Éô„Éº„Éà„Çµ„Ç¶„Éä',icon:'üßñ',cost:50000,xpBonus:0.08,desc:'Á©∂Ê•µ„ÅÆÂõûÂæ©Á©∫Èñì'},
  {id:'int_rooftop',name:'„É´„Éº„Éï„Éà„ÉÉ„Éó„ÉÜ„É©„Çπ',icon:'üåÖ',cost:70000,xpBonus:0.07,desc:'Â§ïÊó•„ÇíÁã¨„ÇäÂç†„ÇÅ'},
  {id:'int_lab',name:'„Éõ„Éº„É†„É©„Éú',icon:'üî¨',cost:90000,xpBonus:0.08,desc:'Ëá™ÂÆÖ„ÅßÂÆüÈ®ì'},
  {id:'int_dojo',name:'ÈÅìÂ†¥',icon:'ü•ã',cost:120000,xpBonus:0.09,desc:'Á≤æÁ•û„Å®Ë∫´‰Ωì„ÇíÈçõ„Åà„Çã'},
  {id:'int_observatory',name:'„Éó„É©„Éç„Çø„É™„Ç¶„É†ÂÆ§',icon:'üåå',cost:180000,xpBonus:0.10,desc:'Â§©‰∫ï„Å´ÊòüÁ©∫„ÇíÊò†„Åô'},
  {id:'int_library',name:'„Éó„É©„Ç§„Éô„Éº„ÉàÂõ≥Êõ∏ÂÆ§',icon:'üìñ',cost:250000,xpBonus:0.12,desc:'1‰∏áÂÜä„ÅÆÁü•„ÅÆÊÆøÂ†Ç'},
  {id:'int_pool',name:'„Ç§„É≥„Éï„Ç£„Éã„ÉÜ„Ç£„Éó„Éº„É´',icon:'üèä',cost:400000,xpBonus:0.12,desc:'Âú∞Âπ≥Á∑ö„Å®Ê∫∂„ÅëÂêà„ÅÜÊ∞¥Èù¢'},
  {id:'int_holo',name:'„Éõ„É≠„Ç∞„É©„É†ÈÉ®Â±ã',icon:'üîÆ',cost:800000,xpBonus:0.15,desc:'ÂÖâ„Åß‰Ωú„Çã‰ªÆÊÉ≥Á©∫Èñì'},
  {id:'int_zen',name:'ÊûØÂ±±Ê∞¥Â∫≠Âúí',icon:'‚õ©Ô∏è',cost:1500000,xpBonus:0.18,desc:'Á©∂Ê•µ„ÅÆÈùôÂØÇ'},
  // gacha-only items
  {id:'int_chandelier',name:'„Ç∑„É£„É≥„Éá„É™„Ç¢',icon:'‚ú®',cost:0,xpBonus:0.10,desc:'Â§©‰∫ï„ÇíÈ£æ„ÇãËºù„Åç',gachaOnly:true},
  {id:'int_aquarium',name:'Â∑®Â§ßÊ∞¥ÊßΩ',icon:'üê†',cost:0,xpBonus:0.08,desc:'ÁÜ±Â∏ØÈ≠ö„ÅåÊ≥≥„ÅêÁôí„ÅóÁ©∫Èñì',gachaOnly:true},
  {id:'int_piano',name:'„Ç∞„É©„É≥„Éâ„Éî„Ç¢„Éé',icon:'üéπ',cost:0,xpBonus:0.12,desc:'Ëä∏Ë°ì„ÅÆÊ•µ„Åø',gachaOnly:true},
  {id:'int_telescope',name:'Â§©‰ΩìÊúõÈÅ†Èè°',icon:'üî≠',cost:0,xpBonus:0.09,desc:'Êòü„ÇíË¶ã„ÇãË¥ÖÊ≤¢',gachaOnly:true},
  {id:'int_garden',name:'Â±ã‰∏äÂ∫≠Âúí',icon:'üå∏',cost:0,xpBonus:0.15,desc:'Á©∫„Å´ÊµÆ„Åã„Å∂Ê•ΩÂúí',gachaOnly:true},
  {id:'int_aurora',name:'„Ç™„Éº„É≠„É©Áô∫ÁîüË£ÖÁΩÆ',icon:'üåà',cost:0,xpBonus:0.13,desc:'ÂÆ§ÂÜÖ„Å´„Ç™„Éº„É≠„É©„ÅåËàû„ÅÜ',gachaOnly:true},
  {id:'int_antigrav',name:'ÁÑ°ÈáçÂäõ„ÉÅ„Çß„Ç¢',icon:'ü™ê',cost:0,xpBonus:0.11,desc:'ÊµÆÈÅä„Åô„Çã„É™„É©„ÇØ„Çº„Éº„Ç∑„Éß„É≥',gachaOnly:true},
  {id:'int_timeclock',name:'ÊôÇ„ÅÆÂ§ßÊôÇË®à',icon:'‚è∞',cost:0,xpBonus:0.14,desc:'ÊôÇ„ÇíÂàª„ÇÄËä∏Ë°ìÂìÅ',gachaOnly:true},
];

function getCurrentHousing(){return ls_get('housing_level')||0;}
function setCurrentHousing(v){ls_set('housing_level',v);}
function getOwnedInterior(){return ls_get('owned_interior')||[];}
function setOwnedInterior(v){ls_set('owned_interior',v);}

function getHousingXPBonus(){
  const hLv=getCurrentHousing();
  const h=HOUSING[hLv]||HOUSING[0];
  let bonus=h.xpBonus;
  getOwnedInterior().forEach(id=>{const it=INTERIOR.find(x=>x.id===id);if(it)bonus+=it.xpBonus;});
  return bonus;
}

function upgradeHousing(level){
  const h=HOUSING[level];
  if(!h)return;
  if(level<=getCurrentHousing()){toast('„Åô„Åß„Å´„Åì„ÅÆ‰ΩèÂ±Ö‰ª•‰∏ä„Åß„Åô','err');return;}
  if(level!==getCurrentHousing()+1){toast('1ÊÆµÈöé„Åö„Å§„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  if(getGold()<h.cost){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: '+h.cost.toLocaleString()+'GÔºâ','err');return;}
  setGold(getGold()-h.cost);
  setCurrentHousing(level);
  addEventLog('üè† ‰ΩèÂ±Ö„Çí„Äå'+h.name+'„Äç„Å´„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÔºÅ XP+'+Math.round(h.xpBonus*100)+'%','money');
  showReward(h.icon,'‰ΩèÂ±Ö„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÔºÅ','„Äå'+h.name+'„Äç„Å´Âºï„Å£Ë∂ä„Åó„Åæ„Åó„ÅüÔºÅ\nXP„Éú„Éº„Éä„Çπ +'+Math.round(h.xpBonus*100)+'%');
  updateNav();renderEconomy();renderLifestyle();
}

function buyInterior(id){
  const item=INTERIOR.find(x=>x.id===id);
  if(!item)return;
  const owned=getOwnedInterior();
  if(owned.includes(id)){toast('„Åô„Åß„Å´Ë≥ºÂÖ•Ê∏à„Åø„Åß„Åô','err');return;}
  if(getGold()<item.cost){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: '+item.cost.toLocaleString()+'GÔºâ','err');return;}
  setGold(getGold()-item.cost);
  owned.push(id);setOwnedInterior(owned);
  addEventLog('üõãÔ∏è „Äå'+item.name+'„Äç„ÇíË≥ºÂÖ•ÔºÅ XP+'+Math.round(item.xpBonus*100)+'%','money');
  toast('üõãÔ∏è '+item.name+' „ÇíË®≠ÁΩÆ„Åó„Åæ„Åó„ÅüÔºÅ');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'XP+'+Math.round(item.xpBonus*100)+'%');
  updateNav();renderEconomy();renderLifestyle();
}
function renderLifestyle(){
  var curH=getCurrentHousing();
  var h=HOUSING[curH];
  var owned=getOwnedInterior();
  var gold=getGold();
  var active=getActiveLifestyles();
  var intBonus=owned.reduce(function(s,id){var it=INTERIOR.find(function(x){return x.id===id;});return s+(it?it.xpBonus:0);},0);
  var totalBonus=getHousingXPBonus()+getLifestyleXPBonus();

  document.getElementById('curHousingIcon').textContent=h.icon;
  document.getElementById('curHousingName').textContent=h.name;
  document.getElementById('curHousingBonus').textContent='XP„Éú„Éº„Éä„ÇπÂêàË®à: +'+Math.round(totalBonus*100)+'% (‰ΩèÂ±Ö+'+Math.round(h.xpBonus*100)+'% / ÂÆ∂ÂÖ∑+'+Math.round(intBonus*100)+'% / „Çµ„Éñ„Çπ„ÇØ+'+Math.round(getLifestyleXPBonus()*100)+'%)';

  var hList=document.getElementById('housingList');
  if(hList){
    hList.innerHTML=HOUSING.slice(1).map(function(hh,i){
      var level=i+1;
      var isOwned=curH>=level;
      var isNext=level===curH+1;
      var canBuy=isNext&&gold>=hh.cost;
      var cls='bld-item'+(isOwned?' bld-owned':!isNext?' bld-cant':'');
      return '<div class="'+cls+'" onclick="'+(canBuy?'upgradeHousing('+level+')':'')+'">'+
        '<div class="bld-icon">'+hh.icon+'</div>'+
        '<div class="bld-info"><div class="bld-name">'+hh.name+'</div><div class="bld-desc">'+hh.desc+' (XP +'+Math.round(hh.xpBonus*100)+'%)</div></div>'+
        '<div class="bld-cost '+(isOwned?'c-own':canBuy?'c-gold':'c-lock')+'">'+(isOwned?'ÂÖ•Â±Ö‰∏≠ ‚úì':hh.cost.toLocaleString()+' G')+'</div></div>';
    }).join('');
  }

  var iGrid=document.getElementById('interiorGrid');
  if(iGrid){
    iGrid.innerHTML=INTERIOR.filter(function(item){return !item.gachaOnly;}).map(function(item){
      var isOwned=owned.includes(item.id);
      var canBuy=!isOwned&&gold>=item.cost;
      return '<div class="inv-card'+(isOwned?' owned':'')+'" onclick="'+(!isOwned&&canBuy?'buyInterior(\''+item.id+'\')':'')+'" style="'+(isOwned?'':canBuy?'cursor:pointer;':'cursor:not-allowed;opacity:.5;')+'">'+
        '<div class="inv-icon">'+item.icon+'</div>'+
        '<div class="inv-name">'+item.name+'</div>'+
        '<div class="inv-desc">'+item.desc+'</div>'+
        '<div class="inv-yield">XP +'+Math.round(item.xpBonus*100)+'%</div>'+
        (isOwned?'':'<div class="inv-cost">'+item.cost.toLocaleString()+' G</div>')+
      '</div>';
    }).join('');
    // Show gacha-only items as locked
    var gachaItems=INTERIOR.filter(function(item){return item.gachaOnly;});
    if(gachaItems.length>0){
      iGrid.innerHTML+='<div style="width:100%;font-size:.62rem;color:var(--violet);margin-top:6px;padding-top:6px;border-top:1px solid var(--border);">üé∞ È´òÁ¥ö„Ç¨„ÉÅ„É£ÈôêÂÆö„Ç¢„Ç§„ÉÜ„É†</div>';
      iGrid.innerHTML+=gachaItems.map(function(item){
        var isOwned=owned.includes(item.id);
        return '<div class="inv-card'+(isOwned?' owned':'')+'" style="border-color:rgba(168,85,247,.25);'+(isOwned?'':'opacity:.6;cursor:default;')+'">'+
          '<div class="inv-icon">'+item.icon+'</div>'+
          '<div class="inv-name">'+item.name+(isOwned?' ‚úì':'')+'</div>'+
          '<div class="inv-desc">'+item.desc+'</div>'+
          '<div class="inv-yield">XP +'+Math.round(item.xpBonus*100)+'%</div>'+
          (isOwned?'':'<div style="font-size:.55rem;color:var(--violet);">üé∞ È´òÁ¥ö„Ç¨„ÉÅ„É£„Åß„ÅÆ„ÅøÂÖ•Êâã</div>')+
        '</div>';
      }).join('');
    }
  }

  var lsEl=document.getElementById('lifestyleGrid');
  if(lsEl){
    lsEl.innerHTML=LIFESTYLES.map(function(item){
      var isActive=active.includes(item.id);
      var meetsReq=checkSkillReq(item.req);
      return '<div class="ls-card'+(isActive?' ls-active':'')+'" onclick="'+(meetsReq?'toggleLifestyle(\''+item.id+'\')':'')+'" style="'+(meetsReq?'':'opacity:.4;cursor:not-allowed;')+'">'+
        '<div class="ls-icon">'+item.icon+'</div>'+
        '<div class="ls-name">'+item.name+(isActive?' ‚úì':'')+'</div>'+
        '<div class="ls-desc">'+item.desc+'</div>'+
        '<div class="ls-cost">-'+item.costPerDay+' G/Êó•</div>'+
        '<div class="ls-bonus">XP +'+Math.round(item.xpBonus*100)+'%</div>'+
        (item.req&&!meetsReq?'<div style="font-size:.55rem;color:var(--rose);margin-top:2px;">üîí '+getSkillNameById(item.req.skill)+' Lv.'+item.req.lv+'</div>':'')+
      '</div>';
    }).join('');
  }
}

// ================================================================
// TOWN RANK SYSTEM
// ================================================================
const TOWN_RANKS = [
  {name:'Êõ¥Âú∞',minPop:0,icon:'üèúÔ∏è',wageBonus:0,goldBonus:0},
  {name:'ÈõÜËêΩ',minPop:50,icon:'üèïÔ∏è',wageBonus:0.02,goldBonus:50},
  {name:'Êùë',minPop:120,icon:'üèòÔ∏è',wageBonus:0.05,goldBonus:150},
  {name:'Áî∫',minPop:250,icon:'üèôÔ∏è',wageBonus:0.08,goldBonus:300},
  {name:'Â∞èÈÉΩÂ∏Ç',minPop:500,icon:'üåÜ',wageBonus:0.12,goldBonus:500},
  {name:'ÈÉΩÂ∏Ç',minPop:800,icon:'üåá',wageBonus:0.18,goldBonus:1000},
  {name:'Â§ßÈÉΩÂ∏Ç',minPop:1200,icon:'üåÉ',wageBonus:0.25,goldBonus:2000},
  {name:'„É°„Ç¨„Ç∑„ÉÜ„Ç£',minPop:1800,icon:'üóº',wageBonus:0.32,goldBonus:4000},
  {name:'„É°„Éà„É≠„Éù„É™„Çπ',minPop:2500,icon:'üåê',wageBonus:0.40,goldBonus:8000},
  {name:'Â∏ùÈÉΩ',minPop:3500,icon:'üëë',wageBonus:0.50,goldBonus:15000},
  {name:'ÈäÄÊ≤≥ÈÉΩÂ∏Ç',minPop:5000,icon:'üåå',wageBonus:0.65,goldBonus:30000},
];

function getTownPop(){
  return getOwnedBuildings().reduce(function(s,id){var b=BUILDINGS.find(function(x){return x.id===id;});return s+(b?b.pop:0);},0);
}

function getTownRank(){
  var pop=getTownPop();
  var rank=TOWN_RANKS[0];
  for(var i=0;i<TOWN_RANKS.length;i++){if(pop>=TOWN_RANKS[i].minPop)rank=TOWN_RANKS[i];}
  return rank;
}

function getTownWageBonus(){return getTownRank().wageBonus;}

function renderTownRank(){
  var pop=getTownPop();
  var rank=getTownRank();
  var rankIdx=TOWN_RANKS.indexOf(rank);
  var next=TOWN_RANKS[rankIdx+1];
  var badge=document.getElementById('townRankBadge');
  if(badge)badge.textContent=rank.icon+' '+rank.name;
  var label=document.getElementById('townRankLabel');
  var prog=document.getElementById('townRankProg');
  var bar=document.getElementById('townRankBar');
  if(next){
    if(label)label.textContent='Ê¨°„ÅÆ„É©„É≥„ÇØ: '+next.name;
    if(prog)prog.textContent=pop+'/'+next.minPop+'‰∫∫';
    if(bar)bar.style.width=Math.min(100,(pop/next.minPop)*100)+'%';
  } else {
    if(label)label.textContent='ÊúÄÈ´ò„É©„É≥„ÇØÈÅîÊàêÔºÅ';
    if(prog)prog.textContent=pop+'‰∫∫';
    if(bar)bar.style.width='100%';
  }
  var bonus=document.getElementById('townBonusText');
  if(bonus){
    if(rank.wageBonus>0){
      bonus.textContent='ÊôÇÁµ¶ +'+Math.round(rank.wageBonus*100)+'% | „É©„É≥„ÇØ„Ç¢„ÉÉ„ÉóÂ†±ÈÖ¨: '+rank.goldBonus.toLocaleString()+'G';
    } else {
      bonus.textContent='Âª∫Áâ©„ÇíÂª∫„Å¶„Å¶‰∫∫Âè£„ÇíÂ¢ó„ÇÑ„Åô„Å®„Éú„Éº„Éä„ÇπËß£ÊîæÔºÅ';
    }
  }
}

// Override calcWage to include town bonus + rebirth bonus
var _baseCalcWage = calcWage;
calcWage = function(){
  return Math.round(_baseCalcWage() * (1 + getTownWageBonus()) * getRebirthWageMulti());
};

// Override buyBuilding to check town rank up
var _origBuyBld2 = buyBuilding;
buyBuilding = function(id){
  var prevRank = getTownRank().name;
  _origBuyBld2(id);
  var newRank = getTownRank();
  if(newRank.name !== prevRank && newRank.goldBonus > 0){
    setGold(getGold() + newRank.goldBonus);
    setTotalEarned(getTotalEarned() + newRank.goldBonus);
    addEventLog('üèôÔ∏è Ë°ó„É©„É≥„ÇØUPÔºÅ„Äå'+newRank.name+'„Äç +'+newRank.goldBonus+'G','awakening');
    showReward(newRank.icon,'Ë°ó„É©„É≥„ÇØ„Ç¢„ÉÉ„ÉóÔºÅ','„Äå'+newRank.name+'„Äç„Å´ÊòáÊ†ºÔºÅ\n\nüéÅ Â†±ÈÖ¨: '+newRank.goldBonus.toLocaleString()+' G\nüí∞ ÊôÇÁµ¶ +'+Math.round(newRank.wageBonus*100)+'%');
  }
  renderTownRank();
};

// Override addXP to apply housing+lifestyle+rebirth bonus
var _prevAddXP = addXP;
addXP = function(amount, blockEl){
  var housingBonus = getHousingXPBonus();
  var rebirthMulti = getRebirthXPMulti();
  var adjusted = Math.round(amount * (1 + housingBonus) * rebirthMulti);
  _prevAddXP(adjusted, blockEl);
};
// ================================================================
// LUXURY INTERIOR GACHA
// ================================================================
function luxuryGacha(){
  if(getGold()<10000){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: 10,000GÔºâ','err');return;}
  setGold(getGold()-10000);
  updateNav();renderEconomy();
  var gachaItems=INTERIOR.filter(function(i){return i.gachaOnly;});
  var owned=getOwnedInterior();
  var unowned=gachaItems.filter(function(i){return !owned.includes(i.id);});
  var el=document.getElementById('luxGachaResult');
  if(unowned.length===0){
    el.innerHTML='<div style="color:var(--amber);">ÂÖ®„Å¶„Ç≥„É≥„ÉóÊ∏à„ÅøÔºÅ +2000GËøîÈáë</div>';
    setGold(getGold()+2000);updateNav();renderEconomy();
    return;
  }
  // Weighted: rarer items less likely
  var weights=[40,30,15,10,5]; // corresponds to gachaItems order
  var totalW=0;
  unowned.forEach(function(item){
    var idx=gachaItems.indexOf(item);
    totalW+=weights[idx]||10;
  });
  var r=Math.random()*totalW;
  var winner=unowned[0];
  for(var i=0;i<unowned.length;i++){
    var idx=gachaItems.indexOf(unowned[i]);
    r-=(weights[idx]||10);
    if(r<=0){winner=unowned[i];break;}
  }
  // 50% chance of miss (get gold back partially)
  if(Math.random()<0.50){
    var refund=Math.round(1000+Math.random()*3000);
    setGold(getGold()+refund);
    el.innerHTML='<div style="color:var(--muted2);">üí® „ÅØ„Åö„Çå... +'+refund+'G ËøîÈáë</div>';
    updateNav();renderEconomy();
    return;
  }
  owned.push(winner.id);
  setOwnedInterior(owned);
  el.innerHTML='<div style="color:var(--violet);font-size:1.2rem;">'+winner.icon+' '+winner.name+'</div><div style="font-size:.65rem;color:var(--green);">XP +'+Math.round(winner.xpBonus*100)+'% Áç≤ÂæóÔºÅ</div>';
  addEventLog('üíé È´òÁ¥ö„Ç¨„ÉÅ„É£„Åß„Äå'+winner.name+'„Äç„ÇíÂÖ•ÊâãÔºÅ','awakening');
  showReward(winner.icon,'„É¨„Ç¢„Ç¢„Ç§„ÉÜ„É†ÔºÅ','„Äå'+winner.name+'„Äç„ÇíÂÖ•ÊâãÔºÅ\nXP„Éú„Éº„Éä„Çπ +'+Math.round(winner.xpBonus*100)+'%');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,winner.icon+' GET!');
  updateNav();renderEconomy();
  var ownedLabel=document.getElementById('luxGachaOwned');
  if(ownedLabel)ownedLabel.textContent=INTERIOR.filter(function(i){return i.gachaOnly&&owned.includes(i.id);}).length+'/'+gachaItems.length+' „Ç≥„É≥„Éó';
  if(curP3Tab==='life')renderLifestyle();
}

// ================================================================
// SLOT MACHINE
// ================================================================
const SLOT_SYMBOLS=['üçí','üçã','‚≠ê','üíé','7Ô∏è‚É£','üîî'];
let slotSpinning=false;

function spinSlot(){
  if(slotSpinning)return;
  if(getGold()<80){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: 80GÔºâ','err');return;}
  setGold(getGold()-80);
  updateNav();
  renderEconomy();
  slotSpinning=true;
  const reels=[0,1,2];
  const finalSymbols=reels.map(()=>SLOT_SYMBOLS[Math.floor(Math.random()*SLOT_SYMBOLS.length)]);

  // Spinning animation
  reels.forEach(i=>document.getElementById('reel'+i).classList.add('spinning'));
  let stopped=0;
  reels.forEach((r,i)=>{
    const interval=setInterval(()=>{
      document.getElementById('reel'+i).textContent=SLOT_SYMBOLS[Math.floor(Math.random()*SLOT_SYMBOLS.length)];
    },80);
    setTimeout(()=>{
      clearInterval(interval);
      document.getElementById('reel'+i).textContent=finalSymbols[i];
      document.getElementById('reel'+i).classList.remove('spinning');
      stopped++;
      if(stopped===3){
        slotSpinning=false;
        evaluateSlot(finalSymbols);
      }
    },600+i*400);
  });
  updateNav();
}

function evaluateSlot(symbols){
  const el=document.getElementById('slotResult');
  if(symbols[0]===symbols[1]&&symbols[1]===symbols[2]){
    const s=symbols[0];
    const prize=s==='7Ô∏è‚É£'?5000:s==='üíé'?2000:250;
    setGold(getGold()+prize);
    setTotalEarned(getTotalEarned()+prize);
    const big=prize>=2000;
    el.innerHTML='<div style="color:var(--gold);font-size:.9rem;font-weight:800;">üéä '+(big?'JACKPOT!!! ':'3„Å§ÊèÉ„ÅÑ! ')+'+'+prize+'G</div>';
    spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üé∞ +'+prize+'G!!');
    addEventLog('üé∞ „Çπ„É≠„ÉÉ„Éà'+(big?'„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„ÉàÔºÅ':'ÂΩì„Åü„ÇäÔºÅ')+' +'+prize+'G','money');
  } else if(symbols[0]===symbols[1]||symbols[1]===symbols[2]||symbols[0]===symbols[2]){
    setGold(getGold()+20);
    el.innerHTML='<div style="color:var(--amber);">‚ú® 2„Å§ÊèÉ„ÅÑ! +20G</div>';
  } else {
    el.innerHTML='<div style="color:var(--muted2);">ÊÆãÂøµ...Ê¨°„Åì„Åù„ÅØÔºÅ (-80G)</div>';
  }
  updateNav();
  renderEconomy();
}

// ================================================================
// ENTERTAINMENT TAB SWITCH
// ================================================================
var curEntTab='slot';
function setEntTab(tab){
  curEntTab=tab;
  ['slot','pachinko','mystery','luxgacha','loan'].forEach(function(t){
    var panel=document.getElementById('entPanel_'+t);
    var btn=document.getElementById('entTab_'+t);
    if(panel)panel.style.display=t===tab?'':'none';
    if(btn){btn.style.background=t===tab?'var(--s3)':'var(--s2)';btn.style.borderColor=t===tab?(t==='slot'?'var(--orange)':t==='pachinko'?'#c084fc':t==='mystery'?'var(--cyan)':t==='loan'?'#4ade80':'var(--violet)'):'var(--border)';btn.style.color=t===tab?(t==='slot'?'var(--orange)':t==='pachinko'?'#c084fc':t==='mystery'?'var(--cyan)':t==='loan'?'#4ade80':'var(--violet)'):'var(--text)';}
  });
  if(tab==='mystery')renderMysteryCollection();
  if(tab==='loan')renderLoanUI();
}

// ================================================================
// FORTUNE MACHINE SYSTEM („Éï„Ç£„Éº„Éê„Éº„ÉªÊôÇÁü≠„É´„Éº„É´)
// ================================================================
var pachinkoSpinning=false;
function getPachinkoState(){return ls_get('pachinko_state')||{mode:'normal',jitan:0,chain:0};}
function setPachinkoState(s){ls_set('pachinko_state',s);}
var PACHINKO_NUMS=['1','2','3','4','5','6','7','8','9'];

var pachiMiniMode=false;
function playPachinko(mini){
  if(pachinkoSpinning)return;
  pachiMiniMode=!!mini;
  var scale=mini?0.1:1;
  var state=getPachinkoState();
  var cost=Math.round(((state.mode==='kakuhen'&&state.jitan>0)?50:100)*scale);
  if(getGold()<cost){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: '+cost+'GÔºâ','err');return;}
  setGold(getGold()-cost);
  updateNav();renderEconomy();
  pachinkoSpinning=true;
  document.getElementById('pachinkoBtn').disabled=true;
  document.getElementById('pachinkoResult').textContent='';

  // Determine outcome
  var hitRate=state.mode==='kakuhen'?3:10; // 1/3 vs 1/10
  var isHit=Math.random()*hitRate<1;

  // Pick drums
  var d0=PACHINKO_NUMS[Math.floor(Math.random()*PACHINKO_NUMS.length)];
  var d1,d2;
  if(isHit){
    d1=d0;d2=d0; // triple
  } else {
    // Reach (2 match) ~30% of time on miss
    if(Math.random()<0.3){
      d1=d0;
      do{d2=PACHINKO_NUMS[Math.floor(Math.random()*PACHINKO_NUMS.length)];}while(d2===d0);
    } else {
      do{d1=PACHINKO_NUMS[Math.floor(Math.random()*PACHINKO_NUMS.length)];}while(d1===d0);
      d2=PACHINKO_NUMS[Math.floor(Math.random()*PACHINKO_NUMS.length)];
    }
  }

  // Animate pachinko ball on canvas
  animatePachinkoBall();

  // Spin drums
  var drums=[d0,d1,d2];
  [0,1,2].forEach(function(i){document.getElementById('pDrum'+i).classList.add('spinning');});
  var stopped=0;
  [0,1,2].forEach(function(i){
    var iv=setInterval(function(){
      document.getElementById('pDrum'+i).textContent=PACHINKO_NUMS[Math.floor(Math.random()*PACHINKO_NUMS.length)];
    },90);
    setTimeout(function(){
      clearInterval(iv);
      document.getElementById('pDrum'+i).textContent=drums[i];
      document.getElementById('pDrum'+i).classList.remove('spinning');
      stopped++;
      if(stopped===3)resolvePachinko(isHit,drums,state);
    },700+i*500);
  });
}

function animatePachinkoBall(){
  var canvas=document.getElementById('pachinkoCanvas');
  if(!canvas)return;
  var ctx=canvas.getContext('2d');
  var w=canvas.width,h=canvas.height;
  var ball={x:w/2+Math.random()*40-20,y:10,vx:Math.random()*2-1,vy:0,r:5};
  // pegs
  var pegs=[];
  for(var row=0;row<6;row++){
    var cols=row%2===0?5:4;
    for(var c=0;c<cols;c++){
      pegs.push({x:(row%2===0?30:50)+c*45,y:30+row*28});
    }
  }
  var frame=0;
  var maxFrames=60;
  function draw(){
    ctx.clearRect(0,0,w,h);
    // draw pegs
    pegs.forEach(function(p){
      ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fillStyle='rgba(192,132,252,0.4)';ctx.fill();
    });
    // physics
    ball.vy+=0.5;ball.x+=ball.vx;ball.y+=ball.vy;
    pegs.forEach(function(p){
      var dx=ball.x-p.x,dy=ball.y-p.y,dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<8){ball.vx=dx/dist*2+Math.random()-0.5;ball.vy=-Math.abs(ball.vy)*0.5;ball.y=p.y-8;}
    });
    if(ball.x<5){ball.x=5;ball.vx=Math.abs(ball.vx);}
    if(ball.x>w-5){ball.x=w-5;ball.vx=-Math.abs(ball.vx);}
    // draw ball
    ctx.beginPath();ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2);
    ctx.fillStyle='#fcd34d';ctx.shadowBlur=8;ctx.shadowColor='#fbbf24';ctx.fill();ctx.shadowBlur=0;
    frame++;
    if(frame<maxFrames&&ball.y<h-5)requestAnimationFrame(draw);
  }
  draw();
}

function resolvePachinko(isHit,drums,state){
  pachinkoSpinning=false;
  document.getElementById('pachinkoBtn').disabled=false;
  var el=document.getElementById('pachinkoResult');
  var scale=pachiMiniMode?0.1:1;

  if(isHit){
    var num=parseInt(drums[0]);
    var prize;
    if(num===7) prize=2500;
    else if(num>=5) prize=800;
    else prize=400;
    if(state.mode==='kakuhen')prize=Math.round(prize*1.2);
    prize=Math.round(prize*scale);
    setGold(getGold()+prize);
    setTotalEarned(getTotalEarned()+prize);

    // Determine kakuhen
    var newKakuhen=Math.random()<0.5;
    state.chain++;
    if(newKakuhen){
      state.mode='kakuhen';state.jitan=10;
      el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">üéä Â§ßÂΩì„Åü„ÇäÔºÅ +'+prize+'G</div><div style="color:#f472b6;font-size:.78rem;font-weight:800;margin-top:3px;">‚ú® „Éï„Ç£„Éº„Éê„ÉºÁ™ÅÂÖ•ÔºÅÔºàÊôÇÁü≠10Âõû‰ªòÔºâ</div>';
      addEventLog('üîÆ „Éï„Ç©„Éº„ÉÅ„É•„É≥Â§ßÂΩì„Åü„Çä +'+prize+'G ‚Üí „Éï„Ç£„Éº„Éê„ÉºÁ™ÅÂÖ•ÔºÅÔºà'+state.chain+'ÈÄ£„ÉÅ„É£„É≥Ôºâ','money');
    } else {
      state.mode='normal';state.jitan=0;
      el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">üéä Â§ßÂΩì„Åü„ÇäÔºÅ +'+prize+'G</div><div style="color:var(--muted2);font-size:.7rem;margin-top:3px;">ÈÄöÂ∏∏„Å´Êàª„Çã</div>';
      addEventLog('üîÆ „Éï„Ç©„Éº„ÉÅ„É•„É≥Â§ßÂΩì„Åü„Çä +'+prize+'GÔºà'+state.chain+'ÈÄ£„ÉÅ„É£„É≥Ôºâ','money');
      state.chain=0;
    }
    spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üîÆ +'+prize+'G!!');
    if(prize>=2500)showReward('üîÆ','„Éï„Ç©„Éº„ÉÅ„É•„É≥Â§ßÂΩì„Åü„ÇäÔºÅ','+'+prize+'GÁç≤ÂæóÔºÅ'+(newKakuhen?'\n‚ú® „Éï„Ç£„Éº„Éê„ÉºÁ™ÅÂÖ•ÔºÅÂ§ßÈÄ£„ÉÅ„É£„É≥„ÅÆ„ÉÅ„É£„É≥„ÇπÔºÅ':''));
  } else {
    // Miss
    if(drums[0]===drums[1]){
      // Reach miss - consolation
      var consol=Math.round(((state.mode==='kakuhen')?15:20)*scale);
      setGold(getGold()+consol);
      el.innerHTML='<div style="color:var(--amber);">„É™„Éº„ÉÅÔºÅ ÊÉú„Åó„ÅÑ... +'+consol+'G</div>';
    } else {
      el.innerHTML='<div style="color:var(--muted2);">„ÅØ„Åö„Çå...</div>';
    }
    if(state.mode==='kakuhen'&&state.jitan>0){
      state.jitan--;
      if(state.jitan<=0){state.mode='normal';state.chain=0;
        el.innerHTML+='<div style="font-size:.65rem;color:var(--rose);margin-top:3px;">ÊôÇÁü≠ÁµÇ‰∫Ü ‚Üí ÈÄöÂ∏∏„É¢„Éº„Éâ„Å´Êàª„Çã</div>';
      }
    }
  }
  setPachinkoState(state);
  updatePachinkoDisplay();
  updateNav();renderEconomy();
  checkAchievements();
}

function updatePachinkoDisplay(){
  var state=getPachinkoState();
  var modeEl=document.getElementById('pachinkoMode');
  var jitanEl=document.getElementById('pachinkoJitan');
  var chainEl=document.getElementById('pachinkoChain');
  if(modeEl){
    if(state.mode==='kakuhen'){modeEl.textContent='„Éï„Ç£„Éº„Éê„Éº‰∏≠';modeEl.style.color='#fcd34d';}
    else{modeEl.textContent='ÈÄöÂ∏∏';modeEl.style.color='var(--muted2)';}
  }
  if(jitanEl){jitanEl.textContent=state.jitan>0?state.jitan+'Âõû':'--';jitanEl.style.color=state.jitan>0?'#38bdf8':'var(--muted2)';}
  if(chainEl){chainEl.textContent=state.chain;chainEl.style.color=state.chain>0?'#f472b6':'#c084fc';}
  var btn=document.getElementById('pachinkoBtn');
  if(btn){
    var cost=(state.mode==='kakuhen'&&state.jitan>0)?50:100;
    btn.textContent='Êâì„Å§ ('+cost+'G)';
  }
}

// Machine selector
var curPachiMachine='std';
function setPachiMachine(m){
  curPachiMachine=m;
  ['std','umi','gen'].forEach(function(id){
    var p=document.getElementById('pachiPanel_'+id);
    var b=document.getElementById('pachiSel_'+id);
    if(p)p.style.display=id===m?'':'none';
    if(b)b.classList.toggle('active',id===m);
  });
  if(m==='umi')updateUmiDisplay();
  if(m==='gen')updateGenDisplay();
}

// ================================================================
// FORTUNE 2: „É©„ÉÉ„Ç≠„Éº„Ç™„Éº„Ç∑„É£„É≥ („Éï„Ç£„Éº„Éê„Éº„É´„Éº„Éó„Çø„Ç§„Éó)
// ================================================================
var UMI_NUMS=['1','2','3','4','5','6','7','8','9'];
function getUmiState(){return ls_get('umi_state')||{mode:'normal',chain:0};}
function setUmiState(s){ls_set('umi_state',s);}
var umiSpinning=false;

var umiMiniMode=false;
function playUmi(mini){
  if(umiSpinning)return;
  umiMiniMode=!!mini;
  var scale=mini?0.1:1;
  var cost=Math.round((getUmiState().mode==='kakuhen'?40:80)*scale);
  var state=getUmiState();
  if(getGold()<cost){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: '+cost+'GÔºâ','err');return;}
  setGold(getGold()-cost);updateNav();renderEconomy();
  umiSpinning=true;
  document.getElementById('umiBtn').disabled=true;
  document.getElementById('umiResult').textContent='';

  // Hit rate: normal 1/320, kakuhen 1/40
  var hitRate=state.mode==='kakuhen'?40:320;
  var isHit=Math.random()*hitRate<1;
  var d0=UMI_NUMS[Math.floor(Math.random()*UMI_NUMS.length)];
  var d1,d2;
  if(isHit){d1=d0;d2=d0;}
  else{
    if(Math.random()<0.15){d1=d0;do{d2=UMI_NUMS[Math.floor(Math.random()*UMI_NUMS.length)];}while(d2===d0);}
    else{do{d1=UMI_NUMS[Math.floor(Math.random()*UMI_NUMS.length)];}while(d1===d0);d2=UMI_NUMS[Math.floor(Math.random()*UMI_NUMS.length)];}
  }
  var drums=[d0,d1,d2];
  [0,1,2].forEach(function(i){
    var iv=setInterval(function(){document.getElementById('uDrum'+i).textContent=UMI_NUMS[Math.floor(Math.random()*UMI_NUMS.length)];},90);
    setTimeout(function(){clearInterval(iv);document.getElementById('uDrum'+i).textContent=drums[i];if(i===2)resolveUmi(isHit,drums,state);},700+i*500);
  });
}

function resolveUmi(isHit,drums,state){
  umiSpinning=false;document.getElementById('umiBtn').disabled=false;
  var el=document.getElementById('umiResult');
  var scale=umiMiniMode?0.1:1;
  if(isHit){
    var num=parseInt(drums[0]);
    var prize=Math.round((num>=7?5000:num>=4?2500:1500)*scale);
    setGold(getGold()+prize);setTotalEarned(getTotalEarned()+prize);
    state.chain++;
    if(Math.random()<0.65){
      state.mode='kakuhen';
      el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">üåä Â§ßÂΩì„Åü„ÇäÔºÅ +'+prize+'G</div><div style="color:#38bdf8;font-size:.78rem;font-weight:800;">‚ú® „Éï„Ç£„Éº„Éê„ÉºÁ∂ôÁ∂öÔºÅÔºà'+state.chain+'ÈÄ£Ôºâ</div>';
      addEventLog('üåä „É©„ÉÉ„Ç≠„Éº„Ç™„Éº„Ç∑„É£„É≥ Â§ßÂΩì„Åü„Çä +'+prize+'G ‚Üí „Éï„Ç£„Éº„Éê„Éº„É´„Éº„ÉóÔºà'+state.chain+'ÈÄ£Ôºâ','money');
    } else {
      state.mode='normal';
      el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">üåä Â§ßÂΩì„Åü„ÇäÔºÅ +'+prize+'G</div><div style="color:var(--muted2);font-size:.7rem;">ÈÄöÂ∏∏„Å´Êàª„ÇãÔºà'+state.chain+'ÈÄ£Ôºâ</div>';
      addEventLog('üåä „É©„ÉÉ„Ç≠„Éº„Ç™„Éº„Ç∑„É£„É≥ Â§ßÂΩì„Åü„Çä +'+prize+'GÔºà'+state.chain+'ÈÄ£Ôºâ','money');
      state.chain=0;
    }
    spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üåä +'+prize+'G!!');
  } else {
    var consol=Math.round(10*scale);
    if(drums[0]===drums[1]){setGold(getGold()+consol);el.innerHTML='<div style="color:var(--amber);">„É™„Éº„ÉÅÔºÅ +'+consol+'G</div>';}
    else{el.innerHTML='<div style="color:var(--muted2);">„ÅØ„Åö„Çå...</div>';}
  }
  setUmiState(state);updateUmiDisplay();updateNav();renderEconomy();checkAchievements();
}

function updateUmiDisplay(){
  var s=getUmiState();
  var m=document.getElementById('umiMode'),c=document.getElementById('umiChain'),l=document.getElementById('umiLoop');
  if(m){m.textContent=s.mode==='kakuhen'?'„Éï„Ç£„Éº„Éê„Éº‰∏≠':'ÈÄöÂ∏∏';m.style.color=s.mode==='kakuhen'?'#38bdf8':'var(--muted2)';}
  if(c){c.textContent=s.chain;c.style.color=s.chain>0?'#38bdf8':'var(--muted2)';}
  if(l){l.textContent=s.mode==='kakuhen'?'Á∂ôÁ∂ö‰∏≠':'--';l.style.color=s.mode==='kakuhen'?'#4ade80':'var(--muted2)';}
  var btn=document.getElementById('umiBtn');
  if(btn)btn.textContent='Êâì„Å§ ('+(s.mode==='kakuhen'?40:80)+'G)';
}

// ================================================================
// FORTUNE 3: „Ç¥„Éº„É´„Éâ„É©„ÉÉ„Ç∑„É•
// ================================================================
var GEN_NUMS=['1','2','3','4','5','6','7','8','9'];
function getGenState(){return ls_get('gen_state')||{mode:'normal',chain:0,rush:false};}
function setGenState(s){ls_set('gen_state',s);}
var genSpinning=false;
var genMiniMode=false;

function playGen(mini){
  if(genSpinning)return;
  genMiniMode=!!mini;
  var scale=mini?0.1:1;
  var state=getGenState();
  var cost=Math.round((state.rush?30:60)*scale);
  if(getGold()<cost){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: '+cost+'GÔºâ','err');return;}
  setGold(getGold()-cost);updateNav();renderEconomy();
  genSpinning=true;
  document.getElementById('genBtn').disabled=true;
  document.getElementById('genResult').textContent='';

  // Hit rate: normal 1/199, rush 1/8
  var hitRate=state.rush?8:199;
  var isHit=Math.random()*hitRate<1;
  var d0=GEN_NUMS[Math.floor(Math.random()*GEN_NUMS.length)];
  var d1,d2;
  if(isHit){d1=d0;d2=d0;}
  else{
    if(Math.random()<0.12){d1=d0;do{d2=GEN_NUMS[Math.floor(Math.random()*GEN_NUMS.length)];}while(d2===d0);}
    else{do{d1=GEN_NUMS[Math.floor(Math.random()*GEN_NUMS.length)];}while(d1===d0);d2=GEN_NUMS[Math.floor(Math.random()*GEN_NUMS.length)];}
  }
  var drums=[d0,d1,d2];
  // Fast animation for rush feel
  [0,1,2].forEach(function(i){
    var iv=setInterval(function(){document.getElementById('gDrum'+i).textContent=GEN_NUMS[Math.floor(Math.random()*GEN_NUMS.length)];},60);
    setTimeout(function(){clearInterval(iv);document.getElementById('gDrum'+i).textContent=drums[i];if(i===2)resolveGen(isHit,drums,state);},400+i*300);
  });
}

function resolveGen(isHit,drums,state){
  genSpinning=false;document.getElementById('genBtn').disabled=false;
  var el=document.getElementById('genResult');
  var scale=genMiniMode?0.1:1;
  if(isHit){
    var num=parseInt(drums[0]);
    var prize;
    if(state.rush){
      prize=Math.round((num>=7?2000:num>=4?1200:800)*scale);
      state.chain++;
      if(Math.random()<0.81){
        el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">‚ö° RUSHÂΩì„Åü„ÇäÔºÅ +'+prize+'G</div><div style="color:#fbbf24;font-size:.78rem;font-weight:800;">‚ö° RUSHÁ∂ôÁ∂öÔºÅÔºà'+state.chain+'ÈÄ£Ôºâ</div>';
        addEventLog('‚ö° „Ç¥„Éº„É´„Éâ„É©„ÉÉ„Ç∑„É•RUSH +'+prize+'GÔºà'+state.chain+'ÈÄ£„ÉÅ„É£„É≥ÔºÅÔºâ','money');
      } else {
        state.rush=false;state.mode='normal';
        el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">‚ö° ÂΩì„Åü„ÇäÔºÅ +'+prize+'G</div><div style="color:var(--rose);font-size:.7rem;">RUSHÁµÇ‰∫ÜÔºà'+state.chain+'ÈÄ£Ôºâ</div>';
        addEventLog('‚ö° „Ç¥„Éº„É´„Éâ„É©„ÉÉ„Ç∑„É• +'+prize+'G RUSHÁµÇ‰∫ÜÔºà'+state.chain+'ÈÄ£Ôºâ','money');
        state.chain=0;
      }
    } else {
      prize=Math.round((num>=7?1000:num>=4?500:300)*scale);
      if(Math.random()<0.30){
        state.rush=true;state.mode='rush';state.chain=1;
        el.innerHTML='<div style="color:#fcd34d;font-size:1rem;font-weight:900;">‚ö° Â§ßÂΩì„Åü„ÇäÔºÅ +'+prize+'G</div><div style="color:#fbbf24;font-size:.85rem;font-weight:900;">üî• RUSHÁ™ÅÂÖ•ÔºÅÔºÅ ÁàÜÈÄüÈÄ£„ÉÅ„É£„É≥STARTÔºÅ</div>';
        addEventLog('‚ö° „Ç¥„Éº„É´„Éâ„É©„ÉÉ„Ç∑„É• Â§ßÂΩì„Åü„Çä +'+prize+'G ‚Üí RUSHÁ™ÅÂÖ•ÔºÅÔºÅ','money');
      } else {
        el.innerHTML='<div style="color:#fcd34d;font-size:.9rem;font-weight:800;">ÂΩì„Åü„ÇäÔºÅ +'+prize+'G</div><div style="color:var(--muted2);font-size:.65rem;">RUSHÁ™ÅÂÖ•„Å™„Çâ„Åö‚Ä¶</div>';
        addEventLog('‚ö° „Ç¥„Éº„É´„Éâ„É©„ÉÉ„Ç∑„É• ÂΩì„Åü„Çä +'+prize+'GÔºàRUSHÁ™ÅÂÖ•„Åõ„ÅöÔºâ','money');
      }
    }
    setGold(getGold()+prize);setTotalEarned(getTotalEarned()+prize);
    spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'‚ö° +'+prize+'G!!');
  } else {
    if(drums[0]===drums[1]){el.innerHTML='<div style="color:var(--amber);">„É™„Éº„ÉÅÔºÅ ÊÉú„Åó„ÅÑ...</div>';}
    else{el.innerHTML='<div style="color:var(--muted2);">„ÅØ„Åö„Çå...</div>';}
  }
  setGenState(state);updateGenDisplay();updateNav();renderEconomy();checkAchievements();
}

function updateGenDisplay(){
  var s=getGenState();
  var m=document.getElementById('genMode'),c=document.getElementById('genChain'),r=document.getElementById('genRush');
  if(m){m.textContent=s.rush?'RUSH‰∏≠':'ÈÄöÂ∏∏';m.style.color=s.rush?'#fbbf24':'var(--muted2)';}
  if(c){c.textContent=s.chain;c.style.color=s.chain>0?'#fbbf24':'var(--muted2)';}
  if(r){r.textContent=s.rush?'Á∂ôÁ∂ö‰∏≠':'--';r.style.color=s.rush?'#fb7185':'var(--muted2)';}
  var btn=document.getElementById('genBtn');
  if(btn)btn.textContent='Êâì„Å§ ('+(s.rush?30:60)+'G)';
}

// ================================================================
// MYSTERY GACHA (123 items collection)
// ================================================================
var MYSTERY_ITEMS=[];
(function(){
  var pool=[
    ['ü™®','Ë¨é„ÅÆÁü≥','„Å™„Çì„ÅÆÂ§âÂì≤„ÇÇ„Å™„ÅÑÁü≥„ÄÇ„Åß„ÇÇ‰Ωï„ÅãÊÑü„Åò„Çã„ÄÇ'],['üß≤','Á£ÅÁü≥„ÅÆ„Åã„Åë„Çâ','NÊ•µ„Åó„Åã„Å™„ÅÑ‰∏çÊÄùË≠∞„Å™Á£ÅÁü≥„ÄÇ'],['ü™∂','Ë¶ãË¶ö„Åà„ÅÆ„Å™„ÅÑÁæΩ','„Å©„ÅÆÈ≥•„ÅÆ„ÇÇ„ÅÆ„Åß„ÇÇ„Å™„ÅÑ„ÄÇ'],['ü´ß','Ê∞∏ÈÅ†„ÅÆ„Ç∑„É£„Éú„É≥Áéâ','Ââ≤„Çå„Å™„ÅÑ„Çâ„Åó„ÅÑ„ÄÇÊú¨ÂΩìÔºü'],['üçÑ','ÂÖâ„Çã„Ç≠„Éé„Ç≥','ÊöóÈóá„ÅßÊ∑°„ÅèÂÖâ„Çã„ÄÇÈ£ü„Åπ„Åü„ÇâÂç±Èô∫„ÄÇ'],
    ['ü¶∑','Âè§‰ª£„ÅÆÊ≠Ø','Ë™∞„ÅÆ„Å†„Çç„ÅÜ...ÊÅêÁ´úÔºü'],['üî©','ÈåÜ„Å≥„Åü„Éç„Ç∏','‰Ωï„Åã„ÅÆÈÉ®ÂìÅ„Å†„Å£„Åü„ÅØ„Åö„ÄÇ'],['üß©','Ëø∑Â≠ê„ÅÆ„Éî„Éº„Çπ','„Å©„ÅÆ„Éë„Ç∫„É´„Å´„ÇÇÂêà„Çè„Å™„ÅÑ„ÄÇ'],['üé™','„Éü„Éã„Çµ„Éº„Ç´„Çπ„ÉÜ„É≥„Éà','Êâã„ÅÆ„Å≤„Çâ„Çµ„Ç§„Ç∫„ÄÇ‰∏≠„ÇíË¶ó„Åè„Å®...'],['ü™Ñ','Êäò„Çå„ÅüÈ≠îÊ≥ï„ÅÆÊùñ','ÂÖàÁ´Ø„Åå„Å°„Çá„Å£„Å®ÂÖâ„Çã„ÄÇ'],
    ['üìé','ÊúÄÂº∑„ÅÆ„ÇØ„É™„ÉÉ„Éó','‰ºùË™¨„ÅÆÊñáÊàøÂÖ∑„ÄÇ'],['üßä','Ê∫∂„Åë„Å™„ÅÑÊ∞∑','Â∏∏Ê∏©„Åß„ÇÇÂõ∫‰Ωì„ÅÆ„Åæ„Åæ„ÄÇ'],['ü™û','ÈÄÜ„ÅïÈè°','Êò†„Å£„Åü„ÇÇ„ÅÆ„ÅåÂÖ®ÈÉ®ÈÄÜ„ÄÇ'],['üéê','ÁÑ°Èü≥„ÅÆÈ¢®Èà¥','È¢®„ÅåÂêπ„ÅÑ„Å¶„ÇÇÈ≥¥„Çâ„Å™„ÅÑ„ÄÇ'],['üßÉ','Á©∫„ÅÆ„Ç∏„É•„Éº„ÇπÁÆ±','„Åß„ÇÇ„Å™„Åú„ÅãÈáç„ÅÑ„ÄÇ'],
    ['ü™Ö','Ë∏ä„Çã„Åì„Åë„Åó','Â§ú‰∏≠„Å´Âãï„Åè„Å®„ÅÑ„ÅÜÂôÇ„ÄÇ'],['üé≠','ÂçäÂàÜ„ÅÆ‰ªÆÈù¢','„ÇÇ„ÅÜÂçäÂàÜ„ÅØ„Å©„Åì„Å´Ôºü'],['üß∏','ÁâáÁõÆ„ÅÆ„ÇØ„Éû','ÁâáÁõÆ„Å†„Åë„Ç¶„Ç§„É≥„ÇØ„Åó„Å¶„Çã„ÄÇ'],['üé†','Âõû„Çâ„Å™„ÅÑ„É°„É™„Éº„Ç¥„Éº„É©„Ç¶„É≥„Éâ','ÁΩÆÁâ©„Çµ„Ç§„Ç∫„ÄÇÊôÇ„ÄÖÂõû„Çã„ÄÇ'],['ü™Ü','Â∫ï„Å™„Åó„Éû„Éà„É™„Éß„Éº„Ç∑„Ç´','Èñã„Åë„Å¶„ÇÇÈñã„Åë„Å¶„ÇÇ...'],
    ['üîÆ','Êõá„Çä„ÅÆÊ∞¥Êô∂Áéâ','ÈÅéÂéª„Å†„ÅëË¶ã„Åà„Çã„ÄÇ'],['üïØÔ∏è','Ê∂à„Åà„Å™„ÅÑËùãÁá≠','ÁÅ´„Çí„Å§„Åë„Å™„Åè„Å¶„ÇÇÂÖâ„Çã„ÄÇ'],['ü™§','ÂÑ™„Åó„ÅÑ„Éç„Ç∫„ÉüÊçï„Çä','Êåü„Åæ„Çå„Çã„Å®Ê∞óÊåÅ„Å°„ÅÑ„ÅÑ„ÄÇ'],['üßø','ÈÄÜ„Éä„Ç∂„Éº„É´','Âπ∏ÈÅã„ÇíÂê∏„ÅÑÂèñ„ÇãÁõÆ„ÄÇ'],['üéã','ÊûØ„Çå„Å™„ÅÑÁ¨π','È°ò„ÅÑ„ÅØÂè∂„Çè„Å™„ÅÑ„Åë„Å©ÊûØ„Çå„Å™„ÅÑ„ÄÇ'],
    ['ü™É','Êàª„Å£„Å¶„Åì„Å™„ÅÑ„Éñ„Éº„É°„É©„É≥','Êäï„Åí„Åü„ÇâË°åÊñπ‰∏çÊòé„ÄÇ'],['üè∫','Â∫ï„ÅÆ„Å™„ÅÑÂ£∫','‰Ωï„ÇíÂÖ•„Çå„Å¶„ÇÇÊ∂à„Åà„Çã„ÄÇ'],['ü™¨','ÊÑèÂë≥‰∏çÊòé„ÅÆ„ÅäÂÆà„Çä','ÂäπÊûú‰∏çÊòé„Å†„ÅåÈ´òÁ¥öÊÑü„ÅØ„ÅÇ„Çã„ÄÇ'],['üß≤','ÂèçÁô∫„Åô„ÇãÁ£ÅÁü≥','ÂÖ®„Å¶„ÇíÊäº„ÅóËøî„Åô„ÄÇ'],['üéø','Á†ÇÊº†Áî®„Çπ„Ç≠„ÉºÊùø','„Å™„Åú„ÅãÁ†Ç„ÅÆ‰∏ä„ÇíÊªë„Çå„Çã„ÄÇ'],
    ['ü™ô','Ë°®„Åó„Åã„Å™„ÅÑ„Ç≥„Ç§„É≥','Ë£è„Åå„Å™„ÅÑ„ÄÇË≥≠„Åë„Å´ÊúÄÈÅ©„ÄÇ'],['üßµ','Âàá„Çå„Å™„ÅÑÁ≥∏','„Åß„ÇÇÈáù„ÅØÈÄö„Çâ„Å™„ÅÑ„ÄÇ'],['ü™°','Êõ≤„Åå„Å£„ÅüÈáù','Áõ¥Á∑ö„Å†„ÅëÁ∏´„Åà„Å™„ÅÑ„ÄÇ'],['üß∂','Ëß£„Åë„Å™„ÅÑÊØõÁ≥∏Áéâ','Á∑®„ÇÇ„ÅÜ„Å®„Åô„Çã„Å®Âõ∫„Åæ„Çã„ÄÇ'],['ü™¢','Ê∞∏‰πÖÁµê„Å≥','Áµê„Çì„Å†„Çâ‰∫åÂ∫¶„Å®Ëß£„Åë„Å™„ÅÑ„ÄÇ'],
    ['üß≤','ÊµÆ„ÅèÁü≥','Ê∞¥„Å´ÂÖ•„Çå„Çã„Å®ÊµÆ„Åã„Å∂„ÄÇ'],['ü™®','Êüî„Çâ„Åã„ÅÑÁü≥','Ëß¶„Çã„Å®„Å∑„Å´„Å∑„Å´„ÄÇ'],['üß±','ÈÄèÊòé„Å™„É¨„É≥„Ç¨','Ë¶ã„Åà„Å™„ÅÑ„Åë„Å©Á¢∫„Åã„Å´„ÅÇ„Çã„ÄÇ'],['ü™µ','Ê≠å„ÅÜÊú®Áâá','ËÄ≥„ÇíÂΩì„Å¶„Çã„Å®Ê≠å„ÅåËÅû„Åì„Åà„Çã„ÄÇ'],['ü™∏','Èô∏„ÅÆ„Çµ„É≥„Ç¥','Âúü„ÅÆ‰∏ä„ÅßËÇ≤„Å§„ÄÇ'],
    ['ü´ß','Âõ∫„ÅÑ„Ç∑„É£„Éú„É≥Áéâ','„Éë„É≥„ÉÅ„Åó„Å¶„ÇÇÂâ≤„Çå„Å™„ÅÑ„ÄÇ'],['üéà','Ê≤à„ÇÄÈ¢®Ëàπ','„Éò„É™„Ç¶„É†„Å™„ÅÆ„Å´ËêΩ„Å°„Çã„ÄÇ'],['üßä','ÁÜ±„ÅÑÊ∞∑','Ëß¶„Çã„Å®Ê∏©„Åã„ÅÑ„ÄÇ'],['üî•','ÂÜ∑„Åü„ÅÑÁÇé','Êâã„Çí„Åã„Åñ„Åô„Å®Ê∂º„Åó„ÅÑ„ÄÇ'],['üíß','‰πæ„ÅÑ„ÅüÊ∞¥Êª¥','Êø°„Çå„Å™„ÅÑÊ∞¥„ÄÇ'],
    ['üå™Ô∏è','Áì∂Ë©∞„ÇÅ„ÅÆÁ´úÂ∑ª','Èñã„Åë„Çã„Å®ÈÉ®Â±ã„ÅåÊï£„Çâ„Åã„Çã„ÄÇ'],['‚õàÔ∏è','Èõ∑„ÅÆ„Åã„Åë„Çâ','ÈùôÈõªÊ∞ó„Åå„Åô„Åî„ÅÑ„ÄÇ'],['üåà','ÁôΩÈªí„ÅÆËôπ','„É¢„Éé„ÇØ„É≠„Å†„Åë„Å©Ëôπ„ÄÇ'],['‚òÅÔ∏è','Èáç„ÅÑÈõ≤','Êâã„Å´ÊåÅ„Å§„Å®„Åö„Å£„Åó„Çä„ÄÇ'],['‚≠ê','ËêΩ„Å°„ÅüÊòü','„Åæ„Å†Â∞ë„ÅóÊ∏©„Åã„ÅÑ„ÄÇ'],
    ['üåô','Ê¨†„Åë„Å™„ÅÑ‰∏âÊó•Êúà','Ê∫ÄÊúà„Å´„Å™„Çâ„Å™„ÅÑ„ÄÇ'],['‚òÄÔ∏è','Â∞è„Åï„Å™Â§™ÈôΩ','Êöó„ÅÑÈÉ®Â±ã„ÇíÊòé„Çã„Åè„Åô„Çã„ÄÇ'],['ü™ê','Âçì‰∏ä„ÅÆÂúüÊòü','Ëº™„Å£„Åã„ÅåÂõû„Çã„ÄÇ'],['üåç','Âπ≥„Çâ„Å™Âú∞ÁêÉÂÑÄ','„Éï„É©„ÉÉ„Éà„Ç¢„Éº„Çπ„ÄÇ'],['üåã','„Éü„ÉãÁÅ´Â±±','ÊôÇ„ÄÖÂô¥ÁÅ´„Åô„ÇãÔºàÂÆâÂÖ®Ôºâ„ÄÇ'],
    ['üçï','Ê∞∏ÈÅ†„ÅÆ„Éî„Ç∂','È£ü„Åπ„Å¶„ÇÇÊ∏õ„Çâ„Å™„ÅÑ„ÄÇ'],['üç©','ÂõõËßí„ÅÑ„Éâ„Éº„Éä„ÉÑ','Á©¥„ÇÇÂõõËßí„ÄÇ'],['üç≥','Áîü„Å´Êàª„ÇãÁõÆÁéâÁÑº„Åç','ÂÜ∑„ÇÅ„Çã„Å®ÁîüÂçµ„Å´„ÄÇ'],['üßÅ','Ë¶ã„Åà„Å™„ÅÑ„Ç´„ÉÉ„Éó„Ç±„Éº„Ç≠','ÁæéÂë≥„Åó„ÅÑÂåÇ„ÅÑ„Å†„Åë„ÄÇ'],['üç≠','Ëæõ„ÅÑ„Ç≠„É£„É≥„Éá„Ç£','Ë¶ã„ÅüÁõÆ„ÅØÁîò„Åù„ÅÜ„ÄÇ'],
    ['üéµ','ËÅû„Åì„Åà„Å™„ÅÑÈü≥Á¨¶','ÁõÆ„Å´Ë¶ã„Åà„ÇãÈü≥Ê•Ω„ÄÇ'],['üé∂','Ëß¶„Çå„Çã„É°„É≠„Éá„Ç£','ÊâãËß¶„Çä„Åå„ÅÑ„ÅÑ„ÄÇ'],['üîî','Èü≥„ÅÆ„Å™„ÅÑÈêò','ÊåØ„Å£„Å¶„ÇÇÁÑ°Èü≥„ÄÇ'],['üé∏','Âº¶„ÅÆ„Å™„ÅÑ„ÇÆ„Çø„Éº','„Ç®„Ç¢„ÇÆ„Çø„ÉºÂ∞ÇÁî®„ÄÇ'],['ü•Å','Âè©„Åë„Å™„ÅÑ„Éâ„É©„É†','Êâã„ÅåÈÄö„ÇäÊäú„Åë„Çã„ÄÇ'],
    ['üìñ','ÁôΩÁ¥ô„ÅÆÊú¨','Ë™≠„ÇÄ„Å®Áâ©Ë™û„ÅåÊµÆ„Åã„Å∂„ÄÇ'],['üìú','Ëß£Ë™≠‰∏çËÉΩ„ÅÆÂ∑ªÁâ©','„Å©„ÅÆË®ÄË™û„Åß„ÇÇ„Å™„ÅÑ„ÄÇ'],['üóùÔ∏è','ÈçµÁ©¥„ÅÆ„Å™„ÅÑÈçµ','‰Ωï„ÇíÈñã„Åë„Çã„ÅÆ„Åã‰∏çÊòé„ÄÇ'],['üó∫Ô∏è','Á©∫ÁôΩ„ÅÆÂú∞Âõ≥','Ê≠©„Åè„Å®Êèè„Åã„Çå„Å¶„ÅÑ„Åè„ÄÇ'],['üß≠','Âòò„Å§„Åç„Ç≥„É≥„Éë„Çπ','Âçó„ÇíÊåá„Åô„ÄÇ'],
    ['‚è≥','ÈÄÜ„Åï„ÅÆÁ†ÇÊôÇË®à','Á†Ç„Åå‰∏ä„Å´ËêΩ„Å°„Çã„ÄÇ'],['‚åö','ÈÅÖ„Çå„ÇãÊôÇË®à','Â∏∏„Å´5ÂàÜÈÅÖ„ÅÑ„ÄÇ'],['üî≠','Ëøë„Åè„ÅåË¶ã„Åà„ÇãÊúõÈÅ†Èè°','ÈÅ†„Åè„ÅØË¶ã„Åà„Å™„ÅÑ„ÄÇ'],['üî¨','Â§ß„Åç„ÅèË¶ã„Åà„Å™„ÅÑÈ°ïÂæÆÈè°','Â∞è„Åï„ÅèË¶ã„Åà„Çã„ÄÇ'],['ü™ú','Áü≠„Åè„Å™„Çã„ÅØ„Åó„Åî','Áôª„Çã„Å®Á∏Æ„ÇÄ„ÄÇ'],
    ['üö™','„Å©„Åì„Åß„ÇÇ„Å™„ÅÑ„Éâ„Ç¢','Èñã„Åë„Çã„Å®Â£Å„ÄÇ'],['ü™ü','ÊôØËâ≤„ÅåÂ§â„Çè„ÇãÁ™ì','ÊØéÂõûÈÅï„ÅÜÂ†¥ÊâÄ„ÅåË¶ã„Åà„Çã„ÄÇ'],['üõó','Âãï„Åã„Å™„ÅÑ„Ç®„É¨„Éô„Éº„Çø„Éº','„Éâ„Ç¢„ÅØÈñãÈñâ„Åô„Çã„ÄÇ'],['üé¢','Âπ≥Âù¶„Å™„Ç∏„Çß„ÉÉ„Éà„Ç≥„Éº„Çπ„Çø„Éº','„Çπ„É™„É´„Çº„É≠„ÄÇ'],['üé°','Ë∂ÖÂ∞èÂûãË¶≥Ë¶ßËªä','Êåá„ÅßÂõû„Åô„ÄÇ'],
    ['üëë','Èáç„Åô„Åé„ÇãÁéãÂÜ†','È¶ñ„ÅåÈçõ„Åà„Çâ„Çå„Çã„ÄÇ'],['üëí','ÊµÆ„ÅèÂ∏ΩÂ≠ê','Ë¢´„Çã„Å®ÊµÆÈÅäÊÑü„ÄÇ'],['üß§','Âè≥ÊâãÁî®„Åå2„Å§','Â∑¶Êâã„Å´„ÅØ‰Ωø„Åà„Å™„ÅÑ„ÄÇ'],['üß£','Áü≠„Åô„Åé„Çã„Éû„Éï„É©„Éº','È¶ñ„Å´Â∑ª„Åë„Å™„ÅÑ„ÄÇ'],['üëì','‰Ωï„ÇÇË¶ã„Åà„Å™„ÅÑÁúºÈè°','Ë£ÖÁùÄ„Åô„Çã„Å®Áúü„Å£Êöó„ÄÇ'],
    ['üé®','Ëâ≤„ÅÆ„Å™„ÅÑ„Éë„É¨„ÉÉ„Éà','ÈÄèÊòé„Å™Áµµ„ÅåÊèè„Åë„Çã„ÄÇ'],['üñåÔ∏è','Êèè„Åë„Å™„ÅÑÁ≠Ü','„Ç§„É≥„ÇØ„ÇíÂºæ„Åè„ÄÇ'],['‚úèÔ∏è','Êõ∏„Åë„Å™„ÅÑÈâõÁ≠Ü','Á¥ô„ÅÆ‰∏ä„ÇíÊªë„Çã„ÄÇ'],['üìè','‰º∏Á∏Æ„Åô„ÇãÂÆöË¶è','Ê∏¨„Çã„Åü„Å≥„Å´Èï∑„Åï„ÅåÂ§â„Çè„Çã„ÄÇ'],['‚úÇÔ∏è','Âàá„Çå„Å™„ÅÑ„Éè„Çµ„Éü','„Åß„ÇÇÈü≥„ÅØ„Åô„Çã„ÄÇ'],
    ['üß≤','Êú®„ÅÆÁ£ÅÁü≥','ÈáëÂ±û„ÇíÈÅø„Åë„Çã„ÄÇ'],['ü™ù','Êõ≤„Åå„Çâ„Å™„ÅÑ„Éï„ÉÉ„ÇØ','Áúü„Å£Áõ¥„Åê„ÄÇ'],['üîß','Êüî„Çâ„Åã„ÅÑ„Çπ„Éë„Éä','Á∑†„ÇÅ„Çâ„Çå„Å™„ÅÑ„ÄÇ'],['üî®','Ë∑≥„Å≠„Çã„Éè„É≥„Éû„Éº','Èáò„ÇíÊâì„Å§„Å®È£õ„Å∂„ÄÇ'],['‚öôÔ∏è','ÈÄÜÂõûËª¢„ÅÆÊ≠ØËªä','ÂèçÂØæ„Å´Âõû„Çã„ÄÇ'],
    ['üíä','‰Ωï„ÇÇ„Åó„Å™„ÅÑËñ¨','„Éó„É©„Çª„Éú‰ª•‰∏ã„ÄÇ'],['üß™','Á©∫„ÅÆ„Éï„É©„Çπ„Ç≥','‰Ωï„ÇíÂÖ•„Çå„Å¶„ÇÇÊ∂à„Åà„Çã„ÄÇ'],['üîã','ÂÖÖÈõª„Åß„Åç„Å™„ÅÑÈõªÊ±†','ÊúÄÂàù„Åã„Çâ„Éï„É´„ÄÇ'],['üí°','Êöó„Åè„Å™„ÇãÈõªÁêÉ','„Å§„Åë„Çã„Å®Êöó„ÅÑ„ÄÇ'],['üîå','Â∑Æ„Åõ„Å™„ÅÑ„Éó„É©„Ç∞','„Å©„ÅÆ„Ç≥„É≥„Çª„É≥„Éà„Å´„ÇÇÂêà„Çè„Å™„ÅÑ„ÄÇ'],
    ['üé≤','ÂÖ®Èù¢1„ÅÆ„Çµ„Ç§„Ç≥„É≠','‰Ωï„ÇíÊåØ„Å£„Å¶„ÇÇ1„ÄÇ'],['üÉè','ÁôΩÁ¥ô„ÅÆ„Ç∏„Éß„Éº„Ç´„Éº','Â•Ω„Åç„Å™„Ç´„Éº„Éâ„Å´„Å™„Çã„ÄÇ'],['‚ôüÔ∏è','Âãï„Åã„Å™„ÅÑ„ÉÅ„Çß„Çπ„ÅÆÈßí','Áõ§‰∏ä„ÅßÂõ∫ÂÆö„Åï„Çå„Çã„ÄÇ'],['üÄÑ','Ë™≠„ÇÅ„Å™„ÅÑÈ∫ªÈõÄÁâå','Êñ∞„Åó„ÅÑÂΩπÔºü'],['üéØ','Â§ñ„Çå„Å™„ÅÑ„ÉÄ„Éº„ÉÑ','ÁöÑ„Å´Âê∏„ÅÑËæº„Åæ„Çå„Çã„ÄÇ'],
    ['üß´','Á©∫„ÅÆÂüπÈ§äÁöø','‰Ωï„ÇÇËÇ≤„Åü„Å™„ÅÑ„ÄÇ'],['ü¶†','ÂèãÂ•ΩÁöÑ„Å™Ëèå','Êå®Êã∂„Åó„Å¶„Åè„Çã„ÄÇ'],['üß¨','„Å≠„Åò„Çå„Åô„Åé„ÅüDNA','‰∏âÈáç„Çâ„Åõ„Çì„ÄÇ'],['üîé','ÈÅ†„Åè„Å™„ÇãËô´ÁúºÈè°','Â∞è„Åï„ÅèË¶ã„Åà„Çã„ÄÇ'],['ü™§','ÈÄÜ„Åï„ÅÆ„Éà„É©„ÉÉ„Éó','Ë∏è„ÇÄ„Å®È£õ„Å≥‰∏ä„Åå„Çã„ÄÇ'],
    ['üõ∏','È£õ„Å∞„Å™„ÅÑUFO','Âú∞Èù¢„ÇíËµ∞„Çã„ÄÇ'],['ü§ñ','ÈõªÊ∫ê„ÅÆ„Å™„ÅÑ„É≠„Éú„ÉÉ„Éà','„Åß„ÇÇÂãï„Åè„ÄÇ'],['üëæ','ÂèãÂ•ΩÁöÑ„Å™„Ç§„É≥„Éô„Éº„ÉÄ„Éº','ÊîªÊíÉ„Åó„Å¶„Åì„Å™„ÅÑ„ÄÇ'],['üéÉ','ÈÄöÂπ¥„Ç´„Éú„ÉÅ„É£','Â≠£ÁØÄÊÑü„Çº„É≠„ÄÇ'],['üßõ','Êó•ÁÑº„Åë„Åó„Åü„É¥„Ç°„É≥„Éë„Ç§„Ç¢','„Éì„Éº„ÉÅ„ÅåÂ•Ω„Åç„ÄÇ'],
    ['ü¶Ñ','Ëßí„ÅÆ„Å™„ÅÑ„É¶„Éã„Ç≥„Éº„É≥','„Åü„Å†„ÅÆÈ¶¨„Åß„ÅØÔºü'],['üêâ','Êâã„ÅÆ„Å≤„Çâ„Çµ„Ç§„Ç∫„ÅÆÁ´ú','ÁÅ´„ÅØÂá∫„Å™„ÅÑ„ÄÇ'],['üçÄ','‰∫î„Å§Ëëâ„ÅÆ„ÇØ„É≠„Éº„Éê„Éº','ÈÄÜ„Å´‰∏çÂêâÔºü'],['üå∏','ÂÜ¨„Å´Âí≤„ÅèÊ°ú','Èõ™„ÅÆ‰∏≠„ÅßÊ∫ÄÈñã„ÄÇ'],['üçÇ','Á∑ë„ÅÆËêΩ„Å°Ëëâ','ËêΩ„Å°„Åü„ÅÆ„Å´Á∑ë„ÄÇ'],
    ['üóø','„Éü„Éã„É¢„Ç¢„Ç§','ÁõÆ„ÅåÂãï„ÅèÔºàÊ∞ó„Åå„Åô„ÇãÔºâ„ÄÇ'],['üèõÔ∏è','Êü±„Å†„Åë„ÅÆÁ•ûÊÆø','Â±ãÊ†π„Åå„Å™„ÅÑ„ÄÇ'],['‚öì','ÊµÆ„ÅèÈå®','Ëàπ„ÅåÊµÅ„Åï„Çå„Çã„ÄÇ'],
  ];
  for(var i=0;i<123;i++){
    var item=pool[i%pool.length];
    MYSTERY_ITEMS.push({id:'myst_'+i,emoji:item[0],name:item[1],desc:item[2]});
  }
})();

function getMysteryCollection(){return ls_get('mystery_coll')||[];}
function setMysteryCollection(v){ls_set('mystery_coll',v);}
function hasGoldenEagle(){return ls_get('golden_eagle')||false;}
function setGoldenEagle(v){ls_set('golden_eagle',v);}

function pullMysteryGacha(count){
  var cost=count===10?450:50*count;
  if(getGold()<cost){toast('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºàÂøÖË¶Å: '+cost+'GÔºâ','err');return;}
  setGold(getGold()-cost);
  updateNav();renderEconomy();

  var coll=getMysteryCollection();
  var results=[];

  // Check if 124th item (golden eagle) is unlocked and not yet obtained
  var eagleUnlocked=(coll.length>=123 && !hasGoldenEagle());

  for(var i=0;i<count;i++){
    // If eagle is unlocked, roll 1/124 chance
    if(eagleUnlocked && Math.random()<(1/124)){
      setGoldenEagle(true);
      setGold(getGold()+1240000);
      setTotalEarned(getTotalEarned()+1240000);
      results.push({item:{id:'myst_eagle',emoji:'ü¶Ö',name:'„Éà„É™„Éó„É´„Ç§„Éº„Ç∞„É´ÈáëË≤®',desc:'‰ºùË™¨„ÅÆÈáëË≤®„ÄÇ124‰∏áG„ÅÆ‰æ°ÂÄ§„Åå„ÅÇ„Çã„ÄÇ'},isNew:true,isEagle:true});
      eagleUnlocked=false; // only once
      addEventLog('ü¶Ö „Éà„É™„Éó„É´„Ç§„Éº„Ç∞„É´ÈáëË≤®„ÇíÂÖ•ÊâãÔºÅ +1,240,000GÔºÅÔºÅ','awakening');
      continue;
    }
    var item=MYSTERY_ITEMS[Math.floor(Math.random()*MYSTERY_ITEMS.length)];
    if(!coll.includes(item.id)){
      coll.push(item.id);
      results.push({item:item,isNew:true});
    } else {
      results.push({item:item,isNew:false});
    }
  }
  setMysteryCollection(coll);

  var gc=(ls_get('gacha_count')||0)+count;
  ls_set('gacha_count',gc);

  var display=document.getElementById('mysteryGachaDisplay');
  var resultEl=document.getElementById('mysteryGachaResult');
  var newCount=results.filter(function(r){return r.isNew;}).length;
  var dupeCount=count-newCount;
  var refund=dupeCount*15;
  if(refund>0){setGold(getGold()+refund);updateNav();renderEconomy();}

  // Check for eagle in results
  var eagleResult=results.find(function(r){return r.isEagle;});

  if(count===1){
    var r=results[0];
    display.textContent=r.item.emoji;
    display.style.borderColor=r.isEagle?'#fcd34d':r.isNew?'var(--cyan)':'var(--muted)';
    display.style.boxShadow=r.isEagle?'0 0 30px rgba(252,211,77,.5)':r.isNew?'0 0 20px rgba(0,212,255,.3)':'none';
    if(r.isEagle){
      resultEl.innerHTML='<div style="color:#fcd34d;font-weight:800;font-size:1rem;">ü¶Ö „Éà„É™„Éó„É´„Ç§„Éº„Ç∞„É´ÈáëË≤®ÔºÅÔºÅ</div><div style="color:#4ade80;font-weight:700;">+1,240,000G Áç≤ÂæóÔºÅ</div>';
    } else {
      resultEl.innerHTML=r.isNew
        ?'<div style="color:var(--cyan);font-weight:700;">NEW! '+r.item.emoji+' '+r.item.name+'</div><div style="font-size:.65rem;color:var(--muted2);">'+r.item.desc+'</div>'
        :'<div style="color:var(--muted2);">„ÉÄ„Éñ„Çä... '+r.item.emoji+' '+r.item.name+' (+15GËøîÈáë)</div>';
    }
  } else {
    display.textContent=eagleResult?'ü¶Ö':'üéÅ';
    display.style.borderColor=eagleResult?'#fcd34d':'var(--cyan)';
    display.style.boxShadow=eagleResult?'0 0 30px rgba(252,211,77,.5)':'0 0 20px rgba(0,212,255,.2)';
    var html='<div style="font-size:.72rem;margin-bottom:4px;color:var(--cyan);font-weight:700;">10ÈÄ£ÁµêÊûú: NEW '+newCount+'Á®Æ'+(dupeCount>0?' / „ÉÄ„Éñ„Çä '+dupeCount+'Á®Æ (+'+refund+'G)':'')+'</div>';
    if(eagleResult)html+='<div style="color:#fcd34d;font-weight:800;font-size:.9rem;margin:4px 0;">ü¶Ö „Éà„É™„Éó„É´„Ç§„Éº„Ç∞„É´ÈáëË≤®ÔºÅ +1,240,000GÔºÅÔºÅ</div>';
    html+='<div style="display:flex;flex-wrap:wrap;justify-content:center;gap:3px;">';
    results.forEach(function(r){
      html+='<span title="'+r.item.name+'" style="font-size:1.1rem;opacity:'+(r.isNew?'1':'0.35')+';'+(r.isNew?'text-shadow:0 0 6px rgba(0,212,255,.5);':'')+(r.isEagle?'text-shadow:0 0 10px rgba(252,211,77,.8);':'')+'">'+r.item.emoji+'</span>';
    });
    html+='</div>';
    resultEl.innerHTML=html;
  }

  if(newCount>0){
    addEventLog('üéÅ „Éä„Çæ„Ç¨„ÉÅ„É£„Åß'+newCount+'Á®Æ„ÅÆÊñ∞„Ç¢„Ç§„ÉÜ„É†ÂÖ•ÊâãÔºÅÔºà'+coll.length+'/123Ôºâ','money');
    if(coll.length>=123 && !hasGoldenEagle()){
      addEventLog('üèÜ „Éä„Çæ„Ç¨„ÉÅ„É£ÂÖ®123Á®Æ„Ç≥„É≥„Éó„É™„Éº„ÉàÔºÅ 124Áï™ÁõÆ„ÅåËß£Êîæ„Åï„Çå„Åü...','awakening');
      toast('üèÜ ÂÖ®123Á®Æ„Ç≥„É≥„ÉóÔºÅ 124Áï™ÁõÆ„ÅÆ„Äå???„Äç„ÅåÂá∫ÁèæÔºÅ 1/124„ÅÆÁ¢∫Áéá„ÅßÊäΩÈÅ∏...');
    }
  }

  updateNav();renderEconomy();
  renderMysteryCollection();
  checkAchievements();
}

function renderMysteryCollection(){
  var coll=getMysteryCollection();
  var countEl=document.getElementById('mysteryCollCount');
  var barEl=document.getElementById('mysteryCollBar');
  var gridEl=document.getElementById('mysteryCollGrid');
  var totalItems=123+(coll.length>=123?1:0);
  if(countEl)countEl.textContent=coll.length+(hasGoldenEagle()?'+1':'')+' / '+totalItems;
  if(barEl)barEl.style.width=Math.round((coll.length+(hasGoldenEagle()?1:0))/totalItems*100)+'%';
  if(gridEl){
    var html=MYSTERY_ITEMS.map(function(item,idx){
      var owned=coll.includes(item.id);
      return '<div onclick="'+(owned?"showMysteryDetail("+idx+")":"")+'" style="width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:1rem;background:'+(owned?'var(--s2)':'var(--s1)')+';border:1px solid '+(owned?'rgba(0,212,255,.3)':'var(--border)')+';border-radius:6px;opacity:'+(owned?'1':'0.2')+';cursor:'+(owned?'pointer':'default')+';transition:transform .1s;'+(owned?'':'')+'\" onmouseenter="this.style.transform=\'scale(1.15)\'" onmouseleave="this.style.transform=\'scale(1)\'">'+(owned?item.emoji:'?')+'</div>';
    }).join('');
    // 124th item: Golden Eagle
    if(coll.length>=123){
      var eagleOwned=hasGoldenEagle();
      html+='<div onclick="'+(eagleOwned?"showMysteryDetail(-1)":"")+'" style="width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-size:1rem;background:'+(eagleOwned?'linear-gradient(135deg,#78350f,#92400e)':'var(--s1)')+';border:2px solid '+(eagleOwned?'rgba(252,211,77,.6)':'rgba(252,211,77,.2)')+';border-radius:6px;opacity:'+(eagleOwned?'1':'0.5')+';cursor:'+(eagleOwned?'pointer':'default')+';'+(eagleOwned?'box-shadow:0 0 8px rgba(252,211,77,.3);':'')+'">'+(eagleOwned?'ü¶Ö':'‚ùì')+'</div>';
    }
    gridEl.innerHTML=html;
  }
}

function showMysteryDetail(idx){
  var item;
  if(idx===-1){
    item={emoji:'ü¶Ö',name:'„Éà„É™„Éó„É´„Ç§„Éº„Ç∞„É´ÈáëË≤®',desc:'‰ºùË™¨„ÅÆÈáëË≤®„ÄÇ124‰∏áG„ÅÆ‰æ°ÂÄ§„Åå„ÅÇ„Çã„ÄÇ1/124„ÅÆÂ•áË∑°„ÇíÂºï„ÅçÂΩì„Å¶„ÅüË®º„ÄÇ'};
  } else {
    item=MYSTERY_ITEMS[idx];
  }
  if(!item)return;
  // Show detail popup
  var el=document.getElementById('mysteryDetailPopup');
  if(!el){
    el=document.createElement('div');
    el.id='mysteryDetailPopup';
    el.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:200;display:flex;align-items:center;justify-content:center;';
    el.onclick=function(e){if(e.target===el)el.style.display='none';};
    document.body.appendChild(el);
  }
  el.style.display='flex';
  el.innerHTML='<div style="background:#111827;border:1px solid '+(idx===-1?'rgba(252,211,77,.4)':'rgba(0,212,255,.3)')+';border-radius:16px;padding:28px;text-align:center;max-width:280px;width:90%;">'+
    '<div style="font-size:3.5rem;margin-bottom:8px;">'+item.emoji+'</div>'+
    '<div style="font-size:1rem;font-weight:800;color:'+(idx===-1?'#fcd34d':'var(--cyan)')+';margin-bottom:6px;">'+item.name+'</div>'+
    '<div style="font-size:.75rem;color:var(--muted2);line-height:1.6;">'+item.desc+'</div>'+
    '<div style="font-size:.6rem;color:var(--muted);margin-top:10px;">No.'+(idx===-1?'124':(idx+1))+' / '+(idx===-1?'124':'123')+'</div>'+
    '<button onclick="document.getElementById(\'mysteryDetailPopup\').style.display=\'none\'" style="margin-top:12px;padding:6px 20px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--text);font-size:.7rem;cursor:pointer;">Èñâ„Åò„Çã</button>'+
  '</div>';
}

// ================================================================
// TODO GOAL SYSTEM
// ================================================================
function getTodos(){return ls_get('todo_goals')||[];}
function setTodos(v){ls_set('todo_goals',v);}

function openAddTodo(){
  document.getElementById('todoAddForm').style.display='block';
  document.getElementById('todoTitle').value='';
  document.getElementById('todoDesc').value='';
  document.getElementById('todoTitle').focus();
}

function addTodoItem(){
  var title=document.getElementById('todoTitle').value.trim();
  if(!title){toast('„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  var desc=document.getElementById('todoDesc').value.trim();
  var xp=parseInt(document.getElementById('todoXP').value)||500;
  var todos=getTodos();
  todos.push({id:Date.now(),title:title,desc:desc,xp:xp,done:false,createdAt:todayStr()});
  setTodos(todos);
  document.getElementById('todoAddForm').style.display='none';
  toast('üìã ÁõÆÊ®ô„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
  renderTodos();
}

function completeTodo(id){
  var todos=getTodos();
  var todo=todos.find(function(t){return t.id===id;});
  if(!todo||todo.done)return;
  if(!confirm('„Äå'+todo.title+'„Äç„ÇíÈÅîÊàêÊ∏à„Åø„Å´„Åó„Åæ„Åô„ÅãÔºü\n+'+todo.xp+' XP „Åå„ÇÇ„Çâ„Åà„Åæ„ÅôÔºÅ'))return;
  todo.done=true;
  todo.doneAt=todayStr();
  setTodos(todos);
  addXPRaw(todo.xp);
  addEventLog('üìã ÁõÆÊ®ôÈÅîÊàêÔºÅ„Äå'+todo.title+'„Äç +'+todo.xp+' XP','awakening');
  toast('üéâ ÁõÆÊ®ôÈÅîÊàêÔºÅ +'+todo.xp+' XPÔºÅ');
  spawnFloatXP(window.innerWidth/2,window.innerHeight/2,'üìã +'+todo.xp+'XP');
  updateNav();
  renderTodos();
}

function deleteTodo(id){
  if(!confirm('„Åì„ÅÆÁõÆÊ®ô„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü'))return;
  var todos=getTodos().filter(function(t){return t.id!==id;});
  setTodos(todos);
  renderTodos();
}

function renderTodos(){
  var todos=getTodos();
  var el=document.getElementById('todoList');
  var countEl=document.getElementById('todoCount');
  var active=todos.filter(function(t){return !t.done;});
  var done=todos.filter(function(t){return t.done;});
  if(countEl)countEl.textContent=active.length+'ÂÄã„ÅÆÁõÆÊ®ô'+(done.length>0?' (ÈÅîÊàê'+done.length+'ÂÄã)':'');
  if(!el)return;
  if(todos.length===0){
    el.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted);font-size:.75rem;">ÁõÆÊ®ô„ÇíËøΩÂä†„Åó„Å¶Â§ß„Åç„Å™XP„Éú„Éº„Éä„Çπ„ÇíÁç≤Âæó„Åó„Çà„ÅÜÔºÅ<br><span style="font-size:.65rem;color:var(--muted2);">‰æã: „ÄåTOEIC 800ÁÇπ„Äç„Äå‰ΩìÈáç-5kg„Äç„ÄåÊú¨„Çí10ÂÜäË™≠„ÇÄ„Äç</span></div>';
    return;
  }
  var html='';
  // Active goals
  active.forEach(function(t){
    html+='<div style="background:var(--s1);border:1px solid rgba(74,222,128,.2);border-radius:12px;padding:12px 14px;">'+
      '<div style="display:flex;align-items:center;gap:8px;">'+
        '<div style="font-size:1.2rem;cursor:pointer;" onclick="completeTodo('+t.id+')" title="ÈÅîÊàêÔºÅ">‚¨ú</div>'+
        '<div style="flex:1;">'+
          '<div style="font-size:.82rem;font-weight:700;color:var(--text);">'+t.title+'</div>'+
          (t.desc?'<div style="font-size:.62rem;color:var(--muted2);margin-top:2px;">'+t.desc+'</div>':'')+
        '</div>'+
        '<div style="text-align:right;">'+
          '<div style="font-size:.75rem;font-weight:800;color:#4ade80;font-family:JetBrains Mono,monospace;">+'+t.xp+' XP</div>'+
          '<div style="font-size:.55rem;color:var(--muted);">'+t.createdAt+'„Äú</div>'+
        '</div>'+
        '<button onclick="deleteTodo('+t.id+')" style="border:none;background:none;color:var(--muted);cursor:pointer;font-size:.7rem;padding:4px;">üóë</button>'+
      '</div>'+
    '</div>';
  });
  // Done goals
  if(done.length>0){
    html+='<div style="font-size:.65rem;color:var(--muted);margin-top:6px;">‚úÖ ÈÅîÊàêÊ∏à„Åø</div>';
    done.forEach(function(t){
      html+='<div style="background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:10px 14px;opacity:.5;">'+
        '<div style="display:flex;align-items:center;gap:8px;">'+
          '<div style="font-size:1rem;">‚úÖ</div>'+
          '<div style="flex:1;text-decoration:line-through;font-size:.75rem;color:var(--muted);">'+t.title+'</div>'+
          '<div style="font-size:.6rem;color:var(--muted2);">+'+t.xp+'XP ÈÅîÊàê:'+t.doneAt+'</div>'+
          '<button onclick="deleteTodo('+t.id+')" style="border:none;background:none;color:var(--muted);cursor:pointer;font-size:.6rem;padding:4px;">√ó</button>'+
        '</div>'+
      '</div>';
    });
  }
  el.innerHTML=html;
}

// ================================================================
// CONSUMER FINANCE SYSTEM (Ê∂àË≤ªËÄÖÈáëËûç)
// ================================================================
function getLoanData(){return ls_get('loan_data')||{status:'none',principal:0,borrowed:0,interest:0,lastTick:null,repaid:false,approved:false,limit:50000,contractDate:null};}
function setLoanData(v){ls_set('loan_data',v);}

function getLoanInterestRate(principal){
  // Âà©ÊÅØÂà∂ÈôêÊ≥ï: 10‰∏áÊú™Ê∫Ä20%, 10‰∏á„Äú100‰∏áÊú™Ê∫Ä18%, 100‰∏á‰ª•‰∏ä15%
  if(principal<100000)return 0.20;
  if(principal<1000000)return 0.18;
  return 0.15;
}

function getLoanDailyRate(principal){
  return getLoanInterestRate(principal)/365;
}

function calcAnnualIncome(){
  // ÊôÇÁµ¶ √ó 8h √ó (365 - 100‰ºëÊó•) = Âπ¥Âèé
  var wage=calcWage();
  return wage*8*265;
}

function getLoanLimit(ld){
  if(!ld.repaid){
    return 50000; // ÂàùÂõû: 1‰∏á„Äú5‰∏á
  }
  // ËøîÊ∏àÂÆüÁ∏æ„ÅÇ„Çä: Âπ¥Âèé„ÅÆ1/3
  return Math.floor(calcAnnualIncome()/3);
}

function tickLoanInterest(){
  var ld=getLoanData();
  if(ld.status!=='active'||ld.borrowed<=0)return;
  var today=todayStr();
  if(ld.lastTick===today)return;
  var last=ld.lastTick?parseDate(ld.lastTick):parseDate(ld.contractDate);
  var now=parseDate(today);
  var days=Math.max(1,Math.round((now-last)/(1000*60*60*24)));
  var rate=getLoanDailyRate(ld.borrowed);
  var newInterest=Math.round(ld.borrowed*rate*days);
  ld.interest+=newInterest;
  ld.lastTick=today;
  
  // Monthly minimum payment check (4.5% of borrowed)
  if(!ld.lastMinPayDate) ld.lastMinPayDate=ld.contractDate;
  var lastPay=parseDate(ld.lastMinPayDate);
  var daysSinceLastPay=Math.round((now-lastPay)/(1000*60*60*24));
  if(daysSinceLastPay>=30){
    var minPay=Math.max(1,Math.ceil(ld.borrowed*0.045));
    var gold=getGold();
    if(gold>=minPay){
      // Auto-deduct minimum payment
      var intPay=Math.min(minPay,ld.interest);
      ld.interest-=intPay;
      var prinPay=minPay-intPay;
      ld.borrowed=Math.max(0,ld.borrowed-prinPay);
      setGold(gold-minPay);
      ld.lastMinPayDate=today;
      addEventLog('üè¶ Ê∂àË≤ªËÄÖÈáëËûç: ÊúÄ‰ΩéËøîÊ∏àÈ°ç '+minPay.toLocaleString()+'G „ÇíËá™ÂãïÂºï„ÅçËêΩ„Å®„Åó','money');
      toast('üè¶ ÊúÄ‰ΩéËøîÊ∏àÈ°ç '+minPay.toLocaleString()+'G „ÅåÂºï„ÅçËêΩ„Å®„Åï„Çå„Åæ„Åó„Åü');
      if(ld.borrowed<=0&&ld.interest<=0){
        ld.status='none';ld.borrowed=0;ld.interest=0;ld.repaid=true;
        ld.limit=getLoanLimit(ld);
        addEventLog('üéâ Ê∂àË≤ªËÄÖÈáëËûçÂÆåÊ∏àÔºÅ','money');
      }
    } else {
      // Cannot pay ‚Äî penalty: interest doubles for this period + warning
      if(!ld.overdueCount) ld.overdueCount=0;
      ld.overdueCount++;
      var penalty=Math.ceil(ld.borrowed*0.01*ld.overdueCount);
      ld.interest+=penalty;
      ld.lastMinPayDate=today;
      addEventLog('‚ö†Ô∏è Ê∂àË≤ªËÄÖÈáëËûç: ÊúÄ‰ΩéËøîÊ∏àÈ°ç '+minPay.toLocaleString()+'G „ÇíÊîØÊâï„Åà„ÅöÔºÅÈÅÖÂª∂ÊêçÂÆ≥Èáë +'+penalty.toLocaleString()+'G','money');
      toast('‚ö†Ô∏è ËøîÊ∏àÈÅÖÂª∂ÔºÅÈÅÖÂª∂ÊêçÂÆ≥Èáë +'+penalty.toLocaleString()+'G „ÅåÂä†ÁÆó„Åï„Çå„Åæ„Åó„Åü','err');
      // Force deduction if any gold
      if(gold>0){
        var forcePay=gold;
        var iP=Math.min(forcePay,ld.interest);
        ld.interest-=iP;
        ld.borrowed=Math.max(0,ld.borrowed-(forcePay-iP));
        setGold(0);
        addEventLog('üí∏ ÊâÄÊåÅÈáë '+forcePay.toLocaleString()+'G „ÇíÂº∑Âà∂ÂõûÂèé„Åï„Çå„Åæ„Åó„Åü','money');
      }
    }
  }
  
  setLoanData(ld);
}

function loanApply(){
  var ld=getLoanData();
  if(ld.status==='active'){toast('Êó¢„Å´ÂÄüÂÖ•‰∏≠„Åß„Åô','err');return;}
  if(ld.status==='reviewing'){toast('ÂØ©Êüª‰∏≠„Åß„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ','err');return;}
  ld.status='reviewing';
  setLoanData(ld);
  renderLoanUI();
  toast('üìã „ÅäÁî≥„ÅóËæº„Åø„ÇíÂèó„Åë‰ªò„Åë„Åæ„Åó„Åü„ÄÇCIC‰ø°Áî®ÊÉÖÂ†±„ÇíÁÖß‰ºö‰∏≠...');
  // Simulate review (3 seconds)
  setTimeout(function(){
    var ld2=getLoanData();
    if(ld2.status!=='reviewing')return;
    ld2.status='approved';
    ld2.approved=true;
    ld2.limit=getLoanLimit(ld2);
    setLoanData(ld2);
    addEventLog('üè¶ TF„Éï„Ç°„Ç§„Éä„É≥„ÇπÂØ©ÊüªÈÄöÈÅéÔºÅ ÂÄüÂÖ•Êû†: '+ld2.limit.toLocaleString()+'G','money');
    toast('‚úÖ ÂØ©ÊüªÈÄöÈÅéÔºÅ Â•ëÁ¥ÑÊâãÁ∂ö„Åç„Å´ÈÄ≤„ÇÅ„Åæ„Åô„ÄÇ');
    renderLoanUI();
  },3000);
}

function loanContract(){
  // Show inline contract form
  var ld=getLoanData();
  if(ld.status!=='approved')return;
  var limit=getLoanLimit(ld);
  var minAmt=10000;
  var maxAmt=limit;
  var actEl=document.getElementById('loanActions');
  actEl.innerHTML=
    '<div style="background:var(--s1);border:1px solid rgba(251,191,36,.3);border-radius:12px;padding:14px;margin-top:8px;">'+
      '<div style="font-size:.8rem;font-weight:700;color:#fbbf24;margin-bottom:8px;">üìù ÂÄüÂÖ•ÈáëÈ°ç„ÇíÂÖ•Âäõ</div>'+
      '<div style="font-size:.6rem;color:var(--muted);margin-bottom:6px;line-height:1.5;">'+
        'ÂÄüÂÖ•ÂèØËÉΩÈ°ç: '+minAmt.toLocaleString()+'G „Äú '+maxAmt.toLocaleString()+'G<br>'+
        'ÈÅ©Áî®ÈáëÂà©: Âπ¥'+Math.round(getLoanInterestRate(maxAmt)*100)+'%ÔºàÂà©ÊÅØÂà∂ÈôêÊ≥ïÊ∫ñÊã†Ôºâ<br>'+
        '‚Äª Á∑èÈáèË¶èÂà∂: Âπ¥Âèé('+calcAnnualIncome().toLocaleString()+'G)„ÅÆ1/3 = '+Math.floor(calcAnnualIncome()/3).toLocaleString()+'G'+
      '</div>'+
      '<div style="display:flex;gap:4px;margin-bottom:8px;"><input id="loanAmtInput" type="number" min="'+minAmt+'" max="'+maxAmt+'" value="'+Math.min(maxAmt,50000)+'" style="flex:1;padding:10px;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:1rem;font-weight:700;font-family:JetBrains Mono,monospace;box-sizing:border-box;">'+
      '<button onclick="document.getElementById(\'loanAmtInput\').value='+maxAmt+';document.getElementById(\'loanAmtInput\').oninput();" style="padding:10px 14px;border:1px solid rgba(251,191,36,.4);border-radius:8px;background:rgba(251,191,36,.15);color:#fbbf24;font-size:.75rem;font-weight:800;cursor:pointer;white-space:nowrap;">MAX</button></div>'+
      '<div id="loanAmtPreview" style="font-size:.6rem;color:var(--muted);margin-bottom:10px;"></div>'+
      '<div style="display:flex;gap:6px;">'+
        '<button onclick="loanContractConfirm()" style="flex:1;padding:10px;border:none;border-radius:8px;background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000;font-size:.8rem;font-weight:800;cursor:pointer;">Â•ëÁ¥Ñ„Åô„Çã</button>'+
        '<button onclick="renderLoanUI()" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--text);font-size:.75rem;cursor:pointer;">Êàª„Çã</button>'+
      '</div>'+
    '</div>';
  // Live preview
  var inp=document.getElementById('loanAmtInput');
  function updatePreview(){
    var v=parseInt(inp.value)||0;
    var r=getLoanInterestRate(v);
    var minP=Math.max(1,Math.ceil(v*0.045));
    document.getElementById('loanAmtPreview').innerHTML=
      'ÂÆüË≥™Âπ¥Áéá: <span style="color:#fbbf24;font-weight:700;">'+Math.round(r*100)+'%</span> | '+
      '1Êó•„ÅÇ„Åü„ÇäÂà©ÊÅØ: <span style="color:#fb7185;">Á¥Ñ'+Math.round(v*r/365).toLocaleString()+'G/Êó•</span><br>'+
      'üí≥ ÊØéÊúà„ÅÆÊúÄ‰ΩéËøîÊ∏àÈ°çÔºà4.5%Ôºâ: <span style="color:#f97316;font-weight:700;">'+minP.toLocaleString()+'G/Êúà</span>'+
      ' <span style="color:var(--muted);font-size:.55rem;">‚Äî 30Êó•„Åî„Å®„Å´Ëá™ÂãïÂºïËêΩ„ÄÇ‰∏çË∂≥ÊôÇ„ÅØÈÅÖÂª∂ÊêçÂÆ≥Èáë+Âº∑Âà∂ÂõûÂèé</span>';
  }
  inp.oninput=updatePreview;
  updatePreview();
}

function loanContractConfirm(){
  var ld=getLoanData();
  var limit=getLoanLimit(ld);
  var minAmt=10000;var maxAmt=limit;
  var inp=document.getElementById('loanAmtInput');
  var amt=parseInt(inp.value);
  if(isNaN(amt)||amt<minAmt||amt>maxAmt){toast('ÂÄüÂÖ•È°ç„ÅØ'+minAmt.toLocaleString()+'G„Äú'+maxAmt.toLocaleString()+'G„ÅÆÁØÑÂõ≤„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ','err');return;}
  var rate=getLoanInterestRate(amt);
  // Show confirmation inline
  var actEl=document.getElementById('loanActions');
  actEl.innerHTML=
    '<div style="background:var(--s1);border:2px solid rgba(251,191,36,.4);border-radius:12px;padding:16px;">'+
      '<div style="font-size:.85rem;font-weight:800;color:#fbbf24;text-align:center;margin-bottom:10px;">üìã Ë≤∏‰ªòÂ•ëÁ¥ÑÊõ∏</div>'+
      '<div style="background:var(--s2);border-radius:8px;padding:10px;margin-bottom:10px;">'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="font-size:.65rem;color:var(--muted);">Ë≤∏‰ªòÈáëÈ°ç</span><span style="font-size:.9rem;font-weight:800;color:var(--text);font-family:JetBrains Mono,monospace;">'+amt.toLocaleString()+' G</span></div>'+
        '<div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="font-size:.65rem;color:var(--muted);">ÂÆüË≥™Âπ¥Áéá</span><span style="font-size:.8rem;font-weight:700;color:#fbbf24;">'+Math.round(rate*100)+'.0%</span></div>'+
        '<div style="display:flex;justify-content:space-between;"><span style="font-size:.65rem;color:var(--muted);">1Êó•„ÅÇ„Åü„ÇäÂà©ÊÅØ</span><span style="font-size:.75rem;color:#fb7185;">Á¥Ñ'+Math.round(amt*rate/365).toLocaleString()+'G</span></div>'+
      '</div>'+
      '<div style="font-size:.5rem;color:var(--muted);line-height:1.5;margin-bottom:10px;">TF„Éï„Ç°„Ç§„Éä„É≥„ÇπÊ†™Âºè‰ºöÁ§æ<br>Ë≤∏ÈáëÊ•≠ÁôªÈå≤Áï™Âè∑ „Çø„Ç§„É†„Éï„É≠„ÉºË≤°ÂãôÂ±ÄÈï∑Ôºà3ÔºâÁ¨¨4219Âè∑</div>'+
      '<div style="display:flex;gap:6px;">'+
        '<button onclick="loanExecute('+amt+')" style="flex:1;padding:12px;border:none;border-radius:8px;background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000;font-size:.85rem;font-weight:900;cursor:pointer;">‚úÖ ÂêåÊÑè„Åó„Å¶Â•ëÁ¥Ñ</button>'+
        '<button onclick="renderLoanUI()" style="padding:12px 16px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--text);font-size:.7rem;cursor:pointer;">Êàª„Çã</button>'+
      '</div>'+
    '</div>';
}

function loanExecute(amt){
  var ld=getLoanData();
  var rate=getLoanInterestRate(amt);
  ld.status='active';
  ld.principal=amt;
  ld.borrowed=amt;
  ld.interest=0;
  ld.lastTick=todayStr();
  ld.contractDate=todayStr();
  setLoanData(ld);
  setGold(getGold()+amt);
  addEventLog('üè¶ Ê∂àË≤ªËÄÖÈáëËûç„Åã„Çâ'+amt.toLocaleString()+'GÂÄüÂÖ•ÔºàÂπ¥Áéá'+Math.round(rate*100)+'%Ôºâ','money');
  toast('üí∞ '+amt.toLocaleString()+'G „ÇíÂÄüÂÖ•„Åó„Åæ„Åó„Åü');
  updateNav();renderEconomy();renderLoanUI();
}

function loanRepay(){
  // Show inline repay form
  var ld=getLoanData();
  if(ld.status!=='active'||ld.borrowed<=0)return;
  tickLoanInterest();
  ld=getLoanData();
  var total=ld.borrowed+ld.interest;
  var gold=getGold();
  var actEl=document.getElementById('loanActions');
  actEl.innerHTML=
    '<div style="background:var(--s1);border:1px solid rgba(74,222,128,.3);border-radius:12px;padding:14px;margin-top:8px;">'+
      '<div style="font-size:.8rem;font-weight:700;color:#4ade80;margin-bottom:8px;">üí∏ ËøîÊ∏à</div>'+
      '<div style="font-size:.6rem;color:var(--muted);margin-bottom:8px;line-height:1.5;">'+
        'ÂÖÉÊú¨ÊÆãÈ´ò: <span style="color:#fb7185;font-weight:700;">'+ld.borrowed.toLocaleString()+'G</span><br>'+
        'Âà©ÊÅØ: <span style="color:#fbbf24;font-weight:700;">'+ld.interest.toLocaleString()+'G</span><br>'+
        'ËøîÊ∏àÁ∑èÈ°ç: <span style="color:#fb7185;font-weight:700;">'+total.toLocaleString()+'G</span><br>'+
        'ÊâÄÊåÅÈáë: <span style="color:var(--text);font-weight:700;">'+gold.toLocaleString()+'G</span>'+
      '</div>'+
      '<div style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px;">'+
        '<button onclick="loanRepayExec('+Math.min(gold,total)+')" style="flex:1;padding:8px;border:none;border-radius:8px;background:linear-gradient(135deg,#4ade80,#22c55e);color:#000;font-size:.72rem;font-weight:800;cursor:pointer;">ÂÖ®È°çËøîÊ∏à<br><span style="font-size:.6rem;">'+Math.min(gold,total).toLocaleString()+'G</span></button>'+
        (total>10000&&gold>=10000?'<button onclick="loanRepayExec(10000)" style="flex:1;padding:8px;border:none;border-radius:8px;background:rgba(74,222,128,.15);border:1px solid rgba(74,222,128,.3);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">10,000G<br><span style="font-size:.6rem;">‰∏ÄÈÉ®ËøîÊ∏à</span></button>':'')+
        (total>50000&&gold>=50000?'<button onclick="loanRepayExec(50000)" style="flex:1;padding:8px;border:none;border-radius:8px;background:rgba(74,222,128,.15);border:1px solid rgba(74,222,128,.3);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">50,000G<br><span style="font-size:.6rem;">‰∏ÄÈÉ®ËøîÊ∏à</span></button>':'')+
      '</div>'+
      '<div style="display:flex;gap:4px;align-items:center;margin-bottom:8px;">'+
        '<input id="loanRepayInput" type="number" min="1" max="'+Math.min(gold,total)+'" placeholder="ÈáëÈ°ç„ÇíÂÖ•Âäõ" style="flex:1;padding:8px;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:.8rem;font-family:JetBrains Mono,monospace;box-sizing:border-box;">'+
        '<button onclick="var v=parseInt(document.getElementById(\'loanRepayInput\').value);if(v>0)loanRepayExec(v);else toast(\'ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\',\'err\');" style="padding:8px 14px;border:none;border-radius:8px;background:rgba(74,222,128,.2);border:1px solid rgba(74,222,128,.3);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">ËøîÊ∏à</button>'+
      '</div>'+
      '<button onclick="renderLoanUI()" style="width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:var(--s2);color:var(--muted);font-size:.68rem;cursor:pointer;">Êàª„Çã</button>'+
    '</div>';
}

function loanRepayExec(payAmt){
  var ld=getLoanData();
  var gold=getGold();
  var total=ld.borrowed+ld.interest;
  payAmt=Math.min(payAmt,gold,total);
  if(payAmt<=0){toast('ËøîÊ∏àÈ°ç„Åå0„Åß„Åô','err');return;}
  var intPay=Math.min(payAmt,ld.interest);
  ld.interest-=intPay;
  var prinPay=payAmt-intPay;
  ld.borrowed-=prinPay;
  setGold(gold-payAmt);
  if(ld.borrowed<=0&&ld.interest<=0){
    ld.status='none';
    ld.borrowed=0;ld.interest=0;
    ld.repaid=true;
    ld.limit=getLoanLimit(ld);
    addEventLog('üéâ Ê∂àË≤ªËÄÖÈáëËûçÂÆåÊ∏àÔºÅ ÂÄüÂÖ•Êû†„ÅåÂπ¥Âèé„ÅÆ1/3„Å´Êã°Â§ß','money');
    toast('üéâ ÂÆåÊ∏àÔºÅ ÂÄüÂÖ•ÂèØËÉΩÈ°ç„Åå„Ç¢„ÉÉ„Éó„Åó„Åæ„Åó„ÅüÔºÅ');
  } else {
    toast('üí∏ '+payAmt.toLocaleString()+'GËøîÊ∏àÔºàÊÆã„ÇäÂÖÉÊú¨:'+ld.borrowed.toLocaleString()+'G / Âà©ÊÅØ:'+ld.interest.toLocaleString()+'GÔºâ');
    addEventLog('üí∏ Ê∂àË≤ªËÄÖÈáëËûç„Å∏'+payAmt.toLocaleString()+'GËøîÊ∏àÔºàÊÆã'+ld.borrowed.toLocaleString()+'GÔºâ','money');
  }
  setLoanData(ld);
  updateNav();renderEconomy();renderLoanUI();
}

function renderLoanUI(){
  tickLoanInterest();
  var ld=getLoanData();
  var statusEl=document.getElementById('loanStatus');
  var actEl=document.getElementById('loanActions');
  if(!statusEl||!actEl)return;

  var income=calcAnnualIncome();
  var limit=getLoanLimit(ld);
  var rate=ld.borrowed>0?getLoanInterestRate(ld.borrowed):0.18;

  // Status display
  if(ld.status==='active'){
    var total=ld.borrowed+ld.interest;
    var minPay=Math.max(1,Math.ceil(ld.borrowed*0.045));
    var lastMinPayDate=ld.lastMinPayDate||ld.contractDate;
    var daysSinceMinPay=Math.round((parseDate(todayStr())-parseDate(lastMinPayDate))/(1000*60*60*24));
    var daysUntilMinPay=Math.max(0,30-daysSinceMinPay);
    var overdueWarning=(ld.overdueCount&&ld.overdueCount>0)?'<div style="background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:6px 10px;margin-top:8px;font-size:.62rem;color:#fb7185;text-align:center;">‚ö†Ô∏è ËøîÊ∏àÈÅÖÂª∂ '+ld.overdueCount+'Âõû ‚Äî ÈÅÖÂª∂ÊêçÂÆ≥Èáë„ÅåÂä†ÁÆó„Åï„Çå„Å¶„ÅÑ„Åæ„Åô</div>':'';
    statusEl.innerHTML=
      '<div style="display:flex;justify-content:space-between;margin-bottom:8px;">'+
        '<div style="font-size:.65rem;color:var(--muted2);">Â•ëÁ¥ÑÁä∂Ê≥Å</div>'+
        '<div style="font-size:.65rem;color:#fb7185;font-weight:700;">ÂÄüÂÖ•‰∏≠</div>'+
      '</div>'+
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">'+
        '<div style="background:var(--s2);border-radius:8px;padding:8px;text-align:center;">'+
          '<div style="font-size:.55rem;color:var(--muted);">ÂÖÉÊú¨ÊÆãÈ´ò</div>'+
          '<div style="font-size:1rem;font-weight:800;color:#fb7185;font-family:JetBrains Mono,monospace;">'+ld.borrowed.toLocaleString()+'G</div>'+
        '</div>'+
        '<div style="background:var(--s2);border-radius:8px;padding:8px;text-align:center;">'+
          '<div style="font-size:.55rem;color:var(--muted);">Âà©ÊÅØÁ¥ØË®à</div>'+
          '<div style="font-size:1rem;font-weight:800;color:#fbbf24;font-family:JetBrains Mono,monospace;">'+ld.interest.toLocaleString()+'G</div>'+
        '</div>'+
      '</div>'+
      '<div style="background:rgba(251,191,36,.06);border:1px solid rgba(251,191,36,.2);border-radius:8px;padding:8px 10px;margin-top:8px;">'+
        '<div style="display:flex;justify-content:space-between;align-items:center;">'+
          '<div style="font-size:.62rem;color:var(--muted2);">üí≥ ÊØéÊúà„ÅÆÊúÄ‰ΩéËøîÊ∏àÈ°çÔºàÂÄüÂÖ•„ÅÆ4.5%Ôºâ</div>'+
          '<div style="font-size:.85rem;font-weight:800;color:#fbbf24;font-family:JetBrains Mono,monospace;">'+minPay.toLocaleString()+'G</div>'+
        '</div>'+
        '<div style="font-size:.55rem;color:var(--muted);margin-top:4px;">Ê¨°ÂõûÂºïËêΩ„Åæ„Åß <span style="color:'+(daysUntilMinPay<=7?'#fb7185':'var(--cyan)')+';font-weight:700;">'+daysUntilMinPay+'Êó•</span>'+
        ' ‚Äî ÊâÄÊåÅÈáë„Åã„ÇâËá™ÂãïÂºïËêΩ„Åï„Çå„Åæ„Åô„ÄÇ‰∏çË∂≥ÊôÇ„ÅØÈÅÖÂª∂ÊêçÂÆ≥Èáë„ÅåÁô∫Áîü„Åó„ÄÅÊâÄÊåÅÈáë„ÇíÂº∑Âà∂ÂõûÂèé„Åó„Åæ„Åô„ÄÇ</div>'+
      '</div>'+
      overdueWarning+
      '<div style="font-size:.6rem;color:var(--muted);margin-top:6px;text-align:center;">ËøîÊ∏àÁ∑èÈ°ç: <span style="color:#fb7185;font-weight:700;">'+total.toLocaleString()+'G</span> | Âπ¥Áéá'+Math.round(rate*100)+'% | Â•ëÁ¥ÑÊó•: '+ld.contractDate+'</div>';

    actEl.innerHTML='<button onclick="loanRepay()" style="width:100%;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#4ade80,#22c55e);color:#000;font-size:.85rem;font-weight:800;cursor:pointer;">üí∏ ËøîÊ∏à„Åô„Çã</button>';
  } else if(ld.status==='reviewing'){
    statusEl.innerHTML=
      '<div style="text-align:center;padding:16px;">'+
        '<div style="font-size:1.5rem;margin-bottom:6px;">üîç</div>'+
        '<div style="font-size:.8rem;font-weight:700;color:var(--cyan);">ÂØ©Êüª‰∏≠...</div>'+
        '<div style="font-size:.6rem;color:var(--muted);margin-top:4px;">CIC‰ø°Áî®ÊÉÖÂ†±Ê©üÈñ¢„Å´ÁÖß‰ºö‰∏≠„Åß„Åô„ÄÇ<br>Â∞ë„ÄÖ„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ</div>'+
        '<div style="margin-top:8px;height:4px;background:var(--s2);border-radius:2px;overflow:hidden;"><div style="height:100%;width:60%;background:var(--cyan);animation:pulse 1.5s ease-in-out infinite;"></div></div>'+
      '</div>';
    actEl.innerHTML='';
  } else if(ld.status==='approved'){
    statusEl.innerHTML=
      '<div style="text-align:center;padding:10px;">'+
        '<div style="font-size:1.2rem;margin-bottom:4px;">‚úÖ</div>'+
        '<div style="font-size:.8rem;font-weight:700;color:#4ade80;">ÂØ©ÊüªÈÄöÈÅé</div>'+
        '<div style="font-size:.65rem;color:var(--muted);margin-top:4px;">ÂÄüÂÖ•ÂèØËÉΩÈ°ç: <span style="color:#4ade80;font-weight:700;">'+limit.toLocaleString()+'G</span></div>'+
        '<div style="font-size:.55rem;color:var(--muted);margin-top:2px;">Âπ¥Âèé'+income.toLocaleString()+'G √ó ÊôÇÁµ¶'+calcWage().toLocaleString()+'G/h'+(ld.repaid?' (Á∑èÈáèË¶èÂà∂: Âπ¥Âèé„ÅÆ1/3)':'')+'</div>'+
      '</div>';
    actEl.innerHTML='<button onclick="loanContract()" style="width:100%;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#000;font-size:.85rem;font-weight:800;cursor:pointer;">üìù Â•ëÁ¥ÑÊâãÁ∂ö„Åç„Å∏</button>'+
      '<div style="text-align:center;margin-top:6px;font-size:.55rem;color:var(--muted);">„ÅîÂà©Áî®„ÅØË®àÁîªÁöÑ„Å´„ÄÇ</div>';
  } else {
    // Not applied
    statusEl.innerHTML=
      '<div style="text-align:center;padding:10px;">'+
        '<div style="font-size:.75rem;color:var(--muted2);margin-bottom:6px;">„ÅäÂÄüÂÖ•„ÅÆÁä∂Ê≥Å</div>'+
        (ld.repaid?
          '<div style="font-size:.65rem;color:#4ade80;">‚úÖ ÈÅéÂéª„ÅÆÂÆåÊ∏àÂÆüÁ∏æ„ÅÇ„Çä ‚Üí ÂÄüÂÖ•Êû†UP</div><div style="font-size:.6rem;color:var(--muted);margin-top:4px;">ÂÄüÂÖ•ÂèØËÉΩÈ°ç: <span style="color:#4ade80;font-weight:700;">'+limit.toLocaleString()+'G</span>ÔºàÂπ¥Âèé„ÅÆ1/3Ôºâ</div>'
          :'<div style="font-size:.65rem;color:var(--muted);">ÂàùÂõû„ÅîÂà©Áî®: 10,000G „Äú 50,000G</div>')+
      '</div>';
    actEl.innerHTML='<button onclick="loanApply()" style="width:100%;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,#059669,#10b981);color:#fff;font-size:.85rem;font-weight:800;cursor:pointer;">üìã „ÅäÁî≥„ÅóËæº„Åø</button>'+
      '<div style="text-align:center;margin-top:6px;font-size:.55rem;color:var(--muted);">„ÅîÂà©Áî®„ÅØË®àÁîªÁöÑ„Å´„ÄÇ</div>';
  }
}

// Tick loan interest on page load
function initLoanTick(){tickLoanInterest();}

// ================================================================
// ACHIEVEMENT SYSTEM
// ================================================================
const ACHIEVEMENTS = [
  {id:'ach_3day',  name:'3Êó•ÈÄ£Á∂öË®òÈå≤',      emoji:'üî•', desc:'3Êó•ÈÄ£Á∂ö„ÅßÊôÇÈñì„ÇíË®òÈå≤',    rew:'XP +50',  check:()=>calcStreak()>=3, reward:()=>addXPRaw(50)},
  {id:'ach_7day',  name:'1ÈÄ±Èñì„ÅÆÁøíÊÖ£',      emoji:'üìÖ', desc:'7Êó•ÈÄ£Á∂ö„ÅßÊôÇÈñì„ÇíË®òÈå≤',    rew:'XP +150', check:()=>calcStreak()>=7, reward:()=>addXPRaw(150)},
  {id:'ach_21day', name:'ÁøíÊÖ£„ÅÆÂÆöÁùÄ',        emoji:'üí™', desc:'21Êó•ÈÄ£Á∂ö„ÅßÊôÇÈñì„ÇíË®òÈå≤',   rew:'XP +500 & +200G', check:()=>calcStreak()>=21, reward:()=>{addXPRaw(500);setGold(getGold()+200);}},
  {id:'ach_sleep90',name:'ÂÆåÁíß„Å™Áú†„Çä',       emoji:'üåô', desc:'Áù°Áú†„Çπ„Ç≥„Ç¢90ÁÇπ‰ª•‰∏ä„ÇíË®òÈå≤',rew:'XP +100', check:()=>{const d=getDayData(todayStr());return d.sleepScore&&d.sleepScore>=90;}, reward:()=>addXPRaw(100)},
  {id:'ach_1000g', name:'ÂçÉÈáëÊåÅ„Å°',          emoji:'üí∞', desc:'Á¥ØË®à1,000GÁ®º„Åê',         rew:'XP +50',  check:()=>getTotalEarned()>=1000, reward:()=>addXPRaw(50)},
  {id:'ach_10000g',name:'‰∏áÈáëÊåÅ„Å°',          emoji:'üíé', desc:'Á¥ØË®à10,000GÁ®º„Åê',        rew:'XP +200', check:()=>getTotalEarned()>=10000, reward:()=>addXPRaw(200)},
  {id:'ach_100000g',name:'Â§ßÂØåË±™',           emoji:'üëë', desc:'Á¥ØË®à100,000GÁ®º„Åê',       rew:'+500G',   check:()=>getTotalEarned()>=100000, reward:()=>setGold(getGold()+500)},
  {id:'ach_alldom',name:'„Ç™„Éº„É´„É©„Ç¶„É≥„ÉÄ„Éº',   emoji:'‚öñÔ∏è', desc:'ÂÖ®„Éâ„É°„Ç§„É≥„Å´„Çπ„Ç≠„É´Lv2‰ª•‰∏ä',rew:'XP +300',check:()=>{return DOMAINS.every(d=>d.skills.some(s=>getSkillLevel(s)>=2));}, reward:()=>addXPRaw(300)},
  {id:'ach_1inv',  name:'Âàù„ÇÅ„Å¶„ÅÆÊäïË≥á',      emoji:'üìà', desc:'ÊúÄÂàù„ÅÆÊäïË≥á„ÇíË≥ºÂÖ•',        rew:'+100G',   check:()=>(getPortfolio().length+getREHoldings().length+getBizHoldings().length)>=1, reward:()=>setGold(getGold()+100)},
  {id:'ach_5inv',  name:'ÂàÜÊï£ÊäïË≥áÂÆ∂',        emoji:'üè¶', desc:'5„Å§„ÅÆÊäïË≥á„Çí‰øùÊúâ',         rew:'+500G',   check:()=>(getPortfolio().length+getREHoldings().length+getBizHoldings().length)>=5, reward:()=>setGold(getGold()+500)},
  {id:'ach_1bld',  name:'ÊúÄÂàù„ÅÆÂª∫Ë®≠',        emoji:'üè†', desc:'ÊúÄÂàù„ÅÆÂª∫Áâ©„ÇíÂª∫Ë®≠',        rew:'XP +50',  check:()=>getOwnedBuildings().length>=1, reward:()=>addXPRaw(50)},
  {id:'ach_castle',name:'Âüé‰∏ª',              emoji:'üè∞', desc:'Âüé„ÇíÂª∫Ë®≠„Åô„Çã',            rew:'XP +1000',check:()=>getOwnedBuildings().includes('b14'), reward:()=>addXPRaw(1000)},
  {id:'ach_awaken1',name:'ÊúÄÂàù„ÅÆË¶öÈÜí',       emoji:'‚ú®', desc:'„Çπ„Ç≠„É´„Çí1„Å§Ë¶öÈÜí„Åï„Åõ„Çã',   rew:'+300G',   check:()=>getAwakenedSkills().length>=1, reward:()=>setGold(getGold()+300)},
  {id:'ach_effort100',name:'Âä™Âäõ„ÅÆ100ÊôÇÈñì',  emoji:'‚è∞', desc:'Á¥ØË®àÂä™ÂäõÊôÇÈñì100ÊôÇÈñìÈÅîÊàê', rew:'XP +500', check:()=>{let t=0;getAllDates().forEach(d=>{t+=getEffortMins(getDayData(d).blocks);});return t>=6000;}, reward:()=>addXPRaw(500)},
  {id:'ach_gacha50',name:'„Ç¨„ÉÅ„É£‰∏≠ÊØí',       emoji:'üé∞', desc:'„Ç¨„ÉÅ„É£„Çí50ÂõûÂºï„Åè',        rew:'+200G',   check:()=>(ls_get('gacha_count')||0)>=50, reward:()=>setGold(getGold()+200)},

  // Hidden achievements (description hidden until unlocked)
  {id:'ach_hidden_night',name:'???',emoji:'üåô',desc:'???',rew:'+500G',hidden:true,realName:'Â§úÂûã‰∫∫Èñì',realDesc:'Ê∑±Â§ú1ÊôÇ‰ª•Èôç„Å´Ë®òÈå≤„ÇíËøΩÂä†',check:function(){var d=getDayData(todayStr());return d.blocks.some(function(b){return parseInt(b.start.split(':')[0])>=1&&parseInt(b.start.split(':')[0])<5;});},reward:function(){setGold(getGold()+500);}},
  {id:'ach_hidden_10h',name:'???',emoji:'‚è∞',desc:'???',rew:'XP +500',hidden:true,realName:'10ÊôÇÈñìÊà¶Â£´',realDesc:'1Êó•„Å´10ÊôÇÈñì‰ª•‰∏ä„ÅÆÂä™ÂäõÊôÇÈñì„ÇíË®òÈå≤',check:function(){var d=getDayData(todayStr());return getEffortMins(d.blocks)>=600;},reward:function(){addXPRaw(500);}},
  {id:'ach_hidden_broke',name:'???',emoji:'üí∏',desc:'???',rew:'+1000G',hidden:true,realName:'‰∏ÄÊñáÁÑ°„Åó',realDesc:'ÊâÄÊåÅÈáë„Åå0G„Å´„Å™„Çã',check:function(){return getGold()===0;},reward:function(){setGold(getGold()+1000);}},
  {id:'ach_hidden_housing8',name:'???',emoji:'üè∞',desc:'???',rew:'XP +2000',hidden:true,realName:'Âüé‰∏ª',realDesc:'‰ΩèÂ±Ö„ÇíÂüé„Å´„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ',check:function(){return getCurrentHousing()>=8;},reward:function(){addXPRaw(2000);}},
  {id:'ach_hidden_slot777',name:'???',emoji:'üé∞',desc:'???',rew:'+3000G',hidden:true,realName:'„É©„ÉÉ„Ç≠„Éº„Çª„Éñ„É≥',realDesc:'„Çπ„É≠„ÉÉ„Éà„Åß7Ô∏è‚É£„Çí3„Å§ÊèÉ„Åà„Çã',check:function(){return ls_get('slot_jackpot')||false;},reward:function(){setGold(getGold()+3000);}},
  {id:'ach_hidden_allskill',name:'???',emoji:'üåà',desc:'???',rew:'XP +3000 & +5000G',hidden:true,realName:'ÂÖ®Áü•ÂÖ®ËÉΩ',realDesc:'ÂÖ®„Çπ„Ç≠„É´„ÇíË¶öÈÜí„Åï„Åõ„Çã',check:function(){return getAwakenedSkills().length>=30;},reward:function(){addXPRaw(3000);setGold(getGold()+5000);}},
  {id:'ach_mystery10',name:'„Éä„Çæ„Ç≥„É¨„ÇØ„Çø„ÉºË¶ãÁøí„ÅÑ',emoji:'üéÅ',desc:'„Éä„Çæ„Ç¨„ÉÅ„É£10Á®Æ„Ç≥„É≥„Éó',rew:'+100G',check:function(){return getMysteryCollection().length>=10;},reward:function(){setGold(getGold()+100);}},
  {id:'ach_mystery50',name:'„Éä„Çæ„Éû„Éã„Ç¢',emoji:'üéÅ',desc:'„Éä„Çæ„Ç¨„ÉÅ„É£50Á®Æ„Ç≥„É≥„Éó',rew:'+500G & XP +300',check:function(){return getMysteryCollection().length>=50;},reward:function(){setGold(getGold()+500);addXPRaw(300);}},
  {id:'ach_mystery100',name:'„Éä„Çæ„Éû„Çπ„Çø„Éº',emoji:'üéÅ',desc:'„Éä„Çæ„Ç¨„ÉÅ„É£100Á®Æ„Ç≥„É≥„Éó',rew:'+2000G & XP +1000',check:function(){return getMysteryCollection().length>=100;},reward:function(){setGold(getGold()+2000);addXPRaw(1000);}},
  {id:'ach_mystery123',name:'???',emoji:'üåü',desc:'???',rew:'+5000G & XP +2000',hidden:true,realName:'„Éä„Çæ„ÅÆÊîØÈÖçËÄÖ',realDesc:'„Éä„Çæ„Ç¨„ÉÅ„É£ÂÖ®123Á®Æ„Ç≥„É≥„Éó„É™„Éº„Éà',check:function(){return getMysteryCollection().length>=123;},reward:function(){setGold(getGold()+5000);addXPRaw(2000);}},
  {id:'ach_pachinko_kakuhen',name:'???',emoji:'üîÆ',desc:'???',rew:'+500G',hidden:true,realName:'„Éï„Ç©„Éº„ÉÅ„É•„É≥„Éû„Çπ„Çø„Éº',realDesc:'„Éï„Ç©„Éº„ÉÅ„É•„É≥„Éû„Ç∑„É≥„Åß3ÈÄ£„ÉÅ„É£„É≥‰ª•‰∏ä',check:function(){return getPachinkoState().chain>=3;},reward:function(){setGold(getGold()+500);}},
  {id:'ach_pachinko_fever',name:'???',emoji:'üîÆ',desc:'???',rew:'+3000G & XP +1000',hidden:true,realName:'„Éï„Ç£„Éº„Éê„Éº„É¨„Ç∏„Çß„É≥„Éâ',realDesc:'„Éï„Ç©„Éº„ÉÅ„É•„É≥„Éû„Ç∑„É≥„Åß7ÈÄ£„ÉÅ„É£„É≥‰ª•‰∏ä',check:function(){return getPachinkoState().chain>=7;},reward:function(){setGold(getGold()+3000);addXPRaw(1000);}},

  // New achievements
  {id:'ach_14day',name:'2ÈÄ±Èñì„ÅÆÁ∂ôÁ∂ö',emoji:'üìÜ',desc:'14Êó•ÈÄ£Á∂ö„ÅßÊôÇÈñì„ÇíË®òÈå≤',rew:'XP +300 & +200G',check:()=>calcStreak()>=14,reward:()=>{addXPRaw(300);setGold(getGold()+200);}},
  {id:'ach_50day',name:'50Êó•„ÅÆÈâÑ‰∫∫',emoji:'üóìÔ∏è',desc:'50Êó•ÈÄ£Á∂ö„ÅßÊôÇÈñì„ÇíË®òÈå≤',rew:'XP +2000 & +1000G',check:()=>calcStreak()>=50,reward:()=>{addXPRaw(2000);setGold(getGold()+1000);}},
  {id:'ach_lv10',name:'Lv.10Âà∞ÈÅî',emoji:'‚≠ê',desc:'„Éó„É¨„Ç§„É§„Éº„É¨„Éô„É´10„Å´Âà∞ÈÅî',rew:'+500G',check:()=>getLevel()>=10,reward:()=>setGold(getGold()+500)},
  {id:'ach_lv25',name:'Lv.25Âà∞ÈÅî',emoji:'üåü',desc:'„Éó„É¨„Ç§„É§„Éº„É¨„Éô„É´25„Å´Âà∞ÈÅî',rew:'+2000G & XP +500',check:()=>getLevel()>=25,reward:()=>{setGold(getGold()+2000);addXPRaw(500);}},
  {id:'ach_effort500',name:'Âä™Âäõ„ÅÆ500ÊôÇÈñì',emoji:'üèãÔ∏è',desc:'Á¥ØË®àÂä™ÂäõÊôÇÈñì500ÊôÇÈñìÈÅîÊàê',rew:'XP +2000 & +1000G',check:()=>{let t=0;getAllDates().forEach(d=>{t+=getEffortMins(getDayData(d).blocks);});return t>=30000;},reward:()=>{addXPRaw(2000);setGold(getGold()+1000);}},
  {id:'ach_1000000g',name:'„Éü„É™„Ç™„Éç„Ç¢',emoji:'üíé',desc:'Á¥ØË®à1,000,000GÁ®º„Åê',rew:'XP +1000 & +5000G',check:()=>getTotalEarned()>=1000000,reward:()=>{addXPRaw(1000);setGold(getGold()+5000);}},
  {id:'ach_awaken5',name:'‰∫î„Å§„ÅÆË¶öÈÜí',emoji:'üî•',desc:'„Çπ„Ç≠„É´„Çí5„Å§Ë¶öÈÜí„Åï„Åõ„Çã',rew:'+1000G',check:()=>getAwakenedSkills().length>=5,reward:()=>setGold(getGold()+1000)},
  {id:'ach_awaken15',name:'Ë¶öÈÜí„ÅÆÂçä„Å∞',emoji:'üí´',desc:'„Çπ„Ç≠„É´„Çí15ÂÄãË¶öÈÜí„Åï„Åõ„Çã',rew:'XP +1500 & +3000G',check:()=>getAwakenedSkills().length>=15,reward:()=>{addXPRaw(1500);setGold(getGold()+3000);}},
  {id:'ach_10bld',name:'Ë°ó„ÅÆÈñãÊãìËÄÖ',emoji:'üèóÔ∏è',desc:'Âª∫Áâ©„Çí10ÂÄãÂª∫Ë®≠„Åô„Çã',rew:'+500G',check:()=>getOwnedBuildings().length>=10,reward:()=>setGold(getGold()+500)},
  {id:'ach_allbld',name:'???',emoji:'üèôÔ∏è',desc:'???',rew:'XP +3000 & +5000G',hidden:true,realName:'ÂÆåÂÖ®ÈÉΩÂ∏Ç',realDesc:'ÂÖ®Âª∫Áâ©„ÇíÂª∫Ë®≠„Åô„Çã',check:()=>BUILDINGS.every(b=>getOwnedBuildings().includes(b.id)),reward:()=>{addXPRaw(3000);setGold(getGold()+5000);}},
  {id:'ach_debt_clear',name:'„É≠„Éº„É≥ÂÆåÊ∏à',emoji:'üéä',desc:'ÂàùÊúü„É≠„Éº„É≥„ÇíÂÆåÊ∏à„Åô„Çã',rew:'XP +100',check:()=>isDebtPaid(),reward:()=>addXPRaw(100)},
  {id:'ach_todo3',name:'ÁõÆÊ®ôÈÅîÊàêËÄÖ',emoji:'üìã',desc:'ToDo„É™„Çπ„Éà„ÅÆÁõÆÊ®ô„Çí3„Å§ÈÅîÊàê',rew:'XP +300 & +300G',check:()=>(getTodos().filter(t=>t.done).length>=3),reward:()=>{addXPRaw(300);setGold(getGold()+300);}},
  {id:'ach_hidden_loan',name:'???',emoji:'üè¶',desc:'???',rew:'+500G',hidden:true,realName:'‰ø°Áî®ÂèñÂºï„ÅÆÈÅî‰∫∫',realDesc:'Ê∂àË≤ªËÄÖÈáëËûç„Åã„ÇâÂÄüÂÖ•„Åô„Çã',check:function(){return getLoanData().status==='active'||getLoanData().repaid;},reward:function(){setGold(getGold()+500);}},
  {id:'ach_hidden_loan1m',name:'???',emoji:'üè¶',desc:'???',rew:'+10000G & XP +2000',hidden:true,realName:'„Éü„É™„Ç™„É≥„ÇØ„É¨„Ç∏„ÉÉ„Éà',realDesc:'Ê∂àË≤ªËÄÖÈáëËûç„Åß100‰∏áG‰ª•‰∏ä„ÇíÂÄüÂÖ•„Åô„Çã',check:function(){var ld=getLoanData();return ld.borrowed>=1000000||(ld.principal&&ld.principal>=1000000);},reward:function(){setGold(getGold()+10000);addXPRaw(2000);}},
];

// raw XP add without sleep modifier (for achievement rewards)
function addXPRaw(amount){
  const prev=getTotalXP();
  setTotalXP(prev+amount);
  checkLevelUp(prev,prev+amount);
  updateNav();
}

function getUnlockedAchievements(){return ls_get('unlocked_ach')||[];}
function setUnlockedAchievements(v){ls_set('unlocked_ach',v);}

function checkAchievements(){
  const unlocked=getUnlockedAchievements();
  let newlyUnlocked=false;
  ACHIEVEMENTS.forEach(ach=>{
    if(unlocked.includes(ach.id))return;
    try{
      if(ach.check()){
        unlocked.push(ach.id);
        ach.reward();
        addEventLog('üèÜ ÂÆüÁ∏æËß£Èô§ÔºÅ„Äå'+(ach.realName||ach.name)+'„Äç ‚Üí '+ach.rew,'awakening');
        showReward(ach.emoji,'ÂÆüÁ∏æËß£Èô§ÔºÅ','„Äå'+(ach.realName||ach.name)+'„Äç\n'+(ach.realDesc||ach.desc)+'\n\nüéÅ Â†±ÈÖ¨: '+ach.rew);
        newlyUnlocked=true;
      }
    }catch(e){}
  });
  if(newlyUnlocked)setUnlockedAchievements(unlocked);
}

function renderAchievements(){
  const unlocked=getUnlockedAchievements();
  const el=document.getElementById('achGrid');
  if(!el)return;
  el.innerHTML=ACHIEVEMENTS.map(function(ach){
    var isUl=unlocked.includes(ach.id);
    var isHidden=ach.hidden&&!isUl;
    var name=isHidden?'???':(ach.realName||ach.name);
    var desc=isHidden?'Êù°‰ª∂„ÇíÊ∫Ä„Åü„Åô„Å®Ëß£Êîæ„Åï„Çå„Åæ„Åô':(ach.realDesc||ach.desc);
    var emoji=isHidden?'‚ùì':ach.emoji;
    return '<div class="ach-card'+(isUl?' unlocked':'')+'">'+
      '<div class="ach-icon">'+emoji+'</div>'+
      '<div class="ach-info">'+
        '<div class="ach-name">'+name+(isUl?' ‚úì':'')+'</div>'+
        '<div class="ach-desc">'+desc+'</div>'+
        '<div class="ach-rew">üéÅ '+(isHidden?'???':ach.rew)+'</div>'+
      '</div></div>';
  }).join('');

  // Rebirth status
  var rCount=getRebirthCount();
  var statusEl=document.getElementById('rebirthStatus');
  if(statusEl){
    if(rCount>0){
      var rt=getHighestRebirthTitle();
      var titles=getRebirthTitles();
      statusEl.innerHTML='<div style="font-size:1.8rem;margin-bottom:4px;">'+(rt?rt.icon:'‚è≥')+'</div>'+
        '<div style="color:'+(rt?rt.color:'#c084fc')+';font-weight:800;font-size:1rem;">'+rCount+'Âë®ÁõÆ</div>'+
        '<div style="font-size:.65rem;color:var(--muted2);margin-top:4px;">Áß∞Âè∑: '+titles.map(function(t){return t.icon+' '+t.name;}).join(' ‚Üí ')+'</div>'+
        '<div style="font-size:.65rem;color:#fcd34d;margin-top:4px;">‚è∞ ÊôÇÁµ¶ √ó'+getRebirthWageMulti().toFixed(1)+' | ‚ö° XP √ó'+getRebirthXPMulti().toFixed(1)+'</div>';
    } else {
      statusEl.innerHTML='<div style="font-size:1.5rem;opacity:.3;">‚è≥</div><div style="font-size:.7rem;color:var(--muted);">„Åæ„Å†Ëª¢Áîü„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
    }
  }

  // Rebirth conditions
  var condEl=document.getElementById('rebirthConditions');
  var btn=document.getElementById('rebirthBtn');
  if(condEl){
    var conds=getRebirthConditions();
    condEl.innerHTML='<div style="font-size:.65rem;color:var(--muted2);margin-bottom:6px;">Ëª¢ÁîüÊù°‰ª∂:</div>'+
      conds.map(function(c){return '<div style="font-size:.7rem;padding:3px 0;color:'+(c.met?'var(--green)':'var(--muted)')+';">'+(c.met?'‚úÖ':'‚¨ú')+' '+c.name+'</div>';}).join('');
    if(btn){
      var ready=canRebirth();
      btn.disabled=!ready;
      btn.style.opacity=ready?1:0.35;
      btn.style.cursor=ready?'pointer':'not-allowed';
      if(ready){btn.style.borderColor='rgba(192,132,252,.6)';btn.style.background='rgba(192,132,252,.2)';btn.style.boxShadow='0 0 20px rgba(192,132,252,.15)';}
    }
  }
}

// On initial collect date setup
if(!getLastCollectDate()){
  setLastCollectDate(todayStr());
}
initLoanTick();

</script>

<!-- HELP OVERLAY -->
<div class="help-overlay" id="helpOverlay">
  <div class="help-box">
    <div class="hb-title">
      <span id="helpTitleIcon" style="cursor:default;">üìñ TIMEFLOW „Ç¨„Ç§„Éâ</span>
      <button class="btn sm" onclick="closeHelp()">‚úï Èñâ„Åò„Çã</button>
    </div>
    <div style="margin-bottom:16px;"><button onclick="closeHelp();setTimeout(openTutorial,300);" style="width:100%;padding:12px;border:2px solid rgba(0,212,255,.3);border-radius:12px;background:linear-gradient(135deg,rgba(0,212,255,.08),rgba(168,85,247,.06));color:var(--cyan);font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s;font-family:'M PLUS Rounded 1c',sans-serif;">üéì „ÉÅ„É•„Éº„Éà„É™„Ç¢„É´„ÇíË¶ã„Çã</button></div>
    <div class="hb-section"><div class="hb-h">üéÆ Âü∫Êú¨„Ç≥„É≥„Çª„Éó„Éà</div><div class="hb-p">ÁèæÂÆü„ÅÆÊôÇÈñìË®òÈå≤„ÅåËÇ≤Êàê„Ç≤„Éº„É†„Å´Áõ¥Áµê„Åô„Çã‰∫∫ÁîüRPG„ÄÇË°åÂãï„ÇíË®òÈå≤„Åô„Çã„Å®„Çπ„Ç≠„É´„ÅåÊàêÈï∑„Åó„ÄÅÊôÇÁµ¶„Åå‰∏ä„Åå„Çä„ÄÅ„Ç¥„Éº„É´„Éâ„ÅßË≥áÁî£„ÇíÈÅãÁî®„Åß„Åç„Åæ„Åô„ÄÇ</div></div>
    <div class="hb-section"><div class="hb-h">üìù Âü∫Êú¨„É´„Éº„Éó</div><div class="hb-p"><span class="hb-tag">Ë®òÈå≤</span>‚Üí<span class="hb-tag">XPÔºÜ„Çπ„Ç≠„É´ÊàêÈï∑</span>‚Üí<span class="hb-tag">ÊôÇÁµ¶‰∏äÊòá</span>‚Üí<span class="hb-tag">ÊèõÈáë</span>‚Üí<span class="hb-tag">Ë≥áÁî£ÈÅãÁî®</span>‚Üí<span class="hb-tag">‰∏çÂä¥ÊâÄÂæó</span>„ÅÆ„É´„Éº„Éó</div></div>
    <div class="hb-section"><div class="hb-h">‚ö° Áù°Áú†„Çπ„Ç≥„Ç¢„Å®XPÂÄçÁéá</div>
      <table class="hb-tbl"><tr><th>Áù°Áú†„Çπ„Ç≥„Ç¢</th><th>XPÂÄçÁéá</th><th>ÂäπÊûú</th></tr>
        <tr><td>90„Äú100ÁÇπ</td><td style="color:#4ade80">√ó1.5</td><td>ÂÆåÁíß</td></tr>
        <tr><td>75„Äú89ÁÇπ</td><td style="color:#38bdf8">√ó1.25</td><td>ËâØÂ•Ω</td></tr>
        <tr><td>60„Äú74ÁÇπ</td><td>√ó1.0</td><td>Ê®ôÊ∫ñ</td></tr>
        <tr><td>40„Äú59ÁÇπ</td><td style="color:#fbbf24">√ó0.8</td><td>‰∏çË∂≥</td></tr>
        <tr><td>0„Äú39ÁÇπ</td><td style="color:#fb7185">√ó0.6</td><td>Âç±Èô∫</td></tr>
      </table>
      <div class="hb-p" style="margin-top:5px;">ÁêÜÊÉ≥: <strong style="color:#c084fc;">23:00Â∞±ÂØù / 6:30Ëµ∑Â∫ä / 7.5hÁù°Áú†</strong></div>
    </div>
    <div class="hb-section"><div class="hb-h">üí∞ ÊôÇÁµ¶„ÅÆ‰ªïÁµÑ„Åø</div>
      <div class="hb-p">ÊôÇÁµ¶„ÅØ„Çπ„Ç≠„É´Lv„ÅÆÂêàË®à„Å´Âøú„Åò„Å¶30ÊÆµÈöé„Åß‰∏äÊòáÔºà90G„Äú8,000G/hÔºâ„ÄÇÁÑ°ËÅ∑‚ÜíÊó•Èõá„ÅÑ‚Üí„Ç¢„É´„Éê„Ç§„Éà‚Üí‚Ä¶‚ÜíÁ§æÈï∑‚ÜíCEO‚Üí‰ºùË™¨„ÅÆÁµåÂñ∂ËÄÖ„Åæ„Åß„ÄÇ„ÄåÊèõÈáë„Äç„Éú„Çø„É≥„Åß„Ç¥„Éº„É´„Éâ„Å´Â§âÊèõ„Åß„Åç„Åæ„Åô„ÄÇ</div>
    </div>
    <div class="hb-section"><div class="hb-h">üìà Ë≥áÁî£ÈÅãÁî®</div>
      <div class="hb-p"><strong style="color:#38bdf8;">Ê†™Âºè</strong>: Ê†™‰æ°„ÅåÊó•„ÄÖÂ§âÂãï„ÄÇË§áÊï∞Âè£Ë≥ºÂÖ•„ÉªÂ£≤Âç¥ÂèØËÉΩ„ÄÇS&P500„ÅÆ„Çà„ÅÜ„Å´„É™„Ç¢„É´„Å™ÂÄ§Âãï„Åç„ÄÇ<br><strong style="color:#4ade80;">‰∏çÂãïÁî£</strong>: Ë§áÊï∞Áâ©‰ª∂‰øùÊúâÂèØ„ÄÇÂÆ∂Ë≥É„ÅØÊúà1ÂõûÂõûÂèé„ÄÇÁâ©‰ª∂„ÅØÁµåÂπ¥„ÅßÊ∏õ‰æ°„Åó„ÄÅÂ£≤Âç¥ÊôÇ„ÅØÊôÇ‰æ°„ÄÇ<br><strong style="color:#c084fc;">‰∫ãÊ•≠</strong>: Ë°ó„ÅÆ‰∫∫Âè£ÔºùÈõáÁî®ÂèØËÉΩ‰∫∫Êï∞„ÄÇÂ§ß‰ºÅÊ•≠„Åª„Å©Â§ßÈáè„ÅÆÂæìÊ•≠Âì°„ÅåÂøÖË¶Å„ÄÇ<br><strong style="color:#fbbf24;">ÁîüÊ¥ªÊ∞¥Ê∫ñ</strong>: ÊØéÊó•„Ç≥„Çπ„Éà„Åå„Åã„Åã„Çã„ÅåXPÂÄçÁéá„Éú„Éº„Éä„Çπ„ÄÇ<br>‰∫ãÊ•≠ÂèéÂÖ•„ÅØÊØéÊó•„Äåüì• Âèó„ÅëÂèñ„Çã„Äç„ÅßÁç≤Âæó„ÄÇ</div>
    </div>
    <div class="hb-section"><div class="hb-h">üß¨ „Çπ„Ç≠„É´„ÉÑ„É™„Éº„ÅÆË°åÂãïËß£Êîæ</div>
      <div class="hb-p">„Çπ„Ç≠„É´Lv„Åå‰∏ä„Åå„Çã„Å®Ë≥áÁî£ÈÅãÁî®„ÅÆÈÅ∏ÊäûËÇ¢„ÅåËß£Êîæ„Åï„Çå„Åæ„Åô„ÄÇ‰æã: Êà¶Áï•ÊÄùËÄÉLv2 ‚Üí Ê†™ÂºèÊäïË≥á„ÅåËß£Êîæ„ÄÇ„Çπ„Ç≠„É´„ÇíËÇ≤„Å¶„Çã„Åª„Å©„Åß„Åç„Çã„Åì„Å®„ÅåÂ¢ó„Åà„Åæ„Åô„ÄÇ</div>
    </div>
    <div class="hb-section"><div class="hb-h">üí∏ „É≠„Éº„É≥„Ç∑„Çπ„ÉÜ„É†</div>
      <div class="hb-p">„Ç≤„Éº„É†ÈñãÂßãÊôÇ„Å´5,000G„ÅÆ„Çπ„Çø„Éº„Éà„É≠„Éº„É≥„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊôÇÈñì„ÇíÊèõÈáë„Åô„Çã„Å®Ëá™ÂãïÁöÑ„Å´ËøîÊ∏à„Å´Âõû„Çä„Åæ„Åô„ÄÇÂÆåÊ∏à„Åô„Çã„Å®Ë≥áÁî£ÈÅãÁî®ÔºàÊ†™„Éª‰∏çÂãïÁî£„Éª‰∫ãÊ•≠Ôºâ„Å®Ë°ó„Å•„Åè„Çä„ÅåËß£Á¶Å„Åï„Çå„Åæ„Åô„ÄÇ„Åæ„Åö„ÅØ„É≠„Éº„É≥ËøîÊ∏à„ÇíÁõÆÊåá„Åó„Åæ„Åó„Çá„ÅÜÔºÅÊâÄÊåÅÈáë„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÊâãÂãï„ÅßËøîÊ∏à„Åô„Çã„Åì„Å®„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ</div>
    </div>
    <div class="hb-section"><div class="hb-h">üè¶ Ê∂àË≤ªËÄÖÈáëËûç</div>
      <div class="hb-p">
        Â®ØÊ•Ω„Çø„Éñ„ÅÆ„Äåüè¶ Ê∂àË≤ªËÄÖÈáëËûç„Äç„Åã„Çâ„ÅäÈáë„ÇíÂÄü„Çä„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ<br><br>
        <strong style="color:#fb7185;">ÊâãÈ†Ü</strong>: „ÅäÁî≥„ÅóËæº„Åø ‚Üí CIC‰ø°Áî®ÊÉÖÂ†±ÁÖß‰ºöÔºàÂØ©ÊüªÁ¥Ñ3ÁßíÔºâ ‚Üí Â•ëÁ¥Ñ ‚Üí ÂÄüÂÖ•<br><br>
        <strong style="color:#fbbf24;">ÈáëÂà©ÔºàÂà©ÊÅØÂà∂ÈôêÊ≥ïÊ∫ñÊã†Ôºâ</strong>:<br>
        „ÉªÂÖÉÊú¨10‰∏áGÊú™Ê∫Ä: Âπ¥20%ÔºàÊó•Á¥Ñ0.0548%Ôºâ<br>
        „ÉªÂÖÉÊú¨10‰∏á„Äú100‰∏áGÊú™Ê∫Ä: Âπ¥18%ÔºàÊó•Á¥Ñ0.0493%Ôºâ<br>
        „ÉªÂÖÉÊú¨100‰∏áG‰ª•‰∏ä: Âπ¥15%ÔºàÊó•Á¥Ñ0.0411%Ôºâ<br><br>
        <strong style="color:#4ade80;">ÂÄüÂÖ•ÈôêÂ∫¶È°ç</strong>:<br>
        „ÉªÂàùÂõû: 10,000G„Äú50,000G<br>
        „ÉªÂÆåÊ∏àÂÆüÁ∏æ„ÅÇ„Çä: Âπ¥ÂèéÔºàÊôÇÁµ¶√ó8h√ó265Êó•Ôºâ„ÅÆ1/3„Åæ„ÅßÔºàÁ∑èÈáèË¶èÂà∂Ôºâ<br><br>
        <strong style="color:#f97316;">üí≥ ÊØéÊúà„ÅÆÊúÄ‰ΩéËøîÊ∏àÈ°çÔºàÈáçË¶ÅÔºâ</strong>:<br>
        „ÉªÂÄüÂÖ•ÂÖÉÊú¨„ÅÆ <strong>4.5%</strong> „ÅåÊØéÊúà„ÅÆÊúÄ‰ΩéËøîÊ∏àÈ°ç„Å®„Åó„Å¶Ë®≠ÂÆö„Åï„Çå„Åæ„Åô<br>
        „ÉªÂ•ëÁ¥ÑÊó•„Åã„Çâ30Êó•„Åî„Å®„Å´„ÄÅÊâÄÊåÅÈáë„Åã„Çâ<strong>Ëá™ÂãïÂºï„ÅçËêΩ„Å®„Åó</strong>„Åï„Çå„Åæ„Åô<br>
        „ÉªÊâÄÊåÅÈáë„ÅåÊúÄ‰ΩéËøîÊ∏àÈ°ç„Å´Ê∫Ä„Åü„Å™„ÅÑÂ†¥ÂêàÔºö<br>
        „ÄÄ‚Üí <span style="color:#fb7185;font-weight:700;">ÈÅÖÂª∂ÊêçÂÆ≥Èáë</span>„ÅåÂä†ÁÆó„Åï„Çå„Åæ„ÅôÔºàÂõûÊï∞√óÂÖÉÊú¨„ÅÆ1%Ôºâ<br>
        „ÄÄ‚Üí ÊâÄÊåÅÈáë„Åå<strong>ÂÖ®È°çÂº∑Âà∂ÂõûÂèé</strong>„Åï„Çå„Åæ„Åô<br>
        „ÉªÈÅÖÂª∂„ÇíÁπ∞„ÇäËøî„Åô„Åª„Å©ÊêçÂÆ≥Èáë„ÅåËÜ®„Çâ„ÇÄ„Åü„ÇÅ„ÄÅË®àÁîªÁöÑ„Å™ËøîÊ∏à„ÅåÈáçË¶Å„Åß„Åô<br><br>
        <span style="font-size:.6rem;color:var(--muted);">‰æã: 100,000GÂÄüÂÖ• ‚Üí ÊúÄ‰ΩéËøîÊ∏àÈ°ç 4,500G/Êúà„ÄÇËøîÊ∏àÊôÇ„ÅØÂà©ÊÅØ‚ÜíÂÖÉÊú¨„ÅÆÈ†Ü„Å´ÂÖÖÂΩì„Åï„Çå„Åæ„Åô„ÄÇ</span>
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">üî• ÁøíÊÖ£„ÉÅ„Çß„Éº„É≥ÔºÜÁ∂ôÁ∂ö„Éú„Éº„Éä„Çπ</div>
      <div class="hb-p">Áµ±Ë®à„Éö„Éº„Ç∏„ÅÆ„ÄåÁøíÊÖ£„ÉÅ„Çß„Éº„É≥„Äç„ÅØÈÅéÂéª56Êó•ÂàÜ„ÅÆË®òÈå≤Áä∂Ê≥Å„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇË®òÈå≤„Åó„ÅüÊó•„ÅØÁ∑ëËâ≤„ÅßË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ<br><br><strong style="color:#fbbf24;">Á∂ôÁ∂ö„Éú„Éº„Éä„Çπ</strong>: ÊØéÊó•Ë®òÈå≤„Åô„Çã„Å®„Ç¥„Éº„É´„Éâ„Åå„ÇÇ„Çâ„Åà„Åæ„Åô„ÄÇÈÄ£Á∂öÊó•Êï∞„ÅåÂ¢ó„Åà„Çã„Åª„Å©ÈáëÈ°ç„Åå„Ç¢„ÉÉ„ÉóÔºÅÔºà3Êó•„Åß25G‚Üí7Êó•„Åß76G‚Üí14Êó•„Åß145G‚Üí30Êó•„Åß470G‚Ä¶Ôºâ„ÄÇ„Äåüì• Âèó„ÅëÂèñ„Çã„Äç„Éú„Çø„É≥„ÅßÂõûÂèé„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br><br><strong style="color:rgba(255,255,255,0.3);">‰∏ÄÊôÇÂÅúÊ≠¢</strong>: Ë®òÈå≤„Åß„Åç„Å™„Åã„Å£„ÅüÊó•„ÅØ„Äå‰∏ÄÊôÇÂÅúÊ≠¢„ÄçÊâ±„ÅÑ„Åß„ÅôÔºàÊúÄÂ§ß3Êó•Ôºâ„ÄÇ„Çπ„Éà„É™„Éº„ÇØ„ÅØÂ£ä„Çå„Åæ„Åõ„Çì„ÄÇÁΩ∞„ÇÇ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂÜçÈñã„ÅØ„ÅÑ„Å§„Åß„ÇÇ„Åß„Åç„Åæ„Åô„ÄÇ</div>
    </div>
    <div class="hb-section"><div class="hb-h">‚≠ê ÁâπÂà•XPÈ†ÖÁõÆ</div>
      <div class="hb-p">Ëá™ÂàÜ„ÅåÁâπ„Å´ÈáçË¶ÅË¶ñ„Åô„ÇãË°åÂãï„ÇíÁôªÈå≤„Åó„Å¶XP„Éú„Éº„Éä„Çπ„ÇíÂæó„Çã‰ªïÁµÑ„Åø„Åß„Åô„ÄÇ‰æã„Åà„Å∞„ÄåÂ≠¶Áøí„Çí120ÂàÜ‰ª•‰∏ä„Äç„ÅßXP√ó3ÂÄç„ÄÅ„Å®„ÅÑ„Å£„ÅüË®≠ÂÆö„Åå„Åß„Åç„Åæ„Åô„ÄÇË®òÈå≤„Éö„Éº„Ç∏„ÅÆ„ÄåÔºãËøΩÂä†„Äç„Åã„ÇâË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åó„ÅüË®òÈå≤„ÇíËøΩÂä†„Åô„Çã„Å®Ëá™ÂãïÁöÑ„Å´XP„ÅåÂ¢óÂä†„Åó„Åæ„Åô„ÄÇ</div>
    </div>
    <div class="hb-section"><div class="hb-h">‚è© „Çà„Åè‰Ωø„ÅÜ„ÉÜ„É≥„Éó„É¨„Éº„Éà</div>
      <div class="hb-p">Ë®òÈå≤„Éö„Éº„Ç∏„ÅÆ„ÄåÊúù‰ªï‰∫ã 9-12„Äç„ÄåÊòºÈ£ü 12-13„Äç„Å™„Å©„ÅÆ„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅÊôÇÈñì„Å®„Ç´„ÉÜ„Ç¥„É™„ÅåËá™ÂãïÂÖ•Âäõ„Åï„Çå„Åæ„Åô„ÄÇÊØéÊó•Âêå„ÅòÊôÇÈñì„Å´Âêå„Åò„Åì„Å®„Çí„Åô„ÇãÂ†¥Âêà„Å´‰æøÂà©„Åß„Åô„ÄÇ</div>
    </div>
    <div class="hb-section"><div class="hb-h">üé∞ „Çπ„É≠„ÉÉ„Éà„Éª„Éï„Ç©„Éº„ÉÅ„É•„É≥„Éû„Ç∑„É≥„Éª„Ç¨„ÉÅ„É£</div>
      <div class="hb-p">
        <strong style="color:#fbbf24;">üé∞ „Çπ„É≠„ÉÉ„Éà</strong>: 80G„ÅßÂõû„Åô„ÄÇ3„Å§ÊèÉ„ÅÑ=250„Äú5000G„ÄÅ2„Å§ÊèÉ„ÅÑ=20G„ÄÅ„ÅØ„Åö„Çå=-80G„ÄÇ777„Åß„Ç∏„É£„ÉÉ„ÇØ„Éù„ÉÉ„ÉàÔºÅ<br><br>
        <strong style="color:#c084fc;">üîÆ „Éï„Ç©„Éº„ÉÅ„É•„É≥„Éû„Ç∑„É≥Ôºà„Éï„Ç£„Éº„Éê„Éº„ÉªÊôÇÁü≠„É´„Éº„É´‰ªò„ÅçÔºâ</strong><br>
        „Éª1Âõû100G„ÅßÁéâ„ÇíÊâì„Å§„ÄÇ„Éâ„É©„É†„ÅåÂõûËª¢„Åó„ÄÅÊèÉ„Åà„Å∞Â§ßÂΩì„Åü„Çä„ÄÇ<br>
        „Éª<strong style="color:#f472b6;">ÈÄöÂ∏∏„É¢„Éº„Éâ</strong>: Â§ßÂΩì„Åü„ÇäÁ¢∫Áéá 1/10„ÄÇÂΩì„Åü„Çã„Å®+500„Äú3000G„ÄÇ<br>
        „Éª<strong style="color:#fcd34d;">„Éï„Ç£„Éº„Éê„ÉºÔºàÁ¢∫ÁéáÂ§âÂãïÔºâ</strong>: Â§ßÂΩì„Åü„ÇäÂæå„ÄÅ50%„ÅÆÁ¢∫Áéá„ÅßÁ™ÅÂÖ•„ÄÇÂ§ßÂΩì„Åü„ÇäÁ¢∫Áéá„Åå 1/3 „Å´Â§ßÂπÖUP„ÄÇ„Åï„Çâ„Å´ÊôÇÁü≠10Âõû„ÇÇ„Çª„ÉÉ„Éà„Åß‰ªò‰∏é„ÄÇÊ¨°„ÅÆÂ§ßÂΩì„Åü„Çä„Åæ„Åß„Éï„Ç£„Éº„Éê„Éº„ÅØÁ∂ôÁ∂ö„ÄÇ<br>
        „Éª<strong style="color:#38bdf8;">ÊôÇÁü≠</strong>: „Éï„Ç£„Éº„Éê„ÉºÁ™ÅÂÖ•ÊôÇ„Å´10Âõû‰ªò‰∏é„ÄÇÊôÇÁü≠‰∏≠„ÅØÊâì„Å°Áéâ„Ç≥„Çπ„Éà„Åå50GÔºàÈÄöÂ∏∏„ÅÆÂçäÈ°çÔºâ„Å´„ÄÇÊôÇÁü≠„Çí‰Ωø„ÅÑÂàá„Çã„Å®ÈÄöÂ∏∏„É¢„Éº„Éâ„Å´Êàª„Çã„ÄÇ<br>
        „Éª„Éï„Ç£„Éº„Éê„Éº‰∏≠„Å´Â§ßÂΩì„Åü„Çä„Åô„Çã„Å®„ÄÅÂÜç„Å≥50%„Åß„Éï„Ç£„Éº„Éê„Éº„Å´„ÄÇ„Éï„Ç£„Éº„Éê„Éº„É´„Éº„Éó„ÅßÂ§ßÈÄ£„ÉÅ„É£„É≥„ÅÆ„ÉÅ„É£„É≥„ÇπÔºÅ<br>
        „Éª„É™„Éº„ÉÅÔºà2„Å§ÊèÉ„ÅÑÔºâ„Åß„ÅØ„Åö„Çå„ÅüÂ†¥Âêà„ÇÇÊÖ∞„ÇÅ„ÅÆ+30G„ÄÇ<br><br>
        <strong style="color:#06b6d4;">üéÅ „Éä„Çæ„Ç¨„ÉÅ„É£</strong>: 50G„Åß„Äå„Çà„Åè„Çè„Åã„Çâ„Å™„ÅÑ„ÇÇ„ÅÆ„Äç„ÅåÂá∫„Çã„ÄÇÂÖ®123Á®Æ„Ç≥„É≥„Éó„ÅßÂÆüÁ∏æÔºÜÁâπÂà•„Éú„Éº„Éä„Çπ„ÄÇ10ÈÄ£„ÅØ450GÔºà1ÂõûÂàÜ„ÅäÂæóÔºâ„ÄÇ„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥È≠Ç„ÇíÂà∫ÊøÄ„Åô„Çã„ÄÇ<br><br>
        <strong style="color:#a855f7;">üíé È´òÁ¥ö„Ç§„É≥„ÉÜ„É™„Ç¢„Ç¨„ÉÅ„É£</strong>: 8,000G„ÅßË∂Ö„É¨„Ç¢„Ç§„É≥„ÉÜ„É™„Ç¢„ÅåÂΩì„Åü„Çã„Åã„ÇÇ„ÄÇXP„Éú„Éº„Éä„Çπ‰ªò„Åç„ÅÆÈôêÂÆöÂìÅ„ÄÇ
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">‚úÖ „Éá„Ç§„É™„Éº„ÇØ„Ç®„Çπ„Éà</div>
      <div class="hb-p">
        ÊØéÊó•„ÉÅ„Çß„ÉÉ„ÇØ„Åô„ÇãËá™ÂàÜ„Å†„Åë„ÅÆ„Äå„ÇÑ„Çã„Åì„Å®„É™„Çπ„Éà„Äç„Åß„Åô„ÄÇ<br><br>
        <strong style="color:#4ade80;">‰ªïÁµÑ„Åø</strong>: Ë®òÈå≤„Éö„Éº„Ç∏„ÅÆ‰∏ã„Å´„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇÈÅîÊàê„Åó„ÅüÈ†ÖÁõÆ„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å®XP„Åå„ÇÇ„Çâ„Åà„Åæ„Åô„ÄÇ„ÉÅ„Çß„ÉÉ„ÇØ„ÅØ1Êó•„Åî„Å®„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô„ÄÇ<br><br>
        <strong style="color:#38bdf8;">„Ç´„Çπ„Çø„Éû„Ç§„Ç∫</strong>: „Äå‚öô „ÇØ„Ç®„Çπ„ÉàÁ∑®ÈõÜ„Äç„Éú„Çø„É≥„Åã„Çâ„ÄÅÈ†ÖÁõÆ„ÅÆËøΩÂä†„ÉªÂâäÈô§„ÉªXPË®≠ÂÆö„Åå„Åß„Åç„Åæ„Åô„ÄÇËá™ÂàÜ„ÅÆÁøíÊÖ£„Å´Âêà„Çè„Åõ„Å¶Ëá™Áî±„Å´Á∑®ÈõÜ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊúÄÂàù„ÅØ„Äå„Å®„Çä„ÅÇ„Åà„ÅöË®òÈå≤„Åó„Å¶„Åø„Çã„Äç„Å†„Åë„ÅßOK„ÄÇÊÖ£„Çå„Å¶„Åç„Åü„ÇâÂ∞ë„Åó„Åö„Å§Â¢ó„ÇÑ„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ<br><br>
        <strong style="color:#fbbf24;">„Ç≥„ÉÑ</strong>: È†ÖÁõÆ„ÅØ3„Äú5ÂÄã„ÅåÁ∂ö„Åë„ÇÑ„Åô„ÅÑ„ÄÇÂ§ö„Åô„Åé„Çã„Å®ÈÄÜÂäπÊûú„ÄÇ„ÄåÁ∞°Âçò„Å´„ÇØ„É™„Ç¢„Åß„Åç„Çã„ÇÇ„ÅÆ„Äç„Çí1„Å§ÂÖ•„Çå„Å¶„Åä„Åè„Å®„É¢„ÉÅ„Éô„Åå‰øù„Å°„ÇÑ„Åô„ÅÑ„Åß„Åô„ÄÇ
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">üèòÔ∏è Ë°ó„Å•„Åè„Çä</div>
      <div class="hb-p">„Ç¥„Éº„É´„Éâ„ÅßÂª∫Áâ©„ÇíÂª∫Ë®≠„Åô„Çã„Å®Ë°ó„ÅÆ‰∫∫Âè£„ÅåÂ¢ó„Åà„Åæ„Åô„ÄÇ‰∫∫Âè£„ÅåÂ¢ó„Åà„Çã„Å®Ë°ó„É©„É≥„ÇØ„Åå‰∏äÊòá„Åó„ÄÅÊôÇÁµ¶„Éú„Éº„Éä„Çπ„ÇÑ„É©„É≥„ÇØ„Ç¢„ÉÉ„ÉóÂ†±ÈÖ¨„Åå„ÇÇ„Çâ„Åà„Åæ„Åô„ÄÇ<br><br>
        <strong>Ë°ó„É©„É≥„ÇØ‰∏ÄË¶ß:</strong><br>
        üèúÔ∏è Êõ¥Âú∞(0‰∫∫) ‚Üí üèïÔ∏è ÈõÜËêΩ(50‰∫∫) ‚Üí üèòÔ∏è Êùë(120‰∫∫) ‚Üí üèôÔ∏è Áî∫(250‰∫∫) ‚Üí üåÜ Â∞èÈÉΩÂ∏Ç(500‰∫∫) ‚Üí üåá ÈÉΩÂ∏Ç(800‰∫∫) ‚Üí üåÉ Â§ßÈÉΩÂ∏Ç(1200‰∫∫) ‚Üí üóº „É°„Ç¨„Ç∑„ÉÜ„Ç£(1800‰∫∫) ‚Üí üåê „É°„Éà„É≠„Éù„É™„Çπ(2500‰∫∫) ‚Üí üëë Â∏ùÈÉΩ(3500‰∫∫) ‚Üí üåå ÈäÄÊ≤≥ÈÉΩÂ∏Ç(5000‰∫∫)<br><br>
        „É©„É≥„ÇØ„Åå‰∏ä„Åå„Çã„Åª„Å©ÊôÇÁµ¶„Éú„Éº„Éä„Çπ„ÅåÂ¢óÂä†ÔºàÊúÄÂ§ß+65%Ôºâ„ÄÇ„Åæ„Åü‰∫ãÊ•≠„ÅßÈõá„Åà„Çã‰∫∫Êï∞„ÅØË°ó„ÅÆ‰∫∫Âè£„Å´‰æùÂ≠ò„Åô„Çã„Åü„ÇÅ„ÄÅÂ§ß„Åç„Å™‰∫ãÊ•≠„Å´„ÅØÂ§ß„Åç„Å™Ë°ó„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">üèÜ ÂÆüÁ∏æ</div>
      <div class="hb-p">Êù°‰ª∂„ÇíÊ∫Ä„Åü„Åô„Å®ÂÆüÁ∏æ„ÅåËß£Èô§„Åï„Çå„ÄÅÊ∞∏Á∂ö„Éú„Éº„Éä„ÇπÔºàXP„Éª„Ç¥„Éº„É´„ÉâÔºâ„ÅåÂæó„Çâ„Çå„Åæ„Åô„ÄÇÈö†„ÅóÂÆüÁ∏æ„ÇÇÂ§öÊï∞Â≠òÂú®„Åó„Åæ„Åô„ÄÇ„Äå???„Äç„ÅØÊù°‰ª∂„ÇíÊ∫Ä„Åü„Åô„Å®Ê≠£‰Ωì„ÅåÊòé„Åã„Åï„Çå„Åæ„Åô„ÄÇ„Éä„Çæ„Ç¨„ÉÅ„É£„ÅÆ10Á®Æ/50Á®Æ/100Á®Æ/123Á®Æ„Ç≥„É≥„Éó„ÄÅ„Éï„Ç©„Éº„ÉÅ„É•„É≥„Éû„Ç∑„É≥„Åß„Éï„Ç£„Éº„Éê„Éº3ÈÄ£„ÉÅ„É£„É≥‰ª•‰∏ä„ÄÅ„Çπ„É≠„ÉÉ„Éà„Åß777„Å™„Å©„ÇÇÂÆüÁ∏æ„Å´„ÄÇ</div>
    </div>
    <div class="hb-section"><div class="hb-h">üè† ‰ΩèÂ±Ö„Éª„Ç§„É≥„ÉÜ„É™„Ç¢</div>
      <div class="hb-p">
        <strong style="color:#fbbf24;">‰ΩèÂ±Ö„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„Éâ</strong>: ÂÖ®13ÊÆµÈöé„ÄÇÈáéÂÆø(0G)‚Üí„ÉÜ„É≥„Éà(200G)‚ÜíÂ∞èÈÉ®Â±ã(800G)‚Üí‚Ä¶‚ÜíÂüé(80‰∏áG)‚ÜíÂÆÆÊÆø(200‰∏áG)‚ÜíÊµ∑Â∫ï„Éâ„Éº„É†(500‰∏áG)‚ÜíËªåÈÅì‰∏ä„Çπ„ÉÜ„Éº„Ç∑„Éß„É≥(1500‰∏áG)‚ÜíÁï∞Ê¨°ÂÖÉÈÇ∏ÂÆÖ(5000‰∏áG)„ÄÇ‰ΩèÂ±Ö„ÅåËâØ„ÅÑ„Åª„Å©XP„Éú„Éº„Éä„Çπ„ÅåÂ¢óÂä†ÔºàÊúÄÂ§ß+100%Ôºâ„ÄÇ<br><br>
        <strong style="color:#06b6d4;">„Ç§„É≥„ÉÜ„É™„Ç¢</strong>: Ë≥ºÂÖ•ÂèØËÉΩ„Å™ÈÄöÂ∏∏„Ç¢„Ç§„ÉÜ„É†20Á®ÆÔºãÈ´òÁ¥ö„Ç¨„ÉÅ„É£Â∞ÇÁî®8Á®Æ„ÄÇ„Åù„Çå„Åû„ÇåXP„Éú„Éº„Éä„Çπ„Åå‰ªò„Åç„ÄÅÂÖ®„Å¶Á©ç„ÅøÈáç„Å≠„ÅßÂäπÊûú„ÅåÂä†ÁÆó„Åï„Çå„Åæ„Åô„ÄÇ<br><br>
        <strong style="color:#a855f7;">È´òÁ¥ö„Ç§„É≥„ÉÜ„É™„Ç¢„Ç¨„ÉÅ„É£</strong>: 10,000G„ÅßÂõû„Åô„ÄÇ50%„ÅÆÁ¢∫Áéá„Åß„ÅØ„Åö„ÇåÔºà‰∏ÄÈÉ®ËøîÈáëÔºâ„ÄÇ„Ç¨„ÉÅ„É£Â∞ÇÁî®„Ç¢„Ç§„ÉÜ„É†„ÅØ„Ç∑„Éß„ÉÉ„Éó„Åß„ÅØË≤∑„Åà„Å™„ÅÑÈôêÂÆöÂìÅ„ÄÇ
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">üëë Â∏ùÂõΩ„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„Çπ ‚Äî ËøΩÂä†ÊäïË≥á</div>
      <div class="hb-p">
        Â∏ùÂõΩ„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„ÇπÔºà150‰∏áGÔºâ„ÇíË®≠Á´ã„Åô„Çã„Å®„ÄÅ„Äåüí∞ ËøΩÂä†ÊäïË≥á„Äç„Éú„Çø„É≥„ÅåÂá∫Áèæ„Åó„Åæ„Åô„ÄÇ<br><br>
        <strong style="color:#fcd34d;">ÊäïË≥áÈ°ç„Å®„É™„Çø„Éº„É≥</strong>: ËøΩÂä†ÊäïË≥á„Åó„ÅüÈáëÈ°ç„Å´Âøú„Åò„Å¶Êó•Ê¨°„É™„Çø„Éº„É≥„ÅåÂ¢óÂä†„ÄÇË®àÁÆóÂºè„ÅØ <code>+500 √ó ‚àö(ÊäïË≥áÈ°ç √∑ 100,000)</code> G/Êó•„ÄÇ<br>
        ‰æã: 10‰∏áGÊäïË≥á ‚Üí +500 G/Êó•„ÄÅ100‰∏áG ‚Üí +1,581 G/Êó•„ÄÅ1000‰∏áG ‚Üí +5,000 G/Êó•<br><br>
        <strong style="color:#c084fc;">„Éù„Ç§„É≥„Éà</strong>: Âπ≥ÊñπÊ†π„Çπ„Ç±„Éº„É™„É≥„Ç∞„Å™„ÅÆ„Åß„ÄÅÂ∞ëÈ°ç„Åß„ÇÇÂäπÊûú„Åå„ÅÇ„Çä„ÄÅÂ§ßÈáë„ÇíÊäïÂÖ•„Åó„Å¶„ÇÇÈöõÈôê„Å™„ÅèÂ¢ó„Åà„Çã„Åì„Å®„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇËª¢ÁîüÂæå„ÇÇËøΩÂä†ÊäïË≥áÈ°ç„ÅØÂºï„ÅçÁ∂ô„Åå„Çå„Åæ„Åô„ÄÇ
      </div>
    </div>
    <div class="hb-section" style="border-top:2px solid rgba(192,132,252,.3);padding-top:16px;margin-top:8px;">
      <div class="hb-h" style="color:#c084fc;">‚è≥ ÊôÇ„ÅÆÈÅ∫Áî£ ‚Äî Ëª¢Áîü„Ç∑„Çπ„ÉÜ„É†</div>
      <div class="hb-p">
        ÂÖ®„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÊ•µ„ÇÅ„Åü„Éó„É¨„Ç§„É§„Éº„ÅÆ„Åü„ÇÅ„ÅÆ„Ç®„É≥„Éâ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åß„Åô„ÄÇ<br><br>
        <strong style="color:#e879f9;">Ëª¢ÁîüÊù°‰ª∂</strong>: ‚ë† ‰ΩèÂ±Ö„ÇíÊúÄÂ§ß„É¨„Éô„É´„Åæ„ÅßÂº∑Âåñ„ÄÅ‚ë° ÂÖ®Âª∫Áâ©„ÇíÂª∫Ë®≠„ÄÅ‚ë¢ ÂÖ®Ë≥ºÂÖ•ÂèØËÉΩ„Ç§„É≥„ÉÜ„É™„Ç¢„ÇíÂÖ•Êâã„ÄÅ‚ë£ ÂÖ®‰∏çÂãïÁî£„ÇíÂêÑ1‰ª∂‰ª•‰∏ä‰øùÊúâ„ÄÅ‚ë§ ÂÖ®‰∫ãÊ•≠„ÇíÂêÑ1Á§æ‰ª•‰∏äË®≠Á´ãÔºàÂ∏ùÂõΩHDÂê´„ÇÄÔºâ„ÄÅ‚ë• Ë®òÈå≤Êó•Êï∞30Êó•‰ª•‰∏ä<br><br>
        <strong style="color:#fcd34d;">Ëª¢Áîü„Éú„Éº„Éä„ÇπÔºàÂë®Âõû„Åî„Å®„Å´Á¥ØÁ©çÔºâ</strong>:<br>
        „ÉªÊôÇÁµ¶ √ó1.5Ôºà2Âë®ÁõÆÔºâ‚Üí √ó2.0Ôºà3Âë®ÁõÆÔºâ‚Üí √ó2.5Ôºà4Âë®ÁõÆÔºâ‚Ä¶<br>
        „ÉªXP √ó1.1Ôºà2Âë®ÁõÆÔºâ‚Üí √ó1.2Ôºà3Âë®ÁõÆÔºâ‚Üí √ó1.3Ôºà4Âë®ÁõÆÔºâ‚Ä¶<br>
        „ÉªÂàùÊúü„Ç¥„Éº„É´„Éâ: Âë®ÂõûÊï∞√ó1,000G<br><br>
        <strong style="color:#4ade80;">Âºï„ÅçÁ∂ô„Åå„Çå„Çã„ÇÇ„ÅÆ</strong>:<br>
        ‚úÖ Ê†™Âºè„Éù„Éº„Éà„Éï„Ç©„É™„Ç™ÔºàÂÖ®‰øùÊúâÊ†™Ôºâ<br>
        ‚úÖ Â∏ùÂõΩ„Éõ„Éº„É´„Éá„Ç£„É≥„Ç∞„ÇπÔºàÔºãËøΩÂä†ÊäïË≥áÈ°çÔºâ<br>
        ‚úÖ ÂÖ®Êó•„ÅÆÊôÇÈñìË®òÈå≤„Éá„Éº„Çø<br>
        ‚úÖ „Éä„Çæ„Ç¨„ÉÅ„É£„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥<br>
        ‚úÖ „ÉÜ„É≥„Éó„É¨„Éº„ÉàË®≠ÂÆö„ÉªÁù°Áú†ÁêÜÊÉ≥ÂÄ§„Éª„Éá„Ç§„É™„Éº„ÇØ„Ç®„Çπ„Éà<br><br>
        <strong style="color:#fb7185;">„É™„Çª„ÉÉ„Éà„Åï„Çå„Çã„ÇÇ„ÅÆ</strong>:<br>
        ‚ùå „Ç¥„Éº„É´„ÉâÔºàÂàùÊúü„Éú„Éº„Éä„Çπ„ÅßÂÜç„Çπ„Çø„Éº„ÉàÔºâ<br>
        ‚ùå „Çπ„Ç≠„É´„É¨„Éô„É´„ÉªË¶öÈÜí<br>
        ‚ùå Âª∫Áâ©„ÉªË°ó„É©„É≥„ÇØ<br>
        ‚ùå ‰∏çÂãïÁî£„ÉªÂ∏ùÂõΩ‰ª•Â§ñ„ÅÆ‰∫ãÊ•≠<br>
        ‚ùå ‰ΩèÂ±Ö„Éª„Ç§„É≥„ÉÜ„É™„Ç¢<br>
        ‚ùå ÂÆüÁ∏æÔºàÂÜçÂèñÂæó„Åß„Éú„Éº„Éä„ÇπÂÜçÁç≤ÂæóÔºâ<br><br>
        <strong style="color:#818cf8;">Áß∞Âè∑</strong>: 1Âë®ÔºùËª¢ÁîüËÄÖ„ÄÅ2Âë®ÔºùËº™Âªª„ÅÆÊóÖ‰∫∫„ÄÅ3Âë®ÔºùÊôÇ„ÅÆÊîØÈÖçËÄÖ„ÄÅ5Âë®ÔºùÊ∞∏Âä´ÂõûÂ∏∞„ÄÅ7Âë®ÔºùË∂ÖË∂äËÄÖ„ÄÅ10Âë®ÔºùÁ•û<br><br>
        ËÇ≤Êàê„Çø„Éñ ‚Üí üèÜ ÂÆüÁ∏æ „ÅÆ‰∏ãÈÉ®„Å´„ÅÇ„Çã„Äå‚è≥ Ëª¢Áîü„Åô„Çã„Äç„Éú„Çø„É≥„Åã„ÇâÂÆüË°å„Åß„Åç„Åæ„Åô„ÄÇ
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">üåô Áù°Áú†Ë©ï‰æ°„Å®ÊôÇÈñì„Éñ„É≠„ÉÉ„ÇØËá™ÂãïÈÄ£Êê∫</div>
      <div class="hb-p">
        Áù°Áú†Ë©ï‰æ°„ÅßÂ∞±ÂØù„ÉªËµ∑Â∫äÊôÇÂàª„ÇíÂÖ•Âäõ„Åô„Çã„Å®„ÄÅ„Äåüåô Áù°Áú†„Äç„Éñ„É≠„ÉÉ„ÇØ„ÅåËá™Âãï„ÅßÊôÇÈñì„Éñ„É≠„ÉÉ„ÇØ„Å´ÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇÊâãÂãïÂÖ•Âäõ„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇÊó•„Çí„Åæ„Åü„ÅêÂ†¥Âêà„ÅØ2„Å§„ÅÆ„Éñ„É≠„ÉÉ„ÇØÔºàÂ∞±ÂØù„Äú24:00 Ôºã 0:00„ÄúËµ∑Â∫äÔºâ„Å´ÂàÜÂâ≤„Åï„Çå„Åæ„Åô„ÄÇ„ÄåËá™Âãï„Äç„Çø„Ç∞„Åå‰ªò„ÅÑ„Åü„Éñ„É≠„ÉÉ„ÇØ„ÅØÂâäÈô§‰∏çÂèØ„Åß„ÄÅÁù°Áú†Ë©ï‰æ°„ÅÆÂ§âÊõ¥ÊôÇ„Å´Ëá™ÂãïÊõ¥Êñ∞„Åï„Çå„Åæ„Åô„ÄÇ<br><br>
        ÁêÜÊÉ≥„ÅÆÁù°Áú†ÊôÇÂàª„ÅØ„Äå‚úèÔ∏è„Äç„Éú„Çø„É≥„Åß„Ç´„Çπ„Çø„Éû„Ç§„Ç∫ÂèØËÉΩ„Åß„Åô„ÄÇÂ§âÊõ¥„Åô„Çã„Å®Áù°Áú†„Çπ„Ç≥„Ç¢„ÅÆÂü∫Ê∫ñ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åô„ÄÇ
      </div>
    </div>
    <div class="hb-section"><div class="hb-h">‚è∏ ÁÅ∞Ëâ≤Ëá™ÂãïË£úÂÆåÔºà‰∏ÄÊôÇÂÅúÊ≠¢Ôºâ</div>
      <div class="hb-p">
        Ë®òÈå≤„Åß„Åç„Å™„Åã„Å£„ÅüÊó•„ÅØ„Äå‰∏ÄÊôÇÂÅúÊ≠¢„ÄçÊâ±„ÅÑ„Åß„Åô„ÄÇ„Çº„É≠Ë©ï‰æ°„Åß„ÅØ„Å™„Åè„ÄåË¶≥Ê∏¨‰∏çËÉΩÊó•„Äç„Å®„Åó„Å¶Âá¶ÁêÜ„Åï„Çå„Åæ„Åô„ÄÇ<br>
        „ÉªÁ∂ôÁ∂öÊó•Êï∞: ÊúÄÂ§ß3Êó•„ÅÆÁ©∫ÁôΩ„Åæ„Åß„ÅØ„Çπ„Éà„É™„Éº„ÇØ„ÇíÁ∂≠ÊåÅ<br>
        „ÉªÂπ≥ÂùáË®àÁÆó: Êú™Ë®òÈå≤Êó•„ÅØÂπ≥ÂùáÂÄ§Ë®àÁÆó„Åã„ÇâÈô§Â§ñÔºà„Çπ„Ç≥„Ç¢„Åå‰∏ã„Åå„Çâ„Å™„ÅÑÔºâ<br>
        „Éª„Ç∞„É©„Éï: Ê•µËñÑ„ÅÆÁôΩ„Éê„ÉºÔºàÂ§±Êïó„Åß„ÅØ„Å™„Åè‰∏ÄÊôÇÂÅúÊ≠¢Ôºâ<br>
        „ÉªUI„É°„ÉÉ„Çª„Éº„Ç∏: „ÄåÂÜçÈñã„ÅØ„ÅÑ„Å§„Åß„ÇÇ„Åß„Åç„Åæ„Åô„Äç
      </div>
    </div>
    <div class="hb-section" id="debugSection" style="border-top:2px solid rgba(245,158,11,.3);padding-top:16px;margin-top:8px;display:none;">
      <div style="margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid rgba(239,68,68,.2);">
        <div class="hb-h" style="color:#fb7185;">‚ö† „Éá„Éº„Çø„É™„Çª„ÉÉ„Éà</div>
        <div class="hb-p">„Åô„Åπ„Å¶„ÅÆ„Çª„Éº„Éñ„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Å¶ÊúÄÂàù„Åã„Çâ„ÇÑ„ÇäÁõ¥„Åó„Åæ„Åô„ÄÇ„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ</div>
        <button onclick="showResetConfirm()" id="resetBtn1" style="margin-top:10px;padding:10px 24px;border:2px solid #ef4444;border-radius:10px;background:rgba(239,68,68,.15);color:#fb7185;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .2s;">üóë ÂÖ®„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶ÊúÄÂàù„Åã„Çâ</button>
        <div id="resetConfirmArea" style="display:none;margin-top:10px;"></div>
      </div>
      <div class="hb-h" style="color:#fbbf24;">üîß „Éá„Éê„ÉÉ„Ç∞„ÉÑ„Éº„É´</div>
      <div class="hb-p">„ÉÜ„Çπ„ÉàÁî®„Å´„Ç¥„Éº„É´„Éâ„ÇÑXP„ÇíËøΩÂä†„Åß„Åç„Åæ„Åô„ÄÇ</div>
      <div style="margin-bottom:10px;">
        <div style="font-size:.65rem;color:var(--muted2);margin-bottom:4px;">‚ö° XP„É¨„Éº„ÉàÔºà„Çπ„Ç≠„É´ÊàêÈï∑ÈÄüÂ∫¶Ôºâ</div>
        <div style="display:flex;gap:4px;">
          <button class="xprate-btn tstep-btn" data-mode="easy" onclick="setXPRate('easy')" style="flex:1;">„ÇÜ„Çã„ÇÅ √ó0.5</button>
          <button class="xprate-btn tstep-btn" data-mode="normal" onclick="setXPRate('normal')" style="flex:1;">„Åµ„Å§„ÅÜ √ó1.0</button>
          <button class="xprate-btn tstep-btn" data-mode="hard" onclick="setXPRate('hard')" style="flex:1;">„Éè„Éº„Éâ √ó2.0</button>
        </div>
        <div style="font-size:.52rem;color:var(--muted);margin-top:3px;">„ÇÜ„Çã„ÇÅ=„ÅÆ„Çì„Å≥„ÇäÊàêÈï∑ / „Éè„Éº„Éâ=ÁàÜÈÄüÊàêÈï∑ÔºàË®òÈå≤ÊôÇÈñì„ÅÇ„Åü„Çä„ÅÆXPÈáè„ÅåÂ§â„Çè„Çä„Åæ„ÅôÔºâ</div>
      </div>
      <script>document.querySelectorAll('.xprate-btn').forEach(function(b){b.classList.toggle('active',b.dataset.mode===xpRateMode);});</script>
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;">
        <button onclick="setGold(getGold()+10000);updateNav();renderEconomy();toast('üí∞ +10,000G')" style="padding:7px 14px;border:1px solid rgba(245,158,11,.4);border-radius:8px;background:rgba(245,158,11,.1);color:#fbbf24;font-size:.72rem;font-weight:700;cursor:pointer;">+10,000G</button>
        <button onclick="setGold(getGold()+100000);updateNav();renderEconomy();toast('üí∞ +100,000G')" style="padding:7px 14px;border:1px solid rgba(245,158,11,.4);border-radius:8px;background:rgba(245,158,11,.1);color:#fbbf24;font-size:.72rem;font-weight:700;cursor:pointer;">+100,000G</button>
        <button onclick="setGold(getGold()+1000000);updateNav();renderEconomy();toast('üí∞ +1,000,000G')" style="padding:7px 14px;border:1px solid rgba(245,158,11,.4);border-radius:8px;background:rgba(245,158,11,.1);color:#fbbf24;font-size:.72rem;font-weight:700;cursor:pointer;">+1,000,000G</button>
        <button onclick="addXPRaw(1000);updateNav();toast('‚ö° +1,000XP')" style="padding:7px 14px;border:1px solid rgba(74,222,128,.4);border-radius:8px;background:rgba(74,222,128,.1);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">+1,000XP</button>
        <button onclick="addXPRaw(5000);updateNav();toast('‚ö° +5,000XP')" style="padding:7px 14px;border:1px solid rgba(74,222,128,.4);border-radius:8px;background:rgba(74,222,128,.1);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">+5,000XP</button>
        <button onclick="addXPRaw(20000);updateNav();toast('‚ö° +20,000XP')" style="padding:7px 14px;border:1px solid rgba(74,222,128,.4);border-radius:8px;background:rgba(74,222,128,.1);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">+20,000XP</button>
        <button onclick="addXPRaw(100000);updateNav();toast('‚ö° +100,000XP')" style="padding:7px 14px;border:1px solid rgba(74,222,128,.4);border-radius:8px;background:rgba(74,222,128,.1);color:#4ade80;font-size:.72rem;font-weight:700;cursor:pointer;">+100,000XP</button>
      </div>
      <button onclick="showEconomySim()" style="margin-top:10px;padding:8px 18px;border:1px solid rgba(56,189,248,.4);border-radius:8px;background:rgba(56,189,248,.1);color:var(--cyan);font-size:.72rem;font-weight:700;cursor:pointer;">üìä ÂÆå‰∫Ü„Ç∑„Éü„É•„É¨„Éº„Çø„Éº</button>
      <div id="econSimResult" style="margin-top:10px;font-size:.65rem;color:var(--muted2);line-height:1.8;max-height:300px;overflow-y:auto;"></div>
    </div>
  </div>
</div>
<!-- Sleep Ideal Editor Modal -->
<div class="modal" id="sleepIdealModal">
  <div class="modal-box" style="max-width:350px;">
    <div class="modal-hd">üåô Áù°Áú†„ÅÆÁêÜÊÉ≥ÂÄ§„ÇíÁ∑®ÈõÜ<button class="modal-close" onclick="closeModal('sleepIdealModal')">√ó</button></div>
    <div style="font-size:.68rem;color:var(--muted2);margin-bottom:12px;">Áù°Áú†„Çπ„Ç≥„Ç¢„ÅÆÂü∫Ê∫ñ„Å®„Å™„ÇãÁêÜÊÉ≥ÁöÑ„Å™Â∞±ÂØù„ÉªËµ∑Â∫äÊôÇÂàª„ÇíË®≠ÂÆö„Åó„Åæ„Åô„ÄÇ</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
      <div><div class="inp-lbl">ÁêÜÊÉ≥„ÅÆÂ∞±ÂØù</div><input type="time" id="idealSleepInput" value="23:00" step="600" style="width:100%;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px;font-size:.85rem;font-family:'JetBrains Mono',monospace;"></div>
      <div><div class="inp-lbl">ÁêÜÊÉ≥„ÅÆËµ∑Â∫ä</div><input type="time" id="idealWakeInput" value="06:30" step="600" style="width:100%;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px;font-size:.85rem;font-family:'JetBrains Mono',monospace;"></div>
    </div>
    <button class="btn" onclick="saveSleepIdeals()" style="width:100%;background:linear-gradient(135deg,#818cf8,#6366f1);color:#fff;padding:10px;font-weight:700;">‰øùÂ≠ò</button>
  </div>
</div>

<!-- Template Editor Modal -->
<div class="modal" id="tplEditorModal">
  <div class="modal-box" style="max-width:420px;">
    <div class="modal-hd">‚úèÔ∏è „ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ<button class="modal-close" onclick="closeModal('tplEditorModal')">√ó</button></div>
    <div style="font-size:.68rem;color:var(--muted2);margin-bottom:10px;">„Äå„Çà„Åè‰Ωø„ÅÜ„Äç„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„ÄÇ</div>
    <div id="tplEditorList" style="max-height:200px;overflow-y:auto;margin-bottom:10px;"></div>
    <div style="font-size:.65rem;color:var(--muted2);margin-bottom:6px;">Êñ∞„Åó„ÅÑ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíËøΩÂä†:</div>
    <div style="display:flex;gap:4px;flex-wrap:wrap;align-items:center;">
      <input type="text" id="tplLabel" placeholder="„É©„Éô„É´Âêç" style="flex:1;min-width:80px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 8px;font-size:.72rem;">
      <input type="time" id="tplStart" value="09:00" step="600" style="width:75px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;">
      <input type="time" id="tplEnd" value="12:00" step="600" style="width:75px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;">
      <select id="tplCat" style="background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;"></select>
      <button class="btn sm" onclick="addTpl()">ËøΩÂä†</button>
    </div>
    <script>document.getElementById('tplCat').innerHTML=Object.keys(CATS).map(function(c){return '<option value="'+c+'">'+c+'</option>';}).join('');</script>
  </div>
</div>

<!-- Day Template Manager Modal -->
<div class="modal" id="dayTplModal">
  <div class="modal-box" style="max-width:500px;">
    <div class="modal-hd">üìÖ ‰∏ÄÊó•„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ<button class="modal-close" onclick="closeModal('dayTplModal')">√ó</button></div>
    <div style="font-size:.68rem;color:var(--muted2);margin-bottom:12px;line-height:1.6;">
      ‰∏ÄÊó•„ÅÆË°åÂãï„Éë„Çø„Éº„É≥„Çí‰øùÂ≠ò„Åó„Å¶„ÄÅ„ÉØ„É≥„Éú„Çø„É≥„ÅßÈÅ©Áî®„Åß„Åç„Åæ„Åô„ÄÇ<br>Âπ≥Êó•Áî®„ÉªÂúüÊó•Áî®„Å™„Å©„ÄÅË§áÊï∞„Éë„Çø„Éº„É≥„Çí‰ΩúÊàêÂèØËÉΩ„Åß„Åô„ÄÇ
    </div>
    <div id="dayTplList" style="max-height:300px;overflow-y:auto;margin-bottom:14px;"></div>
    <div style="border-top:1px solid var(--border);padding-top:12px;">
      <div style="font-size:.7rem;font-weight:700;color:var(--text);margin-bottom:8px;">Êñ∞„Åó„ÅÑ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê</div>
      <div style="display:flex;gap:6px;align-items:center;margin-bottom:8px;">
        <input type="text" id="dayTplName" placeholder="„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêçÔºà‰æã: Âπ≥Êó•Áî®Ôºâ" style="flex:1;background:var(--s2);border:1px solid var(--border);border-radius:8px;color:var(--text);padding:8px 10px;font-size:.75rem;">
      </div>
      <div style="display:flex;gap:6px;">
        <button class="btn sm" onclick="saveDayTplFromCurrent()" style="border-color:var(--cyan);color:var(--cyan);flex:1;">üìù ‰ªäÊó•„ÅÆË®òÈå≤„Åã„Çâ‰ΩúÊàê</button>
        <button class="btn sm" onclick="saveDayTplEmpty()" style="border-color:var(--amber);color:var(--amber);">Á©∫„Åß‰ΩúÊàê</button>
      </div>
    </div>
  </div>
</div>

<!-- Day Template Edit Modal -->
<div class="modal" id="dayTplEditModal">
  <div class="modal-box" style="max-width:500px;">
    <div class="modal-hd"><span id="dayTplEditTitle">„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ</span><button class="modal-close" onclick="closeModal('dayTplEditModal')">√ó</button></div>
    <div id="dayTplEditList" style="max-height:280px;overflow-y:auto;margin-bottom:12px;"></div>
    <div style="border-top:1px solid var(--border);padding-top:10px;">
      <div style="font-size:.65rem;color:var(--muted2);margin-bottom:6px;">„Éñ„É≠„ÉÉ„ÇØ„ÇíËøΩÂä†:</div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;align-items:center;">
        <input type="time" id="dtplNewStart" value="09:00" step="600" style="width:80px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;">
        <span style="color:var(--muted);">„Äú</span>
        <input type="time" id="dtplNewEnd" value="12:00" step="600" style="width:80px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;">
        <select id="dtplNewCat" style="background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:5px 6px;font-size:.72rem;"></select>
        <button class="btn sm" onclick="addBlockToDayTpl()" style="border-color:var(--green);color:var(--green);">Ôºã</button>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin-top:12px;">
      <button class="btn sm" onclick="closeModal('dayTplEditModal')" style="flex:1;">‚úï Èñâ„Åò„Çã</button>
    </div>
  </div>
</div>

<!-- Quest Editor Modal -->
<div class="modal" id="questModal">
  <div class="modal-box" style="max-width:450px;">
    <div class="modal-hd">‚öô „Éá„Ç§„É™„Éº„ÇØ„Ç®„Çπ„ÉàÁ∑®ÈõÜ<button class="modal-close" onclick="closeModal('questModal')">√ó</button></div>
    <div style="font-size:.68rem;color:var(--muted2);margin-bottom:10px;">ÊØéÊó•„ÉÅ„Çß„ÉÉ„ÇØ„Åô„ÇãÈ†ÖÁõÆ„ÇíË®≠ÂÆö„ÄÇ„ÇØ„É™„Ç¢„Åô„Çã„Å®XP„Åå„ÇÇ„Çâ„Åà„Åæ„Åô„ÄÇ</div>
    <div style="display:flex;flex-direction:column;gap:6px;" id="questEditorList"></div>
    <div style="margin-top:10px;display:flex;gap:6px;">
      <input type="text" id="newQuestName" placeholder="Êñ∞„Åó„ÅÑ„ÇØ„Ç®„Çπ„ÉàÂêç" style="flex:1;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:6px 8px;font-size:.75rem;">
      <input type="number" id="newQuestXP" placeholder="XP" value="10" style="width:60px;background:var(--s2);border:1px solid var(--border);border-radius:7px;color:var(--text);padding:6px 8px;font-size:.75rem;">
      <button class="btn sm" onclick="addQuest()">ËøΩÂä†</button>
    </div>
  </div>
</div>
<!-- ==================== TUTORIAL OVERLAY ==================== -->
<div class="tut-overlay" id="tutOverlay">
  <div class="tut-card">
    <div class="tut-inner">
      <div class="tut-step-indicator" id="tutDots"></div>
      <div class="tut-emoji" id="tutEmoji"></div>
      <div class="tut-title" id="tutTitle"></div>
      <div class="tut-desc" id="tutDesc"></div>
      <div class="tut-btns">
        <button class="tut-btn skip" id="tutSkip" onclick="closeTutorial()">„Çπ„Ç≠„ÉÉ„Éó</button>
        <button class="tut-btn secondary" id="tutPrev" onclick="tutPrev()">‚Üê Êàª„Çã</button>
        <button class="tut-btn primary" id="tutNext" onclick="tutNext()">Ê¨°„Å∏ ‚Üí</button>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
var TUT_STEPS = [
  {
    emoji:'üëÅÔ∏è',
    title:'„Åæ„Åö„ÄÅËá™ÂàÜ„ÅÆ‰∏ÄÊó•„Çí„ÄåË¶ã„Çã„Äç„Åì„Å®„Åã„Çâ',
    desc:'„ÅÇ„Å™„Åü„ÅØÊò®Êó•„ÄÅ‰Ωï„Å´‰ΩïÊôÇÈñì‰Ωø„ÅÑ„Åæ„Åó„Åü„ÅãÔºü<br>Ê≠£Á¢∫„Å´Á≠î„Åà„Çâ„Çå„Çã‰∫∫„ÅØ„Åª„Å®„Çì„Å©„ÅÑ„Åæ„Åõ„Çì„ÄÇ<br><br>TIMEFLOW„ÅÆÂá∫Áô∫ÁÇπ„ÅØ<strong>„ÄåË®òÈå≤„Åô„Çã„Åì„Å®„Äç</strong>„Åß„Åô„ÄÇ<br>Ë®àÁîª„ÇíÁ´ã„Å¶„Çã„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅ„Åæ„Åö<strong>Ëá™ÂàÜ„ÅÆÁèæÂÆü„ÇíÊ≠£Á¢∫„Å´Áü•„Çã</strong>„ÄÇ<br><br>‰∏ÄÊó•„Çí‰øØÁû∞„Åß„Åç„Çã„Çà„ÅÜ„Å´„Å™„Çã„Å®„ÄÅ<br>‰Ωï„ÇíÂ§â„Åà„Çã„Åπ„Åç„Åã„Åå<strong>Ëá™ÁÑ∂„Å®Ë¶ã„Åà„Å¶„Åç„Åæ„Åô</strong>„ÄÇ'
  },
  {
    emoji:'üìù',
    title:'‚ë† Ë®òÈå≤„Åô„Çã ‚Äî „Åü„Å†‰∫ãÂÆü„ÇíÊÆã„Åô„Å†„Åë',
    desc:'<span class="th">üìù Ë®òÈå≤</span> „Éö„Éº„Ç∏„Åß„ÄÅ<strong>‰Ωï„Çí„Åó„Åü„Åã„Éª„ÅÑ„Å§„Éª„Å©„Çå„Å†„Åë</strong>„ÇíÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇ<br><br>„Çø„Ç§„É†„É©„Ç§„É≥„Å®„Éâ„Éº„Éä„ÉÑ„Ç∞„É©„Éï„Åß„ÄÅ‰∏ÄÊó•„ÅÆÂÖ®‰ΩìÂÉè„Åå‰∏ÄÁõÆ„Åß„Çè„Åã„Çã„ÄÇ<br>„ÄåÊÄù„Å£„Åü„Çà„Çä‰ªï‰∫ã„Åó„Å¶„Å™„ÅÑ„Äç„Äå‰ºëÊÜ©„ÅåÂ§ö„ÅÑ„Äç„ÄåÁßªÂãï„Å´2ÊôÇÈñì„ÇÇ‚Ä¶„Äç<br><br>„Åì„ÅÆ<strong>Ê∞ó„Å•„Åç</strong>„Åå„Åô„Åπ„Å¶„ÅÆÊîπÂñÑ„ÅÆËµ∑ÁÇπ„Åß„Åô„ÄÇ<br>ÂÆåÁíß„Å´Ë®òÈå≤„Åô„ÇãÂøÖË¶Å„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Åñ„Å£„Åè„Çä„ÅßOK„Åß„Åô„ÄÇ'
  },
  {
    emoji:'üìä',
    title:'‚ë° ‰øØÁû∞„Åô„Çã ‚Äî „Çπ„Ç≥„Ç¢„ÅßËá™ÂàÜ„ÇíÂÆ¢Ë¶≥Ë¶ñ',
    desc:'<span class="th">üìä Áµ±Ë®à</span> „Éö„Éº„Ç∏„Åß„ÄÅÊó•„ÄÖ„ÅÆË®òÈå≤„Åå<strong>„Ç∞„É©„Éï„Å®„Çπ„Ç≥„Ç¢</strong>„Å´„Å™„Çä„Åæ„Åô„ÄÇ<br><br>„Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆÊé®Áßª„ÄÅÂä™ÂäõÊôÇÈñì„ÅÆÊó•Ë∂≥„ÉªÈÄ±Ë∂≥„ÄÅ56Êó•ÂàÜ„ÅÆÁøíÊÖ£„Ç∞„É™„ÉÉ„Éâ„ÄÇ<br><br>Êò®Êó•„ÅÆËá™ÂàÜ„Å®„ÄÅÂÖàÈÄ±„ÅÆËá™ÂàÜ„ÇíÊØîËºÉ„Åô„Çã„ÄÇ<br>„Äå„Å™„Çì„Å®„Å™„ÅèÈ†ëÂºµ„Å£„Åü„Äç„Çí<strong>„ÄåÊï∞Â≠ó„ÅßË¶ã„Åà„ÇãÊàêÈï∑„Äç</strong>„Å´Â§â„Åà„Çã„ÄÇ<br><br>„Çπ„Ç≥„Ç¢„Åå‰∏ä„Åå„Çå„Å∞Â¨â„Åó„ÅÑ„Åó„ÄÅ‰∏ã„Åå„Çå„Å∞Ê∞ó„Å•„Åë„Çã„ÄÇ<br>„Åì„Çå„Åå<strong>ÊîπÂñÑ„ÅÆ„Çµ„Ç§„ÇØ„É´</strong>„ÅÆÂßã„Åæ„Çä„Åß„Åô„ÄÇ'
  },
  {
    emoji:'üò¥',
    title:'‚ë¢ Áù°Áú† ‚Äî „Åô„Åπ„Å¶„ÅÆÂä™Âäõ„ÅÆÂúüÂè∞',
    desc:'„Å©„Çå„Å†„ÅëÈ†ëÂºµ„Å£„Å¶„ÇÇ„ÄÅÁù°Áú†„ÅåÂ¥©„Çå„Åü„ÇâÂäπÁéá„ÅØËêΩ„Å°„Åæ„Åô„ÄÇ<br><br>Â∞±ÂØù„ÉªËµ∑Â∫äÊôÇÂàª„ÇíÂÖ•Âäõ„Åô„Çã„Å®<strong>Áù°Áú†„Çπ„Ç≥„Ç¢</strong>Ôºà0„Äú100ÁÇπÔºâ„ÅåÁÆóÂá∫„ÄÇ<br>ÁêÜÊÉ≥„ÅØ <span class="tg">23:00Â∞±ÂØù / 6:30Ëµ∑Â∫ä / 7.5h</span> „Åß90ÁÇπË∂Ö„Åà„ÄÇ<br><br>„Çπ„Ç≥„Ç¢„Åå<strong>XPÂÄçÁéá</strong>„Å´Áõ¥Áµê„Åô„Çã„ÅÆ„ÅßÔºö<br>90ÁÇπ ‚Üí <span class="tg">√ó1.5</span>„ÄÄ75ÁÇπ ‚Üí <span class="tg">√ó1.25</span>„ÄÄ60ÁÇπÊú™Ê∫Ä ‚Üí <span class="tr">√ó0.8</span><br><br>„ÄåÊó©„ÅèÂØù„ÅüÊñπ„ÅåÂæó„Äç„Å®‰Ωì„ÅßË¶ö„Åà„Çã‰ªïÁµÑ„Åø„Åß„Åô„ÄÇ'
  },
  {
    emoji:'üîÅ',
    title:'‚ë£ Ë®òÈå≤„Åô„Çã„Å†„Åë„ÅßÂ†±ÈÖ¨„ÅåÁîü„Åæ„Çå„Çã',
    desc:'Ë®òÈå≤„Åô„Çã„Åü„Å≥„Å´ <span class="tg">XP</span> „ÅåÂ¢ó„Åà„ÄÅ„Çπ„Ç≠„É´„Åå‰º∏„Å≥„ÄÅ„Ç∞„É©„Éï„ÅåÂãï„Åè„ÄÇ<br><br>„Äå‰ªäÊó•„ÇÇË®òÈå≤„Åó„Åü„Äç„Å®„ÅÑ„ÅÜÂ∞è„Åï„Å™Ë°åÁÇ∫Ëá™‰Ωì„Åå<strong>ÈÅîÊàêÊÑü</strong>„Å´„Å™„Çã„ÄÇ<br>Â§ñÈÉ®„ÅÆ„ÅîË§íÁæé„Åß„ÅØ„Å™„Åè„ÄÅ<strong>Ë°åÁÇ∫„Åù„ÅÆ„ÇÇ„ÅÆ„Å´Âñú„Å≥„ÇíÊÑü„Åò„Çã</strong>Áä∂ÊÖã„ÄÇ<br><br>„Åì„Çå„Åå<strong>ÂÜÖÁô∫ÁöÑÂãïÊ©ü</strong>„Åß„Åô„ÄÇ<br>„ÇÑ„Çâ„Åï„Çå„Çã„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅ„ÇÑ„Çä„Åü„Åè„Å™„Çã„ÄÇ<br>Ë®òÈå≤„ÅåÁøíÊÖ£„Å´„Å™„Å£„ÅüÊôÇ„ÄÅÂä™Âäõ„ÇÇËá™ÁÑ∂„Å´„Å§„ÅÑ„Å¶„Åç„Åæ„Åô„ÄÇ'
  },
  {
    emoji:'üß¨',
    title:'‚ë§ „Ç∑„Çπ„ÉÜ„É†„ÅåÊîπÂñÑ„ÇíÂæåÊäº„Åó„Åô„Çã',
    desc:'<span class="th">üéÆ ËÇ≤Êàê</span> „Éö„Éº„Ç∏„Åß„ÄÅË®òÈå≤„Åå<strong>30Á®Æ„ÅÆ„Çπ„Ç≠„É´</strong>„Å´Ëá™ÂãïÂ§âÊèõ„Åï„Çå„Åæ„Åô„ÄÇ<br><br><div class="tut-flow"><span class="tf-node">Ë®òÈå≤„Åô„Çã</span><span class="tf-arrow">‚Üí</span><span class="tf-node">„Çπ„Ç≠„É´ÊàêÈï∑</span><span class="tf-arrow">‚Üí</span><span class="tf-node">ÊôÇÁµ¶UP</span><span class="tf-arrow">‚Üí</span><span class="tf-node">ÊèõÈáë</span><span class="tf-arrow">‚Üí</span><span class="tf-node">„Ç¥„Éº„É´„ÉâÁç≤Âæó</span></div><br>„Å©„ÅÆ„Çπ„Ç≠„É´„Åå‰º∏„Å≥„Å¶„ÅÑ„Å¶„ÄÅ„Å©„Åì„ÅåË∂≥„Çä„Å™„ÅÑ„Åã„Åå‰∏ÄÁõÆÁû≠ÁÑ∂„ÄÇ<br><br>‚≠ê <strong>ÁâπÂà•XPÈ†ÖÁõÆ</strong>„ÅßÈáçÁÇπÂàÜÈáé„Å´„Éú„Éº„Éä„Çπ„ÇíË®≠ÂÆö<br>üìã <strong>„Éá„Ç§„É™„Éº„ÇØ„Ç®„Çπ„Éà</strong>„ÅßÂ∞è„Åï„Å™Ë°åÂãï„Çí„ÉÅ„Çß„ÉÉ„ÇØ<br>üìÖ <strong>‰∏ÄÊó•„ÉÜ„É≥„Éó„É¨</strong>„ÅßÁêÜÊÉ≥„ÅÆ‰∏ÄÊó•„Éë„Çø„Éº„É≥„ÇíÈÅ©Áî®<br><br>„Çπ„Ç≥„Ç¢„Å®„Ç∑„Çπ„ÉÜ„É†„Åå„ÄÅÊ¨°„ÅÆ‰∏ÄÊâã„ÇíÁ§∫„Åó„Å¶„Åè„Çå„Åæ„Åô„ÄÇ'
  },
  {
    emoji:'üèóÔ∏è',
    title:'‚ë• Á∂ö„Åë„ÅüÂÖà„Å´Â∫É„Åå„Çã„Åä„Åæ„Åë„ÅÆ‰∏ñÁïå',
    desc:'„Ç¥„Éº„É´„Éâ„ÅåË≤Ø„Åæ„Çã„Å®„ÄÅ<strong>„Åä„Åæ„ÅëË¶ÅÁ¥†</strong>„ÅåËß£Á¶Å„Åï„Çå„Åæ„ÅôÔºö<br><br>üìà <strong>Ë≥áÁî£ÈÅãÁî®</strong> ‚Äî Ê†™„Éª‰∏çÂãïÁî£„Éª‰∫ãÊ•≠„Åß‰∏çÂä¥ÊâÄÂæó<br>üèòÔ∏è <strong>Ë°ó„Å•„Åè„Çä</strong> ‚Äî 54Á®Æ„ÅÆÂª∫Áâ©„ÅßËá™ÂàÜ„Å†„Åë„ÅÆË°ó„ÇíÁô∫Â±ï<br>üé∞ <strong>Â®ØÊ•Ω</strong> ‚Äî „Çπ„É≠„ÉÉ„Éà„ÄÅ„Éï„Ç©„Éº„ÉÅ„É•„É≥„Éû„Ç∑„É≥„ÄÅ„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥<br>üèÜ <strong>Èö†„ÅóÂÆüÁ∏æ</strong> ‚Äî Êù°‰ª∂‰∏çÊòé„ÅÆ???„ÇíÁô∫Ë¶ã„Åô„ÇãÊ•Ω„Åó„Åø<br><br>„Åì„Çå„Çâ„ÅØÂä™Âäõ„ÅÆ<strong>ÂâØÁî£Áâ©</strong>„ÄÇË®òÈå≤„ÇíÁ∂ö„Åë„Åü‰∫∫„Å†„Åë„ÅåÈÅä„Åπ„Çã‰∏ñÁïå„Åß„Åô„ÄÇ'
  },
  {
    emoji:'üî•',
    title:'„Åï„ÅÇ„ÄÅ‰ªäÊó•„ÇíË®òÈå≤„Åó„Çà„ÅÜ„ÄÇ',
    desc:'TIMEFLOW„Å´Ê≠£Ëß£„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ<br><br>Â§ß‰∫ã„Å™„ÅÆ„ÅØ<strong>„ÄåÂÆåÁíß„Å™‰∏ÄÊó•„ÇíÈÅé„Åî„Åô„Åì„Å®„Äç„Åß„ÅØ„Å™„Åè„ÄÅ<br>„ÄåËá™ÂàÜ„ÅÆ‰∏ÄÊó•„ÇíË¶ã„Çã„Åì„Å®„Äç</strong>„Åß„Åô„ÄÇ<br><br><div class="tut-flow"><span class="tf-node">Ë®òÈå≤„Åô„Çã</span><span class="tf-arrow">‚Üí</span><span class="tf-node">‰øØÁû∞„Åô„Çã</span><span class="tf-arrow">‚Üí</span><span class="tf-node">Ê∞ó„Å•„Åè</span><span class="tf-arrow">‚Üí</span><span class="tf-node">Â∞ë„Åó„Å†„ÅëÂ§â„Åà„Çã</span></div><br>Ë¶ã„Åà„Çã„Åã„ÇâÂ§â„Åà„Çâ„Çå„Çã„ÄÇÂ§â„Çè„Çã„Åã„ÇâÁ∂ö„Åë„Åü„Åè„Å™„Çã„ÄÇ<br><br>„Åæ„Åö„ÅØ‰ªäÊó•„ÅÆË°åÂãï„Çí„ÄÅ1„Å§Ë®òÈå≤„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br><br><strong style="color:var(--cyan);">„Éò„É´„Éó„ÅØÂè≥‰∏ä„ÅÆ ? „Åã„Çâ„ÅÑ„Å§„Åß„ÇÇÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô„ÄÇ</strong>'
  }
];

var tutStep = 0;

function renderTut(){
  var s = TUT_STEPS[tutStep];
  document.getElementById('tutEmoji').textContent = s.emoji;
  document.getElementById('tutTitle').textContent = s.title;
  document.getElementById('tutDesc').innerHTML = s.desc;
  // dots
  var dots = '';
  for(var i=0;i<TUT_STEPS.length;i++){
    var cls = i<tutStep?'tut-dot done':i===tutStep?'tut-dot active':'tut-dot';
    dots += '<div class="'+cls+'"></div>';
  }
  document.getElementById('tutDots').innerHTML = dots;
  // buttons
  document.getElementById('tutPrev').style.display = tutStep===0?'none':'inline-block';
  if(tutStep === TUT_STEPS.length-1){
    document.getElementById('tutNext').textContent = '„ÅØ„Åò„ÇÅ„ÇãÔºÅ üéÆ';
    document.getElementById('tutSkip').style.display = 'none';
  } else {
    document.getElementById('tutNext').textContent = 'Ê¨°„Å∏ ‚Üí';
    document.getElementById('tutSkip').style.display = 'inline-block';
  }
}

window.tutNext = function(){
  if(tutStep < TUT_STEPS.length-1){
    tutStep++;
    renderTut();
  } else {
    closeTutorial();
  }
};
window.tutPrev = function(){
  if(tutStep > 0){
    tutStep--;
    renderTut();
  }
};
window.closeTutorial = function(){
  document.getElementById('tutOverlay').classList.remove('show');
  localStorage.setItem('tf_tutorial_done','1');
};
window.openTutorial = function(){
  tutStep = 0;
  renderTut();
  document.getElementById('tutOverlay').classList.add('show');
};

// Auto-show on first visit
if(!localStorage.getItem('tf_tutorial_done')){
  setTimeout(function(){
    openTutorial();
  }, 800);
}
})();
</script>
<script>
(function(){
  var debugTaps=0;
  var debugTimer=null;
  var debugActive=localStorage.getItem('tf_debug')==='1';
  if(debugActive){
    var ds=document.getElementById('debugSection');
    if(ds)ds.style.display='block';
  }
  document.getElementById('helpTitleIcon').addEventListener('click',function(){
    debugTaps++;
    clearTimeout(debugTimer);
    debugTimer=setTimeout(function(){debugTaps=0;},2000);
    if(debugTaps>=7){
      debugTaps=0;
      debugActive=!debugActive;
      localStorage.setItem('tf_debug',debugActive?'1':'0');
      var ds=document.getElementById('debugSection');
      if(ds)ds.style.display=debugActive?'block':'none';
      if(debugActive){
        toast('üîß „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ ON');
      } else {
        toast('üîß „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ OFF');
      }
    }
  });
})();
</script>
</body>
</html>
